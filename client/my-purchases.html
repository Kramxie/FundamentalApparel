<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Purchases - Fundamental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-100">
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">My Purchases</h1>
    <div id="purchases-list" class="space-y-4">
      <p class="text-gray-500">Loading purchases...</p>
    </div>
  </main>

  <script>
    const API_BASE = 'https://fundamental-apparel-backend.onrender.com';
    const token = localStorage.getItem('token');
    if (!token) { alert('Please log in'); window.location.href = 'login.html'; }

    async function api(path, opts = {}){
      opts.headers = { ...(opts.headers||{}), 'Authorization': `Bearer ${token}` };
      const res = await fetch(API_BASE + path, opts);
      if (res.status === 401) { localStorage.removeItem('token'); window.location.href='login.html'; throw new Error('Unauthorized'); }
      const json = await res.json();
      if (!json.success) throw new Error(json.msg || 'API error');
      return json.data;
    }

    async function loadPurchases(){
      const container = document.getElementById('purchases-list');
      try {
        // Fetch user's orders so every order appears even if there's no stored receipt yet
        const res = await fetch(API_BASE + '/api/orders/myorders', { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.status === 401) { localStorage.removeItem('token'); window.location.href='login.html'; return; }
        const j = await res.json();
        if (!j.success) { container.innerHTML = `<p class="text-red-500">${j.msg || 'Failed to load orders'}</p>`; return; }
        const orders = j.data || [];
        if (!orders || orders.length === 0) { container.innerHTML = '<p class="text-gray-500">No purchases found.</p>'; return; }

        const html = orders.map(o => {
          const dt = new Date(o.createdAt).toLocaleString();
          const total = Number(o.totalPrice || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
          const paid = o.paymentStatus && (o.paymentStatus === 'Received' || o.paymentStatus === 'paid');
          return `
            <div class="bg-white p-4 rounded-lg shadow-sm flex items-start justify-between">
              <div>
                <div class="font-semibold">Order • ${o._id.slice(-8).toUpperCase()}</div>
                <div class="text-sm text-gray-500">${dt}</div>
                <div class="mt-2 text-sm">
                  <strong>Total:</strong> ₱${total}
                  <span class="ml-3 text-xs text-gray-500">${paid ? 'Paid' : 'Unpaid'}</span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button data-id="${o._id}" class="request-refund px-3 py-2 bg-yellow-500 text-white rounded">Request A Refund</button>
                <button data-id="${o._id}" class="view-receipt px-3 py-2 bg-white border text-indigo-600 rounded" ${paid ? '' : 'disabled'}>View Receipt</button>
                <button data-id="${o._id}" class="download-receipt px-3 py-2 bg-indigo-600 text-white rounded" ${paid ? '' : 'disabled'}>Download Receipt</button>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;

        document.querySelectorAll('.download-receipt').forEach(b => b.addEventListener('click', async (e)=>{
          const oid = e.currentTarget.dataset.id;
          try { window._DOWNLOAD_DIRECT = true; await fetchAndRenderReceiptForOrder(oid); } finally { window._DOWNLOAD_DIRECT = undefined; }
        }));
        document.querySelectorAll('.view-receipt').forEach(b => b.addEventListener('click', async (e)=>{
          const oid = e.currentTarget.dataset.id;
          await fetchAndRenderReceiptForOrder(oid, /*openInline=*/true);
        }));
        document.querySelectorAll('.request-refund').forEach(b => b.addEventListener('click', (e)=>{
          const id = e.currentTarget.dataset.id;
          alert('Refund request for order: ' + id + ' — please use Requests page.');
        }));

      } catch (err) {
        console.error('loadPurchases error', err);
        container.innerHTML = `<p class="text-red-500">${err.message}</p>`;
      }
    }

    // Try to fetch server-stored receipt for an order, fallback to generating from order data
    async function fetchAndRenderReceiptForOrder(orderId, openInline = false){
      try {
        // Try lookup by order id
        try {
          const r = await api(`/api/receipts/by-order/${orderId}`);
          if (r) { await renderReceiptPDF(r, openInline); return; }
        } catch (e) {
          // ignore and fallback
        }

        // If no stored receipt, fetch order and synthesize receipt-like object
        const order = await api(`/api/orders/${orderId}`);
        if (!order) throw new Error('Order not found');

        // Build receipt-like object
        const receipt = {
          _id: `synth-${order._id}`,
          tin: 'SYNTH-' + order._id.slice(-8).toUpperCase(),
          createdAt: order.createdAt,
          logoUrl: '/images/logo.png',
          items: (order.items || []).map(it => ({ name: it.name || it.productName || 'Item', quantity: it.quantity || 1, price: it.price || it.unitPrice || 0 })),
          subtotal: order.subtotal || order.totalPrice || 0,
          vat: (typeof order.vat === 'number') ? order.vat : undefined,
          deliveryFee: order.deliveryFee || 0,
          total: (typeof order.totalPrice === 'number') ? order.totalPrice : undefined,
          customerName: (order.user && order.user.name) ? order.user.name : ''
        };

        await renderReceiptPDF(receipt, openInline);

      } catch (err) {
        console.error('fetchAndRenderReceiptForOrder', err);
        alert(err.message || 'Failed to fetch or render receipt');
      }
    }

    // Generate PDF from a receipt object (used by downloadReceipt and view inline flows)
    async function renderReceiptPDF(r, openInline = false){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      let logoData = null;
      try { logoData = await loadImageAsDataURL(r.logoUrl || '/images/logo.png'); } catch (e) { logoData = null; }

      const margin = 36;
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      let y = margin;

      // Dark header band
      doc.setFillColor(17,24,39);
      doc.rect(0, 0, pageW, 88, 'F');
      if (logoData) doc.addImage(logoData, 'PNG', margin, 16, 56, 56);
      doc.setTextColor(255,255,255);
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('Fundamental Apparel', margin + 72, 34);
      doc.setFontSize(9); doc.setFont(undefined, 'normal');
      doc.text('Unit 4B, Creative Building • Makati City', margin + 72, 50);
      doc.text('hello@fundamental.ph • www.fundamental.ph', margin + 72, 64);
      doc.setTextColor(0,0,0);

      // Info box (OR/TIN/Date)
      const infoW = 220, infoX = pageW - margin - infoW, infoY = 18;
      doc.setFillColor(255,255,255);
      doc.roundedRect(infoX, infoY, infoW, 60, 6, 6, 'F');
      doc.setTextColor(0,0,0); doc.setFontSize(9);
      doc.text(`OR No.: ${r._id ? r._id.toString().slice(-10).toUpperCase() : (r.tin || '')}`, infoX + 12, infoY + 18);
      doc.text(`Date: ${r.createdAt ? new Date(r.createdAt).toLocaleString() : ''}`, infoX + 12, infoY + 34);
      doc.text(`TIN: ${r.tin || '—'}`, infoX + 12, infoY + 50);

      // Billed To
      y = 110;
      doc.setFontSize(10); doc.setFont(undefined, 'bold');
      doc.text('Billed To:', margin, y);
      doc.setFont(undefined, 'normal'); doc.setFontSize(9);
      if (r.customerName) doc.text(r.customerName, margin, y + 14);
      if (r.customerAddress) doc.text(String(r.customerAddress), margin, y + 28);

      // Items table
      y += 60;
      const tableX = margin; const tableW = pageW - margin*2 - 200;
      const totalsAreaX = pageW - margin - 180;

      doc.setFillColor(243,244,246); doc.rect(tableX, y, tableW, 22, 'F');
      doc.setFontSize(9); doc.setFont(undefined, 'bold');
      doc.text('Item', tableX + 6, y + 14);
      doc.text('Size', tableX + 220, y + 14);
      doc.text('Qty', tableX + 320, y + 14);
      doc.text('Unit', tableX + 370, y + 14);
      doc.text('Amount', tableX + tableW - 6, y + 14, { align: 'right' });
      doc.setFont(undefined, 'normal'); doc.setFontSize(9);
      y += 28;

      const items = r.items || [];
      let computedSubtotal = Number(r.subtotal || 0);
      if (!computedSubtotal) computedSubtotal = items.reduce((s,it)=>s+((Number(it.price)||0)*(Number(it.quantity)||1)),0);

      // Improved item row rendering: fixed columns and consistent heights
      const descX = tableX + 6;
      const descWidth = 220;
      const sizeX = tableX + 240;
      const qtyX = tableX + 320;
      const unitX = tableX + 370;
      const amountX = tableX + tableW - 6;
      const lineHeight = 12;
      for (const it of items) {
        const name = (it.name || it.description || '').toString().replace(/\s+/g,' ');
        const size = it.size || '-';
        const qty = Number(it.quantity || 1);
        const unit = Number(it.price || 0);
        const lineTotal = qty * unit;

        const descLines = doc.splitTextToSize(name, descWidth);
        for (let i = 0; i < descLines.length; i++) {
          doc.text(descLines[i], descX, y + (i * lineHeight));
        }
        doc.text(size.toString(), sizeX, y);
        doc.text(String(qty), qtyX, y);
        doc.text('₱' + unit.toLocaleString(undefined,{minimumFractionDigits:2}), unitX, y);
        doc.text('₱' + lineTotal.toLocaleString(undefined,{minimumFractionDigits:2}), amountX, y, { align: 'right' });

        y += Math.max(lineHeight, descLines.length * lineHeight) + 6;
        if (y > pageH - 160) { doc.addPage(); y = margin + 40; }
      }

      // Totals box
      const totalsY = Math.max(y + 10, 380);
      doc.setFillColor(249,250,251); doc.roundedRect(totalsAreaX, totalsY, 180, 100, 6, 6, 'F');
      doc.setFontSize(9); doc.setTextColor(99,102,106);
      const tx = totalsAreaX + 12; let ty = totalsY + 18;
      doc.text('Subtotal', tx, ty); doc.text('₱' + Number(computedSubtotal||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 16;
      // Derive VAT: prefer positive server-provided VAT; otherwise derive from server total if present; fallback to 12% of subtotal
      const deliveryFee = Number(r.deliveryFee || 0);
      const serverTotal = (typeof r.total === 'number') ? Number(r.total) : NaN;
      let vat;
      if (typeof r.vat === 'number' && r.vat > 0) {
        vat = Number(r.vat);
      } else if (!isNaN(serverTotal)) {
        vat = Math.round((serverTotal - computedSubtotal - deliveryFee) * 100) / 100;
      } else {
        vat = Math.round((computedSubtotal * 0.12) * 100) / 100;
      }
      doc.text('VAT (12%)', tx, ty); doc.text('₱' + Number(vat||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 16;
      doc.text('Delivery', tx, ty); doc.text('₱' + Number(deliveryFee||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 18;
      doc.setFont(undefined, 'bold'); doc.setFontSize(11);
      const totalComputed = (!isNaN(serverTotal) && typeof r.total === 'number') ? serverTotal : (computedSubtotal + vat + deliveryFee);
      doc.text('TOTAL', tx, ty); doc.text('₱' + Number(totalComputed||computedSubtotal||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' });
      doc.setFont(undefined, 'normal'); doc.setTextColor(0,0,0);

      // Prepared by
      const prepared = r.preparedBy || r.preparedByName || '';
      if (prepared) doc.setFontSize(9).text('Prepared by: ' + prepared, margin, totalsY + 120);

      // Save/open
      const safeName = `Invoice-${(r._id||r.tin||'receipt').toString().slice(-12)}.pdf`;
      if (openInline) { const pdfBlob = doc.output('blob'); const url = URL.createObjectURL(pdfBlob); window.open(url, '_blank'); return; }
      if (typeof window._DOWNLOAD_DIRECT !== 'undefined' && window._DOWNLOAD_DIRECT === true) { doc.save(safeName); }
      else { const pdfBlob = doc.output('blob'); const url = URL.createObjectURL(pdfBlob); window.open(url, '_blank'); }
    }

    async function loadImageAsDataURL(src){
      return new Promise((resolve, reject) => {
        try {
          const img = new Image();
          img.crossOrigin = 'Anonymous';
          img.onload = () => {
            const c = document.createElement('canvas');
            c.width = img.width; c.height = img.height;
            const ctx = c.getContext('2d');
            ctx.drawImage(img,0,0);
            resolve(c.toDataURL('image/png'));
          };
          img.onerror = (e)=> reject(new Error('Failed to load logo'));
          img.src = src;
        } catch (e) { reject(e); }
      });
    }

    async function downloadReceipt(receiptId){
      const btn = document.querySelector(`button.download-receipt[data-id="${receiptId}"]`);
      const orig = btn ? btn.innerHTML : null;
      try {
        if (btn) { btn.disabled = true; btn.innerHTML = 'Generating...'; }
        const r = await api(`/api/receipts/${receiptId}`);
        await renderReceiptPDF(r, /*openInline=*/false);
      } catch (err) {
        console.error('Download receipt failed', err);
        alert(err.message || 'Failed to generate receipt');
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = orig; }
      }
    }

    async function viewReceiptInline(receiptId){
      try {
        const r = await api(`/api/receipts/${receiptId}`);
        await renderReceiptPDF(r, /*openInline=*/true);
      } catch (e) {
        console.error('View receipt failed', e);
        alert(e.message || 'Failed to view receipt');
      }
    }

    loadPurchases();
  </script>
</body>
</html>
