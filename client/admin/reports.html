<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Reports - Fundamental Apparel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } </style>
  <style>
    /* Chart container constraints to prevent infinite vertical growth */
    .chart-wrapper {
      max-height: 520px; /* upper bound for large screens */
      height: 320px;     /* default visible height */
      overflow: hidden;  /* hide any overflow by default */
      position: relative;
    }
    .chart-wrapper.scrollable {
      overflow-y: auto; /* enable vertical scroll if needed */
    }
    .chart-wrapper canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }
    @media (max-width: 640px) {
      .chart-wrapper { height: 240px; }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen bg-gray-100">
    <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
      <div class="flex items-center justify-center h-16 bg-white shadow-md">
        <span class="text-2xl font-bold text-indigo-600">Admin Panel</span>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
          </a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
          </a>
          <a href="manage-categories.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Manage Categories</span>
          </a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
          </a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
          </a>
          <a href="reports.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
          </a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
          </a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
          </a>
          <a href="settings.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span>
          </a>
          <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span>
          </a>
        </nav>
      </div>
    </div>

    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/40 z-40 md:hidden"></div>
    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full transition-transform z-50 md:hidden">
      <div class="flex items-center justify-between h-16 bg-white shadow-md px-3">
        <div class="flex items-center"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
        <button id="mobile-sidebar-close" class="p-2 rounded-md hover:bg-gray-100 text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
          </a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
          </a>
          <a href="manage-categories.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Manage Categories</span>
                    </a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
          </a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
          </a>
          <a href="reports.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
          </a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
          </a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
          </a>
          <a href="settings.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span>
          </a>
          <a href="profile.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
          </a>
        </nav>
      </div>
    </div>

    <div class="flex flex-col flex-1 overflow-hidden">
      <div class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
        <div class="flex items-center">
          <button id="mobile-menu-btn" class="block md:hidden mr-3 p-2 rounded-md hover:bg-gray-100 z-30" aria-label="Open menu">
            <i class="fas fa-bars text-gray-700"></i>
          </button>
          <h1 class="text-xl font-semibold text-gray-800">Reports & Sales</h1>
        </div>
        <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>

      <div class="flex-1 overflow-y-auto">
        <div class="p-6 space-y-6">
          <!-- Filters and actions -->
          <div class="bg-white p-4 rounded shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm text-gray-600">Period</label>
                  <select id="periodSelect" class="mt-1 block w-full border rounded p-2">
                    <option value="30">Last 30 days</option>
                    <option value="7">Last 7 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last 1 year</option>
                    <option value="custom">Custom range</option>
                    <option value="month">By Month</option>
                  </select>
                </div>
                <div id="month-wrap" class="hidden">
                    <label class="block text-sm text-gray-600">Month</label>
                    <input id="month" type="month" class="mt-1 block w-full border rounded p-2" />
                </div>
                <div id="date-start-wrap" class="hidden">
                  <label class="block text-sm text-gray-600">Start Date</label>
                  <input id="startDate" type="date" class="mt-1 block w-full border rounded p-2" />
                </div>
                <div id="date-end-wrap" class="hidden">
                  <label class="block text-sm text-gray-600">End Date</label>
                  <input id="endDate" type="date" class="mt-1 block w-full border rounded p-2" />
                </div>
              <div>
                <label class="block text-sm text-gray-600">Filter</label>
                <select id="reportType" class="mt-1 block w-full border rounded p-2">
                  <option value="sales">Sales Summary</option>
                  <option value="orders">Order Export</option>
                  <option value="inventory">Inventory</option>
                  <option value="revenue-by-category">Revenue by Category</option>
                  <option value="refunds">Refunds & Returns</option>
                  <option value="sales-by-cohort">Sales by Customer Cohort</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-600">Per Type</label>
                <select id="perTypeSelect" class="mt-1 block w-full border rounded p-2">
                  <option value="all">All (combined)</option>
                  <option value="product">Product</option>
                  <option value="predesign">Pre-Design Apparel</option>
                  <option value="fabric">Fabric & Garment</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-600">Format</label>
                <select id="format" class="mt-1 block w-full border rounded p-2">
                  <option value="csv">CSV</option>
                  <option value="json">JSON</option>
                </select>
              </div>
            </div>

            <div class="mt-4 flex gap-2 items-center">
              <button id="generate" class="px-4 py-2 bg-indigo-600 text-white rounded">Generate Report</button>
              <button id="preview" class="px-4 py-2 bg-gray-200 rounded">Preview (JSON)</button>
              <button id="export-csv" class="px-4 py-2 bg-green-600 text-white rounded">Export as CSV</button>
              <button id="export-pdf" class="px-4 py-2 bg-red-600 text-white rounded">Export as PDF</button>
              <div id="report-status" class="ml-3 text-sm text-gray-500">&nbsp;</div>
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 border rounded bg-white">
              <p class="text-sm text-gray-500">Total Sales (Selected)</p>
              <p id="total-sales-display" class="text-2xl font-bold">₱0</p>
            </div>
            <div class="p-4 border rounded bg-white">
              <p class="text-sm text-gray-500">Total Orders (Selected)</p>
              <p id="total-orders-display" class="text-2xl font-bold">0</p>
            </div>
            <div class="p-4 border rounded bg-white">
              <p class="text-sm text-gray-500">Top Product (Selected)</p>
              <p id="top-product-display" class="text-md">—</p>
            </div>
          </div>

          <!-- Low-stock widget -->
          <div class="mt-4">
            <div class="p-4 border rounded bg-white flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500">Low Stock Items</p>
                <p id="low-stock-count" class="text-2xl font-bold text-red-600">0</p>
                <p class="text-xs text-gray-500">Items with any size at or below threshold</p>
              </div>
              <div class="flex gap-2">
                <button id="view-lowstock" class="px-4 py-2 bg-indigo-600 text-white rounded">View Low Stock</button>
                <button id="notify-lowstock" class="px-4 py-2 bg-green-600 text-white rounded">Notify Admin</button>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Revenue Trend</h2>
                <div class="flex gap-2">
                  <button id="btn-7days" class="px-3 py-1 text-xs bg-indigo-600 text-white rounded">7 Days</button>
                  <button id="btn-30days" class="px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded">30 Days</button>
                </div>
              </div>
              <div class="chart-wrapper" id="salesChartWrapper">
                <canvas id="salesChart"></canvas>
              </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">Top Selling Products</h2>
                <div class="chart-wrapper" id="topProductsChartWrapper">
                  <canvas id="topProductsChart"></canvas>
                </div>
                <div class="mt-4">
                  <h3 class="text-sm font-medium mb-2">Top Products (table)</h3>
                  <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50 text-xs text-gray-500"><tr><th class="p-2 text-left">Product</th><th class="p-2 text-right">Units</th><th class="p-2 text-right">Revenue</th></tr></thead>
                          <tbody id="topProductsTbody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                  </div>
                      <div class="mt-3 flex items-center justify-end gap-2">
                        <div class="text-sm text-gray-600">Show</div>
                        <div class="flex items-center gap-2">
                          <button id="topProductsPrev" class="px-3 py-1 border rounded text-sm">Prev</button>
                          <div id="topProductsPageInfo" class="text-sm text-gray-600 px-2">0 / 0</div>
                          <button id="topProductsNext" class="px-3 py-1 border rounded text-sm">Next</button>
                        </div>
                      </div>
                </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">Category Revenue Breakdown</h2>
              <div class="chart-wrapper" id="categoryChartWrapper"><canvas id="categoryChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">KPIs</h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 border rounded"><p class="text-sm text-gray-500">Average Order Value</p><p id="aov" class="text-xl font-bold">₱0</p></div>
                <div class="p-4 border rounded"><p class="text-sm text-gray-500">Conversion Rate</p><p id="conversion-rate" class="text-xl font-bold">0%</p></div>
              </div>
            </div>
          </div>

          <!-- Top Selling by Product Type: Fabric & Garment / Pre-Design Apparel -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">Top Selling Fabric & Garment</h2>
              <div class="chart-wrapper" id="fabricChartWrapper"><canvas id="fabricChart"></canvas></div>
              <div class="mt-4">
                <h3 class="text-sm font-medium mb-2">Top Fabrics & Garments (table)</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 text-xs text-gray-500"><tr><th class="p-2 text-left">Product</th><th class="p-2 text-right">Units</th><th class="p-2 text-right">Revenue</th></tr></thead>
                    <tbody id="topFabricTbody" class="bg-white divide-y divide-gray-100"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">Top Selling Pre-Design Apparel</h2>
              <div class="chart-wrapper" id="predesignChartWrapper"><canvas id="predesignChart"></canvas></div>
              <div class="mt-4">
                <h3 class="text-sm font-medium mb-2">Top Pre-Design Apparel (table)</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 text-xs text-gray-500"><tr><th class="p-2 text-left">Product</th><th class="p-2 text-right">Units</th><th class="p-2 text-right">Revenue</th></tr></thead>
                    <tbody id="topPreDesignTbody" class="bg-white divide-y divide-gray-100"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

            <!-- Orders table -->
            <div id="orders-section" class="bg-white p-4 rounded shadow">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-medium">Orders</h2>
                <div class="flex items-center gap-4">
                  <div class="text-sm text-gray-500">Showing up to 250 recent orders for selected range</div>
                  <div class="flex items-center gap-2">
                    <button id="ordersPrev" class="px-3 py-1 border rounded text-sm">Prev</button>
                    <div id="ordersPageInfo" class="text-sm text-gray-600">0 / 0</div>
                    <button id="ordersNext" class="px-3 py-1 border rounded text-sm">Next</button>
                  </div>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Order ID</th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Customer</th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Email</th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                      <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Total</th>
                      <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">Paid</th>
                    </tr>
                  </thead>
                  <tbody id="ordersTbody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
              </div>
            </div>

            <!-- Preview/output -->
            <div id="output" class="bg-white p-4 rounded shadow">
              <h2 class="text-lg font-medium mb-2">Preview</h2>
              <pre id="previewArea" class="text-sm text-gray-700 overflow-auto max-h-96"></pre>
            </div>
        </div>
      </div>
    </div>

  <script>
    // API base: prefer same-origin (works on Render or when served by backend).
    // If opened via Live Server (port 5500) or static file host, fall back to localhost:5000.
    const API_BASE = (function(){
      try {
        const origin = window.location.origin;
        const port = window.location.port;
        const host = window.location.hostname;
        // If opened from Live Server (port 5500) or explicitly 127.0.0.1 static host, use local backend
        if (port === '5500' || host === '127.0.0.1') return 'http://localhost:5000';
        // Otherwise assume page is served from backend (Render or localhost:5000)
        return origin;
      } catch (e) {
        return 'http://localhost:5000';
      }
    })();

    function escapeHtmlGlobal(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Helper to map report type to endpoint
    function endpointFor(type) {
      switch (type) {
        case 'sales': return 'sales';
        case 'orders': return 'orders';
        case 'inventory': return 'inventory';
        case 'revenue-by-category': return 'revenue-by-category';
        case 'refunds': return 'refunds';
        case 'sales-by-cohort': return 'sales-by-cohort';
        default: return 'sales';
      }
    }

    async function buildUrl(type, params = {}) {
      const endpoint = endpointFor(type);
      const qs = new URLSearchParams();
      if (params.startDate) qs.set('startDate', params.startDate);
      if (params.endDate) qs.set('endDate', params.endDate);
      if (params.format) qs.set('download', params.format);
      if (params.extra) Object.entries(params.extra).forEach(([k,v]) => { if (v!=null) qs.set(k,v); });
      return API_BASE + '/api/admin/reports/' + endpoint + (qs.toString() ? `?${qs.toString()}` : '');
    }

    // Draw charts using Chart.js
    let salesChart = null, topProductsChart = null, fabricChart = null, predesignChart = null;
    // Pagination state for top products and orders
    let topProductsData = [];
    let topProductsPage = 0;
    const TOP_PRODUCTS_PAGE_SIZE = 5;

    let ordersPage = 0;
    const ORDERS_PAGE_SIZE = 10;
    function drawSalesChart(labels, data) {
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (salesChart) salesChart.destroy();
      salesChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Revenue', data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // show/hide a friendly empty message over a chart wrapper when its data is empty
    function showEmptyForCanvas(wrapperId, canvasId, msg) {
      const wrap = document.getElementById(wrapperId);
      const canvas = document.getElementById(canvasId);
      if (!wrap) return;
      // hide canvas
      if (canvas) canvas.style.display = 'none';
      let note = wrap.querySelector('.empty-note');
      if (!note) { note = document.createElement('div'); note.className = 'empty-note p-6 text-sm text-gray-500'; wrap.appendChild(note); }
      note.textContent = msg || 'No data available for the selected range.';
    }
    function clearEmptyForCanvas(wrapperId, canvasId) {
      const wrap = document.getElementById(wrapperId);
      const canvas = document.getElementById(canvasId);
      if (!wrap) return;
      if (canvas) canvas.style.display = '';
      const note = wrap.querySelector('.empty-note'); if (note) note.remove();
    }

    function drawTopProductsChart(labels, data) {
      const ctx = document.getElementById('topProductsChart').getContext('2d');
      if (topProductsChart) topProductsChart.destroy();
      topProductsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Units Sold', data, backgroundColor: '#10b981' }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Generic bar chart drawer used for Fabric/PreDesign charts
    function drawBarChartGeneric(canvasId, labels, data, color = '#3b82f6', chartRefName = null) {
      const ctx = document.getElementById(canvasId)?.getContext('2d');
      if (!ctx) return null;
      // destroy existing if any (map chartRefName to variable)
      try {
        if (chartRefName && typeof window[chartRefName] !== 'undefined' && window[chartRefName]) { window[chartRefName].destroy(); window[chartRefName] = null; }
      } catch (e) { /* ignore */ }
      const cfg = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Units Sold', data, backgroundColor: color }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
      if (chartRefName) window[chartRefName] = cfg;
      return cfg;
    }

    let categoryChart = null;
    function drawCategoryChart(labels, data) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      if (categoryChart) categoryChart.destroy();
      const colors = labels.map((_,i)=>['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899'][i%6]);
      categoryChart = new Chart(ctx, { type: 'pie', data: { labels, datasets:[{ data, backgroundColor: colors }] }, options: { responsive:true, maintainAspectRatio:false } });
    }

    // periodDays OR (startDateParam & endDateParam) may be provided. If both date params provided, they take precedence.
    async function fetchAndRenderReports(periodDays = 30, startDateParam = null, endDateParam = null) {
      const token = localStorage.getItem('adminToken');
      if (!token) { window.location.href = 'login.html'; return; }

      // Determine date range: prefer explicit params (custom range), otherwise compute from periodDays
      let startDate, endDate;
      if (startDateParam && endDateParam) {
        startDate = startDateParam;
        endDate = endDateParam;
      } else {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - (periodDays - 1));
        startDate = start.toISOString().slice(0,10);
        endDate = end.toISOString().slice(0,10);
      }

      // read selected per-type filter (product / predesign / fabric / all)
      const perTypeEl = document.getElementById('perTypeSelect');
      const selectedPerType = perTypeEl ? perTypeEl.value : 'all';

      // show loading indicator
      document.getElementById('report-status').textContent = 'Loading...';
      try {
        // Sales summary (includes salesByDay and topProducts)
        const salesUrl = await buildUrl('sales', { startDate, endDate, extra: { type: selectedPerType } });
        const salesRes = await fetch(salesUrl, { headers: { Authorization: 'Bearer ' + token } });
        if (!salesRes.ok) throw new Error('Failed to fetch sales');
        const salesJson = await salesRes.json();
        const data = salesJson.data || {};

        document.getElementById('total-sales-display').textContent = '₱' + ((data.totalRevenue||0).toLocaleString('en-PH', { minimumFractionDigits: 2 }));
        document.getElementById('total-orders-display').textContent = (data.totalOrders||0);
        const topName = (data.topProducts && data.topProducts[0] && (data.topProducts[0].productInfo && data.topProducts[0].productInfo.name)) || (data.topProducts && data.topProducts[0] && data.topProducts[0]._id) || '—';
        document.getElementById('top-product-display').textContent = topName;

        // Render sales by day
        const labels = (data.salesByDay || []).map(s => s._id);
        const values = (data.salesByDay || []).map(s => s.total || 0);
        try { document.getElementById('salesChartWrapper').classList.toggle('scrollable', (labels.length > 30)); } catch(e){}
        if (!labels || labels.length === 0) {
          showEmptyForCanvas('salesChartWrapper','salesChart','No sales data for the selected range.');
        } else {
          clearEmptyForCanvas('salesChartWrapper','salesChart');
          drawSalesChart(labels, values);
        }

        // Top products data: keep full array in state and render first page
        topProductsData = data.topProducts || [];
        topProductsPage = 0;
        renderTopProductsPage();

        // --- Top Selling Fabric & Garment and Top Selling Pre-Design Apparel ---
        try {
          const topProductsArr = data.topProducts || [];

          // helper to map items to label/units/revenue
          const mapItems = (arr) => arr.map(p => ({
            name: (p.productInfo && p.productInfo.name) || String(p._id || ''),
            units: Number(p.totalSold || p.unitsSold || 0),
            revenue: Number(p.revenue || p.totalRevenue || (p.unitPrice ? p.unitPrice * (p.totalSold||p.unitsSold||0) : 0))
          }));

          // Fabric & Garment: prefer server-provided data; otherwise filter topProducts
          let fabricItemsRaw = (data.topFabrics && data.topFabrics.length) ? data.topFabrics : topProductsArr.filter(p => {
            const info = p.productInfo || {};
            const cat = (info.category || '').toString().toLowerCase();
            const type = (info.type || '').toString().toLowerCase();
            const tags = ((info.tags && info.tags.join) ? info.tags.join(' ').toLowerCase() : (info.tags || '').toString().toLowerCase());
            const name = (info.name || '').toString().toLowerCase();
            return /fabric|garment/.test(cat) || /fabric|garment/.test(type) || /fabric|garment/.test(tags) || /fabric|garment/.test(name);
          });
          const fabricItems = mapItems(fabricItemsRaw || []);
          const fabricLabels = fabricItems.map(i=>i.name);
          const fabricValues = fabricItems.map(i=>i.units);
          try { document.getElementById('fabricChartWrapper').classList.toggle('scrollable', (fabricLabels.length > 12)); } catch(e){}
          if (!fabricLabels || fabricLabels.length === 0) {
            showEmptyForCanvas('fabricChartWrapper','fabricChart','No fabric/garment sales for the selected range.');
          } else {
            clearEmptyForCanvas('fabricChartWrapper','fabricChart');
            drawBarChartGeneric('fabricChart', fabricLabels, fabricValues, '#ef4444', 'fabricChart');
          }
          // populate fabric table
          const fabricTbody = document.getElementById('topFabricTbody'); if (fabricTbody) { fabricTbody.innerHTML = ''; fabricItems.forEach(it => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2">${escapeHtmlGlobal(it.name)}</td><td class="p-2 text-right">${it.units}</td><td class="p-2 text-right">₱${Number(it.revenue||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>`; fabricTbody.appendChild(tr); }); }

          // Pre-Design Apparel: server field or filter by product flags/names
          let preItemsRaw = (data.topPreDesigns && data.topPreDesigns.length) ? data.topPreDesigns : topProductsArr.filter(p => {
            const info = p.productInfo || {};
            const name = (info.name || '').toString().toLowerCase();
            const cat = (info.category || '').toString().toLowerCase();
            const type = (info.type || '').toString().toLowerCase();
            const tags = ((info.tags && info.tags.join) ? info.tags.join(' ').toLowerCase() : (info.tags || '').toString().toLowerCase());
            const isPre = (info.isPreDesign || info.preDesign || info.pre_design) || false;
            return isPre || /pre-?design|predesign|pre design|pre_design/.test(name) || /pre-?design|predesign/.test(cat) || /pre-?design|predesign/.test(type) || /pre-?design|predesign/.test(tags);
          });
          const preItems = mapItems(preItemsRaw || []);
          const preLabels = preItems.map(i=>i.name);
          const preValues = preItems.map(i=>i.units);
          try { document.getElementById('predesignChartWrapper').classList.toggle('scrollable', (preLabels.length > 12)); } catch(e){}
          if (!preLabels || preLabels.length === 0) {
            showEmptyForCanvas('predesignChartWrapper','predesignChart','No pre-design apparel sales for the selected range.');
          } else {
            clearEmptyForCanvas('predesignChartWrapper','predesignChart');
            drawBarChartGeneric('predesignChart', preLabels, preValues, '#8b5cf6', 'predesignChart');
          }
          // populate pre-design table
          const preTbody = document.getElementById('topPreDesignTbody'); if (preTbody) { preTbody.innerHTML = ''; preItems.forEach(it => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2">${escapeHtmlGlobal(it.name)}</td><td class="p-2 text-right">${it.units}</td><td class="p-2 text-right">₱${Number(it.revenue||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>`; preTbody.appendChild(tr); }); }
        } catch (e) { console.debug('Failed to render fabric/predesign sections', e); }

        // Category breakdown
        if (!data.byCategory && !(data.salesByCategory && data.salesByCategory.length)) {
          showEmptyForCanvas('categoryChartWrapper','categoryChart','No category data for the selected range.');
        } else {
          clearEmptyForCanvas('categoryChartWrapper','categoryChart');
        }
        if (data.byCategory) {
          const catLabels = Object.keys(data.byCategory);
          const catValues = catLabels.map(k=> Number(data.byCategory[k]||0));
          drawCategoryChart(catLabels, catValues);
        } else if (data.salesByCategory) {
          const catLabels = (data.salesByCategory||[]).map(x=>x._id);
          const catValues = (data.salesByCategory||[]).map(x=>x.total || 0);
          drawCategoryChart(catLabels, catValues);
        } else {
          try{ if (categoryChart) { categoryChart.destroy(); categoryChart = null; } }catch(e){}
        }

        // KPIs
        const aov = data.averageOrderValue || (data.totalRevenue && data.totalOrders ? (data.totalRevenue / Math.max(1, data.totalOrders)) : 0);
        document.getElementById('aov').textContent = '₱' + Number(aov||0).toLocaleString(undefined,{minimumFractionDigits:2});
        document.getElementById('conversion-rate').textContent = (Number(data.conversionRate||0)*100).toFixed(2) + '%';

        // Fetch and render Orders table for the selected range (paginated)
        try {
          const orders = await fetchOrdersForTable(startDate, endDate, selectedPerType);
          // fetchOrdersForTable sets currentOrders; ensure we render first page
          ordersPage = 0;
          renderOrdersPage();
        } catch (e) { console.debug('Failed to fetch orders for table', e); }

        document.getElementById('report-status').textContent = '';
      } catch (err) {
        console.error('Failed to load reports', err);
        document.getElementById('previewArea').textContent = 'Failed to load reports: ' + err.message;
        document.getElementById('report-status').textContent = 'Failed to load';
      }
    }

    // Wire buttons and auto-load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('logout-btn').addEventListener('click', () => { localStorage.removeItem('adminToken'); window.location.href='login.html'; });
      document.getElementById('generate').addEventListener('click', async () => {
        const period = (document.getElementById('periodSelect')||{}).value || '30';
        const type = document.getElementById('reportType').value;
        const perType = document.getElementById('perTypeSelect') ? document.getElementById('perTypeSelect').value : 'all';
        const format = document.getElementById('format').value;
        const token = localStorage.getItem('adminToken');
        if (!token) { alert('Not authenticated'); return; }

        // If report type is 'sales', use the charting flow. For other report types, fall back to download/preview.
        if (type === 'sales') {
          if (period === 'custom') {
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            if (!s || !e) { alert('Please select both start and end dates for a custom range.'); return; }
            await fetchAndRenderReports(null, s, e);
            return;
          }
          // numeric period (days)
          const days = Number(period) || 30;
          // pass per-type selection via DOM inside fetchAndRenderReports
          await fetchAndRenderReports(days);
          return;
        }

        // Non-sales reports: fetch JSON and update preview/UI (do not auto-download CSV on Generate)
        let startDate = document.getElementById('startDate').value;
        let endDate = document.getElementById('endDate').value;
        if (period !== 'custom') {
          const days = Number(period) || 30; const e = new Date(); const s = new Date(); s.setDate(e.getDate() - (days - 1)); startDate = s.toISOString().slice(0,10); endDate = e.toISOString().slice(0,10);
        }
        try {
          // include perType filter when previewing non-sales types as well
          const url = await buildUrl(type, { startDate, endDate, extra: { type: perType } }); // no format -> return JSON preview
          const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
          if (!res.ok) throw new Error('Server error: ' + res.status);
          const json = await res.json();
          document.getElementById('previewArea').textContent = JSON.stringify(json, null, 2);
          // Optionally populate table/summary for well-known types
          if (type === 'refunds' || type.indexOf('refund') !== -1 || type === 'refunds & returns') {
            // if backend returns a refunds array, show count in report-status
            const count = (json.data && Array.isArray(json.data)) ? json.data.length : (json.count||0);
            document.getElementById('report-status').textContent = `${count} refund records found`;
          }
        } catch (e) { alert('Failed to generate: ' + e.message); }
      });

      document.getElementById('preview').addEventListener('click', async () => {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const type = document.getElementById('reportType').value;
        const perType = document.getElementById('perTypeSelect') ? document.getElementById('perTypeSelect').value : 'all';
        const token = localStorage.getItem('adminToken');
        if (!token) { alert('Not authenticated'); return; }
        const url = await buildUrl(type, { startDate, endDate, extra: { type: perType } });
        try { const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } }); const json = await res.json(); document.getElementById('previewArea').textContent = JSON.stringify(json, null, 2); } catch (e){ alert('Preview failed: '+e.message); }
      });

      // Period select behavior (show/hide custom date inputs)
      const periodSelect = document.getElementById('periodSelect');
      const startWrap = document.getElementById('date-start-wrap');
      const endWrap = document.getElementById('date-end-wrap');
      const monthWrap = document.getElementById('month-wrap');
      function updateDateInputsVisibility(){
        if (!periodSelect) return;
        if (periodSelect.value === 'custom') {
            startWrap.classList.remove('hidden');
            endWrap.classList.remove('hidden');
            monthWrap.classList.add('hidden');
        } else if (periodSelect.value === 'month') {
            startWrap.classList.add('hidden');
            endWrap.classList.add('hidden');
            monthWrap.classList.remove('hidden');
        }
        else {
            startWrap.classList.add('hidden');
            endWrap.classList.add('hidden');
            monthWrap.classList.add('hidden');
        }
      }
      periodSelect?.addEventListener('change', updateDateInputsVisibility);
      updateDateInputsVisibility();

      // Auto-load default period (based on periodSelect)
      const defaultDays = (document.getElementById('periodSelect')||{value:'30'}).value;
      if (defaultDays === 'custom') {
        // if custom and dates provided, use them; otherwise use 30 days
        const s = document.getElementById('startDate').value; const e = document.getElementById('endDate').value;
        if (s && e) { fetchAndRenderReports( Math.max(1, Math.ceil((new Date(e)-new Date(s))/(1000*60*60*24))+1) ); }
        else fetchAndRenderReports(30);
      } else fetchAndRenderReports(Number(defaultDays || 30));

      // Quick period buttons
      document.getElementById('btn-7days').addEventListener('click', () => fetchAndRenderReports(7));
      document.getElementById('btn-30days').addEventListener('click', () => fetchAndRenderReports(30));

      // Export CSV / PDF handlers
      document.getElementById('export-csv').addEventListener('click', async () => {
        try {
          const statusEl = document.getElementById('report-status');
          statusEl.textContent = 'Preparing CSV...';
          await exportCurrentViewCSV();
          statusEl.textContent = 'CSV downloaded';
          setTimeout(()=> statusEl.textContent=' ', 3000);
        } catch (e) { alert('Export CSV failed: ' + e.message); }
      });

      document.getElementById('export-pdf').addEventListener('click', async () => {
        try {
          const statusEl = document.getElementById('report-status');
          statusEl.textContent = 'Preparing PDF...';
          await exportCurrentViewPDF();
          statusEl.textContent = 'PDF downloaded';
          setTimeout(()=> statusEl.textContent=' ', 3000);
        } catch (e) { alert('Export PDF failed: ' + e.message); }
      });
      // Pagination button wiring (Top Products and Orders)
      try {
        const tpPrev = document.getElementById('topProductsPrev');
        const tpNext = document.getElementById('topProductsNext');
        if (tpPrev) tpPrev.addEventListener('click', () => { topProductsPage = Math.max(0, topProductsPage-1); renderTopProductsPage(); });
        if (tpNext) tpNext.addEventListener('click', () => { topProductsPage = topProductsPage+1; renderTopProductsPage(); });

        const oPrev = document.getElementById('ordersPrev');
        const oNext = document.getElementById('ordersNext');
        if (oPrev) oPrev.addEventListener('click', () => { ordersPage = Math.max(0, ordersPage-1); renderOrdersPage(); });
        if (oNext) oNext.addEventListener('click', () => { ordersPage = ordersPage+1; renderOrdersPage(); });
      } catch (e) { /* ignore if elements not present yet */ }
    });

    // --- Orders table and export implementations ---
    let currentOrders = [];
    async function fetchOrdersForTable(startDate, endDate, perType = 'product') {
      const token = localStorage.getItem('adminToken');
      if (!token) return [];
      if (perType === 'product' || perType === 'all') {
        const url = await buildUrl('orders', { startDate, endDate, extra: { limit: 250 } });
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error('Failed to fetch orders for table: ' + res.status);
        const json = await res.json();
        const rows = json.data || [];
        currentOrders = rows;
        return rows;
      } else {
        // For predesign / fabric types, fetch custom orders admin list
        const qs = new URLSearchParams();
        if (startDate) qs.set('startDate', startDate);
        if (endDate) qs.set('endDate', endDate);
        if (perType === 'predesign') qs.set('serviceType', 'predesign-product');
        const url = API_BASE + '/api/custom-orders/admin' + (qs.toString() ? `?${qs.toString()}` : '');
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error('Failed to fetch custom orders for table: ' + res.status);
        const json = await res.json();
        const rows = (json.data || []).map(r => ({
          _id: r._id,
          createdAt: r.createdAt,
          user: r.user || {},
          status: r.status,
          totalPrice: r.totalPrice || r.price || 0,
          isPaid: r.paymentStatus === 'paid' || r.downPaymentPaid || r.balancePaid
        }));
        currentOrders = rows;
        return rows;
      }
    }

    function renderOrdersTable(rows) {
      const tbody = document.getElementById('ordersTbody');
      tbody.innerHTML = '';
      if (!rows || !rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 text-sm text-gray-500">No orders found for the selected range.</td></tr>';
        return;
      }
      rows.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2">${String(o._id).slice(-8)}</td>
          <td class="px-4 py-2">${o.createdAt ? new Date(o.createdAt).toLocaleString() : ''}</td>
          <td class="px-4 py-2">${o.user ? (o.user.name||'') : ''}</td>
          <td class="px-4 py-2">${o.user ? (o.user.email||'') : ''}</td>
          <td class="px-4 py-2">${o.status||''}</td>
          <td class="px-4 py-2 text-right">₱${(o.totalPrice||0).toLocaleString('en-PH', { minimumFractionDigits: 2 })}</td>
          <td class="px-4 py-2 text-center">${o.isPaid ? 'Yes' : 'No'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Pagination renderers
    function renderTopProductsPage() {
      const tbody = document.getElementById('topProductsTbody');
      const wrapperId = 'topProductsChartWrapper';
      tbody.innerHTML = '';
      const total = topProductsData.length || 0;
      const pages = Math.max(1, Math.ceil(total / TOP_PRODUCTS_PAGE_SIZE));
      topProductsPage = Math.min(Math.max(0, topProductsPage), pages - 1);
      const start = topProductsPage * TOP_PRODUCTS_PAGE_SIZE;
      const pageItems = topProductsData.slice(start, start + TOP_PRODUCTS_PAGE_SIZE);

      const labels = pageItems.map(p => (p.productInfo && p.productInfo.name) || String(p._id));
      const values = pageItems.map(p => Number(p.chartValue ?? p.totalSold ?? p.unitsSold ?? p.total ?? 0));
      try { document.getElementById(wrapperId).classList.toggle('scrollable', (labels.length > 12)); } catch(e){}
      if (!labels || labels.length === 0) {
        showEmptyForCanvas(wrapperId,'topProductsChart','No top-products data for the selected range.');
      } else {
        clearEmptyForCanvas(wrapperId,'topProductsChart');
        drawTopProductsChart(labels, values);
      }

      // populate table with current page
      pageItems.forEach(p => {
        const tr = document.createElement('tr');
        const name = (p.productInfo && p.productInfo.name) || String(p._id || '');
        const units = Number(p.totalSold ?? p.unitsSold ?? p.chartValue ?? 0);
        const revenue = Number(p.revenue ?? p.totalRevenue ?? 0);
        tr.innerHTML = `<td class="p-2">${escapeHtmlGlobal(name)}</td><td class="p-2 text-right">${units}</td><td class="p-2 text-right">₱${revenue.toLocaleString(undefined,{minimumFractionDigits:2})}</td>`;
        tbody.appendChild(tr);
      });

      // update pagination UI
      const info = document.getElementById('topProductsPageInfo'); if (info) info.textContent = `${topProductsPage+1} / ${pages}`;
      const prev = document.getElementById('topProductsPrev'); const next = document.getElementById('topProductsNext');
      if (prev) prev.disabled = topProductsPage <= 0; if (next) next.disabled = topProductsPage >= pages-1;
    }

    function renderOrdersPage() {
      const total = (currentOrders && currentOrders.length) || 0;
      const pages = Math.max(1, Math.ceil(total / ORDERS_PAGE_SIZE));
      ordersPage = Math.min(Math.max(0, ordersPage), pages - 1);
      const start = ordersPage * ORDERS_PAGE_SIZE;
      const pageItems = (currentOrders || []).slice(start, start + ORDERS_PAGE_SIZE);
      renderOrdersTable(pageItems);
      const info = document.getElementById('ordersPageInfo'); if (info) info.textContent = `${ordersPage+1} / ${pages}`;
      const prev = document.getElementById('ordersPrev'); const next = document.getElementById('ordersNext');
      if (prev) prev.disabled = ordersPage <= 0; if (next) next.disabled = ordersPage >= pages-1;
    }

    async function exportCurrentViewCSV() {
      // Prefer server-generated CSV that respects the Per-Type filter
      const perType = document.getElementById('perTypeSelect') ? document.getElementById('perTypeSelect').value : 'all';
      const period = document.getElementById('periodSelect').value;
      const token = localStorage.getItem('adminToken');
      const params = {
          type: perType,
          download: 'csv'
      };

      if (period === 'month') {
          const month = document.getElementById('month').value;
          if (month) {
              params.month = month;
          }
      } else {
          params.startDate = document.getElementById('startDate').value;
          params.endDate = document.getElementById('endDate').value;
      }

      try {
        const url = await buildUrl('sales', { extra: params });
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error('Failed to get CSV: ' + res.status);
        const blob = await res.blob();
        // derive filename from header if present
        const cd = res.headers.get('content-disposition') || '';
        let filename = `reports_${Date.now()}.csv`;
        const m = cd.match(/filename\*=UTF-8''(.+)$|filename="?([^";]+)"?/);
        if (m) filename = decodeURIComponent(m[1] || m[2] || filename);
        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); link.remove();
      } catch (e) {
        // fallback to client-side CSV from currentOrders
        let rows = currentOrders;
        if (!rows || !rows.length) {
          const end = new Date();
          const start = new Date(); start.setDate(end.getDate()-29);
          rows = await fetchOrdersForTable(start.toISOString().slice(0,10), end.toISOString().slice(0,10));
        }
        const columns = ['orderId','date','customer','email','status','totalPrice','isPaid'];
        const esc = v=>{ if(v===null||v===undefined) return ''; const s=String(v); return (s.includes(',')||s.includes('\n')||s.includes('"')) ? '"'+s.replace(/"/g,'""')+'"' : s; };
        const body = rows.map(o=> [String(o._id), o.createdAt?new Date(o.createdAt).toISOString():'', o.user?o.user.name:'', o.user?o.user.email:'', o.status||'', o.totalPrice||0, o.isPaid? 'yes':'no' ].map(esc).join(',')).join('\n');
        const csv = columns.join(',') + '\n' + body;
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `orders_export_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
    }

    async function exportCurrentViewPDF() {
      // Request a server-generated, data-driven PDF using active filters
      const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
      const period = document.getElementById('periodSelect')?.value || '30';
      let startDate = '';
      let endDate = '';
      if (period === 'custom') {
        startDate = document.getElementById('startDate')?.value || '';
        endDate = document.getElementById('endDate')?.value || '';
      } else {
        // calculate endDate = today, startDate = today - (period-1)
        const days = parseInt(period || '30', 10);
        const e = new Date();
        const s = new Date(); s.setDate(e.getDate() - (days - 1));
        startDate = s.toISOString().slice(0,10);
        endDate = e.toISOString().slice(0,10);
      }
      const perType = document.getElementById('perTypeSelect')?.value || 'all';
      const reportType = document.getElementById('reportType')?.value || 'sales';
      const qs = new URLSearchParams();
      if (startDate) qs.set('startDate', startDate);
      if (endDate) qs.set('endDate', endDate);
      if (perType) qs.set('type', perType);
      // include custom orders when perType is 'all' or when needed
      if (perType === 'all') qs.set('includeCustom', 'true');

      const url = API_BASE + '/api/admin/reports/sales/pdf' + (qs.toString() ? `?${qs.toString()}` : '');
      const res = await fetch(url, { headers: Object.assign({}, token ? { 'Authorization': 'Bearer ' + token } : {}) });
      if (!res.ok) {
        const text = await res.text().catch(()=>res.statusText||'');
        throw new Error('Server failed to generate PDF: ' + (text || res.status));
      }
      const blob = await res.blob();
      const downloadUrl = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = downloadUrl; a.download = `reports_${Date.now()}.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(downloadUrl);
    }
  </script>

  <!-- Low-stock modal -->
  <div id="lowStockModal" class="hidden fixed inset-0 bg-black/50 z-50 items-center justify-center">
    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Low Stock Items</h3>
        <div class="flex items-center gap-2">
          <button id="lowstock-refresh" class="px-3 py-1 border rounded text-sm">Refresh</button>
          <button id="lowstock-close" class="px-3 py-1 border rounded text-sm">Close</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-xs text-gray-500 border-b">
            <tr>
              <th class="p-2">Product</th>
              <th class="p-2">Size</th>
              <th class="p-2">Available</th>
              <th class="p-2">Reserved</th>
            </tr>
          </thead>
          <tbody id="lowstock-table-body" class="align-top"></tbody>
        </table>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="notify-all-lowstock" class="px-4 py-2 bg-green-600 text-white rounded">Notify All</button>
        <button id="notify-selected-lowstock" class="px-4 py-2 bg-indigo-600 text-white rounded">Notify Selected</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const LOW_STOCK_THRESHOLD = 5; // items at or below this per-size will be considered low
      const API_BASE = (typeof API !== 'undefined') ? API : '';
      const lowstockCountEl = document.getElementById('low-stock-count');
      const viewBtn = document.getElementById('view-lowstock');
      const notifyBtn = document.getElementById('notify-lowstock');
      const modal = document.getElementById('lowStockModal');
      const modalBody = document.getElementById('lowstock-table-body');
      const closeBtn = document.getElementById('lowstock-close');
      const refreshBtn = document.getElementById('lowstock-refresh');
      const notifyAllBtn = document.getElementById('notify-all-lowstock');
      const notifySelectedBtn = document.getElementById('notify-selected-lowstock');

      async function fetchVariants(){
        try{
          const res = await fetch(`${API_BASE}/api/admin/inventory/public/variants`);
          if(!res.ok) return [];
          const json = await res.json();
          return json.success ? (json.data || []) : [];
        }catch(err){ console.debug('fetchVariants failed', err && err.message); return []; }
      }

      // fetch availability for a given variant name
      async function fetchAvailabilityByName(name, token){
        try{
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const res = await fetch(`${API_BASE}/api/admin/inventory/availability?name=${encodeURIComponent(name)}`, { headers });
          if(!res.ok) return null;
          const json = await res.json();
          return json.success ? json.data : null;
        }catch(err){ console.debug('availability fetch failed', err && err.message); return null; }
      }

      // compute low-stock items (any size <= threshold)
      async function fetchLowStockItems(threshold = LOW_STOCK_THRESHOLD){
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        const variants = await fetchVariants();
        const found = [];
        // limit to first 200 variants to avoid huge loads
        const slice = variants.slice(0, 200);
        await Promise.all(slice.map(async v => {
          const avail = await fetchAvailabilityByName(v.name, token);
          if(!avail) return;
          const sizes = avail.sizesInventory || {};
          const reserved = avail.reservedSizes || {};
          const perSize = [];
          Object.keys(sizes).forEach(sz=>{
            const total = Number(sizes[sz] || 0);
            const resv = Number(reserved[sz] || 0);
            const available = Math.max(0, total - resv);
            if(available <= threshold){
              perSize.push({ size: sz, available, reserved: resv });
            }
          });
          if(perSize.length) {
            found.push({ id: avail.id || avail._id || v._id || '', name: v.name, perSize, raw: avail });
          }
        }));
        return found;
      }

      function renderLowStockList(items){
        modalBody.innerHTML = '';
        if(!items || !items.length){
          modalBody.innerHTML = '<tr><td class="p-2" colspan="4">No low-stock items found.</td></tr>';
          return;
        }
        items.forEach(it => {
          it.perSize.forEach(ps => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="p-2">${escapeHtml(it.name)}</td>
              <td class="p-2">${escapeHtml(ps.size)}</td>
              <td class="p-2 text-red-600 font-semibold">${ps.available}</td>
              <td class="p-2">${ps.reserved}</td>
            `;
            // attach dataset for notify
            tr.dataset.itemId = it.id || '';
            tr.dataset.itemName = it.name || '';
            tr.dataset.size = ps.size;
            tr.dataset.available = ps.available;
            modalBody.appendChild(tr);
          });
        });
      }

      function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

      function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
      function closeModal(){ modal.classList.remove('flex'); modal.classList.add('hidden'); }

      async function refreshLowStockUI(){
        try{
            viewBtn.disabled = true; notifyBtn.disabled = true;
            const items = await fetchLowStockItems();
            lowstockCountEl.textContent = String(items.length || 0);
            return items;
          }finally{ viewBtn.disabled = false; notifyBtn.disabled = false; }
      }

      async function notifyLowStock(items){
        if(!items || !items.length) { alert('No items to notify.'); return; }
        const token = localStorage.getItem('token');
        try{
          const res = await fetch(`${API_BASE}/api/admin/notifications/low-stock`, {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': `Bearer ${token}` } : {}),
            body: JSON.stringify({ items })
          });
          const j = await res.json();
          if(!j.success) throw new Error(j.message || 'Notify failed');
          alert('Notification sent to admin.');
        }catch(err){ alert('Failed to send notification: ' + (err.message||err)); }
      }

      // wire buttons
      viewBtn.addEventListener('click', async ()=>{
        viewBtn.disabled = true; viewBtn.textContent = 'Loading...';
        try{
          const items = await fetchLowStockItems();
          renderLowStockList(items);
          openModal();
        }catch(err){ alert('Error loading low-stock items'); }
        finally{ viewBtn.disabled = false; viewBtn.textContent = 'View Low Stock'; }
      });

      notifyBtn.addEventListener('click', async ()=>{
        notifyBtn.disabled = true; notifyBtn.textContent = 'Notifying...';
        try{
          const items = await fetchLowStockItems();
          await notifyLowStock(items);
        }catch(err){ alert('Error notifying admin'); }
        finally{ notifyBtn.disabled = false; notifyBtn.textContent = 'Notify Admin'; }
      });

      closeBtn.addEventListener('click', closeModal);
      refreshBtn.addEventListener('click', async ()=>{
        refreshBtn.disabled = true; refreshBtn.textContent = 'Refreshing...';
        try{ const items = await refreshLowStockUI(); renderLowStockList(items); }catch(e){} finally{ refreshBtn.disabled = false; refreshBtn.textContent = 'Refresh'; }
      });

      notifyAllBtn.addEventListener('click', async ()=>{
        notifyAllBtn.disabled = true; notifyAllBtn.textContent = 'Notifying...';
        try{
          // collect all rows in modal
          const rows = Array.from(modalBody.querySelectorAll('tr'));
          const items = rows.map(r => ({
            id: r.dataset.itemId,
            name: r.dataset.itemName,
            size: r.dataset.size,
            available: Number(r.dataset.available || 0)
          }));
          await notifyLowStock(items);
        }catch(err){ console.debug(err); }
        finally{ notifyAllBtn.disabled = false; notifyAllBtn.textContent = 'Notify All'; }
      });

      notifySelectedBtn.addEventListener('click', async ()=>{
        // notify only the currently visible rows
        notifySelectedBtn.disabled = true; notifySelectedBtn.textContent = 'Notifying...';
        try{
          const rows = Array.from(modalBody.querySelectorAll('tr'));
          const items = rows.map(r => ({
            id: r.dataset.itemId,
            name: r.dataset.itemName,
            size: r.dataset.size,
            available: Number(r.dataset.available || 0)
          }));
          await notifyLowStock(items);
        }catch(err){ console.debug(err); }
        finally{ notifySelectedBtn.disabled = false; notifySelectedBtn.textContent = 'Notify Selected'; }
      });

      // initial check on page load
      (async function initLowStock(){
        try{
          const items = await refreshLowStockUI();
          // if any low-stock items exist, optionally auto-open modal or auto-notify
          if(items && items.length){
            // highlight visually by adding small pulse to the card (simple)
            const card = document.getElementById('low-stock-count');
            if(card) card.classList.add('animate-pulse');
            // auto-send a notification once per page load (comment/uncomment as desired)
            // await notifyLowStock(items);
          }
        }catch(err){ console.debug('low-stock init failed', err); }
      })();
    })();
  </script>
</script>
<script src="admin-notifications.js"></script>
</body>
</html>
