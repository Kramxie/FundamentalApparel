<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Print only the receipt section when printing */
    @media print {
      body * { visibility: hidden; }
      #receipt-wrap, #receipt-wrap * { visibility: visible; }
      #receipt-wrap { position: absolute; left: 0; top: 0; width: 100%; background: white; }
    }

    /* --- FIX PARA SA @APPLY WARNING --- */
    .admin-tab {
      font-size: 1.125rem;
      /* text-lg */
      font-weight: 600;
      /* font-semibold */
      color: rgb(156 163 175);
      /* text-gray-400 */
      padding-bottom: 0.5rem;
      /* pb-2 */
      cursor: pointer;
      /* cursor-pointer */
    }

    .admin-tab.active {
      color: rgb(17 24 39);
      /* text-gray-900 */
      border-bottom-width: 2px;
      /* border-b-2 */
      border-color: rgb(17 24 39);
      /* border-gray-900 */
    }

    /* --- END FIX --- */
  </style>
</head>

<body class="bg-gray-100">
  <div id="dev-error-banner" class="hidden fixed top-16 left-1/2 transform -translate-x-1/2 z-50 bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded-md text-sm"></div>
  <div class="flex h-screen bg-gray-100">
    <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
      <div class="flex items-center justify-center h-16 bg-white shadow-md">
        <span class="text-2xl font-bold text-indigo-600">Admin Panel</span>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
          </a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
          </a>
          <a href="manage-products.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
          </a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
          </a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
          </a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
          </a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
          </a>
          <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span>
          </a>
        </nav>
      </div>
    </div>

    <div class="flex flex-col flex-1 overflow-hidden">
      <!-- Header with proper spacing -->
      <div class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
        <h1 class="text-xl font-semibold text-gray-800">Orders</h1>
        <div class="flex items-center gap-3">
          <div class="relative">
            <button id="notif-btn" class="px-3 py-2 bg-white border rounded-md hover:bg-gray-50" title="Notifications">
              <i class="fas fa-bell text-gray-700"></i>
              <span id="notif-count" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs px-1 rounded-full">0</span>
            </button>
            <div id="notif-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border rounded shadow-lg z-50 overflow-auto max-h-80">
              <div id="notif-list" class="p-2"></div>
              <div class="p-2 text-center border-t"><button id="notif-markall" class="text-sm text-indigo-600">Mark all read</button></div>
            </div>
          </div>
          <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </button>
        </div>
      </div>

      <!-- Main content with overflow scroll -->
      <div class="flex-1 overflow-y-auto">
      <div class="p-6 space-y-6">
        <div class="bg-white p-4 rounded-lg shadow">
          <div id="tabs-container" class="flex gap-8">
            <button data-tab="regular" class="admin-tab active">Manage Orders</button>
            <button data-tab="custom" class="admin-tab">Manage Custom Orders</button>
          </div>
        </div>

        <div id="tab-content-regular">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
              <div class="flex gap-3 items-center">
                <select id="filter-status" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Order Status</option>
                  <option value="to-pay">To Pay</option>
                  <option value="to-ship">To Ship</option>
                  <option value="to-receive">To Receive</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
                <select id="filter-payment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Payment</option>
                  <option>Pending</option>
                  <option>Received</option>
                  <option>Rejected</option>
                </select>
                <select id="filter-shipping" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Shipping</option>
                  <option value="Standard">Standard</option>
                  <option value="Pick-Up">Pick-Up</option>
                </select>
                <input id="search" type="text" placeholder="Search (order id, customer, tracking)..." class="border rounded-md px-3 py-2 text-sm w-56">
                <input id="date-from" type="date" class="border rounded-md px-3 py-2 text-sm">
                <input id="date-to" type="date" class="border rounded-md px-3 py-2 text-sm">
                <button id="filter-reset" class="px-3 py-2 text-sm border rounded hover:bg-gray-50">Reset</button>
              </div>
              <div class="text-sm text-gray-500"><span id="count">0</span> orders</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left px-4 py-3">Order ID</th>
                    <th class="text-left px-4 py-3">Created</th>
                    <th class="text-left px-4 py-3">Payment Status</th>
                    <th class="text-left px-4 py-3">Order Status</th>
                    <th class="text-left px-4 py-3">Items</th>
                    <th class="text-left px-4 py-3">Customer</th>
                    <th class="text-left px-4 py-3">Shipping</th>
                    <th class="text-left px-4 py-3">Tracking</th>
                    <th class="text-right px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="orders-body" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-content-custom" class="hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
              <div class="flex flex-wrap gap-2 items-center">
                <input id="custom-search" type="text" placeholder="Search name, ref, courier..." class="border rounded-md px-3 py-2 text-sm w-56">
                <select id="custom-filter-status" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Status</option>
                  <option>Pending Quote</option>
                  <option>Quote Sent</option>
                  <option>Pending Downpayment</option>
                  <option>In Production</option>
                  <option>Pending Balance</option>
                  <option>Pending Final Verification</option>
                  <option>Ready for Pickup/Delivery</option>
                  <option>Out for Delivery</option>
                  <option>Completed</option>
                  <option>Cancelled</option>
                </select>
                <select id="custom-filter-type" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Type</option>
                  <option>Customize Product</option>
                  <option>Upload File</option>
                </select>
                <select id="custom-filter-shipmethod" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Shipping Method</option>
                  <option>Standard</option>
                  <option>Pick-Up</option>
                </select>
                <select id="custom-filter-fulfillment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Fulfillment</option>
                  <option>pending</option>
                  <option>pickup</option>
                  <option>delivery</option>
                </select>
                <select id="custom-filter-payment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Payment Stage</option>
                  <option value="dp-paid">Downpayment Paid</option>
                  <option value="dp-unpaid">Downpayment Pending</option>
                  <option value="bal-paid">Balance Paid</option>
                  <option value="bal-unpaid">Balance Pending</option>
                </select>
                <select id="custom-filter-courier" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Courier</option>
                  <option value="has">Has Courier</option>
                  <option value="none">No Courier</option>
                </select>
                <select id="custom-filter-tracking" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Tracking</option>
                  <option value="has">Has Tracking</option>
                  <option value="none">No Tracking</option>
                </select>
                <div class="flex items-center gap-2">
                  <input id="custom-date-from" type="date" class="border rounded-md px-2 py-1.5 text-sm" />
                  <span class="text-gray-400 text-xs">to</span>
                  <input id="custom-date-to" type="date" class="border rounded-md px-2 py-1.5 text-sm" />
                </div>
                <button id="custom-filter-reset" class="px-3 py-2 text-sm border rounded hover:bg-gray-50">Reset</button>
              </div>
              <div class="text-sm text-gray-500"><span id="custom-count">0</span> custom requests</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left px-4 py-3">Date</th>
                    <th class="text-left px-4 py-3">Customer</th>
                    <th class="text-left px-4 py-3">Type</th>
                    <th class="text-left px-4 py-3">Qty</th>
                    <th class="text-left px-4 py-3">Status</th>
                    <th class="text-left px-4 py-3">Shipping</th>
                    <th class="text-left px-4 py-3">Details</th>
                    <th class="text-right px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="custom-orders-body" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-3xl w-full overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 class="font-semibold text-gray-800">Order Details</h3>
        <button id="modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
        <div>
          <h4 class="font-semibold mb-2">Order Summary</h4>
          <div id="modal-items" class="space-y-3 text-sm"></div>
          <div class="mt-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span> <span id="modal-subtotal">0</span></div>
            <div class="flex justify-between"><span>Delivery Fee</span> <span id="modal-delivery">0</span></div>
            <div class="flex justify-between font-semibold"><span>Total</span> <span id="modal-total">0</span></div>
          </div>
          <div class="mt-3">
            <button id="modal-receipt-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm border rounded hover:bg-gray-50"><i class="fas fa-receipt text-green-600"></i>View Receipt</button>
          </div>
          <!-- Receipt-like section (toggle within modal) moved under Order Summary -->
          <div id="receipt-wrap" class="hidden mt-4 border rounded-lg overflow-hidden">
            <div class="p-4 bg-gray-50 flex items-center justify-between">
              <div>
                <p class="text-xs text-gray-500">Reference Number</p>
                <p id="receipt-reference" class="font-mono font-semibold text-gray-800">-</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="receipt-copy-ref" class="px-2 py-1 text-xs border rounded hover:bg-gray-100" title="Copy reference"><i class="fas fa-copy mr-1"></i>Copy</button>
                <button id="receipt-print" class="px-2 py-1 text-xs border rounded hover:bg-gray-100" title="Print receipt"><i class="fas fa-print mr-1"></i>Print</button>
                <a id="receipt-open-url" href="#" target="_blank" class="hidden px-2 py-1 text-xs border rounded hover:bg-gray-100" title="Open gateway receipt"><i class="fas fa-external-link-alt mr-1"></i>Open</a>
              </div>
            </div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p class="text-sm text-gray-500">Payment amount</p>
                  <p id="receipt-amount" class="text-3xl font-extrabold text-green-600">‚Ç±0.00</p>
                  <div class="mt-2 text-sm space-y-1">
                    <div class="flex justify-between"><span class="text-gray-600">Payment date</span><span id="receipt-date" class="font-medium"></span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Payment method</span><span id="receipt-method" class="font-medium"></span></div>
                  </div>
                  <div class="mt-3">
                    <p class="font-semibold">Payment for</p>
                    <p class="text-sm text-gray-700">Order #<span id="receipt-shortid"></span></p>
                    <p class="text-xs text-gray-500">Customer: <span id="receipt-customer"></span></p>
                  </div>
                </div>
                <div class="flex items-center justify-center">
                  <div class="text-center">
                    <div class="text-green-500 text-5xl"><i class="fas fa-check-circle"></i></div>
                    <p id="receipt-status" class="text-green-700 font-semibold mt-2">Payment received</p>
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="text-left px-2 py-2">Item name</th>
                      <th class="text-left px-2 py-2">Qty</th>
                      <th class="text-right px-2 py-2">Price</th>
                    </tr>
                  </thead>
                  <tbody id="receipt-items"></tbody>
                </table>
                <div class="mt-3 text-sm">
                  <div class="flex justify-between"><span>Delivery Fee</span><span id="receipt-delivery">‚Ç±0.00</span></div>
                  <div class="flex justify-between font-semibold"><span>Total</span><span id="receipt-total">‚Ç±0.00</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Payment and Shipping</h4>
          <div class="text-sm space-y-2">
            <div><span class="text-gray-500">Payment Method:</span> <span id="modal-paymentMethod"></span></div>
            <div><span class="text-gray-500">Shipping Method:</span> <span id="modal-shippingMethod"></span></div>
            <div><span class="text-gray-500">Payment Status:</span> <span id="modal-paymentStatus"></span></div>
            <div><span class="text-gray-500">Payment Reference:</span> <span id="modal-paymentRef" class="font-mono"></span></div>
          </div>
          <div class="mt-4">
            <h5 class="font-medium mb-2">Shipping Address</h5>
            <div id="modal-address" class="text-sm text-gray-700"></div>
          </div>
          <div id="modal-cancellation-details" class="hidden mt-4 text-sm space-y-1">
            <h5 class="font-medium mb-1">Cancellation Details</h5>
            <div class="bg-red-50 p-3 rounded-md">
              <p><strong>Cancelled By:</strong> <span id="modal-cancelled-by"></span></p>
              <p><strong>Reason:</strong> <span id="modal-cancellation-reason"></span></p>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div>
              <label class="block text-gray-700 mb-1">Payment Status</label>
              <select id="form-paymentStatus" class="w-full border rounded px-3 py-2">
                <option>Pending</option>
                <option>Received</option>
                <option>Rejected</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Order Status</label>
              <select id="form-status" class="w-full border rounded px-3 py-2">
                <option>Processing</option>
                <option>Accepted</option>
                <option>Shipped</option>
                <option>Delivered</option>
                <option>Cancelled</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Shipping Service</label>
              <select id="form-shippingService" class="w-full border rounded px-3 py-2">
                <option value="">-- Select Courier --</option>
                <option value="Lalamove">Lalamove</option>
                <option value="J&T Express">J&T Express</option>
                <option value="LBC Express">LBC Express</option>
                <option value="Ninja Van">Ninja Van</option>
                <option value="Flash Express">Flash Express</option>
                <option value="JRS Express">JRS Express</option>
                <option value="2GO Express">2GO Express</option>
                <option value="DHL">DHL</option>
                <option value="FedEx">FedEx</option>
                <option value="Store Pickup">Store Pickup</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Tracking Code</label>
              <input id="form-trackingCode" type="text" class="w-full border rounded px-3 py-2"
                placeholder="Tracking number">
            </div>
          </div>
          <div id="modal-admin-cancel-reason-box" class="hidden mt-3 text-sm">
            <label class="block text-gray-700 mb-1">Reason for Cancellation (Admin)</label>
            <input id="form-cancellationReason" type="text" class="w-full border rounded px-3 py-2"
              placeholder="e.g., Out of stock">
          </div>
        </div>
        <div id="modal-refund-section" class="hidden mt-4 text-sm space-y-2 border-t pt-3">
          <h5 class="font-medium mb-1">Return / Refund Request</h5>
          <div class="bg-yellow-50 p-3 rounded-md">
            <p><strong>Status:</strong> <span id="modal-refund-status">-</span></p>
            <p><strong>Reason:</strong> <span id="modal-refund-reason">-</span></p>
            <p><strong>Amount:</strong> <span id="modal-refund-amount">-</span></p>
            <div id="modal-refund-media" class="mt-2 flex gap-2 flex-wrap"></div>
            <div class="mt-2"><label class="block text-sm">Admin Notes</label><textarea id="modal-refund-adminnotes" class="w-full border rounded px-2 py-1 text-sm" rows="2"></textarea></div>
            <div class="mt-3 flex gap-2">
              <button id="btn-approve-refund" class="px-3 py-1 text-sm bg-green-600 text-white rounded">Approve</button>
              <button id="btn-reject-refund" class="px-3 py-1 text-sm bg-red-600 text-white rounded">Reject</button>
              <button id="btn-process-refund" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded">Process Refund</button>
            </div>
            <p id="modal-refund-msg" class="text-sm text-red-600 mt-2"></p>
          </div>
        </div>
      </div>
      <div class="px-5 py-3 border-t flex items-center justify-end gap-3">
        <p id="modal-error" class="text-sm text-red-600 mr-auto"></p>
        <button id="modal-save"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-4 py-2 rounded">Save</button>
        <button id="modal-remove" class="hidden bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded">Remove</button>
      </div>
    </div>
  </div>

  <div id="custom-order-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-6xl w-full overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50">
        <h3 class="text-lg font-semibold text-gray-800">Custom Order Request</h3>
        <button id="custom-modal-close" class="text-gray-500 hover:text-gray-700 text-xl"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 max-h-[80vh] overflow-y-auto space-y-6">
        <!-- Error Message (Full Width) -->
        <div id="custom-modal-error" class="hidden text-sm p-3 rounded-md bg-red-100 text-red-700"></div>
        
        <!-- Two Column Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- LEFT COLUMN -->
          <div class="space-y-6">
            <!-- Basic Information -->
            <div class="bg-gray-50 p-4 rounded-lg border">
              <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-info-circle mr-2 text-indigo-600"></i>
                Order Information
              </h4>
              <div class="text-sm space-y-2">
                <p><strong>Customer:</strong> <span id="custom-modal-user"></span></p>
                <p><strong>Quantity:</strong> <span id="custom-modal-qty"></span></p>
                <p><strong>Type:</strong> <span id="custom-modal-type"></span></p>
              </div>
            </div>

            <!-- Service Type Badge -->
            <div id="custom-modal-service-type-section">
              <span id="custom-modal-service-badge" class="inline-block px-3 py-1 rounded-full text-sm font-semibold"></span>
            </div>

        <!-- Customize Jersey Details -->
        <div id="custom-modal-customize-jersey-section" class="hidden space-y-3">
          <div class="border-t pt-3">
            <h4 class="font-semibold text-gray-800 mb-2">üéΩ Jersey Customization</h4>
            <div class="space-y-2 text-sm">
              <p><strong>Item Type:</strong> <span id="custom-modal-item-type"></span></p>
              <p><strong>Printing Type:</strong> <span id="custom-modal-printing-type"></span></p>
              
              <!-- Template Design Fields -->
              <div id="custom-modal-template-fields" class="hidden bg-gray-50 p-3 rounded border space-y-2">
                <p class="font-medium text-indigo-900">Template Design:</p>
                <p><strong>Design Style:</strong> <span id="custom-modal-design-style"></span></p>
                <div id="custom-modal-colors-section">
                  <strong>Colors:</strong>
                  <div class="flex gap-2 mt-1">
                    <div id="custom-modal-primary-color" class="w-8 h-8 rounded border-2 border-gray-300" title="Primary Color"></div>
                    <div id="custom-modal-secondary-color" class="w-8 h-8 rounded border-2 border-gray-300" title="Secondary Color"></div>
                    <div id="custom-modal-accent-color" class="w-8 h-8 rounded border-2 border-gray-300" title="Accent Color"></div>
                  </div>
                </div>
                <div id="custom-modal-text-section" class="hidden">
                  <p><strong>Custom Text:</strong> <span id="custom-modal-custom-text"></span></p>
                  <p><strong>Font:</strong> <span id="custom-modal-text-font"></span> | <strong>Size:</strong> <span id="custom-modal-text-size"></span></p>
                  <p><strong>Placement:</strong> <span id="custom-modal-text-placement"></span></p>
                </div>
                <div id="custom-modal-logo-section" class="hidden">
                  <p><strong>Logo Type:</strong> <span id="custom-modal-logo-type"></span></p>
                  <p><strong>Logo Placement:</strong> <span id="custom-modal-logo-placement"></span></p>
                  <div id="custom-modal-logo-preview"></div>
                </div>
              </div>

              <!-- Upload Design File -->
              <div id="custom-modal-design-file-section" class="hidden">
                <strong>Design File:</strong>
                <div id="custom-modal-design-file" class="mt-1"></div>
              </div>

              <!-- Professional Customizer (3-panel) Details -->
              <div id="custom-modal-pro-section" class="hidden bg-gray-50 p-3 rounded border space-y-2">
                <p class="font-medium text-indigo-900">Professional Customizer Details:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <p><strong>Garment:</strong> <span id="pro-garment"></span></p>
                  <p><strong>Location:</strong> <span id="pro-location"></span></p>
                </div>
                <div id="colors-section">
                  <strong>Colors Selected:</strong>
                  <div id="colors-container" class="flex gap-3 mt-2 flex-wrap">
                    <!-- Colors will be dynamically inserted here -->
                  </div>
                </div>
                <div id="pro-design-text-wrap" class="hidden">
                  <p><strong>Design Text:</strong> <span id="pro-design-text"></span></p>
                </div>
                <div id="pro-design-image-wrap" class="hidden">
                  <p class="mb-2"><strong>Design Images:</strong></p>
                  <div id="pro-design-image" class="grid grid-cols-2 gap-3"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <p><strong>Printing Type:</strong> <span id="pro-printing-type"></span></p>
                  <p><strong>Quantity:</strong> <span id="pro-qty"></span></p>
                </div>
                <div id="pro-team-wrap" class="hidden">
                  <p class="font-medium mt-2">Team Entries:</p>
                  <div class="overflow-x-auto">
                    <table class="min-w-full text-xs border">
                      <thead class="bg-indigo-100">
                        <tr>
                          <th class="border px-2 py-1 text-left">Name</th>
                          <th class="border px-2 py-1 text-left">#</th>
                          <th class="border px-2 py-1 text-left">Size</th>
                        </tr>
                      </thead>
                      <tbody id="pro-team-tbody" class="bg-white"></tbody>
                    </table>
                  </div>
                </div>
                <div id="pro-pricing-wrap" class="hidden">
                  <p class="font-medium mt-2">Pricing Breakdown:</p>
                  <pre id="pro-pricing-json" class="text-[11px] bg-white border rounded p-2 overflow-auto max-h-40"></pre>
                </div>
              </div>

              <!-- Team Details -->
              <div id="custom-modal-team-section" class="hidden bg-blue-50 p-3 rounded border border-blue-200 space-y-2">
                <h5 class="font-semibold text-blue-900">üë• Team Order</h5>
                <p><strong>Team Name:</strong> <span id="custom-modal-team-name"></span></p>
                <div id="custom-modal-team-members-container" class="hidden">
                  <p class="font-medium mt-2 mb-1">Team Members:</p>
                  <div class="overflow-x-auto">
                    <table class="min-w-full text-xs border">
                      <thead class="bg-blue-100">
                        <tr>
                          <th class="border px-2 py-1 text-left">Name</th>
                          <th class="border px-2 py-1 text-left">Number</th>
                          <th class="border px-2 py-1 text-left">Size</th>
                        </tr>
                      </thead>
                      <tbody id="custom-modal-team-members-tbody" class="bg-white">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Shorts Details -->
              <div id="custom-modal-shorts-section" class="hidden bg-purple-50 p-3 rounded border border-purple-200 space-y-2">
                <h5 class="font-semibold text-purple-900">ü©≥ Shorts Included</h5>
                <p><strong>Same Design as Jersey:</strong> <span id="custom-modal-shorts-same"></span></p>
                <div id="custom-modal-shorts-different-container" class="hidden mt-2">
                  <p class="text-xs text-purple-700">Different Shorts Design:</p>
                  <div id="custom-modal-shorts-details"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout Creation Details -->
        <div id="custom-modal-layout-section" class="hidden space-y-3">
          <div class="border-t pt-3">
            <h4 class="font-semibold text-gray-800 mb-2">üé® Layout Creation</h4>
            <div class="space-y-2 text-sm">
              <div id="custom-modal-inspiration-image-container">
                <strong>Inspiration Image:</strong>
                <div id="custom-modal-inspiration-image" class="mt-2"></div>
              </div>
              <p><strong>Team Name:</strong> <span id="custom-modal-layout-team"></span></p>
              <p><strong>Member Name:</strong> <span id="custom-modal-layout-member"></span></p>
              <p><strong>Jersey Number:</strong> <span id="custom-modal-layout-number"></span></p>
              <div id="custom-modal-color-palette-section">
                <strong>Color Palette:</strong>
                <div id="custom-modal-color-palette" class="flex gap-2 mt-1 flex-wrap"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Printing Only Details -->
        <div id="custom-modal-printing-section" class="hidden space-y-3">
          <div class="border-t pt-3">
            <h4 class="font-semibold text-gray-800 mb-2">üñ®Ô∏è Printing Only</h4>
            <div class="space-y-2 text-sm">
              <p><strong>Printing Method:</strong> <span id="custom-modal-printing-method"></span></p>
              <p><strong>Fabric Type:</strong> <span id="custom-modal-fabric-type">N/A</span></p>
              <p><strong>Inventory:</strong> <span id="custom-modal-fabric-available">-</span> available ¬∑ <span id="custom-modal-fabric-reserved">-</span> reserved</p>
              <p><strong>Garment Type:</strong> <span id="custom-modal-garment-type">N/A</span></p>
              <p id="custom-modal-garment-size-row"><strong>Garment Size:</strong> <span id="custom-modal-garment-size"></span></p>
              <div id="custom-modal-printing-file-section" class="hidden">
                <strong>Design File:</strong>
                <div id="custom-modal-printing-file" class="mt-1"></div>
              </div>
              <div id="custom-modal-po-team-section" class="hidden bg-blue-50 p-3 rounded border border-blue-200 space-y-2">
                <div class="flex items-center justify-between">
                  <h5 class="font-semibold text-blue-900">üë• Team List</h5>
                  <a id="custom-modal-po-team-file-link" href="#" target="_blank" class="hidden text-blue-700 text-xs hover:underline">Download original file</a>
                </div>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-xs border">
                    <thead class="bg-blue-100">
                      <tr>
                        <th class="border px-2 py-1 text-left">Surname / Name</th>
                        <th class="border px-2 py-1 text-left">Number</th>
                        <th class="border px-2 py-1 text-left">Size</th>
                      </tr>
                    </thead>
                    <tbody id="custom-modal-po-team-tbody" class="bg-white"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
          </div>
          <!-- END LEFT COLUMN -->

          <!-- RIGHT COLUMN -->
          <div class="space-y-6">
        <!-- Customer Notes -->
        <div class="bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-clipboard mr-2 text-indigo-600"></i>
            Customer Notes
          </h4>
          <div id="custom-modal-notes" class="text-sm bg-white p-3 rounded-md border min-h-[50px]"></div>
        </div>

        <!-- Payment Receipts -->
        <div id="custom-modal-dp-section" class="hidden bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-receipt mr-2 text-green-600"></i>
            Down Payment Receipt
          </h4>
          <div id="custom-modal-dp-receipt" class="text-sm"></div>
        </div>
        
        <div id="custom-modal-fp-section" class="hidden bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-receipt mr-2 text-blue-600"></i>
            Final Payment Receipt
          </h4>
          <div id="custom-modal-fp-receipt" class="text-sm"></div>
        </div>

        <!-- Quote Form -->
        <div id="custom-modal-quote-box" class="hidden bg-indigo-50 p-4 rounded-lg border border-indigo-200 space-y-3">
          <h4 class="font-semibold text-indigo-900 mb-2">üí∞ Set Quote Price</h4>
          <div>
            <label for="form-custom-price" class="block text-sm font-medium mb-1">Total Price (PHP)</label>
            <input id="form-custom-price" type="number" min="0" class="w-full border rounded px-3 py-2 text-sm" placeholder="Enter total amount">
          </div>
          <div>
            <label for="form-pricing-notes" class="block text-sm font-medium mb-1">Pricing Breakdown / Notes</label>
            <textarea id="form-pricing-notes" rows="3" class="w-full border rounded px-3 py-2 text-sm" placeholder="Materials, Printing, Discounts..."></textarea>
          </div>
        </div>

        <!-- Price Display -->
        <div id="custom-modal-info-box" class="hidden bg-green-50 p-4 rounded-lg border border-green-200">
          <p class="text-sm"><strong>Total Price:</strong> <span id="custom-modal-price-display" class="font-bold text-xl text-green-700"></span></p>
          <p id="custom-modal-info-text" class="text-sm text-gray-600 mt-1">Waiting for user to accept quote.</p>
        </div>

        <!-- Fulfillment Details Section -->
        <div id="custom-modal-fulfillment-section" class="hidden bg-gray-50 p-4 rounded-lg border space-y-3">
          <h4 class="font-semibold text-gray-800 flex items-center">
            <i class="fas fa-truck mr-2 text-purple-600"></i>
            Fulfillment Details
          </h4>
          
          <div id="custom-modal-fulfillment-info" class="text-sm bg-white p-3 rounded-md border">
            <!-- This will be populated dynamically -->
          </div>

          <!-- Admin form to add tracking/pickup details -->
          <div id="custom-modal-fulfillment-form" class="hidden space-y-3 p-3 bg-indigo-50 rounded-md border border-indigo-200">
            <p class="text-xs font-medium text-indigo-900">Add Fulfillment Details:</p>
            
            <!-- For Delivery -->
            <div id="fulfillment-delivery-fields" class="hidden space-y-2">
              <!-- Show delivery address -->
              <div id="fulfillment-delivery-address" class="bg-white p-2 rounded border text-sm">
                <span class="font-medium text-gray-700">Delivery Address:</span>
                <p id="delivery-address-text" class="text-gray-900 mt-1"></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">Courier Service</label>
                <select id="fulfillment-courier" class="w-full border rounded px-3 py-2 text-sm">
                  <option value="">Select Courier</option>
                  <option value="J&T Express">J&T Express</option>
                  <option value="LBC">LBC</option>
                  <option value="JRS Express">JRS Express</option>
                  <option value="Grab Express">Grab Express</option>
                  <option value="Lalamove">Lalamove</option>
                  <option value="Ninja Van">Ninja Van</option>
                  <option value="Flash Express">Flash Express</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Tracking Number</label>
                <input id="fulfillment-tracking" type="text" class="w-full border rounded px-3 py-2 text-sm" placeholder="Enter tracking number">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Estimated Delivery Date</label>
                <input id="fulfillment-delivery-date" type="date" class="w-full border rounded px-3 py-2 text-sm">
              </div>
            </div>

            <!-- For Pickup -->
            <div id="fulfillment-pickup-fields" class="hidden space-y-2">
              <div>
                <label class="block text-sm font-medium mb-1">Pickup Date</label>
                <input id="fulfillment-pickup-date" type="date" class="w-full border rounded px-3 py-2 text-sm">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Pickup Location</label>
                <input id="fulfillment-pickup-location" type="text" class="w-full border rounded px-3 py-2 text-sm" value="Fundamental Store - 123 Main St, Manila">
              </div>
            </div>

            <button id="custom-modal-save-fulfillment" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded text-sm w-full">
              <i class="fas fa-paper-plane mr-2"></i>Submit Tracking Details
            </button>
          </div>
        </div>
          </div>
          <!-- END RIGHT COLUMN -->
        </div>
        <!-- END TWO COLUMN GRID -->
      </div>
      
      <!-- Modal Footer -->
      <div class="px-6 py-4 border-t bg-gray-50 flex items-center justify-between gap-3">
        <p id="custom-modal-error" class="text-sm text-red-600 mr-auto"></p> 
        <div class="flex items-center gap-2"> 
          <button id="custom-modal-save-quote" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-paper-plane mr-2"></i>Send Quote
          </button>
          <button id="custom-modal-verify-dp" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-check-circle mr-2"></i>Verify DP
          </button>
          <button id="custom-modal-request-final" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-money-bill-wave mr-2"></i>Request Final Payment
          </button>
          <button id="custom-modal-verify-final" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-check-circle mr-2"></i>Verify Final Payment
          </button>
        </div>
      </div>
  </div>

  <!-- Payment Receipt Modal for Custom Orders -->
  <div id="custom-payment-receipt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <i class="fas fa-receipt text-green-600"></i>View Receipt
        </h3>
        <button onclick="closeCustomPaymentModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="custom-payment-receipt-content" class="p-6">
        <!-- Receipt content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Payment Details Modal removed: payment info now shown directly in Order Details modal -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const API = 'https://fundamental-apparel-backend.onrender.com'; // O ang ngrok URL mo

    function peso(n) { return '‚Ç±' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function shortId(id) { return id ? id.slice(0, 8) : '-'; }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken');
      if (!token) { window.location.href = 'login.html'; return; }

      // Notifications setup
      const notifBtn = document.getElementById('notif-btn');
      const notifCountEl = document.getElementById('notif-count');
      const notifDropdown = document.getElementById('notif-dropdown');
      const notifList = document.getElementById('notif-list');
      const notifMarkAll = document.getElementById('notif-markall');

      // Connect socket.io with auth token
      let socket = null;
      try {
        socket = io(API, { auth: { token } });
        socket.on('connect', () => console.log('Socket connected'));
        socket.on('notification', (n) => {
          // Prepend notification
          prependNotif(n);
        });
      } catch (e) { console.warn('Socket init failed', e.message); }

      async function loadNotifications() {
        try {
          const res = await fetch(`${API}/api/admin/notifications`, { headers: { 'Authorization': `Bearer ${token}` } });
          const j = await res.json();
          if (!res.ok || !j.success) throw new Error(j.msg || 'Failed to load');
          await renderNotifs(j.data || []);
        } catch (e) { console.warn('Failed to load notifications', e.message); }
      }

      async function renderNotifs(arr) {
        notifList.innerHTML = '';
        let unread = 0;
        (arr || []).forEach(n => {
          const el = document.createElement('div');
          el.className = 'p-2 border-b text-sm';
          if (!n.read) { el.className += ' bg-gray-50'; unread++; }
          const orderId = n.meta && n.meta.orderId ? n.meta.orderId : '';
          el.setAttribute('data-orderid', orderId);
          el.innerHTML = `<div class="font-medium">${n.title}</div><div class="text-xs text-gray-600">${n.body || ''}</div><div class="text-xs text-gray-400 mt-1">${new Date(n.createdAt).toLocaleString()}</div><div class="mt-2 text-right"><button data-id="${n._id}" class="mark-read text-xs text-indigo-600">Mark read</button></div>`;
          // clicking the notification opens the order modal if orderId present
          if (orderId) {
            el.style.cursor = 'pointer';
            el.addEventListener('click', (ev) => {
              // avoid click when pressing Mark read button
              if (ev.target && ev.target.classList && ev.target.classList.contains('mark-read')) return;
              const ord = allOrders.find(o => o._id === orderId);
              if (ord) {
                openModal(ord);
                notifDropdown.classList.add('hidden');
              } else {
                // try to lazy-load order details and open
                fetch(`${API}/api/orders/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(j => {
                  if (j && j.success) openModal(j.data);
                }).catch(() => {});
              }
            });
          }
          notifList.appendChild(el);
        });
        if (unread > 0) { notifCountEl.textContent = unread; notifCountEl.classList.remove('hidden'); } else { notifCountEl.classList.add('hidden'); }
        // Bind mark-read buttons
        Array.from(document.getElementsByClassName('mark-read')).forEach(b => b.addEventListener('click', async (ev) => {
          const id = ev.target.dataset.id;
          try {
            const r = await fetch(`${API}/api/admin/notifications/${id}/read`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } });
            const j = await r.json();
            if (!r.ok || !j.success) throw new Error(j.msg || 'Failed');
            await loadNotifications();
          } catch (e) { console.warn(e.message); }
        }));
      }

      function prependNotif(n) {
        // simple prepend and update count
        const el = document.createElement('div');
        el.className = 'p-2 border-b bg-gray-50 text-sm';
        const orderId = n.meta && n.meta.orderId ? n.meta.orderId : '';
        el.setAttribute('data-orderid', orderId);
        el.innerHTML = `<div class="font-medium">${n.title}</div><div class="text-xs text-gray-600">${n.body || ''}</div><div class="text-xs text-gray-400 mt-1">${new Date(n.createdAt).toLocaleString()}</div><div class="mt-2 text-right"><button data-id="${n._id}" class="mark-read text-xs text-indigo-600">Mark read</button></div>`;
        if (orderId) {
          el.style.cursor = 'pointer';
          el.addEventListener('click', (ev) => {
            if (ev.target && ev.target.classList && ev.target.classList.contains('mark-read')) return;
            const ord = allOrders.find(o => o._id === orderId);
            if (ord) openModal(ord);
            else fetch(`${API}/api/orders/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(j => { if (j && j.success) openModal(j.data); }).catch(() => {});
          });
        }
        notifList.insertBefore(el, notifList.firstChild);
        const current = parseInt(notifCountEl.textContent || '0', 10) || 0;
        notifCountEl.textContent = current + 1; notifCountEl.classList.remove('hidden');
      }

      notifBtn.addEventListener('click', async () => {
        notifDropdown.classList.toggle('hidden');
        if (!notifDropdown.classList.contains('hidden')) {
          await loadNotifications();
        }
      });

      notifMarkAll.addEventListener('click', async () => {
        try {
          const r = await fetch(`${API}/api/admin/notifications/mark-all-read`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
          const j = await r.json();
          if (!r.ok || !j.success) throw new Error(j.msg || 'Failed');
          await loadNotifications();
        } catch (e) { console.warn(e.message); }
      });

      // Global error handler to surface JS errors on page for debugging
      window.addEventListener('error', function (evt) {
        try {
          const banner = document.getElementById('dev-error-banner');
          if (banner) {
            banner.textContent = `JS Error: ${evt.message} at ${evt.filename}:${evt.lineno}`;
            banner.classList.remove('hidden');
          }
        } catch (e) { /* ignore */ }
      });

      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('adminToken');
        window.location.href = 'login.html';
      });

      const els = {
        // Regular Order selectors
        tbody: document.getElementById('orders-body'),
        count: document.getElementById('count'),
        search: document.getElementById('search'),
        filterStatus: document.getElementById('filter-status'),
        filterPayment: document.getElementById('filter-payment'),
        filterShipping: document.getElementById('filter-shipping'),
        dateFrom: document.getElementById('date-from'),
        dateTo: document.getElementById('date-to'),
        filterReset: document.getElementById('filter-reset'),
        modal: document.getElementById('modal'),
        modalClose: document.getElementById('modal-close'),
        modalItems: document.getElementById('modal-items'),
        modalSubtotal: document.getElementById('modal-subtotal'),
        modalDelivery: document.getElementById('modal-delivery'),
        modalTotal: document.getElementById('modal-total'),
        modalPaymentMethod: document.getElementById('modal-paymentMethod'),
        modalShippingMethod: document.getElementById('modal-shippingMethod'),
        modalPaymentStatus: document.getElementById('modal-paymentStatus'),
        modalPaymentRef: document.getElementById('modal-paymentRef'),
        modalReceiptBtn: document.getElementById('modal-receipt-btn'),
        receiptWrap: document.getElementById('receipt-wrap'),
        receiptReference: document.getElementById('receipt-reference'),
        receiptAmount: document.getElementById('receipt-amount'),
        receiptDate: document.getElementById('receipt-date'),
        receiptMethod: document.getElementById('receipt-method'),
        receiptShortId: document.getElementById('receipt-shortid'),
        receiptCustomer: document.getElementById('receipt-customer'),
        receiptStatus: document.getElementById('receipt-status'),
        receiptItems: document.getElementById('receipt-items'),
        receiptDelivery: document.getElementById('receipt-delivery'),
        receiptTotal: document.getElementById('receipt-total'),
        receiptCopyRef: document.getElementById('receipt-copy-ref'),
        receiptPrint: document.getElementById('receipt-print'),
        receiptOpenUrl: document.getElementById('receipt-open-url'),
        modalAddress: document.getElementById('modal-address'),
        formPaymentStatus: document.getElementById('form-paymentStatus'),
        formStatus: document.getElementById('form-status'),
        formShippingService: document.getElementById('form-shippingService'),
        formTrackingCode: document.getElementById('form-trackingCode'),
        modalSave: document.getElementById('modal-save'),
        modalError: document.getElementById('modal-error'),
        modalCancellationDetails: document.getElementById('modal-cancellation-details'),
        modalCancelledBy: document.getElementById('modal-cancelled-by'),
        modalCancellationReason: document.getElementById('modal-cancellation-reason'),
        modalAdminCancelReasonBox: document.getElementById('modal-admin-cancel-reason-box'),
        formCancellationReason: document.getElementById('form-cancellationReason'),

        // Tab Selectors
        tabsContainer: document.getElementById('tabs-container'),
        tabContentRegular: document.getElementById('tab-content-regular'),
        tabContentCustom: document.getElementById('tab-content-custom'),

       
        // Custom Order Selectors
        customOrdersBody: document.getElementById('custom-orders-body'),
        customCount: document.getElementById('custom-count'),
        customSearch: document.getElementById('custom-search'),
        customFilterStatus: document.getElementById('custom-filter-status'),
        customFilterType: document.getElementById('custom-filter-type'),
        customFilterShipMethod: document.getElementById('custom-filter-shipmethod'),
        customFilterFulfillment: document.getElementById('custom-filter-fulfillment'),
        customFilterPayment: document.getElementById('custom-filter-payment'),
        customFilterCourier: document.getElementById('custom-filter-courier'),
        customFilterTracking: document.getElementById('custom-filter-tracking'),
        customDateFrom: document.getElementById('custom-date-from'),
        customDateTo: document.getElementById('custom-date-to'),
        customFilterReset: document.getElementById('custom-filter-reset'),
        customModal: document.getElementById('custom-order-modal'),
        customModalClose: document.getElementById('custom-modal-close'),
        customModalError: document.getElementById('custom-modal-error'),
        customModalUser: document.getElementById('custom-modal-user'),
        customModalQty: document.getElementById('custom-modal-qty'),
        customModalType: document.getElementById('custom-modal-type'),
        customModalDetails: document.getElementById('custom-modal-details'),
        customModalNotes: document.getElementById('custom-modal-notes'),
        customModalDpSection: document.getElementById('custom-modal-dp-section'),
        customModalDpReceipt: document.getElementById('custom-modal-dp-receipt'),
        customModalFpSection: document.getElementById('custom-modal-fp-section'),
        customModalFpReceipt: document.getElementById('custom-modal-fp-receipt'),
        customModalQuoteBox: document.getElementById('custom-modal-quote-box'),
        formCustomPrice: document.getElementById('form-custom-price'),
        customModalInfoBox: document.getElementById('custom-modal-info-box'),
        customModalInfoText: document.getElementById('custom-modal-info-text'),
        customModalPriceDisplay: document.getElementById('custom-modal-price-display'),
        customModalSaveQuote: document.getElementById('custom-modal-save-quote'),
        customModalVerifyDp: document.getElementById('custom-modal-verify-dp'),
        customModalRequestFinal: document.getElementById('custom-modal-request-final'),
        customModalVerifyFinal: document.getElementById('custom-modal-verify-final'),
        formPricingNotes: document.getElementById('form-pricing-notes')
      };

      let allOrders = [];
      let allCustomOrders = [];
      let selectedOrder = null; // Para sa regular order
      let selectedCustomOrder = null; // Para sa custom order
      // Payment modal removed; payment info is shown directly in Order Details modal

      // Payment Info modal removed; no modal helpers needed

      function badge(text, type) {
        const map = {
          green: 'bg-green-100 text-green-800',
          red: 'bg-red-100 text-red-800',
          yellow: 'bg-yellow-100 text-yellow-800',
          blue: 'bg-blue-100 text-blue-800',
          gray: 'bg-gray-100 text-gray-800'
        };
        return `<span class="px-2 py-1 text-xs rounded-full ${map[type] || map.gray}">${text}</span>`;
      }
      function paymentBadge(status) {
        if (status === 'Received') return badge('Paid', 'green');
        if (status === 'Rejected') return badge('Rejected', 'red');
        return badge('Pending', 'yellow');
      }

      function renderRegularOrders() {
        const q = els.search.value.trim().toLowerCase();
        const s = els.filterStatus.value;
        const p = els.filterPayment.value;
        // Map filter value to backend status (note: 'To Pay' is derived from paymentStatus + Processing)
        const statusFilterMap = {
          'to-ship': ['Accepted'],
          'to-receive': ['Shipped'],
          'completed': ['Delivered'],
          'cancelled': ['Cancelled']
        };

        const filteredOrders = allOrders.filter(o => {
          const hay = [o._id, o.user?.name, o.trackingCode, o.shippingService].join(' ').toLowerCase();
          if (q && !hay.includes(q)) return false;
          if (s) {
            if (s === 'to-pay') {
              // "To Pay" means order is in Processing and payment is still Pending
              if (!(o.status === 'Processing' && (!o.paymentStatus || o.paymentStatus === 'Pending'))) return false;
            } else if (statusFilterMap[s] && !statusFilterMap[s].includes(o.status)) {
              return false;
            }
          }
          if (p && o.paymentStatus !== p) return false;
          return true;
        });

        // Map backend status to user-friendly label, taking paymentStatus into account
        const statusBadge = (order) => {
          const status = order.status;
          if (status === 'Processing') {
            // If payment pending -> To Pay; if already received -> Processing (paid)
            if (!order.paymentStatus || order.paymentStatus === 'Pending') return `<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">To Pay</span>`;
            return `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Processing</span>`;
          }
          const map = {
            'Accepted': ['To Ship', 'bg-blue-100 text-blue-800'],
            'Shipped': ['To Receive', 'bg-indigo-100 text-indigo-800'],
            'Delivered': ['Completed', 'bg-green-100 text-green-800'],
            'Cancelled': ['Cancelled', 'bg-red-100 text-red-800']
          };
          const [label, cls] = map[status] || [status, 'bg-gray-100 text-gray-800'];
          return `<span class="px-2 py-1 text-xs rounded-full ${cls}">${label}</span>`;
        };
        const rows = filteredOrders.map(o => `
          <tr>
            <td class="px-4 py-3">${shortId(o._id)} ${o.hasRefundRequest ? `<span data-refund-id="${o.latestRefundId || ''}" class="inline-block ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 refund-badge">Refund: ${o.latestRefundStatus || 'Pending'}</span>` : ''}</td>
            <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
            <td class="px-4 py-3">${paymentBadge(o.paymentStatus)}</td>
            <td class="px-4 py-3">${statusBadge(o)}</td>
            <td class="px-4 py-3">${(o.orderItems || []).reduce((n, i) => n + (i.quantity || 0), 0)}</td>
            <td class="px-4 py-3">${o.user?.name || '-'}</td>
            <td class="px-4 py-3">${o.shippingMethod || '-'}</td>
            <td class="px-4 py-3">${o.trackingCode || '-'}</td>
            <td class="px-4 py-3 text-right">
              <div class="inline-flex gap-3 items-center justify-end">
                <button data-id="${o._id}" class="edit-btn text-indigo-600 hover:text-indigo-800" title="View / Edit"><i class="fas fa-pen"></i></button>
              </div>
            </td>
          </tr>
        `).join('');
        els.tbody.innerHTML = rows || '<tr><td colspan="9" class="px-4 py-6 text-center text-gray-500">No orders found.</td></tr>';
        els.count.textContent = filteredOrders.length;
      }

      // --- MODIFIED: renderCustomOrders ---
      function renderCustomOrders() {
        const typeLabel = (t) => {
          // Prefer service-based mapping for clarity
          return function(mapObj){
            if (mapObj.serviceType === 'printing-only') return 'Upload File';
            if (t === 'Template' || t === 'LayoutCreation') return 'Customize Product';
            if (t === 'PrintingOnly' || t === 'FileUpload') return 'Upload File';
            return t || '-';
          };
        };
        // Apply client-side filters
        const q = (els.customSearch?.value || '').trim().toLowerCase();
        const fStatus = els.customFilterStatus?.value || '';
        const fType = els.customFilterType?.value || '';
        const fShip = els.customFilterShipMethod?.value || '';
        const fFull = els.customFilterFulfillment?.value || '';
        const fPay = els.customFilterPayment?.value || '';
        const fCourier = els.customFilterCourier?.value || '';
        const fTrack = els.customFilterTracking?.value || '';
        const dFrom = els.customDateFrom?.value ? new Date(els.customDateFrom.value) : null;
        const dTo = els.customDateTo?.value ? new Date(els.customDateTo.value) : null;

        const filtered = allCustomOrders.filter(o => {
          // text search across common fields
          const hay = [
            o._id,
            o.user?.name,
            o.productName,
            typeLabel(o.customType)(o),
            o.status,
            o.courier,
            o.trackingNumber,
            o.shippingMethod,
            o.fulfillmentMethod
          ].filter(Boolean).join(' ').toLowerCase();
          if (q && !hay.includes(q)) return false;
          if (fStatus && o.status !== fStatus) return false;
          if (fType && typeLabel(o.customType)(o) !== fType) return false;
          if (fShip && (o.shippingMethod || '') !== fShip) return false;
          if (fFull && (o.fulfillmentMethod || '') !== fFull) return false;
          if (fPay) {
            const dpPaid = !!o.downPaymentPaid;
            const balPaid = !!o.balancePaid;
            if (fPay === 'dp-paid' && !dpPaid) return false;
            if (fPay === 'dp-unpaid' && dpPaid) return false;
            if (fPay === 'bal-paid' && !balPaid) return false;
            if (fPay === 'bal-unpaid' && balPaid) return false;
          }
          if (fCourier) {
            const has = !!(o.courier && o.courier.trim());
            if (fCourier === 'has' && !has) return false;
            if (fCourier === 'none' && has) return false;
          }
          if (fTrack) {
            const has = !!(o.trackingNumber && o.trackingNumber.trim());
            if (fTrack === 'has' && !has) return false;
            if (fTrack === 'none' && has) return false;
          }
          if (dFrom || dTo) {
            const created = new Date(o.createdAt);
            if (dFrom && created < dFrom) return false;
            if (dTo) {
              // include whole day for 'to'
              const toEnd = new Date(dTo); toEnd.setHours(23,59,59,999);
              if (created > toEnd) return false;
            }
          }
          return true;
        });

        const rows = filtered.map(o => {
          let details = '';
          if (o.customType === 'FileUpload') {
            details = `<a href="${o.designFileUrl}" target="_blank" class="text-indigo-600 hover:underline">View Design File</a>`;
          } else if (o.serviceType === 'printing-only') {
            const parts = [];
            if (o.designFileUrl) parts.push(`<a href="${o.designFileUrl}" target="_blank" class="text-indigo-600 hover:underline">Download Design</a>`);
            if (o.teamNamesFileUrl) parts.push(`<a href="${o.teamNamesFileUrl}" target="_blank" class="text-indigo-600 hover:underline">Team List</a>`);
            details = parts.join(' ‚Ä¢ ') || (o.designDetails || 'N/A');
          } else {
            details = o.designDetails || 'N/A';
          }

          // --- BADGE LOGIC (UPDATED) ---
          let statusBadge;
          switch (o.status) {
            case 'Pending Quote': statusBadge = badge(o.status, 'yellow'); break;
              case 'Quote Sent': statusBadge = badge(o.status, 'green'); break;
              case 'Pending Downpayment': statusBadge = badge(o.status, 'blue'); break;
              case 'In Production': statusBadge = badge(o.status, 'blue'); break;
              case 'Pending Balance': statusBadge = badge(o.status, 'yellow'); break;
              // --- ITO ANG BAGO PARA SA PHASE 5.3 ---
              case 'Pending Final Verification': statusBadge = badge(o.status, 'blue'); break; 
              case 'Completed': statusBadge = badge(o.status, 'green'); break;
              case 'Cancelled': statusBadge = badge(o.status, 'red'); break;
              default: statusBadge = badge(o.status, 'gray');
          }
          // --- END BADGE LOGIC ---

          return `
                  <tr>
                      <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
                      <td class="px-4 py-3">${o.user?.name || 'N/A'}</td>
                      <td class="px-4 py-3">${typeLabel(o.customType)(o)}</td>
                      <td class="px-4 py-3">${o.quantity}</td>
                      <td class="px-4 py-3">${statusBadge}</td>
                      <td class="px-4 py-3">${o.shippingMethod || '-'}</td>
                      <td class="px-4 py-3 text-xs max-w-xs truncate">${details}</td>
                        <td class="px-4 py-3 text-right">
                          <div class="inline-flex gap-3 items-center justify-end">
                            <button data-id="${o._id}" class="edit-custom-btn text-indigo-600 hover:text-indigo-800" title="View / Edit"><i class="fas fa-pen"></i></button>
                          </div>
                        </td>
                  </tr>
              `;
        }).join('');
        els.customOrdersBody.innerHTML = rows || '<tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">No custom orders found.</td></tr>';
        els.customCount.textContent = filtered.length;
      }

      // Removed: Payment Info button in table; details shown directly in modal
      // Removed: Custom Payment Info action (aligning with Orders behavior)

      // Payment Info button removed; payment data is rendered directly in the modal

      // Removed: payment details loader; payment data comes from the order payload

      async function loadRegularOrders() {
        try {
          // Build query from filter controls
          const params = new URLSearchParams();
          const s = els.filterStatus.value;
          const p = els.filterPayment.value;
          const sm = els.filterShipping.value;
          const q = (els.search.value || '').trim();
          const df = els.dateFrom?.value;
          const dt = els.dateTo?.value;
          if (s) params.set('status', s);
          if (p) params.set('paymentStatus', p);
          if (sm) params.set('shippingMethod', sm);
          if (q) params.set('search', q);
          if (df) params.set('dateFrom', df);
          if (dt) params.set('dateTo', dt);

          const url = `${API}/api/orders/admin${params.toString() ? ('?' + params.toString()) : ''}`;
          const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (res.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
            return;
          }
          const data = await res.json();
          if (!data.success) {
            const banner = document.getElementById('dev-error-banner');
            banner.textContent = 'Failed to load orders: ' + (data.msg || JSON.stringify(data));
            banner.classList.remove('hidden');
            throw new Error(data.msg || 'Failed to load orders');
          }
          allOrders = data.data;
          renderRegularOrders();
        } catch (err) {
          console.error('loadRegularOrders error', err);
          const banner = document.getElementById('dev-error-banner');
          if (banner) { banner.textContent = 'Error loading orders: ' + (err.message || err); banner.classList.remove('hidden'); }
        }
      }

      // Wire filter change handlers
      function debounce(fn, wait = 300) {
        let t = null;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }
      els.filterStatus.addEventListener('change', () => loadRegularOrders());
      els.filterPayment.addEventListener('change', () => loadRegularOrders());
      els.filterShipping.addEventListener('change', () => loadRegularOrders());
      els.dateFrom.addEventListener('change', () => loadRegularOrders());
      els.dateTo.addEventListener('change', () => loadRegularOrders());
      els.search.addEventListener('input', debounce(() => loadRegularOrders(), 350));
      els.filterReset.addEventListener('click', () => {
        els.filterStatus.value = '';
        els.filterPayment.value = '';
        els.search.value = '';
        els.dateFrom.value = '';
        els.dateTo.value = '';
        loadRegularOrders();
      });

      async function loadCustomOrders() {
        try {
          const res = await fetch(`${API}/api/custom-orders/admin`, { headers: { 'Authorization': `Bearer ${token}` } });
          if (res.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
            return;
          }
          const data = await res.json();
          if (!data.success) throw new Error(data.msg || 'Failed to load custom orders');
          allCustomOrders = data.data;
          renderCustomOrders();
          // Bind filter events once after initial load
          const reb = renderCustomOrders;
          els.customSearch?.addEventListener('input', reb);
          els.customFilterStatus?.addEventListener('change', reb);
          els.customFilterType?.addEventListener('change', reb);
          els.customFilterShipMethod?.addEventListener('change', reb);
          els.customFilterFulfillment?.addEventListener('change', reb);
          els.customFilterPayment?.addEventListener('change', reb);
          els.customFilterCourier?.addEventListener('change', reb);
          els.customFilterTracking?.addEventListener('change', reb);
          els.customDateFrom?.addEventListener('change', reb);
          els.customDateTo?.addEventListener('change', reb);
          els.customFilterReset?.addEventListener('click', () => {
            els.customSearch.value = '';
            els.customFilterStatus.value = '';
            els.customFilterType.value = '';
            els.customFilterShipMethod.value = '';
            els.customFilterFulfillment.value = '';
            els.customFilterPayment.value = '';
            els.customFilterCourier.value = '';
            els.customFilterTracking.value = '';
            els.customDateFrom.value = '';
            els.customDateTo.value = '';
            renderCustomOrders();
          });
        } catch (err) {
          alert(err.message);
        }
      }

      async function openModal(order) {
        // ... (ang function na ito ay pareho pa rin) ...
        selectedOrder = order;
        // expose globally for fallback inline delegation
        window.selectedOrder = order;
        // Display payment info directly
        els.modalPaymentStatus.textContent = order.paymentStatus || 'Pending';
        els.modalPaymentRef.textContent = order.paymentIntentId || '-';
        // Prepare receipt view
        els.receiptWrap.classList.add('hidden');
        els.receiptReference.textContent = order.paymentIntentId || '-';
        els.receiptAmount.textContent = peso(order.totalPrice || 0);
        const paidAt = order.paidAt || order.updatedAt || order.createdAt;
        els.receiptDate.textContent = paidAt ? new Date(paidAt).toLocaleString() : '-';
        els.receiptMethod.textContent = order.paymentMethod || '-';
        els.receiptShortId.textContent = shortId(order._id);
        els.receiptCustomer.textContent = order.user?.name || '-';
        els.receiptStatus.textContent = (order.paymentStatus === 'Received') ? 'Payment received' : (order.paymentStatus || 'Pending');
        // Items table
        els.receiptItems.innerHTML = (order.orderItems || []).map(it => `
          <tr>
            <td class="px-2 py-1">${it.name || 'Item'}</td>
            <td class="px-2 py-1">${it.quantity || 0}</td>
            <td class="px-2 py-1 text-right">${peso((it.price || 0) * (it.quantity || 0))}</td>
          </tr>
        `).join('');
        els.receiptDelivery.textContent = peso(order.deliveryFee || 0);
        els.receiptTotal.textContent = peso(order.totalPrice || 0);
        // Optional gateway receipt URL
        if (order.receiptUrl) {
          els.receiptOpenUrl.href = order.receiptUrl;
          els.receiptOpenUrl.classList.remove('hidden');
        } else {
          els.receiptOpenUrl.classList.add('hidden');
        }
        els.modal.classList.remove('hidden'); els.modal.classList.add('flex');
        els.modalItems.innerHTML = (order.orderItems || []).map(it => `<div class="flex items-center justify-between"><div class="flex items-center gap-3"><img src="${it.imageUrl || ''}" class="w-10 h-10 rounded object-cover bg-gray-100" /><div><div class="font-medium">${it.name || 'Item'}</div><div class="text-gray-500 text-xs">‚Ç±${Number(it.price || 0).toLocaleString()} x ${it.quantity || 0}</div></div></div><div class="font-medium">${peso((it.price || 0) * (it.quantity || 0))}</div></div>`).join('');
        const subtotal = (order.orderItems || []).reduce((s, i) => s + (i.price || 0) * (i.quantity || 0), 0);
        els.modalSubtotal.textContent = peso(subtotal);
        els.modalDelivery.textContent = peso(order.deliveryFee || 0);
        els.modalTotal.textContent = peso(order.totalPrice || 0);
        els.modalPaymentMethod.textContent = order.paymentMethod || '-';
        els.modalShippingMethod.textContent = order.shippingMethod || '-';
        // Receipt upload deprecated in PayMongo flow
        const a = order.shippingAddress || {};
        els.modalAddress.innerHTML = `<div>${[a.block, a.lot].filter(Boolean).join(' ')} ${a.street || ''}</div><div>${a.building || ''}</div><div>${a.city || ''}, ${a.province || ''} ${a.zip || ''}</div><div>${a.phone || ''}</div>`;
        els.formPaymentStatus.value = order.paymentStatus || 'Pending';
        els.formStatus.value = order.status || 'Processing';
        els.formShippingService.value = order.shippingService || '';
        els.formTrackingCode.value = order.trackingCode || '';
        els.modalError.textContent = '';
        // Disable editing if Completed (Delivered)
        const isCompleted = order.status === 'Delivered' || order.status === 'Completed';
        els.formPaymentStatus.disabled = !!order.paymentIntentId || isCompleted;
        els.formStatus.disabled = isCompleted;
        els.formShippingService.disabled = isCompleted;
        els.formTrackingCode.disabled = isCompleted;
        els.modalSave.style.display = isCompleted ? 'none' : '';
        const removeBtn = document.getElementById('modal-remove');
        if (removeBtn) removeBtn.style.display = isCompleted ? '' : 'none';
        els.formPaymentStatus.title = order.paymentIntentId ? 'Payment status is managed by PayMongo' : '';
        if (order.status === 'Cancelled' && order.cancellationReason) {
          els.modalCancelledBy.textContent = order.cancelledBy || 'N/A';
          els.modalCancellationReason.textContent = order.cancellationReason;
          els.modalCancellationDetails.classList.remove('hidden');
        } else {
          els.modalCancellationDetails.classList.add('hidden');
        }
        els.modalAdminCancelReasonBox.classList.toggle('hidden', order.status !== 'Cancelled');
        els.formCancellationReason.value = order.cancellationReason || '';
        // Load refund/return details if available
        const refundSection = document.getElementById('modal-refund-section');
        const refundStatusEl = document.getElementById('modal-refund-status');
        const refundReasonEl = document.getElementById('modal-refund-reason');
        const refundAmountEl = document.getElementById('modal-refund-amount');
        const refundMediaEl = document.getElementById('modal-refund-media');
        const refundAdminNotes = document.getElementById('modal-refund-adminnotes');
        const refundMsg = document.getElementById('modal-refund-msg');
        refundMsg.textContent = '';
        refundAdminNotes.value = '';
        if (order.latestRefundId) {
          // fetch return details
          try {
            const rres = await fetch(`${API}/api/returns/${order.latestRefundId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const rdata = await rres.json();
            if (rres.ok && rdata.success) {
              const rr = rdata.data;
              refundSection.classList.remove('hidden');
              refundStatusEl.textContent = rr.status || 'Pending';
              refundReasonEl.textContent = rr.reason || '-';
              refundAmountEl.textContent = rr.amount ? peso(rr.amount) : (order.totalPrice ? peso(order.totalPrice) : '-');
              refundAdminNotes.value = rr.adminNotes || '';
              refundMediaEl.innerHTML = '';
              if (Array.isArray(rr.images)) rr.images.forEach(u => refundMediaEl.innerHTML += `<a href="${u}" target="_blank" class="text-indigo-600 text-xs mr-2">Image</a>`);
              if (Array.isArray(rr.videos)) rr.videos.forEach(u => refundMediaEl.innerHTML += `<a href="${u}" target="_blank" class="text-indigo-600 text-xs mr-2">Video</a>`);
              // bind buttons
              document.getElementById('btn-approve-refund').onclick = async function() {
                refundMsg.textContent = '';
                try {
                  const resp = await fetch(`${API}/api/returns/${rr._id}/approve`, { method: 'PUT', headers: { 'Content-Type':'application/json','Authorization': `Bearer ${token}` }, body: JSON.stringify({ adminNotes: refundAdminNotes.value }) });
                  const j = await resp.json();
                  if (!resp.ok || !j.success) throw new Error(j.msg || 'Failed');
                  refundStatusEl.textContent = 'Approved';
                  await loadRegularOrders();
                } catch (e) { refundMsg.textContent = e.message; }
              };
              document.getElementById('btn-reject-refund').onclick = async function() {
                refundMsg.textContent = '';
                try {
                  const resp = await fetch(`${API}/api/returns/${rr._id}/reject`, { method: 'PUT', headers: { 'Content-Type':'application/json','Authorization': `Bearer ${token}` }, body: JSON.stringify({ adminNotes: refundAdminNotes.value }) });
                  const j = await resp.json();
                  if (!resp.ok || !j.success) throw new Error(j.msg || 'Failed');
                  refundStatusEl.textContent = 'Rejected';
                  await loadRegularOrders();
                } catch (e) { refundMsg.textContent = e.message; }
              };
              document.getElementById('btn-process-refund').onclick = async function() {
                refundMsg.textContent = '';
                try {
                  const resp = await fetch(`${API}/api/returns/${rr._id}/refund`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                  const j = await resp.json();
                  if (!resp.ok || !j.success) throw new Error(j.msg || 'Failed to process refund');
                  refundStatusEl.textContent = 'Refunded';
                  await loadRegularOrders();
                } catch (e) { refundMsg.textContent = e.message; }
              };
            } else {
              refundSection.classList.add('hidden');
            }
          } catch (e) {
            refundSection.classList.add('hidden');
            console.warn('Failed to fetch refund details', e.message);
          }
        } else {
          refundSection.classList.add('hidden');
        }
      }

      // Remove order (Completed only)
      document.getElementById('modal-remove').onclick = async function() {
        if (!selectedOrder) return;
        if (!confirm('Are you sure you want to remove this completed order?')) return;
        try {
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to remove order');
          allOrders = allOrders.filter(o => o._id !== selectedOrder._id);
          renderRegularOrders();
          els.modal.classList.add('hidden');
        } catch (err) {
          els.modalError.textContent = err.message;
        }
      }

      async function saveModal() {
        // ... (ang function na ito ay pareho pa rin) ...
        if (!selectedOrder) return;
        els.modalError.textContent = '';
        try {
          const body = {
            paymentStatus: els.formPaymentStatus.value,
            status: els.formStatus.value,
            shippingService: els.formShippingService.value,
            trackingCode: els.formTrackingCode.value
          };
          if (body.status === 'Cancelled') {
            body.cancellationReason = els.formCancellationReason.value;
          }
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to update order');
          const idx = allOrders.findIndex(o => o._id === selectedOrder._id);
          if (idx >= 0) allOrders[idx] = data.data;
          renderRegularOrders();
          els.modal.classList.add('hidden');
        } catch (err) {
          els.modalError.textContent = err.message;
        }
      }

      // --- NEW: Functions for Custom Order Modal ---
      async function openCustomModal(order) {
        selectedCustomOrder = order;
        els.customModalError.textContent = '';
        els.customModalError.classList.add('hidden');
        els.customModal.classList.remove('hidden');
        els.customModal.classList.add('flex');

        // Basic Information
        els.customModalUser.textContent = `${order.user?.name || 'N/A'} (${order.user?.email || 'N/A'})`;
        els.customModalQty.textContent = order.quantity;
        els.customModalType.textContent = order.customType;
        els.customModalNotes.textContent = order.notes || 'N/A';
        els.formCustomPrice.value = order.price || '';
        els.formPricingNotes.value = order.adminNotes || '';

        // Service Type Badge
        const serviceType = order.serviceType || 'customize-jersey';
        const serviceBadge = document.getElementById('custom-modal-service-badge');
        if (serviceType === 'customize-jersey') {
          serviceBadge.textContent = 'üéΩ Customize Jersey';
          serviceBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800';
        } else if (serviceType === 'layout-creation') {
          serviceBadge.textContent = 'üé® Layout Creation';
          serviceBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-purple-100 text-purple-800';
        } else if (serviceType === 'printing-only') {
          serviceBadge.textContent = 'üñ®Ô∏è Printing Only';
          serviceBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
        }

        // Hide all service sections first
        document.getElementById('custom-modal-customize-jersey-section').classList.add('hidden');
        document.getElementById('custom-modal-layout-section').classList.add('hidden');
        document.getElementById('custom-modal-printing-section').classList.add('hidden');

        // Show relevant section based on service type
        if (serviceType === 'customize-jersey') {
          const section = document.getElementById('custom-modal-customize-jersey-section');
          section.classList.remove('hidden');

          // Item and Printing Type
          document.getElementById('custom-modal-item-type').textContent = order.itemType || 'N/A';
          document.getElementById('custom-modal-printing-type').textContent = order.printingType || (order.quotePayload && order.quotePayload.printingType) || 'N/A';

          // Template vs Upload
          if (order.customType === 'Template') {
            const templateFields = document.getElementById('custom-modal-template-fields');
            templateFields.classList.remove('hidden');
            
            document.getElementById('custom-modal-design-style').textContent = order.designStyle || 'N/A';
            
            // Color swatches (legacy fields)
            if (order.primaryColor) document.getElementById('custom-modal-primary-color').style.backgroundColor = order.primaryColor;
            if (order.secondaryColor) document.getElementById('custom-modal-secondary-color').style.backgroundColor = order.secondaryColor;
            if (order.accentColor) document.getElementById('custom-modal-accent-color').style.backgroundColor = order.accentColor;

            // Text details
            if (order.customText) {
              const textSection = document.getElementById('custom-modal-text-section');
              textSection.classList.remove('hidden');
              document.getElementById('custom-modal-custom-text').textContent = order.customText;
              document.getElementById('custom-modal-text-font').textContent = order.textFont || 'N/A';
              document.getElementById('custom-modal-text-size').textContent = order.textSize || 'N/A';
              document.getElementById('custom-modal-text-placement').textContent = order.textPlacement || 'N/A';
            }

            // Logo details
            if (order.logoType && order.logoType !== 'none') {
              const logoSection = document.getElementById('custom-modal-logo-section');
              logoSection.classList.remove('hidden');
              document.getElementById('custom-modal-logo-type').textContent = order.logoType || 'N/A';
              document.getElementById('custom-modal-logo-placement').textContent = order.logoPlacement || 'N/A';
              
              if (order.logoUrl) {
                document.getElementById('custom-modal-logo-preview').innerHTML = 
                  `<a href="${order.logoUrl}" target="_blank" class="text-indigo-600 hover:underline text-xs">View Logo File</a>`;
              }
            }

            document.getElementById('custom-modal-design-file-section').classList.add('hidden');
          } else if (order.customType === 'FileUpload') {
            document.getElementById('custom-modal-template-fields').classList.add('hidden');
            const fileSection = document.getElementById('custom-modal-design-file-section');
            fileSection.classList.remove('hidden');
            
            if (order.designFileUrl) {
              document.getElementById('custom-modal-design-file').innerHTML = 
                `<a href="${order.designFileUrl}" target="_blank" download class="text-indigo-600 font-medium hover:underline">View/Download Design File</a>`;
            } else {
              document.getElementById('custom-modal-design-file').textContent = 'No file uploaded';
            }
          }

          // Team Details
          if (order.teamName || order.includeTeamMembers) {
            const teamSection = document.getElementById('custom-modal-team-section');
            teamSection.classList.remove('hidden');
            document.getElementById('custom-modal-team-name').textContent = order.teamName || 'N/A';

            if (order.includeTeamMembers && order.teamMembers && order.teamMembers.length > 0) {
              const membersContainer = document.getElementById('custom-modal-team-members-container');
              membersContainer.classList.remove('hidden');

              const tbody = document.getElementById('custom-modal-team-members-tbody');
              const rowsHtml = order.teamMembers.map(member => `
                <tr>
                  <td class=\"border px-2 py-1\">${member.name || 'N/A'}</td>
                  <td class=\"border px-2 py-1\">${member.jerseyNumber || 'N/A'}</td>
                  <td class=\"border px-2 py-1\">${member.size || 'N/A'}</td>
                </tr>
              `).join('');
              // Collapse control
              const maxVisible = 8;
              if (order.teamMembers.length > maxVisible) {
                tbody.innerHTML = rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
                // Add toggle button
                let toggleBtn = membersContainer.querySelector('[data-team-toggle]');
                if (!toggleBtn) {
                  toggleBtn = document.createElement('button');
                  toggleBtn.setAttribute('data-team-toggle', '');
                  toggleBtn.className = 'mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50';
                  membersContainer.appendChild(toggleBtn);
                }
                toggleBtn.textContent = `Show all (${order.teamMembers.length})`;
                let expanded = false;
                toggleBtn.onclick = () => {
                  expanded = !expanded;
                  tbody.innerHTML = expanded ? rowsHtml : rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
                  toggleBtn.textContent = expanded ? 'Show less' : `Show all (${order.teamMembers.length})`;
                };
              } else {
                tbody.innerHTML = rowsHtml;
                const toggleBtn = membersContainer.querySelector('[data-team-toggle]');
                if (toggleBtn) toggleBtn.remove();
              }
            }
          }

          // Shorts Details
          if (order.includeShorts) {
            const shortsSection = document.getElementById('custom-modal-shorts-section');
            shortsSection.classList.remove('hidden');
            document.getElementById('custom-modal-shorts-same').textContent = order.shortsSameDesign ? 'Yes' : 'No';

            if (!order.shortsSameDesign) {
              const differentContainer = document.getElementById('custom-modal-shorts-different-container');
              differentContainer.classList.remove('hidden');
              
              const shortsDetails = document.getElementById('custom-modal-shorts-details');
              if (order.shortsDesignFileUrl) {
                shortsDetails.innerHTML = `<a href="${order.shortsDesignFileUrl}" target="_blank" class="text-purple-600 hover:underline text-xs">View Shorts Design File</a>`;
              } else if (order.shortsDesignDetails) {
                shortsDetails.textContent = order.shortsDesignDetails;
              } else {
                shortsDetails.textContent = 'No details provided';
              }
            }
          }

          // --- Professional Customizer Details (3-panel layout) ---
          const pro = document.getElementById('custom-modal-pro-section');
          pro.classList.add('hidden');
          const hasProData = !!(order.garmentType || order.selectedLocation || order.colors || order.designImage || order.designText || order.quotePayload);
          if (hasProData) {
            pro.classList.remove('hidden');
            const qp = order.quotePayload || {};
            
            console.log('[Admin Modal] Full order data:', order);
            console.log('[Admin Modal] garmentType:', order.garmentType);
            console.log('[Admin Modal] colors:', order.colors);
            console.log('[Admin Modal] designImagesMap:', order.designImagesMap);
            console.log('[Admin Modal] designImage:', order.designImage);
            
            // Garment and location - Prefer human-readable label from quotePayload
            const garmentLabel = (qp && qp.garmentLabel) ? qp.garmentLabel : null;
            let garmentType = garmentLabel || order.garmentType || order.itemType || 'T-Shirt';
            const lower = garmentType.toLowerCase();
            const garmentEmoji = lower.includes('v-neck') || lower.includes('vneck') ? 'üëï' :
                                lower.includes('round') || lower.includes('crew') ? 'üëï' :
                                lower.includes('jersey') ? 'üéΩ' : 
                                lower.includes('shirt') ? 'üëï' : 
                                lower.includes('short') ? 'ü©≥' : 'üëî';
            document.getElementById('pro-garment').innerHTML = `${garmentEmoji} ${garmentType}`;
            
            // Location - Show specific location with emoji
            const location = order.selectedLocation || qp.selectedLocation || 'Not specified';
            const locationText = location.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            document.getElementById('pro-location').innerHTML = `üìç ${locationText}`;
            
            // Colors - Prefer the single selected garment color from quotePayload
            const colors = order.colors || {};
            const colorsContainer = document.getElementById('colors-container');
            const singleColorHex = (qp && (qp.garmentColorHex || qp.garmentColorName)) || null;
            const singleColorName = (qp && qp.garmentColorName) || '';
            if (singleColorHex) {
              const title = [singleColorName, singleColorHex].filter(Boolean).join(' ¬∑ ');
              colorsContainer.innerHTML = `<div class="w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm" style="background-color: ${singleColorHex}" title="${title}"></div>`;
            } else if (colors.primary || colors.secondary || colors.accent) {
              let colorHTML = '';
              if (colors.primary) {
                colorHTML += `<div class=\"w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm\" style=\"background-color: ${colors.primary}\" title=\"${colors.primary}\"></div>`;
              }
              if (colors.secondary) {
                colorHTML += `<div class=\"w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm\" style=\"background-color: ${colors.secondary}\" title=\"${colors.secondary}\"></div>`;
              }
              if (colors.accent) {
                colorHTML += `<div class=\"w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm\" style=\"background-color: ${colors.accent}\" title=\"${colors.accent}\"></div>`;
              }
              colorsContainer.innerHTML = colorHTML;
            } else {
              colorsContainer.innerHTML = '<p class="text-sm text-gray-500">No colors specified</p>';
            }
            // Design text AND uploaded design placements
            const dtext = (order.designText || '');
            const multi = order.designImagesMap || {};
            const designKeys = Object.keys(multi);
            
            let designInfoHTML = '';
            
            // Show text placement if exists
            if (dtext) {
              const textLocation = order.selectedLocation || qp.selectedLocation || 'Unknown';
              const formattedLocation = textLocation.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
              designInfoHTML += `<div class="mb-2">
                <span class="font-semibold text-indigo-700">"${dtext}"</span> 
                <span class="text-xs text-gray-600">- ${formattedLocation}</span>
              </div>`;
            }
            
            // Show uploaded design placements (include original filename when available)
            if (designKeys.length > 0) {
              const placements = designKeys.map(key => key.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())).join(', ');
              let uploadedName = (qp && qp.uploadedDesignFilename) || '';
              if (!uploadedName && order.designImage) {
                try {
                  const urlNoQuery = order.designImage.split('?')[0];
                  uploadedName = urlNoQuery.substring(urlNoQuery.lastIndexOf('/') + 1) || '';
                } catch(e) { uploadedName = ''; }
              }
              const namePart = uploadedName ? ` <span class=\"text-xs text-gray-500\">(${uploadedName})</span>` : '';
              designInfoHTML += `<div>
                <span class="font-semibold text-green-700">Uploaded Design</span>${namePart} 
                <span class="text-xs text-gray-600">- ${placements}</span>
              </div>`;
            }
            
            if (designInfoHTML) {
              document.getElementById('pro-design-text').innerHTML = designInfoHTML;
              document.getElementById('pro-design-text-wrap').classList.remove('hidden');
            } else {
              document.getElementById('pro-design-text-wrap').classList.add('hidden');
            }
            // Design images (single legacy + multi-location previews) - 2x2 grid
            const designWrap = document.getElementById('pro-design-image');
            // Use 'multi' from above (already declared for design text section)
            
            console.log('[Admin] Full order object:', order);
            console.log('[Admin] Order designImagesMap:', multi);
            console.log('[Admin] Order designImage:', order.designImage);
            console.log('[Admin] designImagesMap keys:', Object.keys(multi));
            console.log('[Admin] designImagesMap entries:', Object.entries(multi));
            
            if (multi && Object.keys(multi).length) {
              const entries = Object.entries(multi);
              designWrap.innerHTML = entries.map(([loc,url]) => {
                // Ensure URL is absolute
                let finalUrl = url;
                if (url && !url.startsWith('http') && !url.startsWith('data:')) {
                  const API_BASE = 'https://fundamental-apparel-backend.onrender.com';
                  finalUrl = url.startsWith('/') ? `${API_BASE}${url}` : `${API_BASE}/${url}`;
                }
                
                return `
                <div class="bg-white p-3 rounded-lg border">
                  <p class="text-xs font-semibold text-gray-700 mb-2 capitalize">${loc.replace(/-/g,' ')}</p>
                  <a href="${finalUrl}" target="_blank" download class="block mb-2">
                    <img src="${finalUrl}" class="w-full h-32 object-contain rounded border shadow-sm hover:shadow-md transition" alt="${loc} preview" onerror="this.parentElement.innerHTML='<div class=\\'text-red-500 text-xs\\'>Image failed to load</div>'">
                  </a>
                  <a href="${finalUrl}" target="_blank" download class="block text-center px-2 py-1 text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 transition">
                    <i class="fas fa-download mr-1"></i>Download
                  </a>
                </div>`
              }).join('');
              document.getElementById('pro-design-image-wrap').classList.remove('hidden');
            } else if (order.designImage) {
              designWrap.innerHTML = `
                <div class="col-span-2 bg-white p-3 rounded-lg border">
                  <p class="text-xs font-semibold text-gray-700 mb-2">Uploaded Design</p>
                  <a href="${order.designImage}" target="_blank" download class="block mb-2">
                    <img src="${order.designImage}" class="w-full h-48 object-contain rounded border shadow-sm hover:shadow-md transition" alt="Design Image">
                  </a>
                  <a href="${order.designImage}" target="_blank" download class="block text-center px-3 py-2 text-sm bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 transition">
                    <i class="fas fa-download mr-1"></i>Download Image
                  </a>
                </div>`;
              document.getElementById('pro-design-image-wrap').classList.remove('hidden');
            } else {
              document.getElementById('pro-design-image-wrap').classList.add('hidden');
            }
            // Printing, qty - Show specific details
            const printingType = qp.printingType || order.printingType || 'Not specified';
            document.getElementById('pro-printing-type').innerHTML = `üñ®Ô∏è ${printingType}`;
            
            const quantity = order.quantity != null ? order.quantity : 0;
            document.getElementById('pro-qty').innerHTML = `üì¶ ${quantity} ${quantity === 1 ? 'piece' : 'pieces'}`;
            
            // Team entries
            const teamEntries = Array.isArray(qp.teamEntries) ? qp.teamEntries : [];
            const teamWrap = document.getElementById('pro-team-wrap');
            if (qp.teamMode && teamEntries.length) {
              teamWrap.classList.remove('hidden');
              const tb = document.getElementById('pro-team-tbody');
              const rowsHtml = teamEntries.map(e => `<tr><td class="border px-2 py-1">${e.name || ''}</td><td class="border px-2 py-1">${e.number || ''}</td><td class="border px-2 py-1">${e.size || ''}</td></tr>`).join('');
              const maxVisiblePro = 8;
              if (teamEntries.length > maxVisiblePro) {
                tb.innerHTML = rowsHtml.split('</tr>').slice(0, maxVisiblePro).join('</tr>');
                let toggleBtn = teamWrap.querySelector('[data-pro-team-toggle]');
                if (!toggleBtn) {
                  toggleBtn = document.createElement('button');
                  toggleBtn.setAttribute('data-pro-team-toggle', '');
                  toggleBtn.className = 'mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50';
                  teamWrap.appendChild(toggleBtn);
                }
                toggleBtn.textContent = `Show all (${teamEntries.length})`;
                let expanded = false;
                toggleBtn.onclick = () => {
                  expanded = !expanded;
                  tb.innerHTML = expanded ? rowsHtml : rowsHtml.split('</tr>').slice(0, maxVisiblePro).join('</tr>');
                  toggleBtn.textContent = expanded ? 'Show less' : `Show all (${teamEntries.length})`;
                };
              } else {
                tb.innerHTML = rowsHtml;
                const toggleBtn = teamWrap.querySelector('[data-pro-team-toggle]');
                if (toggleBtn) toggleBtn.remove();
              }
            } else {
              teamWrap.classList.add('hidden');
            }
            // Pricing breakdown (hidden for admin to input later)
            const pricingWrap = document.getElementById('pro-pricing-wrap');
            pricingWrap.classList.add('hidden');
            const pj = document.getElementById('pro-pricing-json');
            if (pj) pj.textContent = '';
          }
        } 
        else if (serviceType === 'layout-creation') {
          const section = document.getElementById('custom-modal-layout-section');
          section.classList.remove('hidden');

          // Inspiration Image
          if (order.inspirationImageUrl || order.designFileUrl) {
            const imageUrl = order.inspirationImageUrl || order.designFileUrl;
            document.getElementById('custom-modal-inspiration-image').innerHTML = 
              `<a href="${imageUrl}" target="_blank"><img src="${imageUrl}" class="max-h-48 rounded border shadow" alt="Inspiration"></a>`;
          } else {
            document.getElementById('custom-modal-inspiration-image').textContent = 'No image uploaded';
          }

          document.getElementById('custom-modal-layout-team').textContent = order.teamName || 'N/A';
          document.getElementById('custom-modal-layout-member').textContent = order.memberName || 'N/A';
          document.getElementById('custom-modal-layout-number').textContent = order.jerseyNumber || 'N/A';

          // Color Palette
          if (order.colorPalette && order.colorPalette.length > 0) {
            const paletteContainer = document.getElementById('custom-modal-color-palette');
            paletteContainer.innerHTML = order.colorPalette.map(color => 
              `<div class="w-10 h-10 rounded border-2 border-gray-300" style="background-color: ${color}" title="${color}"></div>`
            ).join('');
          } else {
            document.getElementById('custom-modal-color-palette').innerHTML = '<span class="text-gray-500">No colors specified</span>';
          }
        } 
        else if (serviceType === 'printing-only') {
          const section = document.getElementById('custom-modal-printing-section');
          section.classList.remove('hidden');
          const methodMap = {
            'dye-sublimation': 'Dye-Sublimation',
            'heat-transfer': 'Heat Transfer',
            'vinyl-print': 'Vinyl Print',
          };
          document.getElementById('custom-modal-printing-method').textContent = methodMap[order.printingMethod] || order.printingMethod || 'N/A';
          document.getElementById('custom-modal-fabric-type').textContent = order.fabricType || 'N/A';
          // Fetch inventory info for this fabric (admin endpoint)
          (async () => {
            try {
              const name = order.fabricType;
              if (!name) {
                document.getElementById('custom-modal-fabric-available').textContent = '-';
                document.getElementById('custom-modal-fabric-reserved').textContent = '-';
                return;
              }
              const q = new URLSearchParams({ search: name, limit: 1 });
              const r = await fetch(`${API}/api/admin/inventory?` + q.toString(), { headers: { 'Authorization': `Bearer ${token}` } });
              if (!r.ok) throw new Error('Failed to fetch inventory');
              const j = await r.json();
              if (!j.success || !j.data || j.data.length === 0) {
                document.getElementById('custom-modal-fabric-available').textContent = '0';
                document.getElementById('custom-modal-fabric-reserved').textContent = '0';
              } else {
                const item = j.data[0];
                document.getElementById('custom-modal-fabric-available').textContent = (item.quantity != null) ? item.quantity : '-';
                document.getElementById('custom-modal-fabric-reserved').textContent = (item.reserved != null) ? item.reserved : '0';
              }
            } catch (e) {
              console.warn('Inventory fetch failed', e.message);
              document.getElementById('custom-modal-fabric-available').textContent = '?';
              document.getElementById('custom-modal-fabric-reserved').textContent = '?';
            }
          })();
          document.getElementById('custom-modal-garment-type').textContent = order.garmentType || 'N/A';

          const sizeRow = document.getElementById('custom-modal-garment-size-row');
          if (order.includeTeamMembers && Array.isArray(order.teamMembers) && order.teamMembers.length) {
            sizeRow.classList.add('hidden');
          } else {
            sizeRow.classList.remove('hidden');
            document.getElementById('custom-modal-garment-size').textContent = order.garmentSize || 'N/A';
          }

          if (order.designFileUrl) {
            const fileSection = document.getElementById('custom-modal-printing-file-section');
            fileSection.classList.remove('hidden');
            document.getElementById('custom-modal-printing-file').innerHTML = 
              `<a href="${order.designFileUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">View/Download Design File</a>`;
          }

          // Team List (from saved members or uploaded txt/csv)
          const teamWrap = document.getElementById('custom-modal-po-team-section');
          const teamBody = document.getElementById('custom-modal-po-team-tbody');
          const teamFileLink = document.getElementById('custom-modal-po-team-file-link');
          teamBody.innerHTML = '';
          teamWrap.classList.add('hidden');
          teamFileLink.classList.add('hidden');

          function renderTeamRows(list){
            if (!list || !list.length) return;
            const rowsHtml = list.map(m => `<tr><td class="border px-2 py-1">${(m.name||'').toString()}</td><td class="border px-2 py-1">${(m.jerseyNumber||m.number||'').toString()}</td><td class="border px-2 py-1">${(m.size||'').toString()}</td></tr>`).join('');
            const maxVisible = 12;
            if (list.length > maxVisible) {
              teamBody.innerHTML = rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
              let toggleBtn = teamWrap.querySelector('[data-po-team-toggle]');
              if (!toggleBtn) {
                toggleBtn = document.createElement('button');
                toggleBtn.setAttribute('data-po-team-toggle','');
                toggleBtn.className = 'mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50';
                teamWrap.appendChild(toggleBtn);
              }
              toggleBtn.textContent = `Show all (${list.length})`;
              let expanded = false;
              toggleBtn.onclick = () => {
                expanded = !expanded;
                teamBody.innerHTML = expanded ? rowsHtml : rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
                toggleBtn.textContent = expanded ? 'Show less' : `Show all (${list.length})`;
              };
            } else {
              teamBody.innerHTML = rowsHtml;
              const toggleBtn = teamWrap.querySelector('[data-po-team-toggle]');
              if (toggleBtn) toggleBtn.remove();
            }
            teamWrap.classList.remove('hidden');
          }

          if (order.includeTeamMembers && Array.isArray(order.teamMembers) && order.teamMembers.length) {
            renderTeamRows(order.teamMembers);
          } else if (order.teamNamesFileUrl) {
            try {
              teamFileLink.href = order.teamNamesFileUrl;
              teamFileLink.classList.remove('hidden');
              const res = await fetch(order.teamNamesFileUrl, { headers: { 'ngrok-skip-browser-warning': 'true' }});
              const text = await res.text();
              const lines = text.split(/\r?\n/).filter(Boolean);
              const parsed = lines.map(ln => {
                const parts = ln.split(/[,|\t]/);
                return { name: (parts[0]||'').trim(), jerseyNumber: (parts[1]||'').trim(), size: (parts[2]||'').trim() };
              });
              renderTeamRows(parsed);
            } catch (e) {
              console.warn('Failed to load team list file:', e);
            }
          }
        }

        // I-reset muna lahat ng sections/buttons
        els.customModalQuoteBox.classList.add('hidden');
        els.customModalInfoBox.classList.add('hidden');
        els.customModalDpSection.classList.add('hidden');
        els.customModalFpSection.classList.add('hidden');
        els.customModalSaveQuote.classList.add('hidden');
        els.customModalVerifyDp.classList.add('hidden');
        els.customModalRequestFinal.classList.add('hidden');
        els.customModalVerifyFinal.classList.add('hidden');

        // --- Magpakita ng UI based sa status ---
        if (order.status === 'Pending Quote') {
          els.customModalQuoteBox.classList.remove('hidden');
          els.customModalSaveQuote.classList.remove('hidden');
        }
        else if (order.status === 'Quote Sent') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price?.toLocaleString?.() || order.price || ''}`;
          els.customModalInfoText.textContent = "Waiting for user to accept quote.";
        }
        else if (order.status === 'Quote Accepted') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price?.toLocaleString?.() || order.price || ''}`;
          els.customModalInfoText.textContent = "Waiting for user to pay 50% down payment.";
        }
        else if (order.status === 'Pending Downpayment') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = "User has submitted a down payment receipt.";

          // Show DP receipt section
          els.customModalDpSection.classList.remove('hidden');
          
          // Check both old (downPaymentReceiptUrl) and new (receiptUrl/paymentIntentId) fields
          if (order.downPaymentReceiptUrl) {
            // Old manual upload system
            els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View Down Payment Receipt</a>`;
          } else if (order.paymentIntentId || order.receiptUrl) {
            // New PayMongo system - show View Receipt button
            els.customModalDpReceipt.innerHTML = `
              <button onclick="viewCustomOrderPayment('${order._id}')" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                <i class="fas fa-receipt"></i>View Receipt
              </button>
              <p class="text-xs text-gray-500 mt-2">
                <i class="fas fa-check-circle text-green-600"></i> Payment: ${order.paymentMethod || 'N/A'} ‚Ä¢ Amount: ‚Ç±${(order.paymentAmount || 0).toLocaleString()}
              </p>
            `;
          } else {
            els.customModalDpReceipt.innerHTML = `<span class="text-red-500">User submitted, but receipt URL is missing.</span>`;
          }

          // Show "Verify" button
          els.customModalVerifyDp.classList.remove('hidden');
        }

        else if (order.status === 'In Production') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = "Order is currently in production.";
          els.customModalDpSection.classList.remove('hidden');
          
          // Check both old and new payment fields
          if (order.downPaymentReceiptUrl) {
            // Old manual upload
            els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-gray-500 hover:underline">View Verified DP Receipt</a>`;
          } else if (order.paymentIntentId || order.receiptUrl) {
            // New PayMongo system
            els.customModalDpReceipt.innerHTML = `
              <button onclick="viewCustomOrderPayment('${order._id}')" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                <i class="fas fa-receipt"></i>View Receipt
              </button>
              <p class="text-xs text-gray-500 mt-2">
                <i class="fas fa-check-circle text-green-600"></i> Verified ‚Ä¢ Payment: ${order.paymentMethod || 'N/A'} ‚Ä¢ ‚Ç±${(order.paymentAmount || 0).toLocaleString()}
              </p>
            `;
          } else {
            els.customModalDpReceipt.innerHTML = `<span>DP Verified (No Receipt)</span>`;
          }
          // Show "Request Final Payment" button ONLY if balance not yet paid (i.e., not 100% payment)
          if (!order.balancePaid && order.paymentType !== 'full') {
            els.customModalRequestFinal.classList.remove('hidden');
          } else {
            // 100% payment already received - show completion option instead
            const completeInfo = document.createElement('div');
            completeInfo.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded text-sm';
            completeInfo.innerHTML = `
              <p class="font-semibold text-green-800 mb-2"><i class="fas fa-check-circle"></i> Full Payment Received (100%)</p>
              <p class="text-gray-700 text-xs">This order was paid in full. Ready to mark as completed and arrange fulfillment.</p>
            `;
            els.customModalDpSection.after(completeInfo);
          }
        }
        else if (order.status === 'Pending Final Verification') {
              els.customModalInfoBox.classList.remove('hidden');
              els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
              // Updated messaging for PayMongo final payment flow
              els.customModalInfoText.textContent = "Final payment received via PayMongo. Awaiting admin verification.";

              // Show Downpayment section (legacy/manual vs PayMongo)
              els.customModalDpSection.classList.remove('hidden');
              if (order.downPaymentReceiptUrl) {
                els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-gray-500 hover:underline">View Verified Downpayment Receipt</a>`;
              } else {
                // For PayMongo downpayment we may have no manual receipt; indicate verified status
                els.customModalDpReceipt.innerHTML = `<span class="text-xs text-gray-500"><i class="fas fa-check-circle text-green-600"></i> Downpayment verified via PayMongo</span>`;
              }

              // Final payment section
              els.customModalFpSection.classList.remove('hidden');
              if (order.finalPaymentReceiptUrl) {
                // Manual upload path (backward compat)
                els.customModalFpReceipt.innerHTML = `<a href="${order.finalPaymentReceiptUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View Final Payment Receipt</a>`;
              } else if (order.paymentIntentId || order.receiptUrl) {
                // PayMongo final payment
                els.customModalFpReceipt.innerHTML = `
                  <button onclick="viewCustomOrderPayment('${order._id}')" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    <i class="fas fa-receipt"></i>View Final Payment Receipt
                  </button>
                  <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-credit-card text-indigo-600"></i> Method: ${order.paymentMethod || 'N/A'} ‚Ä¢ Amount: ‚Ç±${(order.paymentAmount || 0).toLocaleString()}
                  </p>
                `;
              } else {
                els.customModalFpReceipt.innerHTML = `<span class="text-red-500 text-xs">No final payment receipt data found.</span>`;
              }
              
              // Ipakita ang "Verify Final" button
              els.customModalVerifyFinal.classList.remove('hidden');
          }
        else {
          // Para sa "In Production", "Completed", etc.
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = `Order is currently: ${order.status}`;
        }

        // --- NEW: Handle Fulfillment Section ---
        const fulfillmentSection = document.getElementById('custom-modal-fulfillment-section');
        const fulfillmentInfo = document.getElementById('custom-modal-fulfillment-info');
        const fulfillmentForm = document.getElementById('custom-modal-fulfillment-form');
        const deliveryFields = document.getElementById('fulfillment-delivery-fields');
        const pickupFields = document.getElementById('fulfillment-pickup-fields');

        fulfillmentSection.classList.add('hidden');
        fulfillmentForm.classList.add('hidden');

        if (order.status === 'Completed' || order.status === 'Ready for Pickup/Delivery' || order.status === 'Out for Delivery') {
          fulfillmentSection.classList.remove('hidden');

          if (order.fulfillmentMethod === 'pending' || !order.fulfillmentMethod) {
            // Check if shippingAddress or shippingMethod exists (new structured data)
            if (order.shippingAddress || order.shippingMethod) {
              const addr = order.shippingAddress;
              const method = order.shippingMethod || 'Standard';
              
              if (method === 'Pick-Up') {
                fulfillmentInfo.innerHTML = `
                  <p class="font-semibold text-green-900">üì¶ Pick-Up Selected</p>
                  <p class="mt-1"><strong>Method:</strong> Customer will pick up at store</p>
                  <p class="mt-2 bg-green-50 border border-green-200 rounded p-2">
                    <strong class="text-green-900">üìç Pickup Location:</strong><br>
                    <span class="text-sm text-gray-700">Fundamental Apparel Store</span><br>
                    <span class="text-sm text-gray-600">123 Main Street, Barangay San Jose</span><br>
                    <span class="text-sm text-gray-600">Manila, Metro Manila 1000</span><br>
                    <span class="text-sm text-gray-600">üìû Contact: (02) 8123-4567</span>
                  </p>
                  <p class="mt-1 text-sm text-gray-600">Delivery Fee: FREE</p>
                `;
              } else {
                // Format full address from shippingAddress object with ALL fields
                let fullAddress = 'N/A';
                if (addr) {
                  const parts = [];
                  if (addr.block) parts.push(`Block ${addr.block}`);
                  if (addr.lot) parts.push(`Lot ${addr.lot}`);
                  if (addr.street) parts.push(addr.street);
                  if (addr.building) parts.push(addr.building);
                  if (addr.city) parts.push(addr.city);
                  if (addr.province) parts.push(addr.province);
                  if (addr.zip) parts.push(addr.zip);
                  fullAddress = parts.length > 0 ? parts.join(', ') : 'N/A';
                } else if (order.deliveryAddress) {
                  fullAddress = order.deliveryAddress;
                }
                
                fulfillmentInfo.innerHTML = `
                  <p class="font-semibold text-blue-900">üöö Standard Delivery Selected</p>
                  <p class="mt-1"><strong>Address:</strong> ${fullAddress}</p>
                  ${addr && addr.phone ? `<p class="mt-1"><strong>Contact:</strong> ${addr.phone}</p>` : ''}
                  <p class="mt-1 text-sm text-gray-600">Delivery Fee: ‚Ç±${order.deliveryFee || 80}</p>
                  <p class="mt-1 text-yellow-600">‚è≥ Awaiting admin to set tracking details</p>
                `;
              }
            } else {
              fulfillmentInfo.innerHTML = '<p class="text-gray-600">‚è≥ Customer has not chosen a fulfillment method yet.</p>';
            }
          } else if (order.fulfillmentMethod === 'delivery') {
            fulfillmentInfo.innerHTML = `
              <p class="font-semibold text-blue-900">üöö Delivery Selected</p>
              <p class="mt-1"><strong>Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
              ${order.courier ? `<p class="mt-1"><strong>Courier:</strong> <span class="font-medium text-blue-700">${order.courier}</span></p>` : ''}
              ${order.trackingNumber ? `<p class="mt-1"><strong>Tracking #:</strong> <span class="font-mono text-green-700">${order.trackingNumber}</span></p>` : '<p class="mt-1 text-yellow-600">‚ö†Ô∏è Tracking number not set yet</p>'}
              ${order.estimatedDeliveryDate ? `<p class="mt-1"><strong>Est. Delivery:</strong> ${new Date(order.estimatedDeliveryDate).toLocaleDateString()}</p>` : ''}
            `;
            
            if (order.status === 'Ready for Pickup/Delivery') {
              fulfillmentForm.classList.remove('hidden');
              deliveryFields.classList.remove('hidden');
              pickupFields.classList.add('hidden');
              
              // Populate delivery address - use deliveryAddress if available, otherwise format from shippingAddress
              let displayAddress = order.deliveryAddress || 'N/A';
              if ((!order.deliveryAddress || order.deliveryAddress === 'N/A') && order.shippingAddress) {
                const addr = order.shippingAddress;
                const parts = [];
                if (addr.block) parts.push(`Block ${addr.block}`);
                if (addr.lot) parts.push(`Lot ${addr.lot}`);
                if (addr.street) parts.push(addr.street);
                if (addr.building) parts.push(addr.building);
                if (addr.city) parts.push(addr.city);
                if (addr.province) parts.push(addr.province);
                if (addr.zip) parts.push(addr.zip);
                if (addr.phone) parts.push(`Tel: ${addr.phone}`);
                displayAddress = parts.length > 0 ? parts.join(', ') : 'N/A';
              }
              document.getElementById('delivery-address-text').textContent = displayAddress;
              
              document.getElementById('fulfillment-courier').value = order.courier || '';
              document.getElementById('fulfillment-tracking').value = order.trackingNumber || '';
              document.getElementById('fulfillment-delivery-date').value = order.estimatedDeliveryDate ? order.estimatedDeliveryDate.split('T')[0] : '';
            }
          } else if (order.fulfillmentMethod === 'pickup') {
            fulfillmentInfo.innerHTML = `
              <p class="font-semibold text-green-900">üì¶ Pickup Selected</p>
              <p class="mt-1"><strong>Location:</strong> ${order.pickupLocation || 'Fundamental Store - 123 Main St, Manila'}</p>
              ${order.pickupDate ? `<p class="mt-1"><strong>Pickup Date:</strong> ${new Date(order.pickupDate).toLocaleDateString()}</p>` : '<p class="mt-1 text-yellow-600">‚ö†Ô∏è Pickup date not set yet</p>'}
            `;

            if (order.status === 'Ready for Pickup/Delivery') {
              fulfillmentForm.classList.remove('hidden');
              pickupFields.classList.remove('hidden');
              deliveryFields.classList.add('hidden');
              
              document.getElementById('fulfillment-pickup-date').value = order.pickupDate ? order.pickupDate.split('T')[0] : '';
              document.getElementById('fulfillment-pickup-location').value = order.pickupLocation || 'Fundamental Store - 123 Main St, Manila';
            }
          }
        }
      }

      async function saveCustomQuote() {
        if (!selectedCustomOrder) return;

        const price = els.formCustomPrice.value;
        if (!price || Number(price) <= 0) {
          els.customModalError.textContent = 'Please enter a valid price.';
          els.customModalError.classList.remove('hidden');
          return;
        }

        els.customModalSaveQuote.disabled = true;
        els.customModalSaveQuote.textContent = 'Sending...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/quote`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ price: price, notes: els.formPricingNotes.value || undefined })
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to send quote');

          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders(); // I-refresh ang table

          els.customModal.classList.add('hidden'); // Isara ang modal
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalSaveQuote.disabled = false;
          els.customModalSaveQuote.textContent = 'Send Quote to Customer';
        }
      }

      async function verifyFinalPayment() {
          if (!selectedCustomOrder) return;

          if (!confirm('Are you sure you want to verify this FINAL payment? The order will be marked as Ready for Pickup/Delivery. This action cannot be undone.')) {
              return;
          }

          els.customModalVerifyFinal.disabled = true;
          els.customModalVerifyFinal.textContent = 'Verifying...';
          els.customModalError.classList.add('hidden');
          
          try {
              const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/verify-final-payment`, {
                  method: 'PUT',
                  headers: { 'Authorization': `Bearer ${token}` }
              });
              const data = await res.json();
              if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to verify');
              
              // Update local list
              const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
              if (idx >= 0) allCustomOrders[idx] = data.data;
              renderCustomOrders();
              
              els.customModal.classList.add('hidden');
          } catch (err) {
              els.customModalError.textContent = err.message;
              els.customModalError.classList.remove('hidden');
          } finally {
              els.customModalVerifyFinal.disabled = false;
              els.customModalVerifyFinal.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verify Final Payment';
          }
      }

      // --- NEW: Function to verify DP ---
      async function verifyDownPayment() {
        if (!selectedCustomOrder) return;

        if (!confirm('Are you sure you want to verify this down payment and start production? This action cannot be undone.')) {
          return;
        }

        els.customModalVerifyDp.disabled = true;
        els.customModalVerifyDp.textContent = 'Verifying...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/verify-downpayment`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to verify');

          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders();

          els.customModal.classList.add('hidden');
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalVerifyDp.disabled = false;
          els.customModalVerifyDp.textContent = 'Verify & Start Production';
        }
      }

      async function requestFinalPayment() {
        if (!selectedCustomOrder) return;

        if (!confirm('Are you sure you want to mark this order as complete and request final payment?')) {
          return;
        }

        els.customModalRequestFinal.disabled = true;
        els.customModalRequestFinal.textContent = 'Requesting...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/request-final-payment`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to update status');

          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders();

          els.customModal.classList.add('hidden');
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalRequestFinal.disabled = false;
          els.customModalRequestFinal.textContent = 'Request Final Payment';
        }
      }
      // --- END NEW FUNCTIONS ---

      // --- Events ---
      els.search.addEventListener('input', renderRegularOrders);
      els.filterStatus.addEventListener('change', renderRegularOrders);
      els.filterPayment.addEventListener('change', renderRegularOrders);

      // Regular order edit
      els.tbody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const order = allOrders.find(o => o._id === id);
          if (order) openModal(order);
        }
      });

      // MODIFIED: Custom order edit
      els.customOrdersBody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-custom-btn');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const order = allCustomOrders.find(o => o._id === id);
          if (order) openCustomModal(order);
        }
      });

      // Tab Switching
      els.tabsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button.admin-tab');
        if (!btn) return;

        els.tabsContainer.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        const tab = btn.dataset.tab;
        if (tab === 'regular') {
          els.tabContentRegular.classList.remove('hidden');
          els.tabContentCustom.classList.add('hidden');
        } else if (tab === 'custom') {
          els.tabContentRegular.classList.add('hidden');
          els.tabContentCustom.classList.remove('hidden');
          if (allCustomOrders.length === 0) {
            loadCustomOrders();
          }
        }
      });

      // Regular Modal Events
      els.formStatus.addEventListener('change', () => {
        els.modalAdminCancelReasonBox.classList.toggle('hidden', els.formStatus.value !== 'Cancelled');
      });
      els.modalClose.addEventListener('click', () => els.modal.classList.add('hidden'));
      els.modal.addEventListener('click', (e) => { if (e.target === els.modal) els.modal.classList.add('hidden'); });
      els.modalSave.addEventListener('click', saveModal);
      // Receipt controls
      if (els.modalReceiptBtn) {
        els.modalReceiptBtn.addEventListener('click', () => {
          els.receiptWrap.classList.toggle('hidden');
          if (!els.receiptWrap.classList.contains('hidden')) {
            els.receiptWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      if (els.receiptCopyRef) {
        els.receiptCopyRef.addEventListener('click', async () => {
          const txt = (els.receiptReference.textContent || '').trim();
          try { await navigator.clipboard.writeText(txt); } catch (_) {}
        });
      }
      if (els.receiptPrint) {
        els.receiptPrint.addEventListener('click', () => window.print());
      }
      // --- MODIFIED: Custom Modal Events ---
      els.customModalClose.addEventListener('click', () => els.customModal.classList.add('hidden'));
      els.customModal.addEventListener('click', (e) => { if (e.target === els.customModal) els.customModal.classList.add('hidden'); });
      els.customModalSaveQuote.addEventListener('click', saveCustomQuote); // Para sa Phase 2
      els.customModalVerifyDp.addEventListener('click', verifyDownPayment); // Para sa Phase 4
      els.customModalRequestFinal.addEventListener('click', requestFinalPayment); // Para sa Phase 5.1
      els.customModalVerifyFinal.addEventListener('click', verifyFinalPayment);

      // --- NEW: Save Fulfillment Details ---
      async function saveFulfillmentDetails() {
        if (!selectedCustomOrder) return;

        const fulfillmentMethod = selectedCustomOrder.fulfillmentMethod;
        const data = {};

        if (fulfillmentMethod === 'delivery') {
          const courier = document.getElementById('fulfillment-courier').value.trim();
          const trackingNumber = document.getElementById('fulfillment-tracking').value.trim();
          const deliveryDate = document.getElementById('fulfillment-delivery-date').value;

          if (!courier) {
            alert('Please select a courier service.');
            return;
          }
          if (!trackingNumber) {
            alert('Please enter a tracking number.');
            return;
          }

          data.courier = courier;
          data.trackingNumber = trackingNumber;
          if (deliveryDate) data.estimatedDeliveryDate = deliveryDate;
        } else if (fulfillmentMethod === 'pickup') {
          const pickupDate = document.getElementById('fulfillment-pickup-date').value;
          const pickupLocation = document.getElementById('fulfillment-pickup-location').value.trim();

          if (pickupDate) data.pickupDate = pickupDate;
          if (pickupLocation) data.pickupLocation = pickupLocation;
        }

        if (Object.keys(data).length === 0) {
          alert('Please enter at least one fulfillment detail.');
          return;
        }

        const saveBtn = document.getElementById('custom-modal-save-fulfillment');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/fulfillment-details`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(data)
          });
          const result = await res.json();
          if (!res.ok || !result.success) throw new Error(result.msg || 'Failed to save fulfillment details');

          alert(result.msg || 'Fulfillment details saved! Status updated to "Out for Delivery".');
          
          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = result.data;
          renderCustomOrders(); // Refresh the table

          els.customModal.classList.add('hidden'); // Close modal

        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Tracking Details';
        }
      }

      document.getElementById('custom-modal-save-fulfillment').addEventListener('click', saveFulfillmentDetails);

      // --- Initial load ---
      loadRegularOrders();
    });

    // Custom Order Payment Receipt Viewer
    async function viewCustomOrderPayment(orderId) {
      try {
        const token = localStorage.getItem('adminToken');
        const res = await fetch(`${API}/api/custom-orders/${orderId}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });
        const json = await res.json();
        
        if (!json.success || !json.data) {
          alert('Failed to load payment details');
          return;
        }
        
        const order = json.data;
        const code = (order._id || '').toString().slice(-8).toUpperCase();
        
        // Calculate payment breakdown
        const totalAmount = Number(order.price || 0);
        const deliveryFee = Number(order.deliveryFee || 0);
        const grandTotal = totalAmount + deliveryFee;
        let paymentType = order.paymentType || order.paymentOption || 'downpayment'; // 'downpayment' | 'full' | 'remaining'
        // Use actual PayMongo payment amount when available; fallback to PayMongo details if DB missing
        let amountPaid = Number(order.paymentAmount || 0);
        if ((!amountPaid || amountPaid <= 0) && order.paymentIntentId) {
          try {
            const detRes = await fetch(`${API}/api/payments/details/custom/${order._id}`, {
              headers: { 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' }
            });
            const detJson = await detRes.json();
            if (detJson.success && detJson.data) {
              amountPaid = Number(detJson.data.amount || amountPaid);
              if (!order.paymentType) {
                paymentType = Math.abs(amountPaid - grandTotal) < 1 ? 'full' : 'downpayment';
              }
            }
          } catch (e) {
            console.warn('Payment details fallback failed:', e);
          }
        }
        const isFinalPayment = (paymentType === 'remaining' || paymentType === 'balance');
        // For final payment, remaining balance after this transaction is zero
        const remainingBalance = (paymentType === 'full' || isFinalPayment) 
          ? 0 
          : Math.max(0, grandTotal - amountPaid);
        
        let receiptHtml = `
          <div class="space-y-4">
            <div class="text-center pb-4 border-b">
              <div class="text-xs text-gray-500 mb-1">Reference Number</div>
              <div class="font-mono font-bold text-lg">${code}</div>
              <button onclick="copyToClipboard('${code}')" class="text-xs text-indigo-600 hover:underline mt-1">
                <i class="fas fa-copy"></i> Copy
              </button>
            </div>
            
            <div>
              <div class="text-xs text-gray-500 mb-1">Payment Type</div>
              <div class="text-lg font-semibold text-indigo-600 mb-3">${
                paymentType === 'full' 
                  ? '100% Full Payment' 
                  : (isFinalPayment ? '50% Final Payment' : '50% Downpayment')
              }</div>
              
              <div class="text-xs text-gray-500 mb-1">Amount Paid</div>
              <div class="text-3xl font-bold text-green-600">‚Ç±${amountPaid.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-xs text-gray-500 mb-1">Payment</div>
                <div class="font-medium">${new Date(order.updatedAt || order.createdAt).toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'})}, ${new Date(order.updatedAt || order.createdAt).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true})}</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Payment method</div>
                <div class="font-medium capitalize">${order.paymentMethod || 'N/A'}</div>
              </div>
            </div>
            
            <div class="flex items-center justify-between py-3 px-4 bg-green-50 rounded-lg">
              <span class="text-sm font-medium text-gray-700">Payment received</span>
              <i class="fas fa-check-circle text-2xl text-green-600"></i>
            </div>
            
            <div class="border-t pt-3">
              <div class="text-xs text-gray-500 mb-2">Payment for</div>
              <div class="font-medium mb-1">${order.productName || 'Custom Order'} ‚Ä¢ Ref ${code}</div>
              <div class="text-xs text-gray-500">Service: ${order.serviceType || 'customize-jersey'}</div>
            </div>
            
            <div class="border-t pt-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Item name</span>
                <span class="text-gray-600">Qty</span>
                <span class="text-gray-600">Price</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="font-medium">${order.productName || 'Custom Order'}</span>
                <span class="font-medium">${order.quantity || 1}</span>
                <span class="font-medium">‚Ç±${totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
            </div>
            
            <div class="border-t pt-3 space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Subtotal</span>
                <span class="font-medium">‚Ç±${totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Delivery Fee</span>
                <span class="font-medium">‚Ç±${deliveryFee.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between font-bold text-base pt-2 border-t">
                <span>Total Amount</span>
                <span>‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between text-green-600 font-semibold">
                <span>Amount Paid (${paymentType === 'full' ? '100%' : (isFinalPayment ? 'Final 50%' : '50%')})</span>
                <span>‚Ç±${amountPaid.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              ${
                remainingBalance > 0 || isFinalPayment || paymentType === 'full' 
                  ? `
              <div class="flex justify-between ${remainingBalance > 0 ? 'text-orange-600' : 'text-green-700'} font-semibold">
                <span>Remaining Balance</span>
                <span>‚Ç±${(remainingBalance || 0).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>`
                  : ''
              }
            </div>
            
            ${order.paymentIntentId ? `
            <div class="text-xs text-gray-500 text-center pt-2 border-t">
              <i class="fas fa-shield-alt"></i> Secured by PayMongo<br/>
              Session ID: ${order.paymentIntentId.slice(0, 30)}...
            </div>
            ` : ''}
          </div>
        `;
        
        document.getElementById('custom-payment-receipt-content').innerHTML = receiptHtml;
        document.getElementById('custom-payment-receipt-modal').classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading payment receipt:', error);
        alert('Failed to load payment details');
      }
    }
    
    function closeCustomPaymentModal() {
      document.getElementById('custom-payment-receipt-modal').classList.add('hidden');
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Reference number copied!');
      });
    }
  </script>
</body>

</html>