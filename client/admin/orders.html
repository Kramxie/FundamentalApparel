<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Print only the receipt section when printing */
    @media print {
      body * { visibility: hidden; }
      #receipt-wrap, #receipt-wrap * { visibility: visible; }
      #receipt-wrap { position: absolute; left: 0; top: 0; width: 100%; background: white; }
      /* Hide interactive controls when printing */
      .no-print { display: none !important; }
    }

    .admin-tab {
      font-size: 1.125rem;
      font-weight: 600;
      color: rgb(156 163 175);
      padding-bottom: 0.5rem;
      cursor: pointer;
    }

    .admin-tab.active {
      color: rgb(17 24 39);
      border-bottom-width: 2px;
      border-color: rgb(17 24 39);
    }

    /* Fixed Sidebar Styles */
    .admin-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 260px;
      background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 40;
    }
    .admin-sidebar::-webkit-scrollbar { width: 6px; }
    .admin-sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    
    .admin-main {
      margin-left: 260px;
    }
    
    @media (max-width: 768px) {
      .admin-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .admin-sidebar.open {
        transform: translateX(0);
      }
      .admin-main {
        margin-left: 0;
      }
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: rgba(255,255,255,0.7);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      margin-bottom: 2px;
    }
    .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .nav-link.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    .nav-link i { width: 20px; text-align: center; }
    
    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255,255,255,0.4);
      padding: 0 16px;
      margin-bottom: 8px;
      margin-top: 16px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-gray-100">
  <div id="dev-error-banner" class="hidden fixed top-16 left-1/2 transform -translate-x-1/2 z-50 bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded-md text-sm"></div>
  
  <!-- Fixed Sidebar -->
  <aside class="admin-sidebar hidden md:flex flex-col">
    <!-- Logo -->
    <div class="p-5 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-xl flex items-center justify-center">
          <i class="fas fa-tshirt text-white text-lg"></i>
        </div>
        <div>
          <span class="text-white font-bold text-lg">Fundamental</span>
          <span class="block text-xs text-indigo-300">Admin Panel</span>
        </div>
      </div>
    </div>
    
    <!-- Navigation -->
    <nav class="flex-1 p-3">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link">
        <i class="fas fa-th-large"></i><span>Dashboard</span>
      </a>
      <a href="orders.html" class="nav-link active">
        <i class="fas fa-shopping-bag"></i><span>Orders</span>
      </a>
      <a href="returns.html" class="nav-link">
        <i class="fas fa-undo"></i><span>Returns & Refunds</span>
      </a>
      <a href="messages.html" class="nav-link">
        <i class="fas fa-comments"></i><span>Messages</span>
      </a>
      
      <div class="nav-section-title">Products</div>
      <a href="add-product.html" class="nav-link">
        <i class="fas fa-plus-circle"></i><span>Add Product</span>
      </a>
      <a href="add-predisign-product.html" class="nav-link">
        <i class="fas fa-tshirt"></i><span>Add Pre-Design</span>
      </a>
      <a href="inventory.html" class="nav-link">
        <i class="fas fa-boxes"></i><span>Inventory</span>
      </a>
      <a href="manage-categories.html" class="nav-link">
        <i class="fas fa-folder"></i><span>Categories</span>
      </a>
      <a href="featured-products.html" class="nav-link">
        <i class="fas fa-star"></i><span>Featured Products</span>
      </a>
      
      <div class="nav-section-title">Analytics</div>
      <a href="reports.html" class="nav-link">
        <i class="fas fa-chart-bar"></i><span>Reports & Sales</span>
      </a>
      <a href="vouchers.html" class="nav-link">
        <i class="fas fa-ticket-alt"></i><span>Vouchers</span>
      </a>
      
      <div class="nav-section-title">Admin</div>
      <a href="employees.html" class="nav-link">
        <i class="fas fa-users"></i><span>Employees</span>
      </a>
    </nav>
    
    <!-- Bottom Section -->
    <div class="p-3 border-t border-white/10 mt-auto">
      <a href="settings.html" class="nav-link">
        <i class="fas fa-cog"></i><span>Settings</span>
      </a>
      <a href="profile.html" class="nav-link">
        <i class="fas fa-user-circle"></i><span>Profile</span>
      </a>
    </div>
  </aside>

  <!-- Mobile Sidebar Overlay -->
  <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden"></div>
  
  <!-- Mobile Sidebar -->
  <aside id="mobile-sidebar" class="admin-sidebar md:hidden">
    <div class="p-4 border-b border-white/10 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-lg flex items-center justify-center">
          <i class="fas fa-tshirt text-white"></i>
        </div>
        <span class="text-white font-bold">Admin Panel</span>
      </div>
      <button id="mobile-sidebar-close" class="text-white/70 hover:text-white p-2">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>
    <nav class="flex-1 p-3">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i><span>Dashboard</span></a>
      <a href="orders.html" class="nav-link active"><i class="fas fa-shopping-bag"></i><span>Orders</span></a>
      <a href="returns.html" class="nav-link"><i class="fas fa-undo"></i><span>Returns & Refunds</span></a>
      <a href="messages.html" class="nav-link"><i class="fas fa-comments"></i><span>Messages</span></a>
      
      <div class="nav-section-title">Products</div>
      <a href="add-product.html" class="nav-link"><i class="fas fa-plus-circle"></i><span>Add Product</span></a>
      <a href="add-predisign-product.html" class="nav-link"><i class="fas fa-tshirt"></i><span>Add Pre-Design</span></a>
      <a href="inventory.html" class="nav-link"><i class="fas fa-boxes"></i><span>Inventory</span></a>
      <a href="manage-categories.html" class="nav-link"><i class="fas fa-folder"></i><span>Categories</span></a>
      <a href="featured-products.html" class="nav-link"><i class="fas fa-star"></i><span>Featured Products</span></a>
      
      <div class="nav-section-title">Analytics</div>
      <a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i><span>Reports & Sales</span></a>
      <a href="vouchers.html" class="nav-link"><i class="fas fa-ticket-alt"></i><span>Vouchers</span></a>
      
      <div class="nav-section-title">Admin</div>
      <a href="employees.html" class="nav-link"><i class="fas fa-users"></i><span>Employees</span></a>
    </nav>
    <div class="p-3 border-t border-white/10">
      <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i><span>Settings</span></a>
      <a href="profile.html" class="nav-link"><i class="fas fa-user-circle"></i><span>Profile</span></a>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="admin-main min-h-screen">
    <!-- Sticky Header -->
    <header class="sticky top-0 z-20 bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg hover:bg-gray-100">
            <i class="fas fa-bars text-gray-600"></i>
          </button>
          <div>
            <h1 class="text-xl font-bold text-gray-800">Orders</h1>
            <p class="text-sm text-gray-500">Manage customer orders</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="hidden sm:flex items-center gap-3 pl-3 border-l border-gray-200">
            <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-semibold text-sm" id="user-avatar">A</div>
            <div class="hidden md:block">
              <p class="text-sm font-medium text-gray-800" id="user-name">Admin</p>
              <p class="text-xs text-gray-500">Administrator</p>
            </div>
          </div>
          <button id="logout-btn" class="ml-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
            <i class="fas fa-sign-out-alt"></i>
            <span class="hidden sm:inline">Logout</span>
          </button>
        </div>
      </div>
    </header>
    
    <div class="p-6">
      <!-- Page-level message container -->
      <div id="message-container" class="hidden mb-4 p-3 rounded-md bg-green-100 text-green-800"></div>
      <div class="p-6 space-y-6">
        <div class="bg-white p-4 rounded-lg shadow">
          <div id="tabs-container" class="flex gap-8">
            <button data-tab="regular" class="admin-tab active">Manage Orders</button>
            <button data-tab="custom" class="admin-tab">Manage Custom Orders</button>
          </div>
        </div>

        <div id="tab-content-regular">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
              <div class="flex gap-3 items-center">
                <select id="filter-status" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Order Status</option>
                  <option value="to-pay">To Pay</option>
                  <option value="to-ship">To Ship</option>
                  <option value="to-receive">To Receive</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="archived">üì¶ Archived</option>
                </select>
                <select id="filter-payment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Payment</option>
                  <option>Pending</option>
                  <option>Received</option>
                  <option>Rejected</option>
                </select>
                <select id="filter-shipping" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Shipping</option>
                  <option value="Standard">Standard</option>
                  <option value="Pick-Up">Pick-Up</option>
                </select>
                <input id="search" type="text" placeholder="Search (order id, customer, tracking)..." class="border rounded-md px-3 py-2 text-sm w-full sm:w-56">
                <input id="date-from" type="date" class="border rounded-md px-3 py-2 text-sm">
                <input id="date-to" type="date" class="border rounded-md px-3 py-2 text-sm">
                <button id="filter-reset" class="px-3 py-2 text-sm border rounded hover:bg-gray-50">Reset</button>
                <button id="refresh-orders" class="px-3 py-2 text-sm border rounded hover:bg-gray-50">Refresh</button>
                <label class="flex items-center gap-2 text-sm text-gray-600"><input id="auto-refresh-orders" type="checkbox" class="h-4 w-4"> Auto</label>
              </div>
              <div class="text-sm text-gray-500"><span id="count">0</span> orders</div>
            </div>
            <div id="orders-cards" class="sm:hidden p-4"></div>
            <div class="overflow-x-auto hidden sm:block">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left px-4 py-3">Order ID</th>
                    <th class="text-left px-4 py-3">Created</th>
                    <th class="text-left px-4 py-3">Payment Status</th>
                    <th class="text-left px-4 py-3">Order Status</th>
                    <th class="text-left px-4 py-3">Items</th>
                    <th class="text-left px-4 py-3">Customer</th>
                    <th class="text-left px-4 py-3">Shipping</th>
                    <th class="text-left px-4 py-3">Tracking</th>
                    <th class="text-right px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="orders-body" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-content-custom" class="hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
              <div class="flex flex-wrap gap-2 items-center">
                <input id="custom-search" type="text" placeholder="Search name, ref, courier..." class="border rounded-md px-3 py-2 text-sm w-full sm:w-56">
                <select id="custom-filter-status" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">All Status</option>
                  <option value="Pending Quote">‚è≥ Pending Quote</option>
                  <option value="Quote Sent">üì§ Quote Sent</option>
                  <option value="Quote Accepted">‚úÖ Quote Accepted</option>
                  <option value="Pending Downpayment">üí≥ Awaiting DP Verification</option>
                  <option value="In Production">üè≠ In Production</option>
                  <option value="Pending Balance">üí∞ Awaiting Balance Payment</option>
                  <option value="Pending Final Verification">üîç Verifying Final Payment</option>
                  <option value="Ready for Pickup/Delivery">üì¶ Ready for Fulfillment</option>
                  <option value="Out for Delivery">üöö Out for Delivery</option>
                  <option value="Completed">‚úÖ Completed</option>
                  <option value="Cancelled">‚ùå Cancelled</option>
                  <option value="archived">üì¶ Archived</option>
                </select>
                <select id="custom-filter-type" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Type</option>
                  <option>Pre-Design Product</option>
                  <option>Upload File</option>
                </select>
                <select id="custom-filter-shipmethod" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Shipping Method</option>
                  <option>Standard</option>
                  <option>Pick-Up</option>
                </select>
                <select id="custom-filter-fulfillment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Fulfillment</option>
                  <option>pending</option>
                  <option>pickup</option>
                  <option>delivery</option>
                </select>
                <select id="custom-filter-payment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Payment Stage</option>
                  <option value="dp-paid">Downpayment Paid</option>
                  <option value="dp-unpaid">Downpayment Pending</option>
                  <option value="bal-paid">Balance Paid</option>
                  <option value="bal-unpaid">Balance Pending</option>
                </select>
                <select id="custom-filter-courier" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Courier</option>
                  <option value="has">Has Courier</option>
                  <option value="none">No Courier</option>
                </select>
                <select id="custom-filter-tracking" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Tracking</option>
                  <option value="has">Has Tracking</option>
                  <option value="none">No Tracking</option>
                </select>
                <div class="flex items-center gap-2">
                  <input id="custom-date-from" type="date" class="border rounded-md px-2 py-1.5 text-sm" />
                  <span class="text-gray-400 text-xs">to</span>
                  <input id="custom-date-to" type="date" class="border rounded-md px-2 py-1.5 text-sm" />
                </div>
                <button id="custom-filter-reset" class="px-3 py-2 text-sm border rounded hover:bg-gray-50">Reset</button>
                <button id="refresh-custom" class="px-3 py-2 text-sm border rounded hover:bg-gray-50">Refresh</button>
                <label class="flex items-center gap-2 text-sm text-gray-600"><input id="auto-refresh-custom" type="checkbox" class="h-4 w-4"> Auto</label>
              </div>
              <div class="text-sm text-gray-500"><span id="custom-count">0</span> custom requests</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left px-4 py-3">Date</th>
                    <th class="text-left px-4 py-3">Customer</th>
                    <th class="text-left px-4 py-3">Type</th>
                    <th class="text-left px-4 py-3">Qty</th>
                    <th class="text-left px-4 py-3">Status</th>
                    <th class="text-left px-4 py-3">Shipping</th>
                    <th class="text-left px-4 py-3">Details</th>
                    <th class="text-right px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="custom-orders-body" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-3xl w-full overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 class="font-semibold text-gray-800">Order Details</h3>
        <button id="modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
        <div>
          <h4 class="font-semibold mb-2">Order Summary</h4>
          <div id="modal-items" class="space-y-3 text-sm"></div>
          <div class="mt-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span> <span id="modal-subtotal">0</span></div>
            <div class="flex justify-between"><span>Delivery Fee</span> <span id="modal-delivery">0</span></div>
            <div class="flex justify-between font-semibold"><span>Total</span> <span id="modal-total">0</span></div>
          </div>
          <div class="mt-3">
            <button id="modal-receipt-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm border rounded hover:bg-gray-50"><i class="fas fa-receipt text-green-600"></i>View Receipt</button>
            <button id="modal-download-receipt" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm border rounded hover:bg-gray-50 ml-2"><i class="fas fa-download text-blue-600"></i>Download</button>
          </div>
          <!-- Professional Invoice Receipt Container - Content generated by buildReceiptHtml() -->
          <div id="receipt-wrap" class="hidden mt-4 border rounded-lg overflow-hidden shadow-lg bg-white">
            <!-- Receipt HTML will be injected here by buildReceiptHtml() -->
          </div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Payment and Shipping</h4>
          <div class="text-sm space-y-2">
            <div><span class="text-gray-500">Payment Method:</span> <span id="modal-paymentMethod"></span></div>
            <div><span class="text-gray-500">Shipping Method:</span> <span id="modal-shippingMethod"></span></div>
            <div><span class="text-gray-500">Payment Status:</span> <span id="modal-paymentStatus"></span></div>
            <div><span class="text-gray-500">Payment Reference:</span> <span id="modal-paymentRef" class="font-mono"></span></div>
          </div>
          <div class="mt-4">
            <h5 class="font-medium mb-2">Shipping Address</h5>
            <div id="modal-address" class="text-sm text-gray-700"></div>
          </div>
          <div id="modal-cancellation-details" class="hidden mt-4 text-sm space-y-1">
            <h5 class="font-medium mb-1">Cancellation Details</h5>
            <div class="bg-red-50 p-3 rounded-md">
              <p><strong>Cancelled By:</strong> <span id="modal-cancelled-by"></span></p>
              <p><strong>Reason:</strong> <span id="modal-cancellation-reason"></span></p>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 gap-3 text-sm">
            <div>
              <label class="block text-gray-700 mb-1">Payment Status</label>
              <select id="form-paymentStatus" class="w-full border rounded px-3 py-2">
                <option>Pending</option>
                <option>Received</option>
                <option>Rejected</option>
              </select>
            </div>
            <!-- Order Status is now automatic based on workflow -->
            <!-- Shipping Service & Tracking handled by Ship Order modal -->
          </div>
          <div id="modal-admin-cancel-reason-box" class="hidden mt-3 text-sm">
            <label class="block text-gray-700 mb-1">Reason for Cancellation (Admin)</label>
            <input id="form-cancellationReason" type="text" class="w-full border rounded px-3 py-2"
              placeholder="e.g., Out of stock">
          </div>
        </div>
        <div id="modal-refund-section" class="hidden mt-4 text-sm space-y-2 border-t pt-3">
          <h5 class="font-medium mb-1">Return / Refund Request</h5>
          <div class="bg-yellow-50 p-3 rounded-md">
            <p><strong>Status:</strong> <span id="modal-refund-status">-</span></p>
            <p><strong>Reason:</strong> <span id="modal-refund-reason">-</span></p>
            <p><strong>Amount:</strong> <span id="modal-refund-amount">-</span></p>
            <div id="modal-refund-media" class="mt-2 flex gap-2 flex-wrap"></div>
            <div class="mt-2"><label class="block text-sm">Admin Notes</label><textarea id="modal-refund-adminnotes" class="w-full border rounded px-2 py-1 text-sm" rows="2"></textarea></div>
            <div class="mt-3 flex gap-2">
              <button id="btn-approve-refund" class="px-3 py-1 text-sm bg-green-600 text-white rounded">Approve</button>
              <button id="btn-reject-refund" class="px-3 py-1 text-sm bg-red-600 text-white rounded">Reject</button>
              <button id="btn-process-refund" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded">Process Refund</button>
            </div>
            <p id="modal-refund-msg" class="text-sm text-red-600 mt-2"></p>
          </div>
        </div>
      </div>
      <div class="px-5 py-3 border-t flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <button id="modal-archive" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded text-sm" title="Archive Order">
            <i class="fas fa-archive mr-1"></i>Archive
          </button>
          <button id="modal-delete" class="hidden bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded text-sm" title="Delete Order">
            <i class="fas fa-trash-alt mr-1"></i>Delete
          </button>
        </div>
        <div class="flex items-center gap-3">
          <p id="modal-error" class="text-sm text-red-600"></p>
          <button id="modal-save"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-4 py-2 rounded">Save</button>
          <button id="modal-remove" class="hidden bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ship Order Modal - NEW -->
  <div id="ship-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-lg w-full overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b bg-gradient-to-r from-indigo-600 to-purple-600">
        <h3 class="font-semibold text-white flex items-center gap-2">
          <i class="fas fa-shipping-fast"></i> Ship Order
        </h3>
        <button id="ship-modal-close" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-5 space-y-4">
        <!-- Order Info -->
        <div class="bg-gray-50 p-3 rounded-lg border">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-600">Order ID:</span>
            <span id="ship-modal-order-id" class="font-mono text-sm font-semibold text-indigo-600"></span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-gray-600">Customer:</span>
            <span id="ship-modal-customer" class="text-sm font-medium"></span>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
          <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-map-marker-alt text-blue-600"></i>
            <span class="text-sm font-semibold text-gray-700">Delivery Address:</span>
          </div>
          <div id="ship-modal-address" class="text-sm text-gray-700"></div>
          <div id="ship-modal-distance" class="text-xs text-blue-600 mt-1 hidden">
            <i class="fas fa-route"></i> <span></span>
          </div>
        </div>

        <!-- Courier Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-truck text-gray-500 mr-1"></i> Select Courier
          </label>
          <select id="ship-modal-courier" class="w-full border rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">-- Select Courier --</option>
            <option value="Lalamove">üèçÔ∏è Lalamove (Same-Day)</option>
            <option value="Grab Express">üü¢ Grab Express (Same-Day)</option>
            <option value="J&T Express">üì¶ J&T Express (1-3 Days)</option>
            <option value="LBC Express">üì¶ LBC Express (1-3 Days)</option>
            <option value="Ninja Van">üì¶ Ninja Van (1-3 Days)</option>
            <option value="Flash Express">‚ö° Flash Express (1-3 Days)</option>
            <option value="JRS Express">üì¶ JRS Express (2-5 Days)</option>
            <option value="2GO Express">üì¶ 2GO Express (3-5 Days)</option>
          </select>
          <p id="ship-modal-courier-recommendation" class="text-xs text-green-600 mt-1 hidden">
            <i class="fas fa-lightbulb"></i> <span></span>
          </p>
        </div>

        <!-- Tracking Number (Auto-generated) -->
        <div id="ship-modal-tracking-section" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-barcode text-gray-500 mr-1"></i> Tracking Number
          </label>
          <div class="relative">
            <input id="ship-modal-tracking" type="text" readonly
              class="w-full border rounded-lg px-3 py-2.5 text-sm font-mono bg-gray-50 pr-20">
            <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-green-600 font-medium">
              <i class="fas fa-check-circle"></i> Auto-generated
            </span>
          </div>
        </div>

        <!-- Tracking URL -->
        <div id="ship-modal-url-section" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-link text-gray-500 mr-1"></i> Tracking URL
          </label>
          <div class="flex items-center gap-2">
            <input id="ship-modal-tracking-url" type="text" readonly
              class="flex-1 border rounded-lg px-3 py-2 text-xs font-mono bg-gray-50 text-gray-600 truncate">
            <button id="ship-modal-copy-url" type="button"
              class="px-3 py-2 bg-gray-100 hover:bg-gray-200 border rounded-lg text-sm transition-colors">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <!-- Error message -->
        <p id="ship-modal-error" class="text-sm text-red-600 hidden"></p>
      </div>

      <!-- Footer -->
      <div class="px-5 py-3 border-t bg-gray-50 flex items-center justify-end gap-3">
        <button id="ship-modal-cancel" class="px-4 py-2 border rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">
          Cancel
        </button>
        <button id="ship-modal-confirm" disabled
          class="px-5 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium rounded-lg text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <i class="fas fa-check"></i> Confirm Shipment
        </button>
      </div>
    </div>
  </div>

  <script>
    // Mobile sidebar handlers (enable on pages that include mobile sidebar markup)
    (function(){
      document.addEventListener('DOMContentLoaded', function(){
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        function openSidebar() {
          if (!mobileSidebar) return;
          mobileSidebar.classList.remove('-translate-x-full');
          mobileSidebar.classList.add('translate-x-0');
          if (sidebarOverlay) sidebarOverlay.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
        }
        function closeSidebar() {
          if (!mobileSidebar) return;
          mobileSidebar.classList.remove('translate-x-0');
          mobileSidebar.classList.add('-translate-x-full');
          if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
        }
        mobileMenuBtn?.addEventListener('click', openSidebar);
        document.getElementById('mobile-sidebar-close')?.addEventListener('click', closeSidebar);
        sidebarOverlay?.addEventListener('click', closeSidebar);
        if (mobileSidebar) Array.from(mobileSidebar.querySelectorAll('a')).forEach(a => a.addEventListener('click', closeSidebar));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });
      });
    })();
  </script>

  <div id="custom-order-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-6xl w-full overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50">
        <h3 class="text-lg font-semibold text-gray-800">Custom Order Request</h3>
        <button id="custom-modal-close" class="text-gray-500 hover:text-gray-700 text-xl"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 max-h-[80vh] overflow-y-auto space-y-6">
        <!-- Error Message (Full Width) -->
        <div id="custom-modal-error" class="hidden text-sm p-3 rounded-md bg-red-100 text-red-700"></div>
        
        <!-- Two Column Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- LEFT COLUMN -->
          <div class="space-y-6">
            <!-- Basic Information -->
            <div class="bg-gray-50 p-4 rounded-lg border">
              <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-info-circle mr-2 text-indigo-600"></i>
                Order Information
              </h4>
              <div class="text-sm space-y-2">
                <p><strong>Customer:</strong> <span id="custom-modal-user"></span></p>
                <p><strong>Quantity:</strong> <span id="custom-modal-qty"></span></p>
                <p><strong>Type:</strong> <span id="custom-modal-type"></span></p>
              </div>
            </div>

            <!-- Service Type Badge -->
            <div id="custom-modal-service-type-section">
              <span id="custom-modal-service-badge" class="inline-block px-3 py-1 rounded-full text-sm font-semibold"></span>
            </div>

        <!-- Customize Jersey Details -->
        <div id="custom-modal-customize-jersey-section" class="hidden space-y-3">
          <div class="border-t pt-3">
            <h4 class="font-semibold text-gray-800 mb-2">üéΩ Jersey Customization</h4>
            <div class="space-y-2 text-sm">
              <p><strong>Item Type:</strong> <span id="custom-modal-item-type"></span></p>
              <p><strong>Printing Type:</strong> <span id="custom-modal-printing-type"></span></p>
              
              <!-- Template Design Fields -->
              <div id="custom-modal-template-fields" class="hidden bg-gray-50 p-3 rounded border space-y-2">
                <p class="font-medium text-indigo-900">Template Design:</p>
                <p><strong>Design Style:</strong> <span id="custom-modal-design-style"></span></p>
                <div id="custom-modal-colors-section">
                  <strong>Colors:</strong>
                  <div class="flex gap-2 mt-1">
                    <div id="custom-modal-primary-color" class="w-8 h-8 rounded border-2 border-gray-300" title="Primary Color"></div>
                    <div id="custom-modal-secondary-color" class="w-8 h-8 rounded border-2 border-gray-300" title="Secondary Color"></div>
                    <div id="custom-modal-accent-color" class="w-8 h-8 rounded border-2 border-gray-300" title="Accent Color"></div>
                  </div>
                </div>
                <div id="custom-modal-text-section" class="hidden">
                  <p><strong>Custom Text:</strong> <span id="custom-modal-custom-text"></span></p>
                  <p><strong>Font:</strong> <span id="custom-modal-text-font"></span> | <strong>Size:</strong> <span id="custom-modal-text-size"></span></p>
                  <p><strong>Placement:</strong> <span id="custom-modal-text-placement"></span></p>
                </div>
                <div id="custom-modal-logo-section" class="hidden">
                  <p><strong>Logo Type:</strong> <span id="custom-modal-logo-type"></span></p>
                  <p><strong>Logo Placement:</strong> <span id="custom-modal-logo-placement"></span></p>
                  <div id="custom-modal-logo-preview"></div>
                </div>
              </div>

              <!-- Upload Design File -->
              <div id="custom-modal-design-file-section" class="hidden">
                <strong>Design File:</strong>
                <div id="custom-modal-design-file" class="mt-1"></div>
              </div>

              <!-- Professional Customizer (3-panel) Details -->
              <div id="custom-modal-pro-section" class="hidden bg-gray-50 p-3 rounded border space-y-2">
                <p class="font-medium text-indigo-900">Professional Customizer Details:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <p><strong>Garment:</strong> <span id="pro-garment"></span></p>
                  <p><strong>Location:</strong> <span id="pro-location"></span></p>
                </div>
                <div id="colors-section">
                  <strong>Colors Selected:</strong>
                  <div id="colors-container" class="flex gap-3 mt-2 flex-wrap">
                    <!-- Colors will be dynamically inserted here -->
                  </div>
                </div>
                <div id="pro-design-text-wrap" class="hidden">
                  <p><strong>Design Text:</strong> <span id="pro-design-text"></span></p>
                </div>
                <div id="pro-design-image-wrap" class="hidden">
                  <p class="mb-2"><strong>Design Images:</strong></p>
                  <div id="pro-design-image" class="grid grid-cols-2 gap-3"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <p><strong>Printing Type:</strong> <span id="pro-printing-type"></span></p>
                  <p><strong>Quantity:</strong> <span id="pro-qty"></span></p>
                </div>
                <div id="pro-team-wrap" class="hidden">
                  <p class="font-medium mt-2">Team Entries:</p>
                  <div class="overflow-x-auto">
                    <table class="min-w-full text-xs border">
                      <thead class="bg-indigo-100">
                        <tr>
                          <th class="border px-2 py-1 text-left">Name</th>
                          <th class="border px-2 py-1 text-left">#</th>
                          <th class="border px-2 py-1 text-left">Size</th>
                        </tr>
                      </thead>
                      <tbody id="pro-team-tbody" class="bg-white"></tbody>
                    </table>
                  </div>
                </div>
                <div id="pro-pricing-wrap" class="hidden">
                  <p class="font-medium mt-2">Pricing Breakdown:</p>
                  <pre id="pro-pricing-json" class="text-[11px] bg-white border rounded p-2 overflow-auto max-h-40"></pre>
                </div>
              </div>

              <!-- Team Details -->
              <div id="custom-modal-team-section" class="hidden bg-blue-50 p-3 rounded border border-blue-200 space-y-2">
                <h5 class="font-semibold text-blue-900">üë• Team Order</h5>
                <p><strong>Team Name:</strong> <span id="custom-modal-team-name"></span></p>
                <div id="custom-modal-team-members-container" class="hidden">
                  <p class="font-medium mt-2 mb-1">Team Members:</p>
                  <div class="overflow-x-auto">
                    <table class="min-w-full text-xs border">
                      <thead class="bg-blue-100">
                        <tr>
                          <th class="border px-2 py-1 text-left">Name</th>
                          <th class="border px-2 py-1 text-left">Number</th>
                          <th class="border px-2 py-1 text-left">Size</th>
                        </tr>
                      </thead>
                      <tbody id="custom-modal-team-members-tbody" class="bg-white">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Shorts Details -->
              <div id="custom-modal-shorts-section" class="hidden bg-purple-50 p-3 rounded border border-purple-200 space-y-2">
                <h5 class="font-semibold text-purple-900">ü©≥ Shorts Included</h5>
                <p><strong>Same Design as Jersey:</strong> <span id="custom-modal-shorts-same"></span></p>
                <div id="custom-modal-shorts-different-container" class="hidden mt-2">
                  <p class="text-xs text-purple-700">Different Shorts Design:</p>
                  <div id="custom-modal-shorts-details"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout Creation Details -->
        <div id="custom-modal-layout-section" class="hidden space-y-3">
          <div class="border-t pt-3">
            <h4 class="font-semibold text-gray-800 mb-2">üé® Layout Creation</h4>
            <div class="space-y-2 text-sm">
              <div id="custom-modal-inspiration-image-container">
                <strong>Inspiration Image:</strong>
                <div id="custom-modal-inspiration-image" class="mt-2"></div>
              </div>
              <p><strong>Team Name:</strong> <span id="custom-modal-layout-team"></span></p>
              <p><strong>Member Name:</strong> <span id="custom-modal-layout-member"></span></p>
              <p><strong>Jersey Number:</strong> <span id="custom-modal-layout-number"></span></p>
              <div id="custom-modal-color-palette-section">
                <strong>Color Palette:</strong>
                <div id="custom-modal-color-palette" class="flex gap-2 mt-1 flex-wrap"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Printing Only Details -->
        <div id="custom-modal-printing-section" class="hidden space-y-3">
          <div class="border-t pt-3">
            <h4 class="font-semibold text-gray-800 mb-2">üñ®Ô∏è Upload Custom Design</h4>
            <div class="space-y-2 text-sm">
              <p><strong>Printing Method:</strong> <span id="custom-modal-printing-method"></span></p>
              <p><strong>Fabric Type:</strong> <span id="custom-modal-fabric-type">N/A</span></p>
              <p><strong>Inventory:</strong> <span id="custom-modal-fabric-available">-</span> available ¬∑ <span id="custom-modal-fabric-reserved">-</span> reserved</p>
              <p><strong>Garment Type:</strong> <span id="custom-modal-garment-type">N/A</span></p>
              <p id="custom-modal-garment-size-row"><strong>Garment Size:</strong> <span id="custom-modal-garment-size"></span></p>
              <div id="custom-modal-printing-file-section" class="hidden">
                <strong>Design File:</strong>
                <div id="custom-modal-printing-file" class="mt-1"></div>
              </div>
              <div id="custom-modal-po-team-section" class="hidden bg-blue-50 p-3 rounded border border-blue-200 space-y-2">
                <div class="flex items-center justify-between">
                  <h5 class="font-semibold text-blue-900">üë• Team List</h5>
                  <a id="custom-modal-po-team-file-link" href="#" target="_blank" class="hidden text-blue-700 text-xs hover:underline">Download original file</a>
                </div>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-xs border">
                    <thead class="bg-blue-100">
                      <tr>
                        <th class="border px-2 py-1 text-left">Surname / Name</th>
                        <th class="border px-2 py-1 text-left">Number</th>
                        <th class="border px-2 py-1 text-left">Size</th>
                      </tr>
                    </thead>
                    <tbody id="custom-modal-po-team-tbody" class="bg-white"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
          </div>
          <!-- END LEFT COLUMN -->

          <!-- RIGHT COLUMN -->
          <div class="space-y-6">
        <!-- Customer Notes -->
        <div class="bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-clipboard mr-2 text-indigo-600"></i>
            Customer Notes
          </h4>
          <div id="custom-modal-notes" class="text-sm bg-white p-3 rounded-md border min-h-[50px]"></div>
        </div>

        <!-- Payment Receipts -->
        <div id="custom-modal-dp-section" class="hidden bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-receipt mr-2 text-green-600"></i>
            Down Payment Receipt
          </h4>
          <div id="custom-modal-dp-receipt" class="text-sm"></div>
        </div>
        
        <div id="custom-modal-fp-section" class="hidden bg-gray-50 p-4 rounded-lg border">
          <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-receipt mr-2 text-blue-600"></i>
            Final Payment Receipt
          </h4>
          <div id="custom-modal-fp-receipt" class="text-sm"></div>
        </div>

        <!-- Quote Form with Materials Selection -->
        <div id="custom-modal-quote-box" class="hidden bg-indigo-50 p-4 rounded-lg border border-indigo-200 space-y-4">
          <h4 class="font-semibold text-indigo-900 mb-2">üí∞ Set Quote Price</h4>
          
          <!-- Materials Selection Section -->
          <div class="bg-white p-3 rounded-lg border">
            <div class="flex items-center justify-between mb-3">
              <h5 class="text-sm font-semibold text-gray-700">
                <i class="fas fa-cubes text-purple-600 mr-2"></i>Materials Used
              </h5>
              <button type="button" id="add-material-row-btn" class="px-3 py-1 text-xs bg-purple-100 text-purple-700 border border-purple-300 rounded hover:bg-purple-200">
                <i class="fas fa-plus mr-1"></i>Add Material
              </button>
            </div>
            
            <!-- Materials Table Header -->
            <div class="grid grid-cols-12 gap-2 text-xs text-gray-500 font-semibold mb-2 px-2">
              <div class="col-span-4">Material</div>
              <div class="col-span-2">Available</div>
              <div class="col-span-2">Qty Used</div>
              <div class="col-span-2">Unit Cost</div>
              <div class="col-span-1">Subtotal</div>
              <div class="col-span-1"></div>
            </div>
            
            <!-- Materials Rows Container -->
            <div id="quote-materials-container" class="space-y-2 max-h-48 overflow-y-auto">
              <!-- Material rows will be added here dynamically -->
              <div class="text-center text-sm text-gray-400 py-3" id="no-materials-msg">
                Click "Add Material" to select materials from inventory
              </div>
            </div>
            
            <!-- Materials Subtotal -->
            <div class="border-t mt-3 pt-2 flex justify-between text-sm">
              <span class="text-gray-600 font-medium">Materials Subtotal:</span>
              <span id="quote-materials-subtotal" class="font-semibold text-purple-700">‚Ç±0.00</span>
            </div>
          </div>
          
          <!-- Labor/Service Cost -->
          <div class="bg-white p-3 rounded-lg border">
            <h5 class="text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-tools text-blue-600 mr-2"></i>Labor & Service Costs
            </h5>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600 mb-1">Printing/Production (‚Ç±)</label>
                <input id="quote-labor-printing" type="number" min="0" step="0.01" class="w-full border rounded px-3 py-2 text-sm" value="0" placeholder="0.00">
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">Design Fee (‚Ç±)</label>
                <input id="quote-labor-design" type="number" min="0" step="0.01" class="w-full border rounded px-3 py-2 text-sm" value="0" placeholder="0.00">
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">Setup/Prep Fee (‚Ç±)</label>
                <input id="quote-labor-setup" type="number" min="0" step="0.01" class="w-full border rounded px-3 py-2 text-sm" value="0" placeholder="0.00">
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">Other Charges (‚Ç±)</label>
                <input id="quote-labor-other" type="number" min="0" step="0.01" class="w-full border rounded px-3 py-2 text-sm" value="0" placeholder="0.00">
              </div>
            </div>
            <div class="border-t mt-3 pt-2 flex justify-between text-sm">
              <span class="text-gray-600 font-medium">Labor Subtotal:</span>
              <span id="quote-labor-subtotal" class="font-semibold text-blue-700">‚Ç±0.00</span>
            </div>
          </div>
          
          <!-- Total Price Summary -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Materials Cost:</span>
                <span id="quote-summary-materials" class="font-medium">‚Ç±0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Labor Cost:</span>
                <span id="quote-summary-labor" class="font-medium">‚Ç±0.00</span>
              </div>
              <div class="flex justify-between border-t pt-2">
                <span class="font-semibold text-gray-800">Total Quote Price:</span>
                <span id="quote-total-price" class="font-bold text-xl text-green-700">‚Ç±0.00</span>
              </div>
            </div>
            <input id="form-custom-price" type="hidden" value="0">
          </div>
          
          <!-- Pricing Notes -->
          <div>
            <label for="form-pricing-notes" class="block text-sm font-medium mb-1">Additional Notes for Customer</label>
            <textarea id="form-pricing-notes" rows="2" class="w-full border rounded px-3 py-2 text-sm" placeholder="Any special instructions or notes..."></textarea>
          </div>
        </div>

        <!-- Billing Summary -->
        <div id="custom-modal-info-box" class="hidden bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
          <h4 class="font-semibold text-green-900 mb-3 flex items-center">
            <i class="fas fa-file-invoice-dollar mr-2 text-green-600"></i>
            Billing Summary
          </h4>
          <div class="bg-white rounded-md border p-3 space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Subtotal:</span>
              <span id="custom-modal-subtotal" class="font-medium">‚Ç±0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Delivery Fee:</span>
              <span id="custom-modal-delivery-fee" class="font-medium">‚Ç±0.00</span>
            </div>
            <div class="flex justify-between text-green-700">
              <span>VAT (12%):</span>
              <span id="custom-modal-vat" class="font-medium">‚Ç±0.00</span>
            </div>
            <div class="border-t pt-2 flex justify-between">
              <span class="font-semibold text-gray-800">Grand Total:</span>
              <span id="custom-modal-price-display" class="font-bold text-xl text-green-700">‚Ç±0.00</span>
            </div>
            <div id="custom-modal-payment-breakdown" class="border-t pt-2 mt-2 space-y-1 hidden">
              <div class="flex justify-between text-blue-700">
                <span>50% Downpayment:</span>
                <span id="custom-modal-dp-amount" class="font-medium">‚Ç±0.00</span>
              </div>
              <div class="flex justify-between text-indigo-700">
                <span>50% Balance:</span>
                <span id="custom-modal-balance-amount" class="font-medium">‚Ç±0.00</span>
              </div>
            </div>
          </div>
          <p id="custom-modal-info-text" class="text-sm text-gray-600 mt-3 flex items-center">
            <i class="fas fa-info-circle mr-2 text-green-500"></i>
            <span>Waiting for user to accept quote.</span>
          </p>
        </div>

        <!-- Fulfillment Details Section -->
        <div id="custom-modal-fulfillment-section" class="hidden bg-gray-50 p-4 rounded-lg border space-y-3">
          <h4 class="font-semibold text-gray-800 flex items-center">
            <i class="fas fa-truck mr-2 text-purple-600"></i>
            Fulfillment Details
          </h4>
          
          <div id="custom-modal-fulfillment-info" class="text-sm bg-white p-3 rounded-md border">
            <!-- This will be populated dynamically -->
          </div>

          <!-- Admin form to add tracking/pickup details -->
          <div id="custom-modal-fulfillment-form" class="hidden space-y-3 p-3 bg-indigo-50 rounded-md border border-indigo-200">
            <p class="text-xs font-medium text-indigo-900">Add Fulfillment Details:</p>

            <!-- Select method: Delivery or Pickup -->
            <div>
              <label class="block text-sm font-medium mb-1">Fulfillment Method</label>
              <select id="fulfillment-method-select" class="w-full border rounded px-3 py-2 text-sm">
                <option value="">Select method</option>
                <option value="delivery">Delivery</option>
                <option value="pickup">Pick-Up</option>
              </select>
            </div>
            
            <!-- For Delivery -->
            <div id="fulfillment-delivery-fields" class="hidden space-y-3">
              <!-- Show delivery address -->
              <div id="fulfillment-delivery-address" class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <div class="flex items-center gap-2 mb-1">
                  <i class="fas fa-map-marker-alt text-blue-600"></i>
                  <span class="font-medium text-gray-700 text-sm">Delivery Address:</span>
                </div>
                <p id="delivery-address-text" class="text-gray-900 text-sm"></p>
              </div>
              
              <!-- Courier Selection with Auto-generate -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-truck text-gray-500 mr-1"></i> Select Courier
                </label>
                <select id="fulfillment-courier" class="w-full border rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="">-- Select Courier --</option>
                  <option value="Lalamove">üèçÔ∏è Lalamove (Same-Day)</option>
                  <option value="Grab Express">üü¢ Grab Express (Same-Day)</option>
                  <option value="J&T Express">üì¶ J&T Express (1-3 Days)</option>
                  <option value="LBC Express">üì¶ LBC Express (1-3 Days)</option>
                  <option value="Ninja Van">üì¶ Ninja Van (1-3 Days)</option>
                  <option value="Flash Express">‚ö° Flash Express (1-3 Days)</option>
                  <option value="JRS Express">üì¶ JRS Express (2-5 Days)</option>
                  <option value="2GO Express">üì¶ 2GO Express (3-5 Days)</option>
                </select>
                <p id="fulfillment-courier-recommendation" class="text-xs text-green-600 mt-1">
                  <i class="fas fa-lightbulb"></i> Recommended: J&T Express (reliable for Luzon deliveries)
                </p>
              </div>
              
              <!-- Auto-generated Tracking Number -->
              <div id="fulfillment-tracking-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-barcode text-gray-500 mr-1"></i> Tracking Number
                </label>
                <div class="relative">
                  <input id="fulfillment-tracking" type="text" readonly
                    class="w-full border rounded-lg px-3 py-2.5 text-sm font-mono bg-gray-50 pr-28">
                  <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-green-600 font-medium">
                    <i class="fas fa-check-circle"></i> Auto-generated
                  </span>
                </div>
              </div>
              
              <!-- Tracking URL -->
              <div id="fulfillment-url-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-link text-gray-500 mr-1"></i> Tracking URL
                </label>
                <div class="flex items-center gap-2">
                  <input id="fulfillment-tracking-url" type="text" readonly
                    class="flex-1 border rounded-lg px-3 py-2 text-xs font-mono bg-gray-50 text-gray-600 truncate">
                  <button id="fulfillment-copy-url" type="button"
                    class="px-3 py-2 bg-gray-100 hover:bg-gray-200 border rounded-lg text-sm transition-colors" title="Copy URL">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Customer can use this link to track their order</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-calendar-alt text-gray-500 mr-1"></i> Estimated Delivery Date
                </label>
                <input id="fulfillment-delivery-date" type="date" class="w-full border rounded-lg px-3 py-2 text-sm">
              </div>
            </div>

            <!-- For Pickup -->
            <div id="fulfillment-pickup-fields" class="hidden space-y-2">
              <div>
                <label class="block text-sm font-medium mb-1">Pickup Date</label>
                <input id="fulfillment-pickup-date" type="date" class="w-full border rounded px-3 py-2 text-sm">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Pickup Location</label>
                <input id="fulfillment-pickup-location" type="text" class="w-full border rounded px-3 py-2 text-sm" value="Fundamental Store - 123 Main St, Manila">
              </div>
            </div>

            <button id="custom-modal-save-fulfillment" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded text-sm w-full">
              <i class="fas fa-paper-plane mr-2"></i>Submit Tracking Details
            </button>
          </div>
        </div>
          </div>
          <!-- END RIGHT COLUMN -->
        </div>
        <!-- END TWO COLUMN GRID -->
      </div>
      
      <!-- Modal Footer -->
      <div class="px-6 py-4 border-t bg-gray-50 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <button id="custom-modal-archive" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded text-sm" title="Archive Order">
            <i class="fas fa-archive mr-1"></i>Archive
          </button>
          <button id="custom-modal-delete" class="hidden bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded text-sm" title="Delete Order">
            <i class="fas fa-trash-alt mr-1"></i>Delete
          </button>
          <p id="custom-modal-error" class="text-sm text-red-600 ml-2"></p>
        </div>
        <div class="flex items-center gap-2"> 
          <button id="custom-modal-save-quote" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-paper-plane mr-2"></i>Send Quote
          </button>
          <button id="custom-modal-verify-dp" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-check-circle mr-2"></i>Verify DP
          </button>
          <button id="custom-modal-request-final" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-money-bill-wave mr-2"></i>Request Final Payment
          </button>
          <button id="custom-modal-verify-final" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2.5 rounded-lg transition">
            <i class="fas fa-check-circle mr-2"></i>Verify Final Payment &amp; Start Production
          </button>
        </div>
      </div>
  </div>

  <!-- Payment Receipt Modal for Custom Orders -->
  <div id="custom-payment-receipt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div id="custom-payment-receipt-dialog" class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b flex-shrink-0">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <i class="fas fa-receipt text-green-600"></i>Payment Receipt
        </h3>
        <div class="flex items-center gap-2">
          <button id="custom-receipt-print-btn" onclick="window.print()" title="Print receipt" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 border rounded hover:bg-gray-50"><i class="fas fa-print mr-1"></i>Print</button>
          <button id="custom-receipt-download-btn" title="Download receipt" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 border rounded hover:bg-gray-50"><i class="fas fa-download mr-1"></i>PDF</button>
          <button onclick="closeCustomPaymentModal()" class="text-gray-400 hover:text-gray-600 ml-2">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div id="custom-payment-receipt-content" class="p-6 overflow-y-auto flex-1">
        <!-- Receipt content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Payment Details Modal removed: payment info now shown directly in Order Details modal -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="../js/receipt-builder.js"></script>
  <script>
    const API = 'https://fundamental-apparel-backend.onrender.com'; // O ang ngrok URL mo

    function peso(n) { return '‚Ç±' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function shortId(id) { return id ? id.slice(0, 8) : '-'; }
    
    // Populate billing summary for custom orders (matches PayMongo VAT calculation)
    function populateBillingSummary(order, els) {
      const price = Number(order.price) || 0;
      const deliveryFee = Number(order.deliveryFee) || 0;
      
      // VAT is calculated on subtotal (excluding delivery) at 12%
      const subtotal = price; // Quote price is the subtotal
      const vat = subtotal * 0.12;
      const grandTotal = subtotal + deliveryFee + vat;
      
      // 50% downpayment and balance (VAT proportionally split)
      const dpSubtotal = subtotal * 0.5;
      const dpVat = dpSubtotal * 0.12;
      const dpAmount = dpSubtotal + dpVat;
      
      const balanceSubtotal = subtotal * 0.5;
      const balanceVat = balanceSubtotal * 0.12;
      const balanceAmount = balanceSubtotal + balanceVat;
      
      // Populate elements
      if (els.customModalSubtotal) els.customModalSubtotal.textContent = peso(subtotal);
      if (els.customModalDeliveryFee) els.customModalDeliveryFee.textContent = peso(deliveryFee);
      if (els.customModalVat) els.customModalVat.textContent = peso(vat);
      if (els.customModalPriceDisplay) els.customModalPriceDisplay.textContent = peso(grandTotal);
      if (els.customModalDpAmount) els.customModalDpAmount.textContent = peso(dpAmount);
      if (els.customModalBalanceAmount) els.customModalBalanceAmount.textContent = peso(balanceAmount);
      
      // Show payment breakdown if order has a valid price
      if (els.customModalPaymentBreakdown && price > 0) {
        els.customModalPaymentBreakdown.classList.remove('hidden');
      }
    }
    
    // Normalize fabric+garment into an inventory key: e.g. "Dry Fit" + "jersey" -> "Dry-Fit - Jersey"
    function normalizeInventoryKey(fabric, garment) {
      const safe = (s) => (s || '').toString().trim();
      const cap = (str) => String(str).toLowerCase().replace(/[-_\s]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      const fabricRaw = safe(fabric);
      const garmentRaw = safe(garment);
      if (!fabricRaw && !garmentRaw) return '';
      // Fabric: replace multiple spaces with single, split into words, strip non-alphanum except hyphen, capitalize and join with hyphen
      const fabricParts = fabricRaw.split(/\s+/).map(p => p.trim()).filter(Boolean);
      const fabricNorm = fabricParts.map(p => p.replace(/[^a-zA-Z0-9-]/g,'')).map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('-');
      // Garment: capitalize words and collapse spaces
      const garmentNorm = cap(garmentRaw).replace(/\s+/g, ' ');
      if (fabricNorm && garmentNorm) return `${fabricNorm} - ${garmentNorm}`;
      return fabricNorm || garmentNorm || '';
    }

    // message helper (replaces alert())
    const messageEl = document.getElementById('message-container');
    function showMessage(text, type = 'success') {
      if (!messageEl) return;
      messageEl.textContent = text;
      messageEl.className = `mb-4 p-3 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      messageEl.classList.remove('hidden');
      window.scrollTo(0, 0);
      setTimeout(() => messageEl.classList.add('hidden'), 4000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken');
      if (!token) { window.location.href = 'login.html'; return; }

      // Notifications setup (support legacy IDs and centralized admin-notifications.js)
      const notifBtn = document.getElementById('notif-btn') || document.getElementById('admin-notif-btn');
      const notifCountEl = document.getElementById('notif-count') || document.getElementById('admin-notif-badge');
      const notifDropdown = document.getElementById('notif-dropdown') || document.getElementById('admin-notif-dropdown');
      const notifList = document.getElementById('notif-list') || document.getElementById('admin-notif-list');
      const notifMarkAll = document.getElementById('notif-markall') || document.getElementById('admin-notif-markall');

      // Connect socket.io with auth token
      let socket = null;
      try {
        // Prefer websocket transport to avoid XHR polling errors in environments
        // where polling requests are blocked or misconfigured (400 responses).
        socket = io(API, { auth: { token }, transports: ['websocket'] });
        socket.on('connect', () => console.log('Socket connected'));
        socket.on('connect_error', (err) => console.warn('Socket connect_error', err && err.message));
        socket.on('notification', (n) => {
          // Prepend notification
          prependNotif(n);
        });
      } catch (e) { console.warn('Socket init failed', e && e.message); }

      async function loadNotifications() {
        try {
          const res = await fetch(`${API}/api/admin/notifications`, { headers: { 'Authorization': `Bearer ${token}` } });
          const j = await res.json();
          if (!res.ok || !j.success) throw new Error(j.msg || 'Failed to load');
          await renderNotifs(j.data || []);
        } catch (e) { console.warn('Failed to load notifications', e.message); }
      }

      async function renderNotifs(arr) {
        if (!notifList) return; // nothing to render to
        notifList.innerHTML = '';
        let unread = 0;
        (arr || []).forEach(n => {
          const el = document.createElement('div');
          el.className = 'p-2 border-b text-sm';
          if (!n.read) { el.className += ' bg-gray-50'; unread++; }
          const orderId = n.meta && n.meta.orderId ? n.meta.orderId : '';
          el.setAttribute('data-orderid', orderId);
          el.innerHTML = `<div class="font-medium">${n.title}</div><div class="text-xs text-gray-600">${n.body || ''}</div><div class="text-xs text-gray-400 mt-1">${new Date(n.createdAt).toLocaleString()}</div><div class="mt-2 text-right"><button data-id="${n._id}" class="mark-read text-xs text-indigo-600">Mark read</button></div>`;
          // clicking the notification opens the order modal if orderId present
          if (orderId) {
            el.style.cursor = 'pointer';
            el.addEventListener('click', (ev) => {
              // avoid click when pressing Mark read button
              if (ev.target && ev.target.classList && ev.target.classList.contains('mark-read')) return;
              const ord = allOrders.find(o => o._id === orderId);
              if (ord) {
                openModal(ord);
                notifDropdown.classList.add('hidden');
              } else {
                // try to lazy-load order details and open
                fetch(`${API}/api/orders/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(j => {
                  if (j && j.success) openModal(j.data);
                }).catch(() => {});
              }
            });
          }
          notifList.appendChild(el);
        });
        if (unread > 0) { notifCountEl.textContent = unread; notifCountEl.classList.remove('hidden'); } else { notifCountEl.classList.add('hidden'); }
        // Bind mark-read buttons
        Array.from(document.getElementsByClassName('mark-read')).forEach(b => b.addEventListener('click', async (ev) => {
          const id = ev.target.dataset.id;
          try {
            const r = await fetch(`${API}/api/admin/notifications/${id}/read`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } });
            const j = await r.json();
            if (!r.ok || !j.success) throw new Error(j.msg || 'Failed');
            await loadNotifications();
          } catch (e) { console.warn(e.message); }
        }));
      }

      function prependNotif(n) {
        if (!notifList || !notifCountEl) return;
        // simple prepend and update count
        const el = document.createElement('div');
        el.className = 'p-2 border-b bg-gray-50 text-sm';
        const orderId = n.meta && n.meta.orderId ? n.meta.orderId : '';
        el.setAttribute('data-orderid', orderId);
        el.innerHTML = `<div class="font-medium">${n.title}</div><div class="text-xs text-gray-600">${n.body || ''}</div><div class="text-xs text-gray-400 mt-1">${new Date(n.createdAt).toLocaleString()}</div><div class="mt-2 text-right"><button data-id="${n._id}" class="mark-read text-xs text-indigo-600">Mark read</button></div>`;
        if (orderId) {
          el.style.cursor = 'pointer';
          el.addEventListener('click', (ev) => {
            if (ev.target && ev.target.classList && ev.target.classList.contains('mark-read')) return;
            const ord = allOrders.find(o => o._id === orderId);
            if (ord) openModal(ord);
            else fetch(`${API}/api/orders/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()).then(j => { if (j && j.success) openModal(j.data); }).catch(() => {});
          });
        }
        notifList.insertBefore(el, notifList.firstChild);
        const current = parseInt(notifCountEl.textContent || '0', 10) || 0;
        notifCountEl.textContent = current + 1; notifCountEl.classList.remove('hidden');
      }

      // Attach notification handlers if elements are present, or wait for them to appear
      (function attachNotifIfReady(){
        function bind(){
          if (!notifBtn) return false;
          if (notifDropdown) {
            notifBtn.addEventListener('click', async () => {
              notifDropdown.classList.toggle('hidden');
              if (!notifDropdown.classList.contains('hidden')) {
                await loadNotifications();
              }
            });
          }
          if (notifMarkAll) {
            notifMarkAll.addEventListener('click', async () => {
              try {
                const r = await fetch(`${API}/api/admin/notifications/mark-all-read`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const j = await r.json();
                if (!r.ok || !j.success) throw new Error(j.msg || 'Failed');
                await loadNotifications();
              } catch (e) { console.warn(e.message); }
            });
          }
          return true;
        }

        if (!bind()) {
          // observe briefly for presence
          const target = document.body;
          const mo = new MutationObserver((mutations, obs) => { if (bind()) { obs.disconnect(); } });
          mo.observe(target, { childList: true, subtree: true });
          setTimeout(()=>mo.disconnect(), 8000);
        }
      })();

      // Global error handler to surface JS errors on page for debugging
      window.addEventListener('error', function (evt) {
        try {
          const banner = document.getElementById('dev-error-banner');
          if (banner) {
            banner.textContent = `JS Error: ${evt.message} at ${evt.filename}:${evt.lineno}`;
            banner.classList.remove('hidden');
          }
        } catch (e) { /* ignore */ }
      });

      (function attachLogoutHandler(){
        function bind(el){
          el.addEventListener('click', ()=>{
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
          });
        }
        const el = document.getElementById('logout-btn');
        if (el) { bind(el); return; }
        // If logout not present yet, observe the header for it (short-lived)
        const hdr = document.querySelector('header') || document.body;
        const mo = new MutationObserver((mutations, obs)=>{
          const later = document.getElementById('logout-btn');
          if (later) { bind(later); obs.disconnect(); }
        });
        mo.observe(hdr, { childList: true, subtree: true });
        // safety: stop observing after 8s
        setTimeout(()=>mo.disconnect(), 8000);
      })();

      const els = {
        // Regular Order selectors
        tbody: document.getElementById('orders-body'),
        count: document.getElementById('count'),
        search: document.getElementById('search'),
        filterStatus: document.getElementById('filter-status'),
        filterPayment: document.getElementById('filter-payment'),
        filterShipping: document.getElementById('filter-shipping'),
        dateFrom: document.getElementById('date-from'),
        dateTo: document.getElementById('date-to'),
        filterReset: document.getElementById('filter-reset'),
        refreshOrdersBtn: document.getElementById('refresh-orders'),
        autoRefreshOrders: document.getElementById('auto-refresh-orders'),
        modal: document.getElementById('modal'),
        modalClose: document.getElementById('modal-close'),
        modalItems: document.getElementById('modal-items'),
        modalSubtotal: document.getElementById('modal-subtotal'),
        modalDelivery: document.getElementById('modal-delivery'),
        modalTotal: document.getElementById('modal-total'),
        modalPaymentMethod: document.getElementById('modal-paymentMethod'),
        modalShippingMethod: document.getElementById('modal-shippingMethod'),
        modalPaymentStatus: document.getElementById('modal-paymentStatus'),
        modalPaymentRef: document.getElementById('modal-paymentRef'),
        modalReceiptBtn: document.getElementById('modal-receipt-btn'),
        modalDownloadReceipt: document.getElementById('modal-download-receipt'),
        receiptWrap: document.getElementById('receipt-wrap'),
        // Note: Individual receipt elements removed - content now generated by buildReceiptHtml()
        modalAddress: document.getElementById('modal-address'),
        formPaymentStatus: document.getElementById('form-paymentStatus'),
        // Order status, shipping service, tracking code removed - handled by workflow/Ship Modal
        modalSave: document.getElementById('modal-save'),
        modalArchive: document.getElementById('modal-archive'),
        modalDelete: document.getElementById('modal-delete'),
        modalError: document.getElementById('modal-error'),
        modalCancellationDetails: document.getElementById('modal-cancellation-details'),
        modalCancelledBy: document.getElementById('modal-cancelled-by'),
        modalCancellationReason: document.getElementById('modal-cancellation-reason'),
        modalAdminCancelReasonBox: document.getElementById('modal-admin-cancel-reason-box'),
        formCancellationReason: document.getElementById('form-cancellationReason'),

        // Ship Modal Selectors
        shipModal: document.getElementById('ship-modal'),
        shipModalClose: document.getElementById('ship-modal-close'),
        shipModalOrderId: document.getElementById('ship-modal-order-id'),
        shipModalCustomer: document.getElementById('ship-modal-customer'),
        shipModalAddress: document.getElementById('ship-modal-address'),
        shipModalDistance: document.getElementById('ship-modal-distance'),
        shipModalCourier: document.getElementById('ship-modal-courier'),
        shipModalCourierRecommendation: document.getElementById('ship-modal-courier-recommendation'),
        shipModalTrackingSection: document.getElementById('ship-modal-tracking-section'),
        shipModalTracking: document.getElementById('ship-modal-tracking'),
        shipModalUrlSection: document.getElementById('ship-modal-url-section'),
        shipModalTrackingUrl: document.getElementById('ship-modal-tracking-url'),
        shipModalCopyUrl: document.getElementById('ship-modal-copy-url'),
        shipModalError: document.getElementById('ship-modal-error'),
        shipModalCancel: document.getElementById('ship-modal-cancel'),
        shipModalConfirm: document.getElementById('ship-modal-confirm'),

        // Tab Selectors
        tabsContainer: document.getElementById('tabs-container'),
        tabContentRegular: document.getElementById('tab-content-regular'),
        tabContentCustom: document.getElementById('tab-content-custom'),
        ordersCards: document.getElementById('orders-cards'),

       
        // Custom Order Selectors
        customOrdersBody: document.getElementById('custom-orders-body'),
        customCount: document.getElementById('custom-count'),
        customSearch: document.getElementById('custom-search'),
        customFilterStatus: document.getElementById('custom-filter-status'),
        customFilterType: document.getElementById('custom-filter-type'),
        customFilterShipMethod: document.getElementById('custom-filter-shipmethod'),
        customFilterFulfillment: document.getElementById('custom-filter-fulfillment'),
        customFilterPayment: document.getElementById('custom-filter-payment'),
        customFilterCourier: document.getElementById('custom-filter-courier'),
        customFilterTracking: document.getElementById('custom-filter-tracking'),
        customDateFrom: document.getElementById('custom-date-from'),
        customDateTo: document.getElementById('custom-date-to'),
        customFilterReset: document.getElementById('custom-filter-reset'),
        refreshCustomBtn: document.getElementById('refresh-custom'),
        autoRefreshCustom: document.getElementById('auto-refresh-custom'),
        customModal: document.getElementById('custom-order-modal'),
        customModalClose: document.getElementById('custom-modal-close'),
        customModalError: document.getElementById('custom-modal-error'),
        customModalUser: document.getElementById('custom-modal-user'),
        customModalQty: document.getElementById('custom-modal-qty'),
        customModalType: document.getElementById('custom-modal-type'),
        customModalDetails: document.getElementById('custom-modal-details'),
        customModalNotes: document.getElementById('custom-modal-notes'),
        customModalDpSection: document.getElementById('custom-modal-dp-section'),
        customModalDpReceipt: document.getElementById('custom-modal-dp-receipt'),
        customModalFpSection: document.getElementById('custom-modal-fp-section'),
        customModalFpReceipt: document.getElementById('custom-modal-fp-receipt'),
        customModalQuoteBox: document.getElementById('custom-modal-quote-box'),
        formCustomPrice: document.getElementById('form-custom-price'),
        customModalInfoBox: document.getElementById('custom-modal-info-box'),
        customModalInfoText: document.getElementById('custom-modal-info-text'),
        customModalPriceDisplay: document.getElementById('custom-modal-price-display'),
        customModalSubtotal: document.getElementById('custom-modal-subtotal'),
        customModalDeliveryFee: document.getElementById('custom-modal-delivery-fee'),
        customModalVat: document.getElementById('custom-modal-vat'),
        customModalDpAmount: document.getElementById('custom-modal-dp-amount'),
        customModalBalanceAmount: document.getElementById('custom-modal-balance-amount'),
        customModalPaymentBreakdown: document.getElementById('custom-modal-payment-breakdown'),
        customModalSaveQuote: document.getElementById('custom-modal-save-quote'),
        customModalVerifyDp: document.getElementById('custom-modal-verify-dp'),
        customModalRequestFinal: document.getElementById('custom-modal-request-final'),
        customModalVerifyFinal: document.getElementById('custom-modal-verify-final'),
        customModalArchive: document.getElementById('custom-modal-archive'),
        customModalDelete: document.getElementById('custom-modal-delete'),
        formPricingNotes: document.getElementById('form-pricing-notes')
      };

      // Helper: generate a clean PDF from an element by cloning and stripping UI controls
      async function generatePdfFromElement(element, filename) {
        if (!element) throw new Error('No element provided for PDF generation');
        // Ensure html2pdf is loaded
        const ensureHtml2pdf = () => new Promise((resolve, reject) => {
          if (window.html2pdf) return resolve(window.html2pdf);
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js';
          s.onload = () => resolve(window.html2pdf);
          s.onerror = () => reject(new Error('Failed to load html2pdf')); document.body.appendChild(s);
        });

        // Clone and sanitize: remove interactive controls with class 'no-print'
        const clone = element.cloneNode(true);
        clone.style.boxSizing = 'border-box';
        clone.querySelectorAll && clone.querySelectorAll('.no-print').forEach(n => n.remove());
        // Put clone in a hidden container to ensure styles apply
        const container = document.createElement('div');
        container.style.position = 'fixed'; container.style.left = '-9999px'; container.style.top = '0';
        container.style.width = '800px'; // target PDF width for A4-ish
        container.appendChild(clone);
        document.body.appendChild(container);

        try {
          await ensureHtml2pdf();
          const opt = {
            margin: 8,
            filename: filename || 'receipt.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: Math.min(2, (window.devicePixelRatio || 1) * 1.2) },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['css', 'legacy'] }
          };
          await window.html2pdf().set(opt).from(clone).save();
        } finally {
          container.remove();
        }
      }

      let allOrders = [];
      let allCustomOrders = [];
      let selectedOrder = null; // Para sa regular order
      let selectedCustomOrder = null; // Para sa custom order
      let shipOrderTarget = null; // Order being shipped via Ship Modal
      // Payment modal removed; payment info is shown directly in Order Details modal

      // =====================================================
      // SHIP ORDER MODAL - Auto-generate Tracking Numbers
      // =====================================================
      
      // Tracking number formats for each courier (simulated/mock)
      const courierTrackingFormats = {
        'Lalamove': { prefix: 'LLM', digits: 8, url: (code) => null }, // Lalamove has no public tracking
        'Grab Express': { prefix: 'GRB', digits: 8, url: (code) => null }, // Grab has no public tracking
        'J&T Express': { prefix: '820', digits: 9, url: (code) => `https://www.jtexpress.ph/trajectoryQuery?billcode=${code}` },
        'LBC Express': { prefix: 'LBC', digits: 10, url: (code) => `https://www.lbcexpress.com/track?tracking_no=${code}` },
        'Ninja Van': { prefix: 'NV', digits: 12, url: (code) => `https://www.ninjavan.co/en-ph/tracking?id=${code}` },
        'Flash Express': { prefix: 'FL', digits: 10, url: (code) => `https://www.flashexpress.com/tracking/?se=${code}` },
        'JRS Express': { prefix: 'JRS', digits: 9, url: (code) => `https://www.jrs-express.com/track?code=${code}` },
        '2GO Express': { prefix: '2GO', digits: 9, url: (code) => `https://www.2go.com.ph/track/${code}` },
      };

      // Generate a mock tracking number for a given courier
      function generateTrackingNumber(courier) {
        const format = courierTrackingFormats[courier];
        if (!format) return '';
        const digits = Array.from({ length: format.digits }, () => Math.floor(Math.random() * 10)).join('');
        return format.prefix + digits;
      }

      // Generate tracking URL for a courier and tracking code
      function generateTrackingUrl(courier, trackingCode) {
        const format = courierTrackingFormats[courier];
        if (!format || !format.url) return null;
        return format.url(trackingCode);
      }

      // Recommend courier based on shipping method and distance (if available)
      function recommendCourier(order) {
        // If Pick-Up, no courier needed
        if (order.shippingMethod === 'Pick-Up') return null;
        
        // For Standard shipping, recommend based on distance or default to J&T
        // In the future, can integrate distance from shipping calculator
        // For now, default recommendation is J&T Express for reliability
        return 'J&T Express';
      }

      // Open Ship Order Modal
      function openShipModal(order) {
        shipOrderTarget = order;
        
        // Reset modal state
        els.shipModalCourier.value = '';
        els.shipModalTracking.value = '';
        els.shipModalTrackingUrl.value = '';
        els.shipModalTrackingSection.classList.add('hidden');
        els.shipModalUrlSection.classList.add('hidden');
        els.shipModalError.classList.add('hidden');
        els.shipModalConfirm.disabled = true;
        
        // Populate order info
        els.shipModalOrderId.textContent = order._id.slice(-8).toUpperCase();
        els.shipModalCustomer.textContent = order.user?.name || order.user?.email || 'Customer';
        
        // Populate address
        const addr = order.shippingAddress || {};
        els.shipModalAddress.innerHTML = `
          <div>${[addr.block, addr.lot].filter(Boolean).join(' ')} ${addr.street || ''}</div>
          <div>${addr.building || ''}</div>
          <div class="font-medium">${addr.city || ''}, ${addr.province || ''} ${addr.zip || ''}</div>
          <div class="text-gray-500">${addr.phone || ''}</div>
        `;
        
        // Show courier recommendation
        const recommended = recommendCourier(order);
        if (recommended) {
          els.shipModalCourierRecommendation.querySelector('span').textContent = `Recommended: ${recommended} (reliable for Luzon deliveries)`;
          els.shipModalCourierRecommendation.classList.remove('hidden');
        } else {
          els.shipModalCourierRecommendation.classList.add('hidden');
        }
        
        // Show modal
        els.shipModal.classList.remove('hidden');
        els.shipModal.classList.add('flex');
      }

      // Close Ship Order Modal
      function closeShipModal() {
        els.shipModal.classList.add('hidden');
        els.shipModal.classList.remove('flex');
        shipOrderTarget = null;
      }

      // Handle courier selection - auto-generate tracking number
      function onCourierSelect() {
        const courier = els.shipModalCourier.value;
        
        if (!courier) {
          els.shipModalTrackingSection.classList.add('hidden');
          els.shipModalUrlSection.classList.add('hidden');
          els.shipModalConfirm.disabled = true;
          return;
        }
        
        // Auto-generate tracking number
        const trackingNumber = generateTrackingNumber(courier);
        els.shipModalTracking.value = trackingNumber;
        els.shipModalTrackingSection.classList.remove('hidden');
        
        // Auto-generate tracking URL
        const trackingUrl = generateTrackingUrl(courier, trackingNumber);
        if (trackingUrl) {
          els.shipModalTrackingUrl.value = trackingUrl;
          els.shipModalUrlSection.classList.remove('hidden');
        } else {
          els.shipModalTrackingUrl.value = '';
          els.shipModalUrlSection.classList.add('hidden');
        }
        
        // Enable confirm button
        els.shipModalConfirm.disabled = false;
      }

      // Copy tracking URL to clipboard
      function copyTrackingUrl() {
        const url = els.shipModalTrackingUrl.value;
        if (!url) return;
        
        navigator.clipboard.writeText(url).then(() => {
          const btn = els.shipModalCopyUrl;
          const originalHtml = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check text-green-600"></i>';
          btn.classList.add('bg-green-100');
          setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('bg-green-100');
          }, 2000);
        }).catch(() => {
          alert('Failed to copy. Please copy manually: ' + url);
        });
      }

      // Confirm shipment - update order status to Shipped with courier and tracking info
      async function confirmShipment() {
        if (!shipOrderTarget) return;
        
        const courier = els.shipModalCourier.value;
        const trackingNumber = els.shipModalTracking.value;
        const trackingUrl = els.shipModalTrackingUrl.value;
        
        if (!courier || !trackingNumber) {
          els.shipModalError.textContent = 'Please select a courier to generate tracking number.';
          els.shipModalError.classList.remove('hidden');
          return;
        }
        
        els.shipModalConfirm.disabled = true;
        els.shipModalConfirm.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        els.shipModalError.classList.add('hidden');
        
        try {
          const body = {
            status: 'Shipped',
            shippingService: courier,
            trackingCode: trackingNumber,
            trackingUrl: trackingUrl || ''
          };
          
          const res = await fetch(`${API}/api/orders/${shipOrderTarget._id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(body)
          });
          
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to ship order');
          
          // Update local orders array
          const idx = allOrders.findIndex(o => o._id === shipOrderTarget._id);
          if (idx >= 0) allOrders[idx] = data.data;
          
          renderRegularOrders();
          closeShipModal();
          showMessage(`Order shipped successfully! Tracking: ${trackingNumber}`, 'success');
          
        } catch (err) {
          els.shipModalError.textContent = err.message;
          els.shipModalError.classList.remove('hidden');
          els.shipModalConfirm.disabled = false;
          els.shipModalConfirm.innerHTML = '<i class="fas fa-check"></i> Confirm Shipment';
        }
      }

      // Payment Info modal removed; no modal helpers needed

      // =====================================================
      // MATERIALS SELECTION FOR QUOTE (Inventory-based)
      // =====================================================
      let availableMaterials = []; // Will be fetched from inventory
      let quoteMaterialsSelected = []; // Array of { inventoryId, name, qtyUsed, unitCost, available, unit }
      
      // Fetch materials from inventory
      async function loadAvailableMaterials() {
        try {
          const res = await fetch(`${API}/api/admin/inventory?type=material`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Failed to load materials');
          const data = await res.json();
          availableMaterials = (data.data || data || []).filter(m => m.type === 'material');
        } catch (e) {
          console.error('Failed to load materials:', e);
          availableMaterials = [];
        }
      }
      
      // Create a material row in the quote form
      function createMaterialRow(material = null) {
        const container = document.getElementById('quote-materials-container');
        const noMsgEl = document.getElementById('no-materials-msg');
        if (noMsgEl) noMsgEl.remove();
        
        const rowId = `mat-row-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border';
        row.id = rowId;
        
        // Build material options
        let options = '<option value="">Select Material</option>';
        availableMaterials.forEach(m => {
          const displayName = m.name;
          const avail = m.quantity || 0;
          const unit = m.unit || 'pcs';
          const price = m.price || 0;
          const disabled = avail <= 0 ? 'disabled' : '';
          const stockLabel = avail <= 0 ? ' (Out of Stock)' : '';
          options += `<option value="${m._id}" data-avail="${avail}" data-unit="${unit}" data-price="${price}" ${disabled}>${displayName}${stockLabel}</option>`;
        });
        
        row.innerHTML = `
          <div class="col-span-4">
            <select class="material-select w-full px-2 py-1 border rounded text-xs" data-row="${rowId}">
              ${options}
            </select>
          </div>
          <div class="col-span-2">
            <span class="material-available text-xs text-gray-500">-</span>
          </div>
          <div class="col-span-2">
            <input type="number" min="0" class="material-qty w-full px-2 py-1 border rounded text-xs" value="0" data-row="${rowId}">
          </div>
          <div class="col-span-2">
            <span class="material-unit-cost text-xs text-gray-600">‚Ç±0.00</span>
          </div>
          <div class="col-span-1">
            <span class="material-subtotal text-xs font-medium text-purple-700">‚Ç±0.00</span>
          </div>
          <div class="col-span-1">
            <button type="button" class="remove-material-row text-red-500 hover:text-red-700 text-xs" data-row="${rowId}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        container.appendChild(row);
        
        // Event handlers
        const selectEl = row.querySelector('.material-select');
        const qtyEl = row.querySelector('.material-qty');
        const availEl = row.querySelector('.material-available');
        const unitCostEl = row.querySelector('.material-unit-cost');
        const subtotalEl = row.querySelector('.material-subtotal');
        const removeBtn = row.querySelector('.remove-material-row');
        
        selectEl.addEventListener('change', () => {
          const opt = selectEl.options[selectEl.selectedIndex];
          const avail = Number(opt?.dataset?.avail || 0);
          const unit = opt?.dataset?.unit || 'pcs';
          const price = Number(opt?.dataset?.price || 0);
          
          availEl.textContent = avail > 0 ? `${avail} ${unit}` : '-';
          unitCostEl.textContent = `‚Ç±${price.toFixed(2)}`;
          qtyEl.max = avail;
          qtyEl.value = 0;
          subtotalEl.textContent = '‚Ç±0.00';
          recalculateQuoteTotals();
        });
        
        qtyEl.addEventListener('input', () => {
          const opt = selectEl.options[selectEl.selectedIndex];
          const avail = Number(opt?.dataset?.avail || 0);
          const price = Number(opt?.dataset?.price || 0);
          let qty = Number(qtyEl.value) || 0;
          
          // Validate: cannot exceed available
          if (qty > avail) {
            qty = avail;
            qtyEl.value = avail;
            showQuoteMessage(`Cannot exceed available stock (${avail})`, 'warning');
          }
          
          const subtotal = qty * price;
          subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
          recalculateQuoteTotals();
        });
        
        removeBtn.addEventListener('click', () => {
          row.remove();
          recalculateQuoteTotals();
          // If no rows left, show "no materials" message
          if (container.children.length === 0) {
            container.innerHTML = '<div class="text-center text-sm text-gray-400 py-3" id="no-materials-msg">Click "Add Material" to select materials from inventory</div>';
          }
        });
        
        if (material) {
          selectEl.value = material.inventoryId || '';
          selectEl.dispatchEvent(new Event('change'));
          qtyEl.value = material.qtyUsed || 0;
          qtyEl.dispatchEvent(new Event('input'));
        }
        
        return row;
      }
      
      // Recalculate all quote totals
      function recalculateQuoteTotals() {
        let materialsTotal = 0;
        const container = document.getElementById('quote-materials-container');
        const rows = container.querySelectorAll('[id^="mat-row-"]');
        
        rows.forEach(row => {
          const selectEl = row.querySelector('.material-select');
          const qtyEl = row.querySelector('.material-qty');
          const opt = selectEl?.options[selectEl.selectedIndex];
          const price = Number(opt?.dataset?.price || 0);
          const qty = Number(qtyEl?.value || 0);
          materialsTotal += price * qty;
        });
        
        // Labor costs
        const laborPrinting = Number(document.getElementById('quote-labor-printing')?.value || 0);
        const laborDesign = Number(document.getElementById('quote-labor-design')?.value || 0);
        const laborSetup = Number(document.getElementById('quote-labor-setup')?.value || 0);
        const laborOther = Number(document.getElementById('quote-labor-other')?.value || 0);
        const laborTotal = laborPrinting + laborDesign + laborSetup + laborOther;
        
        const grandTotal = materialsTotal + laborTotal;
        
        // Update displays
        document.getElementById('quote-materials-subtotal').textContent = `‚Ç±${materialsTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
        document.getElementById('quote-labor-subtotal').textContent = `‚Ç±${laborTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
        document.getElementById('quote-summary-materials').textContent = `‚Ç±${materialsTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
        document.getElementById('quote-summary-labor').textContent = `‚Ç±${laborTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
        document.getElementById('quote-total-price').textContent = `‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
        
        // Update hidden form field
        document.getElementById('form-custom-price').value = grandTotal;
        
        return { materialsTotal, laborTotal, grandTotal };
      }
      
      // Collect materials data for submission
      function collectMaterialsData() {
        const materials = [];
        const container = document.getElementById('quote-materials-container');
        const rows = container.querySelectorAll('[id^="mat-row-"]');
        
        rows.forEach(row => {
          const selectEl = row.querySelector('.material-select');
          const qtyEl = row.querySelector('.material-qty');
          const opt = selectEl?.options[selectEl.selectedIndex];
          
          if (selectEl.value && Number(qtyEl.value) > 0) {
            materials.push({
              inventoryId: selectEl.value,
              name: opt?.textContent?.replace(' (Out of Stock)', '') || 'Unknown',
              qtyUsed: Number(qtyEl.value),
              unitCost: Number(opt?.dataset?.price || 0),
              unit: opt?.dataset?.unit || 'pcs'
            });
          }
        });
        
        return materials;
      }
      
      // Show inline quote message
      function showQuoteMessage(msg, type = 'info') {
        // Could add a small toast or inline message; for now use console
        console.warn(`Quote: ${msg}`);
      }
      
      // Initialize materials selection when quote box is shown
      async function initMaterialsSelection() {
        await loadAvailableMaterials();
        
        // Reset materials container
        const container = document.getElementById('quote-materials-container');
        if (container) {
          container.innerHTML = '<div class="text-center text-sm text-gray-400 py-3" id="no-materials-msg">Click "Add Material" to select materials from inventory</div>';
        }
        
        // Reset labor fields
        ['quote-labor-printing', 'quote-labor-design', 'quote-labor-setup', 'quote-labor-other'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = 0;
        });
        
        // Reset totals
        recalculateQuoteTotals();
      }
      
      // Add material row button handler
      document.getElementById('add-material-row-btn')?.addEventListener('click', async () => {
        if (availableMaterials.length === 0) {
          await loadAvailableMaterials();
        }
        if (availableMaterials.length === 0) {
          alert('No materials found in inventory. Please add materials first.');
          return;
        }
        createMaterialRow();
      });
      
      // Labor input handlers for recalculation
      ['quote-labor-printing', 'quote-labor-design', 'quote-labor-setup', 'quote-labor-other'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', recalculateQuoteTotals);
      });
      
      // =====================================================
      // END MATERIALS SELECTION
      // =====================================================

      function badge(text, type) {
        const map = {
          green: 'bg-green-100 text-green-800',
          red: 'bg-red-100 text-red-800',
          yellow: 'bg-yellow-100 text-yellow-800',
          blue: 'bg-blue-100 text-blue-800',
          gray: 'bg-gray-100 text-gray-800'
        };
        return `<span class="px-2 py-1 text-xs rounded-full ${map[type] || map.gray}">${text}</span>`;
      }
      function paymentBadge(status) {
        if (status === 'Received') return badge('Paid', 'green');
        if (status === 'Rejected') return badge('Rejected', 'red');
        return badge('Pending', 'yellow');
      }
      // Helper: load image as data URL for jsPDF
      async function loadImageAsDataURL(src){
        return new Promise((resolve, reject) => {
          try {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
              const c = document.createElement('canvas');
              c.width = img.width; c.height = img.height;
              const ctx = c.getContext('2d');
              ctx.drawImage(img,0,0);
              resolve(c.toDataURL('image/png'));
            };
            img.onerror = (e)=> reject(new Error('Failed to load logo'));
            img.src = src;
          } catch (e) { reject(e); }
        });
      }

      // Render receipt PDF (adapted from user-side generator)
      async function renderReceiptPDF(r, openInline = false){
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        let logoData = null;
        try { logoData = await loadImageAsDataURL(r.logoUrl || '/images/logo.png'); } catch (e) { logoData = null; }

        const margin = 36;
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        let y = margin;

        // Dark header band (centered title)
        doc.setFillColor(17,24,39);
        doc.rect(0, 0, pageW, 88, 'F');
        doc.setTextColor(255,255,255);
        // center logo if present
        if (logoData) {
          const logoW = 56; const logoH = 56;
          const logoX = (pageW - logoW) / 2;
          doc.addImage(logoData, 'PNG', logoX, 8, logoW, logoH);
        }
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        const headerY = 34;
        doc.text('FUNDAMENTAL APPAREL', pageW / 2, headerY, { align: 'center' });
        doc.setFontSize(9); doc.setFont(undefined, 'normal');
        doc.text('Unit 4B, Creative Building ‚Ä¢ Makati City', pageW / 2, headerY + 16, { align: 'center' });
        doc.text('hello@fundamental.ph ‚Ä¢ www.fundamental.ph', pageW / 2, headerY + 30, { align: 'center' });
        doc.setTextColor(0,0,0);

        // Centered info box (OR/TIN/Date)
        const infoW = 260; const infoX = (pageW - infoW) / 2; const infoY = 68;
        doc.setFillColor(255,255,255);
        doc.roundedRect(infoX, infoY, infoW, 56, 6, 6, 'F');
        doc.setTextColor(0,0,0); doc.setFontSize(9);
        const displayTin = (r.tin && String(r.tin).trim()) ? r.tin : `AUTOGEN-${(r._id||'').toString().slice(-8).toUpperCase()}`;
        doc.text(`OR No.: ${r._id ? r._id.toString().slice(-10).toUpperCase() : displayTin}`, infoX + 12, infoY + 18);
        doc.text(`Date: ${r.createdAt ? new Date(r.createdAt).toLocaleString() : ''}`, infoX + 12, infoY + 34);
        doc.text(`TIN: ${displayTin}`, infoX + 12, infoY + 50);

        // Billed To (start below centered header/info)
        y = 140;
        doc.setFontSize(10); doc.setFont(undefined, 'bold');
        doc.text('Billed To:', margin, y);
        doc.setFont(undefined, 'normal'); doc.setFontSize(9);
        const displayCustomer = (r.customerName && String(r.customerName).trim()) ? r.customerName
          : (r.customerEmail && String(r.customerEmail).trim()) ? r.customerEmail
          : (r.user && (r.user.name || r.user.email)) ? (r.user.name || r.user.email)
          : (r.email ? r.email : '');
        if (displayCustomer) doc.text(String(displayCustomer), margin, y + 14);
        if (r.customerAddress) doc.text(String(r.customerAddress), margin, y + 28);

        // Items table
        y += 60;
        const tableX = margin; const tableW = pageW - margin*2 - 200;
        const totalsAreaX = pageW - margin - 180;

        doc.setFillColor(243,244,246); doc.rect(tableX, y, tableW, 22, 'F');
        doc.setFontSize(9); doc.setFont(undefined, 'bold');
        doc.text('Item', tableX + 6, y + 14);
        doc.text('Size', tableX + 220, y + 14);
        doc.text('Qty', tableX + 320, y + 14);
        doc.text('Unit', tableX + 370, y + 14);
        doc.text('Amount', tableX + tableW - 6, y + 14, { align: 'right' });
        doc.setFont(undefined, 'normal'); doc.setFontSize(9);
        y += 28;

        const items = r.items || [];
        let computedSubtotal = Number(r.subtotal || 0);
        if (!computedSubtotal) computedSubtotal = items.reduce((s,it)=>s+((Number(it.price)||0)*(Number(it.quantity)||1)),0);

        const descX = tableX + 6;
        const descWidth = 220;
        const sizeX = tableX + 240;
        const qtyX = tableX + 320;
        const unitX = tableX + 370;
        const amountX = tableX + tableW - 6;
        const lineHeight = 12;
        for (const it of items) {
          const name = (it.name || it.description || '').toString().replace(/\s+/g,' ');
          const size = it.size || '-';
          const qty = Number(it.quantity || 1);
          const unit = Number(it.price || 0);
          const lineTotal = qty * unit;

          const descLines = doc.splitTextToSize(name, descWidth);
          for (let i = 0; i < descLines.length; i++) {
            doc.text(descLines[i], descX, y + (i * lineHeight));
          }
          doc.text(size.toString(), sizeX, y);
          doc.text(String(qty), qtyX, y);
          doc.text('‚Ç±' + unit.toLocaleString(undefined,{minimumFractionDigits:2}), unitX, y);
          doc.text('‚Ç±' + lineTotal.toLocaleString(undefined,{minimumFractionDigits:2}), amountX, y, { align: 'right' });

          y += Math.max(lineHeight, descLines.length * lineHeight) + 6;
          if (y > pageH - 160) { doc.addPage(); y = margin + 40; }
        }

        // Totals box
        const totalsY = Math.max(y + 10, 380);
        doc.setFillColor(249,250,251); doc.roundedRect(totalsAreaX, totalsY, 180, 120, 6, 6, 'F');
        doc.setFontSize(9); doc.setTextColor(99,102,106);
        const tx = totalsAreaX + 12; let ty = totalsY + 18;
        const deliveryFee = Number(r.deliveryFee || 0);
        const voucherAmt = Math.round((Number(r.voucherDiscount || 0) || 0) * 100) / 100;
        const taxable = Math.max(computedSubtotal - voucherAmt, 0);
        const vat = Math.round(taxable * 0.12 * 100) / 100;

        doc.text('Subtotal', tx, ty); doc.text('‚Ç±' + Number(computedSubtotal||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 16;
        doc.text('Delivery', tx, ty); doc.text('‚Ç±' + Number(deliveryFee||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 16;
        if (voucherAmt > 0) { doc.text('Voucher', tx, ty); doc.text('-‚Ç±' + Number(voucherAmt).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 16; }
        else { doc.text('Voucher', tx, ty); doc.text('N/A', totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 16; }
        doc.text('VAT (12%)', tx, ty); doc.text('‚Ç±' + Number(vat||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' }); ty += 18;

        doc.setFont(undefined, 'bold'); doc.setFontSize(11);
        const totalComputed = Math.round((computedSubtotal - voucherAmt + deliveryFee + vat) * 100) / 100;
        doc.text('TOTAL', tx, ty); doc.text('‚Ç±' + Number(totalComputed||computedSubtotal||0).toLocaleString(undefined,{minimumFractionDigits:2}), totalsAreaX + 180 - 12, ty, { align: 'right' });
        doc.setFont(undefined, 'normal'); doc.setTextColor(0,0,0);

        const prepared = r.preparedBy || r.preparedByName || '';
        if (prepared) doc.setFontSize(9).text('Prepared by: ' + prepared, pageW / 2, totalsY + 120, { align: 'center' });

        const safeName = `Invoice-${(r._id||displayTin||'receipt').toString().slice(-12)}.pdf`;
        if (openInline) { const pdfBlob = doc.output('blob'); const url = URL.createObjectURL(pdfBlob); window.open(url, '_blank'); return; }
        try { doc.save(safeName); }
        catch (e) { const pdfBlob = doc.output('blob'); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.href = url; a.download = safeName; document.body.appendChild(a); a.click(); a.remove(); }
      }

      function renderRegularOrders() {
        const q = els.search.value.trim().toLowerCase();
        const s = els.filterStatus.value;
        const p = els.filterPayment.value;
        // Map filter value to backend status (note: 'To Pay' is derived from paymentStatus + Processing)
        const statusFilterMap = {
          'to-ship': ['Accepted'],
          'to-receive': ['Shipped'],
          'completed': ['Delivered'],
          'cancelled': ['Cancelled']
        };

        const filteredOrders = allOrders.filter(o => {
          const hay = [o._id, o.user?.name, o.trackingCode, o.shippingService].join(' ').toLowerCase();
          if (q && !hay.includes(q)) return false;
          // Skip status filter if viewing archived (server already filtered by isArchived)
          if (s && s !== 'archived') {
            if (s === 'to-pay') {
              // "To Pay" means order is in Processing and payment is still Pending
              if (!(o.status === 'Processing' && (!o.paymentStatus || o.paymentStatus === 'Pending'))) return false;
            } else if (statusFilterMap[s] && !statusFilterMap[s].includes(o.status)) {
              return false;
            }
          }
          if (p && o.paymentStatus !== p) return false;
          return true;
        });

        // Map backend status to user-friendly label, taking paymentStatus into account
        const statusBadge = (order) => {
          const status = order.status;
          if (status === 'Processing') {
            // If payment pending -> To Pay; if already received -> Processing (paid)
            if (!order.paymentStatus || order.paymentStatus === 'Pending') return `<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">To Pay</span>`;
            return `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Processing</span>`;
          }
          const map = {
            'Accepted': ['To Ship', 'bg-blue-100 text-blue-800'],
            'Shipped': ['To Receive', 'bg-indigo-100 text-indigo-800'],
            'Delivered': ['Completed', 'bg-green-100 text-green-800'],
            'Cancelled': ['Cancelled', 'bg-red-100 text-red-800']
          };
          const [label, cls] = map[status] || [status, 'bg-gray-100 text-gray-800'];
          return `<span class="px-2 py-1 text-xs rounded-full ${cls}">${label}</span>`;
        };

        // Check if viewing archived
        const isViewingArchived = els.filterStatus.value === 'archived';

        const rows = filteredOrders.map(o => {
          // Show Ship button for orders that are Accepted and not Pick-Up
          const canShip = o.status === 'Accepted' && o.shippingMethod !== 'Pick-Up' && o.paymentStatus === 'Received';
          const shipButton = canShip ? `<button data-id="${o._id}" class="ship-btn text-green-600 hover:text-green-800 ml-2" title="Ship Order"><i class="fas fa-shipping-fast"></i></button>` : '';
          
          // Archive/Restore/Delete buttons
          const canArchive = !o.isArchived && ['Delivered', 'Cancelled'].includes(o.status);
          const archiveButton = canArchive ? `<button data-id="${o._id}" class="archive-btn text-gray-500 hover:text-gray-700 ml-2" title="Archive Order"><i class="fas fa-archive"></i></button>` : '';
          const restoreButton = o.isArchived ? `<button data-id="${o._id}" class="restore-btn text-green-600 hover:text-green-800 ml-2" title="Restore Order"><i class="fas fa-undo"></i></button>` : '';
          // Delete button - can delete archived OR completed/cancelled orders
          const canDelete = o.isArchived || ['Delivered', 'Cancelled'].includes(o.status);
          const deleteButton = canDelete ? `<button data-id="${o._id}" class="delete-permanent-btn text-red-600 hover:text-red-800 ml-2" title="Delete Order"><i class="fas fa-trash-alt"></i></button>` : '';
          
          // Show archived badge if archived
          const archivedBadge = o.isArchived ? `<span class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600 ml-2">Archived</span>` : '';

          return `
          <tr class="${o.isArchived ? 'bg-gray-50' : ''}">
            <td class="px-4 py-3">${shortId(o._id)} ${archivedBadge} ${o.hasRefundRequest ? `<span data-refund-id="${o.latestRefundId || ''}" class="inline-block ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 refund-badge">Refund: ${o.latestRefundStatus || 'Pending'}</span>` : ''}</td>
            <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
            <td class="px-4 py-3">${paymentBadge(o.paymentStatus)}</td>
            <td class="px-4 py-3">${statusBadge(o)}</td>
            <td class="px-4 py-3">${(o.orderItems || []).reduce((n, i) => n + (i.quantity || 0), 0)}</td>
            <td class="px-4 py-3">${o.user?.name || '-'}</td>
            <td class="px-4 py-3">${o.shippingMethod || '-'}</td>
            <td class="px-4 py-3">${o.trackingCode ? `<span class="font-mono text-xs">${o.trackingCode}</span>` : '-'}</td>
            <td class="px-4 py-3 text-right">
              <div class="inline-flex gap-3 items-center justify-end">
                ${shipButton}
                <button data-id="${o._id}" class="edit-btn text-indigo-600 hover:text-indigo-800" title="View / Edit"><i class="fas fa-pen"></i></button>
                ${archiveButton}
                ${restoreButton}
                ${deleteButton}
              </div>
            </td>
          </tr>
        `}).join('');
        els.tbody.innerHTML = rows || '<tr><td colspan="9" class="px-4 py-6 text-center text-gray-500">No orders found.</td></tr>';
        els.count.textContent = filteredOrders.length;

        // Render mobile cards (visible on small screens)
        try {
          if (els.ordersCards) {
            const cards = filteredOrders.map(o => {
              return `
                <div class="bg-white p-4 rounded-lg shadow sm:hidden">
                  <div class="flex items-start justify-between">
                    <div>
                      <div class="text-sm font-medium">${shortId(o._id)}</div>
                      <div class="text-xs text-gray-500">${new Date(o.createdAt).toLocaleString()}</div>
                      <div class="mt-2">${paymentBadge(o.paymentStatus)} ${statusBadge(o)}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-medium">${peso(o.totalPrice || 0)}</div>
                      <div class="text-xs text-gray-500 mt-1">${(o.orderItems || []).reduce((n, i) => n + (i.quantity || 0), 0)} items</div>
                    </div>
                  </div>
                  <div class="mt-3 text-sm text-gray-700">
                    <div><strong>Customer:</strong> ${o.user?.name || '-'}</div>
                    <div class="mt-1"><strong>Shipping:</strong> ${o.shippingMethod || '-'}</div>
                    <div class="mt-1"><strong>Tracking:</strong> ${o.trackingCode ? `<span class="font-mono text-xs">${o.trackingCode}</span>` : '-'}</div>
                  </div>
                  <div class="mt-3 flex items-center justify-end gap-2">
                    ${(o.status === 'Accepted' && o.shippingMethod !== 'Pick-Up' && o.paymentStatus === 'Received') ? `<button data-id="${o._id}" class="ship-btn px-3 py-1 text-sm bg-green-50 text-green-700 rounded flex items-center gap-1"><i class="fas fa-shipping-fast"></i> Ship</button>` : ''}
                    <button data-id="${o._id}" class="edit-btn px-3 py-1 text-sm bg-indigo-50 text-indigo-700 rounded">View</button>
                  </div>
                </div>
              `;
            }).join('');
            els.ordersCards.innerHTML = cards || '<div class="text-center text-sm text-gray-500 py-6">No orders found.</div>';
          }
        } catch (e) { console.warn('Failed to render mobile cards', e); }
      }

        // --- MODIFIED: renderCustomOrders ---
      function renderCustomOrders() {
        const typeLabel = (t) => {
          // Prefer service-based mapping for clarity
          return function(mapObj){
            if (mapObj.serviceType === 'printing-only') return 'Upload File';
            if (t === 'Template' || t === 'LayoutCreation') return 'Pre-Design Product';
            if (t === 'PrintingOnly' || t === 'FileUpload') return 'Upload File';
            return t || '-';
          };
        };
        // Apply client-side filters
        const q = (els.customSearch?.value || '').trim().toLowerCase();
        const fStatus = els.customFilterStatus?.value || '';
        const fType = els.customFilterType?.value || '';
        const fShip = els.customFilterShipMethod?.value || '';
        const fFull = els.customFilterFulfillment?.value || '';
        const fPay = els.customFilterPayment?.value || '';
        const fCourier = els.customFilterCourier?.value || '';
        const fTrack = els.customFilterTracking?.value || '';
        const dFrom = els.customDateFrom?.value ? new Date(els.customDateFrom.value) : null;
        const dTo = els.customDateTo?.value ? new Date(els.customDateTo.value) : null;

        // Check if viewing archived (fStatus === 'archived' means server returned archived orders)
        const isViewingArchived = fStatus === 'archived';

        const filtered = allCustomOrders.filter(o => {
          // text search across common fields
          const hay = [
            o._id,
            o.user?.name,
            o.productName,
            typeLabel(o.customType)(o),
            o.status,
            o.courier,
            o.trackingNumber,
            o.shippingMethod,
            o.fulfillmentMethod
          ].filter(Boolean).join(' ').toLowerCase();
          if (q && !hay.includes(q)) return false;
          // Skip status filter if viewing archived (server already filtered)
          if (fStatus && fStatus !== 'archived' && o.status !== fStatus) return false;
          if (fType && typeLabel(o.customType)(o) !== fType) return false;
          if (fShip && (o.shippingMethod || '') !== fShip) return false;
          if (fFull && (o.fulfillmentMethod || '') !== fFull) return false;
          if (fPay) {
            const dpPaid = !!o.downPaymentPaid;
            const balPaid = !!o.balancePaid;
            if (fPay === 'dp-paid' && !dpPaid) return false;
            if (fPay === 'dp-unpaid' && dpPaid) return false;
            if (fPay === 'bal-paid' && !balPaid) return false;
            if (fPay === 'bal-unpaid' && balPaid) return false;
          }
          if (fCourier) {
            const has = !!(o.courier && o.courier.trim());
            if (fCourier === 'has' && !has) return false;
            if (fCourier === 'none' && has) return false;
          }
          if (fTrack) {
            const has = !!(o.trackingNumber && o.trackingNumber.trim());
            if (fTrack === 'has' && !has) return false;
            if (fTrack === 'none' && has) return false;
          }
          if (dFrom || dTo) {
            const created = new Date(o.createdAt);
            if (dFrom && created < dFrom) return false;
            if (dTo) {
              // include whole day for 'to'
              const toEnd = new Date(dTo); toEnd.setHours(23,59,59,999);
              if (created > toEnd) return false;
            }
          }
          return true;
        });

        const rowsArr = [];
        filtered.forEach(o => {
          let details = '';
          if (o.customType === 'FileUpload') {
            details = `<a href="${o.designFileUrl}" target="_blank" class="text-indigo-600 hover:underline">View Design File</a>`;
          } else if (o.serviceType === 'printing-only') {
            const parts = [];
            if (o.designFileUrl) parts.push(`<a href="${o.designFileUrl}" target="_blank" class="text-indigo-600 hover:underline">Download Design</a>`);
            if (o.teamNamesFileUrl) parts.push(`<a href="${o.teamNamesFileUrl}" target="_blank" class="text-indigo-600 hover:underline">Team List</a>`);
            details = parts.join(' ‚Ä¢ ') || (o.designDetails || 'N/A');
          } else {
            details = o.designDetails || 'N/A';
          }

          // --- BADGE LOGIC (UPDATED) with better status labels ---
          // Map internal status codes to user-friendly labels
          const statusLabelMap = {
            'Pending Quote': '‚è≥ Pending Quote',
            'Quote Sent': 'üì§ Quote Sent',
            'Quote Accepted': '‚úÖ Quote Accepted',
            'Pending Downpayment': 'üí≥ Awaiting DP Verification',
            'In Production': 'üè≠ In Production',
            'Pending Balance': 'üí∞ Awaiting Balance Payment',
            'Pending Final Verification': 'üîç Verifying Final Payment',
            'Completed': '‚úÖ Completed',
            'Cancelled': '‚ùå Cancelled',
            'Ready for Pickup/Delivery': 'üì¶ Ready for Fulfillment',
            'Out for Delivery': 'üöö Out for Delivery'
          };
          const displayLabel = statusLabelMap[o.status] || o.status;
          
          let statusBadge;
          switch (o.status) {
            case 'Pending Quote': statusBadge = badge(displayLabel, 'yellow'); break;
              case 'Quote Sent': statusBadge = badge(displayLabel, 'green'); break;
              case 'Quote Accepted': statusBadge = badge(displayLabel, 'green'); break;
              case 'Pending Downpayment': statusBadge = badge(displayLabel, 'blue'); break;
              case 'In Production': statusBadge = badge(displayLabel, 'blue'); break;
              case 'Pending Balance': statusBadge = badge(displayLabel, 'yellow'); break;
              // --- ITO ANG BAGO PARA SA PHASE 5.3 ---
              case 'Pending Final Verification': statusBadge = badge(displayLabel, 'blue'); break; 
              case 'Ready for Pickup/Delivery': statusBadge = badge(displayLabel, 'purple'); break;
              case 'Out for Delivery': statusBadge = badge(displayLabel, 'indigo'); break;
              case 'Completed': statusBadge = badge(displayLabel, 'green'); break;
              case 'Cancelled': statusBadge = badge(displayLabel, 'red'); break;
              default: statusBadge = badge(displayLabel, 'gray');
          }
          // --- END BADGE LOGIC ---

          // Archive/Restore/Delete buttons for custom orders
          const canArchiveCustom = !o.isArchived && ['Completed', 'Cancelled'].includes(o.status);
          const archiveCustomBtn = canArchiveCustom ? `<button data-id="${o._id}" class="archive-custom-btn text-gray-500 hover:text-gray-700 ml-2" title="Archive"><i class="fas fa-archive"></i></button>` : '';
          const restoreCustomBtn = o.isArchived ? `<button data-id="${o._id}" class="restore-custom-btn text-green-600 hover:text-green-800 ml-2" title="Restore"><i class="fas fa-undo"></i></button>` : '';
          // Delete button - can delete archived OR completed/cancelled custom orders
          const canDeleteCustom = o.isArchived || ['Completed', 'Cancelled'].includes(o.status);
          const deleteCustomBtn = canDeleteCustom ? `<button data-id="${o._id}" class="delete-custom-permanent-btn text-red-600 hover:text-red-800 ml-2" title="Delete Order"><i class="fas fa-trash-alt"></i></button>` : '';
          const archivedCustomBadge = o.isArchived ? `<span class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600 ml-1">Archived</span>` : '';
          // If this order contains team members, render a single row with Qty = order.quantity
          // and include a concise team summary in the Details column. The View/Edit button
          // still opens the parent order modal for full details.
          if (o.includeTeamMembers && Array.isArray(o.teamMembers) && o.teamMembers.length) {
            const memberSummaries = o.teamMembers.map(m => {
              const nm = m.name ? `${m.name}` : '';
              const num = m.jerseyNumber ? `#${m.jerseyNumber}` : '';
              const sz = m.size ? `(${m.size})` : '';
              return `${nm} ${num} ${sz}`.trim();
            }).filter(Boolean);
            const summaryText = memberSummaries.length ? memberSummaries.join(' ‚Ä¢ ') : details;
            rowsArr.push(`
              <tr>
                  <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
                  <td class="px-4 py-3">${o.user?.name || 'N/A'}</td>
                  <td class="px-4 py-3">${typeLabel(o.customType)(o)}</td>
                  <td class="px-4 py-3">${o.quantity}</td>
                  <td class="px-4 py-3">${statusBadge}${archivedCustomBadge}</td>
                  <td class="px-4 py-3">${o.shippingMethod || '-'}</td>
                  <td class="px-4 py-3 text-xs max-w-xs truncate">${summaryText || details}</td>
                    <td class="px-4 py-3 text-right">
                      <div class="inline-flex gap-3 items-center justify-end">
                        <button data-id="${o._id}" class="edit-custom-btn text-indigo-600 hover:text-indigo-800" title="View / Edit"><i class="fas fa-pen"></i></button>
                        ${archiveCustomBtn}
                        ${restoreCustomBtn}
                        ${deleteCustomBtn}
                      </div>
                    </td>
              </tr>
            `);
          } else {
            rowsArr.push(`
              <tr class="${o.isArchived ? 'bg-gray-50' : ''}">
                  <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
                  <td class="px-4 py-3">${o.user?.name || 'N/A'}</td>
                  <td class="px-4 py-3">${typeLabel(o.customType)(o)}</td>
                  <td class="px-4 py-3">${o.quantity}</td>
                  <td class="px-4 py-3">${statusBadge}${archivedCustomBadge}</td>
                  <td class="px-4 py-3">${o.shippingMethod || '-'}</td>
                  <td class="px-4 py-3 text-xs max-w-xs truncate">${details}</td>
                    <td class="px-4 py-3 text-right">
                      <div class="inline-flex gap-3 items-center justify-end">
                        <button data-id="${o._id}" class="edit-custom-btn text-indigo-600 hover:text-indigo-800" title="View / Edit"><i class="fas fa-pen"></i></button>
                        ${archiveCustomBtn}
                        ${restoreCustomBtn}
                        ${deleteCustomBtn}
                      </div>
                    </td>
              </tr>
            `);
          }
        });

        const rows = rowsArr.join('');
        els.customOrdersBody.innerHTML = rows || '<tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">No custom orders found.</td></tr>';
        // Count shown rows (expand team members into individual entries)
        const displayedCount = rowsArr.length;
        els.customCount.textContent = displayedCount;
      }

      // Removed: Payment Info button in table; details shown directly in modal
      // Removed: Custom Payment Info action (aligning with Orders behavior)

      // Payment Info button removed; payment data is rendered directly in the modal

      // Removed: payment details loader; payment data comes from the order payload

      async function loadRegularOrders() {
        try {
          // Build query from filter controls
          const params = new URLSearchParams();
          const s = els.filterStatus.value;
          const p = els.filterPayment.value;
          const sm = els.filterShipping.value;
          const q = (els.search.value || '').trim();
          const df = els.dateFrom?.value;
          const dt = els.dateTo?.value;
          // Handle archived filter
          if (s === 'archived') {
            params.set('archived', 'true');
          } else {
            if (s) params.set('status', s);
          }
          if (p) params.set('paymentStatus', p);
          if (sm) params.set('shippingMethod', sm);
          if (q) params.set('search', q);
          if (df) params.set('dateFrom', df);
          if (dt) params.set('dateTo', dt);

          const url = `${API}/api/orders/admin${params.toString() ? ('?' + params.toString()) : ''}`;
          const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (res.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
            return;
          }
          const data = await res.json();
          if (!data.success) {
            const banner = document.getElementById('dev-error-banner');
            banner.textContent = 'Failed to load orders: ' + (data.msg || JSON.stringify(data));
            banner.classList.remove('hidden');
            throw new Error(data.msg || 'Failed to load orders');
          }
          allOrders = data.data;
          renderRegularOrders();
        } catch (err) {
          console.error('loadRegularOrders error', err);
          const banner = document.getElementById('dev-error-banner');
          if (banner) { banner.textContent = 'Error loading orders: ' + (err.message || err); banner.classList.remove('hidden'); }
        }
      }

      // Expose a helper to open fulfillment form from other parts
      function openFulfillmentForm() {
        const fulfillmentSection = document.getElementById('custom-modal-fulfillment-section');
        const fulfillmentForm = document.getElementById('custom-modal-fulfillment-form');
        fulfillmentSection.classList.remove('hidden');
        fulfillmentForm.classList.remove('hidden');
      }

      // Cleanup auto-refresh intervals on unload
      window.addEventListener('beforeunload', () => {
        try { stopAutoRefresh('regular'); stopAutoRefresh('custom'); } catch (e) { /* ignore */ }
      });

      // Wire filter change handlers
      function debounce(fn, wait = 300) {
        let t = null;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }
      els.filterStatus?.addEventListener('change', () => loadRegularOrders());
      els.filterPayment?.addEventListener('change', () => loadRegularOrders());
      els.filterShipping?.addEventListener('change', () => loadRegularOrders());
      els.dateFrom?.addEventListener('change', () => loadRegularOrders());
      els.dateTo?.addEventListener('change', () => loadRegularOrders());
      els.search?.addEventListener('input', debounce(() => loadRegularOrders(), 350));
      els.filterReset?.addEventListener('click', () => {
        els.filterStatus.value = '';
        els.filterPayment.value = '';
        els.search.value = '';
        els.dateFrom.value = '';
        els.dateTo.value = '';
        loadRegularOrders();
      });

      // Refresh controls: immediate refresh and optional auto-refresh polling
      let refreshIntervals = { regular: null, custom: null };
      function startAutoRefresh(type) {
        stopAutoRefresh(type);
        const fn = type === 'regular' ? loadRegularOrders : loadCustomOrders;
        // default interval 15s
        refreshIntervals[type] = setInterval(() => fn(), 15000);
      }
      function stopAutoRefresh(type) {
        if (refreshIntervals[type]) { clearInterval(refreshIntervals[type]); refreshIntervals[type] = null; }
      }

      els.refreshOrdersBtn?.addEventListener('click', () => loadRegularOrders());
      els.autoRefreshOrders?.addEventListener('change', (e) => {
        if (e.target.checked) startAutoRefresh('regular'); else stopAutoRefresh('regular');
      });

      async function loadCustomOrders() {
        try {
          // Check if archived filter is selected
          const fStatus = els.customFilterStatus?.value || '';
          const params = new URLSearchParams();
          if (fStatus === 'archived') {
            params.set('archived', 'true');
          }
          const url = `${API}/api/custom-orders/admin${params.toString() ? ('?' + params.toString()) : ''}`;
          const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          if (res.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
            return;
          }
          const data = await res.json();
          if (!data.success) throw new Error(data.msg || 'Failed to load custom orders');
          allCustomOrders = data.data;
          renderCustomOrders();
          // Bind filter events once after initial load
          const reb = renderCustomOrders;
            els.customSearch?.addEventListener('input', reb);
              els.customFilterStatus?.addEventListener('change', () => loadCustomOrders());
              els.customFilterType?.addEventListener('change', reb);
              els.customFilterShipMethod?.addEventListener('change', reb);
              els.customFilterFulfillment?.addEventListener('change', reb);
              els.customFilterPayment?.addEventListener('change', reb);
              els.customFilterCourier?.addEventListener('change', reb);
              els.customFilterTracking?.addEventListener('change', reb);
              els.customDateFrom?.addEventListener('change', reb);
              els.customDateTo?.addEventListener('change', reb);
              els.customFilterReset?.addEventListener('click', () => {
            els.customSearch.value = '';
            els.customFilterStatus.value = '';
            els.customFilterType.value = '';
            els.customFilterShipMethod.value = '';
            els.customFilterFulfillment.value = '';
            els.customFilterPayment.value = '';
            els.customFilterCourier.value = '';
            els.customFilterTracking.value = '';
            els.customDateFrom.value = '';
            els.customDateTo.value = '';
            renderCustomOrders();
          });
          // Custom orders refresh controls
          els.refreshCustomBtn?.addEventListener('click', () => loadCustomOrders());
          els.autoRefreshCustom?.addEventListener('change', (e) => {
            if (e.target.checked) startAutoRefresh('custom'); else stopAutoRefresh('custom');
          });
        } catch (err) {
          showMessage(err.message, 'error');
        }
      }

      async function openModal(order) {
        // ... (ang function na ito ay pareho pa rin) ...
        selectedOrder = order;
        // expose globally for fallback inline delegation
        window.selectedOrder = order;
        // Display payment info directly
        els.modalPaymentStatus.textContent = order.paymentStatus || 'Pending';
        els.modalPaymentRef.textContent = order.paymentIntentId || '-';
        // Prepare receipt view - hide initially, content generated by buildReceiptHtml()
        els.receiptWrap.classList.add('hidden');
        // Build a synthesized receipt object from order data so admin can print/download
        // Build a resilient adminReceipt object (avoid throwing; always provide a usable object)
        (function(){
          const addr = order.shippingAddress || {};
          const addrLines = [];
          if (addr.block) addrLines.push(addr.block);
          if (addr.lot) addrLines.push(addr.lot);
          if (addr.street) addrLines.push(addr.street);
          const addrLine2 = [addr.building, addr.city, addr.province, addr.zip].filter(Boolean).join(', ');
          const addrStr = addrLines.join(' ') + (addrLine2 ? ('\n' + addrLine2) : '');
          // better price fallback: try common fields that might hold the per-item price
          const itemsArr = (order.orderItems || []).map(it => {
            const price = Number(it.price || it.unitPrice || (it.product && it.product.price) || it.variantPrice || 0);
            return { name: it.name || it.productName || (it.product && it.product.title) || '', size: it.size || '', quantity: Number(it.quantity || 1), price };
          });
          const subtotalCalc = itemsArr.reduce((s,i)=>s + (Number(i.price||0) * Number(i.quantity||0)), 0);

          // attempt to decode admin token to get current admin name/email for preparedBy fallback
          function tryDecodeAdminName(){
            try {
              const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
              if (!token) return null;
              const parts = token.split('.'); if (parts.length < 2) return null;
              const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
              return payload.name || payload.email || null;
            } catch (e) { return null; }
          }
          const adminNameFallback = tryDecodeAdminName();

          // build receipt object with robust fallbacks: use stored order fields or sensible defaults
          window.currentAdminReceipt = {
            _id: order._id,
            createdAt: order.createdAt,
            paidAt: order.paidAt || order.createdAt,
            // prefer explicit TIN/tax fields if present, else use receipt/order ids with a TIN prefix
            tin: order.tin || order.taxId || order.paymentIntentId || order.receiptId || `TIN-${String(order._id).slice(-8).toUpperCase()}`,
            customerName: order.user?.name || (order.shippingAddress && order.shippingAddress.name) || (order.shippingAddress && order.shippingAddress.contact) || order.billingName || '',
            customerEmail: order.user?.email || order.email || order.billingEmail || '',
            customerPhone: (order.shippingAddress && order.shippingAddress.phone) || order.user?.phone || order.phone || '',
            customerAddress: addrStr,
            shippingAddress: order.shippingAddress,
            paymentStatus: order.paymentStatus || 'Pending',
            status: order.status || 'Pending',
            paymentMethod: order.paymentMethod || 'Online Payment',
            isPaid: order.isPaid || false,
            items: itemsArr,
            subtotal: subtotalCalc,
            deliveryFee: Number(order.deliveryFee || 0),
            voucherCode: order.voucherCode || order.discountCode || '',
            voucherDiscount: Number(order.voucherDiscount || order.voucherAmount || order.discount || 0) || 0,
            preparedByName: order.acceptedByName || order.preparedByName || adminNameFallback || order.acceptedBy || '-',
            total: Number(typeof order.totalPrice === 'number' ? order.totalPrice : (subtotalCalc - (Number(order.voucherDiscount||order.voucherAmount||0) || 0) + Number(order.deliveryFee||0) + 0))
          };
        })();
        // Render full WYSIWYG receipt HTML so admin view/download matches user receipt
        try {
          els.receiptWrap.innerHTML = buildReceiptHtml(window.currentAdminReceipt || {});
        } catch (e) {
          console.warn('Failed to render admin receipt HTML', e);
        }
        // Optional gateway receipt URL - find element inside generated receipt
        if (order.receiptUrl) {
          const openUrlEl = els.receiptWrap.querySelector('#receipt-open-url');
          if (openUrlEl) {
            openUrlEl.href = order.receiptUrl;
            openUrlEl.classList.remove('hidden');
          }
        }
        // Try to fetch server-generated Receipt (prefer authoritative stored receipt)
        (async function tryLoadStoredReceipt(){
          try {
            const adminToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            // If order has direct receiptId reference, prefer that
            let rec = null;
            const rid = order.receiptId || null;
            if (rid) {
              const rres = await fetch(`${API}/api/receipts/${rid}`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
              if (rres && rres.ok) {
                const rjson = await rres.json();
                if (rjson.success && rjson.data) rec = rjson.data;
              }
            }
            // If not found by receiptId, try to fetch by orderId (helpful for older orders)
            if (!rec) {
              try {
                const byRes = await fetch(`${API}/api/receipts/by-order/${order._id}`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                if (byRes && byRes.ok) {
                  const byJson = await byRes.json();
                  if (byJson.success && byJson.data) rec = byJson.data;
                }
              } catch (ee) { /* ignore */ }
            }
            if (!rec) return;
            // Overwrite admin receipt with stored receipt HTML (authoritative)
            try {
              window.currentAdminReceipt = rec;
              els.receiptWrap.innerHTML = buildReceiptHtml(rec);
              els.receiptWrap.classList.remove('hidden');
              if (rec.meta && rec.meta.gatewayReceiptUrl) {
                let openEl = els.receiptWrap.querySelector('#receipt-open-url');
                if (!openEl) {
                  const topBar = document.createElement('div');
                  topBar.className = 'mt-2';
                  topBar.innerHTML = `<a id="receipt-open-url" href="${rec.meta.gatewayReceiptUrl}" target="_blank" class="text-sm text-indigo-600">Open gateway receipt</a>`;
                  els.receiptWrap.prepend(topBar);
                } else {
                  openEl.href = rec.meta.gatewayReceiptUrl;
                  openEl.classList.remove('hidden');
                }
              }
            } catch (e) { console.warn('Failed to apply stored receipt into admin UI', e); }
          } catch (e) {
            console.warn('Failed to load stored receipt for admin view', e);
          }
        })();
        els.modal.classList.remove('hidden'); els.modal.classList.add('flex');
        els.modalItems.innerHTML = (order.orderItems || []).map(it => `<div class="flex items-center justify-between"><div class="flex items-center gap-3"><img src="${it.imageUrl || ''}" class="w-10 h-10 rounded object-cover bg-gray-100" /><div><div class="font-medium">${it.name || 'Item'}</div><div class="text-gray-500 text-xs">‚Ç±${Number(it.price || 0).toLocaleString()} x ${it.quantity || 0}</div></div></div><div class="font-medium">${peso((it.price || 0) * (it.quantity || 0))}</div></div>`).join('');
        const subtotal = (order.orderItems || []).reduce((s, i) => s + (i.price || 0) * (i.quantity || 0), 0);
        els.modalSubtotal.textContent = peso(subtotal);
        els.modalDelivery.textContent = peso(order.deliveryFee || 0);
        els.modalTotal.textContent = peso(order.totalPrice || 0);
        els.modalPaymentMethod.textContent = order.paymentMethod || '-';
        els.modalShippingMethod.textContent = order.shippingMethod || '-';
        // Receipt upload deprecated in PayMongo flow
        const a = order.shippingAddress || {};
        els.modalAddress.innerHTML = `<div>${[a.block, a.lot].filter(Boolean).join(' ')} ${a.street || ''}</div><div>${a.building || ''}</div><div>${a.city || ''}, ${a.province || ''} ${a.zip || ''}</div><div>${a.phone || ''}</div>`;
        els.formPaymentStatus.value = order.paymentStatus || 'Pending';
        els.modalError.textContent = '';
        // Disable editing if Completed (Delivered)
        const isCompleted = order.status === 'Delivered' || order.status === 'Completed';
        const isCancelled = order.status === 'Cancelled';
        els.formPaymentStatus.disabled = !!order.paymentIntentId || isCompleted;
        els.modalSave.style.display = isCompleted ? 'none' : '';
        const removeBtn = document.getElementById('modal-remove');
        if (removeBtn) removeBtn.style.display = isCompleted ? '' : 'none';

        // Show Archive button for completed/cancelled non-archived orders
        const canArchive = !order.isArchived && (isCompleted || isCancelled);
        els.modalArchive.classList.toggle('hidden', !canArchive);
        
        // Show Delete button for completed/cancelled/archived orders
        const canDelete = order.isArchived || isCompleted || isCancelled;
        els.modalDelete.classList.toggle('hidden', !canDelete);

        els.formPaymentStatus.title = order.paymentIntentId ? 'Payment status is managed by PayMongo' : '';
        if (order.status === 'Cancelled' && order.cancellationReason) {
          els.modalCancelledBy.textContent = order.cancelledBy || 'N/A';
          els.modalCancellationReason.textContent = order.cancellationReason;
          els.modalCancellationDetails.classList.remove('hidden');
        } else {
          els.modalCancellationDetails.classList.add('hidden');
        }
        els.modalAdminCancelReasonBox.classList.toggle('hidden', order.status !== 'Cancelled');
        els.formCancellationReason.value = order.cancellationReason || '';
        // Load refund/return details if available
        const refundSection = document.getElementById('modal-refund-section');
        const refundStatusEl = document.getElementById('modal-refund-status');
        const refundReasonEl = document.getElementById('modal-refund-reason');
        const refundAmountEl = document.getElementById('modal-refund-amount');
        const refundMediaEl = document.getElementById('modal-refund-media');
        const refundAdminNotes = document.getElementById('modal-refund-adminnotes');
        const refundMsg = document.getElementById('modal-refund-msg');
        refundMsg.textContent = '';
        refundAdminNotes.value = '';
        if (order.latestRefundId) {
          // fetch return details
          try {
            const rres = await fetch(`${API}/api/returns/${order.latestRefundId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const rdata = await rres.json();
            if (rres.ok && rdata.success) {
              const rr = rdata.data;
              refundSection.classList.remove('hidden');
              refundStatusEl.textContent = rr.status || 'Pending';
              refundReasonEl.textContent = rr.reason || '-';
              refundAmountEl.textContent = rr.amount ? peso(rr.amount) : (order.totalPrice ? peso(order.totalPrice) : '-');
              refundAdminNotes.value = rr.adminNotes || '';
              refundMediaEl.innerHTML = '';
              if (Array.isArray(rr.images)) rr.images.forEach(u => refundMediaEl.innerHTML += `<a href="${u}" target="_blank" class="text-indigo-600 text-xs mr-2">Image</a>`);
              if (Array.isArray(rr.videos)) rr.videos.forEach(u => refundMediaEl.innerHTML += `<a href="${u}" target="_blank" class="text-indigo-600 text-xs mr-2">Video</a>`);
              
              // Get button elements
              const btnApprove = document.getElementById('btn-approve-refund');
              const btnReject = document.getElementById('btn-reject-refund');
              const btnProcessRefund = document.getElementById('btn-process-refund');
              
              // Enable/disable buttons based on current status
              const canApprove = rr.status === 'Pending';
              const canRefund = ['Approved', 'Awaiting Return', 'Received'].includes(rr.status);
              const isFinalized = ['Refunded', 'Rejected'].includes(rr.status);
              
              btnApprove.disabled = !canApprove || isFinalized;
              btnApprove.classList.toggle('opacity-50', !canApprove || isFinalized);
              btnApprove.classList.toggle('cursor-not-allowed', !canApprove || isFinalized);
              
              btnReject.disabled = isFinalized;
              btnReject.classList.toggle('opacity-50', isFinalized);
              btnReject.classList.toggle('cursor-not-allowed', isFinalized);
              
              btnProcessRefund.disabled = !canRefund || isFinalized;
              btnProcessRefund.classList.toggle('opacity-50', !canRefund || isFinalized);
              btnProcessRefund.classList.toggle('cursor-not-allowed', !canRefund || isFinalized);
              
              // Show helpful message about refund button
              if (!canRefund && !isFinalized) {
                refundMsg.textContent = 'Note: Approve the return request first before processing refund.';
                refundMsg.classList.remove('text-red-600');
                refundMsg.classList.add('text-yellow-600');
              } else {
                refundMsg.textContent = '';
                refundMsg.classList.remove('text-yellow-600');
                refundMsg.classList.add('text-red-600');
              }
              
              // bind buttons
              btnApprove.onclick = async function() {
                if (this.disabled) return;
                refundMsg.textContent = '';
                refundMsg.classList.remove('text-yellow-600');
                refundMsg.classList.add('text-red-600');
                try {
                  const resp = await fetch(`${API}/api/returns/${rr._id}/approve`, { method: 'PUT', headers: { 'Content-Type':'application/json','Authorization': `Bearer ${token}` }, body: JSON.stringify({ adminNotes: refundAdminNotes.value }) });
                  const j = await resp.json();
                  if (!resp.ok || !j.success) throw new Error(j.msg || 'Failed');
                  refundStatusEl.textContent = 'Approved';
                  refundMsg.textContent = 'Return approved! You can now process the refund.';
                  refundMsg.classList.remove('text-red-600');
                  refundMsg.classList.add('text-green-600');
                  await loadRegularOrders();
                  // Re-open modal with updated data
                  openModal(order);
                } catch (e) { refundMsg.textContent = e.message; }
              };
              btnReject.onclick = async function() {
                if (this.disabled) return;
                refundMsg.textContent = '';
                refundMsg.classList.remove('text-yellow-600');
                refundMsg.classList.add('text-red-600');
                try {
                  const resp = await fetch(`${API}/api/returns/${rr._id}/reject`, { method: 'PUT', headers: { 'Content-Type':'application/json','Authorization': `Bearer ${token}` }, body: JSON.stringify({ adminNotes: refundAdminNotes.value }) });
                  const j = await resp.json();
                  if (!resp.ok || !j.success) throw new Error(j.msg || 'Failed');
                  refundStatusEl.textContent = 'Rejected';
                  await loadRegularOrders();
                } catch (e) { refundMsg.textContent = e.message; }
              };
              btnProcessRefund.onclick = async function() {
                if (this.disabled) return;
                refundMsg.textContent = '';
                refundMsg.classList.remove('text-yellow-600', 'text-green-600');
                refundMsg.classList.add('text-red-600');
                try {
                  const resp = await fetch(`${API}/api/returns/${rr._id}/refund`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                  const j = await resp.json();
                  if (!resp.ok || !j.success) throw new Error(j.msg || 'Failed to process refund');
                  refundStatusEl.textContent = 'Refunded';
                  refundMsg.textContent = 'Refund processed successfully!';
                  refundMsg.classList.remove('text-red-600');
                  refundMsg.classList.add('text-green-600');
                  await loadRegularOrders();
                } catch (e) { refundMsg.textContent = e.message; }
              };
            } else {
              refundSection.classList.add('hidden');
            }
          } catch (e) {
            refundSection.classList.add('hidden');
            console.warn('Failed to fetch refund details', e.message);
          }
        } else {
          refundSection.classList.add('hidden');
        }
      }

      // Remove order (Completed only)
      document.getElementById('modal-remove').onclick = async function() {
        if (!selectedOrder) return;
        if (!confirm('Are you sure you want to remove this completed order?')) return;
        try {
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to remove order');
          allOrders = allOrders.filter(o => o._id !== selectedOrder._id);
          renderRegularOrders();
          els.modal.classList.add('hidden');
        } catch (err) {
          els.modalError.textContent = err.message;
        }
      }

      async function saveModal() {
        // Simplified: Only update payment status from this modal
        // Order status changes via workflow buttons, shipping via Ship Modal
        if (!selectedOrder) return;
        els.modalError.textContent = '';
        try {
          const body = {
            paymentStatus: els.formPaymentStatus.value
          };
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to update order');
          const idx = allOrders.findIndex(o => o._id === selectedOrder._id);
          if (idx >= 0) allOrders[idx] = data.data;
          renderRegularOrders();
          els.modal.classList.add('hidden');
        } catch (err) {
          els.modalError.textContent = err.message;
        }
      }

      // --- NEW: Functions for Custom Order Modal ---
      async function openCustomModal(order) {
        selectedCustomOrder = order;
        els.customModalError.textContent = '';
        els.customModalError.classList.add('hidden');
        els.customModal.classList.remove('hidden');
        els.customModal.classList.add('flex');

        // Basic Information
        els.customModalUser.textContent = `${order.user?.name || 'N/A'} (${order.user?.email || 'N/A'})`;
        els.customModalQty.textContent = order.quantity;
        // Show human-friendly service type (prefer serviceType over customType)
        const svc = order.serviceType || order.customType || 'customize-jersey';
        const svcLabelMap = {
          'customize-jersey': 'Customize Jersey',
          'layout-creation': 'Layout Creation',
          'printing-only': 'Upload Custom Design',
          'predesign-product': 'Pre-Design Product'
        };
        els.customModalType.textContent = svcLabelMap[svc] || svc;
        els.customModalNotes.textContent = order.notes || 'N/A';
        els.formCustomPrice.value = order.price || '';
        els.formPricingNotes.value = order.adminNotes || '';

        // Service Type Badge
        const serviceType = order.serviceType || 'customize-jersey';
        const serviceBadge = document.getElementById('custom-modal-service-badge');
        if (serviceType === 'customize-jersey') {
          serviceBadge.textContent = 'üéΩ Customize Jersey';
          serviceBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800';
        } else if (serviceType === 'layout-creation') {
          serviceBadge.textContent = 'üé® Layout Creation';
          serviceBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-purple-100 text-purple-800';
        } else if (serviceType === 'printing-only') {
          serviceBadge.textContent = 'üñ®Ô∏è Upload Custom Design';
          serviceBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
        }

        // Hide all service sections first
        document.getElementById('custom-modal-customize-jersey-section').classList.add('hidden');
        document.getElementById('custom-modal-layout-section').classList.add('hidden');
        document.getElementById('custom-modal-printing-section').classList.add('hidden');

        // Show relevant section based on service type
        if (serviceType === 'customize-jersey') {
          const section = document.getElementById('custom-modal-customize-jersey-section');
          section.classList.remove('hidden');

          // Item and Printing Type
          document.getElementById('custom-modal-item-type').textContent = order.itemType || 'N/A';
          document.getElementById('custom-modal-printing-type').textContent = order.printingType || (order.quotePayload && order.quotePayload.printingType) || 'N/A';

          // Template vs Upload
          if (order.customType === 'Template') {
            const templateFields = document.getElementById('custom-modal-template-fields');
            templateFields.classList.remove('hidden');
            
            document.getElementById('custom-modal-design-style').textContent = order.designStyle || 'N/A';
            
            // Color swatches (legacy fields)
            if (order.primaryColor) document.getElementById('custom-modal-primary-color').style.backgroundColor = order.primaryColor;
            if (order.secondaryColor) document.getElementById('custom-modal-secondary-color').style.backgroundColor = order.secondaryColor;
            if (order.accentColor) document.getElementById('custom-modal-accent-color').style.backgroundColor = order.accentColor;

            // Text details
            if (order.customText) {
              const textSection = document.getElementById('custom-modal-text-section');
              textSection.classList.remove('hidden');
              document.getElementById('custom-modal-custom-text').textContent = order.customText;
              document.getElementById('custom-modal-text-font').textContent = order.textFont || 'N/A';
              document.getElementById('custom-modal-text-size').textContent = order.textSize || 'N/A';
              document.getElementById('custom-modal-text-placement').textContent = order.textPlacement || 'N/A';
            }

            // Logo details
            if (order.logoType && order.logoType !== 'none') {
              const logoSection = document.getElementById('custom-modal-logo-section');
              logoSection.classList.remove('hidden');
              document.getElementById('custom-modal-logo-type').textContent = order.logoType || 'N/A';
              document.getElementById('custom-modal-logo-placement').textContent = order.logoPlacement || 'N/A';
              
              if (order.logoUrl) {
                document.getElementById('custom-modal-logo-preview').innerHTML = 
                  `<a href="${order.logoUrl}" target="_blank" class="text-indigo-600 hover:underline text-xs">View Logo File</a>`;
              }
            }

            document.getElementById('custom-modal-design-file-section').classList.add('hidden');
          } else if (order.customType === 'FileUpload') {
            document.getElementById('custom-modal-template-fields').classList.add('hidden');
            const fileSection = document.getElementById('custom-modal-design-file-section');
            fileSection.classList.remove('hidden');
            
            if (order.designFileUrl) {
              document.getElementById('custom-modal-design-file').innerHTML = 
                `<a href="${order.designFileUrl}" target="_blank" download class="text-indigo-600 font-medium hover:underline">View/Download Design File</a>`;
            } else {
              document.getElementById('custom-modal-design-file').textContent = 'No file uploaded';
            }
          }

          // Product display (show selected product name/image when available)
          try {
            const productHtmlParts = [];
            if (order.productImage || order.imageUrl || order.designFileUrl) {
              const imgSrc = order.productImage || order.imageUrl || order.designFileUrl;
              productHtmlParts.push(`<div class="mb-2"><img src="${imgSrc}" alt="product" class="w-32 h-32 object-contain border rounded" /></div>`);
            }
            if (order.productName) productHtmlParts.push(`<div class="font-medium">${order.productName}</div>`);
            if (productHtmlParts.length) {
              document.getElementById('custom-modal-details').innerHTML = productHtmlParts.join('');
            }
          } catch(e){ /* ignore UI errors */ }

          // Team Details
          if (order.teamName || order.includeTeamMembers) {
            const teamSection = document.getElementById('custom-modal-team-section');
            teamSection.classList.remove('hidden');
            document.getElementById('custom-modal-team-name').textContent = order.teamName || 'N/A';

            if (order.includeTeamMembers && order.teamMembers && order.teamMembers.length > 0) {
              const membersContainer = document.getElementById('custom-modal-team-members-container');
              membersContainer.classList.remove('hidden');
                const tbody = document.getElementById('custom-modal-team-members-tbody');
                // Render editable inputs so admin can adjust names/numbers/sizes and we can validate sizes
                const rowsHtml = order.teamMembers.map((member, idx) => `
                  <tr data-idx="${idx}">
                    <td class="border px-2 py-1"><input data-field="name" value="${member.name || ''}" class="w-full px-2 py-1 text-sm" /></td>
                    <td class="border px-2 py-1"><input data-field="number" value="${member.jerseyNumber || ''}" class="w-full px-2 py-1 text-sm" /></td>
                    <td class="border px-2 py-1"><input data-field="size" value="${member.size || ''}" class="w-full px-2 py-1 text-sm" /></td>
                  </tr>
                `).join('');
              // Collapse control
              const maxVisible = 8;
              if (order.teamMembers.length > maxVisible) {
                tbody.innerHTML = rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
                // Add toggle button
                let toggleBtn = membersContainer.querySelector('[data-team-toggle]');
                if (!toggleBtn) {
                  toggleBtn = document.createElement('button');
                  toggleBtn.setAttribute('data-team-toggle', '');
                  toggleBtn.className = 'mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50';
                  membersContainer.appendChild(toggleBtn);
                }
                toggleBtn.textContent = `Show all (${order.teamMembers.length})`;
                let expanded = false;
                toggleBtn.onclick = () => {
                  expanded = !expanded;
                  tbody.innerHTML = expanded ? rowsHtml : rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
                  toggleBtn.textContent = expanded ? 'Show less' : `Show all (${order.teamMembers.length})`;
                };
              } else {
                tbody.innerHTML = rowsHtml;
                const toggleBtn = membersContainer.querySelector('[data-team-toggle]');
                if (toggleBtn) toggleBtn.remove();
              }
            }
          }

          // Shorts Details
          if (order.includeShorts) {
            const shortsSection = document.getElementById('custom-modal-shorts-section');
            shortsSection.classList.remove('hidden');
            document.getElementById('custom-modal-shorts-same').textContent = order.shortsSameDesign ? 'Yes' : 'No';

            if (!order.shortsSameDesign) {
              const differentContainer = document.getElementById('custom-modal-shorts-different-container');
              differentContainer.classList.remove('hidden');
              
              const shortsDetails = document.getElementById('custom-modal-shorts-details');
              if (order.shortsDesignFileUrl) {
                shortsDetails.innerHTML = `<a href="${order.shortsDesignFileUrl}" target="_blank" class="text-purple-600 hover:underline text-xs">View Shorts Design File</a>`;
              } else if (order.shortsDesignDetails) {
                shortsDetails.textContent = order.shortsDesignDetails;
              } else {
                shortsDetails.textContent = 'No details provided';
              }
            }
          }

          // --- Professional Customizer Details (3-panel layout) ---
          const pro = document.getElementById('custom-modal-pro-section');
          pro.classList.add('hidden');
          const hasProData = !!(order.garmentType || order.selectedLocation || order.colors || order.designImage || order.designText || order.quotePayload);
          if (hasProData) {
            pro.classList.remove('hidden');
            const qp = order.quotePayload || {};
            
            console.log('[Admin Modal] Full order data:', order);
            console.log('[Admin Modal] garmentType:', order.garmentType);
            console.log('[Admin Modal] colors:', order.colors);
            console.log('[Admin Modal] designImagesMap:', order.designImagesMap);
            console.log('[Admin Modal] designImage:', order.designImage);
            
            // Garment and location - Prefer human-readable label from quotePayload
            const garmentLabel = (qp && qp.garmentLabel) ? qp.garmentLabel : null;
            let garmentType = garmentLabel || order.garmentType || order.itemType || 'T-Shirt';
            const lower = garmentType.toLowerCase();
            const garmentEmoji = lower.includes('v-neck') || lower.includes('vneck') ? 'üëï' :
                                lower.includes('round') || lower.includes('crew') ? 'üëï' :
                                lower.includes('jersey') ? 'üéΩ' : 
                                lower.includes('shirt') ? 'üëï' : 
                                lower.includes('short') ? 'ü©≥' : 'üëî';
            document.getElementById('pro-garment').innerHTML = `${garmentEmoji} ${garmentType}`;
            
            // Location - Show specific location with emoji
            const location = order.selectedLocation || qp.selectedLocation || 'Not specified';
            const locationText = location.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            document.getElementById('pro-location').innerHTML = `üìç ${locationText}`;
            
            // Colors - Prefer the single selected garment color from quotePayload
            const colors = order.colors || {};
            const colorsContainer = document.getElementById('colors-container');
            const singleColorHex = (qp && (qp.garmentColorHex || qp.garmentColorName)) || null;
            const singleColorName = (qp && qp.garmentColorName) || '';
            if (singleColorHex) {
              const title = [singleColorName, singleColorHex].filter(Boolean).join(' ¬∑ ');
              colorsContainer.innerHTML = `<div class="w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm" style="background-color: ${singleColorHex}" title="${title}"></div>`;
            } else if (colors.primary || colors.secondary || colors.accent) {
              let colorHTML = '';
              if (colors.primary) {
                colorHTML += `<div class=\"w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm\" style=\"background-color: ${colors.primary}\" title=\"${colors.primary}\"></div>`;
              }
              if (colors.secondary) {
                colorHTML += `<div class=\"w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm\" style=\"background-color: ${colors.secondary}\" title=\"${colors.secondary}\"></div>`;
              }
              if (colors.accent) {
                colorHTML += `<div class=\"w-12 h-12 rounded-lg border-2 border-gray-300 shadow-sm\" style=\"background-color: ${colors.accent}\" title=\"${colors.accent}\"></div>`;
              }
              colorsContainer.innerHTML = colorHTML;
            } else {
              colorsContainer.innerHTML = '<p class="text-sm text-gray-500">No colors specified</p>';
            }
            // Design text AND uploaded design placements
            const dtext = (order.designText || '');
            const multi = order.designImagesMap || {};
            const designKeys = Object.keys(multi);
            
            let designInfoHTML = '';
            
            // Show text placement if exists
            if (dtext) {
              const textLocation = order.selectedLocation || qp.selectedLocation || 'Unknown';
              const formattedLocation = textLocation.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
              designInfoHTML += `<div class="mb-2">
                <span class="font-semibold text-indigo-700">"${dtext}"</span> 
                <span class="text-xs text-gray-600">- ${formattedLocation}</span>
              </div>`;
            }
            
            // Show uploaded design placements (include original filename when available)
            if (designKeys.length > 0) {
              const placements = designKeys.map(key => key.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())).join(', ');
              let uploadedName = (qp && qp.uploadedDesignFilename) || '';
              if (!uploadedName && order.designImage) {
                try {
                  const urlNoQuery = order.designImage.split('?')[0];
                  uploadedName = urlNoQuery.substring(urlNoQuery.lastIndexOf('/') + 1) || '';
                } catch(e) { uploadedName = ''; }
              }
              const namePart = uploadedName ? ` <span class=\"text-xs text-gray-500\">(${uploadedName})</span>` : '';
              designInfoHTML += `<div>
                <span class="font-semibold text-green-700">Uploaded Design</span>${namePart} 
                <span class="text-xs text-gray-600">- ${placements}</span>
              </div>`;
            }
            
            if (designInfoHTML) {
              document.getElementById('pro-design-text').innerHTML = designInfoHTML;
              document.getElementById('pro-design-text-wrap').classList.remove('hidden');
            } else {
              document.getElementById('pro-design-text-wrap').classList.add('hidden');
            }
            // Design images (single legacy + multi-location previews) - 2x2 grid
            const designWrap = document.getElementById('pro-design-image');
            // Use 'multi' from above (already declared for design text section)
            
            console.log('[Admin] Full order object:', order);
            console.log('[Admin] Order designImagesMap:', multi);
            console.log('[Admin] Order designImage:', order.designImage);
            console.log('[Admin] designImagesMap keys:', Object.keys(multi));
            console.log('[Admin] designImagesMap entries:', Object.entries(multi));
            
            if (multi && Object.keys(multi).length) {
              const entries = Object.entries(multi);
              designWrap.innerHTML = entries.map(([loc,url]) => {
                // Ensure URL is absolute
                let finalUrl = url;
                if (url && !url.startsWith('http') && !url.startsWith('data:')) {
                  const API_BASE = 'https://fundamental-apparel-backend.onrender.com';
                  finalUrl = url.startsWith('/') ? `${API_BASE}${url}` : `${API_BASE}/${url}`;
                }
                
                return `
                <div class="bg-white p-3 rounded-lg border">
                  <p class="text-xs font-semibold text-gray-700 mb-2 capitalize">${loc.replace(/-/g,' ')}</p>
                  <a href="${finalUrl}" target="_blank" download class="block mb-2">
                    <img src="${finalUrl}" class="w-full h-32 object-contain rounded border shadow-sm hover:shadow-md transition" alt="${loc} preview" onerror="this.parentElement.innerHTML='<div class=\\'text-red-500 text-xs\\'>Image failed to load</div>'">
                  </a>
                  <a href="${finalUrl}" target="_blank" download class="block text-center px-2 py-1 text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 transition">
                    <i class="fas fa-download mr-1"></i>Download
                  </a>
                </div>`
              }).join('');
              document.getElementById('pro-design-image-wrap').classList.remove('hidden');
            } else if (order.designImage) {
              designWrap.innerHTML = `
                <div class="col-span-2 bg-white p-3 rounded-lg border">
                  <p class="text-xs font-semibold text-gray-700 mb-2">Uploaded Design</p>
                  <a href="${order.designImage}" target="_blank" download class="block mb-2">
                    <img src="${order.designImage}" class="w-full h-48 object-contain rounded border shadow-sm hover:shadow-md transition" alt="Design Image">
                  </a>
                  <a href="${order.designImage}" target="_blank" download class="block text-center px-3 py-2 text-sm bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 transition">
                    <i class="fas fa-download mr-1"></i>Download Image
                  </a>
                </div>`;
              document.getElementById('pro-design-image-wrap').classList.remove('hidden');
            } else {
              document.getElementById('pro-design-image-wrap').classList.add('hidden');
            }
            // Printing, qty - Show specific details
            const printingType = qp.printingType || order.printingType || 'Not specified';
            document.getElementById('pro-printing-type').innerHTML = `üñ®Ô∏è ${printingType}`;
            
            const quantity = order.quantity != null ? order.quantity : 0;
            document.getElementById('pro-qty').innerHTML = `üì¶ ${quantity} ${quantity === 1 ? 'piece' : 'pieces'}`;
            
            // Team entries
            const teamEntries = Array.isArray(qp.teamEntries) ? qp.teamEntries : [];
            const teamWrap = document.getElementById('pro-team-wrap');
            if (qp.teamMode && teamEntries.length) {
              teamWrap.classList.remove('hidden');
              const tb = document.getElementById('pro-team-tbody');
              const rowsHtml = teamEntries.map(e => `<tr><td class="border px-2 py-1">${e.name || ''}</td><td class="border px-2 py-1">${e.number || ''}</td><td class="border px-2 py-1">${e.size || ''}</td></tr>`).join('');
              const maxVisiblePro = 8;
              if (teamEntries.length > maxVisiblePro) {
                tb.innerHTML = rowsHtml.split('</tr>').slice(0, maxVisiblePro).join('</tr>');
                let toggleBtn = teamWrap.querySelector('[data-pro-team-toggle]');
                if (!toggleBtn) {
                  toggleBtn = document.createElement('button');
                  toggleBtn.setAttribute('data-pro-team-toggle', '');
                  toggleBtn.className = 'mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50';
                  teamWrap.appendChild(toggleBtn);
                }
                toggleBtn.textContent = `Show all (${teamEntries.length})`;
                let expanded = false;
                toggleBtn.onclick = () => {
                  expanded = !expanded;
                  tb.innerHTML = expanded ? rowsHtml : rowsHtml.split('</tr>').slice(0, maxVisiblePro).join('</tr>');
                  toggleBtn.textContent = expanded ? 'Show less' : `Show all (${teamEntries.length})`;
                };
              } else {
                tb.innerHTML = rowsHtml;
                const toggleBtn = teamWrap.querySelector('[data-pro-team-toggle]');
                if (toggleBtn) toggleBtn.remove();
              }
            } else {
              teamWrap.classList.add('hidden');
            }
            // Pricing breakdown (hidden for admin to input later)
            const pricingWrap = document.getElementById('pro-pricing-wrap');
            pricingWrap.classList.add('hidden');
            const pj = document.getElementById('pro-pricing-json');
            if (pj) pj.textContent = '';
          }
        } 
        else if (serviceType === 'layout-creation') {
          const section = document.getElementById('custom-modal-layout-section');
          section.classList.remove('hidden');

          // Inspiration Image
          if (order.inspirationImageUrl || order.designFileUrl) {
            const imageUrl = order.inspirationImageUrl || order.designFileUrl;
            document.getElementById('custom-modal-inspiration-image').innerHTML = 
              `<a href="${imageUrl}" target="_blank"><img src="${imageUrl}" class="max-h-48 rounded border shadow" alt="Inspiration"></a>`;
          } else {
            document.getElementById('custom-modal-inspiration-image').textContent = 'No image uploaded';
          }

          document.getElementById('custom-modal-layout-team').textContent = order.teamName || 'N/A';
          document.getElementById('custom-modal-layout-member').textContent = order.memberName || 'N/A';
          document.getElementById('custom-modal-layout-number').textContent = order.jerseyNumber || 'N/A';

          // Color Palette
          if (order.colorPalette && order.colorPalette.length > 0) {
            const paletteContainer = document.getElementById('custom-modal-color-palette');
            paletteContainer.innerHTML = order.colorPalette.map(color => 
              `<div class="w-10 h-10 rounded border-2 border-gray-300" style="background-color: ${color}" title="${color}"></div>`
            ).join('');
          } else {
            document.getElementById('custom-modal-color-palette').innerHTML = '<span class="text-gray-500">No colors specified</span>';
          }
        } 
        else if (serviceType === 'printing-only') {
          const section = document.getElementById('custom-modal-printing-section');
          section.classList.remove('hidden');
          const methodMap = {
            'dye-sublimation': 'Dye-Sublimation',
            'heat-transfer': 'Heat Transfer',
            'vinyl-print': 'Vinyl Print',
          };
          // Show combined Fabric & Garment as the inventory name (matches Inventory.item.name like "Dry-Fit - Jersey")
          const combinedFG = (order.inventoryName && String(order.inventoryName).trim()) || normalizeInventoryKey(order.fabricType, order.garmentType) || normalizeInventoryKey(order.fabricType, order.productName) || (order.fabricType || order.productName || 'N/A');
          document.getElementById('custom-modal-printing-method').textContent = methodMap[order.printingMethod] || order.printingMethod || 'N/A';
          // Display combined value so admin sees the Inventory key used
          const fabricEl = document.getElementById('custom-modal-fabric-type');
          const garmentEl = document.getElementById('custom-modal-garment-type');
          fabricEl.textContent = combinedFG || 'N/A';
          // If we have a combined Fabric-Garment string, hide the separate Garment line to avoid confusion
          try {
            if (combinedFG && combinedFG !== 'N/A') {
              if (garmentEl && garmentEl.parentElement) garmentEl.parentElement.style.display = 'none';
            } else {
              if (garmentEl && garmentEl.parentElement) garmentEl.parentElement.style.display = '';
              if (garmentEl) garmentEl.textContent = order.garmentType || 'N/A';
            }
          } catch(e) { /* ignore UI hide errors */ }

          // Fetch inventory info for this combined (normalized) name (admin endpoint)
          (async () => {
            try {
              const name = combinedFG;
              if (!name || name === 'N/A') {
                document.getElementById('custom-modal-fabric-available').textContent = '-';
                document.getElementById('custom-modal-fabric-reserved').textContent = '-';
                return;
              }
              const q = new URLSearchParams({ search: name, limit: 1 });
              const r = await fetch(`${API}/api/admin/inventory?` + q.toString(), { headers: { 'Authorization': `Bearer ${token}` } });
              if (!r.ok) throw new Error('Failed to fetch inventory');
              const j = await r.json();
              if (!j.success || !j.data || j.data.length === 0) {
                // try a looser search (without exact match) to help admins diagnose naming issues
                try {
                  const loose = new URLSearchParams({ search: order.fabricType || order.productName || '', limit: 5 });
                  const rr = await fetch(`${API}/api/admin/inventory?` + loose.toString(), { headers: { 'Authorization': `Bearer ${token}` } });
                  const jj = await rr.json();
                  if (jj && jj.success && Array.isArray(jj.data) && jj.data.length) {
                    // show first match info as a hint
                    const item = jj.data[0];
                    document.getElementById('custom-modal-fabric-available').textContent = (item.quantity != null) ? item.quantity : '0';
                    document.getElementById('custom-modal-fabric-reserved').textContent = (item.reserved != null) ? item.reserved : '0';
                    // also show a small hint in the available element so admin can see candidate names
                    const hint = ` (Did you mean: ${item.name || (item.item && item.item.name) || 'unknown'})`;
                    document.getElementById('custom-modal-fabric-available').textContent += hint;
                  } else {
                    document.getElementById('custom-modal-fabric-available').textContent = '0';
                    document.getElementById('custom-modal-fabric-reserved').textContent = '0';
                  }
                } catch(e) {
                  document.getElementById('custom-modal-fabric-available').textContent = '0';
                  document.getElementById('custom-modal-fabric-reserved').textContent = '0';
                }
              } else {
                const item = j.data[0];
                document.getElementById('custom-modal-fabric-available').textContent = (item.quantity != null) ? item.quantity : '-';
                document.getElementById('custom-modal-fabric-reserved').textContent = (item.reserved != null) ? item.reserved : '0';
              }
            } catch (e) {
              console.warn('Inventory fetch failed', e && e.message);
              document.getElementById('custom-modal-fabric-available').textContent = '?';
              document.getElementById('custom-modal-fabric-reserved').textContent = '?';
            }
          })();
          // Still show garmentType separately for clarity
          document.getElementById('custom-modal-garment-type').textContent = order.garmentType || 'N/A';

          const sizeRow = document.getElementById('custom-modal-garment-size-row');
          if (order.includeTeamMembers && Array.isArray(order.teamMembers) && order.teamMembers.length) {
            sizeRow.classList.add('hidden');
          } else {
            sizeRow.classList.remove('hidden');
            document.getElementById('custom-modal-garment-size').textContent = order.garmentSize || 'N/A';
          }

          if (order.designFileUrl) {
            const fileSection = document.getElementById('custom-modal-printing-file-section');
            fileSection.classList.remove('hidden');
            document.getElementById('custom-modal-printing-file').innerHTML = 
              `<a href="${order.designFileUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">View/Download Design File</a>`;
          }

          // Team List (from saved members or uploaded txt/csv)
          const teamWrap = document.getElementById('custom-modal-po-team-section');
          const teamBody = document.getElementById('custom-modal-po-team-tbody');
          const teamFileLink = document.getElementById('custom-modal-po-team-file-link');
          teamBody.innerHTML = '';
          teamWrap.classList.add('hidden');
          teamFileLink.classList.add('hidden');

          function renderTeamRows(list){
            if (!list || !list.length) return;
            const rowsHtml = list.map(m => `<tr><td class="border px-2 py-1">${(m.name||'').toString()}</td><td class="border px-2 py-1">${(m.jerseyNumber||m.number||'').toString()}</td><td class="border px-2 py-1">${(m.size||'').toString()}</td></tr>`).join('');
            const maxVisible = 12;
            if (list.length > maxVisible) {
              teamBody.innerHTML = rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
              let toggleBtn = teamWrap.querySelector('[data-po-team-toggle]');
              if (!toggleBtn) {
                toggleBtn = document.createElement('button');
                toggleBtn.setAttribute('data-po-team-toggle','');
                toggleBtn.className = 'mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50';
                teamWrap.appendChild(toggleBtn);
              }
              toggleBtn.textContent = `Show all (${list.length})`;
              let expanded = false;
              toggleBtn.onclick = () => {
                expanded = !expanded;
                teamBody.innerHTML = expanded ? rowsHtml : rowsHtml.split('</tr>').slice(0, maxVisible).join('</tr>');
                toggleBtn.textContent = expanded ? 'Show less' : `Show all (${list.length})`;
              };
            } else {
              teamBody.innerHTML = rowsHtml;
              const toggleBtn = teamWrap.querySelector('[data-po-team-toggle]');
              if (toggleBtn) toggleBtn.remove();
            }
            teamWrap.classList.remove('hidden');
          }

          if (order.includeTeamMembers && Array.isArray(order.teamMembers) && order.teamMembers.length) {
            renderTeamRows(order.teamMembers);
          } else if (order.teamNamesFileUrl) {
            try {
              teamFileLink.href = order.teamNamesFileUrl;
              teamFileLink.classList.remove('hidden');
              const res = await fetch(order.teamNamesFileUrl, { headers: { 'ngrok-skip-browser-warning': 'true' }});
              const text = await res.text();
              const lines = text.split(/\r?\n/).filter(Boolean);
              const parsed = lines.map(ln => {
                const parts = ln.split(/[,|\t]/);
                return { name: (parts[0]||'').trim(), jerseyNumber: (parts[1]||'').trim(), size: (parts[2]||'').trim() };
              });
              renderTeamRows(parsed);
            } catch (e) {
              console.warn('Failed to load team list file:', e);
            }
          }
        }

        // I-reset muna lahat ng sections/buttons
        els.customModalQuoteBox.classList.add('hidden');
        els.customModalInfoBox.classList.add('hidden');
        els.customModalDpSection.classList.add('hidden');
        els.customModalFpSection.classList.add('hidden');
        els.customModalSaveQuote.classList.add('hidden');
        els.customModalVerifyDp.classList.add('hidden');
        els.customModalRequestFinal.classList.add('hidden');
        els.customModalVerifyFinal.classList.add('hidden');

        // --- Magpakita ng UI based sa status ---
        if (order.status === 'Pending Quote') {
          els.customModalQuoteBox.classList.remove('hidden');
          els.customModalSaveQuote.classList.remove('hidden');
          // Initialize materials selection for quote
          initMaterialsSelection();
        }
        else if (order.status === 'Quote Sent') {
          els.customModalInfoBox.classList.remove('hidden');
          populateBillingSummary(order, els);
          els.customModalInfoText.innerHTML = "<span>Waiting for user to accept quote.</span>";
        }
        else if (order.status === 'Quote Accepted') {
          els.customModalInfoBox.classList.remove('hidden');
          populateBillingSummary(order, els);
          els.customModalInfoText.innerHTML = "<span>Waiting for user to pay 50% down payment.</span>";
        }
        else if (order.status === 'Pending Downpayment') {
          els.customModalInfoBox.classList.remove('hidden');
          populateBillingSummary(order, els);
          els.customModalInfoText.innerHTML = "<span class='text-yellow-700 font-medium'>User has submitted a down payment. Awaiting verification.</span>";

          // Show DP receipt section
          els.customModalDpSection.classList.remove('hidden');
          
          // Check both old (downPaymentReceiptUrl) and new (receiptUrl/paymentIntentId) fields
          if (order.downPaymentReceiptUrl) {
            // Old manual upload system
            els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View Down Payment Receipt</a>`;
          } else if (order.paymentIntentId || order.receiptUrl) {
            // New PayMongo system - show View Receipt button
            els.customModalDpReceipt.innerHTML = `
              <button onclick="viewCustomOrderPayment('${order._id}')" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                <i class="fas fa-receipt"></i>View Receipt
              </button>
              <p class="text-xs text-gray-500 mt-2">
                <i class="fas fa-check-circle text-green-600"></i> Payment: ${order.paymentMethod || 'N/A'} ‚Ä¢ Amount: ‚Ç±${(order.paymentAmount || 0).toLocaleString()}
              </p>
            `;
          } else {
            els.customModalDpReceipt.innerHTML = `<span class="text-red-500">User submitted, but receipt URL is missing.</span>`;
          }

          // Show "Verify" button
          els.customModalVerifyDp.classList.remove('hidden');
        }

        else if (order.status === 'In Production') {
          els.customModalInfoBox.classList.remove('hidden');
          populateBillingSummary(order, els);
          els.customModalInfoText.innerHTML = "<span class='text-blue-700 font-medium'>Order is currently in production.</span>";
          els.customModalDpSection.classList.remove('hidden');
          
          // Check both old and new payment fields
          if (order.downPaymentReceiptUrl) {
            // Old manual upload
            els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-gray-500 hover:underline">View Verified DP Receipt</a>`;
          } else if (order.paymentIntentId || order.receiptUrl) {
            // New PayMongo system
            els.customModalDpReceipt.innerHTML = `
              <button onclick="viewCustomOrderPayment('${order._id}')" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                <i class="fas fa-receipt"></i>View Receipt
              </button>
              <p class="text-xs text-gray-500 mt-2">
                <i class="fas fa-check-circle text-green-600"></i> Verified ‚Ä¢ Payment: ${order.paymentMethod || 'N/A'} ‚Ä¢ ‚Ç±${(order.paymentAmount || 0).toLocaleString()}
              </p>
            `;
          } else {
            els.customModalDpReceipt.innerHTML = `<span>DP Verified (No Receipt)</span>`;
          }
          // Show "Request Final Payment" button ONLY if balance not yet paid (i.e., not 100% payment)
          if (!order.balancePaid && order.paymentType !== 'full') {
            els.customModalRequestFinal.classList.remove('hidden');
          } else {
            // 100% payment already received - show completion option instead
            const completeInfo = document.createElement('div');
            completeInfo.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded text-sm';
            completeInfo.innerHTML = `
              <p class="font-semibold text-green-800 mb-2"><i class="fas fa-check-circle"></i> Full Payment Received (100%)</p>
              <p class="text-gray-700 text-xs">This order was paid in full. Ready to mark as completed and arrange fulfillment.</p>
            `;
            els.customModalDpSection.after(completeInfo);
          }
        }
        else if (order.status === 'Pending Final Verification') {
              els.customModalInfoBox.classList.remove('hidden');
              populateBillingSummary(order, els);
              // Updated messaging for PayMongo final payment flow
              els.customModalInfoText.innerHTML = "<span class='text-yellow-700 font-medium'>Final payment received. Awaiting admin verification.</span>";

              // Show Downpayment section (legacy/manual vs PayMongo)
              els.customModalDpSection.classList.remove('hidden');
              if (order.downPaymentReceiptUrl) {
                els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-gray-500 hover:underline">View Verified Downpayment Receipt</a>`;
              } else {
                // For PayMongo downpayment we may have no manual receipt; indicate verified status
                els.customModalDpReceipt.innerHTML = `<span class="text-xs text-gray-500"><i class="fas fa-check-circle text-green-600"></i> Downpayment verified via PayMongo</span>`;
              }

              // Final payment section
              els.customModalFpSection.classList.remove('hidden');
              const isFullPayment = (order.paymentType === 'full' || order.balancePaid === true);
              if (order.finalPaymentReceiptUrl) {
                // Manual upload path (backward compat)
                els.customModalFpReceipt.innerHTML = `<a href="${order.finalPaymentReceiptUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View ${isFullPayment ? 'Full' : 'Final'} Payment Receipt</a>`;
              } else if (order.paymentIntentId || order.receiptUrl) {
                // PayMongo final payment
                els.customModalFpReceipt.innerHTML = `
                  <button onclick="viewCustomOrderPayment('${order._id}')" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    <i class="fas fa-receipt"></i>View ${isFullPayment ? 'Full' : 'Final'} Payment Receipt
                  </button>
                  <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-credit-card text-indigo-600"></i> Method: ${order.paymentMethod || 'N/A'} ‚Ä¢ Amount: ‚Ç±${(order.paymentAmount || 0).toLocaleString()}
                  </p>
                `;
              } else {
                els.customModalFpReceipt.innerHTML = `<span class="text-red-500 text-xs">No ${isFullPayment ? 'full' : 'final'} payment receipt data found.</span>`;
              }
              
              // Ipakita ang "Verify Final" button (label adjusts for full payments)
              els.customModalVerifyFinal.classList.remove('hidden');
              const verifyFinalLabel = isFullPayment ? 'Verify Full-Payment & Start Production' : 'Verify Final Payment & Start Production';
              els.customModalVerifyFinal.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${verifyFinalLabel}`;
          }
        else {
          // Para sa "In Production", "Completed", etc.
          els.customModalInfoBox.classList.remove('hidden');
          populateBillingSummary(order, els);
          const statusLabels = {
            'Pending Balance': 'Waiting for remaining 50% balance payment',
            'Completed': 'Order completed successfully',
            'Cancelled': 'Order has been cancelled'
          };
          const statusText = statusLabels[order.status] || `Order is currently: ${order.status}`;
          els.customModalInfoText.innerHTML = `<span>${statusText}</span>`;
        }

        // --- NEW: Handle Fulfillment Section ---
        const fulfillmentSection = document.getElementById('custom-modal-fulfillment-section');
        const fulfillmentInfo = document.getElementById('custom-modal-fulfillment-info');
        const fulfillmentForm = document.getElementById('custom-modal-fulfillment-form');
        const deliveryFields = document.getElementById('fulfillment-delivery-fields');
        const pickupFields = document.getElementById('fulfillment-pickup-fields');

        fulfillmentSection.classList.add('hidden');
        fulfillmentForm.classList.add('hidden');

        if (order.status === 'Completed' || order.status === 'Ready for Pickup/Delivery' || order.status === 'Out for Delivery' || order.status === 'In Production') {
          fulfillmentSection.classList.remove('hidden');

          if (order.fulfillmentMethod === 'pending' || !order.fulfillmentMethod) {
            // Check if shippingAddress or shippingMethod exists (new structured data)
            if (order.shippingAddress || order.shippingMethod) {
              const addr = order.shippingAddress;
              const method = order.shippingMethod || 'Standard';
              
              if (method === 'Pick-Up') {
                fulfillmentInfo.innerHTML = `
                  <p class="font-semibold text-green-900">üì¶ Pick-Up Selected</p>
                  <p class="mt-1"><strong>Method:</strong> Customer will pick up at store</p>
                  <p class="mt-2 bg-green-50 border border-green-200 rounded p-2">
                    <strong class="text-green-900">üìç Pickup Location:</strong><br>
                    <span class="text-sm text-gray-700">Fundamental Apparel Store</span><br>
                    <span class="text-sm text-gray-600">123 Main Street, Barangay San Jose</span><br>
                    <span class="text-sm text-gray-600">Manila, Metro Manila 1000</span><br>
                    <span class="text-sm text-gray-600">üìû Contact: (02) 8123-4567</span>
                  </p>
                  <p class="mt-1 text-sm text-gray-600">Delivery Fee: FREE</p>
                `;
              } else {
                // Format full address from shippingAddress object with ALL fields
                let fullAddress = 'N/A';
                if (addr) {
                  const parts = [];
                  if (addr.block) parts.push(`Block ${addr.block}`);
                  if (addr.lot) parts.push(`Lot ${addr.lot}`);
                  if (addr.street) parts.push(addr.street);
                  if (addr.building) parts.push(addr.building);
                  if (addr.city) parts.push(addr.city);
                  if (addr.province) parts.push(addr.province);
                  if (addr.zip) parts.push(addr.zip);
                  fullAddress = parts.length > 0 ? parts.join(', ') : 'N/A';
                } else if (order.deliveryAddress) {
                  fullAddress = order.deliveryAddress;
                }
                
                // If shippingMethod/address exists but fulfillmentMethod not set yet, show details and allow admin to open fulfillment form when In Production
                let ctaHtml = '';
                if (order.status === 'In Production') {
                  ctaHtml = `\n                  <div class="mt-3"><button id="custom-modal-open-fulfillment" class="px-4 py-2 bg-purple-600 text-white rounded">Set Ready for Pickup/Delivery</button></div>\n                  <p class="mt-2 text-sm text-gray-600">Production is ongoing. Click the button to set tracking details and mark order Ready for Pickup/Delivery.</p>`;
                } else {
                  ctaHtml = '<p class="mt-1 text-yellow-600">‚è≥ Awaiting admin to set tracking details</p>';
                }

                fulfillmentInfo.innerHTML = `
                  <p class="font-semibold text-blue-900">üöö Standard Delivery Selected</p>
                  <p class="mt-1"><strong>Address:</strong> ${fullAddress}</p>
                  ${addr && addr.phone ? `<p class="mt-1"><strong>Contact:</strong> ${addr.phone}</p>` : ''}
                  <p class="mt-1 text-sm text-gray-600">Delivery Fee: ‚Ç±${order.deliveryFee || 80}</p>
                  ${ctaHtml}
                `;
              }
            } else {
              // If order is In Production, show CTA to set Ready for Pickup/Delivery
              if (order.status === 'In Production') {
                fulfillmentInfo.innerHTML = `
                  <p class="text-gray-600">Production started. You can now mark this order as <strong>Ready for pickup/delivery</strong> and provide tracking details.</p>
                  <div class="mt-3"><button id="custom-modal-open-fulfillment" class="px-4 py-2 bg-purple-600 text-white rounded">Set Ready for Pickup/Delivery</button></div>
                `;
              } else {
                fulfillmentInfo.innerHTML = '<p class="text-gray-600">‚è≥ Customer has not chosen a fulfillment method yet.</p>';
              }
            }
          } else if (order.fulfillmentMethod === 'delivery') {
            fulfillmentInfo.innerHTML = `
              <p class="font-semibold text-blue-900">üöö Delivery Selected</p>
              <p class="mt-1"><strong>Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
              ${order.courier ? `<p class="mt-1"><strong>Courier:</strong> <span class="font-medium text-blue-700">${order.courier}</span></p>` : ''}
              ${order.trackingNumber ? `<p class="mt-1"><strong>Tracking #:</strong> <span class="font-mono text-green-700">${order.trackingNumber}</span></p>` : '<p class="mt-1 text-yellow-600">‚ö†Ô∏è Tracking number not set yet</p>'}
              ${order.estimatedDeliveryDate ? `<p class="mt-1"><strong>Est. Delivery:</strong> ${new Date(order.estimatedDeliveryDate).toLocaleDateString()}</p>` : ''}
            `;
            
            // Allow admin to set tracking even if production is still ongoing
            if (order.status === 'Ready for Pickup/Delivery') {
              fulfillmentForm.classList.remove('hidden');
              deliveryFields.classList.remove('hidden');
              pickupFields.classList.add('hidden');
              
              // Populate delivery address - use deliveryAddress if available, otherwise format from shippingAddress
              let displayAddress = order.deliveryAddress || 'N/A';
              if ((!order.deliveryAddress || order.deliveryAddress === 'N/A') && order.shippingAddress) {
                const addr = order.shippingAddress;
                const parts = [];
                if (addr.block) parts.push(`Block ${addr.block}`);
                if (addr.lot) parts.push(`Lot ${addr.lot}`);
                if (addr.street) parts.push(addr.street);
                if (addr.building) parts.push(addr.building);
                if (addr.city) parts.push(addr.city);
                if (addr.province) parts.push(addr.province);
                if (addr.zip) parts.push(addr.zip);
                if (addr.phone) parts.push(`Tel: ${addr.phone}`);
                displayAddress = parts.length > 0 ? parts.join(', ') : 'N/A';
              }
              document.getElementById('delivery-address-text').textContent = displayAddress;
              
              document.getElementById('fulfillment-courier').value = order.courier || '';
              document.getElementById('fulfillment-tracking').value = order.trackingNumber || '';
              document.getElementById('fulfillment-delivery-date').value = order.estimatedDeliveryDate ? order.estimatedDeliveryDate.split('T')[0] : '';
            }
            else if (order.status === 'In Production') {
              // Show a CTA so admin can mark Ready and add tracking details now
              fulfillmentInfo.innerHTML += `
                <div class="mt-3"><button id="custom-modal-open-fulfillment" class="px-4 py-2 bg-purple-600 text-white rounded">Set Ready for Pickup/Delivery</button></div>
                <p class="mt-2 text-sm text-gray-600">Production is ongoing. Click the button to set tracking details and mark order Ready for Pickup/Delivery.</p>
              `;
            }
          } else if (order.fulfillmentMethod === 'pickup') {
            fulfillmentInfo.innerHTML = `
              <p class="font-semibold text-green-900">üì¶ Pickup Selected</p>
              <p class="mt-1"><strong>Location:</strong> ${order.pickupLocation || 'Fundamental Store - 123 Main St, Manila'}</p>
              ${order.pickupDate ? `<p class="mt-1"><strong>Pickup Date:</strong> ${new Date(order.pickupDate).toLocaleDateString()}</p>` : '<p class="mt-1 text-yellow-600">‚ö†Ô∏è Pickup date not set yet</p>'}
            `;

            if (order.status === 'Ready for Pickup/Delivery') {
              fulfillmentForm.classList.remove('hidden');
              pickupFields.classList.remove('hidden');
              deliveryFields.classList.add('hidden');
              
              document.getElementById('fulfillment-pickup-date').value = order.pickupDate ? order.pickupDate.split('T')[0] : '';
              document.getElementById('fulfillment-pickup-location').value = order.pickupLocation || 'Fundamental Store - 123 Main St, Manila';
            }
            else if (order.status === 'In Production') {
              fulfillmentInfo.innerHTML += `
                <div class="mt-3"><button id="custom-modal-open-fulfillment" class="px-4 py-2 bg-purple-600 text-white rounded">Set Ready for Pickup/Delivery</button></div>
                <p class="mt-2 text-sm text-gray-600">Production is ongoing. Click the button to set pickup details and mark order Ready for Pickup/Delivery.</p>
              `;
            }
          }
        }
        // Attach dynamic listener for opening the fulfillment form when present
        setTimeout(() => {
          const openBtn = document.getElementById('custom-modal-open-fulfillment');
          if (openBtn) {
            openBtn?.addEventListener('click', () => {
              // show the form and default to delivery if shippingMethod indicates so
              fulfillmentForm.classList.remove('hidden');
              document.getElementById('custom-modal-fulfillment-form').classList.remove('hidden');
              const methodSelect = document.getElementById('fulfillment-method-select');
              if (methodSelect) {
                if ((selectedCustomOrder.shippingMethod || '').toLowerCase().includes('pick')) methodSelect.value = 'pickup';
                else methodSelect.value = 'delivery';
                // trigger display change
                methodSelect.dispatchEvent(new Event('change'));
              }
            });
          }
        }, 50);

        // Show Archive/Delete buttons for completed/cancelled orders
        const isCustomCompleted = order.status === 'Completed';
        const isCustomCancelled = order.status === 'Cancelled';
        
        // Archive button - show for completed/cancelled non-archived orders
        const canArchiveCustom = !order.isArchived && (isCustomCompleted || isCustomCancelled);
        els.customModalArchive.classList.toggle('hidden', !canArchiveCustom);
        
        // Delete button - show for completed/cancelled/archived orders
        const canDeleteCustom = order.isArchived || isCustomCompleted || isCustomCancelled;
        els.customModalDelete.classList.toggle('hidden', !canDeleteCustom);
      }

      async function saveCustomQuote() {
        if (!selectedCustomOrder) return;
        const price = els.formCustomPrice.value;
        if (!price || Number(price) <= 0) {
          els.customModalError.textContent = 'Please enter a valid price. Add materials and/or labor costs.';
          els.customModalError.classList.remove('hidden');
          return;
        }

        // Collect materials data for the quote
        const materialsUsed = collectMaterialsData();
        const laborCosts = {
          printing: Number(document.getElementById('quote-labor-printing')?.value || 0),
          design: Number(document.getElementById('quote-labor-design')?.value || 0),
          setup: Number(document.getElementById('quote-labor-setup')?.value || 0),
          other: Number(document.getElementById('quote-labor-other')?.value || 0)
        };
        const laborTotal = laborCosts.printing + laborCosts.design + laborCosts.setup + laborCosts.other;
        const materialsTotal = materialsUsed.reduce((sum, m) => sum + (m.qtyUsed * m.unitCost), 0);
        
        // Validate that at least some cost is entered
        if (materialsTotal === 0 && laborTotal === 0) {
          els.customModalError.textContent = 'Please add at least one material or labor cost.';
          els.customModalError.classList.remove('hidden');
          return;
        }

        // If team members exist, validate sizes against inventory availability before sending quote
        try {
          if (selectedCustomOrder.includeTeamMembers && selectedCustomOrder.teamMembers && selectedCustomOrder.teamMembers.length > 0) {
            // Read current team member sizes from modal inputs
            const tbody = document.getElementById('custom-modal-team-members-tbody');
            const inputs = tbody ? Array.from(tbody.querySelectorAll('input[data-field="size"]')) : [];
            const usedSizes = inputs.map(i => (i.value || '').toString().trim()).filter(Boolean);
            if (usedSizes.length) {
              const invName = selectedCustomOrder.productName || selectedCustomOrder.garmentType || selectedCustomOrder.fabricType || selectedCustomOrder.productName;
              if (invName) {
                const availRes = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(invName)}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (availRes.ok) {
                  const availJson = await availRes.json();
                  if (availJson.success && availJson.data && availJson.data.sizesInventory) {
                    const allowed = Object.keys(availJson.data.sizesInventory || {}).map(s => s.toString().trim());
                    const invalid = usedSizes.filter(s => !allowed.includes(s));
                    if (invalid.length) {
                      els.customModalError.textContent = `Invalid size(s): ${invalid.join(', ')}. Available sizes: ${allowed.join(', ')}`;
                      els.customModalError.classList.remove('hidden');
                      return;
                    }
                  }
                }
                // If availability lookup fails, continue but warn (do not block)
              }
            }
          }
        } catch (e) {
          console.warn('Size validation error (non-blocking):', e && e.message);
        }

        els.customModalSaveQuote.disabled = true;
        els.customModalSaveQuote.textContent = 'Sending...';
        els.customModalError.classList.add('hidden');

        try {
          // Build price breakdown for customer view
          const priceBreakdown = {
            materials: materialsUsed.map(m => ({
              name: m.name,
              qty: m.qtyUsed,
              unit: m.unit,
              unitCost: m.unitCost,
              subtotal: m.qtyUsed * m.unitCost
            })),
            labor: laborCosts,
            materialsTotal: materialsTotal,
            laborTotal: laborTotal,
            grandTotal: Number(price)
          };
          
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/quote`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ 
              price: price, 
              notes: els.formPricingNotes.value || undefined,
              priceBreakdown: priceBreakdown,
              materialsUsed: materialsUsed
            })
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to send quote');

          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders(); // I-refresh ang table

          els.customModal.classList.add('hidden'); // Isara ang modal
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalSaveQuote.disabled = false;
          els.customModalSaveQuote.textContent = 'Send Quote to Customer';
        }
      }

      async function verifyFinalPayment() {
          if (!selectedCustomOrder) return;

          if (!confirm('Are you sure you want to verify this FINAL payment? The order will be marked as Ready for Pickup/Delivery. This action cannot be undone.')) {
              return;
          }

          els.customModalVerifyFinal.disabled = true;
          els.customModalVerifyFinal.textContent = 'Verifying...';
          els.customModalError.classList.add('hidden');
          
          try {
              const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/verify-final-payment`, {
                  method: 'PUT',
                  headers: { 'Authorization': `Bearer ${token}` }
              });
              const data = await res.json();
              if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to verify');
              
              // Update local list
              const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
              if (idx >= 0) allCustomOrders[idx] = data.data;
              renderCustomOrders();
              
              els.customModal.classList.add('hidden');
          } catch (err) {
              els.customModalError.textContent = err.message;
              els.customModalError.classList.remove('hidden');
          } finally {
              els.customModalVerifyFinal.disabled = false;
              els.customModalVerifyFinal.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verify Final Payment &amp; Start Production';
          }
      }

      // --- NEW: Function to verify DP ---
      async function verifyDownPayment() {
        if (!selectedCustomOrder) return;

        if (!confirm('Are you sure you want to verify this down payment and start production? This action cannot be undone.')) {
          return;
        }

        els.customModalVerifyDp.disabled = true;
        els.customModalVerifyDp.textContent = 'Verifying...';
        els.customModalError.classList.add('hidden');

        try {
          // include the normalized combined inventory name to help server match the Inventory item
          const combinedName = (selectedCustomOrder.inventoryName && String(selectedCustomOrder.inventoryName).trim()) || normalizeInventoryKey(selectedCustomOrder.fabricType, selectedCustomOrder.garmentType) || normalizeInventoryKey(selectedCustomOrder.fabricType, selectedCustomOrder.productName) || (selectedCustomOrder.fabricType || selectedCustomOrder.productName || '');
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/verify-downpayment`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ inventoryName: combinedName || undefined })
          });
          let data = null;
          try { data = await res.json(); } catch(e){ data = null; }
          if (!res.ok || !data || !data.success) {
            const msg = (data && data.msg) ? data.msg : `Failed to verify (status ${res.status})`;
            const tried = (data && data.tried && Array.isArray(data.tried)) ? ` Tried candidates: ${data.tried.join(', ')}` : '';
            throw new Error(msg + tried);
          }

          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders();

          els.customModal.classList.add('hidden');
        } catch (err) {
          els.customModalError.textContent = err.message || 'Failed to verify';
          els.customModalError.classList.remove('hidden');
          console.error('verifyDownPayment error details:', err);
        } finally {
          els.customModalVerifyDp.disabled = false;
          els.customModalVerifyDp.textContent = 'Verify & Start Production';
        }
      }

      async function requestFinalPayment() {
        if (!selectedCustomOrder) return;

        if (!confirm('Are you sure you want to mark this order as complete and request final payment?')) {
          return;
        }

        els.customModalRequestFinal.disabled = true;
        els.customModalRequestFinal.textContent = 'Requesting...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/request-final-payment`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to update status');

          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders();

          els.customModal.classList.add('hidden');
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalRequestFinal.disabled = false;
          els.customModalRequestFinal.textContent = 'Request Final Payment';
        }
      }
      // --- END NEW FUNCTIONS ---

      // --- Events ---
      els.search.addEventListener('input', renderRegularOrders);
      els.filterStatus.addEventListener('change', renderRegularOrders);
      els.filterPayment.addEventListener('change', renderRegularOrders);

      // Regular order edit
      els.tbody?.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const order = allOrders.find(o => o._id === id);
          if (order) openModal(order);
        }
      });

      // Mobile card view edit (same action as table View)
      if (els.ordersCards) {
        els.ordersCards?.addEventListener('click', (e) => {
          const editBtn = e.target.closest('.edit-btn');
          if (editBtn) {
            const id = editBtn.dataset.id;
            const order = allOrders.find(o => o._id === id);
            if (order) openModal(order);
          }
          // Handle Ship button on mobile cards
          const shipBtn = e.target.closest('.ship-btn');
          if (shipBtn) {
            const id = shipBtn.dataset.id;
            const order = allOrders.find(o => o._id === id);
            if (order) openShipModal(order);
          }
        });
      }

      // MODIFIED: Custom order edit and archive actions
      els.customOrdersBody?.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-custom-btn');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const order = allCustomOrders.find(o => o._id === id);
          if (order) openCustomModal(order);
        }
        // Archive button for custom orders
        const archiveBtn = e.target.closest('.archive-custom-btn');
        if (archiveBtn) {
          const id = archiveBtn.dataset.id;
          archiveOrder(id, 'custom');
        }
        // Restore button for custom orders
        const restoreBtn = e.target.closest('.restore-custom-btn');
        if (restoreBtn) {
          const id = restoreBtn.dataset.id;
          restoreOrder(id, 'custom');
        }
        // Delete permanently button for custom orders
        const deleteBtn = e.target.closest('.delete-custom-permanent-btn');
        if (deleteBtn) {
          const id = deleteBtn.dataset.id;
          deleteOrderPermanently(id, 'custom');
        }
      });

      // Tab Switching
      els.tabsContainer?.addEventListener('click', (e) => {
        const btn = e.target.closest('button.admin-tab');
        if (!btn) return;

        els.tabsContainer.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        const tab = btn.dataset.tab;
        if (tab === 'regular') {
          els.tabContentRegular.classList.remove('hidden');
          els.tabContentCustom.classList.add('hidden');
        } else if (tab === 'custom') {
          els.tabContentRegular.classList.add('hidden');
          els.tabContentCustom.classList.remove('hidden');
          if (allCustomOrders.length === 0) {
            loadCustomOrders();
          }
        }
      });

      // Regular Modal Events
      // Note: formStatus removed - order status changes via workflow buttons now
      els.modalClose?.addEventListener('click', () => els.modal.classList.add('hidden'));
      els.modal?.addEventListener('click', (e) => { if (e.target === els.modal) els.modal.classList.add('hidden'); });
      els.modalSave?.addEventListener('click', saveModal);

      // --- Modal Archive/Delete buttons for regular orders ---
      els.modalArchive?.addEventListener('click', async () => {
        if (!selectedOrder) return;
        if (!confirm('Archive this order? It will be moved to the Archived filter.')) return;
        try {
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}/archive`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to archive order');
          showMessage('Order archived successfully', 'success');
          els.modal.classList.add('hidden');
          loadRegularOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      });

      els.modalDelete?.addEventListener('click', async () => {
        if (!selectedOrder) return;
        if (!confirm('‚ö†Ô∏è DELETE this order? This action cannot be undone!')) return;
        if (!confirm('Are you absolutely sure? All order data will be lost forever.')) return;
        try {
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}/permanent`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to delete order');
          showMessage('Order permanently deleted', 'success');
          els.modal.classList.add('hidden');
          loadRegularOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      });

      // Receipt controls
      if (els.modalReceiptBtn) {
        els.modalReceiptBtn?.addEventListener('click', () => {
          els.receiptWrap.classList.toggle('hidden');
          if (!els.receiptWrap.classList.contains('hidden')) {
            els.receiptWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      // Note: Copy ref and print buttons are removed - now handled via Download button
      if (els.modalDownloadReceipt) {
        els.modalDownloadReceipt?.addEventListener('click', async () => {
          try {
            const el = document.querySelector('#receipt-wrap #receipt-content') || els.receiptWrap || document.getElementById('receipt-wrap');
            if (!el) return alert('No receipt content available to download.');
            const safeId = (window.currentAdminReceipt && (window.currentAdminReceipt._id || window.currentAdminReceipt.tin)) ? String(window.currentAdminReceipt._id || window.currentAdminReceipt.tin).slice(-12) : 'receipt';
            const fileName = `Invoice-${safeId}.pdf`;
            // Ensure receipt area is visible for accurate rendering
            if (els.receiptWrap && els.receiptWrap.classList.contains('hidden')) els.receiptWrap.classList.remove('hidden');
            await generatePdfFromElement(el, fileName);
          } catch (err) {
            console.error('Download failed', err);
            alert('Download failed. Please try Print from your browser or open the receipt in a new tab to save as PDF.');
          }
        });
      }
      // --- MODIFIED: Custom Modal Events ---
      els.customModalClose?.addEventListener('click', () => els.customModal.classList.add('hidden'));
      els.customModal?.addEventListener('click', (e) => { if (e.target === els.customModal) els.customModal.classList.add('hidden'); });
      els.customModalSaveQuote?.addEventListener('click', saveCustomQuote); // Para sa Phase 2
      els.customModalVerifyDp?.addEventListener('click', verifyDownPayment); // Para sa Phase 4
      els.customModalRequestFinal?.addEventListener('click', requestFinalPayment); // Para sa Phase 5.1
      els.customModalVerifyFinal?.addEventListener('click', verifyFinalPayment);

      // --- Custom Modal Archive/Delete buttons ---
      els.customModalArchive?.addEventListener('click', async () => {
        if (!selectedCustomOrder) return;
        if (!confirm('Archive this custom order? It will be moved to the Archived filter.')) return;
        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/archive`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to archive order');
          showMessage('Custom order archived successfully', 'success');
          els.customModal.classList.add('hidden');
          loadCustomOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      });

      els.customModalDelete?.addEventListener('click', async () => {
        if (!selectedCustomOrder) return;
        if (!confirm('‚ö†Ô∏è DELETE this custom order? This action cannot be undone!')) return;
        if (!confirm('Are you absolutely sure? All order data will be lost forever.')) return;
        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/permanent`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to delete order');
          showMessage('Custom order permanently deleted', 'success');
          els.customModal.classList.add('hidden');
          loadCustomOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      });

      // --- NEW: Ship Modal Events ---
      els.shipModalClose?.addEventListener('click', closeShipModal);
      els.shipModalCancel?.addEventListener('click', closeShipModal);
      els.shipModal?.addEventListener('click', (e) => { if (e.target === els.shipModal) closeShipModal(); });
      els.shipModalCourier?.addEventListener('change', onCourierSelect);
      els.shipModalCopyUrl?.addEventListener('click', copyTrackingUrl);
      els.shipModalConfirm?.addEventListener('click', confirmShipment);

      // Handle Ship Order button clicks from the orders table
      els.tbody?.addEventListener('click', (e) => {
        const shipBtn = e.target.closest('.ship-btn');
        if (shipBtn) {
          const id = shipBtn.dataset.id;
          const order = allOrders.find(o => o._id === id);
          if (order) openShipModal(order);
        }
        // Archive button
        const archiveBtn = e.target.closest('.archive-btn');
        if (archiveBtn) {
          const id = archiveBtn.dataset.id;
          archiveOrder(id, 'regular');
        }
        // Restore button
        const restoreBtn = e.target.closest('.restore-btn');
        if (restoreBtn) {
          const id = restoreBtn.dataset.id;
          restoreOrder(id, 'regular');
        }
        // Delete permanently button
        const deleteBtn = e.target.closest('.delete-permanent-btn');
        if (deleteBtn) {
          const id = deleteBtn.dataset.id;
          deleteOrderPermanently(id, 'regular');
        }
      });

      // --- Archive/Restore/Delete Functions ---
      async function archiveOrder(id, type) {
        if (!confirm('Archive this order? It will be moved to the Archived filter.')) return;
        try {
          const endpoint = type === 'custom' ? `/api/custom-orders/${id}/archive` : `/api/orders/${id}/archive`;
          const res = await fetch(`${API}${endpoint}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to archive order');
          showMessage('Order archived successfully', 'success');
          if (type === 'custom') loadCustomOrders();
          else loadRegularOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      }

      async function restoreOrder(id, type) {
        if (!confirm('Restore this order from archive?')) return;
        try {
          const endpoint = type === 'custom' ? `/api/custom-orders/${id}/restore` : `/api/orders/${id}/restore`;
          const res = await fetch(`${API}${endpoint}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to restore order');
          showMessage('Order restored successfully', 'success');
          if (type === 'custom') loadCustomOrders();
          else loadRegularOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      }

      async function deleteOrderPermanently(id, type) {
        if (!confirm('‚ö†Ô∏è PERMANENTLY DELETE this order? This action cannot be undone!')) return;
        if (!confirm('Are you absolutely sure? All order data will be lost forever.')) return;
        try {
          const endpoint = type === 'custom' ? `/api/custom-orders/${id}/permanent` : `/api/orders/${id}/permanent`;
          const res = await fetch(`${API}${endpoint}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to delete order');
          showMessage('Order permanently deleted', 'success');
          if (type === 'custom') loadCustomOrders();
          else loadRegularOrders();
        } catch (err) {
          showMessage(err.message, 'error');
        }
      }

      // --- NEW: Save Fulfillment Details ---
      async function saveFulfillmentDetails() {
        if (!selectedCustomOrder) return;

        // Prefer explicit selector value if admin just selected method in the form
        const methodSelectEl = document.getElementById('fulfillment-method-select');
        let fulfillmentMethod = (methodSelectEl && methodSelectEl.value) ? methodSelectEl.value : selectedCustomOrder.fulfillmentMethod;
        const data = {};
        if (fulfillmentMethod) data.fulfillmentMethod = fulfillmentMethod;

        if (fulfillmentMethod === 'delivery') {
          const courier = document.getElementById('fulfillment-courier').value.trim();
          const trackingNumber = document.getElementById('fulfillment-tracking').value.trim();
          const deliveryDate = document.getElementById('fulfillment-delivery-date').value;

          if (!courier) {
            showMessage('Please select a courier service.', 'error');
            return;
          }
          if (!trackingNumber) {
            showMessage('Please enter a tracking number.', 'error');
            return;
          }

          data.courier = courier;
          data.trackingNumber = trackingNumber;
          if (deliveryDate) data.estimatedDeliveryDate = deliveryDate;
          // If deliveryAddress missing on order, populate from shippingAddress
          if (!selectedCustomOrder.deliveryAddress && selectedCustomOrder.shippingAddress) {
            const addr = selectedCustomOrder.shippingAddress;
            const parts = [];
            if (addr.block) parts.push(`Block ${addr.block}`);
            if (addr.lot) parts.push(`Lot ${addr.lot}`);
            if (addr.street) parts.push(addr.street);
            if (addr.building) parts.push(addr.building);
            if (addr.city) parts.push(addr.city);
            if (addr.province) parts.push(addr.province);
            if (addr.zip) parts.push(addr.zip);
            const formatted = parts.length ? parts.join(', ') : '';
            if (formatted) data.deliveryAddress = formatted;
          }
        } else if (fulfillmentMethod === 'pickup') {
          const pickupDate = document.getElementById('fulfillment-pickup-date').value;
          const pickupLocation = document.getElementById('fulfillment-pickup-location').value.trim();

          if (pickupDate) data.pickupDate = pickupDate;
          if (pickupLocation) data.pickupLocation = pickupLocation;
        }

        if (Object.keys(data).length === 0) {
          showMessage('Please enter at least one fulfillment detail.', 'error');
          return;
        }

        const saveBtn = document.getElementById('custom-modal-save-fulfillment');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/fulfillment-details`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(data)
          });
          const result = await res.json();
          if (!res.ok || !result.success) throw new Error(result.msg || 'Failed to save fulfillment details');

          showMessage(result.msg || 'Fulfillment details saved! Status updated to "Out for Delivery".', 'success');
          
          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = result.data;
          renderCustomOrders(); // Refresh the table

          els.customModal.classList.add('hidden'); // Close modal

        } catch (err) {
          showMessage('Error: ' + err.message, 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Tracking Details';
        }
      }

      document.getElementById('custom-modal-save-fulfillment')?.addEventListener('click', saveFulfillmentDetails);

      // Toggle fulfillment form fields based on selected method
      const methodSelect = document.getElementById('fulfillment-method-select');
      if (methodSelect) {
        methodSelect?.addEventListener('change', (e) => {
          const v = e.target.value;
          const deliveryFields = document.getElementById('fulfillment-delivery-fields');
          const pickupFields = document.getElementById('fulfillment-pickup-fields');
          if (v === 'delivery') {
            if (deliveryFields) deliveryFields.classList.remove('hidden');
            if (pickupFields) pickupFields.classList.add('hidden');
          } else if (v === 'pickup') {
            if (pickupFields) pickupFields.classList.remove('hidden');
            if (deliveryFields) deliveryFields.classList.add('hidden');
          } else {
            if (deliveryFields) deliveryFields.classList.add('hidden');
            if (pickupFields) pickupFields.classList.add('hidden');
          }
        });
      }

      // =====================================================
      // CUSTOM ORDER FULFILLMENT - Auto-generate Tracking Numbers
      // Uses same tracking formats as Regular Orders for consistency
      // =====================================================
      const fulfillmentCourierSelect = document.getElementById('fulfillment-courier');
      const fulfillmentTrackingInput = document.getElementById('fulfillment-tracking');
      const fulfillmentTrackingSection = document.getElementById('fulfillment-tracking-section');
      const fulfillmentUrlSection = document.getElementById('fulfillment-url-section');
      const fulfillmentTrackingUrl = document.getElementById('fulfillment-tracking-url');
      const fulfillmentCopyUrlBtn = document.getElementById('fulfillment-copy-url');

      // Handle courier selection - auto-generate tracking number (same as regular orders)
      if (fulfillmentCourierSelect) {
        fulfillmentCourierSelect.addEventListener('change', () => {
          const courier = fulfillmentCourierSelect.value;
          
          if (!courier) {
            // No courier selected - hide tracking fields
            if (fulfillmentTrackingSection) fulfillmentTrackingSection.classList.add('hidden');
            if (fulfillmentUrlSection) fulfillmentUrlSection.classList.add('hidden');
            if (fulfillmentTrackingInput) fulfillmentTrackingInput.value = '';
            if (fulfillmentTrackingUrl) fulfillmentTrackingUrl.value = '';
            return;
          }
          
          // Generate tracking number using same function as regular orders
          const trackingCode = generateTrackingNumber(courier);
          const trackingUrl = generateTrackingUrl(courier, trackingCode);
          
          // Show tracking number section and populate
          if (fulfillmentTrackingSection) fulfillmentTrackingSection.classList.remove('hidden');
          if (fulfillmentTrackingInput) fulfillmentTrackingInput.value = trackingCode;
          
          // Show tracking URL if available
          if (trackingUrl) {
            if (fulfillmentUrlSection) fulfillmentUrlSection.classList.remove('hidden');
            if (fulfillmentTrackingUrl) fulfillmentTrackingUrl.value = trackingUrl;
          } else {
            if (fulfillmentUrlSection) fulfillmentUrlSection.classList.add('hidden');
            if (fulfillmentTrackingUrl) fulfillmentTrackingUrl.value = '';
          }
        });
      }

      // Copy tracking URL to clipboard
      if (fulfillmentCopyUrlBtn) {
        fulfillmentCopyUrlBtn.addEventListener('click', () => {
          const url = fulfillmentTrackingUrl?.value;
          if (url) {
            navigator.clipboard.writeText(url).then(() => {
              // Show feedback
              const originalHtml = fulfillmentCopyUrlBtn.innerHTML;
              fulfillmentCopyUrlBtn.innerHTML = '<i class="fas fa-check text-green-600"></i>';
              setTimeout(() => {
                fulfillmentCopyUrlBtn.innerHTML = originalHtml;
              }, 2000);
            }).catch(err => {
              console.error('Failed to copy:', err);
            });
          }
        });
      }

      // --- Initial load ---
      loadRegularOrders();
    });

    // Custom Order Payment Receipt Viewer
    async function viewCustomOrderPayment(orderId) {
      try {
        const token = localStorage.getItem('adminToken');
        const res = await fetch(`${API}/api/custom-orders/${orderId}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });
        const json = await res.json();
        
        if (!json.success || !json.data) {
          showMessage('Failed to load payment details', 'error');
          return;
        }
        
        const order = json.data;
        const code = (order._id || '').toString().slice(-8).toUpperCase();
        
        // Calculate payment breakdown with VAT (matches PayMongo calculation)
        const subtotal = Number(order.price || 0);
        const deliveryFee = Number(order.deliveryFee || 0);
        const vat = subtotal * 0.12; // 12% VAT on subtotal only
        const grandTotal = subtotal + deliveryFee + vat;
        
        let paymentType = order.paymentType || order.paymentOption || 'downpayment'; // 'downpayment' | 'full' | 'remaining'
        // Use actual PayMongo payment amount when available; fallback to PayMongo details if DB missing
        let amountPaid = Number(order.paymentAmount || 0);
        if ((!amountPaid || amountPaid <= 0) && order.paymentIntentId) {
          try {
            const detRes = await fetch(`${API}/api/payments/details/custom/${order._id}`, {
              headers: { 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' }
            });
            const detJson = await detRes.json();
            if (detJson.success && detJson.data) {
              amountPaid = Number(detJson.data.amount || amountPaid);
              if (!order.paymentType) {
                paymentType = Math.abs(amountPaid - grandTotal) < 1 ? 'full' : 'downpayment';
              }
            }
          } catch (e) {
            console.warn('Payment details fallback failed:', e);
          }
        }
        const isFinalPayment = (paymentType === 'remaining' || paymentType === 'balance');
        // For final payment, remaining balance after this transaction is zero
        const remainingBalance = (paymentType === 'full' || isFinalPayment) 
          ? 0 
          : Math.max(0, grandTotal - amountPaid);
        
        let receiptHtml = `
          <div class="space-y-4">
            <div class="text-center">
              <h2 class="text-lg font-bold">FUNDAMENTAL APPAREL</h2>
              <div class="text-sm text-gray-600">Unit 4B, Creative Building ‚Ä¢ Makati City</div>
              <div class="text-xs text-gray-500">OR No: ${order._id || code}</div>
            </div>
            <div class="text-center pb-4 border-b">
              <div class="text-xs text-gray-500 mb-1">Reference Number</div>
              <div class="font-mono font-bold text-lg">${code}</div>
              <button onclick="copyToClipboard('${code}')" class="text-xs text-indigo-600 hover:underline mt-1">
                <i class="fas fa-copy"></i> Copy
              </button>
            </div>
            
            <div>
              <div class="text-xs text-gray-500 mb-1">Payment Type</div>
              <div class="text-lg font-semibold text-indigo-600 mb-3">${
                paymentType === 'full' 
                  ? '100% Full Payment' 
                  : (isFinalPayment ? '50% Final Payment' : '50% Downpayment')
              }</div>
              
              <div class="text-xs text-gray-500 mb-1">Amount Paid</div>
              <div class="text-3xl font-bold text-green-600">‚Ç±${amountPaid.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-xs text-gray-500 mb-1">Payment</div>
                <div class="font-medium">${new Date(order.updatedAt || order.createdAt).toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'})}, ${new Date(order.updatedAt || order.createdAt).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true})}</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Payment method</div>
                <div class="font-medium capitalize">${order.paymentMethod || 'N/A'}</div>
              </div>
            </div>
            
            <div class="flex items-center justify-between py-3 px-4 bg-green-50 rounded-lg">
              <span class="text-sm font-medium text-gray-700">Payment received</span>
              <i class="fas fa-check-circle text-2xl text-green-600"></i>
            </div>
            
            <div class="border-t pt-3">
              <div class="text-xs text-gray-500 mb-2">Payment for</div>
              <div class="font-medium mb-1">${order.productName || 'Custom Order'} ‚Ä¢ Ref ${code}</div>
              <div class="text-xs text-gray-500">Service: ${order.serviceType || 'customize-jersey'}</div>
            </div>
            
            <div class="border-t pt-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Item name</span>
                <span class="text-gray-600">Qty</span>
                <span class="text-gray-600">Price</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="font-medium">${order.productName || 'Custom Order'}</span>
                <span class="font-medium">${order.quantity || 1}</span>
                <span class="font-medium">‚Ç±${subtotal.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
            </div>
            
            <div class="border-t pt-3 space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Subtotal</span>
                <span class="font-medium">‚Ç±${subtotal.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Delivery Fee</span>
                <span class="font-medium">‚Ç±${deliveryFee.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between text-green-600">
                <span class="text-gray-600">VAT (12%)</span>
                <span class="font-medium text-green-600">‚Ç±${vat.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between font-bold text-base pt-2 border-t">
                <span>Grand Total</span>
                <span>‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              <div class="flex justify-between text-green-600 font-semibold">
                <span>Amount Paid (${paymentType === 'full' ? '100%' : (isFinalPayment ? 'Final 50%' : '50%')})</span>
                <span>‚Ç±${amountPaid.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>
              ${
                remainingBalance > 0 || isFinalPayment || paymentType === 'full' 
                  ? `
              <div class="flex justify-between ${remainingBalance > 0 ? 'text-orange-600' : 'text-green-700'} font-semibold">
                <span>Remaining Balance</span>
                <span>‚Ç±${(remainingBalance || 0).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </div>`
                  : ''
              }
            </div>
            
            ${order.paymentIntentId ? `
            <div class="text-xs text-gray-500 text-center pt-2 border-t">
              <i class="fas fa-shield-alt"></i> Secured by PayMongo<br/>
              Session ID: ${order.paymentIntentId.slice(0, 30)}...
            </div>
            ` : ''}
          </div>
        `;
        
        document.getElementById('custom-payment-receipt-content').innerHTML = receiptHtml;
        // Show modal and enlarge dialog for better viewing
        const customModal = document.getElementById('custom-payment-receipt-modal');
        const customDlg = document.getElementById('custom-payment-receipt-dialog');
        if (customDlg) { customDlg.classList.remove('max-w-md'); customDlg.classList.add('max-w-3xl'); }
        customModal.classList.remove('hidden');

        // Wire download button for custom receipt only
        const downloadBtn = document.getElementById('custom-receipt-download-btn');
        if (downloadBtn) {
          downloadBtn.onclick = () => {
            const run = () => {
              try {
                const el = document.getElementById('custom-payment-receipt-content');
                const fileName = `custom-receipt-${(order._id||'').slice(-8)}.pdf`;
                const opt = {
                  margin: 8,
                  filename: fileName,
                  image: { type: 'jpeg', quality: 0.98 },
                  html2canvas: { scale: Math.min(2, (window.devicePixelRatio || 1) * 1.5), useCORS: true, allowTaint: true },
                  jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
                  pagebreak: { mode: ['css', 'legacy'] }
                };
                html2pdf().set(opt).from(el).save();
              } catch (err) { console.warn('PDF generation failed', err); alert('Download failed. Please try Print in the modal or open in a new window to print-to-PDF.'); }
            };
            if (window.html2pdf) return run();
            const s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js';
            s.onload = run; s.onerror = () => alert('Could not load PDF generator. Use Print/Save as PDF from your browser.');
            document.body.appendChild(s);
          };
        }
        
      } catch (error) {
        console.error('Error loading payment receipt:', error);
        showMessage('Failed to load payment details', 'error');
      }
    }
    
    function closeCustomPaymentModal() {
      document.getElementById('custom-payment-receipt-modal').classList.add('hidden');
      const dlg = document.getElementById('custom-payment-receipt-dialog'); if (dlg) { dlg.classList.remove('max-w-3xl'); dlg.classList.add('max-w-md'); }
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage('Reference number copied!', 'success');
      });
    }
  </script>
  
  <!-- Mobile Sidebar Script -->
  <script>
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.querySelector('.admin-sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    mobileMenuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('hidden');
    });
    
    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.add('hidden');
    });
    
    // Load user info
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        try {
          const res = await fetch('/api/admin/profile', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            document.getElementById('user-name').textContent = data.employee?.name || 'Admin';
            if (data.employee?.profileImage) {
              document.getElementById('user-avatar').src = data.employee.profileImage;
            }
          }
        } catch (err) {}
      }
    });
  </script>
  
  <script src="admin-notifications.js"></script>
</body>
</html>