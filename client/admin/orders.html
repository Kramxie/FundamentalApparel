<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* --- FIX PARA SA @APPLY WARNING --- */
    .admin-tab {
      font-size: 1.125rem;
      /* text-lg */
      font-weight: 600;
      /* font-semibold */
      color: rgb(156 163 175);
      /* text-gray-400 */
      padding-bottom: 0.5rem;
      /* pb-2 */
      cursor: pointer;
      /* cursor-pointer */
    }

    .admin-tab.active {
      color: rgb(17 24 39);
      /* text-gray-900 */
      border-bottom-width: 2px;
      /* border-b-2 */
      border-color: rgb(17 24 39);
      /* border-gray-900 */
    }

    /* --- END FIX --- */
  </style>
</head>

<body class="bg-gray-100">
  <div class="flex h-screen bg-gray-100">
    <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
      <div class="flex items-center justify-center h-16 bg-white shadow-md">
        <span class="text-2xl font-bold text-indigo-600">Admin Panel</span>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
          </a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
          </a>
          <a href="manage-products.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
          </a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
          </a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
            <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
          </a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
          </a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
          </a>
        </nav>
      </div>
    </div>

    <div class="flex flex-col flex-1 overflow-y-auto">
      <div class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
        <div>
          <h1 class="text-xl font-semibold text-gray-800">Orders</h1>
        </div>
        <button id="logout-btn"
          class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-md hover:bg-red-600">Logout</button>
      </div>

      <div class="p-6 space-y-6">
        <div class="bg-white p-4 rounded-lg shadow">
          <div id="tabs-container" class="flex gap-8">
            <button data-tab="regular" class="admin-tab active">Manage Orders</button>
            <button data-tab="custom" class="admin-tab">Manage Custom Orders</button>
          </div>
        </div>

        <div id="tab-content-regular">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
              <div class="flex gap-3 items-center">
                <select id="filter-status" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Status</option>
                  <option>Processing</option>
                  <option>Accepted</option>
                  <option>Shipped</option>
                  <option>Delivered</option>
                  <option>Cancelled</option>
                </select>
                <select id="filter-payment" class="border rounded-md px-3 py-2 text-sm">
                  <option value="">Payment</option>
                  <option>Pending</option>
                  <option>Received</option>
                  <option>Rejected</option>
                </select>
                <input id="search" type="text" placeholder="Search..." class="border rounded-md px-3 py-2 text-sm w-56">
              </div>
              <div class="text-sm text-gray-500"><span id="count">0</span> orders</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left px-4 py-3">Order ID</th>
                    <th class="text-left px-4 py-3">Created</th>
                    <th class="text-left px-4 py-3">Payment Status</th>
                    <th class="text-left px-4 py-3">Items</th>
                    <th class="text-left px-4 py-3">Customer</th>
                    <th class="text-left px-4 py-3">Shipping</th>
                    <th class="text-left px-4 py-3">Tracking</th>
                    <th class="text-right px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="orders-body" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-content-custom" class="hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 flex justify-end">
              <div class="text-sm text-gray-500"><span id="custom-count">0</span> custom requests</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left px-4 py-3">Date</th>
                    <th class="text-left px-4 py-3">Customer</th>
                    <th class="text-left px-4 py-3">Type</th>
                    <th class="text-left px-4 py-3">Qty</th>
                    <th class="text-left px-4 py-3">Status</th>
                    <th class="text-left px-4 py-3">Details</th>
                    <th class="text-right px-4 py-3">Action</th>
                  </tr>
                </thead>
                <tbody id="custom-orders-body" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-3xl w-full overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 class="font-semibold text-gray-800">Order Details</h3>
        <button id="modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
        <div>
          <h4 class="font-semibold mb-2">Order Summary</h4>
          <div id="modal-items" class="space-y-3 text-sm"></div>
          <div class="mt-3 text-sm">
            <div class="flex justify-between"><span>Subtotal</span> <span id="modal-subtotal">0</span></div>
            <div class="flex justify-between"><span>Delivery Fee</span> <span id="modal-delivery">0</span></div>
            <div class="flex justify-between font-semibold"><span>Total</span> <span id="modal-total">0</span></div>
          </div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Payment and Shipping</h4>
          <div class="text-sm space-y-2">
            <div><span class="text-gray-500">Payment Method:</span> <span id="modal-paymentMethod"></span></div>
            <div><span class="text-gray-500">Shipping Method:</span> <span id="modal-shippingMethod"></span></div>
          </div>
          <div class="mt-4">
            <h5 class="font-medium mb-2">Receipt</h5>
            <img id="modal-receipt" class="w-full max-h-64 object-contain border rounded" alt="Receipt">
          </div>
          <div class="mt-4">
            <h5 class="font-medium mb-2">Shipping Address</h5>
            <div id="modal-address" class="text-sm text-gray-700"></div>
          </div>
          <div id="modal-cancellation-details" class="hidden mt-4 text-sm space-y-1">
            <h5 class="font-medium mb-1">Cancellation Details</h5>
            <div class="bg-red-50 p-3 rounded-md">
              <p><strong>Cancelled By:</strong> <span id="modal-cancelled-by"></span></p>
              <p><strong>Reason:</strong> <span id="modal-cancellation-reason"></span></p>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div>
              <label class="block text-gray-700 mb-1">Payment Status</label>
              <select id="form-paymentStatus" class="w-full border rounded px-3 py-2">
                <option>Pending</option>
                <option>Received</option>
                <option>Rejected</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Order Status</label>
              <select id="form-status" class="w-full border rounded px-3 py-2">
                <option>Processing</option>
                <option>Accepted</option>
                <option>Shipped</option>
                <option>Delivered</option>
                <option>Cancelled</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Shipping Service</label>
              <select id="form-shippingService" class="w-full border rounded px-3 py-2">
                <option value="">-- Select Courier --</option>
                <option value="Lalamove">Lalamove</option>
                <option value="J&T Express">J&T Express</option>
                <option value="LBC Express">LBC Express</option>
                <option value="Ninja Van">Ninja Van</option>
                <option value="Flash Express">Flash Express</option>
                <option value="JRS Express">JRS Express</option>
                <option value="2GO Express">2GO Express</option>
                <option value="DHL">DHL</option>
                <option value="FedEx">FedEx</option>
                <option value="Store Pickup">Store Pickup</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Tracking Code</label>
              <input id="form-trackingCode" type="text" class="w-full border rounded px-3 py-2"
                placeholder="Tracking number">
            </div>
          </div>
          <div id="modal-admin-cancel-reason-box" class="hidden mt-3 text-sm">
            <label class="block text-gray-700 mb-1">Reason for Cancellation (Admin)</label>
            <input id="form-cancellationReason" type="text" class="w-full border rounded px-3 py-2"
              placeholder="e.g., Out of stock">
          </div>
        </div>
      </div>
      <div class="px-5 py-3 border-t flex items-center justify-end gap-3">
        <p id="modal-error" class="text-sm text-red-600 mr-auto"></p>
        <button id="modal-save"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <div id="custom-order-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow max-w-lg w-full overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 class="font-semibold text-gray-800">Custom Order Request</h3>
        <button id="custom-modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">
        <div id="custom-modal-error" class="hidden text-sm p-3 rounded-md bg-red-100 text-red-700"></div>
        <div class="text-sm space-y-2">
          <p><strong>Customer:</strong> <span id="custom-modal-user"></span></p>
          <p><strong>Quantity:</strong> <span id="custom-modal-qty"></span></p>
          <p><strong>Type:</strong> <span id="custom-modal-type"></span></p>
        </div>
        <div>
          <h4 class="font-medium mb-1">Design Details</h4>
          <div id="custom-modal-details" class="text-sm bg-gray-50 p-3 rounded-md border max-h-40 overflow-y-auto">
          </div>
        </div>
        <div>
          <h4 class="font-medium mb-1">Customer Notes</h4>
          <div id="custom-modal-notes" class="text-sm bg-gray-50 p-3 rounded-md border min-h-[50px]"></div>
        </div>

        <div id="custom-modal-dp-section" class="hidden space-y-2">
          <hr>
          <h4 class="font-medium">Down Payment Receipt</h4>
          <div id="custom-modal-dp-receipt" class="text-sm">
          </div>
        </div>
        <div id="custom-modal-fp-section" class="hidden space-y-2">
          <hr>
          <h4 class="font-medium">Final Payment Receipt</h4>
          <div id="custom-modal-fp-receipt" class="text-sm">
          </div>
        </div>
        <hr>

        <div id="custom-modal-quote-box" class="hidden">
          <label for="form-custom-price" class="block font-medium mb-1">Set Total Price (PHP)</label>
          <input id="form-custom-price" type="number" min="0" class="w-full border rounded px-3 py-2"
            placeholder="Enter total amount for this custom order">
        </div>

        <div id="custom-modal-info-box" class="hidden text-sm">
          <p><strong>Total Price:</strong> <span id="custom-modal-price-display" class="font-semibold text-lg"></span>
          </p>
          <p id="custom-modal-info-text" class="text-gray-600">Waiting for user to pay 50% down payment.</p>
        </div>

        <!-- NEW: Fulfillment Details Section -->
        <div id="custom-modal-fulfillment-section" class="hidden space-y-3">
          <hr>
          <h4 class="font-medium text-gray-800">üì¶ Fulfillment Details</h4>
          
          <div id="custom-modal-fulfillment-info" class="text-sm bg-gray-50 p-3 rounded-md border">
            <!-- This will be populated dynamically -->
          </div>

          <!-- Admin form to add tracking/pickup details -->
          <div id="custom-modal-fulfillment-form" class="hidden space-y-3 p-4 bg-indigo-50 rounded-md border border-indigo-200">
            <p class="text-sm font-medium text-indigo-900">Add Fulfillment Details:</p>
            
            <!-- For Delivery -->
            <div id="fulfillment-delivery-fields" class="hidden space-y-2">
              <div>
                <label class="block text-sm font-medium mb-1">Tracking Number</label>
                <input id="fulfillment-tracking" type="text" class="w-full border rounded px-3 py-2 text-sm" placeholder="Enter tracking number">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Estimated Delivery Date</label>
                <input id="fulfillment-delivery-date" type="date" class="w-full border rounded px-3 py-2 text-sm">
              </div>
            </div>

            <!-- For Pickup -->
            <div id="fulfillment-pickup-fields" class="hidden space-y-2">
              <div>
                <label class="block text-sm font-medium mb-1">Pickup Date</label>
                <input id="fulfillment-pickup-date" type="date" class="w-full border rounded px-3 py-2 text-sm">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Pickup Location</label>
                <input id="fulfillment-pickup-location" type="text" class="w-full border rounded px-3 py-2 text-sm" value="Fundamental Store - 123 Main St, Manila">
              </div>
            </div>

            <button id="custom-modal-save-fulfillment" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded text-sm w-full">
              Save Fulfillment Details
            </button>
          </div>
        </div>

      </div>
      <div class="px-5 py-3 border-t flex items-center justify-between gap-3">
    <p id="custom-modal-error" class="text-sm text-red-600 mr-auto"></p> <div class="flex items-center gap-3"> <button id="custom-modal-save-quote" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-4 py-2 rounded">Send Quote</button>

        <button id="custom-modal-verify-dp" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded">Verify DP</button>

        <button id="custom-modal-request-final" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">Request Final Payment</button>

        <button id="custom-modal-verify-final" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded">Verify Final & Complete</button>
    </div>
</div>
  </div>
  <script>
    const API = 'https://unmumbled-balloonlike-gayle.ngrok-free.dev'; // O ang ngrok URL mo

    function peso(n) { return '‚Ç±' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function shortId(id) { return id ? id.slice(0, 8) : '-'; }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken');
      if (!token) { window.location.href = 'login.html'; return; }

      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('adminToken');
        window.location.href = 'login.html';
      });

      const els = {
        // Regular Order selectors
        tbody: document.getElementById('orders-body'),
        count: document.getElementById('count'),
        search: document.getElementById('search'),
        filterStatus: document.getElementById('filter-status'),
        filterPayment: document.getElementById('filter-payment'),
        modal: document.getElementById('modal'),
        modalClose: document.getElementById('modal-close'),
        modalItems: document.getElementById('modal-items'),
        modalSubtotal: document.getElementById('modal-subtotal'),
        modalDelivery: document.getElementById('modal-delivery'),
        modalTotal: document.getElementById('modal-total'),
        modalPaymentMethod: document.getElementById('modal-paymentMethod'),
        modalShippingMethod: document.getElementById('modal-shippingMethod'),
        modalReceipt: document.getElementById('modal-receipt'),
        modalAddress: document.getElementById('modal-address'),
        formPaymentStatus: document.getElementById('form-paymentStatus'),
        formStatus: document.getElementById('form-status'),
        formShippingService: document.getElementById('form-shippingService'),
        formTrackingCode: document.getElementById('form-trackingCode'),
        modalSave: document.getElementById('modal-save'),
        modalError: document.getElementById('modal-error'),
        modalCancellationDetails: document.getElementById('modal-cancellation-details'),
        modalCancelledBy: document.getElementById('modal-cancelled-by'),
        modalCancellationReason: document.getElementById('modal-cancellation-reason'),
        modalAdminCancelReasonBox: document.getElementById('modal-admin-cancel-reason-box'),
        formCancellationReason: document.getElementById('form-cancellationReason'),

        // Tab Selectors
        tabsContainer: document.getElementById('tabs-container'),
        tabContentRegular: document.getElementById('tab-content-regular'),
        tabContentCustom: document.getElementById('tab-content-custom'),

       
        // Custom Order Selectors
        customOrdersBody: document.getElementById('custom-orders-body'),
        customCount: document.getElementById('custom-count'),
        customModal: document.getElementById('custom-order-modal'),
        customModalClose: document.getElementById('custom-modal-close'),
        customModalError: document.getElementById('custom-modal-error'),
        customModalUser: document.getElementById('custom-modal-user'),
        customModalQty: document.getElementById('custom-modal-qty'),
        customModalType: document.getElementById('custom-modal-type'),
        customModalDetails: document.getElementById('custom-modal-details'),
        customModalNotes: document.getElementById('custom-modal-notes'),
        customModalDpSection: document.getElementById('custom-modal-dp-section'),
        customModalDpReceipt: document.getElementById('custom-modal-dp-receipt'),
        customModalFpSection: document.getElementById('custom-modal-fp-section'),
        customModalFpReceipt: document.getElementById('custom-modal-fp-receipt'),
        customModalQuoteBox: document.getElementById('custom-modal-quote-box'),
        formCustomPrice: document.getElementById('form-custom-price'),
        customModalInfoBox: document.getElementById('custom-modal-info-box'),
        customModalInfoText: document.getElementById('custom-modal-info-text'),
        customModalPriceDisplay: document.getElementById('custom-modal-price-display'),
        customModalSaveQuote: document.getElementById('custom-modal-save-quote'),
        customModalVerifyDp: document.getElementById('custom-modal-verify-dp'),
        customModalRequestFinal: document.getElementById('custom-modal-request-final'),
        customModalVerifyFinal: document.getElementById('custom-modal-verify-final')
      };

      let allOrders = [];
      let allCustomOrders = [];
      let selectedOrder = null; // Para sa regular order
      let selectedCustomOrder = null; // Para sa custom order

      function badge(text, type) {
        const map = {
          green: 'bg-green-100 text-green-800',
          red: 'bg-red-100 text-red-800',
          yellow: 'bg-yellow-100 text-yellow-800',
          blue: 'bg-blue-100 text-blue-800',
          gray: 'bg-gray-100 text-gray-800'
        };
        return `<span class="px-2 py-1 text-xs rounded-full ${map[type] || map.gray}">${text}</span>`;
      }
      function paymentBadge(status) {
        if (status === 'Received') return badge('Paid', 'green');
        if (status === 'Rejected') return badge('Rejected', 'red');
        return badge('Pending', 'yellow');
      }

      function renderRegularOrders() {
        // ... (ang function na ito ay pareho pa rin, walang bago)
        const q = els.search.value.trim().toLowerCase();
        const s = els.filterStatus.value;
        const p = els.filterPayment.value;
        const filteredOrders = allOrders.filter(o => {
          const hay = [o._id, o.user?.name, o.trackingCode, o.shippingService].join(' ').toLowerCase();
          if (q && !hay.includes(q)) return false;
          if (s && o.status !== s) return false;
          if (p && o.paymentStatus !== p) return false;
          return true;
        });
        const rows = filteredOrders.map(o => `
          <tr>
            <td class="px-4 py-3">${shortId(o._id)}</td>
            <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
            <td class="px-4 py-3">${paymentBadge(o.paymentStatus)}</td>
            <td class="px-4 py-3">${(o.orderItems || []).reduce((n, i) => n + (i.quantity || 0), 0)}</td>
            <td class="px-4 py-3">${o.user?.name || '-'}</td>
            <td class="px-4 py-3">${o.shippingMethod || '-'}</td>
            <td class="px-4 py-3">${o.trackingCode || '-'}</td>
            <td class="px-4 py-3 text-right">
              <button data-id="${o._id}" class="edit-btn text-indigo-600 hover:text-indigo-800"><i class="fas fa-pen"></i></button>
            </td>
          </tr>
        `).join('');
        els.tbody.innerHTML = rows || '<tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">No orders found.</td></tr>';
        els.count.textContent = filteredOrders.length;
      }

      // --- MODIFIED: renderCustomOrders ---
      function renderCustomOrders() {
        const rows = allCustomOrders.map(o => {
          let details = '';
          if (o.customType === 'FileUpload') {
            details = `<a href="${o.designFileUrl}" target="_blank" class="text-indigo-600 hover:underline">View Design File</a>`;
          } else {
            details = o.designDetails || 'N/A';
          }

          // --- BADGE LOGIC (UPDATED) ---
          let statusBadge;
          switch (o.status) {
            case 'Pending Quote': statusBadge = badge(o.status, 'yellow'); break;
              case 'Quote Sent': statusBadge = badge(o.status, 'green'); break;
              case 'Pending Downpayment': statusBadge = badge(o.status, 'blue'); break;
              case 'In Production': statusBadge = badge(o.status, 'blue'); break;
              case 'Pending Balance': statusBadge = badge(o.status, 'yellow'); break;
              // --- ITO ANG BAGO PARA SA PHASE 5.3 ---
              case 'Pending Final Verification': statusBadge = badge(o.status, 'blue'); break; 
              case 'Completed': statusBadge = badge(o.status, 'green'); break;
              case 'Cancelled': statusBadge = badge(o.status, 'red'); break;
              default: statusBadge = badge(o.status, 'gray');
          }
          // --- END BADGE LOGIC ---

          return `
                  <tr>
                      <td class="px-4 py-3">${new Date(o.createdAt).toLocaleDateString()}</td>
                      <td class="px-4 py-3">${o.user?.name || 'N/A'}</td>
                      <td class="px-4 py-3">${o.customType}</td>
                      <td class="px-4 py-3">${o.quantity}</td>
                      <td class="px-4 py-3">${statusBadge}</td>
                      <td class="px-4 py-3 text-xs max-w-xs truncate">${details}</td>
                      <td class="px-4 py-3 text-right">
                          <button data-id="${o._id}" class="edit-custom-btn text-indigo-600 hover:text-indigo-800"><i class="fas fa-pen"></i></button>
                      </td>
                  </tr>
              `;
        }).join('');
        els.customOrdersBody.innerHTML = rows || '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">No custom orders found.</td></tr>';
        els.customCount.textContent = allCustomOrders.length;
      }

      async function loadRegularOrders() {
        try {
          const res = await fetch(`${API}/api/orders/admin`, { headers: { 'Authorization': `Bearer ${token}` } });
          if (res.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
            return;
          }
          const data = await res.json();
          if (!data.success) throw new Error(data.msg || 'Failed to load orders');
          allOrders = data.data;
          renderRegularOrders();
        } catch (err) {
          alert(err.message);
        }
      }

      async function loadCustomOrders() {
        try {
          const res = await fetch(`${API}/api/custom-orders/admin`, { headers: { 'Authorization': `Bearer ${token}` } });
          if (res.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
            return;
          }
          const data = await res.json();
          if (!data.success) throw new Error(data.msg || 'Failed to load custom orders');
          allCustomOrders = data.data;
          renderCustomOrders();
        } catch (err) {
          alert(err.message);
        }
      }

      function openModal(order) {
        // ... (ang function na ito ay pareho pa rin) ...
        selectedOrder = order;
        els.modal.classList.remove('hidden'); els.modal.classList.add('flex');
        els.modalItems.innerHTML = (order.orderItems || []).map(it => `<div class="flex items-center justify-between"><div class="flex items-center gap-3"><img src="${it.imageUrl || ''}" class="w-10 h-10 rounded object-cover bg-gray-100" /><div><div class="font-medium">${it.name || 'Item'}</div><div class="text-gray-500 text-xs">‚Ç±${Number(it.price || 0).toLocaleString()} x ${it.quantity || 0}</div></div></div><div class="font-medium">${peso((it.price || 0) * (it.quantity || 0))}</div></div>`).join('');
        const subtotal = (order.orderItems || []).reduce((s, i) => s + (i.price || 0) * (i.quantity || 0), 0);
        els.modalSubtotal.textContent = peso(subtotal);
        els.modalDelivery.textContent = peso(order.deliveryFee || 0);
        els.modalTotal.textContent = peso(order.totalPrice || 0);
        els.modalPaymentMethod.textContent = order.paymentMethod || '-';
        els.modalShippingMethod.textContent = order.shippingMethod || '-';
        els.modalReceipt.src = order.receiptUrl ? `${order.receiptUrl}` : '';
        const a = order.shippingAddress || {};
        els.modalAddress.innerHTML = `<div>${[a.block, a.lot].filter(Boolean).join(' ')} ${a.street || ''}</div><div>${a.building || ''}</div><div>${a.city || ''}, ${a.province || ''} ${a.zip || ''}</div><div>${a.phone || ''}</div>`;
        els.formPaymentStatus.value = order.paymentStatus || 'Pending';
        els.formStatus.value = order.status || 'Processing';
        els.formShippingService.value = order.shippingService || '';
        els.formTrackingCode.value = order.trackingCode || '';
        els.modalError.textContent = '';
        if (order.status === 'Cancelled' && order.cancellationReason) {
          els.modalCancelledBy.textContent = order.cancelledBy || 'N/A';
          els.modalCancellationReason.textContent = order.cancellationReason;
          els.modalCancellationDetails.classList.remove('hidden');
        } else {
          els.modalCancellationDetails.classList.add('hidden');
        }
        els.modalAdminCancelReasonBox.classList.toggle('hidden', order.status !== 'Cancelled');
        els.formCancellationReason.value = order.cancellationReason || '';
      }

      async function saveModal() {
        // ... (ang function na ito ay pareho pa rin) ...
        if (!selectedOrder) return;
        els.modalError.textContent = '';
        try {
          const body = {
            paymentStatus: els.formPaymentStatus.value,
            status: els.formStatus.value,
            shippingService: els.formShippingService.value,
            trackingCode: els.formTrackingCode.value
          };
          if (body.status === 'Cancelled') {
            body.cancellationReason = els.formCancellationReason.value;
          }
          const res = await fetch(`${API}/api/orders/${selectedOrder._id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to update order');
          const idx = allOrders.findIndex(o => o._id === selectedOrder._id);
          if (idx >= 0) allOrders[idx] = data.data;
          renderRegularOrders();
          els.modal.classList.add('hidden');
        } catch (err) {
          els.modalError.textContent = err.message;
        }
      }

      // --- NEW: Functions for Custom Order Modal ---
      function openCustomModal(order) {
        selectedCustomOrder = order;
        els.customModalError.textContent = '';
        els.customModalError.classList.add('hidden'); // Itago ang error
        els.customModal.classList.remove('hidden');
        els.customModal.classList.add('flex');

        els.customModalUser.textContent = `${order.user?.name || 'N/A'} (${order.user?.email || 'N/A'})`;
        els.customModalQty.textContent = order.quantity;
        els.customModalType.textContent = order.customType;
        els.customModalNotes.textContent = order.notes || 'N/A';
        els.formCustomPrice.value = order.price || '';

        if (order.customType === 'FileUpload') {
          els.customModalDetails.innerHTML = `<a href="${order.designFileUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View Design File</a>`;
        } else {
          els.customModalDetails.textContent = order.designDetails || 'N/A';
        }

        // I-reset muna lahat ng sections/buttons
        els.customModalQuoteBox.classList.add('hidden');
        els.customModalInfoBox.classList.add('hidden');
        els.customModalDpSection.classList.add('hidden');
        els.customModalFpSection.classList.add('hidden');
        els.customModalSaveQuote.classList.add('hidden');
        els.customModalVerifyDp.classList.add('hidden');
        els.customModalRequestFinal.classList.add('hidden');
        els.customModalVerifyFinal.classList.add('hidden');

        // --- Magpakita ng UI based sa status ---
        if (order.status === 'Pending Quote') {
          els.customModalQuoteBox.classList.remove('hidden');
          els.customModalSaveQuote.classList.remove('hidden');
        }
        else if (order.status === 'Quote Sent') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = "Waiting for user to pay 50% down payment.";
        }
        else if (order.status === 'Pending Downpayment') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = "User has submitted a down payment receipt.";

          // Ipakita ang DP receipt section
          els.customModalDpSection.classList.remove('hidden');
          if (order.downPaymentReceiptUrl) {
            els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View Down Payment Receipt</a>`;
          } else {
            els.customModalDpReceipt.innerHTML = `<span class="text-red-500">User submitted, but receipt URL is missing.</span>`;
          }

          // Ipakita ang "Verify" button
          els.customModalVerifyDp.classList.remove('hidden');
        }

        else if (order.status === 'In Production') {
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = "Order is currently in production.";
          els.customModalDpSection.classList.remove('hidden');
          if (order.downPaymentReceiptUrl) {
            els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-gray-500 hover:underline">View Verified DP Receipt</a>`;
          } else {
            els.customModalDpReceipt.innerHTML = `<span>DP Verified (No Receipt)</span>`;
          }
          // Ipakita ang "Request Final Payment" button
          els.customModalRequestFinal.classList.remove('hidden');
        }
        else if (order.status === 'Pending Final Verification') {
              els.customModalInfoBox.classList.remove('hidden');
              els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
              els.customModalInfoText.textContent = "User has submitted final payment receipt.";

              // Ipakita ang verified DP receipt
              els.customModalDpSection.classList.remove('hidden');
              els.customModalDpReceipt.innerHTML = `<a href="${order.downPaymentReceiptUrl}" target="_blank" class="text-gray-500 hover:underline">View Verified DP Receipt</a>`;

              // Ipakita ang FINAL receipt section
              els.customModalFpSection.classList.remove('hidden');
              if (order.finalPaymentReceiptUrl) {
                  els.customModalFpReceipt.innerHTML = `<a href="${order.finalPaymentReceiptUrl}" target="_blank" class="text-indigo-600 font-medium hover:underline">Click to View Final Payment Receipt</a>`;
              } else {
                  els.customModalFpReceipt.innerHTML = `<span class="text-red-500">User submitted, but receipt URL is missing.</span>`;
              }
              
              // Ipakita ang "Verify Final" button
              els.customModalVerifyFinal.classList.remove('hidden');
          }
        else {
          // Para sa "In Production", "Completed", etc.
          els.customModalInfoBox.classList.remove('hidden');
          els.customModalPriceDisplay.textContent = `‚Ç±${order.price.toLocaleString()}`;
          els.customModalInfoText.textContent = `Order is currently: ${order.status}`;
        }

        // --- NEW: Handle Fulfillment Section ---
        const fulfillmentSection = document.getElementById('custom-modal-fulfillment-section');
        const fulfillmentInfo = document.getElementById('custom-modal-fulfillment-info');
        const fulfillmentForm = document.getElementById('custom-modal-fulfillment-form');
        const deliveryFields = document.getElementById('fulfillment-delivery-fields');
        const pickupFields = document.getElementById('fulfillment-pickup-fields');

        fulfillmentSection.classList.add('hidden');
        fulfillmentForm.classList.add('hidden');

        if (order.status === 'Completed' || order.status === 'Ready for Pickup/Delivery') {
          fulfillmentSection.classList.remove('hidden');

          if (order.fulfillmentMethod === 'pending' || !order.fulfillmentMethod) {
            fulfillmentInfo.innerHTML = '<p class="text-gray-600">‚è≥ Customer has not chosen a fulfillment method yet.</p>';
          } else if (order.fulfillmentMethod === 'delivery') {
            fulfillmentInfo.innerHTML = `
              <p class="font-semibold text-blue-900">üöö Delivery Selected</p>
              <p class="mt-1"><strong>Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
              ${order.trackingNumber ? `<p class="mt-1"><strong>Tracking #:</strong> <span class="font-mono text-green-700">${order.trackingNumber}</span></p>` : '<p class="mt-1 text-yellow-600">‚ö†Ô∏è Tracking number not set yet</p>'}
              ${order.estimatedDeliveryDate ? `<p class="mt-1"><strong>Est. Delivery:</strong> ${new Date(order.estimatedDeliveryDate).toLocaleDateString()}</p>` : ''}
            `;
            
            if (order.status === 'Ready for Pickup/Delivery') {
              fulfillmentForm.classList.remove('hidden');
              deliveryFields.classList.remove('hidden');
              pickupFields.classList.add('hidden');
              
              document.getElementById('fulfillment-tracking').value = order.trackingNumber || '';
              document.getElementById('fulfillment-delivery-date').value = order.estimatedDeliveryDate ? order.estimatedDeliveryDate.split('T')[0] : '';
            }
          } else if (order.fulfillmentMethod === 'pickup') {
            fulfillmentInfo.innerHTML = `
              <p class="font-semibold text-green-900">üì¶ Pickup Selected</p>
              <p class="mt-1"><strong>Location:</strong> ${order.pickupLocation || 'Fundamental Store - 123 Main St, Manila'}</p>
              ${order.pickupDate ? `<p class="mt-1"><strong>Pickup Date:</strong> ${new Date(order.pickupDate).toLocaleDateString()}</p>` : '<p class="mt-1 text-yellow-600">‚ö†Ô∏è Pickup date not set yet</p>'}
            `;

            if (order.status === 'Ready for Pickup/Delivery') {
              fulfillmentForm.classList.remove('hidden');
              pickupFields.classList.remove('hidden');
              deliveryFields.classList.add('hidden');
              
              document.getElementById('fulfillment-pickup-date').value = order.pickupDate ? order.pickupDate.split('T')[0] : '';
              document.getElementById('fulfillment-pickup-location').value = order.pickupLocation || 'Fundamental Store - 123 Main St, Manila';
            }
          }
        }
      }

      async function saveCustomQuote() {
        if (!selectedCustomOrder) return;

        const price = els.formCustomPrice.value;
        if (!price || Number(price) <= 0) {
          els.customModalError.textContent = 'Please enter a valid price.';
          els.customModalError.classList.remove('hidden');
          return;
        }

        els.customModalSaveQuote.disabled = true;
        els.customModalSaveQuote.textContent = 'Sending...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/quote`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ price: price })
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to send quote');

          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders(); // I-refresh ang table

          els.customModal.classList.add('hidden'); // Isara ang modal
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalSaveQuote.disabled = false;
          els.customModalSaveQuote.textContent = 'Send Quote to Customer';
        }
      }

      async function verifyFinalPayment() {
          if (!selectedCustomOrder) return;

          if (!confirm('Are you sure you want to verify this FINAL payment and mark the order as Completed? This action cannot be undone.')) {
              return;
          }

          els.customModalVerifyFinal.disabled = true;
          els.customModalVerifyFinal.textContent = 'Verifying...';
          els.customModalError.classList.add('hidden');
          
          try {
              const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/verify-final-payment`, {
                  method: 'PUT',
                  headers: { 'Authorization': `Bearer ${token}` }
              });
              const data = await res.json();
              if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to verify');
              
              // Update local list
              const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
              if (idx >= 0) allCustomOrders[idx] = data.data;
              renderCustomOrders();
              
              els.customModal.classList.add('hidden');
          } catch (err) {
              els.customModalError.textContent = err.message;
              els.customModalError.classList.remove('hidden');
          } finally {
              els.customModalVerifyFinal.disabled = false;
              els.customModalVerifyFinal.textContent = 'Verify Final & Complete';
          }
      }

      // --- NEW: Function to verify DP ---
      async function verifyDownPayment() {
        if (!selectedCustomOrder) return;

        if (!confirm('Are you sure you want to verify this down payment and start production? This action cannot be undone.')) {
          return;
        }

        els.customModalVerifyDp.disabled = true;
        els.customModalVerifyDp.textContent = 'Verifying...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/verify-downpayment`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to verify');

          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders();

          els.customModal.classList.add('hidden');
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalVerifyDp.disabled = false;
          els.customModalVerifyDp.textContent = 'Verify & Start Production';
        }
      }

      async function requestFinalPayment() {
        if (!selectedCustomOrder) return;

        if (!confirm('Are you sure you want to mark this order as complete and request final payment?')) {
          return;
        }

        els.customModalRequestFinal.disabled = true;
        els.customModalRequestFinal.textContent = 'Requesting...';
        els.customModalError.classList.add('hidden');

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/request-final-payment`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.msg || 'Failed to update status');

          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = data.data;
          renderCustomOrders();

          els.customModal.classList.add('hidden');
        } catch (err) {
          els.customModalError.textContent = err.message;
          els.customModalError.classList.remove('hidden');
        } finally {
          els.customModalRequestFinal.disabled = false;
          els.customModalRequestFinal.textContent = 'Request Final Payment';
        }
      }
      // --- END NEW FUNCTIONS ---

      // --- Events ---
      els.search.addEventListener('input', renderRegularOrders);
      els.filterStatus.addEventListener('change', renderRegularOrders);
      els.filterPayment.addEventListener('change', renderRegularOrders);

      // Regular order edit
      els.tbody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const order = allOrders.find(o => o._id === id);
          if (order) openModal(order);
        }
      });

      // MODIFIED: Custom order edit
      els.customOrdersBody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-custom-btn');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const order = allCustomOrders.find(o => o._id === id);
          if (order) openCustomModal(order);
        }
      });

      // Tab Switching
      els.tabsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button.admin-tab');
        if (!btn) return;

        els.tabsContainer.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        const tab = btn.dataset.tab;
        if (tab === 'regular') {
          els.tabContentRegular.classList.remove('hidden');
          els.tabContentCustom.classList.add('hidden');
        } else if (tab === 'custom') {
          els.tabContentRegular.classList.add('hidden');
          els.tabContentCustom.classList.remove('hidden');
          if (allCustomOrders.length === 0) {
            loadCustomOrders();
          }
        }
      });

      // Regular Modal Events
      els.formStatus.addEventListener('change', () => {
        els.modalAdminCancelReasonBox.classList.toggle('hidden', els.formStatus.value !== 'Cancelled');
      });
      els.modalClose.addEventListener('click', () => els.modal.classList.add('hidden'));
      els.modal.addEventListener('click', (e) => { if (e.target === els.modal) els.modal.classList.add('hidden'); });
      els.modalSave.addEventListener('click', saveModal);

      // --- MODIFIED: Custom Modal Events ---
      els.customModalClose.addEventListener('click', () => els.customModal.classList.add('hidden'));
      els.customModal.addEventListener('click', (e) => { if (e.target === els.customModal) els.customModal.classList.add('hidden'); });
      els.customModalSaveQuote.addEventListener('click', saveCustomQuote); // Para sa Phase 2
      els.customModalVerifyDp.addEventListener('click', verifyDownPayment); // Para sa Phase 4
      els.customModalRequestFinal.addEventListener('click', requestFinalPayment); // Para sa Phase 5.1
      els.customModalVerifyFinal.addEventListener('click', verifyFinalPayment);

      // --- NEW: Save Fulfillment Details ---
      async function saveFulfillmentDetails() {
        if (!selectedCustomOrder) return;

        const fulfillmentMethod = selectedCustomOrder.fulfillmentMethod;
        const data = {};

        if (fulfillmentMethod === 'delivery') {
          const trackingNumber = document.getElementById('fulfillment-tracking').value.trim();
          const deliveryDate = document.getElementById('fulfillment-delivery-date').value;

          if (trackingNumber) data.trackingNumber = trackingNumber;
          if (deliveryDate) data.estimatedDeliveryDate = deliveryDate;
        } else if (fulfillmentMethod === 'pickup') {
          const pickupDate = document.getElementById('fulfillment-pickup-date').value;
          const pickupLocation = document.getElementById('fulfillment-pickup-location').value.trim();

          if (pickupDate) data.pickupDate = pickupDate;
          if (pickupLocation) data.pickupLocation = pickupLocation;
        }

        if (Object.keys(data).length === 0) {
          alert('Please enter at least one fulfillment detail.');
          return;
        }

        const saveBtn = document.getElementById('custom-modal-save-fulfillment');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
          const res = await fetch(`${API}/api/custom-orders/${selectedCustomOrder._id}/fulfillment-details`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(data)
          });
          const result = await res.json();
          if (!res.ok || !result.success) throw new Error(result.msg || 'Failed to save fulfillment details');

          alert(result.msg || 'Fulfillment details saved!');
          
          // Update local list
          const idx = allCustomOrders.findIndex(o => o._id === selectedCustomOrder._id);
          if (idx >= 0) allCustomOrders[idx] = result.data;
          renderCustomOrders(); // Refresh the table

          els.customModal.classList.add('hidden'); // Close modal

        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Fulfillment Details';
        }
      }

      document.getElementById('custom-modal-save-fulfillment').addEventListener('click', saveFulfillmentDetails);

      // --- Initial load ---
      loadRegularOrders();
    });
  </script>
</body>

</html>