<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } .thumb { width: 96px; height: 96px; object-fit: cover; }</style>
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen bg-gray-100">
    <div id="admin-sidebar" class="hidden md:flex flex-col w-64 bg-white shadow-lg">
      <div class="flex items-center justify-center h-16 bg-white shadow-md"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span></a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span></a>
          <a href="manage-products.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span></a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span></a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span></a>
          <a href="reports.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span></a>
          <a href="settings.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md"><i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span></a>
        </nav>
      </div>
    </div>

    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full transition-transform z-50 md:hidden">
      <div class="flex items-center justify-between h-16 bg-white shadow-md px-3">
        <div class="flex items-center"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
        <button id="mobile-sidebar-close" class="p-2 rounded-md hover:bg-gray-100 text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="settings.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md"><i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span></a>
        </nav>
      </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
        <div class="flex items-center gap-3">
          <button id="sidebar-toggle" class="md:hidden p-2 rounded bg-gray-100"><i class="fas fa-bars"></i></button>
          <h1 class="text-lg font-semibold">Settings</h1>
        </div>
        <div class="flex items-center gap-4">
          <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
        </div>
      </header>

      <main class="p-6 bg-gray-50 min-h-screen">
        <div class="max-w-5xl mx-auto space-y-6">
          <!-- Settings submenu -->
          <div class="bg-white p-4 rounded shadow mb-4">
            <nav class="flex gap-3">
              <button id="settings-about-tab" class="px-4 py-2 bg-indigo-600 text-white rounded">About Us</button>
              <button id="settings-contact-tab" class="px-4 py-2 bg-gray-100 text-gray-700 rounded">Contact</button>
            </nav>
          </div>

          <div id="about-panel" class="bg-white p-6 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">About Us (Customer Page Preview)</h2>
            <div id="about-message" class="hidden p-3 rounded mb-3"></div>
            <div class="space-y-4">
              <div>
                <iframe id="about-preview" src="/client/about-us.html" class="w-full h-96 border rounded"></iframe>
                <p class="text-xs text-gray-500 mt-2">This shows the full customer About Us page. Only images below can be managed from here.</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Manage Images</label>
                <div id="about-images" class="flex gap-3 items-start flex-wrap mb-3"></div>
                <input id="about-images-input" type="file" accept="image/*" multiple class="mb-3" />
                <div class="flex gap-3">
                  <button id="about-upload" class="px-4 py-2 bg-indigo-600 text-white rounded">Upload Images</button>
                  <button id="about-refresh" class="px-4 py-2 bg-gray-200 rounded">Refresh Preview</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">You can add new images or delete existing ones. The page preview will refresh after changes.</p>
              </div>
            </div>
          </div>

          <div id="contact-panel" class="hidden bg-white p-6 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">Contact</h2>
            <div id="contact-message" class="hidden p-3 rounded mb-3"></div>
            <label class="block text-sm font-medium text-gray-700">Title</label>
            <input id="contact-title" class="w-full border p-2 rounded mb-3" />
            <label class="block text-sm font-medium text-gray-700">Content</label>
            <textarea id="contact-body" class="w-full border p-3 rounded h-40 mb-3"></textarea>
            <label class="block text-sm font-medium text-gray-700">Images</label>
            <div id="contact-images" class="flex gap-3 items-center mb-3"></div>
            <input id="contact-images-input" type="file" accept="image/*" multiple class="mb-3" />
            <div class="flex gap-3">
              <button id="contact-save" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Contact</button>
              <button id="contact-replace" class="px-4 py-2 bg-gray-200 rounded">Replace Images on Save</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    (function(){
      const API = ''; // relative to same origin
      const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

      function showMsg(el, msg, ok=true){ el.className = `p-3 rounded mb-3 ${ok? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`; el.textContent = msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3500); }

      async function loadContent(key, setters){
        try{
          const res = await fetch(`${API}/api/admin/content/${encodeURIComponent(key)}`, { headers });
          const j = await res.json();
          if (!j.success) throw new Error(j.msg || 'Failed');
          const data = j.data || {};
          setters.title.value = data.title || '';
          setters.body.value = data.body || '';
          const imagesDiv = setters.imagesDiv;
          imagesDiv.innerHTML = '';
          (data.images||[]).forEach(img => {
            const imgEl = document.createElement('div'); imgEl.className='flex flex-col items-center';
            imgEl.innerHTML = `<img src="${img.url}" class="thumb rounded border" /><div class="text-xs mt-1">${img.filename||''}</div>`;
            imagesDiv.appendChild(imgEl);
          });
        }catch(e){ console.error('loadContent',e); }
      }

      async function saveContent(key, titleEl, bodyEl, filesInput, replaceImagesFlag, msgEl){
        try{
          const fd = new FormData();
          fd.append('title', titleEl.value||'');
          fd.append('body', bodyEl.value||'');
          if (replaceImagesFlag) fd.append('replaceImages','true');
          const files = filesInput.files || [];
          for (let i=0;i<files.length;i++) fd.append('images', files[i]);
          const res = await fetch(`${API}/api/admin/content/${encodeURIComponent(key)}`, { method: 'PUT', headers: { 'Authorization': headers['Authorization'] }, body: fd });
          const j = await res.json();
          if (!res.ok) { showMsg(msgEl, j.msg||'Failed to save', false); return; }
          showMsg(msgEl, 'Saved successfully', true);
          loadContent(key, { title: titleEl, body: bodyEl, imagesDiv: key==='about-us'? document.getElementById('about-images') : document.getElementById('contact-images') });
        }catch(e){ console.error(e); showMsg(msgEl, 'Error saving content', false); }
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        // Settings tab switching
        const aboutTabBtn = document.getElementById('settings-about-tab');
        const contactTabBtn = document.getElementById('settings-contact-tab');
        const aboutPanel = document.getElementById('about-panel');
        const contactPanel = document.getElementById('contact-panel');
        function showAbout() {
          aboutPanel.classList.remove('hidden'); contactPanel.classList.add('hidden');
          aboutTabBtn.classList.add('bg-indigo-600','text-white'); aboutTabBtn.classList.remove('bg-gray-100','text-gray-700');
          contactTabBtn.classList.remove('bg-indigo-600','text-white'); contactTabBtn.classList.add('bg-gray-100','text-gray-700');
        }
        function showContact() {
          contactPanel.classList.remove('hidden'); aboutPanel.classList.add('hidden');
          contactTabBtn.classList.add('bg-indigo-600','text-white'); contactTabBtn.classList.remove('bg-gray-100','text-gray-700');
          aboutTabBtn.classList.remove('bg-indigo-600','text-white'); aboutTabBtn.classList.add('bg-gray-100','text-gray-700');
        }
        aboutTabBtn.addEventListener('click', ()=> { showAbout(); loadAbout(); });
        contactTabBtn.addEventListener('click', ()=> { showContact(); loadContact(); });
        // default: show About
        showAbout();
        // load about images for the default view
        loadAbout();
        // About: manage images only (preview shows full page)
        const aboutImagesInput = document.getElementById('about-images-input');
        const aboutImagesDiv = document.getElementById('about-images');
        const aboutMsg = document.getElementById('about-message');
        let loadedAbout = null;
        async function loadAbout(){
          try{
            const res = await fetch(`${API}/api/admin/content/about-us`, { headers });
            const j = await res.json();
            if (!j.success) { loadedAbout = { images:[] }; aboutImagesDiv.innerHTML = ''; return; }
            loadedAbout = j.data || { images: [] };
            aboutImagesDiv.innerHTML = '';
            (loadedAbout.images||[]).forEach(img => {
              const wrap = document.createElement('div'); wrap.className = 'relative flex flex-col items-center';
              wrap.style.width = '120px'; wrap.style.marginBottom = '8px'; wrap.style.marginRight = '8px';
              const imgEl = document.createElement('img'); imgEl.src = img.url; imgEl.className = 'thumb rounded border';
              imgEl.style.display = 'block';
              const name = document.createElement('div'); name.className = 'text-xs mt-1'; name.textContent = img.filename || '';
              const delBtn = document.createElement('button'); delBtn.className = 'absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center'; delBtn.innerHTML = '&times;';
              delBtn.title = 'Delete image';
              delBtn.addEventListener('click', async ()=>{
                if (!confirm('Delete this image?')) return;
                try{
                  const dres = await fetch(`${API}/api/admin/content/about-us/image`, { method: 'DELETE', headers: Object.assign({ 'Content-Type':'application/json' }, headers), body: JSON.stringify({ filename: img.filename }) });
                  const dj = await dres.json();
                  if (!dres.ok) { alert(dj.msg || 'Failed to delete'); return; }
                  // reload images and refresh preview
                  await loadAbout();
                  const ifr = document.getElementById('about-preview'); if (ifr) ifr.src = '/client/about-us.html?preview=' + Date.now();
                }catch(e){ console.error('delete image', e); alert('Error deleting image'); }
              });
              wrap.appendChild(imgEl);
              wrap.appendChild(delBtn);
              wrap.appendChild(name);
              aboutImagesDiv.appendChild(wrap);
            });
          }catch(e){ console.error('loadAbout', e); }
        }

        // Upload handler: append new images to content.images
        document.getElementById('about-upload').addEventListener('click', async ()=>{
          const files = aboutImagesInput.files || [];
          if (!files.length) { alert('Select images to upload'); return; }
          try{
            // reuse saveContent; pass empty title/body objects that have .value properties
            await saveContent('about-us', { value: '' }, { value: '' }, aboutImagesInput, false, aboutMsg);
            aboutImagesInput.value = '';
            await loadAbout();
            const ifr = document.getElementById('about-preview'); if (ifr) ifr.src = '/client/about-us.html?preview=' + Date.now();
          }catch(e){ console.error(e); alert('Failed to upload'); }
        });

        document.getElementById('about-refresh').addEventListener('click', ()=>{
          const ifr = document.getElementById('about-preview'); if (ifr) ifr.src = '/client/about-us.html?preview=' + Date.now();
        });

        // initial load when showing tab
        // loadAbout() will be called when About tab is shown (see tab click handler)

        // Contact
        const contactTitle = document.getElementById('contact-title');
        const contactBody = document.getElementById('contact-body');
        const contactImagesInput = document.getElementById('contact-images-input');
        const contactImagesDiv = document.getElementById('contact-images');
        const contactMsg = document.getElementById('contact-message');
        loadContent('contact', { title: contactTitle, body: contactBody, imagesDiv: contactImagesDiv });
        document.getElementById('contact-save').addEventListener('click', ()=> saveContent('contact', contactTitle, contactBody, contactImagesInput, false, contactMsg));
        document.getElementById('contact-replace').addEventListener('click', ()=> saveContent('contact', contactTitle, contactBody, contactImagesInput, true, contactMsg));

        // Sidebar toggle for mobile
        document.getElementById('sidebar-toggle')?.addEventListener('click', ()=> document.getElementById('admin-sidebar')?.classList.toggle('hidden'));
        document.getElementById('mobile-sidebar-close')?.addEventListener('click', ()=> document.getElementById('mobile-sidebar')?.classList.add('-translate-x-full'));
      });
    })();
  </script>
</body>
</html>
