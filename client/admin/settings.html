<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } .thumb { width: 96px; height: 96px; object-fit: cover; }</style>
  <!-- Quill WYSIWYG editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen bg-gray-100">
    <div id="admin-sidebar" class="hidden md:flex flex-col w-64 bg-white shadow-lg">
      <div class="flex items-center justify-center h-16 bg-white shadow-md"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span></a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span></a>
          <!-- Manage Products removed from sidebar -->
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span></a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span></a>
          <a href="reports.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span></a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span></a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span></a>
          <a href="settings.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md"><i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span></a>
        <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span></a>
        </nav>
      </div>
    </div>

    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full transition-transform z-50 md:hidden">
      <div class="flex items-center justify-between h-16 bg-white shadow-md px-3">
        <div class="flex items-center"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
        <button id="mobile-sidebar-close" class="p-2 rounded-md hover:bg-gray-100 text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
            <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span></a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span></a>
          <!-- Manage Products removed from sidebar -->
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span></a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span></a>
          <a href="reports.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span></a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span></a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span></a>
          <a href="settings.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md"><i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span></a>
          <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span></a>
        </nav>
      </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
        <div class="flex items-center gap-3">
          <button id="sidebar-toggle" class="md:hidden p-2 rounded bg-gray-100"><i class="fas fa-bars"></i></button>
          <h1 class="text-lg font-semibold">Settings</h1>
        </div>
        <div class="flex items-center gap-4">
          <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
        </div>
      </header>

      <main class="p-6 bg-gray-50 min-h-screen">
        <div class="max-w-5xl mx-auto space-y-6">
          <!-- Settings submenu -->
          <div class="bg-white p-4 rounded shadow mb-4">
            <nav class="flex gap-3">
              <button id="settings-about-tab" class="px-4 py-2 bg-indigo-600 text-white rounded">About Us</button>
              <button id="settings-contact-tab" class="px-4 py-2 bg-gray-100 text-gray-700 rounded">Contact</button>
            </nav>
          </div>

          <div id="about-panel" class="bg-white p-6 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">About Us (Mirror & Edit)</h2>
            <div id="about-message" class="hidden p-3 rounded mb-3"></div>

            <!-- Mirrored About Us layout (full page content inserted here). -->
            <div id="about-mirror-wrapper" class="mb-4">
              <div id="about-mirror" class="bg-white border p-3 rounded min-h-[320px]"></div>
            </div>

            <!-- Save/Cancel -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex-1">
                <button id="about-cancel" class="w-full sm:w-auto px-4 py-2 bg-gray-200 rounded">Cancel</button>
              </div>
              <div class="flex-1 sm:flex sm:justify-end">
                <button id="about-save" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded">Save</button>
              </div>
            </div>
          </div>

          <div id="contact-panel" class="hidden bg-white p-6 rounded shadow">
            <h2 class="text-lg font-semibold mb-3">Contact</h2>
            <div id="contact-message" class="hidden p-3 rounded mb-3"></div>
            <label class="block text-sm font-medium text-gray-700">Title</label>
            <input id="contact-title" class="w-full border p-2 rounded mb-3" />
            <label class="block text-sm font-medium text-gray-700">Content</label>
            <textarea id="contact-body" class="w-full border p-3 rounded h-40 mb-3"></textarea>
            <label class="block text-sm font-medium text-gray-700">Images</label>
            <div id="contact-images" class="flex gap-3 items-center mb-3"></div>
            <input id="contact-images-input" type="file" accept="image/*" multiple class="mb-3" />
            <div class="flex gap-3">
              <button id="contact-save" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Contact</button>
              <button id="contact-replace" class="px-4 py-2 bg-gray-200 rounded">Replace Images on Save</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
  
    (function(){
      const API = ''; // relative to same origin
      const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

      function showMsg(el, msg, ok=true){ el.className = `p-3 rounded mb-3 ${ok? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`; el.textContent = msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3500); }

      async function loadContent(key, setters){
        try{
          const res = await fetch(`${API}/api/admin/content/${encodeURIComponent(key)}`, { headers });
          const j = await res.json();
          if (!j.success) throw new Error(j.msg || 'Failed');
          const data = j.data || {};
          setters.title.value = data.title || '';
          setters.body.value = data.body || '';
          const imagesDiv = setters.imagesDiv;
          imagesDiv.innerHTML = '';
          (data.images||[]).forEach(img => {
            const imgEl = document.createElement('div'); imgEl.className='flex flex-col items-center';
            imgEl.innerHTML = `<img src="${img.url}" class="thumb rounded border" /><div class="text-xs mt-1">${img.filename||''}</div>`;
            imagesDiv.appendChild(imgEl);
          });
        }catch(e){ console.error('loadContent',e); }
      }

      async function saveContent(key, titleEl, bodyEl, filesInput, replaceImagesFlag, msgEl){
        try{
          const fd = new FormData();
          fd.append('title', titleEl.value||'');
          fd.append('body', bodyEl.value||'');
          if (replaceImagesFlag) fd.append('replaceImages','true');
          const files = filesInput.files || [];
          for (let i=0;i<files.length;i++) fd.append('images', files[i]);
          const res = await fetch(`${API}/api/admin/content/${encodeURIComponent(key)}`, { method: 'PUT', headers: { 'Authorization': headers['Authorization'] }, body: fd });
          const j = await res.json();
          if (!res.ok) { showMsg(msgEl, j.msg||'Failed to save', false); return; }
          showMsg(msgEl, 'Saved successfully', true);
          loadContent(key, { title: titleEl, body: bodyEl, imagesDiv: key==='about-us'? document.getElementById('about-images') : document.getElementById('contact-images') });
        }catch(e){ console.error(e); showMsg(msgEl, 'Error saving content', false); }
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        // Settings tab switching
        const aboutTabBtn = document.getElementById('settings-about-tab');
        const contactTabBtn = document.getElementById('settings-contact-tab');
        const aboutPanel = document.getElementById('about-panel');
        const contactPanel = document.getElementById('contact-panel');
        function showAbout() {
          aboutPanel.classList.remove('hidden'); contactPanel.classList.add('hidden');
          aboutTabBtn.classList.add('bg-indigo-600','text-white'); aboutTabBtn.classList.remove('bg-gray-100','text-gray-700');
          contactTabBtn.classList.remove('bg-indigo-600','text-white'); contactTabBtn.classList.add('bg-gray-100','text-gray-700');
        }
        function showContact() {
          contactPanel.classList.remove('hidden'); aboutPanel.classList.add('hidden');
          contactTabBtn.classList.add('bg-indigo-600','text-white'); contactTabBtn.classList.remove('bg-gray-100','text-gray-700');
          aboutTabBtn.classList.remove('bg-indigo-600','text-white'); aboutTabBtn.classList.add('bg-gray-100','text-gray-700');
        }
        aboutTabBtn.addEventListener('click', ()=> { showAbout(); loadAbout(); });
        contactTabBtn.addEventListener('click', ()=> { showContact(); loadContact(); });
        // default: show About and initialize editor + image management
        showAbout();

        // Mirror-based editor: inject the full About Us HTML into `#about-mirror`,
        // make text nodes editable and provide per-image delete/replace controls.
        const aboutMsg = document.getElementById('about-message');
        const mirror = document.getElementById('about-mirror');
        let loadedAbout = null;
        // imageState: { id: { originalSrc, deleted, replaceFile } }
        const imageState = {};

        // make textual elements editable inside the mirror
        function makeEditable(root){
          const selectors = 'h1,h2,h3,h4,p,li,blockquote,figcaption,span';
          const nodes = root.querySelectorAll(selectors);
          let idCounter = 0;
          nodes.forEach(n => {
            // skip elements that are likely decorative or code
            if (n.closest('nav') || n.closest('button') || n.closest('form')) return;
            if (!n.dataset.editId){
              n.dataset.editId = 'edit-' + (++idCounter);
              n.contentEditable = 'true';
              n.classList.add('outline-none','focus:ring','focus:ring-indigo-200');
            }
          });
        }

        // add inline image controls for every image in the mirror
        function setupImageControls(root){
          const imgs = Array.from(root.querySelectorAll('img'));
          imgs.forEach((img, idx) => {
            // assign stable id
            const id = img.dataset.adminId || ('img-' + idx + '-' + Date.now());
            img.dataset.adminId = id;
            if (!imageState[id]) imageState[id] = { originalSrc: img.src, deleted: false, replaceFile: null };

            // create wrapper if not already wrapped
            if (!img.parentElement.classList.contains('admin-img-wrap')){
              const wrap = document.createElement('div'); wrap.className = 'admin-img-wrap relative inline-block';
              img.parentElement.insertBefore(wrap, img);
              wrap.appendChild(img);
              // controls overlay
              const ctrl = document.createElement('div'); ctrl.className = 'absolute top-1 right-1 flex gap-1 z-20';
              // delete
              const del = document.createElement('button'); del.className='px-2 py-1 bg-red-600 text-white text-xs rounded'; del.textContent='Delete';
              del.addEventListener('click', ()=>{
                if (!confirm('Delete this image from About Us?')) return;
                imageState[id].deleted = true;
                img.style.opacity = '0.4';
              });
              // replace
              const replLabel = document.createElement('label'); replLabel.className='px-2 py-1 bg-gray-200 text-xs rounded cursor-pointer'; replLabel.textContent='Replace';
              const replInput = document.createElement('input'); replInput.type='file'; replInput.accept='image/*'; replInput.className='hidden';
              replInput.addEventListener('change', ()=>{
                const f = replInput.files && replInput.files[0]; if (!f) return;
                imageState[id].replaceFile = f; imageState[id].deleted = false; // undo delete if replaced
                const reader = new FileReader(); reader.onload = (e)=>{ img.src = e.target.result; img.style.opacity='1'; };
                reader.readAsDataURL(f);
              });
              replLabel.appendChild(replInput);
              replLabel.addEventListener('click', ()=> replInput.click());

              ctrl.appendChild(del); ctrl.appendChild(replLabel);
              wrap.appendChild(ctrl);
            }
          });
        }

        async function loadAbout(){
          try{
            const res = await fetch(`${API}/api/admin/content/about-us`, { headers });
            if (!res.ok){
              // fallback to static page
              const htmlRes = await fetch('/client/about-us.html');
              if (!htmlRes.ok){ loadedAbout = { body:'', images:[] }; mirror.innerHTML = '<div class="p-4 text-sm text-gray-600">No About content found.</div>'; return; }
              const text = await htmlRes.text();
              const parser = new DOMParser(); const doc = parser.parseFromString(text, 'text/html');
              // try to locate the main about container by heading
              let aboutEl = null; const headings = doc.querySelectorAll('h1,h2,h3');
              for (let h of headings) if (/about\s*us/i.test(h.textContent||'')){ aboutEl = h; break; }
              const container = aboutEl ? (aboutEl.closest('section') || aboutEl.parentElement) : doc.body;
              loadedAbout = { title:'', body: container.innerHTML, images: Array.from(container.querySelectorAll('img')).map(im=>({ filename: im.getAttribute('data-filename')||'', url: im.src })) };
              mirror.innerHTML = loadedAbout.body || '';
              makeEditable(mirror); setupImageControls(mirror);
              return;
            }
            // parse JSON
            const j = await res.json();
            if (!j.success){ loadedAbout = { body:'', images:[] }; mirror.innerHTML = '<div class="p-4 text-sm text-gray-600">No About content available.</div>'; return; }
            loadedAbout = j.data || { body:'', images:[] };
            // inject full body HTML into the mirror. However, prefer the static client page
            // if it contains more images (covers cases where About is hard-coded on user page).
            try{
              const staticRes = await fetch('/client/about-us.html');
              if (staticRes.ok){
                const staticText = await staticRes.text();
                const parser = new DOMParser(); const staticDoc = parser.parseFromString(staticText, 'text/html');
                const staticImgCount = (staticDoc.querySelectorAll('img')||[]).length;
                const jsonImgCount = ((loadedAbout.body||'').match(/<img\b/gi)||[]).length;
                if (staticImgCount > jsonImgCount){
                  // use full static body to ensure all images/sections appear
                  mirror.innerHTML = staticDoc.body.innerHTML || (loadedAbout.body || '');
                  loadedAbout.body = mirror.innerHTML;
                  makeEditable(mirror); setupImageControls(mirror);
                  return;
                }
              }
            }catch(e){ /* ignore - fall back to API body */ }

            mirror.innerHTML = loadedAbout.body || '';
            // ensure images and text are editable
            makeEditable(mirror);
            // fetch images from images/aboutus folder (or images/<key>) and append any missing images
            try{
              const imgsRes = await fetch(`${API}/api/admin/content/about-us/images`, { headers });
              if (imgsRes.ok){
                const imgsJson = await imgsRes.json();
                const files = imgsJson && imgsJson.data ? imgsJson.data : [];
                if (files.length){
                  // ensure there's a container for extra images
                  let panel = mirror.querySelector('.admin-images-panel');
                  if (!panel){ panel = document.createElement('div'); panel.className = 'admin-images-panel grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6'; mirror.appendChild(panel); }
                  files.forEach(f => {
                    // if not already present in DOM, add it
                    if (!mirror.querySelector(`img[src="${f.url}"]`)){
                      const wrap = document.createElement('div'); wrap.className = 'border p-2 rounded';
                      const im = document.createElement('img'); im.src = f.url; im.className = 'w-full h-auto'; im.setAttribute('data-filename', f.filename);
                      wrap.appendChild(im);
                      panel.appendChild(wrap);
                    }
                  });
                }
              }
            }catch(e){ /* ignore image-list errors */ }
            setupImageControls(mirror);
          }catch(e){ console.error('loadAbout', e); showMsg(aboutMsg, 'Failed to load About content', false); }
        }

        // initial load
        loadAbout();

        // Save: collect mirrored HTML and image replacements/deletions
        document.getElementById('about-save').addEventListener('click', async ()=>{
          const saveBtn = document.getElementById('about-save');
          const cancelBtn = document.getElementById('about-cancel');
          saveBtn.disabled = true; cancelBtn.disabled = true; saveBtn.classList.add('opacity-50');
          try{
            // gather deletions
            const deletions = Object.keys(imageState).filter(k=>imageState[k].deleted).map(k=>imageState[k].originalSrc);
            // gather replacement files
            const fd = new FormData();
            const bodyHtml = mirror.innerHTML || '';
            fd.append('body', bodyHtml);
            // append deletions as JSON
            if (deletions.length) fd.append('deleted', JSON.stringify(deletions));
            Object.keys(imageState).forEach(key => {
              const s = imageState[key]; if (s.replaceFile) fd.append('images', s.replaceFile);
            });

            const res = await fetch(`${API}/api/admin/content/about-us`, { method: 'PUT', headers: { 'Authorization': headers['Authorization'] }, body: fd });
            const j = await res.json();
            if (!res.ok){ showMsg(aboutMsg, j.msg||'Failed to save', false); return; }
            showMsg(aboutMsg, 'Saved successfully', true);
            // reload latest from server
            for (let k of Object.keys(imageState)) delete imageState[k];
            await loadAbout();
            fetch('/client/about-us.html?preview=' + Date.now()).catch(()=>{});
          }catch(e){ console.error('saveAbout', e); showMsg(aboutMsg, 'Error saving content', false); }
          finally{ saveBtn.disabled = false; cancelBtn.disabled = false; saveBtn.classList.remove('opacity-50'); }
        });

        // Cancel: restore mirror to last loaded state
        document.getElementById('about-cancel').addEventListener('click', ()=>{
          if (!loadedAbout) return;
          mirror.innerHTML = loadedAbout.body || '';
          for (let k of Object.keys(imageState)) delete imageState[k];
          makeEditable(mirror); setupImageControls(mirror);
          showMsg(aboutMsg, 'Reverted changes', true);
        });

        // Contact
        const contactTitle = document.getElementById('contact-title');
        const contactBody = document.getElementById('contact-body');
        const contactImagesInput = document.getElementById('contact-images-input');
        const contactImagesDiv = document.getElementById('contact-images');
        const contactMsg = document.getElementById('contact-message');
        loadContent('contact', { title: contactTitle, body: contactBody, imagesDiv: contactImagesDiv });
        document.getElementById('contact-save').addEventListener('click', ()=> saveContent('contact', contactTitle, contactBody, contactImagesInput, false, contactMsg));
        document.getElementById('contact-replace').addEventListener('click', ()=> saveContent('contact', contactTitle, contactBody, contactImagesInput, true, contactMsg));

        // Sidebar toggle for mobile
        document.getElementById('sidebar-toggle')?.addEventListener('click', ()=> document.getElementById('admin-sidebar')?.classList.toggle('hidden'));
        document.getElementById('mobile-sidebar-close')?.addEventListener('click', ()=> document.getElementById('mobile-sidebar')?.classList.add('-translate-x-full'));
      });
    })();
  </script>
  <script src="admin-notifications.js"></script>
</body>
</html>
