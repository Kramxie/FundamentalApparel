<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex bg-gray-100">
        <!-- Sidebar -->
        <aside id="admin-sidebar" class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-16 bg-white shadow-md"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
            <div class="flex flex-col flex-grow p-4">
                 <nav class="flex-grow space-y-2">
                    <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
                    </a>
                    <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
                    </a>
                     <a href="manage-products.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
                        <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
                    </a>
                    <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
                    </a>
                    <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
                    </a>
                    <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
                    </a>
                    <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
                    </a>
                    <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span>
                    </a>
                </nav>
            </div>
        </aside>
        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <header class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
                <div class="flex items-center gap-3">
                    <button id="sidebar-toggle" class="md:hidden p-2 rounded bg-gray-100">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-lg font-semibold">Edit Product</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </header>
            <main class="p-4 md:p-6 overflow-y-auto">
                <div id="message" class="hidden mb-4 p-3 rounded-md"></div>
                
                <form id="edit-product-form" class="max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Left Column: Form Fields -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- General Information -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">General Information</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="name" class="block text-sm font-medium text-gray-700">Product Name</label>
                                        <input type="text" id="name" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                    </div>
                                    <div>
                                        <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                        <select id="category" name="category" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                            <option>Jersey</option>
                                            <option>Shorts</option>
                                            <option>Outwears</option>
                                            <option>Lab Coats</option>
                                            <option>Printing Machine</option>
                                            <option>Banner</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="price" class="block text-sm font-medium text-gray-700">Price (â‚±)</label>
                                        <input type="number" id="price" name="price" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                    </div>
                                    <div>
                                        <label for="countInStock" class="block text-sm font-medium text-gray-700">Stock Quantity</label>
                                        <input type="number" id="countInStock" name="countInStock" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                    </div>
                                </div>
                            </div>

                            <!-- Product Details -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Product Details</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="description" class="block text-sm font-medium text-gray-700">Short Description</label>
                                        <textarea id="description" name="description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border"></textarea>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label for="sizes" class="block text-sm font-medium text-gray-700">Sizes</label>
                                            <input type="text" id="sizes" name="sizes" placeholder="e.g., S, M, L, XL" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                        </div>
                                        <div>
                                            <label for="colors" class="block text-sm font-medium text-gray-700">Colors</label>
                                            <input type="text" id="colors" name="colors" placeholder="e.g., Red, Blue, Green" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                        </div>
                                        <div>
                                            <label for="material" class="block text-sm font-medium text-gray-700">Material</label>
                                            <input type="text" id="material" name="material" placeholder="e.g., Cotton, Polyester" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="productDetails" class="block text-sm font-medium text-gray-700">Additional Details</label>
                                        <textarea id="productDetails" name="productDetails" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border" placeholder="Title::Content||Title2::Content2"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Use '::' to separate title and content, and '||' to separate entries.</p>
                                    </div>
                                                                        <div>
                                                                                <label class="block text-sm font-medium text-gray-700">Per-size inventory (optional)</label>
                                                                                <div class="mt-1 space-y-2">
                                                                                    <div class="flex gap-2">
                                                                                        <input id="sizes" name="sizes" placeholder="e.g., S, M, L, XL" class="flex-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border">
                                                                                        <button id="generate-sizes-btn" type="button" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Generate</button>
                                                                                    </div>
                                                                                    <div id="sizes-rows" class="space-y-2"></div>
                                                                                    <div class="flex gap-2">
                                                                                        <button id="add-size-row" type="button" class="px-3 py-2 bg-green-600 text-white rounded-md">Add Size</button>
                                                                                        <button id="clear-sizes" type="button" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-md">Clear</button>
                                                                                    </div>
                                                                                    <input type="hidden" id="sizesInventoryHidden" name="sizesInventory">
                                                                                    <p class="text-xs text-gray-500 mt-1">Use the controls to set per-size quantities. The values will be submitted as a JSON object.</p>
                                                                                </div>
                                                                        </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Preview & Actions -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Main Image Upload -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Main Image</h2>
                                <div id="main-image-preview" class="w-full h-64 bg-gray-50 rounded-md flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden relative group">
                                    <div id="no-main-image" class="text-center text-gray-400">
                                        <i class="fas fa-image text-4xl mb-2"></i>
                                        <p class="text-sm">No Image Uploaded</p>
                                    </div>
                                    <img id="main-image-display" class="hidden w-full h-full object-contain" alt="Main product image">
                                </div>
                                <input type="file" id="main-image-input" accept="image/*" class="hidden">
                                <button type="button" id="main-image-btn" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-upload mr-2"></i><span id="main-btn-text">Choose main image</span>
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Click to upload or change main image</p>
                            </div>
                            
                            <!-- Gallery Images Upload -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Image Gallery</h2>
                                <div id="gallery-preview" class="grid grid-cols-2 gap-3 mb-3">
                                    <div class="col-span-2 text-center py-8 text-gray-400">
                                        <i class="fas fa-images text-3xl mb-2"></i>
                                        <p class="text-sm">No Image Uploaded</p>
                                    </div>
                                </div>
                                <input type="file" id="gallery-input" accept="image/*" multiple class="hidden">
                                <button type="button" id="gallery-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Add Gallery Images
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Upload multiple images (up to 8)</p>
                            </div>
                            
                            <!-- Actions -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Actions</h2>
                                <div class="flex flex-col gap-3">
                                    <button id="submit-btn" type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <i class="fas fa-save mr-2"></i>Update Product
                                    </button>
                                    <a href="manage-products.html" class="w-full text-center px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </a>
                                </div>
                            </div>

                            <!-- Product Info Card -->
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-semibold mb-1">Editing Product</p>
                                        <p class="text-xs">Make changes to the product details and click "Update Product" to save.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </main>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API = 'https://fundamental-apparel-backend.onrender.com';
        const token = localStorage.getItem('adminToken');

        // Auth check
        if (!token) {
            window.location.href = 'login.html';
        }

        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('admin-sidebar');
        sidebarToggle?.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        });

        // DOM Elements
        const editForm = document.getElementById('edit-product-form');
        const messageEl = document.getElementById('message');
        
        // Image upload elements
        const mainImageInput = document.getElementById('main-image-input');
        const mainImageBtn = document.getElementById('main-image-btn');
        const mainImageDisplay = document.getElementById('main-image-display');
        const noMainImage = document.getElementById('no-main-image');
        const mainBtnText = document.getElementById('main-btn-text');
        
        const galleryInput = document.getElementById('gallery-input');
        const galleryBtn = document.getElementById('gallery-btn');
        const galleryPreview = document.getElementById('gallery-preview');

        // State
        let currentMainImage = null; // Existing image URL
        let newMainImageFile = null; // New uploaded file
        let existingGallery = []; // Existing gallery URLs
        let newGalleryFiles = []; // New uploaded files
        let deletedGalleryImages = []; // URLs to delete

        // SizesInventory helpers
        const sizesRowsContainer = document.getElementById('sizes-rows');
        const sizesHidden = document.getElementById('sizesInventoryHidden');
        const generateSizesBtn = document.getElementById('generate-sizes-btn');
        const addSizeRowBtn = document.getElementById('add-size-row');
        const clearSizesBtn = document.getElementById('clear-sizes');

        function renderSizeRows(obj) {
            if (!sizesRowsContainer) return;
            sizesRowsContainer.innerHTML = '';
            const data = obj || {};
            Object.keys(data).forEach(size => {
                const qty = data[size];
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                  <input class="flex-1 border rounded p-2" data-size-input type="text" value="${size}" />
                  <input class="w-24 border rounded p-2" data-qty-input type="number" min="0" value="${Number(qty)||0}" />
                  <button type="button" class="px-3 py-2 bg-red-600 text-white rounded-md" data-remove>Remove</button>
                `;
                row.querySelector('[data-remove]').addEventListener('click', () => { row.remove(); });
                sizesRowsContainer.appendChild(row);
            });
        }

        function getSizesInventoryObject() {
            const obj = {};
            if (!sizesRowsContainer) return obj;
            const rows = sizesRowsContainer.querySelectorAll('div');
            rows.forEach(row => {
                const sizeInput = row.querySelector('[data-size-input]');
                const qtyInput = row.querySelector('[data-qty-input]');
                if (!sizeInput || !qtyInput) return;
                const size = String(sizeInput.value||'').trim();
                const qty = Number(qtyInput.value||0);
                if (size) obj[size] = Math.max(0, Math.floor(qty));
            });
            return obj;
        }

        generateSizesBtn?.addEventListener('click', () => {
            const sizesText = document.getElementById('sizes').value || '';
            const sizes = sizesText.split(',').map(s => s.trim()).filter(Boolean);
            const obj = {};
            sizes.forEach(s => { obj[s] = obj[s] || 0; });
            renderSizeRows(obj);
        });

        addSizeRowBtn?.addEventListener('click', () => {
            renderSizeRows(Object.assign(getSizesInventoryObject(), { '': 0 }));
            const last = sizesRowsContainer.querySelector('div:last-child [data-size-input]');
            if (last) last.focus();
        });

        clearSizesBtn?.addEventListener('click', () => {
            if (sizesRowsContainer) sizesRowsContainer.innerHTML = '';
        });

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            showMessage('No product ID found. Redirecting...', 'error');
            setTimeout(() => window.location.href = 'manage-products.html', 2000);
        }

        function showMessage(text, type = 'success') {
            messageEl.textContent = text;
            messageEl.className = `mb-4 p-3 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageEl.classList.remove('hidden');
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }

        // Main Image Upload Handler
        mainImageBtn.addEventListener('click', () => {
            mainImageInput.click();
        });

        mainImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                newMainImageFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    mainImageDisplay.src = event.target.result;
                    mainImageDisplay.classList.remove('hidden');
                    noMainImage.classList.add('hidden');
                    mainBtnText.textContent = 'Edit Main Image';
                };
                reader.readAsDataURL(file);
            }
        });

        // Gallery Upload Handler
        galleryBtn.addEventListener('click', () => {
            galleryInput.click();
        });

        galleryInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                files.forEach(file => {
                    newGalleryFiles.push(file);
                });
                renderGallery();
            }
        });

        function renderGallery() {
            const allImages = [...existingGallery, ...newGalleryFiles];
            
            if (allImages.length === 0) {
                galleryPreview.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-400">
                        <i class="fas fa-images text-3xl mb-2"></i>
                        <p class="text-sm">No Image Uploaded</p>
                    </div>
                `;
                return;
            }

            galleryPreview.innerHTML = '';
            
            // Render existing images
            existingGallery.forEach((url, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'relative bg-white border-2 border-gray-200 rounded-lg p-2 group';
                imageCard.innerHTML = `
                    <img src="${url}" class="w-full h-32 object-contain rounded" alt="Gallery image ${index + 1}">
                    <button type="button" class="absolute top-1 right-1 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteExistingImage(${index})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-1">Existing</p>
                `;
                galleryPreview.appendChild(imageCard);
            });

            // Render new uploaded files
            newGalleryFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'relative bg-white border-2 border-green-200 rounded-lg p-2 group';
                    imageCard.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-32 object-contain rounded" alt="New image ${index + 1}">
                        <button type="button" class="absolute top-1 right-1 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteNewImage(${index})">
                            <i class="fas fa-times"></i> Remove
                        </button>
                        <p class="text-xs text-green-600 text-center mt-1">New</p>
                    `;
                    galleryPreview.appendChild(imageCard);
                };
                reader.readAsDataURL(file);
            });
        }

        // Global functions for delete buttons
        window.deleteExistingImage = (index) => {
            const deletedUrl = existingGallery[index];
            deletedGalleryImages.push(deletedUrl);
            existingGallery.splice(index, 1);
            renderGallery();
            showMessage('Image marked for deletion', 'success');
        };

        window.deleteNewImage = (index) => {
            newGalleryFiles.splice(index, 1);
            renderGallery();
        };

        // Fetch and populate product data
        async function loadProduct() {
            try {
                const response = await fetch(`${API}/api/products/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    const product = result.data;
                    
                    // Populate form fields
                    document.getElementById('name').value = product.name || '';
                    document.getElementById('category').value = product.category || '';
                    document.getElementById('price').value = product.price || '';
                    document.getElementById('countInStock').value = product.countInStock || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('sizes').value = Array.isArray(product.sizes) ? product.sizes.join(', ') : '';
                    document.getElementById('colors').value = Array.isArray(product.colors) ? product.colors.join(', ') : '';
                    document.getElementById('material').value = product.material || '';
                    document.getElementById('productDetails').value = product.productDetails || '';
                                        // Populate per-size rows if available
                                        try {
                                            if (product.sizesInventory && Object.keys(product.sizesInventory || {}).length > 0) {
                                                renderSizeRows(product.sizesInventory);
                                            } else if (Array.isArray(product.sizes) && product.sizes.length > 0) {
                                                const obj = {};
                                                product.sizes.forEach(s => obj[s] = obj[s] || 0);
                                                renderSizeRows(obj);
                                            }
                                        } catch (e) {
                                            console.warn('Could not render sizesInventory', e);
                                        }
                    
                    // Set main image
                    if (product.imageUrl) {
                        currentMainImage = product.imageUrl;
                        mainImageDisplay.src = product.imageUrl;
                        mainImageDisplay.classList.remove('hidden');
                        noMainImage.classList.add('hidden');
                        mainBtnText.textContent = 'Edit Main Image';
                    }
                    
                    // Set gallery images
                    if (Array.isArray(product.gallery) && product.gallery.length > 0) {
                        existingGallery = [...product.gallery];
                        renderGallery();
                    }
                } else {
                    throw new Error(result.msg || 'Failed to load product');
                }
            } catch (error) {
                showMessage(`Error loading product: ${error.message}`, 'error');
            }
        }

        // Handle form submission
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

            try {
                const formData = new FormData();
                
                // Add text fields manually (not from form to avoid duplicates)
                formData.append('name', document.getElementById('name').value);
                formData.append('category', document.getElementById('category').value);
                formData.append('price', parseFloat(document.getElementById('price').value));
                formData.append('countInStock', parseInt(document.getElementById('countInStock').value, 10));
                formData.append('description', document.getElementById('description').value);
                formData.append('material', document.getElementById('material').value);
                formData.append('productDetails', document.getElementById('productDetails').value);
                formData.append('faqs', document.getElementById('faqs').value);
                
                const sizes = document.getElementById('sizes').value;
                const colors = document.getElementById('colors').value;
                
                formData.append('sizes', sizes ? sizes.split(',').map(s => s.trim()).join(',') : '');
                formData.append('colors', colors ? colors.split(',').map(c => c.trim()).join(',') : '');

                // Append sizesInventory JSON
                try {
                    formData.append('sizesInventory', JSON.stringify(getSizesInventoryObject()));
                } catch (e) {
                    formData.append('sizesInventory', '');
                }
                
                // Handle main image
                if (newMainImageFile) {
                    formData.append('mainImage', newMainImageFile);
                } else if (currentMainImage) {
                    formData.append('existingMainImage', currentMainImage);
                }
                
                // Handle gallery images
                newGalleryFiles.forEach(file => {
                    formData.append('galleryImages', file);
                });
                
                if (existingGallery.length > 0) {
                    formData.append('existingGallery', JSON.stringify(existingGallery));
                }
                
                if (deletedGalleryImages.length > 0) {
                    formData.append('deletedGallery', JSON.stringify(deletedGalleryImages));
                }

                const response = await fetch(`${API}/api/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('Product updated successfully! Redirecting...', 'success');
                    setTimeout(() => window.location.href = 'manage-products.html', 2000);
                } else {
                    throw new Error(result.msg || 'Failed to update product');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Product';
            }
        });

        // Load product data on page load
        loadProduct();
    </script>
</body>
</html>

