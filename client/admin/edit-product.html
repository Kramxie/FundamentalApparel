<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex bg-gray-100">
        <!-- Sidebar -->
        <aside id="admin-sidebar" class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-16 bg-white shadow-md"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
            <div class="flex flex-col flex-grow p-4">
                 <nav class="flex-grow space-y-2">
                    <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
                    </a>
                    <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
                    </a>
                     <a href="manage-products.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
                        <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
                    </a>
                    <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
                    </a>
                    <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
                    </a>
                    <a href="reports.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
                    </a>
                    <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
                    </a>
                    <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
                    </a>
                    <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span>
                    </a>
                </nav>
            </div>
        </aside>
        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <header class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
                <div class="flex items-center gap-3">
                    <button id="sidebar-toggle" class="md:hidden p-2 rounded bg-gray-100">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-lg font-semibold">Edit Product</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </header>
            <main class="p-4 md:p-6 overflow-y-auto">
                <div id="message" class="hidden mb-4 p-3 rounded-md"></div>
                
                <form id="edit-product-form" class="max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Left Column: Form Fields -->
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="number" id="price" name="price" step="0.01" required class="w-full sm:w-48 md:w-44 lg:w-56 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                            <button id="assign-price-btn" type="button" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Assign</button>
                                        </div>
                            <!-- General Information -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">General Information</h2>
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="number" id="countInStock" name="countInStock" required class="w-full sm:w-48 md:w-44 lg:w-56 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                            <button id="assign-stock-btn" type="button" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Assign</button>
                                        </div>
                                    <script src="admin-notifications.js"></script>
                                    </div>
                                </body>
                                </html>
                                    </div>
                                    <div>
                                        <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                        <select id="category" name="category" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                            <option>Jersey</option>
                                            <option>Shorts</option>
                                            <option>Outwears</option>
                                            <option>Lab Coats</option>
                                            <option>Printing Machine</option>
                                            <option>Banner</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="price" class="block text-sm font-medium text-gray-700">Price (₱)</label>
                                        <input type="number" id="price" name="price" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                    </div>
                                    <div>
                                        <label for="countInStock" class="block text-sm font-medium text-gray-700">Stock Quantity</label>
                                        <input type="number" id="countInStock" name="countInStock" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                    </div>
                                </div>
                            </div>

                            <!-- Product Details -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Product Details</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="description" class="block text-sm font-medium text-gray-700">Short Description</label>
                                        <textarea id="description" name="description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border"></textarea>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label for="sizes" class="block text-sm font-medium text-gray-700">Sizes</label>
                                                        <input type="text" id="sizes" name="sizes" placeholder="e.g., S, M, L, XL" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                        </div>
                                        <div id="colors-section">
                                            <label for="colors" class="block text-sm font-medium text-gray-700">Colors</label>
                                            <input type="text" id="colors" name="colors" placeholder="e.g., Red, Blue, Green" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                        </div>
                                        <div id="materials-section">
                                            <label for="material" class="block text-sm font-medium text-gray-700">Material</label>
                                            <input type="text" id="material" name="material" placeholder="e.g., Cotton, Polyester" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="productDetails" class="block text-sm font-medium text-gray-700">Additional Details</label>
                                        <textarea id="productDetails" name="productDetails" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border" placeholder="Title::Content||Title2::Content2"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Use '::' to separate title and content, and '||' to separate entries.</p>
                                    </div>
                                                                        <div id="per-size-section">
                                                                            <label class="block text-sm font-medium text-gray-700">Per-size inventory (optional)</label>
                                                                            <div class="mt-1 space-y-2">
                                                                                    <div class="flex gap-2">
                                                                                        <input id="sizes-generate" name="sizesGenerate" placeholder="e.g., S, M, L, XL" class="flex-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border">
                                                                                        <button id="generate-sizes-btn" type="button" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Generate</button>
                                                                                    </div>
                                                                                        <div class="flex items-center gap-2 mt-2">
                                                                                            <input id="apply-qty-input" type="number" min="0" placeholder="Qty to apply" class="w-36 border rounded p-2" />
                                                                                            <button id="apply-qty-btn" type="button" class="px-3 py-2 bg-blue-600 text-white rounded-md">Apply to selected sizes</button>
                                                                                            <span class="text-xs text-gray-500">Select sizes and apply one quantity to all selected.</span>
                                                                                        </div>
                                                                                        <div id="sizes-rows" class="space-y-2 mt-2"></div>
                                                                                        <div class="flex gap-2">
                                                                                            <button id="add-size-row" type="button" class="px-3 py-2 bg-green-600 text-white rounded-md">Add Size</button>
                                                                                            <button id="clear-sizes" type="button" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-md">Clear</button>
                                                                                        </div>
                                                                                    <input type="hidden" id="sizesInventoryHidden" name="sizesInventory">
                                                                                    <p class="text-xs text-gray-500 mt-1">Use the controls to set per-size quantities. The values will be submitted as a JSON object.</p>
                                                                                </div>
                                                                        </div>
                                                                                                                                                <div id="per-price-section" class="mt-4">
                                                                                                                                                                <label class="block text-sm font-medium text-gray-700">Per-size price (optional)</label>
                                                                                                                                                                <div class="mt-1 space-y-2">
                                                                                                                                                                    <div class="flex gap-2">
                                                                                                                                                                        <input id="sizes-for-price" placeholder="e.g., S, M, L" class="flex-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 border">
                                                                                                                                                                        <button id="generate-price-sizes-btn" type="button" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Generate</button>
                                                                                                                                                                    </div>
                                                                                                                                                                        <div class="flex items-center gap-2 mt-2">
                                                                                                                                                                            <input id="apply-price-input" type="number" step="0.01" min="0" placeholder="Price to apply" class="w-40 border rounded p-2" />
                                                                                                                                                                            <button id="apply-price-btn" type="button" class="px-3 py-2 bg-blue-600 text-white rounded-md">Apply to selected sizes</button>
                                                                                                                                                                            <span class="text-xs text-gray-500">Select sizes and apply one price to all selected.</span>
                                                                                                                                                                        </div>
                                                                                                                                                                        <div id="prices-rows" class="space-y-2 mt-2"></div>
                                                                                                                                                                        <div class="flex gap-2">
                                                                                                                                                                            <button id="add-price-row" type="button" class="px-3 py-2 bg-green-600 text-white rounded-md">Add Price Row</button>
                                                                                                                                                                            <button id="clear-prices" type="button" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-md">Clear</button>
                                                                                                                                                                        </div>
                                                                                                                                                                    <input type="hidden" id="sizesPriceHidden" name="sizesPrice">
                                                                                                                                                                    <p class="text-xs text-gray-500 mt-1">Set per-size prices. Values will be submitted as a JSON object.</p>
                                                                                                                                                                </div>
                                                                                                                                                </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Preview & Actions -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Main Image Upload -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Main Image</h2>
                                <div id="main-image-preview" class="w-full h-64 bg-gray-50 rounded-md flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden relative group">
                                    <div id="no-main-image" class="text-center text-gray-400">
                                        <i class="fas fa-image text-4xl mb-2"></i>
                                        <p class="text-sm">No Image Uploaded</p>
                                    </div>
                                    <img id="main-image-display" class="hidden w-full h-full object-contain" alt="Main product image">
                                </div>
                                <input type="file" id="main-image-input" accept="image/*" class="hidden">
                                <button type="button" id="main-image-btn" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-upload mr-2"></i><span id="main-btn-text">Choose main image</span>
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Click to upload or change main image</p>
                            </div>
                            
                            <!-- Gallery Images Upload -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Image Gallery</h2>
                                <div id="gallery-preview" class="grid grid-cols-2 gap-3 mb-3">
                                    <div class="col-span-2 text-center py-8 text-gray-400">
                                        <i class="fas fa-images text-3xl mb-2"></i>
                                        <p class="text-sm">No Image Uploaded</p>
                                    </div>
                                </div>
                                <input type="file" id="gallery-input" accept="image/*" multiple class="hidden">
                                <button type="button" id="gallery-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Add Gallery Images
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Upload multiple images (up to 8)</p>
                            </div>
                                                        <!-- Placements -->
                                                        <div class="bg-white p-6 rounded-lg shadow-md">
                                                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Placements</h2>
                                                                <div class="space-y-3">
                                                                    <div>
                                                                        <label class="inline-flex items-center gap-2">
                                                                            <input type="checkbox" id="featured-checkbox" name="placements[featured]" />
                                                                            <span class="text-sm text-gray-700">Featured</span>
                                                                        </label>
                                                                    </div>
                                                                    <div>
                                                                        <label class="block text-sm font-medium text-gray-700">New Arrivals expiry</label>
                                                                        <div class="flex items-center gap-2 mt-2">
                                                                            <select id="new-arrival-presets" class="border rounded p-2">
                                                                                <option value="">None</option>
                                                                                <option value="1">1 day</option>
                                                                                <option value="2">2 days (default)</option>
                                                                                <option value="7">7 days</option>
                                                                                <option value="custom">Custom date</option>
                                                                            </select>
                                                                            <input id="new-arrival-custom" type="date" class="border rounded p-2 hidden" />
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <label class="block text-sm font-medium text-gray-700">Services</label>
                                                                        <p class="text-xs text-gray-500">Assign to service placements (predefined)</p>
                                                                        <div class="mt-2 flex flex-col gap-2">
                                                                            <label class="inline-flex items-center"><input type="checkbox" name="serviceKey" value="customizeApparel" /> <span class="ml-2">Customize Apparel</span></label>
                                                                            <label class="inline-flex items-center"><input type="checkbox" name="serviceKey" value="printing" /> <span class="ml-2">Printing</span></label>
                                                                            <label class="inline-flex items-center"><input type="checkbox" name="serviceKey" value="embroidery" /> <span class="ml-2">Embroidery</span></label>
                                                                        </div>
                                                                    </div>
                                                                    <input type="hidden" id="placementsHidden" name="placements">
                                                                </div>
                                                        </div>
                            
                            <!-- Actions -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Actions</h2>
                                <div class="flex flex-col gap-3">
                                    <button id="submit-btn" type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <i class="fas fa-save mr-2"></i>Update Product
                                    </button>
                                    <a href="manage-products.html" class="w-full text-center px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </a>
                                </div>
                            </div>

                            <!-- Product Info Card -->
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-semibold mb-1">Editing Product</p>
                                        <p class="text-xs">Make changes to the product details and click "Update Product" to save.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </main>
                    </form>
                </div>
            </div>
        </div>
    </div>
                <!-- Stock assign modal (shared markup) -->
                <div id="stock-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
                    <div class="absolute inset-0 bg-black/50" aria-hidden="true"></div>
                    <div class="relative bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold">Assign Stock to Size</h3>
                            <button id="stock-modal-close" class="text-gray-600">✕</button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm">Size name</label>
                                <input id="stock-modal-size" type="text" list="sizes-datalist" class="mt-1 block w-full border rounded p-2" placeholder="e.g., S, M, L">
                                <datalist id="sizes-datalist"></datalist>
                            </div>
                            <div>
                                <label class="block text-sm">Quantity</label>
                                <input id="stock-modal-qty" type="number" class="mt-1 block w-full border rounded p-2" min="0">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button id="stock-modal-add" class="px-4 py-2 bg-indigo-600 text-white rounded">Add</button>
                                <button id="stock-modal-cancel" type="button" class="px-4 py-2 bg-gray-200 rounded" onclick="document.getElementById('stock-modal').classList.add('hidden');document.body.classList.remove('overflow-hidden');">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price assign modal -->
                <div id="price-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
                    <div class="absolute inset-0 bg-black/50" aria-hidden="true"></div>
                    <div class="relative bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold">Assign Price to Sizes</h3>
                            <button id="price-modal-close" class="text-gray-600">✕</button>
                        </div>
                        <div class="space-y-3">
                            <div id="price-modal-sizes" class="flex flex-wrap"></div>
                            <div>
                                <label class="block text-sm">Price (₱)</label>
                                <input id="price-modal-price" type="number" step="0.01" min="0" class="mt-1 block w-full border rounded p-2">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button id="price-modal-add" class="px-4 py-2 bg-indigo-600 text-white rounded">Add</button>
                                <button id="price-modal-cancel" type="button" class="px-4 py-2 bg-gray-200 rounded" onclick="document.getElementById('price-modal').classList.add('hidden');document.body.classList.remove('overflow-hidden');">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
        const API = 'https://fundamental-apparel-backend.onrender.com';
        const token = localStorage.getItem('adminToken');

        // Auth check
        if (!token) {
            window.location.href = 'login.html';
        }

        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('admin-sidebar');
        sidebarToggle?.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        });

        // DOM Elements
        const editForm = document.getElementById('edit-product-form');
        const messageEl = document.getElementById('message');
        
        // Image upload elements
        const mainImageInput = document.getElementById('main-image-input');
        const mainImageBtn = document.getElementById('main-image-btn');
        const mainImageDisplay = document.getElementById('main-image-display');
        const noMainImage = document.getElementById('no-main-image');
        const mainBtnText = document.getElementById('main-btn-text');
        
        const galleryInput = document.getElementById('gallery-input');
        const galleryBtn = document.getElementById('gallery-btn');
        const galleryPreview = document.getElementById('gallery-preview');

        // State
        let currentMainImage = null; // Existing image URL
        let newMainImageFile = null; // New uploaded file
        let existingGallery = []; // Existing gallery URLs
        let newGalleryFiles = []; // New uploaded files
        let deletedGalleryImages = []; // URLs to delete

        // SizesInventory helpers
        const sizesRowsContainer = document.getElementById('sizes-rows');
        const sizesHidden = document.getElementById('sizesInventoryHidden');
        const generateSizesBtn = document.getElementById('generate-sizes-btn');
        const addSizeRowBtn = document.getElementById('add-size-row');
        const clearSizesBtn = document.getElementById('clear-sizes');

        // Per-size prices helpers
        const pricesRowsContainer = document.getElementById('prices-rows');
        const sizesPriceHidden = document.getElementById('sizesPriceHidden');
        const generatePriceSizesBtn = document.getElementById('generate-price-sizes-btn');
        const addPriceRowBtn = document.getElementById('add-price-row');
        const clearPricesBtn = document.getElementById('clear-prices');

        // Placements helpers
        const featuredCheckbox = document.getElementById('featured-checkbox');
        const newArrivalPresets = document.getElementById('new-arrival-presets');
        const newArrivalCustom = document.getElementById('new-arrival-custom');
        const placementsHidden = document.getElementById('placementsHidden');

        function renderSizeRows(obj) {
            if (!sizesRowsContainer) return;
            sizesRowsContainer.innerHTML = '';
            const data = obj || {};
            Object.keys(data).forEach(size => {
                const qty = data[size];
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                                    <input data-select type="checkbox" class="h-4 w-4" />
                                    <input class="flex-1 border rounded p-2" data-size-input type="text" value="${size}" />
                                    <input class="w-24 border rounded p-2" data-qty-input type="number" min="0" value="${Number(qty)||0}" />
                                    <button type="button" class="px-3 py-2 bg-red-600 text-white rounded-md" data-remove>Remove</button>
                `;
                row.querySelector('[data-remove]').addEventListener('click', () => { row.remove(); });
                sizesRowsContainer.appendChild(row);
            });
        }

        function getSizesInventoryObject() {
            const obj = {};
            if (!sizesRowsContainer) return obj;
            const rows = sizesRowsContainer.querySelectorAll('div');
            rows.forEach(row => {
                const sizeInput = row.querySelector('[data-size-input]');
                const qtyInput = row.querySelector('[data-qty-input]');
                if (!sizeInput || !qtyInput) return;
                const size = String(sizeInput.value||'').trim();
                const qty = Number(qtyInput.value||0);
                if (size) obj[size] = Math.max(0, Math.floor(qty));
            });
            return obj;
        }

        generateSizesBtn?.addEventListener('click', () => {
            const sizesText = document.getElementById('sizes-generate')?.value || '';
            const sizes = sizesText.split(',').map(s => s.trim()).filter(Boolean);
            const obj = {};
            sizes.forEach(s => { obj[s] = obj[s] || 0; });
            renderSizeRows(obj);
        });

        addSizeRowBtn?.addEventListener('click', () => {
            renderSizeRows(Object.assign(getSizesInventoryObject(), { '': 0 }));
            const last = sizesRowsContainer.querySelector('div:last-child [data-size-input]');
            if (last) last.focus();
        });

        clearSizesBtn?.addEventListener('click', () => {
            if (sizesRowsContainer) sizesRowsContainer.innerHTML = '';
        });

        // Batch apply quantity to selected sizes
        const applyQtyInput = document.getElementById('apply-qty-input');
        const applyQtyBtn = document.getElementById('apply-qty-btn');
        applyQtyBtn?.addEventListener('click', () => {
            const v = Number(applyQtyInput.value||0);
            const rows = sizesRowsContainer.querySelectorAll('div');
            rows.forEach(r => {
                const chk = r.querySelector('[data-select]');
                const qtyInput = r.querySelector('[data-qty-input]');
                if (chk && chk.checked && qtyInput) {
                    qtyInput.value = Math.max(0, Math.floor(v));
                }
            });
        });

        // Price rows rendering
        function renderPriceRows(obj) {
            if (!pricesRowsContainer) return;
            pricesRowsContainer.innerHTML = '';
            const data = obj || {};
            Object.keys(data).forEach(size => {
                const price = data[size];
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                    <input data-select type="checkbox" class="h-4 w-4" />
                    <input class="flex-1 border rounded p-2" data-price-size-input type="text" value="${size}" />
                    <input class="w-32 border rounded p-2" data-price-input type="number" step="0.01" min="0" value="${Number(price)||0}" />
                    <button type="button" class="px-3 py-2 bg-red-600 text-white rounded-md" data-remove>Remove</button>
                `;
                row.querySelector('[data-remove]').addEventListener('click', () => { row.remove(); });
                pricesRowsContainer.appendChild(row);
            });
        }

        function getSizesPriceObject() {
            const obj = {};
            if (!pricesRowsContainer) return obj;
            const rows = pricesRowsContainer.querySelectorAll('div');
            rows.forEach(row => {
                const sizeInput = row.querySelector('[data-price-size-input]');
                const priceInput = row.querySelector('[data-price-input]');
                if (!sizeInput || !priceInput) return;
                const size = String(sizeInput.value||'').trim();
                const price = Number(priceInput.value||0);
                if (size) obj[size] = Math.max(0, Number(price.toFixed(2)));
            });
            return obj;
        }

        generatePriceSizesBtn?.addEventListener('click', () => {
            const sizesText = document.getElementById('sizes-for-price').value || '';
            const sizes = sizesText.split(',').map(s => s.trim()).filter(Boolean);
            const obj = {};
            sizes.forEach(s => { obj[s] = obj[s] || 0; });
            renderPriceRows(obj);
        });

        addPriceRowBtn?.addEventListener('click', () => {
            renderPriceRows(Object.assign(getSizesPriceObject(), { '': 0 }));
            const last = pricesRowsContainer.querySelector('div:last-child [data-price-size-input]');
            if (last) last.focus();
        });

        clearPricesBtn?.addEventListener('click', () => {
            if (pricesRowsContainer) pricesRowsContainer.innerHTML = '';
        });

        // Batch apply price to selected sizes
        const applyPriceInput = document.getElementById('apply-price-input');
        const applyPriceBtn = document.getElementById('apply-price-btn');
        applyPriceBtn?.addEventListener('click', () => {
            const v = Number(applyPriceInput.value||0);
            const rows = pricesRowsContainer.querySelectorAll('div');
            rows.forEach(r => {
                const chk = r.querySelector('[data-select]');
                const priceInput = r.querySelector('[data-price-input]');
                if (chk && chk.checked && priceInput) {
                    priceInput.value = Number(v.toFixed(2));
                }
            });
        });

        // New arrival presets handling
        newArrivalPresets?.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                newArrivalCustom.classList.remove('hidden');
            } else {
                newArrivalCustom.classList.add('hidden');
            }
        });

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            showMessage('No product ID found. Redirecting...', 'error');
            setTimeout(() => window.location.href = 'manage-products.html', 2000);
        }

        // Fetch categories for flag-driven UI
        async function fetchCategories() {
            try {
                const res = await fetch(`${API}/api/categories`);
                const json = await res.json();
                if (json.success) {
                    window.__categories = json.data || [];
                    populateCategorySelect();
                }
            } catch (e) {
                console.warn('Could not fetch categories for edit page', e);
            }
        }

        function populateCategorySelect() {
            const select = document.getElementById('category');
            if (!select || !window.__categories) return;
            const current = select.value;
            select.innerHTML = window.__categories.map(c => `<option value="${c.name}" ${c.name === current ? 'selected' : ''}>${c.name}</option>`).join('');
            // apply flags immediately based on current value
            applyCategoryFlagsByName(select.value);
            select.addEventListener('change', (e) => applyCategoryFlagsByName(e.target.value));
        }

        function applyCategoryFlagsByName(name) {
            try {
                const cat = (window.__categories || []).find(c => c.name === name);
                applyCategoryFlags(cat);
            } catch (e) { applyCategoryFlags(null); }
        }

        function applyCategoryFlags(cat) {
            const perSizeSection = document.getElementById('per-size-section');
            const perPriceSection = document.getElementById('per-price-section');
            const sizesInput = document.getElementById('sizes');
            const colorsSection = document.getElementById('colors-section');
            const materialsSection = document.getElementById('materials-section');
            const colorsInput = document.getElementById('colors');
            const materialInput = document.getElementById('material');
            if (cat && cat.requiresSizes) {
                perSizeSection?.classList.remove('hidden');
                perSizeSection?.removeAttribute('aria-hidden');
                perPriceSection?.classList.remove('hidden');
                perPriceSection?.removeAttribute('aria-hidden');
                if (sizesInput) sizesInput.removeAttribute('disabled');
            } else {
                perSizeSection?.classList.add('hidden');
                perSizeSection?.setAttribute('aria-hidden', 'true');
                perPriceSection?.classList.add('hidden');
                perPriceSection?.setAttribute('aria-hidden', 'true');
                if (sizesInput) sizesInput.setAttribute('disabled', 'true');
            }

            // Colors
            if (cat && cat.requiresColors) {
                colorsSection?.classList.remove('hidden');
                colorsSection?.removeAttribute('aria-hidden');
                if (colorsInput) colorsInput.removeAttribute('disabled');
            } else {
                colorsSection?.classList.add('hidden');
                colorsSection?.setAttribute('aria-hidden', 'true');
                if (colorsInput) colorsInput.setAttribute('disabled', 'true');
            }

            // Materials
            if (cat && cat.requiresMaterials) {
                materialsSection?.classList.remove('hidden');
                materialsSection?.removeAttribute('aria-hidden');
                if (materialInput) materialInput.removeAttribute('disabled');
            } else {
                materialsSection?.classList.add('hidden');
                materialsSection?.setAttribute('aria-hidden', 'true');
                if (materialInput) materialInput.setAttribute('disabled', 'true');
            }
        }

        // load categories for the edit form
        fetchCategories();

        function showMessage(text, type = 'success') {
            messageEl.textContent = text;
            messageEl.className = `mb-4 p-3 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageEl.classList.remove('hidden');
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }

        // Main Image Upload Handler
        mainImageBtn.addEventListener('click', () => {
            mainImageInput.click();
        });

        mainImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                newMainImageFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    mainImageDisplay.src = event.target.result;
                    mainImageDisplay.classList.remove('hidden');
                    noMainImage.classList.add('hidden');
                    mainBtnText.textContent = 'Edit Main Image';
                };
                reader.readAsDataURL(file);
            }
        });

        // Gallery Upload Handler
        galleryBtn.addEventListener('click', () => {
            galleryInput.click();
        });

        galleryInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                files.forEach(file => {
                    newGalleryFiles.push(file);
                });
                renderGallery();
            }
        });

        function renderGallery() {
            const allImages = [...existingGallery, ...newGalleryFiles];
            
            if (allImages.length === 0) {
                galleryPreview.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-400">
                        <i class="fas fa-images text-3xl mb-2"></i>
                        <p class="text-sm">No Image Uploaded</p>
                    </div>
                `;
                return;
            }

            galleryPreview.innerHTML = '';
            
            // Render existing images
            existingGallery.forEach((url, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'relative bg-white border-2 border-gray-200 rounded-lg p-2 group';
                imageCard.innerHTML = `
                    <img src="${url}" class="w-full h-32 object-contain rounded" alt="Gallery image ${index + 1}">
                    <button type="button" class="absolute top-1 right-1 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteExistingImage(${index})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-1">Existing</p>
                `;
                galleryPreview.appendChild(imageCard);
            });

            // Render new uploaded files
            newGalleryFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'relative bg-white border-2 border-green-200 rounded-lg p-2 group';
                    imageCard.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-32 object-contain rounded" alt="New image ${index + 1}">
                        <button type="button" class="absolute top-1 right-1 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteNewImage(${index})">
                            <i class="fas fa-times"></i> Remove
                        </button>
                        <p class="text-xs text-green-600 text-center mt-1">New</p>
                    `;
                    galleryPreview.appendChild(imageCard);
                };
                reader.readAsDataURL(file);
            });
        }

        // Global functions for delete buttons
        window.deleteExistingImage = (index) => {
            const deletedUrl = existingGallery[index];
            deletedGalleryImages.push(deletedUrl);
            existingGallery.splice(index, 1);
            renderGallery();
            showMessage('Image marked for deletion', 'success');
        };

        window.deleteNewImage = (index) => {
            newGalleryFiles.splice(index, 1);
            renderGallery();
        };

        // Fetch and populate product data
        async function loadProduct() {
            try {
                const response = await fetch(`${API}/api/products/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    const product = result.data;
                    
                    // Populate form fields
                    document.getElementById('name').value = product.name || '';
                    document.getElementById('category').value = product.category || '';
                    document.getElementById('price').value = product.price || '';
                    document.getElementById('countInStock').value = product.countInStock || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('sizes').value = Array.isArray(product.sizes) ? product.sizes.join(', ') : '';
                    document.getElementById('colors').value = Array.isArray(product.colors) ? product.colors.join(', ') : '';
                    document.getElementById('material').value = product.material || '';
                    document.getElementById('productDetails').value = product.productDetails || '';
                                        // Populate per-size rows if available
                                        try {
                                            if (product.sizesInventory && Object.keys(product.sizesInventory || {}).length > 0) {
                                                renderSizeRows(product.sizesInventory);
                                            } else if (Array.isArray(product.sizes) && product.sizes.length > 0) {
                                                const obj = {};
                                                product.sizes.forEach(s => obj[s] = obj[s] || 0);
                                                renderSizeRows(obj);
                                            }
                                        } catch (e) {
                                            console.warn('Could not render sizesInventory', e);
                                        }
                                        // Render per-size prices if available
                                        try {
                                            if (product.sizesPrice && Object.keys(product.sizesPrice || {}).length > 0) {
                                                renderPriceRows(product.sizesPrice);
                                            }
                                        } catch (e) {
                                            console.warn('Could not render sizesPrice', e);
                                        }

                                        // Populate placements
                                        try {
                                            if (product.placements) {
                                                const p = product.placements || {};
                                                if (p.featured) featuredCheckbox.checked = true;
                                                if (p.newArrivalExpiresAt) {
                                                    // try to match preset days (1,2,7)
                                                    const now = Date.now();
                                                    const expires = new Date(p.newArrivalExpiresAt).getTime();
                                                    const diffDays = Math.round((expires - now) / (24*60*60*1000));
                                                    if ([1,2,7].includes(diffDays)) {
                                                        newArrivalPresets.value = String(diffDays);
                                                        newArrivalCustom.classList.add('hidden');
                                                    } else {
                                                        newArrivalPresets.value = 'custom';
                                                        newArrivalCustom.value = new Date(p.newArrivalExpiresAt).toISOString().slice(0,10);
                                                        newArrivalCustom.classList.remove('hidden');
                                                    }
                                                }
                                                if (Array.isArray(p.services) && p.services.length > 0) {
                                                    p.services.forEach(s => {
                                                        const chk = document.querySelector(`input[name="serviceKey"][value="${s}"]`);
                                                        if (chk) chk.checked = true;
                                                    });
                                                }
                                            }
                                        } catch (e) {
                                            console.warn('Could not populate placements', e);
                                        }
                    
                    // Set main image
                    if (product.imageUrl) {
                        currentMainImage = product.imageUrl;
                        mainImageDisplay.src = product.imageUrl;
                        mainImageDisplay.classList.remove('hidden');
                        noMainImage.classList.add('hidden');
                        mainBtnText.textContent = 'Edit Main Image';
                    }
                    
                    // Set gallery images
                    if (Array.isArray(product.gallery) && product.gallery.length > 0) {
                        existingGallery = [...product.gallery];
                        renderGallery();
                    }
                } else {
                    throw new Error(result.msg || 'Failed to load product');
                }
            } catch (error) {
                showMessage(`Error loading product: ${error.message}`, 'error');
            }
        }

        // Handle form submission
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

            try {
                const formData = new FormData();
                
                // Add text fields manually (not from form to avoid duplicates)
                formData.append('name', document.getElementById('name').value);
                formData.append('category', document.getElementById('category').value);
                formData.append('price', parseFloat(document.getElementById('price').value));
                formData.append('countInStock', parseInt(document.getElementById('countInStock').value, 10));
                formData.append('description', document.getElementById('description').value);
                formData.append('material', document.getElementById('material').value);
                formData.append('productDetails', document.getElementById('productDetails').value);
                formData.append('faqs', document.getElementById('faqs').value);
                
                const sizes = document.getElementById('sizes').value;
                const colors = document.getElementById('colors').value;
                
                formData.append('sizes', sizes ? sizes.split(',').map(s => s.trim()).join(',') : '');
                formData.append('colors', colors ? colors.split(',').map(c => c.trim()).join(',') : '');

                // Append sizesInventory JSON
                try {
                    formData.append('sizesInventory', JSON.stringify(getSizesInventoryObject()));
                } catch (e) {
                    formData.append('sizesInventory', '');
                }
                // Append sizesPrice JSON
                try {
                    formData.append('sizesPrice', JSON.stringify(getSizesPriceObject()));
                } catch (e) {
                    formData.append('sizesPrice', '');
                }
                // Append placements
                try {
                    const services = Array.from(document.querySelectorAll('input[name="serviceKey"]:checked')).map(i => i.value);
                    let newArrivalExpiresAt = null;
                    const preset = newArrivalPresets.value;
                    if (preset === 'custom' && newArrivalCustom.value) {
                      newArrivalExpiresAt = new Date(newArrivalCustom.value).toISOString();
                    } else if (preset && preset !== '') {
                      const days = Number(preset) || 0;
                      if (days > 0) newArrivalExpiresAt = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString();
                    }
                    const placementsObj = { featured: !!featuredCheckbox.checked, newArrivalExpiresAt, services };
                    formData.append('placements', JSON.stringify(placementsObj));
                } catch (e) {
                    formData.append('placements', '');
                }
                
                // Handle main image
                if (newMainImageFile) {
                    formData.append('mainImage', newMainImageFile);
                } else if (currentMainImage) {
                    formData.append('existingMainImage', currentMainImage);
                }
                
                // Handle gallery images
                newGalleryFiles.forEach(file => {
                    formData.append('galleryImages', file);
                });
                
                if (existingGallery.length > 0) {
                    formData.append('existingGallery', JSON.stringify(existingGallery));
                }
                
                if (deletedGalleryImages.length > 0) {
                    formData.append('deletedGallery', JSON.stringify(deletedGalleryImages));
                }

                const response = await fetch(`${API}/api/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('Product updated successfully! Redirecting...', 'success');
                    setTimeout(() => window.location.href = 'manage-products.html', 2000);
                } else {
                    throw new Error(result.msg || 'Failed to update product');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Product';
            }
        });

        // Load product data on page load
        loadProduct();

        // --- Stock/Price assign modal handling (edit page) ---
        function populateSizesDatalist() {
            const dl = document.getElementById('sizes-datalist');
            if (!dl) return;
            dl.innerHTML = '';
            const sizesText = (document.getElementById('sizes-generate')?.value || '');
            const fromInput = sizesText.split(',').map(s=>s.trim()).filter(Boolean);
            const inv = getSizesInventoryObject();
            const invSizes = Object.keys(inv || {});
            const all = Array.from(new Set([...fromInput, ...invSizes]));
            all.forEach(s => { const opt = document.createElement('option'); opt.value = s; dl.appendChild(opt); });
        }
        document.getElementById('sizes-generate')?.addEventListener('input', populateSizesDatalist);
        const assignStockBtn = document.getElementById('assign-stock-btn');
        const stockModal = document.getElementById('stock-modal');
        const stockModalClose = document.getElementById('stock-modal-close');
        const stockModalAdd = document.getElementById('stock-modal-add');
        const stockModalSize = document.getElementById('stock-modal-size');
        const stockModalQty = document.getElementById('stock-modal-qty');

        const assignPriceBtn = document.getElementById('assign-price-btn');
        const priceModal = document.getElementById('price-modal');
        const priceModalClose = document.getElementById('price-modal-close');
        const priceModalAdd = document.getElementById('price-modal-add');
        const priceModalPrice = document.getElementById('price-modal-price');
        const priceModalSizesContainer = document.getElementById('price-modal-sizes');

        function openModal(modal) { modal?.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
        function closeModal(modal) { modal?.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }

        assignStockBtn?.addEventListener('click', () => {
                // refresh datalist options then open modal
                populateSizesDatalist();
                stockModalQty.value = Number(document.getElementById('countInStock').value || 0);
                stockModalSize.value = '';
                openModal(stockModal);
        });
        stockModalClose?.addEventListener('click', () => closeModal(stockModal));
        stockModalAdd?.addEventListener('click', () => {
            const size = String(stockModalSize.value||'').trim();
            const qty = Math.max(0, Math.floor(Number(stockModalQty.value||0)));
            if (!size) { showMessage('Please enter a size name', 'error'); return; }
            const rows = sizesRowsContainer.querySelectorAll('div');
            let found = false;
            rows.forEach(r => {
                const sizeInput = r.querySelector('[data-size-input]');
                const qtyInput = r.querySelector('[data-qty-input]');
                if (sizeInput && String(sizeInput.value||'').trim().toLowerCase() === size.toLowerCase()) {
                    qtyInput.value = Math.max(0, Math.floor(Number(qtyInput.value||0)) + qty);
                    found = true;
                }
            });
            if (!found) {
                const obj = getSizesInventoryObject();
                obj[size] = (obj[size] || 0) + qty;
                renderSizeRows(obj);
            }
            const sizesField = document.querySelector('label[for="sizes"]')?.closest('div');
            if (sizesField) sizesField.style.display = 'none';
            const inv = getSizesInventoryObject();
            const hasStock = Object.values(inv).some(v => Number(v) > 0);
            if (hasStock) document.getElementById('price')?.removeAttribute('disabled');
            closeModal(stockModal);
        });

        assignPriceBtn?.addEventListener('click', () => {
            const inv = getSizesInventoryObject();
            if (!inv || Object.keys(inv).length === 0) {
                showMessage('Please assign quantity stock per size before assigning per-size prices.', 'error');
                return;
            }
            priceModalSizesContainer.innerHTML = '';
            Object.keys(inv).forEach(s => {
                const row = document.createElement('label');
                row.className = 'inline-flex items-center gap-2 mr-2';
                row.innerHTML = `<input type="checkbox" value="${s}" /> <span>${s} (${inv[s]})</span>`;
                priceModalSizesContainer.appendChild(row);
            });
            priceModalPrice.value = document.getElementById('price')?.value || '';
            openModal(priceModal);
        });
        priceModalClose?.addEventListener('click', () => closeModal(priceModal));
        priceModalAdd?.addEventListener('click', () => {
            const p = Number(priceModalPrice.value||0);
            if (!p) { showMessage('Enter a valid price', 'error'); return; }
            const checks = Array.from(priceModalSizesContainer.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
            if (checks.length === 0) { showMessage('Select at least one size', 'error'); return; }
            const obj = getSizesPriceObject();
            checks.forEach(s => { obj[s] = p; });
            renderPriceRows(obj);
            document.getElementById('price')?.removeAttribute('disabled');
            closeModal(priceModal);
        });
    </script>
    
    </script>
  </body>
<script>
(function(){
    document.addEventListener('DOMContentLoaded', function(){
        const anchors = Array.from(document.querySelectorAll('a[href="add-product.html"]'));
        if(anchors.length===0) return;
        anchors.forEach(anchor=>{
            let submenu = anchor.parentElement.querySelector('.add-product-submenu');
            if(!submenu){
                submenu = document.createElement('div');
                submenu.className = 'add-product-submenu hidden mt-1 flex flex-col';
                submenu.innerHTML = '<a href="add-predisign-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="w-6"></i><span class="ml-3 text-sm">Add Pre-Design Product</span></a>';
                anchor.insertAdjacentElement('afterend', submenu);
            }
            anchor.style.cursor='pointer';
            if (location.pathname.endsWith('add-product.html') || location.pathname.endsWith('add-predisign-product.html')) submenu.classList.remove('hidden');
        });
        const mainNavLinks = Array.from(document.querySelectorAll('nav a')).filter(a=>{ const h=a.getAttribute('href'); return h && h!=='add-product.html' && h!=='add-predisign-product.html'; });
        mainNavLinks.forEach(l=>{ l.addEventListener('click', ()=>{ document.querySelectorAll('.add-product-submenu').forEach(s=>s.classList.add('hidden')); }); });
        window.addEventListener('popstate', ()=> document.querySelectorAll('.add-product-submenu').forEach(s=>s.classList.add('hidden')));
    });
})();
</script>
</html>

