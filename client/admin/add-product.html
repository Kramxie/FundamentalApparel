<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Product</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .thumb {
      width: 72px;
      height: 72px;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen bg-gray-100">
    <!-- Sidebar (desktop) -->
    <div id="admin-sidebar" class="hidden md:flex flex-col w-64 bg-white shadow-lg">
      <div class="flex items-center justify-center h-16 bg-white shadow-md"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
          </a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
          </a>
          <a href="manage-products.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
          </a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
          </a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
          </a>
          <a href="reports.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-file-chart-column w-6"></i><span class="ml-3">Reports & Sales</span>
          </a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
          </a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
          </a>
          <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span>
          </a>
        </nav>
      </div>
    </div>
    <!-- Mobile sidebar overlay & drawer -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/40 z-40 md:hidden"></div>
    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full transition-transform z-50 md:hidden">
      <div class="flex items-center justify-between h-16 bg-white shadow-md px-3">
        <div class="flex items-center"><span class="text-2xl font-bold text-indigo-600">Admin Panel</span></div>
        <button id="mobile-sidebar-close" class="p-2 rounded-md hover:bg-gray-100 text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex flex-col flex-grow p-4">
        <nav class="flex-grow space-y-2">
          <a href="index.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
          </a>
          <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
          </a>
          <a href="manage-products.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
          </a>
          <a href="inventory.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-warehouse w-6"></i><span class="ml-3">Inventory</span>
          </a>
          <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
          </a>
          <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
          </a>
          <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
          </a>
          <a href="profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
            <i class="fas fa-user-circle w-6"></i><span class="ml-3">Profile</span>
          </a>
        </nav>
      </div>
    </div>

    <!-- Main -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
        <div class="flex items-center gap-3">
          <button id="sidebar-toggle" class="md:hidden p-2 rounded bg-gray-100">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="text-lg font-semibold">Add New Product</h1>
        </div>
        <div class="flex items-center gap-4">
          <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </button>
        </div>
      </header>

      <main class="p-6 bg-gray-50 min-h-screen">
        <div id="message" class="hidden mb-4 p-3 rounded-md"></div>
        
        <form id="product-form" enctype="multipart/form-data" class="max-w-[1400px] mx-auto">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
              
              <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-6">General Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Product Name</label>
                    <input type="text" id="name" name="name" required class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border text-sm" placeholder="e.g. Cotton T-Shirt">
                  </div>
                  
                  <div>
                    <label for="category-select" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <div class="flex gap-2">
                        <select id="category-select" name="category" class="flex-1 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border text-sm bg-white"></select>
                        <div class="flex relative w-1/3">
                             <input id="new-category" placeholder="New..." class="w-full border-gray-300 rounded-l-lg shadow-sm p-2.5 border text-sm">
                             <button id="add-category-btn" type="button" class="bg-indigo-600 text-white px-3 rounded-r-lg hover:bg-indigo-700 text-xs font-bold"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Select or add a new category.</p>
                  </div>
                  
                  <div>
                    <label for="price" class="block text-sm font-semibold text-gray-700 mb-2">Base Price (₱)</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2.5 border text-sm" placeholder="e.g. 499.00">
                    <p class="text-xs text-gray-400 mt-1">Set a base product price. If per-size prices are provided they will override this value for specific sizes.</p>
                  </div>
                </div>
              </div>

              <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-6">Product Details</h2>
                
                <div class="mb-8">
                    <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">Short Description</label>
                    <textarea id="description" name="description" rows="4" required class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 border text-sm resize-none"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 border-t border-gray-100 pt-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Sizes</label>
                        <div class="flex gap-3 items-start h-40">
                            <select id="sizes-list-box" class="flex-1 h-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50" multiple></select>
                            
                            <div class="flex flex-col gap-2 w-32">
                                <input id="new-size-input" type="text" placeholder="New size" class="w-full border border-gray-300 rounded-lg p-2 text-sm text-center">
                                <button type="button" id="add-size-btn" class="w-full bg-green-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition shadow-sm">Add</button>
                                <button type="button" id="remove-size-btn" class="w-full bg-white text-red-600 border border-red-200 py-2 rounded-lg text-xs font-bold hover:bg-red-50 transition shadow-sm mt-auto">Remove</button>
                            </div>
                        </div>
                        <input type="hidden" id="sizes" name="sizes">
                    </div>
                    <div class="text-sm text-gray-500 flex flex-col justify-center">
                        <p class="mb-2"><i class="fas fa-info-circle text-indigo-500 mr-1"></i> <strong>Managing Sizes:</strong></p>
                        <ul class="list-disc pl-5 space-y-1 text-xs text-gray-400">
                            <li>Add sizes (e.g., S, M, L) using the input field.</li>
                            <li>Select multiple sizes in the box to remove them.</li>
                            <li>These sizes will be used to generate inventory rows below.</li>
                        </ul>
                    </div>
                </div>

                <div id="per-size-section" class="mb-8">
                    <label class="block text-sm font-bold text-gray-700 mb-3">Per-size inventory (optional)</label>
                    
                    <div class="flex flex-wrap items-end gap-3 mb-4">
                        <div class="flex-1">
                            <input id="sizes-generate" placeholder="e.g., S, M, L, XL" class="w-full border border-gray-300 rounded-lg shadow-sm p-2.5 text-sm">
                        </div>
                        <button type="button" id="generate-sizes-btn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-sm transition">Generate</button>
                    </div>

                    <div class="flex items-center gap-2 mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <input id="apply-qty-input" type="number" min="0" placeholder="Qty" class="w-24 border border-gray-300 rounded-md p-1.5 text-sm text-center">
                        <button type="button" id="apply-qty-btn" class="px-4 py-1.5 bg-blue-600 text-white rounded-md text-xs font-bold hover:bg-blue-700 transition">Apply to selected sizes</button>
                        <span class="text-xs text-gray-500 ml-auto hidden sm:inline">Select checkboxes to apply bulk quantity.</span>
                    </div>

                    <div id="sizes-rows" class="space-y-2 max-h-64 overflow-y-auto p-1 border border-gray-100 rounded-lg bg-gray-50"></div>

                    <div class="flex gap-3 mt-3">
                        <button type="button" id="add-size-row" class="px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition">Add Size Row</button>
                        <button type="button" id="clear-sizes" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-bold hover:bg-gray-50 transition">Clear</button>
                    </div>
                    
                    <input type="hidden" id="sizesInventoryHidden" name="sizesInventory">
                    <input type="hidden" id="stock" name="countInStock" value="0"> 
                </div>

                <div id="per-price-section">
                    <label class="block text-sm font-bold text-gray-700 mb-3">Per-size price (optional)</label>
                    
                    <div class="flex flex-wrap items-end gap-3 mb-4">
                        <div class="flex-1">
                             <input id="sizes-for-price" placeholder="e.g., XXL, 3XL" class="w-full border border-gray-300 rounded-lg shadow-sm p-2.5 text-sm">
                        </div>
                        <button type="button" id="generate-price-sizes-btn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-sm transition">Generate</button>
                    </div>

                    <div class="flex items-center gap-2 mb-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <input id="apply-price-input" type="number" step="0.01" min="0" placeholder="Price" class="w-24 border border-gray-300 rounded-md p-1.5 text-sm text-center">
                        <button type="button" id="apply-price-btn" class="px-4 py-1.5 bg-blue-600 text-white rounded-md text-xs font-bold hover:bg-blue-700 transition">Apply to selected sizes</button>
                    </div>

                    <div id="prices-rows" class="space-y-2 max-h-64 overflow-y-auto p-1 border border-gray-100 rounded-lg bg-gray-50"></div>

                    <div class="flex gap-3 mt-3">
                        <button type="button" id="add-price-row" class="px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition">Add Price Row</button>
                        <button type="button" id="clear-prices" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-bold hover:bg-gray-50 transition">Clear</button>
                    </div>
                    <input type="hidden" id="sizesPriceHidden" name="sizesPrice">
                </div>

                <div class="mt-8 border-t border-gray-100 pt-6">
                     <label class="block text-sm font-bold text-gray-700 mb-2">Additional Details</label>
                     <textarea id="productDetails" name="productDetails" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm p-3 text-sm border" placeholder="Format: Title::Content||Title2::Content2"></textarea>
                </div>
              </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                  <h2 class="text-lg font-bold text-gray-800 mb-4">Product Images</h2>
                  
                  <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-2">Main Image</label>
                    <div class="relative w-full aspect-square bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden group hover:border-indigo-400 transition cursor-pointer">
                      <img id="main-preview" class="hidden w-full h-full object-contain z-10">
                      <div id="main-placeholder" class="text-center text-gray-400 group-hover:text-indigo-500 transition">
                          <i class="fas fa-cloud-upload-alt text-4xl mb-2"></i>
                          <p class="text-xs font-medium">Main Image</p>
                      </div>
                      <input id="image-input" type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" />
                    </div>
                    <p class="text-xs text-center text-indigo-600 mt-2 cursor-pointer hover:underline" onclick="document.getElementById('image-input').click()">Choose main image</p>
                  </div>

                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">Gallery (Max 8)</label>
                    <div id="thumbs" class="grid grid-cols-4 gap-2 mb-3 min-h-[60px]"></div>
                    
                    <label class="flex items-center justify-center w-full py-3 border border-indigo-100 text-indigo-600 bg-indigo-50 rounded-lg text-sm font-bold cursor-pointer hover:bg-indigo-100 transition">
                        <i class="fas fa-images mr-2"></i> Add Gallery Images
                        <input id="gallery-input" type="file" accept="image/*" multiple class="hidden" />
                    </label>
                  </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Settings</h2>
                    <div class="space-y-4">
                        <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition border border-transparent hover:border-gray-200">
                            <input type="checkbox" id="featured-checkbox" name="placements[featured]" class="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4">
                            <span class="ml-3 text-sm font-medium text-gray-700">Mark as Featured</span>
                        </label>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">New Arrivals Badge</label>
                            <select id="new-arrival-presets" class="w-full border-gray-300 rounded-lg text-sm p-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500 border">
                                <option value="">None</option>
                                <option value="2" selected>2 Days (Default)</option>
                                <option value="7">7 Days</option>
                                <option value="custom">Custom Date</option>
                            </select>
                            <input id="new-arrival-custom" type="date" class="mt-2 w-full border-gray-300 rounded-lg p-2 text-sm hidden border">
                        </div>
                        <input type="hidden" id="placementsHidden" name="placements">
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 sticky top-6">
                   <h2 class="text-lg font-bold text-gray-800 mb-4">Actions</h2>
                   <div class="flex flex-col gap-3">
                      <button id="submit-btn" type="submit" class="w-full px-4 py-3.5 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition transform active:scale-95 flex justify-center items-center gap-2">
                        <i class="fas fa-check-circle"></i> Create Product
                      </button>
                      <a href="manage-products.html" class="w-full text-center px-4 py-3.5 bg-gray-100 text-gray-600 font-bold rounded-lg hover:bg-gray-200 transition">
                        Cancel
                      </a>
                   </div>
                </div>

            </div>
          </div>
        </form>
      </main>
    </div>
  </div>
  
  <!-- Stock assign modal -->
  <div id="stock-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" aria-hidden="true"></div>
    <div class="relative bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">Assign Stock to Size</h3>
        <button id="stock-modal-close" class="text-gray-600">✕</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="block text-sm">Size name</label>
          <input id="stock-modal-size" type="text" list="sizes-datalist" class="mt-1 block w-full border rounded p-2" placeholder="e.g., S, M, L">
          <datalist id="sizes-datalist"></datalist>
        </div>
        <div>
          <label class="block text-sm">Quantity</label>
          <input id="stock-modal-qty" type="number" class="mt-1 block w-full border rounded p-2" min="0">
        </div>
        <div class="flex justify-end gap-2">
          <button id="stock-modal-add" class="px-4 py-2 bg-indigo-600 text-white rounded">Add</button>
          <button id="stock-modal-cancel" type="button" class="px-4 py-2 bg-gray-200 rounded" onclick="document.getElementById('stock-modal').classList.add('hidden');document.body.classList.remove('overflow-hidden');">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Price assign modal -->
  <div id="price-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" aria-hidden="true"></div>
    <div class="relative bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">Assign Price to Sizes</h3>
        <button id="price-modal-close" class="text-gray-600">✕</button>
      </div>
      <div class="space-y-3">
        <div id="price-modal-sizes" class="flex flex-wrap"></div>
        <div>
          <label class="block text-sm">Price (₱)</label>
          <input id="price-modal-price" type="number" step="0.01" min="0" class="mt-1 block w-full border rounded p-2">
        </div>
        <div class="flex justify-end gap-2">
          <button id="price-modal-add" class="px-4 py-2 bg-indigo-600 text-white rounded">Add</button>
          <button id="price-modal-cancel" type="button" class="px-4 py-2 bg-gray-200 rounded" onclick="document.getElementById('price-modal').classList.add('hidden');document.body.classList.remove('overflow-hidden');">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://fundamental-apparel-backend.onrender.com';
    const token = localStorage.getItem('adminToken');
    const DEBUG = true; // set to false to disable verbose client-side submit logs

    // Auth check
    if (!token) {
      window.location.href = 'login.html';
    }

    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('admin-sidebar');
    sidebarToggle?.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('adminToken');
        window.location.href = 'login.html';
    });

    // DOM Elements
    const imageInput = document.getElementById('image-input');
    const galleryInput = document.getElementById('gallery-input');
    const mainPreview = document.getElementById('main-preview');
    const mainPlaceholder = document.getElementById('main-placeholder'); // Added
    const thumbsContainer = document.getElementById('thumbs');
    const productForm = document.getElementById('product-form');
  
    const messageEl = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');
    const sizesListBox = document.getElementById('sizes-list-box');
    const newSizeInput = document.getElementById('new-size-input');
    const addSizeBtn = document.getElementById('add-size-btn');
    const removeSizeBtn = document.getElementById('remove-size-btn');
    const sizesHiddenInput = document.getElementById('sizes');
    // Standardize hidden inputs / controls used later in the script
    const sizesHidden = document.getElementById('sizesInventoryHidden') || document.getElementById('sizes');
    const sizesPriceHidden = document.getElementById('sizesPriceHidden') || document.getElementById('sizesPrice');
    const placementsHidden = document.getElementById('placementsHidden');
    const stockInput = document.getElementById('stock');
    const featuredCheckbox = document.getElementById('featured-checkbox');
    const newArrivalPresets = document.getElementById('new-arrival-presets');
    const newArrivalCustom = document.getElementById('new-arrival-custom');

    
    

    // Pre-design front/back controls (now added)
    

    let galleryFiles = [];
    let mainFile = null;
    
    // --- SIZES LIST BOX LOGIC (NEW) ---
    // --- HELPER: Remove Row by Name (Auto-Sync) ---
    function removeRowBySizeName(sizeVal, container) {
        if (!container) return;
        // Hanapin ang input na may value na kapareho ng size
        const inputs = container.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
            if (input.value.trim().toUpperCase() === sizeVal.toUpperCase()) {
                // Remove the whole row div
                input.closest('div.flex').remove();
            }
        });
    }

    // --- HELPER: Create Inventory Row ---
    function createSizeRow(size = '', qty = 0) {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 p-2 bg-white border rounded-md mb-2';
        row.innerHTML = `
            <input type="checkbox" class="row-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <input type="text" class="size-name-input flex-1 border-gray-300 rounded-md p-1.5 text-sm border" placeholder="Size" value="${size}">
            <input type="number" class="size-qty-input w-24 border-gray-300 rounded-md p-1.5 text-sm border" placeholder="Qty" min="0" value="${qty}">
            <button type="button" class="remove-row-btn text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
        `;
        row.querySelector('.remove-row-btn').addEventListener('click', () => row.remove());
        return row;
    }

    // --- HELPER: Create Price Row ---
    function createPriceRow(size = '', price = 0) {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 p-2 bg-white border rounded-md mb-2';
        row.innerHTML = `
            <input type="checkbox" class="price-row-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <input type="text" class="price-size-input flex-1 border-gray-300 rounded-md p-1.5 text-sm border" placeholder="Size" value="${size}">
            <input type="number" class="price-val-input w-24 border-gray-300 rounded-md p-1.5 text-sm border" placeholder="Price" min="0" step="0.01" value="${price}">
            <button type="button" class="remove-price-btn text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
        `;
        row.querySelector('.remove-price-btn').addEventListener('click', () => row.remove());
        return row;
    }

    // --- SIZES LIST BOX LOGIC (UPDATED WITH AUTO-SYNC) ---
    function updateHiddenSizes() {
        if(!sizesListBox) return;
        const options = Array.from(sizesListBox.options).map(opt => opt.value);
        if(sizesHiddenInput) sizesHiddenInput.value = options.join(',');
    }

    if(addSizeBtn) {
        addSizeBtn.addEventListener('click', () => {
            const val = newSizeInput.value.trim().toUpperCase();
            if (!val) return;
            
            // Prevent duplicates in list
            const exists = Array.from(sizesListBox.options).some(opt => opt.value === val);
            if (exists) {
                alert('Size already exists!');
                return;
            }

            // 1. Add to List Box
            const opt = document.createElement('option');
            opt.value = val;
            opt.text = val;
            sizesListBox.add(opt);
            newSizeInput.value = '';
            updateHiddenSizes();

            // 2. AUTO-ADD TO INVENTORY (The Fix)
            if (sizesRowsContainer) {
                sizesRowsContainer.appendChild(createSizeRow(val, 0));
            }

            // 3. AUTO-ADD TO PRICE (The Fix)
            if (pricesRowsContainer) {
                pricesRowsContainer.appendChild(createPriceRow(val, 0));
            }
        });
    }

    if(removeSizeBtn) {
        removeSizeBtn.addEventListener('click', () => {
            const selected = Array.from(sizesListBox.selectedOptions);
            if (selected.length === 0) return;
            
            selected.forEach(opt => {
                const val = opt.value;
                opt.remove();
                
                // AUTO-REMOVE from Inventory & Price
                removeRowBySizeName(val, sizesRowsContainer);
                removeRowBySizeName(val, pricesRowsContainer);
            });
            updateHiddenSizes();
        });
    }

    // --- INVENTORY SECTION LOGIC ---
    const sizesRowsContainer = document.getElementById('sizes-rows');
    const generateSizesBtn = document.getElementById('generate-sizes-btn');
    const sizesGenerateInput = document.getElementById('sizes-generate');
    const addSizeRowBtn = document.getElementById('add-size-row');
    const clearSizesBtn = document.getElementById('clear-sizes');

    if(generateSizesBtn) {
        generateSizesBtn.addEventListener('click', () => {
            const raw = sizesGenerateInput.value.trim();
            if (!raw) return;
            const sizes = raw.split(/[,;\s]+/).map(s => s.trim()).filter(Boolean);
            if(sizesRowsContainer) {
                sizesRowsContainer.innerHTML = '';
                sizes.forEach(s => sizesRowsContainer.appendChild(createSizeRow(s.toUpperCase(), 0)));
            }
        });
    }
    
    if(addSizeRowBtn) addSizeRowBtn.addEventListener('click', () => sizesRowsContainer.appendChild(createSizeRow()));
    if(clearSizesBtn) clearSizesBtn.addEventListener('click', () => sizesRowsContainer.innerHTML = '');

    // --- PRICE SECTION LOGIC ---
    const pricesRowsContainer = document.getElementById('prices-rows');
    const generatePriceSizesBtn = document.getElementById('generate-price-sizes-btn');
    const sizesPriceInput = document.getElementById('sizes-for-price');
    const addPriceRowBtn = document.getElementById('add-price-row');
    const clearPricesBtn = document.getElementById('clear-prices');

    if(generatePriceSizesBtn) {
        generatePriceSizesBtn.addEventListener('click', () => {
            const raw = sizesPriceInput.value.trim();
            if (!raw) return;
            const sizes = raw.split(/[,;\s]+/).map(s => s.trim()).filter(Boolean);
            if(pricesRowsContainer) {
                pricesRowsContainer.innerHTML = '';
                sizes.forEach(s => pricesRowsContainer.appendChild(createPriceRow(s.toUpperCase(), 0)));
            }
        });
    }

    if(addPriceRowBtn) addPriceRowBtn.addEventListener('click', () => pricesRowsContainer.appendChild(createPriceRow()));
    if(clearPricesBtn) clearPricesBtn.addEventListener('click', () => pricesRowsContainer.innerHTML = '');clearPricesBtn?.addEventListener('click', () => {
      pricesRowsContainer.innerHTML = '';
    });

    // Batch apply price to selected sizes
    const applyPriceInput = document.getElementById('apply-price-input');
    const applyPriceBtn = document.getElementById('apply-price-btn');
    applyPriceBtn?.addEventListener('click', () => {
      const raw = Number(applyPriceInput.value || 0);
      const v = Number.isFinite(raw) ? raw : 0;
      const rows = pricesRowsContainer.querySelectorAll('div');
      rows.forEach(r => {
        // Support markup variants: data-price-select, any checkbox, or class-based rows
        const chk = r.querySelector('[data-price-select], input[type="checkbox"], .row-checkbox');
        const priceInput = r.querySelector('[data-price-input], input[type="number"], .price-input, .size-price-input');
        if (chk && chk.checked && priceInput) {
          // Set formatted value (2 decimal places)
          priceInput.value = v.toFixed(2);
          // trigger input so listeners update state
          priceInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });

      // Try to sync hidden sizesPrice object if helper exists
      try {
        if (typeof getSizesPriceObject === 'function') {
          const obj = getSizesPriceObject();
          if (sizesPriceHidden) sizesPriceHidden.value = JSON.stringify(obj);
        }
      } catch (e) { /* ignore */ }
    });

    // Helpers for sizes inventory/prices (used by submit and UI helpers)
    function renderSizeRows(obj){
      if(!sizesRowsContainer) return;
      sizesRowsContainer.innerHTML = '';
      const data = obj || {};
      Object.keys(data).forEach(size => {
        const qty = data[size];
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.innerHTML = `<input data-select type="checkbox" class="h-4 w-4" /><input class="flex-1 border rounded p-2" data-size-input type="text" value="${size}" /><input class="w-24 border rounded p-2" data-qty-input type="number" min="0" value="${Number(qty)||0}" /><button type="button" class="px-3 py-2 bg-red-600 text-white rounded-md" data-remove>Remove</button>`;
        row.querySelector('[data-remove]')?.addEventListener('click', ()=>row.remove());
        sizesRowsContainer.appendChild(row);
      });
    }

    function getSizesInventoryObject(){
      const obj = {};
      const rows = sizesRowsContainer ? sizesRowsContainer.querySelectorAll('div') : [];
      rows.forEach(row => {
        const sizeInput = row.querySelector('[data-size-input]') || row.querySelector('.size-name-input') || row.querySelector('input[type="text"]');
        const qtyInput = row.querySelector('[data-qty-input]') || row.querySelector('.size-qty-input') || row.querySelector('input[type="number"]');
        if(!sizeInput || !qtyInput) return;
        const size = String(sizeInput.value||'').trim();
        const qty = Math.max(0, Math.floor(Number(qtyInput.value||0)));
        if(size) obj[size] = qty;
      });
      return obj;
    }

    function getSizesPriceObject(){
      const obj = {};
      const rows = pricesRowsContainer ? pricesRowsContainer.querySelectorAll('div') : [];
      rows.forEach(row => {
        const sizeInput = row.querySelector('[data-price-size-input]') || row.querySelector('.price-size-input') || row.querySelector('input[type="text"]');
        const priceInput = row.querySelector('[data-price-input]') || row.querySelector('.price-val-input') || row.querySelector('input[type="number"]');
        if(!sizeInput || !priceInput) return;
        const size = String(sizeInput.value||'').trim();
        const price = Number(priceInput.value||0);
        if(size) obj[size] = Number(price.toFixed(2));
      });
      return obj;
    }

    // New arrival presets handling
    newArrivalPresets?.addEventListener('change', (e) => {
      if (e.target.value === 'custom') {
        newArrivalCustom.classList.remove('hidden');
      } else {
        newArrivalCustom.classList.add('hidden');
      }
    });

    addSizeRowBtn?.addEventListener('click', () => {
      renderSizeRows(Object.assign(getSizesInventoryObject(), { '': 0 }));
      // focus on the last empty size input
      const last = sizesRowsContainer.querySelector('div:last-child [data-size-input]');
      if (last) last.focus();
    });

    clearSizesBtn?.addEventListener('click', () => {
      sizesRowsContainer.innerHTML = '';
    });

    // Sizes management - dropdown + tags + per-size rows (copied from Pre-Design UI)
    const sizesSelect = document.getElementById('sizes-select');
    
    
    const sizesTags = document.getElementById('sizes-tags');

    function addOptionIfMissing(size){ size=String(size||'').trim(); if(!size) return; const exists=Array.from(sizesSelect.options).some(o=>o.value.toLowerCase()===size.toLowerCase()); if(!exists){ const opt=document.createElement('option'); opt.value=size; opt.text=size; opt.selected=true; sizesSelect.appendChild(opt); updateSizesTags(); } else { Array.from(sizesSelect.options).forEach(o=>{ if(o.value.toLowerCase()===size.toLowerCase()) o.selected=true; }); } }

    function updateSizesTags(){ sizesTags.innerHTML=''; Array.from(sizesSelect.options).forEach(opt=>{ const wrapper=document.createElement('span'); wrapper.className='inline-flex items-center gap-2 px-2 py-1 bg-gray-200 rounded-full'; const label=document.createElement('span'); label.textContent=opt.value; label.className='text-sm'; const btn=document.createElement('button'); btn.type='button'; btn.className='ml-2 text-xs text-gray-600 hover:text-red-600'; btn.innerHTML='✕'; btn.title='Remove size'; btn.addEventListener('click', ()=>{ showConfirmModal(opt.value, ()=> removeSize(opt.value)); }); wrapper.appendChild(label); wrapper.appendChild(btn); sizesTags.appendChild(wrapper); }); }

    function removeSize(size){ size = String(size||'').trim(); if(!size) return; Array.from(sizesSelect.options).forEach(o=>{ if(o.value.toLowerCase()===size.toLowerCase()) o.remove(); }); Array.from(sizesRowsContainer.querySelectorAll('div')).forEach(row=>{ const si=row.querySelector('[data-size-input]'); if(si && si.value.toLowerCase()===size.toLowerCase()) row.remove(); }); Array.from(pricesRowsContainer.querySelectorAll('div')).forEach(row=>{ const si=row.querySelector('[data-price-size-input]'); if(si && si.value.toLowerCase()===size.toLowerCase()) row.remove(); }); updateSizesTags(); }

    function addSizeRow(size, qty=0){ size=String(size||'').trim(); if(!size) return; const existing=Array.from(sizesRowsContainer.querySelectorAll('[data-size-input]')).some(i=>i.value.toLowerCase()===size.toLowerCase()); if(existing) return; const row=document.createElement('div'); row.className='flex items-center gap-2'; row.innerHTML=`<input data-select type="checkbox" class="h-4 w-4" /><input class="flex-1 border rounded p-2" data-size-input type="text" value="${size}" /><input class="w-24 border rounded p-2" data-qty-input type="number" min="0" value="${Number(qty)||0}" /><button type="button" class="px-3 py-2 bg-red-600 text-white rounded-md" data-remove>Remove</button>`; row.querySelector('[data-remove]').addEventListener('click', ()=>row.remove()); sizesRowsContainer.appendChild(row); }

    function addPriceRow(size, price=0){ size=String(size||'').trim(); if(!size) return; const existing=Array.from(pricesRowsContainer.querySelectorAll('[data-price-size-input]')).some(i=>i.value.toLowerCase()===size.toLowerCase()); if(existing) return; const row=document.createElement('div'); row.className='flex items-center gap-2'; row.innerHTML=`<input data-price-select type="checkbox" class="h-4 w-4" /><input class="flex-1 border rounded p-2" data-price-size-input type="text" value="${size}" /><input class="w-28 border rounded p-2" data-price-input type="number" step="0.01" min="0" value="${Number(price)||0}" /><button type="button" class="px-3 py-2 bg-red-600 text-white rounded-md" data-remove>Remove</button>`; row.querySelector('[data-remove]').addEventListener('click', ()=>row.remove()); pricesRowsContainer.appendChild(row); }

    addSizeBtn?.addEventListener('click', ()=>{ const v=newSizeInput.value.trim(); if(!v) return; addOptionIfMissing(v); addSizeRow(v); addPriceRow(v); newSizeInput.value=''; });
    // support generate field (already present) to bulk-add sizes
    const generateSizesInput = document.getElementById('sizes-generate');
    generateSizesBtn?.addEventListener('click', ()=>{ const raw=(generateSizesInput.value||'').trim(); if(!raw) return; const parts=raw.split(/[,;\s]+/).map(s=>s.trim()).filter(Boolean); parts.forEach(p=>{ addOptionIfMissing(p); addSizeRow(p); addPriceRow(p); }); generateSizesInput.value=''; });
    const generatePriceSizesInput = document.getElementById('sizes-for-price');
    generatePriceSizesBtn?.addEventListener('click', ()=>{ const raw=(generatePriceSizesInput.value||'').trim(); if(!raw) return; const parts=raw.split(/[,;\s]+/).map(s=>s.trim()).filter(Boolean); parts.forEach(p=>{ addOptionIfMissing(p); addPriceRow(p); addSizeRow(p); }); generatePriceSizesInput.value=''; });

    // update tags when sizesSelect changes
    sizesSelect?.addEventListener('change', updateSizesTags);

    // expose removeSize for tag buttons
    const applyQtyInput = document.getElementById('apply-qty-input');
    const applyQtyBtn = document.getElementById('apply-qty-btn');
    applyQtyBtn?.addEventListener('click', () => {
      const v = Math.max(0, Math.floor(Number(applyQtyInput.value || 0)));
      const rows = sizesRowsContainer.querySelectorAll('div');
      rows.forEach(r => {
        // support multiple row markup variants: data-select / data-qty-input, or checkbox + .size-qty-input
        const chk = r.querySelector('[data-select], input[type="checkbox"], .row-checkbox');
        const qtyInput = r.querySelector('[data-qty-input], .size-qty-input, input[type="number"]');
        // only apply when a checkbox is present and checked
        if (chk && chk.checked) {
          if (qtyInput) {
            qtyInput.value = String(v);
            // trigger input event so any listeners update state
            qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
      });

      // Try to sync hidden sizes inventory and total stock if helper exists
      try {
        if (typeof getSizesInventoryObject === 'function') {
          const inv = getSizesInventoryObject();
          if (sizesHidden) sizesHidden.value = JSON.stringify(inv);
          const total = Object.values(inv || {}).reduce((acc, cur) => acc + Number(cur || 0), 0);
          if (stockInput) stockInput.value = total;
        }
      } catch (e) { /* ignore sync errors */ }
    });
    function showMessage(text, type = 'success') {
      messageEl.textContent = text;
      messageEl.className = `mb-4 p-3 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      messageEl.classList.remove('hidden');
      window.scrollTo(0, 0);
      setTimeout(() => messageEl.classList.add('hidden'), 4000);
    }

    let categoriesLoaded = false;

    const categorySelect = document.getElementById('category-select');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const newCategoryInput = document.getElementById('new-category');
    async function fetchCategories() {
        try {
            const res = await fetch(`${API}/api/categories`);
            const json = await res.json();
            if (json.success) {
                window.__categories = json.data || [];
                populateCategorySelect();
            }
        } catch (e) { 
            console.error('Fetch Categories Error:', e); 
        }
    }

    function populateCategorySelect() {
        if (!categorySelect || !window.__categories) return;

        // I-save ang current selection kung meron
        const currentVal = categorySelect.value; 

        // I-render ang options
        categorySelect.innerHTML = window.__categories.map(c => 
            `<option value="${c.name}">${c.name}</option>`
        ).join('');

        // Ibalik ang selection kung valid pa
        if (currentVal && Array.from(categorySelect.options).some(o => o.value === currentVal)) {
            categorySelect.value = currentVal;
        }

        // Force show inventory (no logic needed, just show)
        applyCategoryFlags();
        
        // Add change listener (optional, kung may idadagdag ka pa later)
        categorySelect.onchange = () => applyCategoryFlags();
    }

    function applyCategoryFlags() {
        // FORCE SHOW: Siguraduhing laging nakikita ang Inventory at Price sections
        const perSizeSection = document.getElementById('per-size-section');
        const perPriceSection = document.getElementById('per-price-section');

        if (perSizeSection) {
            perSizeSection.classList.remove('hidden');
            perSizeSection.removeAttribute('aria-hidden');
        }
        if (perPriceSection) {
            perPriceSection.classList.remove('hidden');
            perPriceSection.removeAttribute('aria-hidden');
        }
    }

    // --- ADD CATEGORY BUTTON LOGIC ---
    // Listener implemented later (uses addCategory helper)

    // Initial Load
    fetchCategories();

    

    // apply flags when category selection changes
    categorySelect?.addEventListener('change', (e) => {
      applyCategoryFlags();
    });

    async function addCategory(name) {
      if (!name || !name.trim()) return null;
      try {
        const res = await fetch(`${API}/api/categories`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name.trim() })
        });
        return await res.json();
      } catch (e) {
        return { success: false, msg: e.message };
      }
    }

    function createThumbnail(file, index) {
      const url = URL.createObjectURL(file);
      const img = document.createElement('img');
      img.src = url;
      img.alt = `Thumb ${index + 1}`;
      img.className = 'thumb';
      img.dataset.index = index;
      
      img.addEventListener('click', () => {
        document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
        img.classList.add('active');
        mainPreview.src = url;
        mainFile = file;
      });
      
      return img;
    }

    function handleMainImageChange(e) {
      const file = e.target.files[0];
      if (!file) return;
      mainFile = file;
      if(mainPreview) {
          mainPreview.src = URL.createObjectURL(file);
          mainPreview.classList.remove('hidden');
      }
      if(mainPlaceholder) mainPlaceholder.classList.add('hidden');
      
      // Clear active state from gallery
      document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
    }

    // Handlers for front/back previews (match Pre-Design page behavior)
    

    function handleGalleryChange(e) {
      const files = Array.from(e.target.files).slice(0, 8);
      galleryFiles = files;
      thumbsContainer.innerHTML = '';
      
      files.forEach((file, i) => {
        const thumb = createThumbnail(file, i);
        thumbsContainer.appendChild(thumb);
      });

      // If no main image is set, use the first gallery image
      if (!mainFile && files.length > 0) {
        mainFile = files[0];
        mainPreview.src = URL.createObjectURL(files[0]);
        thumbsContainer.querySelector('.thumb')?.classList.add('active');
      }
    }

    addCategoryBtn.addEventListener('click', async () => {
      const name = newCategoryInput.value;
      if (!name) return;
      const res = await addCategory(name);
      if (res && res.success) {
        newCategoryInput.value = '';
        await fetchCategories();
        // Select the newly added category
        categorySelect.value = res.data.name;
        showMessage('Category added successfully.', 'success');
      } else {
        showMessage(res?.msg || 'Failed to add category.', 'error');
      }
    });

    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      // serialize sizesInventory into hidden input so it's included in form data
      try {
        sizesHidden.value = JSON.stringify(getSizesInventoryObject());
        // If per-size inventory present, compute aggregate and set Stock input and hidden count
        try {
          const inv = getSizesInventoryObject();
          const total = Object.keys(inv || {}).reduce((s,k)=>s + (Number(inv[k])||0), 0);
          if (total > 0) {
            stockInput.value = String(total);
            const hidden = document.getElementById('countInStockHidden');
            if (hidden) hidden.value = String(total);
          }
        } catch(e) { /* ignore */ }
      } catch (err) {
        sizesHidden.value = '';
      }
      // serialize sizesPrice
      try {
        sizesPriceHidden.value = JSON.stringify(getSizesPriceObject());
      } catch (err) {
        sizesPriceHidden.value = '';
      }
      // If per-size section is visible, require at least one size with quantity
      try {
        const invVal = sizesHidden.value;
        const perSizeSectionEl = document.getElementById('per-size-section');
        const perSizeVisible = perSizeSectionEl && !perSizeSectionEl.classList.contains('hidden');
        if (perSizeVisible) {
          const parsed = invVal ? JSON.parse(invVal) : {};
          if (!parsed || Object.keys(parsed).length === 0) {
            showMessage('Please add at least one size with quantity before submitting.','error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Product';
            return;
          }
        }
      } catch (e) { /* ignore */ }
      
let calculatedBasePrice = 0;
try {
    const sizesPriceData = getSizesPriceObject();
    const prices = Object.values(sizesPriceData).filter(p => Number(p) > 0);

    if (prices.length > 0) {
        // Kunin ang pinakamababang presyo (cheapest size)
        calculatedBasePrice = Math.min(...prices);
        
        // I-sync din ito sa hidden field na `countInStock` kung ginagamit mo
        document.getElementById('countInStock').value = totalStock; 
    }
} catch (e) {
    console.error('Error calculating base price:', e);
}

      // serialize placements
      try {
        // services removed; only featured and newArrival handled
        let newArrivalExpiresAt = null;
        const preset = newArrivalPresets.value;
        if (preset === 'custom' && newArrivalCustom.value) {
          newArrivalExpiresAt = new Date(newArrivalCustom.value).toISOString();
        } else if (preset && preset !== '') {
          const days = Number(preset) || 0;
          if (days > 0) {
            newArrivalExpiresAt = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString();
          }
        }
        const placementsObj = { featured: !!featuredCheckbox.checked, newArrivalExpiresAt: newArrivalExpiresAt };
        placementsHidden.value = JSON.stringify(placementsObj);
      } catch (err) {
        placementsHidden.value = '';
      }

      const fd = new FormData();
      const formElements = productForm.elements;
      
        // Append all form fields to FormData
          for (const element of formElements) {
            if (!element.name) continue;
            // skip file inputs here (we add files explicitly)
            if (element.type === 'file') continue;
            // skip inputs that use bracketed names (e.g. placements[featured])
            // we serialize complex objects into hidden JSON inputs (e.g. placementsHidden)
            if (element.name && element.name.includes('[')) continue;
            // only include checked checkboxes/radios
            if ((element.type === 'checkbox' || element.type === 'radio') && !element.checked) continue;
            fd.append(element.name, element.value);
          }

      if (mainFile) {
        fd.set('image', mainFile); // Use set to ensure only one main image
      } else {
        showMessage('Please select a main image for the product.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Product';
        return;
      }

      // Append front/back files if provided (match Pre-Design UI behavior)
      

      // Append gallery images, excluding the one that might be the main image
      galleryFiles.forEach((file) => {
        if (file !== mainFile) {
          fd.append('gallery', file);
        }
      });

      try {
        if (DEBUG) {
          try {
            console.groupCollapsed('Debug: Product FormData');
            for (const entry of fd.entries()) {
              const [k, v] = entry;
              if (v instanceof File) {
                console.log(k, `File: ${v.name}`, `${v.size} bytes`, v.type);
              } else {
                console.log(k, v);
              }
            }
            console.log('Gallery files count:', galleryFiles.length);
            console.log('Has mainFile:', !!mainFile);
            console.log('Authorization token present:', !!token);
            console.groupEnd();
          } catch (logErr) { console.warn('FormData debug error', logErr); }
        }
        
        const res = await fetch(`${API}/api/products`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: fd
        });
        let json = null;
        try {
          json = await res.json();
        } catch (parseErr) {
          const text = await res.text();
          throw new Error(`Server responded ${res.status}: ${text ? text.replace(/\s+/g, ' ').slice(0,200) : 'no body'}`);
        }

        if (!res.ok) {
          throw new Error(json?.msg || `Server error ${res.status}`);
        }

        if (json.success) {
          showMessage('Product created successfully!', 'success');
          productForm.reset();
          thumbsContainer.innerHTML = '';
          mainPreview.src = 'https://placehold.co/600x400/e2e8f0/9ca3af?text=Main+Image';
          galleryFiles = [];
          mainFile = null;
          fetchCategories(); // Refresh categories list
        } else {
          showMessage(json.msg || 'Failed to create product. Please check the fields.', 'error');
        }
      } catch (err) {
        showMessage(err.message || 'An unexpected server error occurred.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Product';
      }
    });

    // Event Listeners
    imageInput.addEventListener('change', handleMainImageChange);
    galleryInput.addEventListener('change', handleGalleryChange);
    

    // --- Stock/Price assign modal handling ---
    // Modal markup will be inserted in DOM via HTML (below). Hook handlers here.
    const assignStockBtn = document.getElementById('assign-stock-btn');
    const stockModal = document.getElementById('stock-modal');
    const stockModalClose = document.getElementById('stock-modal-close');
    const stockModalAdd = document.getElementById('stock-modal-add');
    const stockModalSize = document.getElementById('stock-modal-size');
    const stockModalQty = document.getElementById('stock-modal-qty');

    const assignPriceBtn = document.getElementById('assign-price-btn');
    const priceModal = document.getElementById('price-modal');
    const priceModalClose = document.getElementById('price-modal-close');
    const priceModalAdd = document.getElementById('price-modal-add');
    const priceModalPrice = document.getElementById('price-modal-price');
    const priceModalSizesContainer = document.getElementById('price-modal-sizes');

    function openModal(modal) { modal?.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
    function closeModal(modal) { modal?.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }

    // populate datalist for sizes used by stock modal
    function populateSizesDatalist() {
      const dl = document.getElementById('sizes-datalist');
      if (!dl) return;
      dl.innerHTML = '';
      const sizesText = (document.getElementById('sizes-generate')?.value || '');
      const fromInput = sizesText.split(',').map(s=>s.trim()).filter(Boolean);
      const inv = getSizesInventoryObject();
      const invSizes = Object.keys(inv || {});
      const all = Array.from(new Set([...fromInput, ...invSizes]));
      all.forEach(s => {
        const opt = document.createElement('option'); opt.value = s; dl.appendChild(opt);
      });
    }

    document.getElementById('sizes-generate')?.addEventListener('input', populateSizesDatalist);

    assignStockBtn?.addEventListener('click', () => {
      // refresh datalist options then open modal
      populateSizesDatalist();
      // Prefill qty from main stock input
      stockModalQty.value = Number(stockInput?.value || 0);
      stockModalSize.value = '';
      openModal(stockModal);
    });
    stockModalClose?.addEventListener('click', () => closeModal(stockModal));

    stockModalAdd?.addEventListener('click', () => {
      const size = String(stockModalSize.value||'').trim();
      const qty = Math.max(0, Math.floor(Number(stockModalQty.value||0)));
      if (!size) { showMessage('Please enter a size name', 'error'); return; }
      // If size exists in rows, add qty, otherwise create
      const rows = sizesRowsContainer.querySelectorAll('div');
      let found = false;
      rows.forEach(r => {
        const sizeInput = r.querySelector('[data-size-input]');
        const qtyInput = r.querySelector('[data-qty-input]');
        if (sizeInput && String(sizeInput.value||'').trim().toLowerCase() === size.toLowerCase()) {
          qtyInput.value = Math.max(0, Math.floor(Number(qtyInput.value||0)) + qty);
          found = true;
        }
      });
      if (!found) {
        const obj = getSizesInventoryObject();
        obj[size] = (obj[size] || 0) + qty;
        renderSizeRows(obj);
      }
      // Hide original sizes input in Product Details and show per-size area
      const sizesField = document.querySelector('label[for="sizes"]')?.closest('div');
      if (sizesField) sizesField.style.display = 'none';
      // Enable price input if at least one size has qty > 0
      const inv = getSizesInventoryObject();
      const hasStock = Object.values(inv).some(v => Number(v) > 0);
      if (hasStock) document.getElementById('price')?.removeAttribute('disabled');
      closeModal(stockModal);
    });

    // Price assign (button exists in DOM)
    assignPriceBtn?.addEventListener('click', () => {
      // Only allow price assign when there is per-size stock
      const inv = getSizesInventoryObject();
      if (!inv || Object.keys(inv).length === 0) {
        showMessage('Please assign quantity stock per size before assigning per-size prices.', 'error');
        return;
      }
      // populate sizes list from current inventory
      priceModalSizesContainer.innerHTML = '';
      Object.keys(inv).forEach(s => {
        const row = document.createElement('label');
        row.className = 'inline-flex items-center gap-2 mr-2';
        row.innerHTML = `<input type="checkbox" value="${s}" /> <span>${s} (${inv[s]})</span>`;
        priceModalSizesContainer.appendChild(row);
      });
      priceModalPrice.value = document.getElementById('price')?.value || '';
      openModal(priceModal);
    });
    priceModalClose?.addEventListener('click', () => closeModal(priceModal));
    priceModalAdd?.addEventListener('click', () => {
      const p = Number(priceModalPrice.value||0);
      if (!p) { showMessage('Enter a valid price', 'error'); return; }
      const checks = Array.from(priceModalSizesContainer.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
      if (checks.length === 0) { showMessage('Select at least one size', 'error'); return; }
      const obj = getSizesPriceObject();
      checks.forEach(s => { obj[s] = p; });
      renderPriceRows(obj);
      // enable main price (already enabled if sizes exist)
      document.getElementById('price')?.removeAttribute('disabled');
      closeModal(priceModal);
    });


    // Confirmation modal logic
    let pendingConfirm = null;
    function showConfirmModal(size, onConfirm){
      const modal = document.getElementById('confirm-modal');
      const text = document.getElementById('confirm-modal-text');
      const yes = document.getElementById('confirm-modal-yes');
      const no = document.getElementById('confirm-modal-no');
      if(!modal || !text || !yes || !no) { if(onConfirm) onConfirm(); return; }
      text.textContent = `Remove size "${size}" and its per-size rows? This cannot be undone.`;
      modal.classList.remove('hidden');
      pendingConfirm = ()=>{ try{ onConfirm && onConfirm(); } finally { hideConfirmModal(); } };
      yes.focus();
    }
    function hideConfirmModal(){ const modal=document.getElementById('confirm-modal'); if(modal) modal.classList.add('hidden'); pendingConfirm = null; }
    document.addEventListener('click', (e)=>{
      const modal = document.getElementById('confirm-modal'); if(!modal || modal.classList.contains('hidden')) return; const target = e.target;
      if(target.id === 'confirm-modal') hideConfirmModal();
    });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ hideConfirmModal(); } if(e.key === 'Enter'){ const modal=document.getElementById('confirm-modal'); if(modal && !modal.classList.contains('hidden')){ e.preventDefault(); pendingConfirm && pendingConfirm(); } } });
    document.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'confirm-modal-yes'){ pendingConfirm && pendingConfirm(); } if(e.target && e.target.id === 'confirm-modal-no'){ hideConfirmModal(); } });

    // Initial Load
    (async () => {
      await fetchCategories();
      // Type-specific redirect removed; use dedicated Add Pre-Design page instead
    })();
  </script>
  <!-- Confirm modal -->
  <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md p-6">
      <h3 class="text-lg font-semibold mb-2">Confirm removal</h3>
      <p id="confirm-modal-text" class="text-sm text-gray-700 mb-4">Are you sure?</p>
      <div class="flex justify-end gap-3">
        <button id="confirm-modal-no" type="button" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
        <button id="confirm-modal-yes" type="button" class="px-4 py-2 bg-red-600 text-white rounded-md">Remove</button>
      </div>
    </div>
  </div>
  </div>
</body>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    const anchors = Array.from(document.querySelectorAll('a[href="add-product.html"]'));
    if(anchors.length===0) return;
    anchors.forEach(anchor=>{
      let submenu = anchor.parentElement.querySelector('.add-product-submenu');
      if(!submenu){
                submenu = document.createElement('div');
                submenu.className = 'add-product-submenu hidden mt-1 flex flex-col';
                submenu.innerHTML = '<a href="add-predisign-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i class="w-6"></i><span class="ml-3 text-sm">Add Pre-Design Product</span></a>';
        anchor.insertAdjacentElement('afterend', submenu);
      }
      anchor.style.cursor='pointer';
      if (location.pathname.endsWith('add-product.html') || location.pathname.endsWith('add-predisign-product.html')) submenu.classList.remove('hidden');
    });
    const mainNavLinks = Array.from(document.querySelectorAll('nav a')).filter(a=>{ const h=a.getAttribute('href'); return h && h!=='add-product.html' && h!=='add-predisign-product.html'; });
    mainNavLinks.forEach(l=>{ l.addEventListener('click', ()=>{ document.querySelectorAll('.add-product-submenu').forEach(s=>s.classList.add('hidden')); }); });
    window.addEventListener('popstate', ()=> document.querySelectorAll('.add-product-submenu').forEach(s=>s.classList.add('hidden')));
  });
})();
</script>
</html>
