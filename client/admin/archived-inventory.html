<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Deleted Items</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Fixed Sidebar Styles */
        .admin-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 40;
        }
        .admin-sidebar::-webkit-scrollbar { width: 6px; }
        .admin-sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        
        .admin-main { margin-left: 260px; }
        
        @media (max-width: 768px) {
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .admin-sidebar.open { transform: translateX(0); }
            .admin-main { margin-left: 0; }
        }

        /* Nav Link Styles */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: rgba(255,255,255,0.7);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 2px;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .nav-link.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .nav-link i { width: 20px; text-align: center; }
        
        /* Section Title */
        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255,255,255,0.4);
            padding: 0 16px;
            margin-bottom: 8px;
            margin-top: 16px;
        }

        .archived-row:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Fixed Sidebar -->
    <aside class="admin-sidebar hidden md:flex flex-col">
        <!-- Logo -->
        <div class="p-5 border-b border-white/10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-xl flex items-center justify-center">
                    <i class="fas fa-tshirt text-white text-lg"></i>
                </div>
                <div>
                    <span class="text-white font-bold text-lg">Fundamental</span>
                    <span class="block text-xs text-indigo-300">Admin Panel</span>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 p-3">
            <!-- Main Section -->
            <div class="nav-section-title">Main</div>
            <a href="index.html" class="nav-link">
                <i class="fas fa-th-large"></i><span>Dashboard</span>
            </a>
            <a href="orders.html" class="nav-link">
                <i class="fas fa-shopping-bag"></i><span>Orders</span>
            </a>
            <a href="returns.html" class="nav-link">
                <i class="fas fa-undo"></i><span>Returns & Refunds</span>
            </a>
            <a href="messages.html" class="nav-link">
                <i class="fas fa-comments"></i><span>Messages</span>
            </a>
            
            <!-- Products Section -->
            <div class="nav-section-title">Products</div>
            <a href="add-product.html" class="nav-link">
                <i class="fas fa-plus-circle"></i><span>Add Product</span>
            </a>
            <a href="add-predisign-product.html" class="nav-link">
                <i class="fas fa-tshirt"></i><span>Add Pre-Design</span>
            </a>
            <a href="inventory.html" class="nav-link">
                <i class="fas fa-boxes"></i><span>Inventory</span>
            </a>
            <a href="archived-inventory.html" class="nav-link active">
                <i class="fas fa-trash-alt"></i><span>Deleted Items</span>
            </a>
            <a href="manage-categories.html" class="nav-link">
                <i class="fas fa-folder"></i><span>Categories</span>
            </a>
            <a href="featured-products.html" class="nav-link">
                <i class="fas fa-star"></i><span>Featured Products</span>
            </a>
            
            <!-- Analytics Section -->
            <div class="nav-section-title">Analytics</div>
            <a href="reports.html" class="nav-link">
                <i class="fas fa-chart-bar"></i><span>Reports & Sales</span>
            </a>
            <a href="vouchers.html" class="nav-link">
                <i class="fas fa-ticket-alt"></i><span>Vouchers</span>
            </a>
            
            <!-- Admin Section -->
            <div class="nav-section-title">Admin</div>
            <a href="employees.html" class="nav-link">
                <i class="fas fa-users"></i><span>Employees</span>
            </a>
        </nav>
        
        <!-- Bottom Section -->
        <div class="p-3 border-t border-white/10 mt-auto">
            <a href="settings.html" class="nav-link">
                <i class="fas fa-cog"></i><span>Settings</span>
            </a>
            <a href="profile.html" class="nav-link">
                <i class="fas fa-user-circle"></i><span>Profile</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main min-h-screen">
        <!-- Top Header -->
        <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Deleted Items</h1>
                    <p class="text-sm text-gray-500">Restore or permanently delete items</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <a href="inventory.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Inventory
                </a>
                <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
                    <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-semibold text-sm" id="user-avatar">A</div>
                    <button id="logout-btn" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-trash-alt text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="total-archived">0</p>
                            <p class="text-sm text-gray-500">Total Deleted</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-box text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="archived-products">0</p>
                            <p class="text-sm text-gray-500">Products</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-fill-drip text-teal-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="archived-materials">0</p>
                            <p class="text-sm text-gray-500">Materials</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-layer-group text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="archived-fabrics">0</p>
                            <p class="text-sm text-gray-500">Fabrics</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="search-input" 
                                placeholder="Search deleted items..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 pl-10"
                            />
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Type Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <select id="type-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="all">All Types</option>
                            <option value="product">Products</option>
                            <option value="material">Materials</option>
                            <option value="fabric">Fabrics</option>
                            <option value="pre-design-apparel">Pre-Design</option>
                        </select>
                    </div>

                    <!-- Bulk Actions -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bulk Actions</label>
                        <div class="flex gap-2">
                            <button id="restore-selected-btn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-undo mr-2"></i>Restore Selected
                            </button>
                            <button id="delete-selected-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-trash-alt mr-2"></i>Delete Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Container -->
            <div id="message-container" class="hidden mb-4 p-4 rounded-lg"></div>

            <!-- Deleted Items Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left">
                                    <input type="checkbox" id="select-all" class="h-4 w-4 text-indigo-600 border-gray-300 rounded cursor-pointer">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Item</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Deleted On</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archived-tbody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading deleted items...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prev-btn-mobile" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            Previous
                        </button>
                        <button id="next-btn-mobile" class="ml-3 px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            Next
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-items">0</span> results
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                <button id="prev-btn" class="px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span class="px-4 py-2 border-t border-b border-gray-300 bg-white text-sm font-medium text-gray-700">
                                    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                                </span>
                                <button id="next-btn" class="px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Restore Confirmation Modal -->
    <div id="restore-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4">
                <div class="flex items-center justify-center w-12 h-12 mx-auto bg-green-100 rounded-full mb-4">
                    <i class="fas fa-undo text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Restore Item?</h3>
                <p class="text-sm text-gray-500 text-center mb-6">
                    Are you sure you want to restore "<span id="restore-item-name" class="font-semibold"></span>"?
                    <br><span class="text-green-600">This will return the item to your active inventory.</span>
                </p>
                <div class="flex justify-center gap-3">
                    <button id="cancel-restore-btn" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button id="confirm-restore-btn" class="px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-undo mr-2"></i>Restore
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Permanent Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4">
                <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Permanently Delete?</h3>
                <p class="text-sm text-gray-500 text-center mb-2">
                    Are you sure you want to permanently delete "<span id="delete-item-name" class="font-semibold"></span>"?
                </p>
                <p class="text-sm text-red-600 text-center mb-6">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    This action cannot be undone!
                </p>
                <div class="flex justify-center gap-3">
                    <button id="cancel-delete-btn" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button id="confirm-delete-btn" class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        <i class="fas fa-trash-alt mr-2"></i>Delete Forever
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Orders Warning Modal -->
    <div id="pending-orders-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
            <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                    </div>
                    <h3 class="text-white font-semibold text-lg">Cannot Delete Item</h3>
                </div>
            </div>
            <div class="p-6">
                <p id="pending-modal-message" class="text-gray-700 mb-4"></p>
                <div id="pending-orders-list" class="max-h-48 overflow-y-auto mb-4"></div>
                <p class="text-sm text-gray-500 italic">Please deliver or cancel the pending order(s) before deleting this item.</p>
            </div>
            <div class="px-6 pb-6">
                <button id="close-pending-modal" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                    <i class="fas fa-check mr-2"></i>Understood
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script>
        const API_BASE = 'https://fundamental-apparel-backend.onrender.com';
        const token = localStorage.getItem('adminToken');

        // State
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = { type: 'all', search: '' };
        let selectedItems = new Set();
        let actionItemId = null;
        let actionItemName = '';

        // Auth check
        if (!token) {
            window.location.href = 'login.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadArchivedItems();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Filters
            document.getElementById('type-filter').addEventListener('change', handleFilterChange);
            document.getElementById('search-input').addEventListener('input', debounce(handleFilterChange, 500));

            // Pagination
            document.getElementById('prev-btn').addEventListener('click', () => changePage(currentPage - 1));
            document.getElementById('next-btn').addEventListener('click', () => changePage(currentPage + 1));
            document.getElementById('prev-btn-mobile').addEventListener('click', () => changePage(currentPage - 1));
            document.getElementById('next-btn-mobile').addEventListener('click', () => changePage(currentPage + 1));

            // Select All
            document.getElementById('select-all').addEventListener('change', handleSelectAll);

            // Bulk Actions
            document.getElementById('restore-selected-btn').addEventListener('click', bulkRestore);
            document.getElementById('delete-selected-btn').addEventListener('click', bulkDelete);

            // Modals
            document.getElementById('cancel-restore-btn').addEventListener('click', closeRestoreModal);
            document.getElementById('confirm-restore-btn').addEventListener('click', confirmRestore);
            document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            });
        }

        // Load archived items
        async function loadArchivedItems() {
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 10,
                    type: currentFilters.type,
                    search: currentFilters.search,
                    sortBy: 'archivedAt',
                    sortOrder: 'desc',
                    archived: 'true'
                });

                const response = await fetch(`${API_BASE}/api/admin/inventory?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load archived items');

                const data = await response.json();
                
                renderArchivedItems(data.data);
                updatePagination(data.pagination);
                updateStats(data.data, data.pagination.totalItems);

            } catch (error) {
                console.error('Error:', error);
                showError('Failed to load deleted items');
            }
        }

        // Render deleted items
        function renderArchivedItems(items) {
            const tbody = document.getElementById('archived-tbody');
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-trash-alt text-4xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">No deleted items</p>
                            <p class="text-sm">Items you delete will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const typeBadge = getTypeBadge(item.type);
                const deletedDate = item.archivedAt ? new Date(item.archivedAt).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                }) : 'Unknown';
                
                const quantity = item.sizesInventory && Object.keys(item.sizesInventory).length > 0
                    ? Object.values(item.sizesInventory).reduce((a, b) => a + Number(b || 0), 0)
                    : item.quantity || 0;

                return `
                    <tr class="archived-row">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="item-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded cursor-pointer" data-id="${item._id}" ${selectedItems.has(item._id) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-10 h-10 rounded-lg object-cover" alt="">` : `<div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center"><i class="fas fa-box text-gray-400"></i></div>`}
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${escapeHtml(item.name)}</div>
                                    ${item.sku ? `<div class="text-xs text-gray-500">SKU: ${escapeHtml(item.sku)}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">${typeBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${quantity.toLocaleString()} ${item.unit || 'pcs'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">₱${(item.price || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${deletedDate}</div>
                            <div class="text-xs text-gray-500">${getTimeAgo(item.archivedAt)}</div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="openRestoreModal('${item._id}', '${escapeHtml(item.name).replace(/'/g, "\\'")}')" class="text-green-600 hover:text-green-800 mr-3" title="Restore">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button onclick="openDeleteModal('${item._id}', '${escapeHtml(item.name).replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800" title="Delete Forever">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Re-attach checkbox listeners
            document.querySelectorAll('.item-checkbox').forEach(cb => {
                cb.addEventListener('change', handleItemSelect);
            });
        }

        function getTypeBadge(type) {
            const badges = {
                'product': '<span class="px-2 py-1 text-xs font-semibold text-blue-700 bg-blue-100 rounded-full">Product</span>',
                'material': '<span class="px-2 py-1 text-xs font-semibold text-teal-700 bg-teal-100 rounded-full">Material</span>',
                'fabric': '<span class="px-2 py-1 text-xs font-semibold text-purple-700 bg-purple-100 rounded-full">Fabric</span>',
                'pre-design-apparel': '<span class="px-2 py-1 text-xs font-semibold text-amber-700 bg-amber-100 rounded-full">Pre-Design</span>'
            };
            return badges[type] || badges.product;
        }

        function getTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 2592000) return `${Math.floor(diff / 86400)} days ago`;
            return `${Math.floor(diff / 2592000)} months ago`;
        }

        function updateStats(items, total) {
            document.getElementById('total-archived').textContent = total;
            
            // Count by type
            let products = 0, materials = 0, fabrics = 0;
            items.forEach(item => {
                if (item.type === 'product' || item.type === 'pre-design-apparel') products++;
                else if (item.type === 'material') materials++;
                else if (item.type === 'fabric') fabrics++;
            });
            
            // For accurate counts, we'd need backend support. For now, show current page counts
            // This is a simplified version
        }

        function updatePagination(pagination) {
            currentPage = pagination.currentPage;
            totalPages = pagination.totalPages;
            
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('total-items').textContent = pagination.totalItems;
            
            const start = pagination.totalItems === 0 ? 0 : ((currentPage - 1) * pagination.itemsPerPage + 1);
            const end = Math.min(currentPage * pagination.itemsPerPage, pagination.totalItems);
            document.getElementById('showing-start').textContent = start;
            document.getElementById('showing-end').textContent = end;

            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
        }

        function handleFilterChange() {
            currentFilters.type = document.getElementById('type-filter').value;
            currentFilters.search = document.getElementById('search-input').value;
            currentPage = 1;
            selectedItems.clear();
            updateBulkButtons();
            loadArchivedItems();
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadArchivedItems();
        }

        function handleSelectAll(e) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                if (e.target.checked) {
                    selectedItems.add(cb.dataset.id);
                } else {
                    selectedItems.delete(cb.dataset.id);
                }
            });
            updateBulkButtons();
        }

        function handleItemSelect(e) {
            if (e.target.checked) {
                selectedItems.add(e.target.dataset.id);
            } else {
                selectedItems.delete(e.target.dataset.id);
            }
            updateBulkButtons();
            
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            document.getElementById('select-all').checked = allChecked;
        }

        function updateBulkButtons() {
            const hasSelected = selectedItems.size > 0;
            document.getElementById('restore-selected-btn').disabled = !hasSelected;
            document.getElementById('delete-selected-btn').disabled = !hasSelected;
        }

        // Restore Modal
        window.openRestoreModal = function(id, name) {
            actionItemId = id;
            actionItemName = name;
            document.getElementById('restore-item-name').textContent = name;
            document.getElementById('restore-modal').classList.remove('hidden');
            document.getElementById('restore-modal').classList.add('flex');
        };

        function closeRestoreModal() {
            document.getElementById('restore-modal').classList.remove('flex');
            document.getElementById('restore-modal').classList.add('hidden');
            actionItemId = null;
        }

        async function confirmRestore() {
            if (!actionItemId) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/inventory/${actionItemId}/restore`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to restore item');

                showSuccess('Item restored successfully!');
                closeRestoreModal();
                loadArchivedItems();
            } catch (error) {
                showError(error.message);
            }
        }

        // Delete Modal
        window.openDeleteModal = function(id, name) {
            actionItemId = id;
            actionItemName = name;
            document.getElementById('delete-item-name').textContent = name;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('flex');
        };

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('flex');
            document.getElementById('delete-modal').classList.add('hidden');
            actionItemId = null;
        }

        // Pending orders modal functions
        function showPendingOrdersModal(result) {
            const pendingModal = document.getElementById('pending-orders-modal');
            const pendingModalMessage = document.getElementById('pending-modal-message');
            const pendingOrdersList = document.getElementById('pending-orders-list');
            
            pendingModalMessage.textContent = result.message;
            
            // Build the list of pending orders
            if (result.pendingOrders && result.pendingOrders.length > 0) {
                let listHtml = '<div class="space-y-2">';
                result.pendingOrders.forEach(order => {
                    const orderDate = new Date(order.createdAt).toLocaleDateString('en-PH', { 
                        year: 'numeric', month: 'short', day: 'numeric' 
                    });
                    const statusColor = {
                        'Processing': 'bg-yellow-100 text-yellow-800',
                        'Accepted': 'bg-blue-100 text-blue-800',
                        'Shipped': 'bg-purple-100 text-purple-800'
                    }[order.status] || 'bg-gray-100 text-gray-800';
                    
                    listHtml += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div>
                                <p class="font-medium text-gray-800 text-sm">Order #${order._id.slice(-8).toUpperCase()}</p>
                                <p class="text-xs text-gray-500">${order.customerName} • ${orderDate}</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${order.status}</span>
                        </div>
                    `;
                });
                listHtml += '</div>';
                pendingOrdersList.innerHTML = listHtml;
            } else {
                pendingOrdersList.innerHTML = '';
            }

            closeDeleteModal();
            pendingModal.classList.remove('hidden');
            pendingModal.classList.add('flex');
        }

        function closePendingOrdersModal() {
            const pendingModal = document.getElementById('pending-orders-modal');
            pendingModal.classList.add('hidden');
            pendingModal.classList.remove('flex');
        }

        // Setup pending modal close events
        document.getElementById('close-pending-modal').addEventListener('click', closePendingOrdersModal);
        document.getElementById('pending-orders-modal').addEventListener('click', (e) => {
            if (e.target.id === 'pending-orders-modal') closePendingOrdersModal();
        });

        async function confirmDelete() {
            if (!actionItemId) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/inventory/${actionItemId}/permanent`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                
                if (!response.ok) {
                    if (result.hasPendingOrders) {
                        // Show pending orders warning modal
                        showPendingOrdersModal(result);
                        return;
                    }
                    throw new Error(result.message || 'Failed to delete item');
                }

                showSuccess('Item permanently deleted!');
                closeDeleteModal();
                loadArchivedItems();
            } catch (error) {
                showError(error.message);
            }
        }

        // Bulk Actions
        async function bulkRestore() {
            if (selectedItems.size === 0) return;
            
            const count = selectedItems.size;
            if (!confirm(`Restore ${count} item(s) to inventory?`)) return;

            let success = 0, failed = 0;
            
            for (const id of selectedItems) {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/inventory/${id}/restore`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) success++;
                    else failed++;
                } catch (e) {
                    failed++;
                }
            }

            selectedItems.clear();
            updateBulkButtons();
            document.getElementById('select-all').checked = false;
            
            if (failed === 0) {
                showSuccess(`${success} item(s) restored successfully!`);
            } else {
                showError(`Restored ${success}, failed ${failed}`);
            }
            
            loadArchivedItems();
        }

        async function bulkDelete() {
            if (selectedItems.size === 0) return;
            
            const count = selectedItems.size;
            if (!confirm(`PERMANENTLY DELETE ${count} item(s)? This cannot be undone!`)) return;

            let success = 0, failed = 0;
            
            for (const id of selectedItems) {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/inventory/${id}/permanent`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) success++;
                    else failed++;
                } catch (e) {
                    failed++;
                }
            }

            selectedItems.clear();
            updateBulkButtons();
            document.getElementById('select-all').checked = false;
            
            if (failed === 0) {
                showSuccess(`${success} item(s) permanently deleted!`);
            } else {
                showError(`Deleted ${success}, failed ${failed}`);
            }
            
            loadArchivedItems();
        }

        // Utilities
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function showSuccess(msg) {
            const container = document.getElementById('message-container');
            container.className = 'mb-4 p-4 rounded-lg bg-green-100 text-green-800';
            container.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${msg}`;
            container.classList.remove('hidden');
            setTimeout(() => container.classList.add('hidden'), 4000);
        }

        function showError(msg) {
            const container = document.getElementById('message-container');
            container.className = 'mb-4 p-4 rounded-lg bg-red-100 text-red-800';
            container.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${msg}`;
            container.classList.remove('hidden');
            setTimeout(() => container.classList.add('hidden'), 4000);
        }
    </script>
</body>
</html>
