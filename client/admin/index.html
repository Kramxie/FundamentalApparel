<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-16 bg-white shadow-md">
                <span class="text-2xl font-bold text-indigo-600">Admin Panel</span>
            </div>
            <div class="flex flex-col flex-grow p-4">
                <nav class="flex-grow space-y-2">
                    <a href="index.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-md">
                        <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
                    </a>
                    <a href="add-product.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-plus-circle w-6"></i><span class="ml-3">Add Product</span>
                    </a>
                     <a href="manage-products.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-box-open w-6"></i><span class="ml-3">Manage Products</span>
                    </a>
                    <a href="orders.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-clipboard-list w-6"></i><span class="ml-3">Orders</span>
                    </a>
                    <a href="vouchers.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-ticket-alt w-6"></i><span class="ml-3">Vouchers</span>
                    </a>
                    <a href="messages.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                        <i class="fas fa-comments w-6"></i><span class="ml-3">Messages</span>
                    </a>
                </nav>
            </div>
        </div>

        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-16 bg-white border-b border-gray-200 px-6">
                 <div><h1 class="text-xl font-semibold text-gray-800">Dashboard Overview</h1></div>
                <button id="logout-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-md hover:bg-red-600">Logout</button>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-green-100 p-3 rounded-full"><i class="fas fa-dollar-sign text-2xl text-green-600"></i></div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Total Revenue</p>
                            <p id="total-sales" class="text-2xl font-bold text-gray-800">₱0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full"><i class="fas fa-wallet text-2xl text-blue-600"></i></div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Sales Today</p>
                            <p id="today-sales" class="text-2xl font-bold text-gray-800">₱0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full"><i class="fas fa-shopping-cart text-2xl text-yellow-600"></i></div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Total Orders</p>
                            <p id="total-orders" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-purple-100 p-3 rounded-full"><i class="fas fa-users text-2xl text-purple-600"></i></div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">New Customers Today</p>
                            <p id="new-customers" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Sales (Last 7 Days)</h2>
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Recent Orders</h2>
                        <div id="recent-orders-list" class="space-y-4">
                            <p class="text-gray-500">Loading...</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Low Stock Products</h2>
                        <div id="low-stock-list" class="space-y-4">
                             <p class="text-gray-500">Loading...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('adminToken');
            if (!token) { window.location.href = 'login.html'; return; }

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            });

            try {
                const response = await fetch('https://unmumbled-balloonlike-gayle.ngrok-free.dev/api/dashboard/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) throw new Error(result.msg || 'Failed to parse dashboard data.');
                
                const stats = result.data;
                updateUI(stats);

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                alert('Could not load dashboard data. Please try again.');
            }

            function updateUI(stats) {
                document.getElementById('total-sales').textContent = `₱${stats.totalSales.toLocaleString()}`;
                document.getElementById('today-sales').textContent = `₱${stats.todaySales.toLocaleString()}`;
                document.getElementById('total-orders').textContent = stats.totalOrders;
                document.getElementById('new-customers').textContent = stats.newCustomersToday;

                const ordersList = document.getElementById('recent-orders-list');
                ordersList.innerHTML = '';
                if (stats.recentOrders && stats.recentOrders.length > 0) {
                    stats.recentOrders.forEach(order => {
                        // FIX: Safely access user name, provide a fallback if user is null
                        const customerName = order.user ? order.user.name : '[Deleted User]';
                        ordersList.innerHTML += `
                            <div class="flex justify-between items-center text-sm">
                                <div>
                                    <p class="font-semibold text-gray-700">${customerName}</p>
                                    <p class="text-xs text-gray-500">${new Date(order.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-indigo-600">₱${order.totalPrice.toLocaleString()}</p>
                                    <span class="px-2 py-1 text-xs rounded-full ${order.status === 'Delivered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.status || 'Pending'}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    ordersList.innerHTML = '<p class="text-gray-500">No recent orders.</p>';
                }

                const lowStockList = document.getElementById('low-stock-list');
                lowStockList.innerHTML = '';
                 if (stats.lowStockProducts && stats.lowStockProducts.length > 0) {
                    stats.lowStockProducts.forEach(product => {
                         lowStockList.innerHTML += `
                            <div class="flex justify-between items-center text-sm">
                                <p class="font-semibold text-gray-700">${product.name}</p>
                                <p class="font-bold text-red-500">Stock: ${product.countInStock}</p>
                            </div>
                        `;
                    });
                } else {
                    lowStockList.innerHTML = '<p class="text-gray-500">No products with low stock.</p>';
                }

                renderSalesChart(stats.salesLast7Days);
            }

            function renderSalesChart(salesData) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                const labels = [];
                const data = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const formattedDate = date.toISOString().split('T')[0];
                    labels.push(new Date(formattedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    const dayData = salesData.find(d => d._id === formattedDate);
                    data.push(dayData ? dayData.total : 0);
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sales',
                            data: data,
                            borderColor: 'rgb(79, 70, 229)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }
        });
    </script>
</body>
</html>