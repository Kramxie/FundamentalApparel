<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-link,
        .sidebar-parent-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            text-decoration: none;
            color: #374151;
            /* text-gray-700 */
            transition: all 0.2s ease-in-out;
        }

        .sidebar-link:hover,
        .sidebar-parent-link:hover {
            background-color: #f3f4f6;
            /* hover:bg-gray-100 */
        }

        .sidebar-link.sidebar-active {
            color: #4f46e5;
            /* text-indigo-600 */
            font-weight: 600;
        }

        .sidebar-parent-link.sidebar-active {
            color: #4f46e5;
            /* text-indigo-600 */
        }

        .sidebar-icon {
            width: 1.5rem;
            /* w-6 */
            text-align: center;
            margin-right: 0.75rem;
            /* mr-3 */
            font-size: 1.125rem;
            /* text-lg */
        }

        .sidebar-submenu {
            display: none;
            /* Hidden by default */
            padding-left: 2.25rem;
            /* pl-9 */
        }

        .sidebar-parent-link.sidebar-active+.sidebar-submenu {
            display: block;
        }

        #avatar-preview-container {
            width: 10rem;
            /* w-40 */
            height: 10rem;
            /* h-40 */
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #e5e7eb;
            /* border-gray-200 */
            margin: 0 auto;
        }

        #avatar-preview,
        #sidebar-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Styles para sa Purchases Tabs (Kinonvert mula @apply) */
        .purchase-tab {
            flex-shrink: 0;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: center;
            color: #4B5563;
            /* text-gray-600 */
            border-bottom-width: 2px;
            border-color: transparent;
        }

        .purchase-tab.tab-active {
            color: #4F46E5;
            /* text-indigo-600 */
            border-color: #4F46E5;
            /* border-indigo-600 */
            font-weight: 600;
            /* font-semibold */
        }

        
    </style>
</head>

<body class="bg-gray-100">

    <header class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            
            <a href="index.html" class="flex items-center gap-3 group">
                <img src="images/logo.png" alt="Fundamental Logo" class="w-10 h-10 object-contain group-hover:opacity-80 transition">
                <span class="text-xl font-extrabold text-gray-900 tracking-tight group-hover:text-indigo-600 transition">Fundamental</span>
            </a>

            <div class="hidden md:flex space-x-8 items-center font-medium text-sm">
                <a href="index.html" class="text-gray-500 hover:text-indigo-600 transition">Home</a>
                <a href="products.html" class="text-gray-500 hover:text-indigo-600 transition">Products</a>
                <a href="services.html" class="text-gray-500 hover:text-indigo-600 transition">Services</a>
                <a href="#" class="text-gray-500 hover:text-indigo-600 transition">About Us</a>
                <a href="#" class="text-gray-500 hover:text-indigo-600 transition">FAQs</a>
            </div>

            <div class="hidden md:flex items-center space-x-6">
                <button class="text-gray-400 hover:text-indigo-600 transition"><i class="fas fa-search text-lg"></i></button>
                
                <a href="cart.html" class="text-gray-400 hover:text-indigo-600 relative transition">
                    <i class="fas fa-shopping-bag text-lg"></i>
                    <span id="cart-count" class="absolute -top-1 -right-2 bg-indigo-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                </a>

                <div id="auth-links-logged-in" class="pl-4 border-l border-gray-200">
                    <a href="profile.html" id="user-link" class="text-indigo-600 transition flex items-center gap-2">
                        <i id="user-icon" class="fas fa-user-circle text-2xl"></i>
                    </a>
                </div>
            </div>

            <div class="md:hidden">
                <button id="menu-btn" class="text-gray-800 focus:outline-none p-2">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>

        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 absolute w-full left-0 top-full shadow-lg z-40">
            <div class="flex flex-col p-4 space-y-3">
                <a href="index.html" class="text-gray-600 font-medium block py-2 hover:text-indigo-600 transition">Home</a>
                <a href="products.html" class="text-gray-600 font-medium block py-2 hover:text-indigo-600 transition">Products</a>
                <a href="services.html" class="text-gray-600 font-medium block py-2 hover:text-indigo-600 transition">Services</a>
                <a href="#" class="text-gray-600 font-medium block py-2 hover:text-indigo-600 transition">About Us</a>
                <a href="#" class="text-gray-600 font-medium block py-2 hover:text-indigo-600 transition">FAQs</a>
                <hr class="border-gray-100">
                <a href="cart.html" class="flex items-center text-gray-600 py-2 hover:text-indigo-600 transition">
                    <i class="fas fa-shopping-bag mr-3"></i> Cart (<span id="cart-count-mobile">0</span>)
                </a>
                <div class="mt-2 pt-2 border-t border-gray-100">
                    <a href="profile.html" class="flex items-center text-indigo-600 font-medium py-2 transition">
                        <i class="fas fa-user-circle mr-3 text-xl"></i> My Profile
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="loading-container" class="text-center">
            <p class="text-lg text-gray-600">Loading profile...</p>
        </div>

        <div id="profile-container" class="max-w-6xl mx-auto hidden">
            <div class="md:flex md:space-x-8">

                <aside class="md:w-1/4 mb-8 md:mb-0">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex items-center gap-4 border-b pb-4">
                            <div id="sidebar-avatar"
                                class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xl font-bold overflow-hidden">
                                <img id="sidebar-avatar-img" src="" alt="" class="hidden">
                                <span id="sidebar-initials">U</span>
                            </div>
                            <div>
                                <div id="user-name-display" class="font-semibold text-gray-800">User Name</div>
                                <div id="user-email-display" class="text-sm text-gray-500">email@example.com</div>
                            </div>
                        </div>

                        <nav id="sidebar-nav" class="mt-4 space-y-1">
                            <button id="sidebar-parent-account" data-tab-parent="account"
                                class="sidebar-parent-link sidebar-active w-full">
                                <i class="sidebar-icon fas fa-user-circle"></i> My Account
                            </button>
                            <div class="sidebar-submenu">
                                <button data-tab="profile" class="sidebar-link sidebar-active w-full">Profile</button>
                                <button data-tab="addresses" class="sidebar-link w-full">Addresses</button>
                            </div>

                            <button data-tab="purchases" class="sidebar-parent-link w-full">
                                <i class="sidebar-icon fas fa-receipt"></i> My Purchases
                            </button>

                            
                            <a href="my-quotes.html" class="sidebar-parent-link w-full">
                                <i class="sidebar-icon fas fa-file-invoice"></i> My Quotes
                            </a>
                            <button data-tab="vouchers" class="sidebar-parent-link w-full">
                                <i class="sidebar-icon fas fa-ticket-alt"></i> My Vouchers
                            </button>

                            <hr class="my-3">
                            <button id="logout-btn" class="sidebar-parent-link w-full text-red-600 hover:bg-red-50">
                                <i class="sidebar-icon fas fa-sign-out-alt"></i> Logout
                            </button>
                        </nav>
                    </div>
                </aside>

                <div class="flex-1">
                    <div id="tab-content" class="min-h-[600px]">

                        <div id="profile-content" class="bg-white p-6 md:p-8 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">My Profile</h2>
                            <p class="text-gray-500 mb-6">Manage and protect your account</p>
                            <hr class="mb-6">
                            <div id="profile-message-container" class="hidden mb-4"></div>
                            <div class="flex flex-col-reverse lg:flex-row gap-8">
                                <form id="profile-form" class="flex-1 space-y-5">
                                    <div><label class="block text-sm text-gray-700 mb-1">Username</label><input
                                            id="username" name="username" class="w-full border px-3 py-2 rounded" />
                                    </div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Name</label><input id="name"
                                            name="name" class="w-full border px-3 py-2 rounded" /></div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Email</label><input id="email"
                                            name="email" class="w-full border px-3 py-2 rounded bg-gray-100" disabled />
                                    </div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Phone Number</label><input
                                            id="contactNumber" name="contactNumber"
                                            class="w-full border px-3 py-2 rounded" /></div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Gender</label>
                                        <div class="flex items-center gap-6 mt-2"><label
                                                class="flex items-center gap-2"><input type="radio" name="gender"
                                                    value="Male" class="h-4 w-4"> Male</label><label
                                                class="flex items-center gap-2"><input type="radio" name="gender"
                                                    value="Female" class="h-4 w-4"> Female</label><label
                                                class="flex items-center gap-2"><input type="radio" name="gender"
                                                    value="Other" class="h-4 w-4"> Other</label></div>
                                    </div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Date of Birth</label>
                                        <div class="flex gap-3"><input id="dob-day" type="number" placeholder="DD"
                                                class="w-1/3 border px-3 py-2 rounded" min="1" max="31"><input
                                                id="dob-month" type="number" placeholder="MM"
                                                class="w-1/3 border px-3 py-2 rounded" min="1" max="12"><input
                                                id="dob-year" type="number" placeholder="YYYY"
                                                class="w-1/3 border px-3 py-2 rounded" min="1920" max="2020"></div>
                                    </div>
                                    <div class="pt-4"><button type="submit"
                                            class="bg-indigo-600 text-white px-6 py-2 rounded">Save</button></div>
                                </form>
                                <div class="lg:w-1/3 lg:border-l lg:pl-8">
                                    <div id="avatar-message-container" class="hidden mb-4"></div>
                                    <div id="avatar-preview-container"><img id="avatar-preview"
                                            src="https://placehold.co/160x160/e2e8f0/cccccc?text=Avatar"
                                            alt="Profile Picture"></div>
                                    <input type="file" id="avatar-input" accept="image/png,image/jpeg" class="hidden">
                                    <label for="avatar-input"
                                        class="w-full max-w-[200px] text-center block mx-auto mt-4 px-4 py-2 border rounded cursor-pointer hover:bg-gray-50">Select
                                        Image</label>
                                    <button id="avatar-upload-btn"
                                        class="w-full max-w-[200px] text-center block mx-auto mt-2 px-4 py-2 border rounded bg-indigo-600 text-white hover:bg-indigo-700">Save
                                        Image</button>
                                    <p class="text-xs text-gray-500 text-center mt-3">File size: maximum 1 MB<br>File
                                        extension: .JPEG, .PNG</p>
                                </div>
                            </div>
                        </div>

                        <div id="addresses-content" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">My Addresses</h2>
                            <div id="address-message-container" class="hidden mb-4"></div>
                            <div id="addresses-list" class="space-y-4 mb-6"></div>
                            <button id="add-address-btn" class="text-sm text-indigo-600 font-medium">+ Add New
                                Address</button>
                            <form id="address-form" class="hidden mt-6 border-t pt-6 space-y-4">
                                <h3 id="address-form-title" class="text-lg font-semibold">Add New Address</h3>
                                <div id="address-form-id" class="hidden"></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm text-gray-700">Street</label><input
                                            id="addr-street" class="mt-1 block w-full border px-3 py-2 rounded"
                                            required /></div>
                                    <div><label class="block text-sm text-gray-700">City</label><input id="addr-city"
                                            class="mt-1 block w-full border px-3 py-2 rounded" required /></div>
                                    <div><label class="block text-sm text-gray-700">Province</label><input
                                            id="addr-province" class="mt-1 block w-full border px-3 py-2 rounded"
                                            required /></div>
                                    <div><label class="block text-sm text-gray-700">Zip Code</label><input
                                            id="addr-zipCode" class="mt-1 block w-full border px-3 py-2 rounded"
                                            required /></div>
                                </div>
                                <div class="flex justify-end gap-3"><button type="button" id="cancel-address-btn"
                                        class="px-4 py-2 rounded bg-gray-200 text-gray-800">Cancel</button><button
                                        type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Save
                                        Address</button></div>
                            </form>
                        </div>

                        <div id="purchases-content" class="hidden">
                            <div class="bg-white rounded-lg shadow-md">
                                <nav id="purchases-tabs" class="flex items-center border-b overflow-x-auto">
                                    <button data-tab-filter="All"
                                        class="purchase-tab tab-active flex-shrink-0 px-4 py-3 text-center font-semibold text-indigo-600 border-b-2 border-indigo-600">All</button>
                                    <button data-tab-filter="To Pay"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">To
                                        Pay</button>
                                    <button data-tab-filter="To Ship"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">To
                                        Ship</button>
                                    <button data-tab-filter="To Receive"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">To
                                        Receive</button>
                                    <button data-tab-filter="Completed"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">Completed</button>
                                    <button data-tab-filter="Cancelled"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">Cancelled</button>
                                </nav>
                                <div id="purchases-list" class="space-y-4 p-4"></div>
                            </div>
                        </div>

                        <div id="vouchers-content" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">My Vouchers</h2>
                            <div id="vouchers-list" class="space-y-4"></div>
                        </div>

                        
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div id="cancel-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Cancel Order</h3>
                <button id="cancel-modal-close" class="text-gray-500">&times;</button>
            </div>
            <div class="p-4">
                <p class="text-sm mb-3">Please select a reason for cancellation:</p>
                <select id="cancel-reason" class="w-full border p-2 rounded">
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Ordered by mistake">Ordered by mistake</option>
                    <option value="Found a better deal">Found a better deal</option>
                    <option value="Other">Other (Please specify)</option>
                </select>
                <textarea id="cancel-reason-other" class="w-full border p-2 rounded mt-3 hidden"
                    placeholder="Please specify your reason"></textarea>
                <div id="cancel-error" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3">
                <button id="cancel-modal-confirm" class="bg-indigo-600 text-white px-4 py-2 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Cancellation Details</h3>
                <button id="details-modal-close" class="text-gray-500">&times;</button>
            </div>
            <div class="p-4 space-y-2">
                <p class="text-sm"><strong>Cancelled By:</strong> <span id="details-cancelled-by"></span></p>
                <p class="text-sm"><strong>Reason:</strong> <span id="details-reason"></span></p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end">
                <button id="details-modal-ok" class="bg-indigo-600 text-white px-4 py-2 rounded">OK</button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Product Feedback</h3>
                <button id="feedback-modal-close" class="text-gray-500">&times;</button>
            </div>
            <div class="p-4 space-y-4">
                <p class="text-sm text-gray-600">Rate and review the product you received.</p>
                <div id="feedback-product-select-wrapper" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Product</label>
                    <select id="feedback-product-select" class="w-full border p-2 rounded"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating</label>
                    <select id="feedback-rating" class="w-full border p-2 rounded">
                        <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                        <option value="4">⭐⭐⭐⭐ (4)</option>
                        <option value="3">⭐⭐⭐ (3)</option>
                        <option value="2">⭐⭐ (2)</option>
                        <option value="1">⭐ (1)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Comment (optional)</label>
                    <textarea id="feedback-comment" rows="4" class="w-full border p-2 rounded" placeholder="Share your experience..."></textarea>
                </div>
                <div id="feedback-error" class="text-red-500 text-sm hidden"></div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3">
                <button id="feedback-submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Submit Review</button>
            </div>
        </div>
    </div>

    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API = 'https://fundamental-apparel-backend.onrender.com';
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // --- Lahat ng Selectors ---
            const profileContainer = document.getElementById('profile-container');
            const loadingContainer = document.getElementById('loading-container');
            const sidebarAvatar = document.getElementById('sidebar-avatar');
            const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
            const sidebarInitials = document.getElementById('sidebar-initials');
            const userNameDisplay = document.getElementById('user-name-display');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutBtn = document.getElementById('logout-btn');
            const sidebarNav = document.getElementById('sidebar-nav');
            const profileForm = document.getElementById('profile-form');
            const profileMessageContainer = document.getElementById('profile-message-container');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarInput = document.getElementById('avatar-input');
            const avatarUploadBtn = document.getElementById('avatar-upload-btn');
            const avatarMessageContainer = document.getElementById('avatar-message-container');
            let selectedAvatarFile = null;
            const purchasesTabs = document.getElementById('purchases-tabs');
            const purchasesList = document.getElementById('purchases-list');
            let currentCancelOrderId = null;
            let purchasesCache = [];
            let isPurchasesSyncing = false;
            let currentUserId = null;
            const cancelModal = document.getElementById('cancel-modal');
            const cancelModalClose = document.getElementById('cancel-modal-close');
            const cancelModalConfirm = document.getElementById('cancel-modal-confirm');
            const cancelReasonSelect = document.getElementById('cancel-reason');
            const cancelReasonOther = document.getElementById('cancel-reason-other');
            const cancelError = document.getElementById('cancel-error');
            const detailsModal = document.getElementById('details-modal');
            const detailsModalClose = document.getElementById('details-modal-close');
            const detailsModalOk = document.getElementById('details-modal-ok');
            const detailsCancelledBy = document.getElementById('details-cancelled-by');
            const detailsReason = document.getElementById('details-reason');
            const addressesList = document.getElementById('addresses-list');
            const addressMessageContainer = document.getElementById('address-message-container');
            const addAddressBtn = document.getElementById('add-address-btn');
            const addressForm = document.getElementById('address-form');
            const cancelAddressBtn = document.getElementById('cancel-address-btn');
            const vouchersList = document.getElementById('vouchers-list');

            // Custom orders UI removed; My Quotes page is canonical.

            // --- API Helpers ---
            const showMessage = (container, msg, type = 'success') => {
                if (!container) return;
                container.textContent = msg;
                container.className = `p-3 rounded mb-4 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                container.classList.remove('hidden');
                setTimeout(() => container.classList.add('hidden'), 3500);
            };

            // --- NEW: Tracking URL Generator ---
            function getTrackingUrl(courier, trackingCode) {
                const courierUrls = {
                    'Lalamove': null, // Lalamove doesn't have public tracking URL
                    'J&T Express': `https://www.jtexpress.ph/track?billcode=${trackingCode}`,
                    'LBC Express': `https://www.lbcexpress.com/track?tracking_no=${trackingCode}`,
                    'Ninja Van': `https://www.ninjavan.co/en-ph/tracking?id=${trackingCode}`,
                    'Flash Express': `https://www.flashexpress.com/tracking/?se=${trackingCode}`,
                    'JRS Express': `https://www.jrs-express.com/track?code=${trackingCode}`,
                    '2GO Express': `https://www.2go.com.ph/track/${trackingCode}`,
                    'DHL': `https://www.dhl.com/ph-en/home/tracking/tracking-express.html?submit=1&tracking-id=${trackingCode}`,
                    'FedEx': `https://www.fedex.com/fedextrack/?trknbr=${trackingCode}`,
                };
                return courierUrls[courier] || null;
            }

            // --- NEW: Copy to Clipboard Function ---
            function copyToClipboard(text, btn) {
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-green-100', 'text-green-700');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
                        btn.classList.remove('bg-green-100', 'text-green-700');
                    }, 2000);
                }).catch(() => {
                    alert('Failed to copy. Please copy manually.');
                });
            }

            async function apiRequest(path, options = {}) {
                const isFormData = options.body instanceof FormData;
                const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
                if (!isFormData) {
                    headers['Content-Type'] = 'application/json';
                }
                options.headers = headers;
                const res = await fetch(`${API}${path}`, options);
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    throw new Error('Unauthorized');
                }
                return res.json();
            }

            // --- Initial Data Fetch ---
            async function fetchUserData() {
                try {
                    const json = await apiRequest('/api/auth/me');
                    if (!json.success) throw new Error(json.msg || 'Failed to load user');
                    populateUI(json.data);
                    loadingContainer.classList.add('hidden');
                    profileContainer.classList.remove('hidden');

                    // If URL param requests a section, open it
                    const params = new URLSearchParams(window.location.search);
                    const section = params.get('section');
                    if (section) {
                        openSection(section);
                    }
                } catch (err) {
                    console.error('fetchUserData error', err);
                    loadingContainer.innerHTML = `<p class="text-red-500">Failed to load profile: ${err.message}</p>`;
                }
            }
            function openSection(section) {
                // Map to sidebar buttons and trigger click to reuse logic
                if (section === 'profile') {
                    document.querySelector('#sidebar-nav .sidebar-submenu button[data-tab="profile"]').click();
                } else if (section === 'purchases') {
                    document.querySelector('#sidebar-nav button[data-tab="purchases"]').click();
                } else if (section === 'vouchers') {
                    document.querySelector('#sidebar-nav button[data-tab="vouchers"]').click();
                }
            }

            // --- Populate UI ---
            function populateUI(user) {
                userNameDisplay.textContent = user.name || '';
                userEmailDisplay.textContent = user.email || '';
                if (user.avatarUrl) {
                    const avatarTimestamp = `?t=${new Date().getTime()}`;
                    sidebarAvatarImg.src = `${user.avatarUrl}${avatarTimestamp}`;
                    avatarPreview.src = `${user.avatarUrl}${avatarTimestamp}`;
                    sidebarAvatarImg.classList.remove('hidden');
                    sidebarInitials.classList.add('hidden');
                } else {
                    const initials = (user.name || 'U').split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();
                    sidebarInitials.textContent = initials;
                    sidebarAvatarImg.classList.add('hidden');
                    sidebarInitials.classList.remove('hidden');
                    avatarPreview.src = 'https://placehold.co/160x160/e2e8f0/cccccc?text=Avatar';
                }
                profileForm.querySelector('#username').value = user.username || '';
                profileForm.querySelector('#name').value = user.name || '';
                profileForm.querySelector('#email').value = user.email || '';
                profileForm.querySelector('#contactNumber').value = user.contactNumber || '';
                document.querySelectorAll('input[name="gender"]').forEach(radio => {
                    radio.checked = (radio.value === user.gender);
                });
                if (user.dob) {
                    const dob = new Date(user.dob);
                    document.getElementById('dob-day').value = dob.getUTCDate();
                    document.getElementById('dob-month').value = dob.getUTCMonth() + 1;
                    document.getElementById('dob-year').value = dob.getUTCFullYear();
                } else {
                    document.getElementById('dob-day').value = '';
                    document.getElementById('dob-month').value = '';
                    document.getElementById('dob-year').value = '';
                }
            }

            // --- Profile Form Logic ---
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    username: profileForm.querySelector('#username').value,
                    name: profileForm.querySelector('#name').value,
                    contactNumber: profileForm.querySelector('#contactNumber').value,
                    gender: document.querySelector('input[name="gender"]:checked')?.value || '',
                };
                const day = document.getElementById('dob-day').value;
                const month = document.getElementById('dob-month').value;
                const year = document.getElementById('dob-year').value;
                if (day && month && year) {
                    data.dob = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                } else {
                    data.dob = null;
                }
                try {
                    const json = await apiRequest('/api/auth/updatedetails', {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    if (!json.success) throw new Error(json.msg || 'Update failed');
                    populateUI(json.data);
                    showMessage(profileMessageContainer, 'Profile updated successfully.', 'success');
                } catch (err) {
                    showMessage(profileMessageContainer, err.message || 'Update failed', 'error');
                }
            });

            // --- Avatar Upload Logic ---
            avatarInput.addEventListener('change', () => {
                const file = avatarInput.files[0];
                if (file) {
                    if (file.size > 1 * 1024 * 1024) { showMessage(avatarMessageContainer, 'File is too large. Maximum 1 MB.', 'error'); avatarInput.value = ''; return; }
                    if (!['image/jpeg', 'image/png'].includes(file.type)) { showMessage(avatarMessageContainer, 'Invalid file type. Only JPG or PNG.', 'error'); avatarInput.value = ''; return; }
                    selectedAvatarFile = file;
                    avatarPreview.src = URL.createObjectURL(file);
                }
            });
            avatarUploadBtn.addEventListener('click', async () => {
                if (!selectedAvatarFile) { showMessage(avatarMessageContainer, 'Please select an image first.', 'error'); return; }
                const fd = new FormData();
                fd.append('avatar', selectedAvatarFile);
                try {
                    const json = await apiRequest('/api/auth/updateavatar', { method: 'PUT', body: fd });
                    if (!json.success) throw new Error(json.msg || 'Upload failed');
                    showMessage(avatarMessageContainer, 'Avatar updated!', 'success');
                    populateUI(json.data);
                    selectedAvatarFile = null;
                    avatarInput.value = '';
                } catch (err) {
                    showMessage(avatarMessageContainer, err.message, 'error');
                }
            });

            // --- Address Logic ---
            async function fetchAddresses() {
                try {
                    const json = await apiRequest('/api/auth/me');
                    if (!json.success) throw new Error(json.msg || 'Could not load addresses');
                    renderAddresses(json.data.shippingAddresses || []);
                } catch (err) { addressesList.innerHTML = `<p class="text-red-500">${err.message}</p>`; }
            }
            function renderAddresses(addresses) {
                if (!addresses || addresses.length === 0) { addressesList.innerHTML = '<p class="text-gray-500">No saved addresses found.</p>'; return; }
                addressesList.innerHTML = addresses.map(addr => `
                <div class="border rounded p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${addr.street}</p>
                            <p class="text-sm text-gray-600">${addr.city}, ${addr.province}</p>
                            <p class="text-sm text-gray-600">${addr.zipCode}</p>
                        </div>
                        <div>
                            ${addr.isDefault
                        ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">Default</span>'
                        : `<button data-id="${addr._id}" class="set-default-btn text-sm text-indigo-600">Set as Default</button>`
                    }
                        </div>
                    </div>
                    <div class="mt-3 text-right">
                        <button data-id="${addr._id}" class="delete-address-btn text-sm text-red-600">Delete</button>
                    </div>
                </div>`).join('');
            }
            addAddressBtn.addEventListener('click', () => {
                addressForm.reset();
                document.getElementById('address-form-title').textContent = 'Add New Address';
                document.getElementById('address-form-id').textContent = '';
                addressForm.classList.remove('hidden');
                addAddressBtn.classList.add('hidden');
            });
            cancelAddressBtn.addEventListener('click', () => {
                addressForm.classList.add('hidden');
                addAddressBtn.classList.remove('hidden');
            });
            addressForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    street: document.getElementById('addr-street').value,
                    city: document.getElementById('addr-city').value,
                    province: document.getElementById('addr-province').value,
                    zipCode: document.getElementById('addr-zipCode').value,
                };
                try {
                    const json = await apiRequest('/api/auth/address', { method: 'POST', body: JSON.stringify(data) });
                    if (!json.success) throw new Error(json.msg || 'Failed to save address');
                    showMessage(addressMessageContainer, 'Address saved.', 'success');
                    renderAddresses(json.data);
                    addressForm.reset();
                    addressForm.classList.add('hidden');
                    addAddressBtn.classList.remove('hidden');
                } catch (err) {
                    showMessage(addressMessageContainer, err.message, 'error');
                }
            });
            addressesList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-address-btn');
                const defaultBtn = e.target.closest('.set-default-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('Are you sure you want to delete this address?')) {
                        try {
                            const json = await apiRequest(`/api/auth/address/${id}`, { method: 'DELETE' });
                            if (!json.success) throw new Error(json.msg || 'Failed to delete');
                            renderAddresses(json.data);
                            showMessage(addressMessageContainer, 'Address deleted.', 'success');
                        } catch (err) { showMessage(addressMessageContainer, err.message, 'error'); }
                    }
                }
                if (defaultBtn) {
                    const id = defaultBtn.dataset.id;
                    try {
                        const json = await apiRequest(`/api/auth/address/${id}/setdefault`, { method: 'PUT' });
                        if (!json.success) throw new Error(json.msg || 'Failed to set default');
                        renderAddresses(json.data);
                        showMessage(addressMessageContainer, 'Default address updated.', 'success');
                    } catch (err) { showMessage(addressMessageContainer, err.message, 'error'); }
                }
            });

            // --- Purchases Logic ---
            async function fetchPurchases(tabFilter = 'All') {
                purchasesList.innerHTML = '<p class="text-gray-500 text-center py-8">Loading orders...</p>';
                try {
                    const json = await apiRequest(`/api/orders/myorders?tab=${encodeURIComponent(tabFilter)}`);
                    if (!json.success) throw new Error(json.msg || 'Could not load purchases');
                    // Annotate orders with whether user already left a review for any product in the order
                    const annotated = await annotateOrdersWithUserReviews(json.data || []);
                    renderPurchases(annotated || [], tabFilter);
                    // After rendering, try to auto-sync any pending orders with an active session
                    autoSyncPending(annotated || [], tabFilter);
                } catch (err) {
                    purchasesList.innerHTML = `<p class="text-red-500 text-center py-8">${err.message}</p>`;
                }
            }

            // For each order, check products for a review by current user. Attach first found review to order.userReview
            async function annotateOrdersWithUserReviews(orders) {
                if (!Array.isArray(orders) || orders.length === 0) return orders;
                if (!currentUserId) return orders;
                // Build unique product id list to reduce calls
                const productIds = new Set();
                orders.forEach(o => (o.orderItems || []).forEach(it => { if (it.product) productIds.add(it.product); }));
                const prodIdArray = Array.from(productIds);
                const productMap = {};
                await Promise.all(prodIdArray.map(async pid => {
                    try {
                        const prodJson = await apiRequest(`/api/products/${encodeURIComponent(pid)}`);
                        if (prodJson && prodJson.success && prodJson.data) productMap[pid] = prodJson.data;
                    } catch (e) {
                        // ignore individual product errors
                    }
                }));
                // annotate orders
                orders.forEach(o => {
                    o.userHasReview = false;
                    o.userReview = null;
                    for (const it of (o.orderItems || [])) {
                        const p = productMap[it.product];
                        if (!p || !Array.isArray(p.reviews)) continue;
                        const myReview = p.reviews.find(r => r.user && r.user.toString() === currentUserId.toString());
                        if (myReview) {
                            o.userHasReview = true;
                            o.userReview = { productId: it.product, rating: myReview.rating, comment: myReview.comment, userName: myReview.userName };
                            break;
                        }
                    }
                });
                return orders;
            }
            async function autoSyncPending(orders, tabFilter) {
                const pendings = (orders || []).filter(o => o.paymentStatus === 'Pending' && o.paymentIntentId);
                if (pendings.length === 0 || isPurchasesSyncing) return;
                isPurchasesSyncing = true;
                try {
                    const results = [];
                    for (const o of pendings) {
                        try {
                            const res = await apiRequest(`/api/payments/sync/${encodeURIComponent(o.paymentIntentId)}`);
                            results.push(res);
                        } catch (e) {
                            // ignore per-order errors
                        }
                    }
                    const anyUpdated = results.some(r => r && r.success && r.data && r.data.updated);
                    if (anyUpdated) {
                        const activeTab = purchasesTabs.querySelector('.tab-active')?.dataset.tabFilter || tabFilter;
                        fetchPurchases(activeTab);
                    }
                } finally {
                    isPurchasesSyncing = false;
                }
            }
            function renderPurchases(orders, tabFilter) {
                purchasesCache = Array.isArray(orders) ? orders : [];
                // For the Completed tab, hide orders that the user already reviewed so they effectively move to 'All'
                if (tabFilter === 'Completed' && Array.isArray(purchasesCache)) {
                    orders = purchasesCache.filter(o => !o.userHasReview);
                }
                // For the All tab, show reviewed orders first (so recently-reviewed items appear at the top)
                if (tabFilter === 'All' && Array.isArray(orders)) {
                    orders.sort((a, b) => {
                        // reviewed first
                        if (a.userHasReview && !b.userHasReview) return -1;
                        if (!a.userHasReview && b.userHasReview) return 1;
                        // If both reviewed, sort by review time (most recently reviewed first)
                        if (a.userHasReview && b.userHasReview) {
                            const ra = a.userReview && (a.userReview.reviewedAt || a.userReview.createdAt) ? new Date(a.userReview.reviewedAt || a.userReview.createdAt).getTime() : 0;
                            const rb = b.userReview && (b.userReview.reviewedAt || b.userReview.createdAt) ? new Date(b.userReview.reviewedAt || b.userReview.createdAt).getTime() : 0;
                            if (rb !== ra) return rb - ra;
                        }
                        // otherwise, newest orders first by order createdAt
                        const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                        const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                        return tb - ta;
                    });
                }
                if (!orders || orders.length === 0) {
                    purchasesList.innerHTML = `<p class="text-gray-500 text-center py-10">No orders found in ${tabFilter}.</p>`;
                    return;
                }
                purchasesList.innerHTML = orders.map(order => {
                    const itemsHtml = order.orderItems.map(item => `
                <div class="flex items-center gap-4 py-4 border-t">
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded border">
                    <div class="flex-1">
                        <p class="font-semibold">${item.name}${item.size ? ` • <span class=\"text-sm font-normal text-gray-600\">Size: ${item.size}</span>` : ''}${item.color ? ` • <span class=\"text-sm font-normal text-gray-600\">Color: ${item.color}</span>` : ''}</p>
                        <p class="text-sm text-gray-500">x ${item.quantity}</p>
                    </div>
                    <p class="text-sm text-gray-700">₱${(item.price * item.quantity).toLocaleString()}</p>
                </div>`).join('');
                    let statusLabel = ''; let statusColor = 'text-gray-700';
                    if (order.status === 'Cancelled') { statusLabel = 'CANCELLED'; statusColor = 'text-red-600'; }
                    else if (order.paymentStatus === 'Pending' && order.paymentIntentId) { statusLabel = 'PROCESSING PAYMENT'; statusColor = 'text-yellow-600'; }
                    else if (order.paymentStatus === 'Pending') { statusLabel = 'TO PAY'; statusColor = 'text-red-600'; }
                    else if (order.status === 'Accepted') { statusLabel = 'TO SHIP'; statusColor = 'text-blue-600'; }
                    else if (order.status === 'Shipped') { statusLabel = 'TO RECEIVE'; statusColor = 'text-blue-600'; }
                    else if (order.status === 'Delivered' || order.status === 'Completed') { statusLabel = 'COMPLETED'; statusColor = 'text-green-600'; }
                    const showSpinner = isPurchasesSyncing && order.paymentStatus === 'Pending' && !!order.paymentIntentId;
                    let buttonsHtml = '';
                    if (order.status === 'Cancelled') {
                        buttonsHtml = `<button data-order-id="${order._id}" data-reason="${order.cancellationReason}" data-by="${order.cancelledBy}" class="btn-details px-4 py-2 border rounded text-sm">Cancellation Details</button>`;
                    } else if (order.paymentStatus === 'Pending') {
                        buttonsHtml = `<button data-order-id="${order._id}" class="btn-pay-now px-4 py-2 bg-indigo-600 text-white rounded text-sm">Pay Now</button>
                                     <button data-order-id="${order._id}" class="btn-cancel px-4 py-2 border rounded text-sm">Cancel Order</button>`;
                    } else if (order.status === 'Shipped') {
                        buttonsHtml = `<button data-order-id="${order._id}" class="btn-mark-received px-4 py-2 bg-green-600 text-white rounded text-sm">Mark Received</button>
                                       <a href="order-confirmation.html?id=${order._id}" class="px-4 py-2 border rounded text-sm">View Details</a>`;
                    } else if (order.status === 'Delivered' || order.status === 'Completed') {
                        const productIds = order.orderItems.map(it => it.product).filter(Boolean);
                        // Refund window: allow refunds for 7 days after deliveredAt (if available)
                        const refundWindowMs = 7 * 24 * 60 * 60 * 1000; // 7 days
                        const deliveredAtMs = order.deliveredAt ? new Date(order.deliveredAt).getTime() : null;
                        const refundWindowExpired = deliveredAtMs ? (Date.now() > (deliveredAtMs + refundWindowMs)) : false;
                        const hasRefundRequest = !!order.hasRefundRequest;

                        // Build base button (view details always available)
                        buttonsHtml = `<a href="order-confirmation.html?id=${order._id}" class="px-4 py-2 border rounded text-sm">View Details</a>`;

                        // If user already left a review, show View Review; otherwise show Write Review
                        if (order.userHasReview) {
                            // Allow refund request even after review while within refund window and if no request exists
                            if (!refundWindowExpired && !hasRefundRequest) {
                                buttonsHtml += ` <button data-order-id="${order._id}" class="btn-request-refund px-4 py-2 border rounded text-sm">Request Refund</button>`;
                            } else if (hasRefundRequest) {
                                buttonsHtml += ` <button disabled class="px-4 py-2 border rounded text-sm text-gray-500">Refund Requested</button>`;
                            }

                            buttonsHtml += ` <button data-order-id="${order._id}" class="btn-view-review px-4 py-2 border rounded text-sm">View Review</button>`;
                        } else {
                            // user has not reviewed yet
                            if (!refundWindowExpired && !hasRefundRequest) {
                                buttonsHtml += ` <button data-order-id="${order._id}" class="btn-request-refund px-4 py-2 border rounded text-sm">Request Refund</button>`;
                            } else if (hasRefundRequest) {
                                buttonsHtml += ` <button disabled class="px-4 py-2 border rounded text-sm text-gray-500">Refund Requested</button>`;
                            }

                            buttonsHtml += ` <button data-products="${productIds.join(',')}" class="btn-leave-feedback px-4 py-2 bg-indigo-600 text-white rounded text-sm">Write Review</button>`;
                        }
                    } else {
                        buttonsHtml = `<a href="order-confirmation.html?id=${order._id}" class="px-4 py-2 border rounded text-sm">View Details</a>`;
                    }
                    return `
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-4 flex justify-between items-center">
                        <span class="text-sm font-medium">Order ID: <span class="font-mono">${order._id.slice(0, 10)}...</span></span>
                        <span class="text-sm font-semibold ${statusColor}">${statusLabel}${showSpinner ? ' <i class=\"fas fa-spinner fa-spin\"></i>' : ''}</span>
                    </div>
                    ${itemsHtml}
                    ${order.status === 'Shipped' || order.status === 'Delivered' ? `
                    <div class="px-4 py-3 bg-blue-50 border-t border-blue-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-shipping-fast text-blue-600"></i>
                            <span class="text-sm font-semibold text-gray-700">Shipping Details:</span>
                        </div>
                        <div class="space-y-2">
                            ${order.shippingService ? `<p class="text-sm text-gray-700"><strong>Courier:</strong> <span class="font-semibold text-blue-700">${order.shippingService}</span></p>` : ''}
                            ${order.trackingCode ? `
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="text-sm text-gray-700"><strong>Tracking Number:</strong></p>
                                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded border border-gray-200">
                                    <span class="font-mono font-semibold text-green-700 text-sm">${order.trackingCode}</span>
                                    <button onclick="event.preventDefault(); copyToClipboard('${order.trackingCode}', this)" 
                                            class="px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-xs transition-all">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    ${order.shippingService && getTrackingUrl(order.shippingService, order.trackingCode) ? `
                                    <a href="${getTrackingUrl(order.shippingService, order.trackingCode)}" 
                                       target="_blank" 
                                       class="px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs transition-all">
                                        <i class="fas fa-external-link-alt"></i> Track Order
                                    </a>` : ''}
                                </div>
                            </div>
                            ` : '<p class="text-sm text-yellow-600">⏳ Tracking number pending...</p>'}
                        </div>
                    </div>` : ''}
                    <div class="p-4 bg-gray-50 flex flex-col sm:flex-row justify-end items-center gap-4">
                        <div class="text-lg">Order Total: <span class="font-bold text-indigo-700">₱${order.totalPrice.toLocaleString()}</span></div>
                        <div class="flex gap-3">${buttonsHtml}</div>
                    </div>
                </div>`;
                }).join('');
            }
            purchasesTabs.addEventListener('click', (e) => {
                const btn = e.target.closest('button.purchase-tab');
                if (!btn) return;
                purchasesTabs.querySelectorAll('.purchase-tab').forEach(t => {
                    t.classList.remove('text-indigo-600', 'border-indigo-600', 'font-semibold', 'tab-active');
                    t.classList.add('text-gray-600', 'border-transparent');
                });
                btn.classList.add('text-indigo-600', 'border-indigo-600', 'font-semibold', 'tab-active');
                btn.classList.remove('text-gray-600', 'border-transparent');
                const filter = btn.dataset.tabFilter;
                fetchPurchases(filter);
            });
                        purchasesList.addEventListener('click', async (e) => {
                const payNowBtn = e.target.closest('.btn-pay-now');
                const cancelBtn = e.target.closest('.btn-cancel');
                const detailsBtn = e.target.closest('.btn-details');
                            const markReceivedBtn = e.target.closest('.btn-mark-received');
                            const leaveFeedbackBtn = e.target.closest('.btn-leave-feedback');
                                if (payNowBtn) {
                                        const orderId = payNowBtn.getAttribute('data-order-id');
                                        const order = purchasesCache.find(o => o._id === orderId);
                                        if (!order) { alert('Order not found. Please refresh and try again.'); return; }
                                        try {
                                                payNowBtn.disabled = true;
                                                payNowBtn.textContent = 'Redirecting...';

                                                const json = await apiRequest(`/api/payments/create-order-existing/${orderId}`, {
                                                    method: 'POST'
                                                });
                                                if (!json.success || !json.data?.checkoutUrl) throw new Error(json.msg || 'Failed to create payment session');
                                                window.location.href = json.data.checkoutUrl;
                                        } catch (err) {
                                                alert(err.message || 'Failed to start payment.');
                                                payNowBtn.disabled = false;
                                                payNowBtn.textContent = 'Pay Now';
                                        }
                                }
                if (cancelBtn) {
                    currentCancelOrderId = cancelBtn.dataset.orderId;
                    cancelModal.classList.remove('hidden'); cancelModal.classList.add('flex');
                    cancelError.classList.add('hidden'); cancelReasonOther.classList.add('hidden');
                    cancelReasonSelect.value = 'Changed my mind';
                }
                if (detailsBtn) {
                    const reason = detailsBtn.dataset.reason || "No reason provided.";
                    const by = detailsBtn.dataset.by || "N/A";
                    detailsCancelledBy.textContent = by.charAt(0).toUpperCase() + by.slice(1);
                    detailsReason.textContent = reason;
                    detailsModal.classList.remove('hidden'); detailsModal.classList.add('flex');
                }
                if (markReceivedBtn) {
                    const orderId = markReceivedBtn.dataset.orderId;
                    markReceivedBtn.disabled = true; markReceivedBtn.textContent = 'Updating...';
                    try {
                        const json = await apiRequest(`/api/orders/${orderId}/complete`, { method: 'PUT' });
                        if (!json.success) throw new Error(json.msg || 'Failed to complete order');
                        // Refresh list
                        const activeTab = purchasesTabs.querySelector('.tab-active').dataset.tabFilter;
                        await fetchPurchases(activeTab);
                        const allProducts = json.data.orderItems.map(it => it.product).filter(Boolean);
                        if (allProducts.length) openFeedbackModal(allProducts);
                    } catch (err) {
                        alert(err.message);
                    } finally {
                        markReceivedBtn.disabled = false; markReceivedBtn.textContent = 'Mark Received';
                    }
                }
                if (leaveFeedbackBtn) {
                    const productIdsStr = leaveFeedbackBtn.dataset.products || '';
                    const list = productIdsStr.split(',').filter(Boolean);
                    if (list.length > 0) openFeedbackModal(list);
                }
                const viewReviewBtn = e.target.closest('.btn-view-review');
                if (viewReviewBtn) {
                    const orderId = viewReviewBtn.dataset.orderId;
                    const order = purchasesCache.find(o => o._id === orderId);
                    if (order && order.userReview) {
                        openViewReviewModal(order.userReview);
                    } else {
                        // try to fetch freshest data
                        try {
                            const refreshed = await apiRequest(`/api/orders/${encodeURIComponent(orderId)}`);
                            if (refreshed && refreshed.success && refreshed.data) {
                                // try to find review for this user's products
                                const annotated = await annotateOrdersWithUserReviews([refreshed.data]);
                                const o = annotated[0];
                                if (o && o.userReview) openViewReviewModal(o.userReview);
                                else alert('No review found for this order.');
                            }
                        } catch (err) { alert('Failed to load review.'); }
                    }
                }
                const requestRefundBtn = e.target.closest('.btn-request-refund');
                if (requestRefundBtn) {
                    const orderId = requestRefundBtn.dataset.orderId;
                    openReturnModal(orderId);
                }
            });
            cancelReasonSelect.addEventListener('change', () => {
                cancelReasonOther.classList.toggle('hidden', cancelReasonSelect.value !== 'Other');
            });
            cancelModalClose.addEventListener('click', () => cancelModal.classList.add('hidden'));
            cancelModalConfirm.addEventListener('click', async () => {
                let reason = cancelReasonSelect.value;
                if (reason === 'Other') { reason = cancelReasonOther.value.trim(); }
                if (!reason) { cancelError.textContent = 'Please provide a reason.'; cancelError.classList.remove('hidden'); return; }
                cancelModalConfirm.disabled = true; cancelModalConfirm.textContent = 'Cancelling...';
                try {
                    const json = await apiRequest(`/api/orders/${currentCancelOrderId}/cancel`, { method: 'PUT', body: JSON.stringify({ reason }) });
                    if (!json.success) throw new Error(json.msg || 'Failed to cancel order');
                    cancelModal.classList.add('hidden');
                    const activeTab = purchasesTabs.querySelector('.tab-active').dataset.tabFilter;
                    fetchPurchases(activeTab);
                } catch (err) {
                    cancelError.textContent = err.message;
                    cancelError.classList.remove('hidden');
                } finally {
                    cancelModalConfirm.disabled = false;
                    cancelModalConfirm.textContent = 'Confirm';
                }
            });
            detailsModalClose.addEventListener('click', () => detailsModal.classList.add('hidden'));
            detailsModalOk.addEventListener('click', () => detailsModal.classList.add('hidden'));

            // --- Feedback Modal Logic ---
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackModalClose = document.getElementById('feedback-modal-close');
            const feedbackRating = document.getElementById('feedback-rating');
            const feedbackComment = document.getElementById('feedback-comment');
            const feedbackSubmit = document.getElementById('feedback-submit');
            const feedbackError = document.getElementById('feedback-error');
            let currentFeedbackProductId = null;
            let currentFeedbackProducts = [];
            const feedbackProductSelectWrapper = document.getElementById('feedback-product-select-wrapper');
            const feedbackProductSelect = document.getElementById('feedback-product-select');

            function openFeedbackModal(productIdOrList) {
                if (Array.isArray(productIdOrList)) {
                    currentFeedbackProducts = productIdOrList.filter(Boolean);
                    if (currentFeedbackProducts.length > 1) {
                        feedbackProductSelectWrapper.classList.remove('hidden');
                        feedbackProductSelect.innerHTML = currentFeedbackProducts.map(pid => `<option value="${pid}">${pid.slice(0,6)}...</option>`).join('');
                        currentFeedbackProductId = currentFeedbackProducts[0];
                    } else {
                        feedbackProductSelectWrapper.classList.add('hidden');
                        currentFeedbackProductId = currentFeedbackProducts[0] || null;
                    }
                } else {
                    feedbackProductSelectWrapper.classList.add('hidden');
                    currentFeedbackProducts = [productIdOrList];
                    currentFeedbackProductId = productIdOrList;
                }
                feedbackRating.value = '5';
                feedbackComment.value = '';
                feedbackError.classList.add('hidden');
                // ensure write mode UI
                const header = feedbackModal.querySelector('h3'); if (header) header.textContent = 'Product Feedback';
                feedbackRating.disabled = false; feedbackComment.disabled = false; feedbackSubmit.style.display = '';
                feedbackModal.classList.remove('hidden');
                feedbackModal.classList.add('flex');
            }
            
            function openViewReviewModal(reviewObj) {
                if (!reviewObj) return;
                // prepare modal for read-only view
                const header = feedbackModal.querySelector('h3');
                if (header) header.textContent = 'View Review';
                feedbackProductSelectWrapper.classList.add('hidden');
                feedbackRating.value = String(reviewObj.rating || '5');
                feedbackComment.value = reviewObj.comment || '';
                feedbackRating.disabled = true;
                feedbackComment.disabled = true;
                feedbackSubmit.style.display = 'none';
                feedbackModal.classList.remove('hidden');
                feedbackModal.classList.add('flex');
            }
            feedbackProductSelect?.addEventListener('change', () => {
                currentFeedbackProductId = feedbackProductSelect.value;
            });
            feedbackModalClose.addEventListener('click', () => {
                // reset modal back to write mode
                const header = feedbackModal.querySelector('h3');
                if (header) header.textContent = 'Product Feedback';
                feedbackRating.disabled = false;
                feedbackComment.disabled = false;
                feedbackSubmit.style.display = '';
                feedbackModal.classList.add('hidden');
            });
            feedbackSubmit.addEventListener('click', async () => {
                if (!currentFeedbackProductId) return;
                feedbackSubmit.disabled = true; feedbackSubmit.textContent = 'Submitting...';
                try {
                    const body = JSON.stringify({ rating: Number(feedbackRating.value), comment: feedbackComment.value.trim() });
                    const json = await apiRequest(`/api/products/${currentFeedbackProductId}/reviews`, { method: 'POST', body });
                    if (!json.success) throw new Error(json.msg || 'Failed to submit review');
                    // Close modal, refresh purchases and switch to All tab so reviewed order moves to All
                    feedbackModal.classList.add('hidden');
                    try {
                        // switch UI to "All" tab programmatically
                        const allBtn = purchasesTabs.querySelector('button[data-tab-filter="All"]');
                        if (allBtn) allBtn.click();
                        await fetchPurchases('All');
                        alert('Thank you! Your review was submitted.');
                    } catch (e) {
                        alert('Thank you! Your review was submitted.');
                    }
                } catch (err) {
                    feedbackError.textContent = err.message;
                    feedbackError.classList.remove('hidden');
                } finally {
                    feedbackSubmit.disabled = false; feedbackSubmit.textContent = 'Submit Review';
                }
            });

                        /* Return Request Modal (in-page) */
                        (function createReturnModal() {
                                const html = `
                                <div id="return-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
                                    <div class="bg-white rounded-lg shadow max-w-2xl w-full overflow-hidden">
                                        <div class="flex items-center justify-between px-5 py-3 border-b">
                                            <h3 class="font-semibold text-gray-800">Request Return / Refund</h3>
                                            <button id="return-modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                                        </div>
                                        <div class="p-5 space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Reason</label>
                                                <input id="return-reason" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="e.g. Wrong size received" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Details (optional)</label>
                                                <textarea id="return-details" class="mt-1 block w-full border rounded px-3 py-2" rows="3"></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Upload video (optional, mp4/mov/webm)</label>
                                                <input id="return-videos" type="file" accept="video/*" multiple class="mt-1" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Upload images (optional)</label>
                                                <input id="return-images" type="file" accept="image/*" multiple class="mt-1" />
                                            </div>
                                            <div id="return-error" class="text-sm text-red-600 hidden"></div>
                                        </div>
                                        <div class="px-5 py-3 border-t flex items-center justify-end gap-3">
                                            <button id="return-submit" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded">Submit Request</button>
                                        </div>
                                    </div>
                                </div>`;
                                document.body.insertAdjacentHTML('beforeend', html);
                                document.getElementById('return-modal-close').addEventListener('click', closeReturnModal);
                                document.getElementById('return-submit').addEventListener('click', submitReturnRequest);
                        })();

                        function openReturnModal(eOrId) {
                                const modal = document.getElementById('return-modal');
                                let orderId = null;
                                if (typeof eOrId === 'string') orderId = eOrId;
                                else if (eOrId && eOrId.currentTarget && eOrId.currentTarget.dataset) orderId = eOrId.currentTarget.dataset.orderId;
                                else if (eOrId && eOrId.dataset) orderId = eOrId.dataset.orderId;
                                if (!orderId) {
                                        const errEl = document.getElementById('return-error');
                                        errEl.textContent = 'Order ID missing. Cannot request return.'; errEl.classList.remove('hidden');
                                        return;
                                }
                                modal.dataset.orderId = orderId;
                                modal.classList.remove('hidden');
                                document.getElementById('return-error').classList.add('hidden');
                        }

                        function closeReturnModal() {
                                const modal = document.getElementById('return-modal');
                                if (modal) modal.classList.add('hidden');
                        }

                        async function submitReturnRequest() {
                                const modal = document.getElementById('return-modal');
                                const orderId = modal.dataset.orderId;
                                const reason = document.getElementById('return-reason').value.trim();
                                const details = document.getElementById('return-details').value.trim();
                                const videos = document.getElementById('return-videos').files;
                                const images = document.getElementById('return-images').files;
                                const errEl = document.getElementById('return-error');
                                errEl.classList.add('hidden'); errEl.textContent = '';

                                if (!reason) { errEl.textContent = 'Please provide a reason.'; errEl.classList.remove('hidden'); return; }
                                const token = localStorage.getItem('token');
                                if (!token) { errEl.textContent = 'Please log in to submit a return.'; errEl.classList.remove('hidden'); return; }

                                const fd = new FormData();
                                fd.append('reason', reason);
                                fd.append('details', details);
                                for (let i=0;i<videos.length;i++) fd.append('videos', videos[i]);
                                for (let i=0;i<images.length;i++) fd.append('images', images[i]);

                                try {
                                        const res = await fetch(`${API}/api/orders/${orderId}/returns`, {
                                                method: 'POST',
                                                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                                                body: fd
                                        });
                                        const data = await res.json();
                                        if (!res.ok) {
                                                errEl.textContent = data.msg || JSON.stringify(data);
                                                errEl.classList.remove('hidden');
                                                return;
                                        }
                                        closeReturnModal();
                                        alert('Return request submitted. Admin will review it shortly.');
                                } catch (e) {
                                        errEl.textContent = 'Failed to submit request. Try again later.';
                                        errEl.classList.remove('hidden');
                                        console.error('Submit return error', e);
                                }
                        }

            // --- Vouchers Logic ---
            async function fetchVouchers() {
                try {
                    const json = await apiRequest('/api/auth/me');
                    if (!json.success) throw new Error(json.msg || 'Could not load vouchers');
                    renderVouchers(json.data.vouchers || []);
                } catch (err) { vouchersList.innerHTML = `<p class="text-red-500">${err.message}</p>`; }
            }
            function renderVouchers(vouchers) {
                if (!vouchers || vouchers.length === 0) { vouchersList.innerHTML = '<p class="text-gray-500">You have no vouchers.</p>'; return; }
                vouchersList.innerHTML = vouchers.map(v => `
                <div class="border rounded p-4 ${v.used ? 'bg-gray-100' : 'bg-gray-50'}">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-mono font-bold ${v.used ? 'text-gray-500' : 'text-indigo-700'}">${v.code}</span>
                        <div class="flex items-center gap-3">
                          <span class="text-sm font-semibold">${v.type === 'percentage' ? `${v.value}% OFF` : (v.type === 'fixed' ? `₱${v.value} OFF` : 'Free Shipping')}</span>
                          ${v.used ? `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">Used</span>` : ''}
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">${v.description}</p>
                </div>`).join('');
            }

            // Custom order logic removed in favor of dedicated My Quotes page.

            // --- MODIFIED: Main Tab/Sidebar Switching Logic ---
            sidebarNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-tab], button[data-tab-parent]');
                if (!btn) return;

                const tab = btn.dataset.tab;
                const parentTab = btn.dataset.tabParent;

                document.querySelectorAll('#sidebar-nav .sidebar-active').forEach(b => b.classList.remove('sidebar-active'));
                document.querySelectorAll('#tab-content > div').forEach(d => {
                    d.classList.add('hidden');
                    d.classList.remove('bg-white', 'p-6', 'md:p-8', 'rounded-lg', 'shadow-md');
                });

                if (tab) {
                    btn.classList.add('sidebar-active');
                    const parentBtn = btn.closest('.sidebar-submenu')?.previousElementSibling;
                    if (parentBtn) { parentBtn.classList.add('sidebar-active'); }

                    const contentEl = document.getElementById(`${tab}-content`);
                    if (contentEl) {
                        contentEl.classList.remove('hidden');
                        if (tab !== 'purchases') {
                            contentEl.classList.add('bg-white', 'p-6', 'md:p-8', 'rounded-lg', 'shadow-md');
                        }
                    }

                    // Fetch data on-demand
                    if (tab === 'purchases' && purchasesList.innerHTML.trim() === "") fetchPurchases('All');
                    if (tab === 'addresses' && addressesList.innerHTML.trim() === "") fetchAddresses();
                    // Always refresh vouchers when user opens the Vouchers tab so used/removed vouchers reflect server state
                    if (tab === 'vouchers') fetchVouchers();

                } else if (parentTab) {
                    btn.classList.add('sidebar-active');
                    const firstChild = btn.nextElementSibling?.querySelector('button[data-tab]');

                    if (firstChild) {
                        firstChild.click();
                    } else {
                        const contentEl = document.getElementById(`${parentTab}-content`);
                        if (contentEl) {
                            contentEl.classList.remove('hidden');
                            if (parentTab !== 'purchases') {
                                contentEl.classList.add('bg-white', 'p-6', 'md:p-8', 'rounded-lg', 'shadow-md');
                            }
                        }
                        if (parentTab === 'purchases' && purchasesList.innerHTML.trim() === "") fetchPurchases('All');
                    }
                }
            });

            // --- Logout Button ---
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });

            // --- Initial Load ---
            fetchUserData();
        });
    </script>

    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Chat Widget -->
    <script src="js/chat.js"></script>
</body>

</html>