<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-link,
        .sidebar-parent-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            text-decoration: none;
            color: #374151;
            /* text-gray-700 */
            transition: all 0.2s ease-in-out;
        }

        .sidebar-link:hover,
        .sidebar-parent-link:hover {
            background-color: #f3f4f6;
            /* hover:bg-gray-100 */
        }

        .sidebar-link.sidebar-active {
            color: #4f46e5;
            /* text-indigo-600 */
            font-weight: 600;
        }

        .sidebar-parent-link.sidebar-active {
            color: #4f46e5;
            /* text-indigo-600 */
        }

        .sidebar-icon {
            width: 1.5rem;
            /* w-6 */
            text-align: center;
            margin-right: 0.75rem;
            /* mr-3 */
            font-size: 1.125rem;
            /* text-lg */
        }

        .sidebar-submenu {
            display: none;
            /* Hidden by default */
            padding-left: 2.25rem;
            /* pl-9 */
        }

        .sidebar-parent-link.sidebar-active+.sidebar-submenu {
            display: block;
        }

        #avatar-preview-container {
            width: 10rem;
            /* w-40 */
            height: 10rem;
            /* h-40 */
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #e5e7eb;
            /* border-gray-200 */
            margin: 0 auto;
        }

        #avatar-preview,
        #sidebar-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Styles para sa Purchases Tabs (Kinonvert mula @apply) */
        .purchase-tab {
            flex-shrink: 0;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: center;
            color: #4B5563;
            /* text-gray-600 */
            border-bottom-width: 2px;
            border-color: transparent;
        }

        .purchase-tab.tab-active {
            color: #4F46E5;
            /* text-indigo-600 */
            border-color: #4F46E5;
            /* border-indigo-600 */
            font-weight: 600;
            /* font-semibold */
        }
    </style>
</head>

<body class="bg-gray-100">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800"><a href="index.html">Fundamental</a></div>
            <div class="flex items-center space-x-5">
                <a href="products.html" class="text-gray-600 hover:text-indigo-600">Products</a>
                <a href="services.html" class="text-gray-600 hover:text-indigo-600">Services</a>
                <a href="cart.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-shopping-cart"></i></a>

                <div id="auth-links-logged-in">
                    <a href="profile.html" id="user-link" class="text-gray-800 font-semibold">
                        <i id="user-icon" class="fas fa-user-circle text-2xl"></i>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="loading-container" class="text-center">
            <p class="text-lg text-gray-600">Loading profile...</p>
        </div>

        <div id="profile-container" class="max-w-6xl mx-auto hidden">
            <div class="md:flex md:space-x-8">

                <aside class="md:w-1/4 mb-8 md:mb-0">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex items-center gap-4 border-b pb-4">
                            <div id="sidebar-avatar"
                                class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xl font-bold overflow-hidden">
                                <img id="sidebar-avatar-img" src="" alt="" class="hidden">
                                <span id="sidebar-initials">U</span>
                            </div>
                            <div>
                                <div id="user-name-display" class="font-semibold text-gray-800">User Name</div>
                                <div id="user-email-display" class="text-sm text-gray-500">email@example.com</div>
                            </div>
                        </div>

                        <nav id="sidebar-nav" class="mt-4 space-y-1">
                            <button id="sidebar-parent-account" data-tab-parent="account"
                                class="sidebar-parent-link sidebar-active w-full">
                                <i class="sidebar-icon fas fa-user-circle"></i> My Account
                            </button>
                            <div class="sidebar-submenu">
                                <button data-tab="profile" class="sidebar-link sidebar-active w-full">Profile</button>
                                <button data-tab="addresses" class="sidebar-link w-full">Addresses</button>
                            </div>

                            <button data-tab="purchases" class="sidebar-parent-link w-full">
                                <i class="sidebar-icon fas fa-receipt"></i> My Purchases
                            </button>

                            <button data-tab="custom-orders" class="sidebar-parent-link w-full">
                                <i class="sidebar-icon fas fa-cut"></i> My Custom Orders
                            </button>
                            <button data-tab="vouchers" class="sidebar-parent-link w-full">
                                <i class="sidebar-icon fas fa-ticket-alt"></i> My Vouchers
                            </button>

                            <hr class="my-3">
                            <button id="logout-btn" class="sidebar-parent-link w-full text-red-600 hover:bg-red-50">
                                <i class="sidebar-icon fas fa-sign-out-alt"></i> Logout
                            </button>
                        </nav>
                    </div>
                </aside>

                <div class="flex-1">
                    <div id="tab-content" class="min-h-[600px]">

                        <div id="profile-content" class="bg-white p-6 md:p-8 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">My Profile</h2>
                            <p class="text-gray-500 mb-6">Manage and protect your account</p>
                            <hr class="mb-6">
                            <div id="profile-message-container" class="hidden mb-4"></div>
                            <div class="flex flex-col-reverse lg:flex-row gap-8">
                                <form id="profile-form" class="flex-1 space-y-5">
                                    <div><label class="block text-sm text-gray-700 mb-1">Username</label><input
                                            id="username" name="username" class="w-full border px-3 py-2 rounded" />
                                    </div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Name</label><input id="name"
                                            name="name" class="w-full border px-3 py-2 rounded" /></div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Email</label><input id="email"
                                            name="email" class="w-full border px-3 py-2 rounded bg-gray-100" disabled />
                                    </div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Phone Number</label><input
                                            id="contactNumber" name="contactNumber"
                                            class="w-full border px-3 py-2 rounded" /></div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Gender</label>
                                        <div class="flex items-center gap-6 mt-2"><label
                                                class="flex items-center gap-2"><input type="radio" name="gender"
                                                    value="Male" class="h-4 w-4"> Male</label><label
                                                class="flex items-center gap-2"><input type="radio" name="gender"
                                                    value="Female" class="h-4 w-4"> Female</label><label
                                                class="flex items-center gap-2"><input type="radio" name="gender"
                                                    value="Other" class="h-4 w-4"> Other</label></div>
                                    </div>
                                    <div><label class="block text-sm text-gray-700 mb-1">Date of Birth</label>
                                        <div class="flex gap-3"><input id="dob-day" type="number" placeholder="DD"
                                                class="w-1/3 border px-3 py-2 rounded" min="1" max="31"><input
                                                id="dob-month" type="number" placeholder="MM"
                                                class="w-1/3 border px-3 py-2 rounded" min="1" max="12"><input
                                                id="dob-year" type="number" placeholder="YYYY"
                                                class="w-1/3 border px-3 py-2 rounded" min="1920" max="2020"></div>
                                    </div>
                                    <div class="pt-4"><button type="submit"
                                            class="bg-indigo-600 text-white px-6 py-2 rounded">Save</button></div>
                                </form>
                                <div class="lg:w-1/3 lg:border-l lg:pl-8">
                                    <div id="avatar-message-container" class="hidden mb-4"></div>
                                    <div id="avatar-preview-container"><img id="avatar-preview"
                                            src="https://placehold.co/160x160/e2e8f0/cccccc?text=Avatar"
                                            alt="Profile Picture"></div>
                                    <input type="file" id="avatar-input" accept="image/png,image/jpeg" class="hidden">
                                    <label for="avatar-input"
                                        class="w-full max-w-[200px] text-center block mx-auto mt-4 px-4 py-2 border rounded cursor-pointer hover:bg-gray-50">Select
                                        Image</label>
                                    <button id="avatar-upload-btn"
                                        class="w-full max-w-[200px] text-center block mx-auto mt-2 px-4 py-2 border rounded bg-indigo-600 text-white hover:bg-indigo-700">Save
                                        Image</button>
                                    <p class="text-xs text-gray-500 text-center mt-3">File size: maximum 1 MB<br>File
                                        extension: .JPEG, .PNG</p>
                                </div>
                            </div>
                        </div>

                        <div id="addresses-content" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">My Addresses</h2>
                            <div id="address-message-container" class="hidden mb-4"></div>
                            <div id="addresses-list" class="space-y-4 mb-6"></div>
                            <button id="add-address-btn" class="text-sm text-indigo-600 font-medium">+ Add New
                                Address</button>
                            <form id="address-form" class="hidden mt-6 border-t pt-6 space-y-4">
                                <h3 id="address-form-title" class="text-lg font-semibold">Add New Address</h3>
                                <div id="address-form-id" class="hidden"></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm text-gray-700">Street</label><input
                                            id="addr-street" class="mt-1 block w-full border px-3 py-2 rounded"
                                            required /></div>
                                    <div><label class="block text-sm text-gray-700">City</label><input id="addr-city"
                                            class="mt-1 block w-full border px-3 py-2 rounded" required /></div>
                                    <div><label class="block text-sm text-gray-700">Province</label><input
                                            id="addr-province" class="mt-1 block w-full border px-3 py-2 rounded"
                                            required /></div>
                                    <div><label class="block text-sm text-gray-700">Zip Code</label><input
                                            id="addr-zipCode" class="mt-1 block w-full border px-3 py-2 rounded"
                                            required /></div>
                                </div>
                                <div class="flex justify-end gap-3"><button type="button" id="cancel-address-btn"
                                        class="px-4 py-2 rounded bg-gray-200 text-gray-800">Cancel</button><button
                                        type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Save
                                        Address</button></div>
                            </form>
                        </div>

                        <div id="purchases-content" class="hidden">
                            <div class="bg-white rounded-lg shadow-md">
                                <nav id="purchases-tabs" class="flex items-center border-b overflow-x-auto">
                                    <button data-tab-filter="All"
                                        class="purchase-tab tab-active flex-shrink-0 px-4 py-3 text-center font-semibold text-indigo-600 border-b-2 border-indigo-600">All</button>
                                    <button data-tab-filter="To Pay"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">To
                                        Pay</button>
                                    <button data-tab-filter="To Ship"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">To
                                        Ship</button>
                                    <button data-tab-filter="To Receive"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">To
                                        Receive</button>
                                    <button data-tab-filter="Completed"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">Completed</button>
                                    <button data-tab-filter="Cancelled"
                                        class="purchase-tab flex-shrink-0 px-4 py-3 text-center text-gray-600 border-b-2 border-transparent">Cancelled</button>
                                </nav>
                                <div id="purchases-list" class="space-y-4 p-4"></div>
                            </div>
                        </div>

                        <div id="vouchers-content" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">My Vouchers</h2>
                            <div id="vouchers-list" class="space-y-4"></div>
                        </div>

                        <div id="custom-orders-content" class="hidden">
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-4 border-b">
                                    <h2 class="text-2xl font-bold text-gray-800">My Custom Orders</h2>
                                    <p class="text-sm text-gray-500">View quotes and pay for your custom designs here.
                                    </p>
                                </div>
                                <div id="custom-orders-list" class="space-y-4 p-4">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div id="cancel-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Cancel Order</h3>
                <button id="cancel-modal-close" class="text-gray-500">&times;</button>
            </div>
            <div class="p-4">
                <p class="text-sm mb-3">Please select a reason for cancellation:</p>
                <select id="cancel-reason" class="w-full border p-2 rounded">
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Ordered by mistake">Ordered by mistake</option>
                    <option value="Found a better deal">Found a better deal</option>
                    <option value="Other">Other (Please specify)</option>
                </select>
                <textarea id="cancel-reason-other" class="w-full border p-2 rounded mt-3 hidden"
                    placeholder="Please specify your reason"></textarea>
                <div id="cancel-error" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3">
                <button id="cancel-modal-confirm" class="bg-indigo-600 text-white px-4 py-2 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Cancellation Details</h3>
                <button id="details-modal-close" class="text-gray-500">&times;</button>
            </div>
            <div class="p-4 space-y-2">
                <p class="text-sm"><strong>Cancelled By:</strong> <span id="details-cancelled-by"></span></p>
                <p class="text-sm"><strong>Reason:</strong> <span id="details-reason"></span></p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end">
                <button id="details-modal-ok" class="bg-indigo-600 text-white px-4 py-2 rounded">OK</button>
            </div>
        </div>
    </div>

    <div id="downpayment-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Submit Down Payment</h3>
                <button id="dp-modal-close" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="p-4">
                <p class="text-sm mb-2">Your quote for <strong id="dp-modal-product-name"
                        class="text-indigo-700">...</strong> is <strong>₱<span id="dp-modal-total">0</span></strong>.
                </p>
                <p class="text-lg font-bold mb-4">50% Down Payment: <strong>₱<span
                            id="dp-modal-amount">0</span></strong></p>
                <p class="text-sm text-gray-600 mb-2">Please pay the 50% down payment via GCash/Bank Transfer and upload
                    your proof of payment.</p>
                <input type="file" id="dp-file-input" accept="image/png,image/jpeg,image/webp"
                    class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <div id="dp-error" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end">
                <button id="dp-modal-confirm" class="bg-indigo-600 text-white px-4 py-2 rounded">Submit Receipt</button>
            </div>
        </div>
    </div>
    <div id="final-payment-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Submit Final Payment</h3>
                <button id="fp-modal-close" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="p-4">
                <p class="text-sm mb-2">Your order for <strong id="fp-modal-product-name" class="text-indigo-700">...</strong> is ready!</p>
                <p class="text-sm">Total Quote: <strong>₱<span id="fp-modal-total">0</span></strong></p>
                <p class="text-sm">Down Payment Paid: <strong>- ₱<span id="fp-modal-dp-paid">0</span></strong></p>
                <p class="text-lg font-bold mb-4">Remaining Balance: <strong>₱<span id="fp-modal-amount">0</span></strong></p>
                <p class="text-sm text-gray-600 mb-2">Please pay the remaining balance and upload your proof of payment to complete the order.</p>
                <input type="file" id="fp-file-input" accept="image/png,image/jpeg,image/webp" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <div id="fp-error" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end">
                <button id="fp-modal-confirm" class="bg-green-600 text-white px-4 py-2 rounded">Submit Final Receipt</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API = 'http://localhost:5000';
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // --- Lahat ng Selectors ---
            const profileContainer = document.getElementById('profile-container');
            const loadingContainer = document.getElementById('loading-container');
            const sidebarAvatar = document.getElementById('sidebar-avatar');
            const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
            const sidebarInitials = document.getElementById('sidebar-initials');
            const userNameDisplay = document.getElementById('user-name-display');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutBtn = document.getElementById('logout-btn');
            const sidebarNav = document.getElementById('sidebar-nav');
            const profileForm = document.getElementById('profile-form');
            const profileMessageContainer = document.getElementById('profile-message-container');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarInput = document.getElementById('avatar-input');
            const avatarUploadBtn = document.getElementById('avatar-upload-btn');
            const avatarMessageContainer = document.getElementById('avatar-message-container');
            let selectedAvatarFile = null;
            const purchasesTabs = document.getElementById('purchases-tabs');
            const purchasesList = document.getElementById('purchases-list');
            let currentCancelOrderId = null;
            const cancelModal = document.getElementById('cancel-modal');
            const cancelModalClose = document.getElementById('cancel-modal-close');
            const cancelModalConfirm = document.getElementById('cancel-modal-confirm');
            const cancelReasonSelect = document.getElementById('cancel-reason');
            const cancelReasonOther = document.getElementById('cancel-reason-other');
            const cancelError = document.getElementById('cancel-error');
            const detailsModal = document.getElementById('details-modal');
            const detailsModalClose = document.getElementById('details-modal-close');
            const detailsModalOk = document.getElementById('details-modal-ok');
            const detailsCancelledBy = document.getElementById('details-cancelled-by');
            const detailsReason = document.getElementById('details-reason');
            const addressesList = document.getElementById('addresses-list');
            const addressMessageContainer = document.getElementById('address-message-container');
            const addAddressBtn = document.getElementById('add-address-btn');
            const addressForm = document.getElementById('address-form');
            const cancelAddressBtn = document.getElementById('cancel-address-btn');
            const vouchersList = document.getElementById('vouchers-list');

            // --- NEW: Custom Order Selectors ---
            const customOrdersList = document.getElementById('custom-orders-list');
            const dpModal = document.getElementById('downpayment-modal');
            const dpModalClose = document.getElementById('dp-modal-close');
            const dpModalConfirm = document.getElementById('dp-modal-confirm');
            const dpModalProductName = document.getElementById('dp-modal-product-name');
            const dpModalTotal = document.getElementById('dp-modal-total');
            const dpModalAmount = document.getElementById('dp-modal-amount');
            const dpFileInput = document.getElementById('dp-file-input');
            const dpError = document.getElementById('dp-error');
            const fpModal = document.getElementById('final-payment-modal');
            const fpModalClose = document.getElementById('fp-modal-close');
            const fpModalConfirm = document.getElementById('fp-modal-confirm');
            const fpModalProductName = document.getElementById('fp-modal-product-name');
            const fpModalTotal = document.getElementById('fp-modal-total');
            const fpModalDpPaid = document.getElementById('fp-modal-dp-paid');
            const fpModalAmount = document.getElementById('fp-modal-amount');
            const fpFileInput = document.getElementById('fp-file-input');
            const fpError = document.getElementById('fp-error');
            let currentCustomOrderId = null; // Para sa pag-upload ng DP

            // --- API Helpers ---
            const showMessage = (container, msg, type = 'success') => {
                if (!container) return;
                container.textContent = msg;
                container.className = `p-3 rounded mb-4 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                container.classList.remove('hidden');
                setTimeout(() => container.classList.add('hidden'), 3500);
            };

            async function apiRequest(path, options = {}) {
                const isFormData = options.body instanceof FormData;
                const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
                if (!isFormData) {
                    headers['Content-Type'] = 'application/json';
                }
                options.headers = headers;
                const res = await fetch(`${API}${path}`, options);
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    throw new Error('Unauthorized');
                }
                return res.json();
            }

            // --- Initial Data Fetch ---
            async function fetchUserData() {
                try {
                    const json = await apiRequest('/api/auth/me');
                    if (!json.success) throw new Error(json.msg || 'Failed to load user');
                    populateUI(json.data);
                    loadingContainer.classList.add('hidden');
                    profileContainer.classList.remove('hidden');
                } catch (err) {
                    console.error('fetchUserData error', err);
                    loadingContainer.innerHTML = `<p class="text-red-500">Failed to load profile: ${err.message}</p>`;
                }
            }

            // --- Populate UI ---
            function populateUI(user) {
                userNameDisplay.textContent = user.name || '';
                userEmailDisplay.textContent = user.email || '';
                if (user.avatarUrl) {
                    const avatarTimestamp = `?t=${new Date().getTime()}`;
                    sidebarAvatarImg.src = `${user.avatarUrl}${avatarTimestamp}`;
                    avatarPreview.src = `${user.avatarUrl}${avatarTimestamp}`;
                    sidebarAvatarImg.classList.remove('hidden');
                    sidebarInitials.classList.add('hidden');
                } else {
                    const initials = (user.name || 'U').split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();
                    sidebarInitials.textContent = initials;
                    sidebarAvatarImg.classList.add('hidden');
                    sidebarInitials.classList.remove('hidden');
                    avatarPreview.src = 'https://placehold.co/160x160/e2e8f0/cccccc?text=Avatar';
                }
                profileForm.querySelector('#username').value = user.username || '';
                profileForm.querySelector('#name').value = user.name || '';
                profileForm.querySelector('#email').value = user.email || '';
                profileForm.querySelector('#contactNumber').value = user.contactNumber || '';
                document.querySelectorAll('input[name="gender"]').forEach(radio => {
                    radio.checked = (radio.value === user.gender);
                });
                if (user.dob) {
                    const dob = new Date(user.dob);
                    document.getElementById('dob-day').value = dob.getUTCDate();
                    document.getElementById('dob-month').value = dob.getUTCMonth() + 1;
                    document.getElementById('dob-year').value = dob.getUTCFullYear();
                } else {
                    document.getElementById('dob-day').value = '';
                    document.getElementById('dob-month').value = '';
                    document.getElementById('dob-year').value = '';
                }
            }

            // --- Profile Form Logic ---
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    username: profileForm.querySelector('#username').value,
                    name: profileForm.querySelector('#name').value,
                    contactNumber: profileForm.querySelector('#contactNumber').value,
                    gender: document.querySelector('input[name="gender"]:checked')?.value || '',
                };
                const day = document.getElementById('dob-day').value;
                const month = document.getElementById('dob-month').value;
                const year = document.getElementById('dob-year').value;
                if (day && month && year) {
                    data.dob = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                } else {
                    data.dob = null;
                }
                try {
                    const json = await apiRequest('/api/auth/updatedetails', {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    if (!json.success) throw new Error(json.msg || 'Update failed');
                    populateUI(json.data);
                    showMessage(profileMessageContainer, 'Profile updated successfully.', 'success');
                } catch (err) {
                    showMessage(profileMessageContainer, err.message || 'Update failed', 'error');
                }
            });

            // --- Avatar Upload Logic ---
            avatarInput.addEventListener('change', () => {
                const file = avatarInput.files[0];
                if (file) {
                    if (file.size > 1 * 1024 * 1024) { showMessage(avatarMessageContainer, 'File is too large. Maximum 1 MB.', 'error'); avatarInput.value = ''; return; }
                    if (!['image/jpeg', 'image/png'].includes(file.type)) { showMessage(avatarMessageContainer, 'Invalid file type. Only JPG or PNG.', 'error'); avatarInput.value = ''; return; }
                    selectedAvatarFile = file;
                    avatarPreview.src = URL.createObjectURL(file);
                }
            });
            avatarUploadBtn.addEventListener('click', async () => {
                if (!selectedAvatarFile) { showMessage(avatarMessageContainer, 'Please select an image first.', 'error'); return; }
                const fd = new FormData();
                fd.append('avatar', selectedAvatarFile);
                try {
                    const json = await apiRequest('/api/auth/updateavatar', { method: 'PUT', body: fd });
                    if (!json.success) throw new Error(json.msg || 'Upload failed');
                    showMessage(avatarMessageContainer, 'Avatar updated!', 'success');
                    populateUI(json.data);
                    selectedAvatarFile = null;
                    avatarInput.value = '';
                } catch (err) {
                    showMessage(avatarMessageContainer, err.message, 'error');
                }
            });

            // --- Address Logic ---
            async function fetchAddresses() {
                try {
                    const json = await apiRequest('/api/auth/me');
                    if (!json.success) throw new Error(json.msg || 'Could not load addresses');
                    renderAddresses(json.data.shippingAddresses || []);
                } catch (err) { addressesList.innerHTML = `<p class="text-red-500">${err.message}</p>`; }
            }
            function renderAddresses(addresses) {
                if (!addresses || addresses.length === 0) { addressesList.innerHTML = '<p class="text-gray-500">No saved addresses found.</p>'; return; }
                addressesList.innerHTML = addresses.map(addr => `
                <div class="border rounded p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${addr.street}</p>
                            <p class="text-sm text-gray-600">${addr.city}, ${addr.province}</p>
                            <p class="text-sm text-gray-600">${addr.zipCode}</p>
                        </div>
                        <div>
                            ${addr.isDefault
                        ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">Default</span>'
                        : `<button data-id="${addr._id}" class="set-default-btn text-sm text-indigo-600">Set as Default</button>`
                    }
                        </div>
                    </div>
                    <div class="mt-3 text-right">
                        <button data-id="${addr._id}" class="delete-address-btn text-sm text-red-600">Delete</button>
                    </div>
                </div>`).join('');
            }
            addAddressBtn.addEventListener('click', () => {
                addressForm.reset();
                document.getElementById('address-form-title').textContent = 'Add New Address';
                document.getElementById('address-form-id').textContent = '';
                addressForm.classList.remove('hidden');
                addAddressBtn.classList.add('hidden');
            });
            cancelAddressBtn.addEventListener('click', () => {
                addressForm.classList.add('hidden');
                addAddressBtn.classList.remove('hidden');
            });
            addressForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    street: document.getElementById('addr-street').value,
                    city: document.getElementById('addr-city').value,
                    province: document.getElementById('addr-province').value,
                    zipCode: document.getElementById('addr-zipCode').value,
                };
                try {
                    const json = await apiRequest('/api/auth/address', { method: 'POST', body: JSON.stringify(data) });
                    if (!json.success) throw new Error(json.msg || 'Failed to save address');
                    showMessage(addressMessageContainer, 'Address saved.', 'success');
                    renderAddresses(json.data);
                    addressForm.reset();
                    addressForm.classList.add('hidden');
                    addAddressBtn.classList.remove('hidden');
                } catch (err) {
                    showMessage(addressMessageContainer, err.message, 'error');
                }
            });
            addressesList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-address-btn');
                const defaultBtn = e.target.closest('.set-default-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('Are you sure you want to delete this address?')) {
                        try {
                            const json = await apiRequest(`/api/auth/address/${id}`, { method: 'DELETE' });
                            if (!json.success) throw new Error(json.msg || 'Failed to delete');
                            renderAddresses(json.data);
                            showMessage(addressMessageContainer, 'Address deleted.', 'success');
                        } catch (err) { showMessage(addressMessageContainer, err.message, 'error'); }
                    }
                }
                if (defaultBtn) {
                    const id = defaultBtn.dataset.id;
                    try {
                        const json = await apiRequest(`/api/auth/address/${id}/setdefault`, { method: 'PUT' });
                        if (!json.success) throw new Error(json.msg || 'Failed to set default');
                        renderAddresses(json.data);
                        showMessage(addressMessageContainer, 'Default address updated.', 'success');
                    } catch (err) { showMessage(addressMessageContainer, err.message, 'error'); }
                }
            });

            // --- Purchases Logic ---
            async function fetchPurchases(tabFilter = 'All') {
                purchasesList.innerHTML = '<p class="text-gray-500 text-center py-8">Loading orders...</p>';
                try {
                    const json = await apiRequest(`/api/orders/myorders?tab=${encodeURIComponent(tabFilter)}`);
                    if (!json.success) throw new Error(json.msg || 'Could not load purchases');
                    renderPurchases(json.data || [], tabFilter);
                } catch (err) {
                    purchasesList.innerHTML = `<p class="text-red-500 text-center py-8">${err.message}</p>`;
                }
            }
            function renderPurchases(orders, tabFilter) {
                if (!orders || orders.length === 0) {
                    purchasesList.innerHTML = `<p class="text-gray-500 text-center py-10">No orders found in ${tabFilter}.</p>`;
                    return;
                }
                purchasesList.innerHTML = orders.map(order => {
                    const itemsHtml = order.orderItems.map(item => `
                <div class="flex items-center gap-4 py-4 border-t">
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded border">
                    <div class="flex-1">
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-500">x ${item.quantity}</p>
                    </div>
                    <p class="text-sm text-gray-700">₱${(item.price * item.quantity).toLocaleString()}</p>
                </div>`).join('');
                    let statusLabel = ''; let statusColor = 'text-gray-700';
                    if (order.status === 'Cancelled') { statusLabel = 'CANCELLED'; statusColor = 'text-red-600'; }
                    else if (order.paymentStatus === 'Pending') { statusLabel = 'TO PAY'; statusColor = 'text-red-600'; }
                    else if (order.status === 'Accepted') { statusLabel = 'TO SHIP'; statusColor = 'text-blue-600'; }
                    else if (order.status === 'Shipped') { statusLabel = 'TO RECEIVE'; statusColor = 'text-blue-600'; }
                    else if (order.status === 'Delivered') { statusLabel = 'COMPLETED'; statusColor = 'text-green-600'; }
                    let buttonsHtml = '';
                    if (order.status === 'Cancelled') {
                        buttonsHtml = `<button data-order-id="${order._id}" data-reason="${order.cancellationReason}" data-by="${order.cancelledBy}" class="btn-details px-4 py-2 border rounded text-sm">Cancellation Details</button>`;
                    } else if (order.paymentStatus === 'Pending') {
                        buttonsHtml = `<button class="btn-pay-now px-4 py-2 bg-indigo-600 text-white rounded text-sm">Pay Now</button>
                                     <button data-order-id="${order._id}" class="btn-cancel px-4 py-2 border rounded text-sm">Cancel Order</button>`;
                    } else {
                        buttonsHtml = `<a href="order-confirmation.html?id=${order._id}" class="px-4 py-2 border rounded text-sm">View Details</a>`;
                    }
                    return `
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-4 flex justify-between items-center">
                        <span class="text-sm font-medium">Order ID: <span class="font-mono">${order._id.slice(0, 10)}...</span></span>
                        <span class="text-sm font-semibold ${statusColor}">${statusLabel}</span>
                    </div>
                    ${itemsHtml}
                    <div class="p-4 bg-gray-50 flex flex-col sm:flex-row justify-end items-center gap-4">
                        <div class="text-lg">Order Total: <span class="font-bold text-indigo-700">₱${order.totalPrice.toLocaleString()}</span></div>
                        <div class="flex gap-3">${buttonsHtml}</div>
                    </div>
                </div>`;
                }).join('');
            }
            purchasesTabs.addEventListener('click', (e) => {
                const btn = e.target.closest('button.purchase-tab');
                if (!btn) return;
                purchasesTabs.querySelectorAll('.purchase-tab').forEach(t => {
                    t.classList.remove('text-indigo-600', 'border-indigo-600', 'font-semibold', 'tab-active');
                    t.classList.add('text-gray-600', 'border-transparent');
                });
                btn.classList.add('text-indigo-600', 'border-indigo-600', 'font-semibold', 'tab-active');
                btn.classList.remove('text-gray-600', 'border-transparent');
                const filter = btn.dataset.tabFilter;
                fetchPurchases(filter);
            });
            purchasesList.addEventListener('click', (e) => {
                const payNowBtn = e.target.closest('.btn-pay-now');
                const cancelBtn = e.target.closest('.btn-cancel');
                const detailsBtn = e.target.closest('.btn-details');
                if (payNowBtn) { alert('Payment gateway not yet integrated. Please coordinate with the admin for payment.'); }
                if (cancelBtn) {
                    currentCancelOrderId = cancelBtn.dataset.orderId;
                    cancelModal.classList.remove('hidden'); cancelModal.classList.add('flex');
                    cancelError.classList.add('hidden'); cancelReasonOther.classList.add('hidden');
                    cancelReasonSelect.value = 'Changed my mind';
                }
                if (detailsBtn) {
                    const reason = detailsBtn.dataset.reason || "No reason provided.";
                    const by = detailsBtn.dataset.by || "N/A";
                    detailsCancelledBy.textContent = by.charAt(0).toUpperCase() + by.slice(1);
                    detailsReason.textContent = reason;
                    detailsModal.classList.remove('hidden'); detailsModal.classList.add('flex');
                }
            });
            cancelReasonSelect.addEventListener('change', () => {
                cancelReasonOther.classList.toggle('hidden', cancelReasonSelect.value !== 'Other');
            });
            cancelModalClose.addEventListener('click', () => cancelModal.classList.add('hidden'));
            cancelModalConfirm.addEventListener('click', async () => {
                let reason = cancelReasonSelect.value;
                if (reason === 'Other') { reason = cancelReasonOther.value.trim(); }
                if (!reason) { cancelError.textContent = 'Please provide a reason.'; cancelError.classList.remove('hidden'); return; }
                cancelModalConfirm.disabled = true; cancelModalConfirm.textContent = 'Cancelling...';
                try {
                    const json = await apiRequest(`/api/orders/${currentCancelOrderId}/cancel`, { method: 'PUT', body: JSON.stringify({ reason }) });
                    if (!json.success) throw new Error(json.msg || 'Failed to cancel order');
                    cancelModal.classList.add('hidden');
                    const activeTab = purchasesTabs.querySelector('.tab-active').dataset.tabFilter;
                    fetchPurchases(activeTab);
                } catch (err) {
                    cancelError.textContent = err.message;
                    cancelError.classList.remove('hidden');
                } finally {
                    cancelModalConfirm.disabled = false;
                    cancelModalConfirm.textContent = 'Confirm';
                }
            });
            detailsModalClose.addEventListener('click', () => detailsModal.classList.add('hidden'));
            detailsModalOk.addEventListener('click', () => detailsModal.classList.add('hidden'));

            // --- Vouchers Logic ---
            async function fetchVouchers() {
                try {
                    const json = await apiRequest('/api/auth/me');
                    if (!json.success) throw new Error(json.msg || 'Could not load vouchers');
                    renderVouchers(json.data.vouchers || []);
                } catch (err) { vouchersList.innerHTML = `<p class="text-red-500">${err.message}</p>`; }
            }
            function renderVouchers(vouchers) {
                if (!vouchers || vouchers.length === 0) { vouchersList.innerHTML = '<p class="text-gray-500">You have no vouchers.</p>'; return; }
                vouchersList.innerHTML = vouchers.map(v => `
                <div class="border rounded p-4 bg-gray-50">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-mono font-bold text-indigo-700">${v.code}</span>
                        <span class="text-sm font-semibold">${v.type === 'percentage' ? `${v.value}% OFF` : (v.type === 'fixed' ? `₱${v.value} OFF` : 'Free Shipping')}</span>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">${v.description}</p>
                </div>`).join('');
            }

            // --- NEW: Custom Order Functions ---
            async function fetchMyCustomOrders() {
                customOrdersList.innerHTML = '<p class="text-gray-500 text-center py-8">Loading custom orders...</p>';
                try {
                    const json = await apiRequest('/api/custom-orders/my-custom-orders');
                    if (!json.success) throw new Error(json.msg || 'Could not load orders');
                    renderMyCustomOrders(json.data || []);
                } catch (err) {
                    customOrdersList.innerHTML = `<p class="text-red-500 text-center py-8">${err.message}</p>`;
                }
            }

            function renderMyCustomOrders(orders) {
                if (!orders || orders.length === 0) {
                    customOrdersList.innerHTML = '<p class="text-gray-500 text-center py-10">You have no custom orders.</p>';
                    return;
                }

                customOrdersList.innerHTML = orders.map(order => {
                    let detailsHtml = '';
                    if (order.customType === 'FileUpload') {
                        detailsHtml = `<strong>Design:</strong> <a href="${order.designFileUrl}" target="_blank" class="text-indigo-600 hover:underline">View Uploaded File</a>`;
                    } else {
                        detailsHtml = `<strong>Design:</strong> ${order.designDetails || 'N/A'}`;
                    }

                    let statusLabel = order.status;
                    let statusColor = 'text-gray-700';
                    let buttonsHtml = '';

                    if (order.status === 'Pending Quote') {
                        statusLabel = 'PENDING QUOTE'; statusColor = 'text-yellow-600';
                        buttonsHtml = `<span class="text-sm text-gray-500">Waiting for admin quote...</span>`;
                    } else if (order.status === 'Quote Sent') {
                        statusLabel = 'QUOTE READY'; statusColor = 'text-green-600';
                        buttonsHtml = `<button data-id="${order._id}" data-name="${order.productName}" data-price="${order.price}" class="btn-pay-dp bg-indigo-600 text-white px-4 py-2 rounded text-sm">Pay 50% Down Payment</button>`;
                    } else if (order.status === 'Pending Downpayment') {
                        statusLabel = 'PENDING DP VERIFICATION'; statusColor = 'text-blue-600';
                        buttonsHtml = `<span class="text-sm text-gray-500">Waiting for admin to verify your payment...</span>`;
                    } else if (order.status === 'In Production') {
                        statusLabel = 'IN PRODUCTION'; statusColor = 'text-blue-800';
                        buttonsHtml = `<span class="text-sm text-gray-500">Your order is in production.</span>`;
                    } else if (order.status === 'Pending Balance') {
                        // --- ITO ANG BAGO PARA SA PHASE 5.2 ---
                        statusColor = 'text-green-600';
                        buttonsHtml = `<button data-id="${order._id}" data-name="${order.productName}" data-price="${order.price}" class="btn-pay-final bg-green-600 text-white px-4 py-2 rounded text-sm">Pay Remaining Balance</button>`;
                    } else if (order.status === 'Pending Final Verification') {
                        statusColor = 'text-blue-600';
                        buttonsHtml = `<span class="text-sm text-gray-500">Waiting for admin to verify final payment...</span>`;
                    } else {
                        statusLabel = order.status.toUpperCase();
                    }

                    return `
                        <div class="bg-white rounded-lg shadow-sm border">
                            <div class="p-4 flex justify-between items-center">
                                <span class="text-sm font-medium">Request ID: <span class="font-mono">${order._id.slice(0, 10)}...</span></span>
                                <span class="text-sm font-semibold ${statusColor}">${statusLabel}</span>
                            </div>
                            <div class="p-4 border-t">
                                <p class="font-semibold text-lg">${order.productName}</p>
                                <p class="text-sm text-gray-600"><strong>Quantity:</strong> ${order.quantity}</p>
                                <p class="text-sm text-gray-600">${detailsHtml}</p>
                                ${order.notes ? `<p class="text-sm text-gray-600 mt-2"><strong>Notes:</strong> ${order.notes}</p>` : ''}
                            </div>
                            <div class="p-4 bg-gray-50 flex flex-col sm:flex-row justify-end items-center gap-4">
                                <div class="text-lg">
                                    Order Total: <span class="font-bold text-indigo-700">${order.price > 0 ? `₱${order.price.toLocaleString()}` : 'Pending Quote'}</span>
                                </div>
                                <div class="flex gap-3">
                                    ${buttonsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // --- NEW: Event listener for "Pay Down Payment" button ---
            customOrdersList.addEventListener('click', (e) => {
                const payBtn = e.target.closest('.btn-pay-dp');
                const payFinalBtn = e.target.closest('.btn-pay-final');

                if (payBtn) {
                    currentCustomOrderId = payBtn.dataset.id;
                    const productName = payBtn.dataset.name;
                    const totalPrice = parseFloat(payBtn.dataset.price);
                    const downPayment = totalPrice * 0.5;

                    dpModalProductName.textContent = productName;
                    dpModalTotal.textContent = totalPrice.toLocaleString();
                    dpModalAmount.textContent = downPayment.toLocaleString();

                    dpFileInput.value = '';
                    dpError.classList.add('hidden');

                    dpModal.classList.remove('hidden');
                    dpModal.classList.add('flex');
                }

                if (payFinalBtn) {
                    currentCustomOrderId = payFinalBtn.dataset.id;
                    const productName = payFinalBtn.dataset.name;
                    const totalPrice = parseFloat(payFinalBtn.dataset.price);
                    const downPayment = totalPrice * 0.5;
                    const finalPayment = totalPrice - downPayment;

                    fpModalProductName.textContent = productName;
                    fpModalTotal.textContent = totalPrice.toLocaleString();
                    fpModalDpPaid.textContent = downPayment.toLocaleString();
                    fpModalAmount.textContent = finalPayment.toLocaleString();

                    fpFileInput.value = '';
                    fpError.classList.add('hidden');
                    fpModal.classList.remove('hidden');
                    fpModal.classList.add('flex');
                }
            });

            // --- NEW: Down Payment Modal Logic ---
            dpModalClose.addEventListener('click', () => dpModal.classList.add('hidden'));
            dpModalConfirm.addEventListener('click', async () => {
                const file = dpFileInput.files[0];
                if (!file) {
                    dpError.textContent = 'Please select your receipt file.';
                    dpError.classList.remove('hidden');
                    return;
                }

                const fd = new FormData();
                // Ginamit ang 'designFile' na field name galing sa customOrderRoutes.js
                fd.append('designFile', file);

                dpModalConfirm.disabled = true;
                dpModalConfirm.textContent = 'Uploading...';
                dpError.classList.add('hidden');

                try {
                    const json = await apiRequest(`/api/custom-orders/${currentCustomOrderId}/downpayment`, {
                        method: 'PUT',
                        body: fd
                    });

                    if (!json.success) throw new Error(json.msg || 'Failed to submit receipt');

                    alert(json.msg || 'Receipt submitted!');
                    dpModal.classList.add('hidden');
                    fetchMyCustomOrders(); // I-refresh ang listahan

                } catch (err) {
                    dpError.textContent = err.message;
                    dpError.classList.remove('hidden');
                } finally {
                    dpModalConfirm.disabled = false;
                    dpModalConfirm.textContent = 'Submit Receipt';
                }
            });

            // --- NEW: Final Payment Modal Logic (Para sa Phase 5.2) ---
            fpModalClose.addEventListener('click', () => fpModal.classList.add('hidden'));
            fpModalConfirm.addEventListener('click', async () => {
                const file = fpFileInput.files[0];
                if (!file) {
                    fpError.textContent = 'Please select your receipt file.';
                    fpError.classList.remove('hidden');
                    return;
                }

                const fd = new FormData();
                fd.append('designFile', file); // Gagamitin ulit natin ang 'designFile' field name

                fpModalConfirm.disabled = true;
                fpModalConfirm.textContent = 'Uploading...';
                fpError.classList.add('hidden');

                try {
                    const json = await apiRequest(`/api/custom-orders/${currentCustomOrderId}/final-payment`, {
                        method: 'PUT',
                        body: fd
                    });
                    if (!json.success) throw new Error(json.msg || 'Failed to submit receipt');
                    
                    alert(json.msg || 'Final receipt submitted!');
                    fpModal.classList.add('hidden');
                    fetchMyCustomOrders(); // I-refresh ang listahan

                } catch (err) {
                    fpError.textContent = err.message;
                    fpError.classList.remove('hidden');
                } finally {
                    fpModalConfirm.disabled = false;
                    fpModalConfirm.textContent = 'Submit Final Receipt';
                }
            });

            // --- MODIFIED: Main Tab/Sidebar Switching Logic ---
            sidebarNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-tab], button[data-tab-parent]');
                if (!btn) return;

                const tab = btn.dataset.tab;
                const parentTab = btn.dataset.tabParent;

                document.querySelectorAll('#sidebar-nav .sidebar-active').forEach(b => b.classList.remove('sidebar-active'));
                document.querySelectorAll('#tab-content > div').forEach(d => {
                    d.classList.add('hidden');
                    d.classList.remove('bg-white', 'p-6', 'md:p-8', 'rounded-lg', 'shadow-md');
                });

                if (tab) {
                    btn.classList.add('sidebar-active');
                    const parentBtn = btn.closest('.sidebar-submenu')?.previousElementSibling;
                    if (parentBtn) { parentBtn.classList.add('sidebar-active'); }

                    const contentEl = document.getElementById(`${tab}-content`);
                    if (contentEl) {
                        contentEl.classList.remove('hidden');
                        if (tab !== 'purchases' && tab !== 'custom-orders') { // <-- MODIFIED
                            contentEl.classList.add('bg-white', 'p-6', 'md:p-8', 'rounded-lg', 'shadow-md');
                        }
                    }

                    // Fetch data on-demand
                    if (tab === 'purchases' && purchasesList.innerHTML.trim() === "") fetchPurchases('All');
                    if (tab === 'addresses' && addressesList.innerHTML.trim() === "") fetchAddresses();
                    if (tab === 'vouchers' && vouchersList.innerHTML.trim() === "") fetchVouchers();
                    if (tab === 'custom-orders' && customOrdersList.innerHTML.trim() === "") fetchMyCustomOrders(); // <-- NEW

                } else if (parentTab) {
                    btn.classList.add('sidebar-active');
                    const firstChild = btn.nextElementSibling?.querySelector('button[data-tab]');

                    if (firstChild) {
                        firstChild.click();
                    } else {
                        const contentEl = document.getElementById(`${parentTab}-content`);
                        if (contentEl) {
                            contentEl.classList.remove('hidden');
                            if (parentTab !== 'purchases' && parentTab !== 'custom-orders') { // <-- MODIFIED
                                contentEl.classList.add('bg-white', 'p-6', 'md:p-8', 'rounded-lg', 'shadow-md');
                            }
                        }
                        if (parentTab === 'purchases' && purchasesList.innerHTML.trim() === "") fetchPurchases('All');
                        if (parentTab === 'custom-orders' && customOrdersList.innerHTML.trim() === "") fetchMyCustomOrders(); // <-- NEW
                    }
                }
            });

            // --- Logout Button ---
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });

            // --- Initial Load ---
            fetchUserData();
        });
    </script>
</body>

</html>