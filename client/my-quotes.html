<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Quotes & Orders â€¢ Fundamental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="/client/index.html" class="text-xl font-bold text-indigo-600">Fundamental</a>
        <a href="/client/profile.html"
          class="inline-flex items-center gap-2 px-3 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">
          <i class="fas fa-arrow-left"></i>
          Back to My Profile
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-6">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">My Quotes & Orders</h1>
        <p class="text-sm text-gray-500">Track status, view pricing, and upload payment receipts.</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-700">Status</label>
        <select id="statusFilter" class="px-3 py-2 border rounded bg-white">
          <option value="">All</option>
          <option>Pending Quote</option>
          <option>Quote Sent</option>
          <option>Quote Accepted</option>
          <option>Pending Downpayment</option>
          <option>In Production</option>
          <option>Pending Balance</option>
          <option>Pending Final Verification</option>
          <option>Completed</option>
          <option>Ready for Pickup/Delivery</option>
          <option>Out for Delivery</option>
          <option>Cancelled</option>
        </select>
      </div>
    </div>

    <div id="list" class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3 items-stretch"></div>
  </main>

  <!-- Order Details Modal -->
  <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-900">Order Details</h2>
        <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="modalContent" class="p-6"></div>
    </div>
  </div>

  <template id="cardTpl">
    <div class="bg-white border rounded-xl p-4 flex flex-col gap-3 h-full">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs text-gray-500">Quote #<span data-ref></span></div>
          <div class="font-semibold" data-product></div>
            <div class="text-xs text-gray-500" data-item></div>
              <div class="text-sm text-gray-600 mt-1" data-fg></div>
              <div class="text-xs text-gray-500 mt-1" data-minprice></div>
        </div>
        <span class="px-2 py-1 text-xs rounded-full" data-badge></span>
      </div>

      <div class="grid grid-cols-2 gap-2 text-sm">
        <div class="p-2 bg-gray-50 rounded">
          <div class="text-xs text-gray-500">Quantity</div>
          <div data-qty></div>
        </div>
        <div class="p-2 bg-gray-50 rounded">
          <div class="text-xs text-gray-500">Price</div>
          <div data-price>-</div>
        </div>
      </div>

      <div class="text-xs text-gray-500" data-updated></div>
      <div class="hidden" data-breakdown-wrap>
        <button type="button"
          class="inline-flex items-center gap-1 px-2 py-1 border border-indigo-300 text-indigo-700 bg-indigo-50 rounded text-xs hover:bg-indigo-100"
          data-breakdown-toggle>
          <i class="fas fa-list"></i>
          View Pricing Breakdown
        </button>
        <pre
          class="mt-2 text-[11px] leading-tight bg-indigo-50 border border-indigo-200 rounded p-2 whitespace-pre-wrap hidden"
          data-breakdown></pre>
      </div>
      <div class="border-t pt-3 mt-auto" data-actions></div>
    </div>
  </template>

  <script>
    const token = localStorage.getItem('token');
    let fileCounter = 0;

    function badgeClass(status) {
      switch (status) {
        case 'Pending Quote': return 'bg-yellow-100 text-yellow-800';
        case 'Quote Sent': return 'bg-blue-100 text-blue-800';
        case 'Quote Accepted': return 'bg-blue-100 text-blue-800';
        case 'Pending Downpayment': return 'bg-orange-100 text-orange-800';
        case 'In Production': return 'bg-indigo-100 text-indigo-800';
        case 'Pending Balance': return 'bg-purple-100 text-purple-800';
        case 'Pending Final Verification': return 'bg-teal-100 text-teal-800';
        case 'Completed': return 'bg-green-100 text-green-800';
        case 'Ready for Pickup/Delivery': return 'bg-green-100 text-green-800';
        case 'Out for Delivery': return 'bg-blue-100 text-blue-800';
        case 'Cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    // Build a displayable delivery address using deliveryAddress or structured shippingAddress
    function getDisplayAddress(order) {
      if (order && order.deliveryAddress && order.deliveryAddress.trim()) return order.deliveryAddress;
      const addr = order && (order.shippingAddress || (order.quotePayload && order.quotePayload.shippingAddress));
      if (!addr) return 'Your address';
      const parts = [];
      if (addr.block) parts.push(`Block ${addr.block}`);
      if (addr.lot) parts.push(`Lot ${addr.lot}`);
      if (addr.street) parts.push(addr.street);
      if (addr.building) parts.push(addr.building);
      if (addr.city) parts.push(addr.city);
      if (addr.province) parts.push(addr.province);
      if (addr.zip) parts.push(addr.zip);
      if (addr.phone) parts.push(`Tel: ${addr.phone}`);
      return parts.length ? parts.join(', ') : 'Your address';
    }

    const API_BASE = 'https://fundamental-apparel-backend.onrender.com';

    async function fetchMine(){
      // 1. Define mo ang backend URL
      const API_BASE = 'https://fundamental-apparel-backend.onrender.com';

      const token = localStorage.getItem('token');
      if (!token){ window.location.href = '/client/login.html'; return; }
      
      try {
          // 2. Gamitin ang API_BASE dito
          const res = await fetch(`${API_BASE}/api/custom-orders/my-custom-orders`, { 
              headers: { 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' } 
          });

          // 3. Check kung okay ang response
          if (!res.ok) throw new Error('Server error');

          const json = await res.json();
          if (!json.success) { alert(json.msg || 'Failed to load'); return; }
          
          renderList(json.data || []);

      } catch (err) {
          console.error(err);
          // Ipakita ang error sa screen para hindi gray bars lang
          document.getElementById('list').innerHTML = '<div class="col-span-full text-center p-4 text-red-500">Failed to load quotes. Please check your internet connection.</div>';
      }
    }

    function renderList(items) {
      const filter = document.getElementById('statusFilter').value;
      const wrap = document.getElementById('list');
      wrap.innerHTML = '';
      items
        .filter(o => !filter || o.status === filter)
        .forEach(o => wrap.appendChild(renderCard(o)));

      if (!wrap.children.length) {
        wrap.innerHTML = `
          <div class="md:col-span-2 lg:col-span-3">
            <div class="text-center p-12 bg-white border rounded-xl">
              <div class="text-3xl mb-2">ðŸ§¾</div>
              <div class="font-semibold text-gray-800 mb-1">No quotes found</div>
              <p class="text-sm text-gray-500">Start a new customization from Services or the Customizer.</p>
            </div>
          </div>`;
      }
    }

    function renderCard(order) {
      const tpl = document.getElementById('cardTpl').content.cloneNode(true);
      const code = (order._id || '').toString().slice(-8).toUpperCase();
      tpl.querySelector('[data-ref]').textContent = code;
      tpl.querySelector('[data-product]').textContent = order.productName || 'Custom Garment';
      tpl.querySelector('[data-item]').textContent = `${order.itemType || ''} â€¢ ${order.selectedLocation || ''}`;
      // Show selected Fabric & Garment when available
      const fgEl = tpl.querySelector('[data-fg]');
      const fgName = order.inventoryName || ((order.fabricType && order.garmentType) ? `${order.fabricType} - ${order.garmentType}` : '');
      if(fgEl){ if(fgName) { fgEl.textContent = fgName; fgEl.classList.remove('hidden'); } else { fgEl.classList.add('hidden'); fgEl.textContent = ''; } }
      // Fetch minimum price from inventory availability API and show it under the fg
      (async ()=>{
        try{
          const minEl = tpl.querySelector('[data-minprice]');
          if(!fgName || !minEl) return;
          const token = localStorage.getItem('token');
          const res = await fetch(`${API_BASE}/api/admin/inventory/availability?name=${encodeURIComponent(fgName)}`, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
          if(!res.ok) return;
          const json = await res.json().catch(()=>null);
          if(!json || !json.success || !json.data) return;
          const price = Number(json.data.price || 0);
          if(price && price > 0){ minEl.textContent = `Minimum price: â‚±${price.toFixed(2)}`; minEl.classList.remove('hidden'); }
          else { minEl.classList.add('hidden'); minEl.textContent = ''; }
        }catch(e){ /* ignore */ }
      })();
      tpl.querySelector('[data-qty]').textContent = order.quantity || 0;

      const badge = tpl.querySelector('[data-badge]');
      badge.textContent = order.status;
      badge.className = 'px-2 py-1 text-xs rounded ' + badgeClass(order.status);

      // Price: show only when admin has sent a quote; include per-item
      const priceEl = tpl.querySelector('[data-price]');
      if (typeof order.price === 'number' && order.price > 0) {
        try {
          const total = Number(order.price);
          const qty = Number(order.quantity) || 0;
          const each = qty > 0 ? Math.round((total / qty) * 100) / 100 : null;
          priceEl.textContent = 'â‚±' + total.toLocaleString() + (each ? ` (â‚±${each.toLocaleString()} each)` : '');
        } catch {
          const qty = Number(order.quantity) || 0;
          const total = order.price;
          const each = qty > 0 ? Math.round((Number(total) / qty) * 100) / 100 : null;
          priceEl.textContent = 'â‚±' + total + (each ? ` (â‚±${each} each)` : '');
        }
      } else {
        priceEl.textContent = 'â€”';
      }

      tpl.querySelector('[data-updated]').textContent = `Updated: ${new Date(order.updatedAt).toLocaleString()}`;
      // Compact item line when values are missing
      const itemEl = tpl.querySelector('[data-item]');
      const loc = order.selectedLocation || order.designStyle || '';
      const it = order.itemType || order.customType || '';
      const meta = [it, loc].filter(Boolean).join(' â€¢ ');
      if (meta) itemEl.textContent = meta;

      // Pricing breakdown: show when price exists; if notes missing, show placeholder
      const bdWrap = tpl.querySelector('[data-breakdown-wrap]');
      const bd = tpl.querySelector('[data-breakdown]');
      const bdToggle = tpl.querySelector('[data-breakdown-toggle]');
      const priceAvailable = typeof order.price === 'number' && order.price > 0;
      if (priceAvailable) {
        bdWrap.classList.remove('hidden');
        const hasAdminNotes = (order.adminNotes && String(order.adminNotes).trim().length > 0);
        if (hasAdminNotes) {
          bd.textContent = order.adminNotes;
        } else {
          // Fallback to auto breakdown from quote payload if available
          const autoBD = order.quotePayload && order.quotePayload.pricingBreakdown;
          if (autoBD) {
            try {
              const lines = [];
              if (autoBD.basePrice != null) lines.push(`Base: â‚±${Number(autoBD.basePrice).toLocaleString()}`);
              if (autoBD.printingType) lines.push(`Printing: ${autoBD.printingType}`);
              if (autoBD.printingSurcharge != null) lines.push(`Printing Surcharge: â‚±${Number(autoBD.printingSurcharge).toLocaleString()}`);
              if (Array.isArray(autoBD.sizeSurcharges) && autoBD.sizeSurcharges.length) {
                const nonZero = autoBD.sizeSurcharges.filter(s => Number(s.surcharge) > 0);
                if (nonZero.length) {
                  lines.push('Size Surcharges:');
                  nonZero.forEach(s => lines.push(`  â€¢ ${s.size}: â‚±${Number(s.surcharge).toLocaleString()}`));
                }
              }
              if (autoBD.unitPrice != null) lines.push(`Per Item: â‚±${Number(autoBD.unitPrice).toLocaleString()}`);
              if (autoBD.quantity != null) lines.push(`Quantity: ${autoBD.quantity}`);
              if (autoBD.totalPrice != null) lines.push(`Total: â‚±${Number(autoBD.totalPrice).toLocaleString()}`);
              bd.textContent = lines.length ? lines.join('\n') : 'No detailed pricing breakdown provided.';
            } catch {
              bd.textContent = typeof autoBD === 'string' ? autoBD : JSON.stringify(autoBD, null, 2);
            }
          } else {
            bd.textContent = 'No detailed pricing breakdown provided.';
          }
        }
        let expanded = false;
        bdToggle.addEventListener('click', () => {
          expanded = !expanded;
          bd.classList.toggle('hidden', !expanded);
          bdToggle.innerHTML = expanded ? '<i class="fas fa-list"></i> Hide Pricing Breakdown' : '<i class="fas fa-list"></i> View Pricing Breakdown';
        });
      }

      const actions = tpl.querySelector('[data-actions]');
      actions.appendChild(renderActions(order));

      return tpl;
    }

    function renderActions(order) {
      const wrap = document.createElement('div');
      wrap.className = 'flex flex-col gap-3';

      // View Details button (always available)
      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition';
      detailsBtn.innerHTML = '<i class="fas fa-eye mr-1"></i> View Details';
      detailsBtn.onclick = () => openDetailsModal(order);
      wrap.appendChild(detailsBtn);

      if (order.status === 'Quote Sent') {
        const info = document.createElement('div');
        info.className = 'text-sm text-gray-700 mb-2';
        info.textContent = 'Please review the quote and accept to proceed with payment.';

        const btnContainer = document.createElement('div');
        btnContainer.className = 'flex gap-2';

        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition';
        acceptBtn.textContent = 'Accept Quote';
        acceptBtn.onclick = async () => { await acceptQuote(order._id); };

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'px-4 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition';
        cancelBtn.textContent = 'Cancel Quote';
        cancelBtn.onclick = async () => { await cancelQuote(order._id); };

        btnContainer.appendChild(acceptBtn);
        btnContainer.appendChild(cancelBtn);
        wrap.appendChild(info);
        wrap.appendChild(btnContainer);
      }
      else if (order.status === 'Pending Downpayment') {
        // Check if payment was already made (PayMongo completed but admin hasn't verified yet)
        if (order.downPaymentPaid || order.paymentIntentId) {
          // Payment completed, waiting for admin verification
          const info = document.createElement('div');
          info.className = 'p-4 bg-blue-50 border border-blue-200 rounded text-sm';
          info.innerHTML = `
            <div class="flex items-center gap-2 mb-2">
              <i class="fas fa-clock text-blue-600"></i>
              <strong class="text-blue-800">Payment Received</strong>
            </div>
            <p class="text-gray-700">Your ${order.paymentType === 'full' ? '100%' : '50%'} payment has been received and is being verified by our admin team. You'll be notified once verified and production begins.</p>
            <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-gray-600">
              <div>Payment Method: <strong>${order.paymentMethod || 'N/A'}</strong></div>
              <div>Amount Paid: <strong>â‚±${(order.paymentAmount || 0).toLocaleString()}</strong></div>
            </div>
          `;
          wrap.appendChild(info);
        } else {
          // No payment yet, show payment options
          const info = document.createElement('div');
          info.className = 'text-sm text-gray-700 mb-3';
          info.innerHTML = '<strong>Quote Accepted!</strong> Choose your payment option:';
          wrap.appendChild(info);

          // Pay 50% Downpayment Button
          const btn50 = document.createElement('button');
          btn50.className = 'px-4 py-2 bg-green-600 text-white rounded text-sm font-medium hover:bg-green-700 transition';
          btn50.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Pay 50% Downpayment';
          btn50.onclick = () => proceedToPayment(order, 'downpayment');
          wrap.appendChild(btn50);

          // Pay 100% Full Payment Button
          const btn100 = document.createElement('button');
          btn100.className = 'px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition';
          btn100.innerHTML = '<i class="fas fa-money-bill-wave mr-2"></i>Pay 100% Full Amount';
          btn100.onclick = () => proceedToPayment(order, 'full');
          wrap.appendChild(btn100);
        }
      }
      else if (order.status === 'In Production') {
        // Order is being produced/admin has verified payment
        const info = document.createElement('div');
        info.className = 'p-4 bg-green-50 border border-green-200 rounded text-sm';
        info.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-check-circle text-green-600"></i>
            <strong class="text-green-800">Payment Verified - In Production</strong>
          </div>
          <p class="text-gray-700">Your payment has been verified and your order is now in production. We'll notify you when it's ready!</p>
        `;
        wrap.appendChild(info);
      }
      else if (order.status === 'Pending Balance') {
        // For final payment, use PayMongo like downpayment/full
        const info = document.createElement('div');
        info.className = 'text-sm text-gray-700 mb-3';
        info.innerHTML = '<strong>Final Payment Requested.</strong> Please pay the remaining balance to proceed.';
        wrap.appendChild(info);

        const btnPayFinal = document.createElement('button');
        btnPayFinal.className = 'px-4 py-2 bg-purple-600 text-white rounded text-sm font-medium hover:bg-purple-700 transition';
        btnPayFinal.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Pay Final Payment';
        btnPayFinal.onclick = () => proceedToPayment(order, 'balance');
        wrap.appendChild(btnPayFinal);
      }
      else if (order.status === 'Pending Final Verification') {
        // Clarify final payment received status for PayMongo flow
        wrap.innerHTML = `
          <div class="p-4 bg-indigo-50 border border-indigo-200 rounded text-sm">
            <div class="flex items-center gap-2 mb-2">
              <i class="fas fa-check text-indigo-600"></i>
              <strong class="text-indigo-800">Final Payment Received</strong>
            </div>
            <p class="text-gray-700 mb-2">We received your final payment. It is now waiting for admin verification.</p>
            <p class="text-xs text-gray-500">Reference will update once verified. Thank you!</p>
          </div>
        `;
      }
      else if (order.status === 'Completed') {
        // Order completed - show confirmation
        wrap.innerHTML = `
          <div class="p-4 bg-green-50 border border-green-200 rounded text-sm">
            <div class="flex items-center gap-2 mb-2">
              <i class="fas fa-check-circle text-green-600 text-lg"></i>
              <strong class="text-green-800">Order Completed!</strong>
            </div>
            <p class="text-gray-700">Thank you for confirming receipt of your order. We hope you enjoy your custom apparel!</p>
            <div class="mt-3 pt-3 border-t border-green-300 text-xs text-gray-600">
              <div>Completed on: <strong>${new Date(order.updatedAt).toLocaleDateString()}</strong></div>
            </div>
          </div>
        `;
      }
      else if (order.status === 'Ready for Pickup/Delivery') {
        // Show fulfillment details and "Confirm Receipt" button
        const box = document.createElement('div');
        box.className = 'p-4 bg-green-50 border border-green-200 rounded text-sm';

        // Show fulfillment info
        let fulfillmentInfo = '';
        if (order.fulfillmentMethod === 'pickup') {
          fulfillmentInfo = `
            <div class="mb-3">
              <div class="flex items-center gap-2 mb-1">
                <i class="fas fa-store text-green-600"></i>
                <strong>Pickup Location:</strong>
              </div>
              <p class="text-gray-700 ml-6">${order.pickupLocation || 'Our store location'}</p>
            </div>
          `;
        } else if (order.fulfillmentMethod === 'delivery') {
          fulfillmentInfo = `
            <div class="mb-3">
              <div class="flex items-center gap-2 mb-1">
                <i class="fas fa-truck text-green-600"></i>
                <strong>Delivery Address:</strong>
              </div>
              <p class="text-gray-700 ml-6">${getDisplayAddress(order)}</p>
              ${order.trackingNumber ? `
                <div class="mt-2 ml-6">
                  <span class="text-xs text-gray-600">Tracking: <strong>${order.trackingNumber}</strong></span>
                </div>
              ` : ''}
            </div>
          `;
        }

        // Determine refund eligibility (7 days from delivery/completion if available)
        const refundWindowMs = 7 * 24 * 60 * 60 * 1000; // 7 days
        const referenceDateMs = (order.deliveredAt || order.completedAt) ? new Date(order.deliveredAt || order.completedAt).getTime() : null;
        const refundWindowExpired = referenceDateMs ? (Date.now() > (referenceDateMs + refundWindowMs)) : false;
        const hasRefundRequest = !!order.hasRefundRequest;

        box.innerHTML = `
          <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-box-open text-green-600 text-lg"></i>
            <strong class="text-green-800">Your order is ready!</strong>
          </div>
          ${fulfillmentInfo}
          <div class="pt-3 border-t border-green-300">
            <p class="text-gray-700 mb-3">Have you received your order?</p>
            <button onclick="confirmReceipt('${order._id}')" class="px-4 py-2 bg-green-600 text-white rounded text-sm font-medium hover:bg-green-700 transition w-full mb-2">
              <i class="fas fa-check-circle mr-2"></i>Confirm Receipt & Complete Order
            </button>
            ${(!refundWindowExpired && !hasRefundRequest) ? `<button onclick="requestRefund('${order._id}')" class="px-4 py-2 border rounded text-sm w-full">Request Refund</button>` : (hasRefundRequest ? `<button disabled class="px-4 py-2 border rounded text-sm w-full text-gray-500">Refund Requested</button>` : '')}
          </div>
        `;
        wrap.appendChild(box);
      }
      else if (order.status === 'Out for Delivery') {
        // Show delivery tracking info with "Confirm Receipt" button
        const box = document.createElement('div');
        box.className = 'p-4 bg-blue-50 border border-blue-200 rounded text-sm';

        box.innerHTML = `
          <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-shipping-fast text-blue-600 text-lg"></i>
            <strong class="text-blue-800">Out for Delivery</strong>
          </div>
          <div class="space-y-2 mb-3">
            <div class="flex items-start gap-2">
              <i class="fas fa-map-marker-alt text-blue-600 mt-1"></i>
              <div class="flex-1">
                <p class="text-xs text-gray-600">Delivery Address:</p>
                <p class="text-gray-900 font-medium">${getDisplayAddress(order)}</p>
              </div>
            </div>
            ${order.courier ? `
            <div class="flex items-center gap-2">
              <i class="fas fa-truck text-blue-600"></i>
              <div class="flex-1">
                <p class="text-xs text-gray-600">Courier:</p>
                <p class="text-gray-900 font-medium">${order.courier}</p>
              </div>
            </div>
            ` : ''}
            ${order.trackingNumber ? `
            <div class="flex items-center gap-2 bg-white rounded p-2 border border-blue-300">
              <i class="fas fa-barcode text-blue-600"></i>
              <div class="flex-1">
                <p class="text-xs text-gray-600">Tracking Number:</p>
                <p class="text-gray-900 font-mono font-bold">${order.trackingNumber}</p>
              </div>
              <button onclick="navigator.clipboard.writeText('${order.trackingNumber}')" class="text-blue-600 hover:text-blue-800 px-2">
                <i class="fas fa-copy"></i>
              </button>
            </div>
            ` : ''}
            ${order.estimatedDeliveryDate ? `
            <div class="flex items-center gap-2">
              <i class="fas fa-calendar-alt text-blue-600"></i>
              <div class="flex-1">
                <p class="text-xs text-gray-600">Estimated Delivery:</p>
                <p class="text-gray-900 font-medium">${new Date(order.estimatedDeliveryDate).toLocaleDateString()}</p>
              </div>
            </div>
            ` : ''}
          </div>
          <div class="pt-3 border-t border-blue-300">
            <p class="text-gray-700 mb-3">Once you receive your order, please confirm:</p>
            <button onclick="confirmReceipt('${order._id}')" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition w-full mb-2">
              <i class="fas fa-check-circle mr-2"></i>Confirm Receipt & Complete Order
            </button>
            ${((!(order.deliveredAt || order.completedAt)) || (Date.now() <= ((new Date(order.deliveredAt || order.completedAt)).getTime() + (7*24*60*60*1000)))) && !order.hasRefundRequest ? `<button onclick="requestRefund('${order._id}')" class="px-4 py-2 border rounded text-sm w-full">Request Refund</button>` : (order.hasRefundRequest ? `<button disabled class="px-4 py-2 border rounded text-sm w-full text-gray-500">Refund Requested</button>` : '')}
          </div>
        `;
        wrap.appendChild(box);
      }
      else if (order.status === 'Cancelled') {
        wrap.innerHTML = '<div class="text-sm text-red-600">Quote cancelled. Please submit a new quote.</div>';
      } else {
        wrap.innerHTML = '<div class="text-sm text-gray-600">No actions available at this stage.</div>';
      }

      return wrap;
    }

    function uploadRow(label, onSubmit) {
      const row = document.createElement('div');
      row.className = 'flex flex-col sm:flex-row sm:items-center gap-2';

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,.pdf';
      input.id = `file-${++fileCounter}`;
      input.className = 'hidden';

      const choose = document.createElement('label');
      choose.setAttribute('for', input.id);
      choose.className = 'inline-flex items-center gap-2 px-3 py-2 border rounded text-sm bg-white hover:bg-gray-50 cursor-pointer';
      choose.innerHTML = '<i class="fas fa-paperclip text-gray-500"></i> Choose File';

      const name = document.createElement('span');
      name.className = 'text-xs text-gray-500 truncate';
      name.textContent = 'No file chosen';

      input.addEventListener('change', () => {
        const f = input.files && input.files[0];
        name.textContent = f ? f.name : 'No file chosen';
      });

      const btn = document.createElement('button');
      btn.className = 'px-3 py-2 bg-indigo-600 text-white rounded text-sm';
      btn.textContent = label;
      btn.onclick = async () => {
        const file = input.files && input.files[0];
        if (!file) { alert('Please choose a file'); return; }
        btn.disabled = true; btn.textContent = 'Uploadingâ€¦';
        try { await onSubmit(file); } finally { btn.disabled = false; btn.textContent = label; }
      };

      row.appendChild(input);
      row.appendChild(choose);
      row.appendChild(name);
      row.appendChild(btn);
      return row;
    }

    async function submitDownpayment(id, file) {
      const fd = new FormData();
      fd.append('designFile', file);
      const res = await fetch(`/api/custom-orders/${id}/downpayment`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' },
        body: fd
      });
      const json = await res.json();
      if (!json.success) { alert(json.msg || 'Failed to upload downpayment'); return; }
      alert('Downpayment receipt uploaded. Awaiting verification.');
      fetchMine();
    }

    async function submitFinalPayment(id, file) {
      const fd = new FormData();
      fd.append('designFile', file);
      const res = await fetch(`/api/custom-orders/${id}/final-payment`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' },
        body: fd
      });
      const json = await res.json();
      if (!json.success) { alert(json.msg || 'Failed to upload final payment'); return; }
      alert('Final payment receipt uploaded. Awaiting verification.');
      fetchMine();
    }

    async function acceptQuote(id) {
      const res = await fetch(`/api/custom-orders/${id}/accept`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' }
      });
      const json = await res.json();
      if (!json.success) { alert(json.msg || 'Failed to accept quote'); return; }
      // Refresh to show payment options
      fetchMine();
    }

    function proceedToPayment(order, paymentOption) {
      // Store order and payment option in localStorage
      const checkoutData = {
        orderId: order._id,
        orderReference: order._id.toString().slice(-8).toUpperCase(),
        serviceType: order.serviceType || 'customize-jersey',
        serviceName: order.productName || 'Custom Order',
        quantity: order.quantity || 1,
        // Always keep totals as FULL amounts; checkout will handle downpayment math
        basePrice: order.price || order.totalPrice || 0,
        totalPrice: order.price || order.totalPrice || 0,
        // Provide unitPrice for clearer subtotal when available
        unitPrice: (order.quantity && (order.price || order.totalPrice)) ? ((order.price || order.totalPrice) / (order.quantity || 1)) : undefined,
        paymentOption: paymentOption, // 'downpayment' | 'full' | 'balance'
        alreadyPaidAmount: Number(order.paymentAmount || 0),
        previousDeliveryFee: Number(order.deliveryFee || 0),
        garmentType: order.garmentType || order.itemType || 't-shirt',
        selectedLocation: order.selectedLocation || 'Front',
        designDetails: order.designDetails || '',
        colors: order.colors || {},
        designText: order.designText || '',
        quotePayload: order.quotePayload || {},
        designImagesMap: order.designImagesMap || null,
        designImage: order.designImage || '',
        notes: order.notes || ''
      };

      localStorage.setItem('pendingServiceCheckout', JSON.stringify(checkoutData));
      if (paymentOption === 'balance') {
        window.location.href = 'services-checkout-final.html';
      } else {
        window.location.href = 'services-checkout.html';
      }
    }

    document.getElementById('statusFilter').addEventListener('change', fetchMine);

    // Initial skeleton state
    (function skeleton() {
      const wrap = document.getElementById('list');
      wrap.innerHTML = Array.from({ length: 6 }).map(() => `
        <div class="bg-white border rounded-xl p-4 animate-pulse">
          <div class="h-4 w-24 bg-gray-200 rounded mb-2"></div>
          <div class="h-5 w-40 bg-gray-200 rounded mb-4"></div>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="h-10 bg-gray-100 rounded"></div>
            <div class="h-10 bg-gray-100 rounded"></div>
          </div>
          <div class="h-4 w-32 bg-gray-200 rounded mb-3"></div>
          <div class="h-10 bg-gray-100 rounded"></div>
        </div>`).join('');
    })();

    fetchMine();

    // Check if returning from payment (PayMongo redirect)
    const urlParams = new URLSearchParams(window.location.search);
    const paymentReturn = urlParams.get('payment');
    const orderRef = urlParams.get('ref');

    if (paymentReturn === 'success' && orderRef) {
      console.log('[Payment Return] Detected payment success, syncing status...');
      // Show loading indicator
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.innerHTML = '<i class="fas fa-sync fa-spin mr-2"></i>Verifying payment status...';
      document.body.appendChild(toast);

      // Poll for status update (webhooks can't reach localhost)
      let pollCount = 0;
      const maxPolls = 10;
      const pollInterval = setInterval(async () => {
        pollCount++;
        try {
          const res = await fetch('/api/custom-orders/my-custom-orders', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'ngrok-skip-browser-warning': 'true'
            }
          });
          const data = await res.json();
          if (data.success && data.data) {
            // Find the order by reference (last 8 chars of _id)
            const order = data.data.find(o => {
              const orderId = (o._id || '').toString();
              const last8 = orderId.slice(-8).toUpperCase();
              return last8 === orderRef.toUpperCase();
            });
            if (order) {
              // Call sync endpoint to force payment status check from PayMongo
              const syncRes = await fetch(`/api/payments/sync/${order._id}`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'ngrok-skip-browser-warning': 'true'
                }
              });
              const syncData = await syncRes.json();

              if (syncData.success && (syncData.data.status === 'In Production' || syncData.data.status === 'Pending Final Verification')) {
                // Payment processed!
                clearInterval(pollInterval);
                toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                toast.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Payment verified successfully!';
                setTimeout(() => {
                  toast.remove();
                  // Clear URL params and reload
                  window.history.replaceState({}, document.title, window.location.pathname);
                  fetchMine();
                }, 2000);
                return;
              }
            }
          }
        } catch (err) {
          console.error('[Payment Polling] Error:', err);
        }

        if (pollCount >= maxPolls) {
          clearInterval(pollInterval);
          toast.className = 'fixed top-4 right-4 bg-yellow-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.innerHTML = '<i class="fas fa-clock mr-2"></i>Payment processing... Please refresh in a moment.';
          setTimeout(() => {
            toast.remove();
            window.history.replaceState({}, document.title, window.location.pathname);
          }, 3000);
        }
      }, 2000); // Poll every 2 seconds
    }

    async function setFulfillment(id, method, address) {
      const res = await fetch(`/api/custom-orders/${id}/fulfillment`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'ngrok-skip-browser-warning': 'true' },
        body: JSON.stringify({ fulfillmentMethod: method, deliveryAddress: address || undefined })
      });
      const json = await res.json();
      if (!json.success) { alert(json.msg || 'Failed to set fulfillment'); return; }
      alert('Fulfillment set. We will provide details soon.');
      fetchMine();
    }

    async function confirmReceipt(orderId) {
      if (!confirm('Have you received your order? This will mark the order as completed.')) {
        return;
      }

      try {
        const res = await fetch(`/api/custom-orders/${orderId}/confirm-receipt`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });

        const json = await res.json();

        if (!json.success) {
          alert(json.msg || 'Failed to confirm receipt');
          return;
        }

        alert('Thank you! Your order has been marked as completed.');
        fetchMine(); // Refresh the list
      } catch (err) {
        console.error('Error confirming receipt:', err);
        alert('An error occurred. Please try again.');
      }
    }

    async function requestRefund(orderId) {
      const reason = prompt('Please enter a short reason for the refund request (e.g. Wrong size, Damaged item):');
      if (!reason || !reason.trim()) { alert('Refund reason is required'); return; }
      const details = prompt('Optional: add more details (press Cancel to skip)') || '';

      try {
        const fd = new FormData();
        fd.append('reason', reason);
        if (details) fd.append('details', details);

        const res = await fetch(`/api/custom-orders/${orderId}/returns`, {
          method: 'POST',
          headers: { 'ngrok-skip-browser-warning': 'true' },
          body: fd
        });

        const json = await res.json();
        if (!json.success) { alert(json.msg || 'Failed to submit refund request'); return; }
        alert('Refund request submitted. Our team will review and contact you.');
        fetchMine();
      } catch (err) {
        console.error('Refund request error:', err);
        alert('An error occurred. Please try again.');
      }
    }

    async function cancelQuote(orderId) {
      if (!confirm('Are you sure you want to cancel this quote? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`/api/custom-orders/${orderId}/cancel`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });

        const json = await res.json();

        if (!json.success) {
          alert(json.msg || 'Failed to cancel quote');
          return;
        }

        alert('Quote cancelled successfully.');
        fetchMine();
      } catch (err) {
        console.error('Cancel quote error:', err);
        alert('An error occurred. Please try again.');
      }
    }

    async function openDetailsModal(order) {
      const modal = document.getElementById('detailsModal');
      const content = document.getElementById('modalContent');

      const orderRef = order._id.toString().slice(-8).toUpperCase();
      const statusBadge = `<span class="px-3 py-1 rounded-full text-sm font-medium ${badgeClass(order.status)}">${order.status}</span>`;
      const serviceType = order.serviceType || 'customize-jersey';
      const serviceLabel = serviceType === 'printing-only' ? 'Printing Only' : (serviceType === 'layout-creation' ? 'Layout Creation' : 'Customize Apparel');
      const methodMap = { 'dye-sublimation': 'Dye-Sublimation', 'heat-transfer': 'Heat Transfer', 'vinyl-print': 'Vinyl Print' };
      const printingMethod = methodMap[order.printingMethod] || order.printingMethod || '';

      // Prepare team entries (from saved array or uploaded .txt/.csv)
      let parsedTeam = Array.isArray(order.teamMembers) ? order.teamMembers : [];
      if ((!parsedTeam || parsedTeam.length === 0) && order.teamNamesFileUrl) {
        try {
          const res = await fetch(order.teamNamesFileUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } });
          const text = await res.text();
          parsedTeam = text.split(/\r?\n/).filter(Boolean).map(ln => {
            const parts = ln.split(/[,|\t]/);
            return { name: (parts[0] || '').trim(), jerseyNumber: (parts[1] || '').trim(), size: (parts[2] || '').trim() };
          });
        } catch (e) { /* ignore */ }
      }

      const hasTeam = !!(order.includeTeamMembers && parsedTeam && parsedTeam.length);
      const maxTeamVisible = 12;
      const teamRowsHtml = (parsedTeam || []).map(m => `<tr><td class="border px-2 py-1">${(m.name || '')}</td><td class="border px-2 py-1">${(m.jerseyNumber || m.number || '')}</td><td class="border px-2 py-1">${(m.size || '')}</td></tr>`).join('');
      const teamBodyId = `team-tbody-${order._id}`;
      const teamToggleId = `team-toggle-${order._id}`;

      let html = `
        <div class="space-y-6">
          <!-- Header -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold text-gray-900">Quote #${orderRef}</h3>
              ${statusBadge}
            </div>
            <p class="text-sm text-gray-500">Updated: ${new Date(order.updatedAt).toLocaleString()}</p>
          </div>

          <!-- Product Info -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="font-semibold text-gray-900 mb-3">Product Information</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-500">Product:</span>
                <p class="font-medium">${order.product || order.productName || 'N/A'}</p>
              </div>
              <div>
                <span class="text-gray-500">Item:</span>
                <p class="font-medium">${order.item || order.itemType || order.garmentType || 'N/A'}</p>
              </div>
              <div>
                <span class="text-gray-500">Quantity:</span>
                <p class="font-medium">${order.quantity || 0}</p>
              </div>
              <div>
                <span class="text-gray-500">Price:</span>
                <p class="font-medium">${order.price ? `â‚±${order.price.toLocaleString()} (â‚±${(order.price).toLocaleString()} each)` : 'Pending'}</p>
              </div>
            </div>
          </div>

          <!-- Service Details -->
          <div class="bg-white rounded-lg p-4 border">
            <h4 class="font-semibold text-gray-900 mb-3">Service Details</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <div><span class="text-gray-500">Services:</span> <span class="font-medium">${serviceLabel}</span></div>
              ${printingMethod ? `<div><span class="text-gray-500">Print Type:</span> <span class="font-medium">${printingMethod}</span></div>` : ''}
              ${order.fabricType ? `<div><span class="text-gray-500">Fabric:</span> <span class="font-medium">${order.fabricType}</span></div>` : ''}
              ${order.garmentType ? `<div><span class="text-gray-500">Garment:</span> <span class="font-medium">${order.garmentType}</span></div>` : ''}
              ${!hasTeam && order.garmentSize ? `<div><span class="text-gray-500">Size:</span> <span class="font-medium">${order.garmentSize}</span></div>` : ''}
            </div>
          </div>

          <!-- Product Preview Images (Multiple Views) -->
          ${order.designImagesMap && Object.keys(order.designImagesMap).length > 0 ? `
          <div>
            <h4 class="font-semibold text-gray-900 mb-3">Product Preview (Multiple Views)</h4>
            <div class="grid grid-cols-2 gap-3">
              ${Object.entries(order.designImagesMap).map(([location, imgPath]) => `
                <div class="border rounded-lg overflow-hidden bg-white">
                  <img src="${imgPath}" alt="${location}" class="w-full h-48 object-contain bg-gray-50">
                  <div class="px-2 py-1 bg-gray-100 text-xs text-center font-medium capitalize">${location}</div>
                </div>
              `).join('')}
            </div>
          </div>
          ` : order.designImage ? `
          <div>
            <h4 class="font-semibold text-gray-900 mb-3">Design/Product Image</h4>
            <div class="border rounded-lg overflow-hidden">
              <img src="${order.designImage}" alt="Design" class="w-full h-auto max-h-96 object-contain bg-gray-100">
            </div>
          </div>
          ` : ''}

          <!-- Uploaded Design File (non-image) -->
          ${order.designFileUrl ? `
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Design File</h4>
            <a href="${order.designFileUrl}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 border rounded hover:bg-gray-50 text-sm">
              <i class="fas fa-file-download text-indigo-600"></i> View/Download Design File
            </a>
          </div>
          ` : ''}

          <!-- Team Entries -->
          ${hasTeam ? `
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <h4 class="font-semibold text-blue-900 mb-2">Team Entries</h4>
            <div class="overflow-x-auto">
              <table class="min-w-full text-xs border bg-white">
                <thead class="bg-blue-100">
                  <tr><th class="border px-2 py-1 text-left">Name</th><th class="border px-2 py-1 text-left">Number</th><th class="border px-2 py-1 text-left">Size</th></tr>
                </thead>
                <tbody id="${teamBodyId}"></tbody>
              </table>
            </div>
            ${(parsedTeam || []).length > maxTeamVisible ? `<button id="${teamToggleId}" class="mt-2 px-3 py-1 text-xs border rounded hover:bg-gray-50">Show all (${parsedTeam.length})</button>` : ''}
            ${order.teamNamesFileUrl ? `<div class="mt-2"><a href="${order.teamNamesFileUrl}" target="_blank" class="text-xs text-blue-700 hover:underline">Download original list</a></div>` : ''}
          </div>
          ` : ''}

          <!-- Additional Info -->
          ${order.additionalInfo ? `
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Additional Information</h4>
            <p class="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 rounded p-3">${order.additionalInfo}</p>
          </div>
          ` : ''}

          <!-- Pricing Breakdown -->
          ${order.autoPricingBreakdown ? `
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Pricing Breakdown</h4>
            <pre class="text-xs bg-gray-50 rounded p-3 whitespace-pre-wrap border">${typeof order.autoPricingBreakdown === 'string' ? order.autoPricingBreakdown : JSON.stringify(order.autoPricingBreakdown, null, 2)}</pre>
          </div>
          ` : ''}

          <!-- Payment Info -->
          ${order.paymentAmount || order.paymentMethod ? `
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <h4 class="font-semibold text-blue-900 mb-3">Payment Information</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              ${order.paymentMethod ? `
              <div>
                <span class="text-blue-700">Payment Method:</span>
                <p class="font-medium text-blue-900">${order.paymentMethod}</p>
              </div>
              ` : ''}
              ${order.paymentAmount ? `
              <div>
                <span class="text-blue-700">Amount Paid:</span>
                <p class="font-medium text-blue-900">â‚±${order.paymentAmount.toLocaleString()}</p>
              </div>
              ` : ''}
              ${order.downPaymentPaid ? '<div class="col-span-2"><span class="inline-flex items-center gap-1 text-green-700"><i class="fas fa-check-circle"></i> Down Payment Confirmed</span></div>' : ''}
              ${order.balancePaid ? '<div class="col-span-2"><span class="inline-flex items-center gap-1 text-green-700"><i class="fas fa-check-circle"></i> Final Payment Confirmed</span></div>' : ''}
            </div>
          </div>
          ` : ''}

          <!-- Fulfillment Info (show only when fulfillment is relevant) -->
          ${(['Ready for Pickup/Delivery', 'Out for Delivery', 'Completed'].includes(order.status)) ? `
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <h4 class="font-semibold text-green-900 mb-3">Fulfillment Information</h4>
            <div class="text-sm space-y-2">
              <div>
                <span class="text-green-700">Method:</span>
                <p class="font-medium text-green-900">${order.fulfillmentMethod === 'pickup' ? 'Pickup' : 'Delivery'}</p>
              </div>
              ${order.fulfillmentMethod === 'delivery' && (order.deliveryAddress || order.shippingAddress || (order.quotePayload && order.quotePayload.shippingAddress)) ? `
              <div>
                <span class="text-green-700">Delivery Address:</span>
                <p class="font-medium text-green-900">${getDisplayAddress(order)}</p>
              </div>
              ` : ''}
              ${order.trackingNumber ? `
              <div>
                <span class="text-green-700">Tracking Number:</span>
                <p class="font-medium text-green-900">${order.trackingNumber}</p>
              </div>
              ` : ''}
            </div>
          </div>
          ` : ''}

          <!-- Completion Info -->
          ${order.completedAt ? `
          <div class="bg-green-50 rounded-lg p-4 border border-green-200 text-center">
            <i class="fas fa-check-circle text-green-600 text-3xl mb-2"></i>
            <p class="font-semibold text-green-900">Order Completed</p>
            <p class="text-sm text-green-700">${new Date(order.completedAt).toLocaleString()}</p>
          </div>
          ` : ''}

          <!-- Cancellation Info -->
          ${order.status === 'Cancelled' ? `
          <div class="bg-red-50 rounded-lg p-4 border border-red-200 text-center">
            <i class="fas fa-times-circle text-red-600 text-3xl mb-2"></i>
            <p class="font-semibold text-red-900">Order Cancelled</p>
            ${order.cancelledAt ? `<p class="text-sm text-red-700">${new Date(order.cancelledAt).toLocaleString()}</p>` : ''}
          </div>
          ` : ''}
        </div>
      `;

      content.innerHTML = html;
      // Populate team rows with limited view and toggle
      if (hasTeam) {
        const tbody = document.getElementById(teamBodyId);
        if (tbody) {
          const rowsAll = teamRowsHtml;
          const limited = rowsAll.split('</tr>').slice(0, maxTeamVisible).join('</tr>');
          tbody.innerHTML = (parsedTeam.length > maxTeamVisible) ? limited : rowsAll;
          const toggleBtn = document.getElementById(teamToggleId);
          if (toggleBtn) {
            let expanded = false;
            toggleBtn.onclick = () => {
              expanded = !expanded;
              tbody.innerHTML = expanded ? rowsAll : limited;
              toggleBtn.textContent = expanded ? 'Show less' : `Show all (${parsedTeam.length})`;
            };
          }
        }
      }
      modal.classList.remove('hidden');
    }

    function closeDetailsModal() {
      const modal = document.getElementById('detailsModal');
      modal.classList.add('hidden');
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('detailsModal');
      if (e.target === modal) {
        closeDetailsModal();
      }
    });
  </script>
  <script src="js/idle-timeout.js"></script>
</body>

</html>