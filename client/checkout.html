<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .field-disabled { background-color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-gray-800"><a href="index.html">Fundamental</a></div>
      <div class="flex items-center space-x-5">
        <a href="index.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-home"></i> <span class="hidden sm:inline">Home</span></a>
        <a href="cart.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-shopping-cart"></i></a>
        
        <div id="auth-links-logged-out" class="hidden items-center space-x-3">
            <a href="login.html" class="text-sm font-medium text-gray-700 hover:text-indigo-600">Log In</a>
            <a href="register.html" class="text-sm font-medium bg-indigo-600 text-white px-3 py-1.5 rounded-md hover:bg-indigo-700">Register</a>
        </div>

        <div id="auth-links-logged-in">
            <a href="profile.html" id="user-link" class="text-gray-600 hover:text-indigo-600">
                <i id="user-icon" class="fas fa-user-circle text-2xl"></i>
            </a>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Checkout</h1>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <div class="lg:col-span-7 space-y-6">
        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
          <div id="order-summary" class="divide-y">
            <p class="text-gray-500">Loading items...</p>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-semibold">Shipping Address</h2>
          </div>
          <div class="flex items-center gap-6 mb-4">
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="addr_mode" id="addr-default" class="h-4 w-4" checked> Use Default Address</label>
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="addr_mode" id="addr-new" class="h-4 w-4"> Enter New Address</label>
          </div>
          <form id="shipping-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-700">Block</label>
              <input id="ship-block" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Blk 13">
            </div>
            <div>
              <label class="block text-sm text-gray-700">Lot</label>
              <input id="ship-lot" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Lot 41">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">Street</label>
              <input id="ship-street" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Magdalo St.">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">Building / Address</label>
              <input id="ship-building" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="De La Salle University - Dasmariñas">
            </div>
            <div>
              <label class="block text-sm text-gray-700">State/Province</label>
              <input id="ship-province" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Cavite">
            </div>
            <div>
              <label class="block text-sm text-gray-700">City</label>
              <input id="ship-city" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Dasmariñas">
            </div>
            <div>
              <label class="block text-sm text-gray-700">Zip/Postal Code</label>
              <input id="ship-zip" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="4103">
            </div>
            <div>
              <label class="block text-sm text-gray-700">Phone</label>
              <input id="ship-phone" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="+63 912 345 6789">
            </div>
          </form>
        </section>

        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Shipping Method</h2>
          <div class="space-y-3">
            <label class="flex items-center justify-between border rounded-md p-4 cursor-pointer">
              <div class="flex items-center gap-3">
                <input id="method-standard" type="radio" name="shipping_method" class="h-4 w-4" checked>
                <div>
                  <p class="font-medium">Standard Shipping</p>
                  <p class="text-sm text-gray-500">3-5 days via J&T / Lalamove</p>
                </div>
              </div>
              <div class="font-semibold">₱<span id="fee-standard">80</span></div>
            </label>
            <label class="flex items-center justify-between border rounded-md p-4 cursor-pointer">
              <div class="flex items-center gap-3">
                <input id="method-pickup" type="radio" name="shipping_method" class="h-4 w-4">
                <div>
                  <p class="font-medium">Pick-Up</p>
                  <p class="text-sm text-gray-500">Pick-up at store</p>
                </div>
              </div>
              <div class="font-semibold">₱<span id="fee-pickup">0</span></div>
            </label>
          </div>
        </section>
      </div>

      <aside class="lg:col-span-5 space-y-6">
        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Payment Method</h2>
          <div class="space-y-3">
            <label class="flex items-center gap-3">
              <input type="radio" name="payment_method" id="pay-gcash" class="h-4 w-4" checked>
              <span class="font-medium">GCash</span>
            </label>
            <label class="flex items-center gap-3">
              <input type="radio" name="payment_method" id="pay-bank" class="h-4 w-4">
              <span class="font-medium">Bank Transfer</span>
            </label>
            <div class="pt-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Upload Receipt</label>
              <input id="receipt" type="file" accept="image/png,image/jpeg,image/jpg,image/webp" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
              <p class="text-xs text-gray-500 mt-1">Accepted: PNG, JPG, JPEG, WEBP up to 5MB.</p>
            </div>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Billing Summary</h2>
          <div class="space-y-3">
            <div class="flex justify-between text-gray-600">
              <span>Subtotal</span>
              <span>₱<span id="subtotal">0</span></span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Discount</span>
              <span class="text-red-600">-₱<span id="discount">0</span></span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Delivery Fee</span>
              <span>₱<span id="delivery-fee">80</span></span>
            </div>
            <hr>
            <div class="flex justify-between text-lg font-semibold">
              <span>Total</span>
              <span>₱<span id="grand-total">0</span></span>
            </div>
            <div>
              <label class="block text-sm text-gray-700">Order Comment</label>
              <textarea id="order-comment" class="mt-1 w-full border rounded-md px-3 py-2" rows="3" placeholder="Type here..."></textarea>
            </div>
            <label class="flex items-start gap-2 text-sm text-gray-700">
              <input id="agree" type="checkbox" class="mt-1"> <span>Please check to acknowledge our Privacy & Terms Policy</span>
            </label>
            <button id="place-order" class="w-full bg-black text-white font-semibold py-3 rounded-md disabled:opacity-50">Submit Order with Receipt</button>
            <p id="error-message" class="text-red-600 text-sm"></p>
            <p id="success-message" class="text-green-600 text-sm"></p>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:5000';
    function peso(n){ return '₱' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    let itemIdsToCheckout = null;
    let savedDefaultAddress = null;
    let savedUserPhone = '';

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      
      // NEW: Auth Links (Kahit alam na nating logged in, para lang consistent)
      const authLoggedOut = document.getElementById('auth-links-logged-out');
      const authLoggedIn = document.getElementById('auth-links-logged-in');
      if (authLoggedOut) authLoggedOut.classList.add('hidden');
      if (authLoggedIn) authLoggedIn.classList.remove('hidden');
      // --- End NEW ---
      
      const orderSummary = document.getElementById('order-summary');
      const subtotalEl = document.getElementById('subtotal');
      const deliveryFeeEl = document.getElementById('delivery-fee');
      // ... (ang iba pang const selectors mo ay pareho pa rin) ...
      const grandTotalEl = document.getElementById('grand-total');
      const placeOrderBtn = document.getElementById('place-order');
      const receiptInput = document.getElementById('receipt');
      const agreeCheckbox = document.getElementById('agree');
      const orderComment = document.getElementById('order-comment');
      const radioDefault = document.getElementById('addr-default');
      const radioNew = document.getElementById('addr-new');
      const shippingFormInputs = document.querySelectorAll('#shipping-form input');


      if (!token) {
        alert('Please log in to continue checkout.');
        window.location.href = 'login.html';
        return;
      }
      
      // ... (ang lahat ng natitirang JS functions ay pareho pa rin) ...
      function toggleFormInputs(disabled) {
          shippingFormInputs.forEach(input => {
              input.disabled = disabled;
              input.classList.remove('field-disabled'); 
          });
      }
      function populateAddressForm(address, phone) {
          document.getElementById('ship-street').value = address?.street || '';
          document.getElementById('ship-city').value = address?.city || '';
          document.getElementById('ship-province').value = address?.province || '';
          document.getElementById('ship-zip').value = address?.zipCode || ''; 
          document.getElementById('ship-phone').value = phone || '';
          if (!address) { 
            document.getElementById('ship-block').value = '';
            document.getElementById('ship-lot').value = '';
            document.getElementById('ship-building').value = '';
          }
      }
      async function fetchProfileAndSetDefaults() {
          try {
              const res = await fetch(`${API_BASE}/api/auth/me`, {
                  headers: { 'Authorization': `Bearer ${token}` }
              });
              const json = await res.json();
              if (json.success) {
                  const user = json.data;
                  savedUserPhone = user.contactNumber || '';
                  if (user.shippingAddresses && user.shippingAddresses.length > 0) {
                      savedDefaultAddress = user.shippingAddresses.find(addr => addr.isDefault);
                  }
                  populateAddressForm(savedDefaultAddress, savedUserPhone);
                  toggleFormInputs(false); 
              }
          } catch (err) {
              console.error('Failed to fetch user profile for address:', err);
              toggleFormInputs(false);
          }
      }
      async function fetchCart() {
        orderSummary.innerHTML = '<p class="text-gray-500">Loading items...</p>';
        const selectedIdsJSON = localStorage.getItem('checkoutItemIds');
        let fetchUrl = `${API_BASE}/api/cart`;
        let fetchOptions = {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        };
        if (selectedIdsJSON) {
            console.log('Selective checkout detected.');
            itemIdsToCheckout = JSON.parse(selectedIdsJSON);
            localStorage.removeItem('checkoutItemIds'); 
            fetchUrl = `${API_BASE}/api/cart/preview`;
            fetchOptions = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ itemIds: itemIdsToCheckout })
            };
        }
        try {
          const res = await fetch(fetchUrl, fetchOptions);
          if (!res.ok) {
            orderSummary.innerHTML = '<p class="text-red-500">Could not load cart.</p>';
            placeOrderBtn.disabled = true;
            return;
          }
          const json = await res.json();
          if (!json.success) {
            orderSummary.innerHTML = `<p class="text-red-500">${json.msg || 'Could not load cart.'}</p>`;
            placeOrderBtn.disabled = true;
            return;
          }
          const cart = json.data;
          if (!cart || !cart.items || cart.items.length === 0) {
            orderSummary.innerHTML = '<p class="text-gray-500">Your cart is empty.</p>';
            placeOrderBtn.disabled = true;
            updateTotals(0);
            return;
          }
          const itemsHtml = cart.items.map(it => {
            const p = it.product || {};
            const qty = it.quantity || 0;
            const price = it.price ?? p.price ?? 0;
            return `<div class="flex items-center gap-4 py-3 border-b">
                      <img src="${p.imageUrl || 'https://placehold.co/80x80'}" class="w-16 h-16 object-cover rounded" alt="${p.name}">
                      <div class="flex-1">
                        <div class="font-medium">${p.name || 'Item'}</div>
                        <div class="text-sm text-gray-500">Qty: ${qty} · ${peso(price)}</div>
                      </div>
                      <div class="font-semibold">${peso(price * qty)}</div>
                    </div>`;
          }).join('');
          orderSummary.innerHTML = itemsHtml;
          const subtotal = cart.items.reduce((s, it) => {
            const price = it.price ?? it.product?.price ?? 0;
            return s + (price * (it.quantity || 0));
          }, 0);
          updateTotals(subtotal);
          placeOrderBtn.disabled = false;
        } catch (err) {
          console.error('fetchCart error', err);
          orderSummary.innerHTML = `<p class="text-red-500">Failed to load cart.</p>`;
          placeOrderBtn.disabled = true;
        }
      }
      function updateTotals(subtotal) {
        subtotalEl.textContent = subtotal.toLocaleString();
        deliveryFeeEl.textContent = Number(deliveryFeeEl.textContent.replace(/,/g, '') || 0).toLocaleString();
        grandTotalEl.textContent = Number(subtotal + (Number(deliveryFeeEl.textContent.replace(/,/g, '') || 0))).toLocaleString();
      }
      async function submitOrder() {
        placeOrderBtn.disabled = true;
        placeOrderBtn.textContent = 'Submitting...';
        if (!agreeCheckbox.checked) {
          alert('Please acknowledge the Privacy & Terms Policy.');
          placeOrderBtn.disabled = false;
          placeOrderBtn.textContent = 'Submit Order with Receipt';
          return;
        }
        const shippingAddress = {
          block: document.getElementById('ship-block')?.value || '',
          lot: document.getElementById('ship-lot')?.value || '',
          street: document.getElementById('ship-street')?.value || '',
          building: document.getElementById('ship-building')?.value || '',
          province: document.getElementById('ship-province')?.value || '',
          city: document.getElementById('ship-city')?.value || '',
          zip: document.getElementById('ship-zip')?.value || '',
          phone: document.getElementById('ship-phone')?.value || ''
        };
        const required = ['street','province','city','zip','phone'];
        for (const k of required) {
          if (!shippingAddress[k]) {
            alert(`Please fill ${k} in shipping address.`);
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = 'Submit Order with Receipt';
            return;
          }
        }
        const shippingMethod = document.getElementById('method-pickup')?.checked ? 'Pick-Up' : 'Standard';
        const paymentMethod = document.getElementById('pay-bank')?.checked ? 'BankTransfer' : 'GCash';
        const deliveryFee = Number(document.getElementById('delivery-fee')?.textContent.replace(/ ,/g, '') || 0);
        const comment = orderComment.value || '';
        try {
          const file = receiptInput.files[0];
          if (file) {
            const fd = new FormData();
            fd.append('receipt', file);
            fd.append('shippingAddress', JSON.stringify(shippingAddress));
            fd.append('shippingMethod', shippingMethod);
            fd.append('paymentMethod', paymentMethod);
            fd.append('deliveryFee', String(deliveryFee));
            fd.append('comment', comment);
            if(itemIdsToCheckout) {
                fd.append('itemIds', JSON.stringify(itemIdsToCheckout));
            }
            const res = await fetch(`${API_BASE}/api/orders/upload-receipt`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` },
              body: fd
            });
            const json = await res.json();
            if (json.success) {
              window.location.href = `order-confirmation.html?id=${json.data._id}`;
              return;
            } else {
              throw new Error(json.msg || 'Order failed');
            }
          } else {
            const payload = {
              shippingAddress,
              shippingMethod,
              paymentMethod,
              deliveryFee,
              comment
            };
            if (itemIdsToCheckout) {
                payload.itemIds = itemIdsToCheckout;
            }
            const res = await fetch(`${API_BASE}/api/orders`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (json.success) {
              window.location.href = `order-confirmation.html?id=${json.data._id}`;
              return;
            } else {
              throw new Error(json.msg || 'Order failed');
            }
          }
        } catch (err) {
          console.error('submitOrder error', err);
          alert(err.message || 'Failed to place order.');
        } finally {
          placeOrderBtn.disabled = false;
          placeOrderBtn.textContent = 'Submit Order with Receipt';
        }
      }
      const methodStandard = document.getElementById('method-standard');
      const methodPickup = document.getElementById('method-pickup');
      const feeStandard = 80;
      const feePickup = 0;
      function updateShippingFee() {
          const fee = methodPickup.checked ? feePickup : feeStandard;
          deliveryFeeEl.textContent = fee.toLocaleString();
          const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
          const discount = Number(document.getElementById('discount').textContent.replace(/,/g, ''));
          grandTotalEl.textContent = (subtotal - discount + fee).toLocaleString();
      }
      methodStandard?.addEventListener('change', updateShippingFee);
      methodPickup?.addEventListener('change', updateShippingFee);
      placeOrderBtn.addEventListener('click', (e) => {
        e.preventDefault();
        submitOrder();
      });
      radioDefault.addEventListener('change', () => {
          populateAddressForm(savedDefaultAddress, savedUserPhone);
          toggleFormInputs(false);
      });
      radioNew.addEventListener('change', () => {
          populateAddressForm(null, '');
          toggleFormInputs(false);
      });
      fetchCart();
      fetchProfileAndSetDefaults();
    });
  </script>
</body>
</html>