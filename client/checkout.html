<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .field-disabled { background-color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-gray-800"><a href="index.html">Fundamental</a></div>
      <div class="flex items-center space-x-5">
        <a href="index.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-home"></i> <span class="hidden sm:inline">Home</span></a>
        <a href="cart.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-shopping-cart"></i></a>
        
        <div id="auth-links-logged-out" class="hidden items-center space-x-3">
            <a href="login.html" class="text-sm font-medium text-gray-700 hover:text-indigo-600">Log In</a>
            <a href="register.html" class="text-sm font-medium bg-indigo-600 text-white px-3 py-1.5 rounded-md hover:bg-indigo-700">Register</a>
        </div>

        <div id="auth-links-logged-in">
            <a href="profile.html" id="user-link" class="text-gray-600 hover:text-indigo-600">
                <i id="user-icon" class="fas fa-user-circle text-2xl"></i>
            </a>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Checkout</h1>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <div class="lg:col-span-7 space-y-6">
        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
          <div id="order-summary" class="divide-y">
            <p class="text-gray-500">Loading items...</p>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-semibold">Shipping Address</h2>
          </div>
          <div class="flex items-center gap-6 mb-4">
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="addr_mode" id="addr-default" class="h-4 w-4" checked> Use Default Address</label>
            <label class="flex items-center gap-2 text-sm"><input type="radio" name="addr_mode" id="addr-new" class="h-4 w-4"> Enter New Address</label>
          </div>
          <form id="shipping-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-700">Block</label>
              <input id="ship-block" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Blk 13">
            </div>
            <div>
              <label class="block text-sm text-gray-700">Lot</label>
              <input id="ship-lot" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Lot 41">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">Street</label>
              <input id="ship-street" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Magdalo St.">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-700">Building / Address</label>
              <input id="ship-building" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="De La Salle University - Dasmariñas">
            </div>
            <div>
              <label class="block text-sm text-gray-700">State/Province</label>
              <select id="ship-province" class="mt-1 w-full border rounded-md px-3 py-2">
                <option value="">Select province</option>
                <option>Metro Manila</option>
                <option>Manila</option>
                <option>Quezon City</option>
                <option>Makati</option>
                <option>Cavite</option>
                <option>Laguna</option>
                <option>Batangas</option>
                <option>Bulacan</option>
                <option>Pampanga</option>
                <option>Rizal</option>
                <option>Quezon</option>
                <option>Nueva Ecija</option>
                <option>Tarlac</option>
                <option>Zambales</option>
                <option>Bataan</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-700">City</label>
              <input id="ship-city" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Dasmariñas">
            </div>
            <div>
              <label class="block text-sm text-gray-700">Zip/Postal Code</label>
              <input id="ship-zip" type="text" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="4103">
            </div>
            <div>
              <label class="block text-sm text-gray-700">Phone <span class="text-red-500">*</span></label>
              <div class="flex mt-1">
                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-100 text-gray-600 text-sm">+63</span>
                <input id="ship-phone" type="tel" class="w-full border rounded-r-md px-3 py-2" placeholder="9XX XXX XXXX" maxlength="12" pattern="[0-9\s]{10,12}">
              </div>
              <p id="phone-error" class="text-red-500 text-xs mt-1 hidden">Phone number must start with 9 and be 10 digits</p>
            </div>
          </form>
        </section>

        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Shipping Method</h2>
          <div class="space-y-3">
            <label class="flex items-center justify-between border rounded-md p-4 cursor-pointer" id="shipping-standard-label">
              <div class="flex items-center gap-3">
                <input id="method-standard" type="radio" name="shipping_method" class="h-4 w-4" checked>
                <div>
                  <p class="font-medium">Standard Shipping</p>
                  <p class="text-sm text-gray-500" id="shipping-desc">3-5 days via J&T / Lalamove</p>
                </div>
              </div>
              <div class="font-semibold">
                <span id="shipping-loader" class="hidden"><i class="fas fa-spinner fa-spin text-blue-500"></i></span>
                <span id="shipping-fee-display">₱<span id="fee-standard">80</span></span>
              </div>
            </label>
            <!-- Distance info display -->
            <div id="distance-info" class="hidden text-xs text-gray-500 ml-4 -mt-2">
              <i class="fas fa-map-marker-alt mr-1"></i>
              <span id="distance-text"></span>
            </div>
            <label class="flex items-center justify-between border rounded-md p-4 cursor-pointer">
              <div class="flex items-center gap-3">
                <input id="method-pickup" type="radio" name="shipping_method" class="h-4 w-4">
                <div>
                  <p class="font-medium">Pick-Up</p>
                  <p class="text-sm text-gray-500">Pick-up at store (Anabu Coastal, Imus, Cavite)</p>
                </div>
              </div>
              <div class="font-semibold">₱<span id="fee-pickup">0</span></div>
            </label>
          </div>
        </section>
      </div>

      <aside class="lg:col-span-5 space-y-6">
        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-credit-card mr-2 text-indigo-600"></i>
            Payment Method
          </h2>
          <div class="space-y-4">
            <!-- Payment Method Selection -->
            <div class="space-y-3">
              <label class="flex items-center justify-between border-2 rounded-lg p-4 cursor-pointer transition hover:border-indigo-500" id="gcash-option">
                <div class="flex items-center gap-3">
                  <input type="radio" name="payment_method" id="pay-gcash" class="h-4 w-4 text-indigo-600" checked>
                  <div>
                    <span class="font-semibold text-gray-900">GCash</span>
                    <p class="text-xs text-gray-500">Pay via GCash e-wallet</p>
                  </div>
                </div>
                <img src="https://via.placeholder.com/50x30/007DBA/FFFFFF?text=GC" alt="GCash" class="h-8">
              </label>
              
              <label class="flex items-center justify-between border-2 rounded-lg p-4 cursor-pointer transition hover:border-indigo-500" id="card-option">
                <div class="flex items-center gap-3">
                  <input type="radio" name="payment_method" id="pay-card" class="h-4 w-4 text-indigo-600">
                  <div>
                    <span class="font-semibold text-gray-900">Credit/Debit Card</span>
                    <p class="text-xs text-gray-500">Visa, Mastercard, JCB</p>
                  </div>
                </div>
                <div class="flex gap-1">
                  <img src="https://via.placeholder.com/35x22/1A1F71/FFFFFF?text=V" alt="Visa" class="h-6">
                  <img src="https://via.placeholder.com/35x22/EB001B/FFFFFF?text=MC" alt="Mastercard" class="h-6">
                </div>
              </label>
            </div>

            <!-- Payment Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <div class="flex items-start gap-2">
                <i class="fas fa-shield-alt text-blue-600 text-sm mt-0.5"></i>
                <p class="text-xs text-blue-800">
                  <strong>Secure Payment:</strong> You'll be redirected to PayMongo's secure checkout page to complete your payment.
                </p>
              </div>
            </div>
          </div>
        </section>

        <section class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Billing Summary</h2>
          <div class="space-y-3">
            <div class="flex items-center gap-2 mb-2">
              <input id="voucher-code" type="text" class="border rounded px-3 py-2 w-1/2" placeholder="Enter voucher code">
              <button id="apply-voucher" class="bg-green-600 hover:bg-green-700 text-white font-medium px-3 py-2 rounded">Apply</button>
              <span id="voucher-message" class="text-sm ml-2"></span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Subtotal</span>
              <span>₱<span id="subtotal">0</span></span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Discount</span>
              <span class="text-red-600">-₱<span id="discount">0</span></span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Delivery Fee</span>
              <span>₱<span id="delivery-fee">80</span></span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>VAT (12%)</span>
              <span>₱<span id="vat">0.00</span></span>
            </div>
            <hr>
            <div class="flex justify-between text-lg font-semibold">
              <span>Total</span>
              <span>₱<span id="grand-total">0</span></span>
            </div>
            <div>
              <label class="block text-sm text-gray-700">Order Comment</label>
              <textarea id="order-comment" class="mt-1 w-full border rounded-md px-3 py-2" rows="3" placeholder="Type here..."></textarea>
            </div>
            <label class="flex items-start gap-2 text-sm text-gray-700">
              <input id="agree" type="checkbox" class="mt-1"> <span>Please check to acknowledge our Privacy & Terms Policy</span>
            </label>
            <button id="place-order" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <i class="fas fa-lock"></i>
              <span>Proceed to Secure Payment</span>
            </button>
            <p id="error-message" class="text-red-600 text-sm"></p>
            <p id="success-message" class="text-green-600 text-sm"></p>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <script>
    const API_BASE = 'https://fundamental-apparel-backend.onrender.com';
    function peso(n){ return '₱' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    let itemIdsToCheckout = null;
    let savedDefaultAddress = null;
    let savedUserPhone = '';
    let savedUserEmail = '';
    let savedUserName = '';
    let cartItems = [];

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      
      // NEW: Auth Links (Kahit alam na nating logged in, para lang consistent)
      const authLoggedOut = document.getElementById('auth-links-logged-out');
      const authLoggedIn = document.getElementById('auth-links-logged-in');
      if (authLoggedOut) authLoggedOut.classList.add('hidden');
      if (authLoggedIn) authLoggedIn.classList.remove('hidden');
      // --- End NEW ---
      
      const orderSummary = document.getElementById('order-summary');
      const subtotalEl = document.getElementById('subtotal');
      const deliveryFeeEl = document.getElementById('delivery-fee');
      const grandTotalEl = document.getElementById('grand-total');
      const placeOrderBtn = document.getElementById('place-order');
      const agreeCheckbox = document.getElementById('agree');
      const orderComment = document.getElementById('order-comment');
      const radioDefault = document.getElementById('addr-default');
      const radioNew = document.getElementById('addr-new');
      const shippingFormInputs = document.querySelectorAll('#shipping-form input');
      const phoneInput = document.getElementById('ship-phone');
      const phoneError = document.getElementById('phone-error');

      if (!token) {
        alert('Please log in to continue checkout.');
        window.location.href = 'login.html';
        return;
      }
      
      // Phone number validation and formatting helper
      function formatPhoneNumber(value) {
        // Remove all non-digits
        let digits = value.replace(/\D/g, '');
        // If starts with 63, remove it (we'll add +63 prefix)
        if (digits.startsWith('63')) digits = digits.slice(2);
        // If starts with 0, remove it
        if (digits.startsWith('0')) digits = digits.slice(1);
        // Limit to 10 digits (Philippine mobile without country code)
        digits = digits.slice(0, 10);
        // Format with spaces: XXX XXX XXXX
        if (digits.length > 6) {
          return digits.slice(0, 3) + ' ' + digits.slice(3, 6) + ' ' + digits.slice(6);
        } else if (digits.length > 3) {
          return digits.slice(0, 3) + ' ' + digits.slice(3);
        }
        return digits;
      }

      function validatePhone(phone) {
        // Remove spaces and check if it's 10 digits starting with 9
        const digits = phone.replace(/\D/g, '');
        return digits.length === 10 && /^9\d{9}$/.test(digits);
      }

      function getFullPhoneNumber() {
        const raw = phoneInput.value.replace(/\D/g, '');
        if (!raw) return '';
        return '+63' + raw;
      }

      // Phone input event listeners
      phoneInput.addEventListener('input', (e) => {
        e.target.value = formatPhoneNumber(e.target.value);
        if (e.target.value && !validatePhone(e.target.value)) {
          phoneError.classList.remove('hidden');
          phoneInput.classList.add('border-red-500');
        } else {
          phoneError.classList.add('hidden');
          phoneInput.classList.remove('border-red-500');
        }
      });

      phoneInput.addEventListener('blur', () => {
        if (phoneInput.value && !validatePhone(phoneInput.value)) {
          phoneError.classList.remove('hidden');
          phoneInput.classList.add('border-red-500');
        }
      });

      // ... (ang lahat ng natitirang JS functions ay pareho pa rin) ...
      function toggleFormInputs(disabled) {
          shippingFormInputs.forEach(input => {
              input.disabled = disabled;
              input.classList.remove('field-disabled'); 
          });
          // Also handle select elements
          const selectEls = document.querySelectorAll('#shipping-form select');
          selectEls.forEach(sel => {
              sel.disabled = disabled;
          });
      }
      function populateAddressForm(address, phone) {
          // Populate all address fields including new ones
          document.getElementById('ship-block').value = address?.block || '';
          document.getElementById('ship-lot').value = address?.lot || '';
          document.getElementById('ship-street').value = address?.street || '';
          document.getElementById('ship-building').value = address?.building || '';
          document.getElementById('ship-city').value = address?.city || '';
          document.getElementById('ship-zip').value = address?.zipCode || '';
          
          // Format phone number for the +63 prefix field
          let phoneVal = address?.phone || phone || '';
          // Remove +63 or 63 prefix if present, and leading 0
          phoneVal = phoneVal.replace(/^\+?63/, '').replace(/^0/, '');
          phoneInput.value = formatPhoneNumber(phoneVal);
          phoneError.classList.add('hidden');
          phoneInput.classList.remove('border-red-500');
          
          // ship-province is now a select
          if (address && address.province) {
            const sel = document.getElementById('ship-province');
            // try to match option value containing the province
            const matchOpt = Array.from(sel.options).find(o => o.text.toLowerCase().includes((address.province || '').toLowerCase()));
            if (matchOpt) sel.value = matchOpt.text;
            else sel.value = address.province || 'Other';
          } else {
            document.getElementById('ship-province').value = '';
          }
      }
      async function fetchProfileAndSetDefaults() {
          try {
              const res = await fetch(`${API_BASE}/api/auth/me`, {
                  headers: { 'Authorization': `Bearer ${token}` }
              });
                const json = await res.json();
                if (json.success) {
                  const user = json.data;
                  savedUserPhone = user.contactNumber || '';
                  savedUserEmail = (user.email || '').trim().toLowerCase();
                  savedUserName = user.name || 'Customer';
                  
                  if (user.shippingAddresses && user.shippingAddresses.length > 0) {
                      // Find default address, or use first one
                      savedDefaultAddress = user.shippingAddresses.find(addr => addr.isDefault) || user.shippingAddresses[0];
                      
                      // If we have a saved address, use default address mode
                      if (savedDefaultAddress) {
                          radioDefault.checked = true;
                          populateAddressForm(savedDefaultAddress, savedUserPhone);
                          toggleFormInputs(false);
                      }
                  } else {
                      // No saved addresses - switch to new address mode
                      radioNew.checked = true;
                      populateAddressForm(null, savedUserPhone);
                      toggleFormInputs(false);
                  }
                  
                  if (typeof updateShippingFee === 'function') updateShippingFee();
              }
          } catch (err) {
              console.error('Failed to fetch user profile for address:', err);
              toggleFormInputs(false);
          }
      }
      async function fetchCart() {
        orderSummary.innerHTML = '<p class="text-gray-500">Loading items...</p>';
        const selectedIdsJSON = localStorage.getItem('checkoutItemIds');
        let fetchUrl = `${API_BASE}/api/cart`;
        let fetchOptions = {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        };
        if (selectedIdsJSON) {
            console.log('Selective checkout detected.');
            itemIdsToCheckout = JSON.parse(selectedIdsJSON);
            localStorage.removeItem('checkoutItemIds'); 
            fetchUrl = `${API_BASE}/api/cart/preview`;
            fetchOptions = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ itemIds: itemIdsToCheckout })
            };
        }
        try {
          const res = await fetch(fetchUrl, fetchOptions);
          if (!res.ok) {
            orderSummary.innerHTML = '<p class="text-red-500">Could not load cart.</p>';
            placeOrderBtn.disabled = true;
            return;
          }
          const json = await res.json();
          if (!json.success) {
            orderSummary.innerHTML = `<p class="text-red-500">${json.msg || 'Could not load cart.'}</p>`;
            placeOrderBtn.disabled = true;
            return;
          }
          const cart = json.data;
          if (!cart || !cart.items || cart.items.length === 0) {
            orderSummary.innerHTML = '<p class="text-gray-500">Your cart is empty.</p>';
            placeOrderBtn.disabled = true;
            updateTotals(0);
            return;
          }
          // Normalize items for payment payload (include size when present)
          cartItems = cart.items.map(it => {
            const p = it.product || {};
            const price = it.price ?? p.price ?? 0;
            return {
              productId: p._id || it.productId,
              name: p.name || it.name || 'Product',
              price: price,
              quantity: it.quantity || 1,
              size: it.size || null,
              image: p.imageUrl || it.image || ''
            };
          });
          const itemsHtml = cart.items.map(it => {
            const p = it.product || {};
            const qty = it.quantity || 0;
            const price = it.price ?? p.price ?? 0;
            return `<div class="flex items-center gap-4 py-3 border-b">
                      <img src="${p.imageUrl || 'https://placehold.co/80x80'}" class="w-16 h-16 object-cover rounded" alt="${p.name}">
                      <div class="flex-1">
                        <div class="font-medium">${p.name || 'Item'}</div>
                        <div class="text-sm text-gray-500">Qty: ${qty} · ${peso(price)}</div>
                        ${it.size ? `<div class="text-sm text-gray-500">Size: ${it.size}</div>` : ''}
                      </div>
                      <div class="font-semibold">${peso(price * qty)}</div>
                    </div>`;
          }).join('');
          orderSummary.innerHTML = itemsHtml;
          const subtotal = cart.items.reduce((s, it) => {
            const price = it.price ?? it.product?.price ?? 0;
            return s + (price * (it.quantity || 0));
          }, 0);
          updateTotals(subtotal);
          placeOrderBtn.disabled = false;
        } catch (err) {
          console.error('fetchCart error', err);
          orderSummary.innerHTML = `<p class="text-red-500">Failed to load cart.</p>`;
          placeOrderBtn.disabled = true;
        }
      }
      let appliedVoucher = null;
      function updateTotals(subtotal) {
        // Helpers
        function round2(v){ return Math.round((v + Number.EPSILON) * 100) / 100; }

        subtotalEl.textContent = subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        let discount = 0;
        if (appliedVoucher) {
          if (appliedVoucher.type === 'percentage') {
            discount = Math.floor(subtotal * (appliedVoucher.value / 100));
          } else if (appliedVoucher.type === 'fixed') {
            discount = Math.min(subtotal, appliedVoucher.value);
          } else if (appliedVoucher.type === 'free_shipping') {
            discount = 0;
            deliveryFeeEl.textContent = '0';
          }
        }
        document.getElementById('discount').textContent = discount.toLocaleString();

        // Parse delivery fee robustly (strip currency symbols if any)
        const deliveryFee = Number((deliveryFeeEl.textContent || '').replace(/[^0-9.\-]/g, '')) || 0;

        // VAT applies to subtotal after discounts only (not to delivery)
        const taxable = Math.max(subtotal - discount, 0);
        const vatRate = 0.12; // 12%
        const vatAmount = round2(taxable * vatRate);
        // Update VAT display (ensure two decimals)
        const vatEl = document.getElementById('vat');
        if (vatEl) vatEl.textContent = vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const grand = round2(taxable + deliveryFee + vatAmount);
        // Display grand total with two decimals and currency
        if (grandTotalEl) grandTotalEl.textContent = grand.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
            // Voucher logic
            const voucherInput = document.getElementById('voucher-code');
            const applyVoucherBtn = document.getElementById('apply-voucher');
            const voucherMsg = document.getElementById('voucher-message');
            applyVoucherBtn.addEventListener('click', async () => {
              const code = voucherInput.value.trim();
              if (!code) {
                voucherMsg.textContent = 'Enter a voucher code.';
                voucherMsg.className = 'text-sm text-red-600 ml-2';
                return;
              }
              voucherMsg.textContent = 'Checking...';
              voucherMsg.className = 'text-sm text-gray-600 ml-2';
              try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/api/vouchers/validate?code=${encodeURIComponent(code)}`, {
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.msg || 'Invalid voucher');
                appliedVoucher = json.data;
                voucherMsg.textContent = `Voucher applied: ${appliedVoucher.description}`;
                voucherMsg.className = 'text-sm text-green-600 ml-2';
                // Recompute totals
                const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
                updateTotals(subtotal);
              } catch (err) {
                appliedVoucher = null;
                voucherMsg.textContent = err.message || 'Invalid voucher code.';
                voucherMsg.className = 'text-sm text-red-600 ml-2';
                document.getElementById('discount').textContent = '0';
                const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
                updateTotals(subtotal);
              }
            });
      async function submitOrder() {
        placeOrderBtn.disabled = true;
        const originalBtnHtml = placeOrderBtn.innerHTML;
        placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        if (!agreeCheckbox.checked) {
          alert('Please acknowledge the Privacy & Terms Policy.');
          placeOrderBtn.disabled = false;
          placeOrderBtn.innerHTML = originalBtnHtml;
          return;
        }

        // Validate phone number
        if (!validatePhone(phoneInput.value)) {
          phoneError.classList.remove('hidden');
          phoneInput.classList.add('border-red-500');
          phoneInput.focus();
          alert('Please enter a valid Philippine phone number (e.g., 912 345 6789)');
          placeOrderBtn.disabled = false;
          placeOrderBtn.innerHTML = originalBtnHtml;
          return;
        }
        
        const shippingAddressForm = {
          block: document.getElementById('ship-block')?.value || '',
          lot: document.getElementById('ship-lot')?.value || '',
          street: document.getElementById('ship-street')?.value || '',
          building: document.getElementById('ship-building')?.value || '',
          province: document.getElementById('ship-province')?.value || '',
          city: document.getElementById('ship-city')?.value || '',
          zip: document.getElementById('ship-zip')?.value || '',
          phone: getFullPhoneNumber() // Use full phone with +63 prefix
        };
        
        const required = ['street','province','city','zip','phone'];
        for (const k of required) {
          if (!shippingAddressForm[k]) {
            alert(`Please fill ${k} in shipping address.`);
            placeOrderBtn.disabled = false;
            placeOrderBtn.innerHTML = originalBtnHtml;
            return;
          }
        }
        
        const shippingMethod = document.getElementById('method-pickup')?.checked ? 'Pick-Up' : 'Standard';
        const paymentMethod = document.getElementById('pay-card')?.checked ? 'card' : 'gcash';
        // Robust parse of delivery fee (strip currency symbols if present)
        const deliveryFee = Number((document.getElementById('delivery-fee')?.textContent || '').replace(/[^0-9.\-]/g, '')) || 0;
        const subtotal = Number(subtotalEl.textContent.replace(/,/g, '') || 0);
        const discount = Number(document.getElementById('discount')?.textContent.replace(/,/g, '') || 0);
        // VAT is applied to subtotal after discount only
        function round2(v){ return Math.round((v + Number.EPSILON) * 100) / 100; }
        const taxable = Math.max(subtotal - discount, 0);
        const vatAmount = round2(taxable * 0.12);
        const totalAmount = round2(taxable + deliveryFee + vatAmount);
        const comment = orderComment.value || '';
        
        try {
          // Build a single-line address for API validation
          const addressLine = [
            shippingAddressForm.block,
            shippingAddressForm.lot,
            shippingAddressForm.building,
            shippingAddressForm.street,
            shippingAddressForm.city,
            shippingAddressForm.province,
            shippingAddressForm.zip
          ].filter(Boolean).join(', ');


          // Prepare PayMongo checkout payload
          const payload = {
            orderType: 'product',
            // Amount used by server/PayMongo: integer in cents
            amount: Math.round(totalAmount * 100),
            // Human-readable amount in pesos (for logging/debug)
            amountDisplay: totalAmount,
            vatAmount: vatAmount,
            vatCents: Math.round(vatAmount * 100),
            items: cartItems,
            shippingAddress: {
              fullName: savedUserName || 'Customer',
              address: addressLine,
              province: shippingAddressForm.province,
              city: shippingAddressForm.city,
              zip: shippingAddressForm.zip,
              phone: shippingAddressForm.phone
            },
            shippingMethod: shippingMethod,
            paymentMethod: paymentMethod,
            deliveryFee: deliveryFee,
            deliveryFeeCents: Math.round(deliveryFee * 100),
            comment: comment,
            customerInfo: {
              name: savedUserName || 'Customer',
              email: savedUserEmail || '',
              phone: shippingAddressForm.phone
            },
            successUrl: `${window.location.origin}/client/payment-success.html`,
            cancelUrl: `${window.location.origin}/client/payment-cancel.html`
          };
          if (appliedVoucher && appliedVoucher.code) {
            payload.voucherCode = appliedVoucher.code;
            console.log('[Checkout] Voucher included in payload:', appliedVoucher.code);
          } else {
            console.log('[Checkout] No voucher applied. appliedVoucher:', appliedVoucher);
          }
          if (itemIdsToCheckout) {
            payload.itemIds = itemIdsToCheckout;
          }
          
          // Create PayMongo checkout session
          const res = await fetch(`${API_BASE}/api/payments/create-order`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(payload)
          });
          
          const json = await res.json();
          
          if (!res.ok) {
            throw new Error(json.msg || json.error || 'Failed to create checkout session');
          }
          
          if (json.success && json.data && json.data.checkoutUrl) {
            // Store order reference for success page
            if (json.data.orderId) {
              localStorage.setItem('lastOrderId', json.data.orderId);
            }
            
            // Redirect to PayMongo checkout
            window.location.href = json.data.checkoutUrl;
          } else {
            throw new Error('Invalid response from payment gateway');
          }
          
        } catch (err) {
          console.error('submitOrder error', err);
          alert(err.message || 'Failed to process payment. Please try again.');
          placeOrderBtn.disabled = false;
          placeOrderBtn.innerHTML = originalBtnHtml;
        }
      }
      const methodStandard = document.getElementById('method-standard');
      const methodPickup = document.getElementById('method-pickup');

      // Shipping calculation state
      let currentShippingFee = 80; // Default fallback
      let lastCalculatedAddress = null;
      let isCalculatingShipping = false;
      let shippingCalcDebounceTimer = null;

      /**
       * Show/hide shipping loader
       */
      function showShippingLoader(show) {
        const loader = document.getElementById('shipping-loader');
        const feeDisplay = document.getElementById('shipping-fee-display');
        if (show) {
          loader?.classList.remove('hidden');
          feeDisplay?.classList.add('hidden');
        } else {
          loader?.classList.add('hidden');
          feeDisplay?.classList.remove('hidden');
        }
      }

      /**
       * Update distance info display
       */
      function updateDistanceInfo(distanceKm, duration) {
        const distanceInfo = document.getElementById('distance-info');
        const distanceText = document.getElementById('distance-text');
        if (distanceKm && distanceInfo && distanceText) {
          distanceText.textContent = `${distanceKm} km from store • Est. ${duration || 'N/A'}`;
          distanceInfo.classList.remove('hidden');
        } else if (distanceInfo) {
          distanceInfo.classList.add('hidden');
        }
      }

      /**
       * Calculate shipping fee using OpenRouteService API
       */
      async function calculateDistanceBasedShipping() {
        if (isCalculatingShipping) return;
        
        const isPickup = methodPickup?.checked;
        if (isPickup) {
          currentShippingFee = 0;
          deliveryFeeEl.textContent = '0';
          document.getElementById('fee-standard')?.parentElement?.classList.add('text-gray-400');
          updateDistanceInfo(null);
          const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
          updateTotals(subtotal);
          return;
        }
        
        document.getElementById('fee-standard')?.parentElement?.classList.remove('text-gray-400');
        
        // Get address components
        const addressComponents = {
          block: document.getElementById('ship-block')?.value || '',
          lot: document.getElementById('ship-lot')?.value || '',
          street: document.getElementById('ship-street')?.value || '',
          building: document.getElementById('ship-building')?.value || '',
          city: document.getElementById('ship-city')?.value || '',
          province: document.getElementById('ship-province')?.value || '',
          isPickup: false
        };
        
        // Check if address has minimum required fields for calculation
        const hasMinAddress = addressComponents.city || addressComponents.province;
        if (!hasMinAddress) {
          // Use default estimate based on province dropdown only
          if (window.ShippingCalculator) {
            const estimate = ShippingCalculator.getQuickEstimate(addressComponents.province);
            currentShippingFee = estimate.fee;
          } else {
            currentShippingFee = 80;
          }
          deliveryFeeEl.textContent = currentShippingFee.toLocaleString();
          document.getElementById('fee-standard').textContent = currentShippingFee.toLocaleString();
          updateDistanceInfo(null);
          const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
          updateTotals(subtotal);
          return;
        }
        
        // Create address key for comparison
        const addressKey = JSON.stringify(addressComponents);
        if (addressKey === lastCalculatedAddress) {
          return; // Same address, no recalculation needed
        }
        
        isCalculatingShipping = true;
        showShippingLoader(true);
        
        try {
          if (window.ShippingCalculator) {
            const result = await ShippingCalculator.calculateShippingFee(addressComponents);
            
            currentShippingFee = result.fee;
            lastCalculatedAddress = addressKey;
            
            // Update UI
            deliveryFeeEl.textContent = currentShippingFee.toLocaleString();
            document.getElementById('fee-standard').textContent = currentShippingFee.toLocaleString();
            
            // Show distance info if available
            if (result.distanceKm) {
              updateDistanceInfo(result.distanceKm, result.durationText);
            } else {
              updateDistanceInfo(null);
            }
            
            // Update shipping description based on method
            const shippingDesc = document.getElementById('shipping-desc');
            if (shippingDesc) {
              if (result.method === 'distance-based') {
                shippingDesc.textContent = '3-5 days via Lalamove / J&T';
              } else {
                shippingDesc.textContent = '3-5 days (zone-based estimate)';
              }
            }
          } else {
            // Fallback if calculator not loaded
            currentShippingFee = 80;
            deliveryFeeEl.textContent = '80';
            document.getElementById('fee-standard').textContent = '80';
            updateDistanceInfo(null);
          }
          
          // Update totals
          const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
          updateTotals(subtotal);
          
        } catch (error) {
          console.error('Shipping calculation error:', error);
          // Use fallback rate
          currentShippingFee = 80;
          deliveryFeeEl.textContent = '80';
          document.getElementById('fee-standard').textContent = '80';
          updateDistanceInfo(null);
          const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
          updateTotals(subtotal);
        } finally {
          isCalculatingShipping = false;
          showShippingLoader(false);
        }
      }

      /**
       * Debounced shipping fee update (to prevent excessive API calls)
       */
      function updateShippingFee() {
        // Clear existing timer
        if (shippingCalcDebounceTimer) {
          clearTimeout(shippingCalcDebounceTimer);
        }
        
        // Quick update for pickup
        if (methodPickup?.checked) {
          currentShippingFee = 0;
          deliveryFeeEl.textContent = '0';
          updateDistanceInfo(null);
          const subtotal = Number(subtotalEl.textContent.replace(/,/g, ''));
          updateTotals(subtotal);
          return;
        }
        
        // Debounce the distance calculation (wait 500ms after user stops typing)
        shippingCalcDebounceTimer = setTimeout(() => {
          calculateDistanceBasedShipping();
        }, 500);
      }
      methodStandard?.addEventListener('change', updateShippingFee);
      methodPickup?.addEventListener('change', updateShippingFee);
      document.getElementById('ship-province')?.addEventListener('change', updateShippingFee);
      // Also recalculate shipping when address fields change
      document.getElementById('ship-street')?.addEventListener('blur', updateShippingFee);
      document.getElementById('ship-city')?.addEventListener('blur', updateShippingFee);
      document.getElementById('ship-building')?.addEventListener('blur', updateShippingFee);
      placeOrderBtn.addEventListener('click', (e) => {
        e.preventDefault();
        submitOrder();
      });
      radioDefault.addEventListener('change', () => {
          if (savedDefaultAddress) {
              populateAddressForm(savedDefaultAddress, savedUserPhone);
          } else {
              // No default address saved, switch back to new
              radioNew.checked = true;
              populateAddressForm(null, savedUserPhone);
          }
          toggleFormInputs(false);
          if (typeof updateShippingFee === 'function') updateShippingFee();
      });
      radioNew.addEventListener('change', () => {
          populateAddressForm(null, savedUserPhone);
          toggleFormInputs(false);
          if (typeof updateShippingFee === 'function') updateShippingFee();
      });
      fetchCart();
      fetchProfileAndSetDefaults();
    });
  </script>

  <!-- Shipping Calculator (Distance-based) -->
  <script src="js/shipping-calculator.js"></script>
  <!-- Socket.io Client -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <!-- Chat Widget -->
  <script src="js/chat.js"></script>
  <script src="js/idle-timeout.js"></script>
</body>
</html>