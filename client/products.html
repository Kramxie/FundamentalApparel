<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop All Products - Fundamental Apparel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5; /* Indigo 600 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <header class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3 group">
                <img src="images/logo.png" alt="Fundamental Logo" class="w-10 h-10 object-contain group-hover:opacity-80 transition">
                <span class="text-xl font-extrabold text-gray-900 tracking-tight group-hover:text-indigo-600 transition">Fundamental</span>
            </a>

            <div class="hidden md:flex space-x-8 items-center font-medium text-sm">
                <a href="index.html" class="text-gray-500 hover:text-indigo-600 transition">Home</a>
                <a href="products.html" class="text-indigo-600 font-semibold">Products</a>
                <a href="services.html" class="text-gray-500 hover:text-indigo-600 transition">Services</a>
                <a href="about-us.html" class="text-gray-500 hover:text-indigo-600 transition">About Us</a>
                <a href="faqs.html" class="text-gray-500 hover:text-indigo-600 transition">FAQs</a>
            </div>

            <div class="hidden md:flex items-center space-x-6">
                <a href="cart.html" class="text-gray-400 hover:text-indigo-600 relative transition">
                    <i class="fas fa-shopping-bag text-lg"></i>
                    <span id="cart-count" class="absolute -top-1 -right-2 bg-indigo-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                </a>

                <div id="auth-links-logged-out" class="flex items-center space-x-3 pl-4 border-l border-gray-200">
                    <a href="login.html" class="text-sm font-medium text-gray-600 hover:text-gray-900 transition">Log In</a>
                    <a href="register.html" class="text-sm font-bold bg-gray-900 text-white px-5 py-2.5 rounded-lg hover:bg-black transition shadow-sm transform hover:scale-105 duration-200">Sign Up</a>
                </div>

                <div id="auth-links-logged-in" class="hidden pl-4 border-l border-gray-200">
                    <a href="profile.html" id="user-link" class="text-gray-500 hover:text-indigo-600 transition flex items-center gap-2">
                        <i id="user-icon" class="fas fa-user-circle text-2xl"></i>
                    </a>
                </div>
            </div>

            <div class="md:hidden">
                <button id="menu-btn" class="text-gray-800 focus:outline-none p-2">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>

        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 absolute w-full left-0 top-full shadow-lg z-40">
            <div class="flex flex-col p-4 space-y-3">
                <a href="index.html" class="text-gray-600 font-medium block py-2">Home</a>
                <a href="products.html" class="text-indigo-600 font-semibold block py-2">Products</a>
                <a href="services.html" class="text-gray-600 font-medium block py-2">Services</a>
                <a href="about-us.html" class="text-gray-600 font-medium block py-2">About Us</a>
                <a href="faqs.html" class="text-gray-600 font-medium block py-2">FAQs</a>
                <hr class="border-gray-100">
                <a href="cart.html" class="flex items-center text-gray-600 py-2">
                    <i class="fas fa-shopping-bag mr-3"></i> Cart (<span id="cart-count-mobile">0</span>)
                </a>
                <div id="mobile-auth-logged-out" class="flex flex-col gap-3 mt-2 pt-2 border-t border-gray-100">
                    <a href="login.html" class="text-center w-full border border-gray-300 text-gray-700 py-2.5 rounded-lg font-medium">Log In</a>
                    <a href="register.html" class="text-center w-full bg-gray-900 text-white py-2.5 rounded-lg font-bold">Sign Up</a>
                </div>
                <div id="mobile-auth-logged-in" class="hidden mt-2 pt-2 border-t border-gray-100">
                    <a href="profile.html" class="flex items-center text-gray-600 font-medium py-2">
                        <i class="fas fa-user-circle mr-3 text-xl"></i> My Profile
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="flex flex-col lg:flex-row gap-10">
            
            <aside class="w-full lg:w-1/4">
                <div class="lg:sticky lg:top-28 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-900 mb-4">Search</h3>
                        <div class="relative">
                            <input id="search" name="search" type="search" placeholder="Find a product..." 
                                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-600 focus:border-transparent outline-none transition text-sm">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        </div>
                    </div>

                    <form id="filter-form" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <i class="fas fa-filter text-indigo-600"></i> Filters
                        </h2>

                        <div class="mb-8">
                            <h3 class="font-semibold text-gray-800 mb-3 text-sm uppercase tracking-wide">Category</h3>
                            <div id="category-filters" class="space-y-2.5">
                                <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                                    <input type="radio" name="category" value="" class="form-radio text-indigo-600 focus:ring-indigo-600 h-4 w-4" checked>
                                    <span class="ml-3 text-gray-600 text-sm">All Products</span>
                                </label>
                                <!-- Categories will be loaded dynamically here -->
                            </div>
                        </div>

                        <div class="mb-8">
                            <h3 class="font-semibold text-gray-800 mb-3 text-sm uppercase tracking-wide">Price Range</h3>
                            <input type="range" id="price-range" name="price" min="0" max="50000" value="50000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-gray-600 mt-3 font-medium">
                                <span>₱0</span>
                                <span id="price-value" class="text-indigo-600">₱50,000</span>
                            </div>
                        </div>

                        <div class="mb-8">
                            <h3 class="font-semibold text-gray-800 mb-3 text-sm uppercase tracking-wide">Rating</h3>
                            <select id="min-rating" name="min-rating" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-600 focus:border-transparent outline-none text-sm">
                                <option value="0">All Ratings</option>
                                <option value="4">4 Stars & Up</option>
                                <option value="3">3 Stars & Up</option>
                            </select>
                        </div>

                        <button type="button" id="clear-filters" class="w-full py-2.5 border border-gray-300 rounded-lg text-gray-600 font-medium text-sm hover:bg-gray-50 hover:text-indigo-600 transition">
                            Clear All Filters
                        </button>
                    </form>
                </div>
            </aside>

            <section class="w-full lg:w-3/4">
                
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">All Products</h1>
                    
                    <div class="flex items-center gap-3">
                        <label for="sort-by" class="text-sm text-gray-500 font-medium">Sort by:</label>
                        <div class="relative">
                            <select id="sort-by" name="sort-by" class="appearance-none pl-4 pr-10 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:border-transparent cursor-pointer shadow-sm">
                                <option value="newest">Newest Arrivals</option>
                                <option value="price-asc">Price: Low to High</option>
                                <option value="price-desc">Price: High to Low</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full py-20 text-center">
                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-600 mb-3"></i>
                        <p class="text-gray-500">Loading products...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile Menu Logic
            const menuBtn = document.getElementById('menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            if (menuBtn && mobileMenu) {
                menuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            const API = 'https://fundamental-apparel-backend.onrender.com';
            const token = localStorage.getItem('token');
            
            // Auth Elements
            const authLoggedOut = document.getElementById('auth-links-logged-out');
            const authLoggedIn = document.getElementById('auth-links-logged-in');
            const mobileAuthLoggedOut = document.getElementById('mobile-auth-logged-out');
            const mobileAuthLoggedIn = document.getElementById('mobile-auth-logged-in');
            const cartCountSpan = document.getElementById('cart-count');
            const cartCountMobile = document.getElementById('cart-count-mobile');

            // Product Elements
            const productsContainer = document.getElementById('products-container');
            const filterForm = document.getElementById('filter-form');
            const priceRange = document.getElementById('price-range');
            const priceValue = document.getElementById('price-value');
            const sortBy = document.getElementById('sort-by');
            const searchInput = document.getElementById('search');
            const minRatingSelect = document.getElementById('min-rating');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const categoryFiltersContainer = document.getElementById('category-filters');

            let allProducts = [];
            let allCategories = [];

            // --- UI STATE MANAGEMENT ---
            function setLoggedOutUI() {
                if (authLoggedOut) authLoggedOut.classList.remove('hidden');
                if (authLoggedIn) authLoggedIn.classList.add('hidden');
                if (mobileAuthLoggedOut) mobileAuthLoggedOut.classList.remove('hidden');
                if (mobileAuthLoggedIn) mobileAuthLoggedIn.classList.add('hidden');
                if (cartCountSpan) cartCountSpan.textContent = '0';
                if (cartCountMobile) cartCountMobile.textContent = '0';
            }

            function setLoggedInUI() {
                if (authLoggedOut) authLoggedOut.classList.add('hidden');
                if (authLoggedIn) authLoggedIn.classList.remove('hidden');
                if (mobileAuthLoggedOut) mobileAuthLoggedOut.classList.add('hidden');
                if (mobileAuthLoggedIn) mobileAuthLoggedIn.classList.remove('hidden');
            }

            async function validateToken(token) {
                if (!token) return false;
                try {
                    const res = await fetch(`${API}/api/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const json = await res.json();
                    return res.ok && json.success && json.data.role !== 'admin';
                } catch (err) { return false; }
            }

            async function fetchCartCount() {
                if (!token) return;
                try {
                    const res = await fetch(`${API}/api/cart`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!res.ok) return;
                    const result = await res.json();
                    if (result.success && result.data && result.data.items) {
                        const count = String(result.data.items.length);
                        if (cartCountSpan) cartCountSpan.textContent = count;
                        if (cartCountMobile) cartCountMobile.textContent = count;
                    }
                } catch (error) { console.error(error); }
            }

            // Initialize Auth State
            (async () => {
                if (token && await validateToken(token)) {
                    setLoggedInUI();
                    await fetchCartCount();
                } else {
                    localStorage.removeItem('token');
                    setLoggedOutUI();
                }
            })();

            // --- PRODUCT LOGIC ---
            async function fetchCategories() {
                try {
                    const response = await fetch(`${API}/api/categories`);
                    if (!response.ok) throw new Error('Failed to fetch categories');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        allCategories = result.data;
                        renderCategoryFilters();
                    }
                } catch (error) {
                    console.error('Error fetching categories:', error);
                    // Keep the "All Products" option even if fetch fails
                }
            }

            function renderCategoryFilters() {
                if (!categoryFiltersContainer) return;
                
                // Keep the "All Products" option and add dynamic categories
                const allProductsOption = categoryFiltersContainer.querySelector('input[value=""]')?.parentElement;
                
                // Clear existing category options (except "All Products")
                categoryFiltersContainer.innerHTML = '';
                
                // Re-add "All Products"
                if (allProductsOption) {
                    categoryFiltersContainer.appendChild(allProductsOption);
                } else {
                    // Fallback if "All Products" was removed
                    categoryFiltersContainer.innerHTML = `
                        <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                            <input type="radio" name="category" value="" class="form-radio text-indigo-600 focus:ring-indigo-600 h-4 w-4" checked>
                            <span class="ml-3 text-gray-600 text-sm">All Products</span>
                        </label>
                    `;
                }
                
                // Add dynamic categories from database
                allCategories.forEach(category => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center cursor-pointer hover:text-indigo-600 transition';
                    label.innerHTML = `
                        <input type="radio" name="category" value="${category.name}" class="form-radio text-indigo-600 focus:ring-indigo-600 h-4 w-4">
                        <span class="ml-3 text-gray-600 text-sm">${category.name}</span>
                    `;
                    categoryFiltersContainer.appendChild(label);
                    
                    // Add event listener for the new radio button
                    label.querySelector('input').addEventListener('change', applyFiltersAndSort);
                });
            }

            async function fetchProducts() {
                try {
                    // Exclude pre-design products from the public products listing
                    const response = await fetch(`${API}/api/products?type=regular`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const result = await response.json();
                    
                    if (result.success) {
                        allProducts = result.data;
                        applyFiltersAndSort();
                    } else {
                        productsContainer.innerHTML = '<div class="col-span-full text-center py-10"><p class="text-gray-500">No products found.</p></div>';
                    }
                } catch (error) {
                    productsContainer.innerHTML = `<div class="col-span-full text-center py-10"><p class="text-red-500">Failed to load products.</p></div>`;
                }
            }
            
            function renderProducts(products) {
                productsContainer.innerHTML = '';
                
                if (products.length === 0) {
                    productsContainer.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-4 text-gray-300"></i>
                            <p>No products match your filters.</p>
                        </div>`;
                    return;
                }

                products.forEach(product => {
                    const imageUrl = product.imageUrl || 'https://placehold.co/400x400/e2e8f0/cccccc?text=N/A';
                    // Determine display price: prefer minimum per-size price when available
                    let displayPrice = Number(product.price || 0);
                    try {
                        let sizesPriceObj = product.sizesPrice || {};
                        if (typeof sizesPriceObj === 'string') {
                            try { sizesPriceObj = JSON.parse(sizesPriceObj); } catch(e) { sizesPriceObj = {}; }
                        }
                        const priceVals = Object.values(sizesPriceObj || {}).map(v => Number(v || 0)).filter(v => v > 0);
                        if (priceVals.length > 0) displayPrice = Math.min(...priceVals);
                    } catch (e) { /* ignore */ }
                    
                    // Premium Card Design (Matching Homepage)
                    const productCard = document.createElement('div');
                    productCard.className = 'group bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col hover:shadow-lg transition-shadow duration-300';
                    
                    productCard.innerHTML = `
                        <a href="product-detail.html?id=${product._id}" class="block relative w-full h-64 bg-gray-100 overflow-hidden">
                            <img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        </a>
                        <div class="p-5 flex-1 flex flex-col justify-between">
                            <div class="mb-3">
                                <h3 class="font-semibold text-gray-900 truncate text-lg" title="${product.name}">${product.name}</h3>
                                <p class="text-sm text-gray-500 mt-1 truncate">${product.category}</p>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-xl font-bold text-indigo-600">₱${Number(displayPrice).toLocaleString()}</span>
                                    <span class="text-xs text-gray-400">Stock: ${product.countInStock}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button class="add-to-cart-btn flex-1 bg-gray-900 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-black transition shadow-sm" data-id="${product._id}">
                                        Add to Cart
                                    </button>
                                    <a href="product-detail.html?id=${product._id}" class="px-3 py-2.5 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50 transition flex items-center justify-center">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    productsContainer.appendChild(productCard);
                });

                // Add to Cart Listeners
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', () => addToCart(btn.dataset.id, btn));
                });
            }

            // Simplified Add to Cart (Inline)
            async function addToCart(productId, btnEl) {
                if (!token) {
                    alert('Please log in to shop.');
                    window.location.href = `login.html?next=${encodeURIComponent(window.location.pathname)}`;
                    return;
                }

                // Fetch product to check whether it has sizes. If it does, require the user
                // to pick a size on the product page instead of allowing a blind quick-add.
                try {
                    const pRes = await fetch(`${API}/api/products/${productId}`);
                    if (pRes.ok) {
                        const pJson = await pRes.json();
                        const prod = pJson && pJson.data ? pJson.data : null;
                        const hasSizes = (prod && ((prod.sizes && prod.sizes.length > 0) || (prod.sizesInventory && Object.keys(prod.sizesInventory || {}).length > 0)));
                        if (hasSizes) {
                            // Redirect to product detail so user can select size/color
                            window.location.href = `product-detail.html?id=${productId}`;
                            return;
                        }
                    }
                } catch (e) {
                    // If product fetch fails, fall back to original behavior (best-effort)
                    console.warn('Could not fetch product before quick add:', e && e.message);
                }

                const originalText = btnEl.textContent;
                btnEl.textContent = 'Adding...';
                btnEl.disabled = true;

                try {
                    const res = await fetch(`${API}/api/cart`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ productId, quantity: 1 })
                    });
                    if (res.ok) {
                        alert('Added to cart!');
                        fetchCartCount();
                    } else {
                        throw new Error('Failed');
                    }
                } catch (error) { alert('Could not add to cart. Try again.'); }
                finally { btnEl.disabled = false; btnEl.textContent = originalText; }
            }

            // --- FILTER LOGIC (Preserved) ---
            function debounce(fn, wait) {
                let t = null;
                return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
            }

            function applyFiltersAndSort() {
                let filteredProducts = [...allProducts];
                const formData = new FormData(filterForm);
                const category = formData.get('category');
                const maxPrice = parseInt(priceRange.value, 10);
                const sortValue = sortBy.value;
                const query = (searchInput.value || '').trim().toLowerCase();
                const minRating = parseFloat(minRatingSelect.value) || 0;

                if (query) {
                    filteredProducts = filteredProducts.filter(p => 
                        (p.name || '').toLowerCase().includes(query) || 
                        (p.description || '').toLowerCase().includes(query)
                    );
                }
                if (category) filteredProducts = filteredProducts.filter(p => p.category === category);
                
                filteredProducts = filteredProducts.filter(p => p.price <= maxPrice);
                
                if (minRating > 0) filteredProducts = filteredProducts.filter(p => (parseFloat(p.rating) || 0) >= minRating);

                if (sortValue === 'price-asc') filteredProducts.sort((a, b) => a.price - b.price);
                else if (sortValue === 'price-desc') filteredProducts.sort((a, b) => b.price - a.price);
                else filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                renderProducts(filteredProducts);
            }

            // Event Listeners
            priceRange.addEventListener('input', () => {
                priceValue.textContent = `₱${parseInt(priceRange.value, 10).toLocaleString()}`;
                applyFiltersAndSort();
            });

            // Note: Category radio buttons are now added dynamically in renderCategoryFilters()

            minRatingSelect.addEventListener('change', applyFiltersAndSort);
            sortBy.addEventListener('change', applyFiltersAndSort);
            searchInput.addEventListener('input', debounce(applyFiltersAndSort, 300));

            clearFiltersBtn.addEventListener('click', () => {
                filterForm.reset();
                priceRange.value = 50000;
                priceValue.textContent = '₱50,000';
                searchInput.value = '';
                applyFiltersAndSort();
            });

            // Initial Load - Fetch categories first, then products
            (async () => {
                await fetchCategories();
                await fetchProducts();
            })();
        });
    </script>

    <div id="site-footer"></div>
    <script src="js/footer.js"></script>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/idle-timeout.js"></script>
</body>
</html>