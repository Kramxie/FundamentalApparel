<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Checkout - Fundamental Apparel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .field-disabled { background-color: #f9fafb; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-gray-800"><a href="index.html">Fundamental</a></div>
      <div class="flex items-center space-x-5">
        <a href="index.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-home"></i> <span class="hidden sm:inline">Home</span></a>
        <a href="services.html" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-briefcase"></i> <span class="hidden sm:inline">Services</span></a>
        
        <div id="auth-links-logged-out" class="hidden items-center space-x-3">
            <a href="login.html" class="text-sm font-medium text-gray-700 hover:text-indigo-600">Log In</a>
            <a href="register.html" class="text-sm font-medium bg-indigo-600 text-white px-3 py-1.5 rounded-md hover:bg-indigo-700">Register</a>
        </div>

        <div id="auth-links-logged-in">
            <a href="profile.html" id="user-link" class="text-gray-600 hover:text-indigo-600">
                <i id="user-icon" class="fas fa-user-circle text-2xl"></i>
            </a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main id="services-checkout-container" class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="max-w-5xl mx-auto">
      <!-- Page Header -->
      <div class="mb-8">
        <a href="services.html" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium mb-2 inline-block">
          <i class="fas fa-arrow-left mr-1"></i> Back to Services
        </a>
        <h1 class="text-3xl font-bold text-gray-900">Service Checkout</h1>
        <p class="text-gray-600 mt-1">Review your custom order and complete payment</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Service Details & Shipping (2 columns width) -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Service Details with Design Preview -->
          <section class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-900">
              Order Summary
            </h2>
            <div id="service-summary" class="space-y-4">
              <p class="text-gray-500">Loading service details...</p>
            </div>
          </section>

          <!-- Shipping Address -->
          <section class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-900">
              Shipping Address
            </h2>
            <div class="flex items-center gap-6 mb-4 text-sm">
              <label class="flex items-center gap-2">
                <input type="radio" name="address-mode" id="address-default" value="default" class="h-4 w-4 text-indigo-600" checked> 
                Use Default Address
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="address-mode" id="address-new" value="new" class="h-4 w-4 text-indigo-600"> 
                Enter New Address
              </label>
            </div>
            <form id="shipping-form" class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Block</label>
                <input id="ship-block" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="Blk 13">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Lot</label>
                <input id="ship-lot" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="Lot 41">
              </div>
              <div class="col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Street <span class="text-red-500">*</span></label>
                <input id="ship-street" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="blk 8 lot 52 Greentown Villas 1, Mambog 3" required>
              </div>
              <div class="col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Building / Address</label>
                <input id="ship-building" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="De La Salle University - Dasmari√±as">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">State/Province <span class="text-red-500">*</span></label>
                <select id="ship-province" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required>
                  <option value="">Select province</option>
                  <option>Metro Manila</option>
                  <option>Manila</option>
                  <option>Quezon City</option>
                  <option>Makati</option>
                  <option>Cavite</option>
                  <option>Laguna</option>
                  <option>Batangas</option>
                  <option>Bulacan</option>
                  <option>Pampanga</option>
                  <option>Rizal</option>
                  <option>Quezon</option>
                  <option>Nueva Ecija</option>
                  <option>Tarlac</option>
                  <option>Zambales</option>
                  <option>Bataan</option>
                  <option>Other</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">City <span class="text-red-500">*</span></label>
                <input id="ship-city" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="Bacoor" required>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Zip/Postal Code <span class="text-red-500">*</span></label>
                <input id="ship-zip" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="4102" required>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Phone <span class="text-red-500">*</span></label>
                <input id="ship-phone" type="tel" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="+63 912 345 6789" required>
              </div>
            </form>
          </section>

          <!-- Delivery Method -->
          <section class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-900">
              Delivery Method
            </h2>
            <div class="space-y-3">
              <label class="flex items-center justify-between border-2 rounded-lg p-3 cursor-pointer hover:border-indigo-400 transition-colors" id="delivery-standard-option">
                <div class="flex items-center gap-3">
                  <input id="method-standard" type="radio" name="delivery-method" value="standard" class="h-4 w-4 text-indigo-600" checked>
                  <div>
                    <p class="font-medium text-sm">Standard Delivery</p>
                    <p class="text-xs text-gray-500">3-5 days via J&T / Lalamove</p>
                  </div>
                </div>
                <div class="font-semibold text-indigo-600">‚Ç±<span id="fee-standard-services">80</span></div>
              </label>
              <label class="flex items-center justify-between border-2 rounded-lg p-3 cursor-pointer hover:border-green-400 transition-colors" id="delivery-pickup-option">
                <div class="flex items-center gap-3">
                  <input id="method-pickup" type="radio" name="delivery-method" value="pickup" class="h-4 w-4 text-green-600">
                  <div>
                    <p class="font-medium text-sm">üì¶ Pick-Up</p>
                    <p class="text-xs text-gray-500">Pick-up at store - No delivery fee</p>
                  </div>
                </div>
                <span class="text-sm font-semibold text-green-600">FREE</span>
              </label>
              
              <!-- Pickup Location Info (shows when pickup selected) -->
              <div id="pickup-location-info" class="hidden mt-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="font-semibold text-green-900 mb-2">üìç Pickup Location:</p>
                <div class="text-sm text-gray-700 space-y-1">
                  <p class="font-medium">Fundamental Apparel Store</p>
                  <p>123 Main Street, Barangay San Jose</p>
                  <p>Manila, Metro Manila 1000</p>
                  <p class="mt-2">üìû Contact: (02) 8123-4567</p>
                  <p>üïí Store Hours: Mon-Sat 9:00 AM - 6:00 PM</p>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Right Column: Payment & Summary (1 column width) -->
        <aside class="lg:col-span-1 space-y-6">
          <!-- Payment Method -->
          <section class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-900 flex items-center">
              <i class="fas fa-credit-card mr-2 text-indigo-600"></i>
              Payment Method
            </h2>
            
            <div class="space-y-3">
              <label class="flex items-center justify-between border-2 rounded-lg p-3 cursor-pointer transition hover:border-indigo-500" id="gcash-option">
                <div class="flex items-center gap-2">
                  <input type="radio" name="payment_method" id="pay-gcash" class="h-4 w-4 text-indigo-600" checked>
                  <div>
                    <span class="font-medium text-sm">GCash</span>
                    <p class="text-xs text-gray-500">Pay via GCash e-wallet</p>
                  </div>
                </div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/GCash_logo.svg/512px-GCash_logo.svg.png" alt="GCash" class="h-6">
              </label>
              
              <label class="flex items-center justify-between border-2 rounded-lg p-3 cursor-pointer transition hover:border-indigo-500" id="card-option">
                <div class="flex items-center gap-2">
                  <input type="radio" name="payment_method" id="pay-card" class="h-4 w-4 text-indigo-600">
                  <div>
                    <span class="font-medium text-sm">Credit/Debit Card</span>
                    <p class="text-xs text-gray-500">Visa, Mastercard, JCB</p>
                  </div>
                </div>
                <div class="flex gap-1">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" alt="Visa" class="h-5">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-5">
                </div>
              </label>
            </div>

            <!-- Security Badge -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-start gap-2">
              <i class="fas fa-shield-alt text-blue-600 mt-0.5"></i>
              <p class="text-xs text-blue-900">
                <strong>Secure Payment:</strong> You'll be redirected to PayMongo's secure checkout page to complete your payment.
              </p>
            </div>
          </section>

          <!-- Billing Summary -->
          <section class="bg-white rounded-lg shadow-sm border p-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-900">
              Billing Summary
            </h2>
            
            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Subtotal</span>
                <span class="font-medium">‚Ç±<span id="base-price">0</span></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Discount</span>
                <span class="font-medium text-red-600">-‚Ç±0</span>
              </div>
              <div id="delivery-fee-row" class="flex justify-between">
                <span class="text-gray-600">Delivery Fee</span>
                <span id="delivery-fee-amount" class="font-medium">‚Ç±80</span>
              </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">VAT (12%)</span>
                  <span class="font-medium">‚Ç±<span id="vat-services">0.00</span></span>
                </div>
                <hr class="border-gray-200">
              <div class="flex justify-between items-center pt-2">
                <span class="text-base font-semibold text-gray-900">Total</span>
                <span class="text-xl font-bold text-indigo-600">‚Ç±<span id="total-amount">0</span></span>
              </div>
            </div>

            <!-- Order Comment -->
            <div class="mt-4">
              <label class="block text-xs font-medium text-gray-700 mb-1">Order Comment</label>
              <textarea id="contact-notes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Type here..."></textarea>
            </div>

            <!-- Contact Info (Compact) -->
            <div class="mt-4 space-y-2">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Full Name <span class="text-red-500">*</span></label>
                <input id="contact-name" type="text" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500" placeholder="Juan Dela Cruz">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
                <input id="contact-email" type="email" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500" placeholder="juan@example.com">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Phone <span class="text-red-500">*</span></label>
                <input id="contact-phone" type="tel" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500" placeholder="+63 912 345 6789">
              </div>
            </div>

            <!-- Terms Checkbox -->
            <label class="flex items-start gap-2 text-xs text-gray-700 cursor-pointer mt-4">
              <input id="agree-terms" type="checkbox" class="mt-0.5 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"> 
              <span>I agree to the <a href="#" class="text-indigo-600 hover:underline">Terms of Service</a> and <a href="#" class="text-indigo-600 hover:underline">Privacy Policy</a></span>
            </label>

            <!-- Checkout Button -->
            <button id="proceed-payment-btn" class="w-full mt-4 bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <i class="fas fa-lock"></i>
              <span>Proceed to Payment</span>
            </button>

            <!-- Status Messages -->
            <div id="error-message" class="hidden mt-3 text-red-600 text-xs bg-red-50 border border-red-200 rounded p-2"></div>
            <div id="success-message" class="hidden mt-3 text-green-600 text-xs bg-green-50 border border-green-200 rounded p-2"></div>
          </section>

          <!-- Order Reference -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-xs text-gray-600">
              <i class="fas fa-info-circle"></i>
              <span>Order Ref: <strong id="order-ref" class="text-gray-900">N/A</strong></span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = 'https://fundamental-apparel-backend.onrender.com';
    
    // Utility: Format peso
    function peso(n) { 
      return '‚Ç±' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
    }

    // Helper: Get garment emoji
    function getGarmentEmoji(garmentType) {
      if (!garmentType) return 'üëï';
      const type = garmentType.toLowerCase();
      if (type.includes('v-neck') || type.includes('vneck')) return 'üëï';
      if (type.includes('round') || type.includes('crew')) return 'üëï';
      if (type.includes('jersey')) return 'üèΩ';
      if (type.includes('shirt')) return 'üëï';
      if (type.includes('short')) return 'ü©≥';
      return 'üëî';
    }

    // Helper: Format location text
    function formatLocation(location) {
      if (!location) return '';
      return location.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    // State
    let serviceData = null;
    let orderReference = null;

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      
      // Auth check
      if (!token) {
        alert('Please log in to continue with checkout.');
        window.location.href = 'login.html';
        return;
      }

      // Show logged-in state
      const authLoggedOut = document.getElementById('auth-links-logged-out');
      const authLoggedIn = document.getElementById('auth-links-logged-in');
      if (authLoggedOut) authLoggedOut.classList.add('hidden');
      if (authLoggedIn) authLoggedIn.classList.remove('hidden');

      // Load service data from localStorage or URL params
      loadServiceData();
      
      // Fetch user profile to pre-fill contact form and address
      fetchUserProfile();

      // Setup shipping address mode toggle
      setupShippingAddressToggle();
      
      // Setup delivery method change handler
      setupDeliveryMethodHandlers();

      // Attach event listeners
      document.getElementById('proceed-payment-btn').addEventListener('click', handlePaymentSubmit);
    });

    /**
     * Setup shipping address toggle (default vs new)
     */
    function setupShippingAddressToggle() {
      const defaultRadio = document.getElementById('address-default');
      const newRadio = document.getElementById('address-new');
      const shippingInputs = document.querySelectorAll('#shipping-form input');
      
      function updateAddressFields() {
        const isBalance = (serviceData && serviceData.paymentOption === 'balance');
        shippingInputs.forEach(input => {
          const disabled = isBalance || defaultRadio.checked;
          input.disabled = disabled;
          if (disabled) {
            input.classList.add('bg-gray-100', 'cursor-not-allowed');
          } else {
            input.classList.remove('bg-gray-100', 'cursor-not-allowed');
          }
        });
        if (isBalance) {
          // Lock the radio toggles too
          if (defaultRadio) defaultRadio.disabled = true;
          if (newRadio) newRadio.disabled = true;
        }
      }
      
      defaultRadio.addEventListener('change', updateAddressFields);
      newRadio.addEventListener('change', updateAddressFields);
      updateAddressFields(); // Initial state
    }

    /**
     * Setup delivery method handlers (Standard vs Pick-Up)
     */
    function setupDeliveryMethodHandlers() {
      const standardRadio = document.getElementById('method-standard');
      const pickupRadio = document.getElementById('method-pickup');
      const shippingSection = document.querySelector('section:has(#shipping-form)');
      const pickupLocationInfo = document.getElementById('pickup-location-info');
      
      function updateDeliveryUI() {
        const isBalance = (serviceData && serviceData.paymentOption === 'balance');
        if (isBalance) {
          // Lock delivery mode; use original method from prior payment
          const prior = (serviceData && (serviceData.shippingMethod || 'Standard'));
          if (prior === 'Pick-Up') {
            if (pickupRadio) pickupRadio.checked = true;
            if (standardRadio) standardRadio.checked = false;
            if (shippingSection) shippingSection.style.display = 'none';
            if (pickupLocationInfo) pickupLocationInfo.classList.remove('hidden');
          } else {
            if (standardRadio) standardRadio.checked = true;
            if (pickupRadio) pickupRadio.checked = false;
            if (shippingSection) shippingSection.style.display = 'block';
            if (pickupLocationInfo) pickupLocationInfo.classList.add('hidden');
          }
          if (standardRadio) standardRadio.disabled = true;
          if (pickupRadio) pickupRadio.disabled = true;
        } else if (pickupRadio.checked) {
          // Hide shipping address for pickup
          shippingSection.style.display = 'none';
          // Show pickup location info
          if (pickupLocationInfo) pickupLocationInfo.classList.remove('hidden');
        } else {
          // Show shipping address for delivery
          shippingSection.style.display = 'block';
          // Hide pickup location info
          if (pickupLocationInfo) pickupLocationInfo.classList.add('hidden');
        }
        // Recalculate total amount with delivery fee
        updatePaymentAmounts(serviceData);
      }
      
      standardRadio.addEventListener('change', updateDeliveryUI);
      pickupRadio.addEventListener('change', updateDeliveryUI);
      updateDeliveryUI(); // Initial state
      // Recompute when province changes so the standard delivery card updates
      const provSel = document.getElementById('ship-province');
      if (provSel) provSel.addEventListener('change', ()=> updatePaymentAmounts(serviceData || {}));
    }

    /**
     * Load service data from localStorage (set by customizer page)
     */
    function loadServiceData() {
      const storedData = localStorage.getItem('pendingServiceCheckout');
      
      if (!storedData) {
        showError('No service data found. Please start from the customizer page.');
        document.getElementById('service-summary').innerHTML = '<p class="text-red-500">Service data not found.</p>';
        document.getElementById('proceed-payment-btn').disabled = true;
        return;
      }

      try {
        serviceData = JSON.parse(storedData);
        orderReference = serviceData.orderReference || 'PENDING';
        
        console.log('[DEBUG] Service data loaded:', serviceData);
        console.log('[DEBUG] Design images map:', serviceData.designImagesMap);
        
        // If orderId exists, fetch full order details from backend to get design images
        if (serviceData.orderId) {
          fetchOrderDetails(serviceData.orderId);
        } else {
          // Render with localStorage data only
          renderServiceSummary(serviceData);
          updatePaymentAmounts(serviceData);
        }
        
        // Update order reference
        document.getElementById('order-ref').textContent = orderReference;
        
      } catch (err) {
        console.error('Error parsing service data:', err);
        showError('Invalid service data format.');
        document.getElementById('proceed-payment-btn').disabled = true;
      }
    }

    /**
     * Fetch full order details from backend (includes design images)
     */
    async function fetchOrderDetails(orderId) {
      const token = localStorage.getItem('token');
      
      try {
        const res = await fetch(`${API_BASE}/api/custom-orders/${orderId}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });
        
        if (!res.ok) throw new Error('Failed to fetch order details');
        
        const json = await res.json();
        
        if (json.success && json.data) {
          // Merge backend data with localStorage data
          serviceData = {
            ...serviceData,
            ...json.data,
            // Preserve payment option from localStorage
            paymentOption: serviceData.paymentOption,
            totalPrice: serviceData.totalPrice
          };
          
          console.log('[DEBUG] Merged order data:', serviceData);
          console.log('[DEBUG] Design images from backend:', serviceData.designImagesMap);
        }
      } catch (err) {
        console.error('Error fetching order details:', err);
        // Continue with localStorage data
      }
      
      // Render with updated data
      renderServiceSummary(serviceData);
      updatePaymentAmounts(serviceData);
    }

    /**
     * Render service summary section
     */
    function renderServiceSummary(data) {
      const container = document.getElementById('service-summary');
      const qp = data.quotePayload || {};
      const garmentLabel = qp.garmentLabel || data.garmentType || data.itemType || 'T-Shirt';
      const garmentEmoji = getGarmentEmoji(garmentLabel);
      const singleColorHex = qp.garmentColorHex || qp.garmentColorName || null;
      const singleColorName = qp.garmentColorName || '';
      const isPrintingOnly = (data.serviceType && String(data.serviceType).toLowerCase().includes('printing')) ||
        (data.serviceName && String(data.serviceName).toLowerCase().includes('printing only'));
      let designDownloadHtml = '';
      if (isPrintingOnly && data.designFileUrl) {
        let fileUrl = data.designFileUrl;
        if (fileUrl && !fileUrl.startsWith('http') && !fileUrl.startsWith('data:')) {
          fileUrl = fileUrl.startsWith('/') ? `${API_BASE}${fileUrl}` : `${API_BASE}/${fileUrl}`;
        }
        designDownloadHtml = `
        <div class="mt-2 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
          <p class="text-xs text-indigo-900 mb-1"><i class=\"fas fa-file-download mr-1\"></i>Design File</p>
          <a href="${fileUrl}" target="_blank" rel="noopener" class="text-sm font-medium text-indigo-700 hover:underline">
            View/Download Uploaded Design
          </a>
        </div>
        `;
      }
      
      const html = `
        <div class="border-b pb-3 mb-3">
          <div class="flex items-center gap-3 mb-2">
            <i class="fas fa-tshirt text-2xl text-indigo-600"></i>
            <div>
              <h3 class="font-semibold text-gray-900">${data.serviceName || 'Custom Jersey Service'}</h3>
              <p class="text-sm text-gray-600">${data.serviceType || 'customize-jersey'}</p>
            </div>
          </div>
        </div>

        ${renderDesignPreviews(data)}
        ${designDownloadHtml}

        <div class="grid grid-cols-2 gap-3 text-sm mt-4">
          <div>
            <span class="text-gray-600">Garment Type:</span>
            <p class="font-medium">${garmentEmoji} ${garmentLabel}</p>
          </div>
          <div>
            <span class="text-gray-600">Quantity:</span>
            <p class="font-medium">üì¶ ${data.quantity || 1} ${(data.quantity || 1) === 1 ? 'piece' : 'pieces'}</p>
          </div>
          ${(() => {
            const qp = data.quotePayload || {};
            // Prefer precomputed placements from backend
            let textPlacements = Array.isArray(qp.designTextWithPlacements) ? qp.designTextWithPlacements : [];
            // Derive from designElementsMap if not provided
            if ((!textPlacements || textPlacements.length === 0) && qp.designElementsMap && typeof qp.designElementsMap === 'object') {
              const derived = [];
              Object.entries(qp.designElementsMap).forEach(([loc, arr]) => {
                (arr || []).filter(e => e && e.type === 'text' && e.text).forEach(e => {
                  derived.push({ text: e.text, placement: loc });
                });
              });
              textPlacements = derived;
            }
            if (textPlacements && textPlacements.length > 0) {
              const formatted = textPlacements.map(tp => `\"${tp.text}\" <span class=\\\"text-xs text-gray-600\\\">- ${formatLocation(tp.placement)}</span>`).join('<br>');
              return `
          <div class="col-span-2">
            <span class="text-gray-600">Design Text:</span>
            <p class="font-medium text-indigo-700">${formatted}</p>
          </div>
              `;
            } else if (data.designText) {
              return `
          <div class="col-span-2">
            <span class="text-gray-600">Design Text:</span>
            <p class="font-medium text-indigo-700">"${data.designText}" ${data.selectedLocation ? `<span class=\"text-xs text-gray-600\">- ${formatLocation(data.selectedLocation)}</span>` : ''}</p>
          </div>
              `;
            }
            return '';
          })()}
          ${singleColorHex ? `
          <div class="col-span-2">
            <span class="text-gray-600">Colors Selected:</span>
            <div class="flex gap-3 mt-2 flex-wrap">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg border-2 shadow-sm" style="background-color: ${singleColorHex}"></div>
                <div class="text-xs">
                  <span class="text-gray-600">${singleColorName || 'Selected'}</span><br>
                  <span class="text-gray-400 font-mono text-[10px]">${singleColorHex}</span>
                </div>
              </div>
            </div>
          </div>
          ` : (data.colors && (data.colors.primary || data.colors.secondary || data.colors.accent) ? `
          <div class="col-span-2">
            <span class="text-gray-600">Colors Selected:</span>
            <div class="flex gap-3 mt-2 flex-wrap">
              ${data.colors.primary ? `<div class=\"flex items-center gap-2\"><div class=\"w-8 h-8 rounded-lg border-2 shadow-sm\" style=\"background-color: ${data.colors.primary}\"></div><div class=\"text-xs\"><span class=\"text-gray-600\">Primary</span><br><span class=\"text-gray-400 font-mono text-[10px]\">${data.colors.primary}</span></div></div>` : ''}
              ${data.colors.secondary ? `<div class=\"flex items-center gap-2\"><div class=\"w-8 h-8 rounded-lg border-2 shadow-sm\" style=\"background-color: ${data.colors.secondary}\"></div><div class=\"text-xs\"><span class=\"text-gray-600\">Secondary</span><br><span class=\"text-gray-400 font-mono text-[10px]\">${data.colors.secondary}</span></div></div>` : ''}
              ${data.colors.accent ? `<div class=\"flex items-center gap-2\"><div class=\"w-8 h-8 rounded-lg border-2 shadow-sm\" style=\"background-color: ${data.colors.accent}\"></div><div class=\"text-xs\"><span class=\"text-gray-600\">Accent</span><br><span class=\"text-gray-400 font-mono text-[10px]\">${data.colors.accent}</span></div></div>` : ''}
            </div>
          </div>
          ` : '')}
        </div>

        ${data.notes ? `
        <div class="mt-4 p-3 bg-gray-50 rounded border border-gray-200">
          <p class="text-xs text-gray-600 mb-1">Customer Notes:</p>
          <p class="text-sm">${data.notes}</p>
        </div>
        ` : ''}
      `;
      
      container.innerHTML = html;
    }

    /**
     * Render design preview images (4 placements like admin view)
     */
    function renderDesignPreviews(data) {
      console.log('[DEBUG] renderDesignPreviews called with:', data);
      console.log('[DEBUG] designImagesMap:', data.designImagesMap);
      console.log('[DEBUG] designImagesMap keys:', data.designImagesMap ? Object.keys(data.designImagesMap) : 'none');
      
      // Log each key's actual value
      if (data.designImagesMap) {
        Object.keys(data.designImagesMap).forEach(key => {
          console.log(`[DEBUG] designImagesMap["${key}"] = `, data.designImagesMap[key]);
        });
      }
      
      console.log('[DEBUG] designPreviews:', data.designPreviews);
      console.log('[DEBUG] designImage:', data.designImage);
      
      // Check if designImagesMap exists (from new customizer)
      if (data.designImagesMap && typeof data.designImagesMap === 'object') {
        // Handle both capitalized and lowercase keys
        const placementMappings = [
          { display: 'Front', keys: ['Front', 'front'] },
          { display: 'Back', keys: ['Back', 'back'] },
          { display: 'Left Sleeve', keys: ['Left', 'left-sleeve', 'leftSleeve', 'left sleeve'] },
          { display: 'Right Sleeve', keys: ['Right', 'right-sleeve', 'rightSleeve', 'right sleeve'] }
        ];
        
        const images = [];
        
        placementMappings.forEach(mapping => {
          // Try to find image with any of the possible key names
          for (const key of mapping.keys) {
            if (data.designImagesMap[key]) {
              let imageUrl = data.designImagesMap[key];
              
              // Fix URL: add API_BASE if it's a relative path
              if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('data:')) {
                imageUrl = imageUrl.startsWith('/') ? `${API_BASE}${imageUrl}` : `${API_BASE}/${imageUrl}`;
              }
              
              console.log(`[DEBUG] Found image for ${mapping.display} with key: ${key}, URL: ${imageUrl}`);
              
              images.push({
                location: mapping.display,
                url: imageUrl
              });
              break; // Found it, move to next placement
            }
          }
        });
        
        console.log('[DEBUG] Found images from designImagesMap:', images.length);
        
        if (images.length > 0) {
          return `
            <div class="mb-4">
              <p class="text-sm font-medium text-gray-700 mb-3">
                <i class="fas fa-images mr-1"></i>
                Design Previews (${images.length} views)
              </p>
              <div class="grid grid-cols-2 gap-3">
                ${images.map(img => `
                  <div class="border-2 border-gray-200 rounded-lg overflow-hidden hover:border-indigo-400 transition">
                    <div class="bg-gray-50 p-2">
                      <img src="${img.url}" alt="${img.location}" class="w-full h-32 object-contain" onerror="this.parentElement.innerHTML='<div class=\\'text-red-500 text-xs p-2\\'>Image failed to load</div>'">
                    </div>
                    <div class="bg-white px-2 py-1.5 border-t border-gray-200">
                      <p class="text-xs font-medium text-gray-700 text-center">${img.location}</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      }
      
      // Fallback: Check old designPreviews format
      if (data.designPreviews && data.designPreviews.length > 0) {
        console.log('[DEBUG] Using designPreviews fallback');
        return `
          <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-3">
              <i class="fas fa-images mr-1"></i>
              Design Previews
            </p>
            <div class="grid grid-cols-2 gap-3">
              ${data.designPreviews.map(preview => `
                <div class="border-2 border-gray-200 rounded-lg overflow-hidden hover:border-indigo-400 transition">
                  <div class="bg-gray-50 p-2">
                    <img src="${preview.url}" alt="${preview.location}" class="w-full h-32 object-contain">
                  </div>
                  <div class="bg-white px-2 py-1.5 border-t border-gray-200">
                    <p class="text-xs font-medium text-gray-700 text-center">${preview.location}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      // Fallback: Single design image
      if (data.designImage) {
        console.log('[DEBUG] Using single designImage');
        return `
          <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-3">
              <i class="fas fa-image mr-1"></i>
              Design Preview
            </p>
            <div class="border-2 border-gray-200 rounded-lg overflow-hidden">
              <div class="bg-gray-50 p-4">
                <img src="${data.designImage}" alt="Design" class="w-full h-48 object-contain">
              </div>
            </div>
          </div>
        `;
      }
      
      // No preview images available
      console.log('[DEBUG] No design images found');
      return `
        <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg text-center">
          <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
          <p class="text-sm text-gray-500">No design preview available</p>
          <p class="text-xs text-gray-400 mt-1">Design images will be generated after order confirmation</p>
        </div>
      `;
    }

    /**
     * Update payment amounts display with delivery fee
     */
    /**
     * Update payment amounts display with delivery fee
     */
    function updatePaymentAmounts(data) {
      const quantity = data.quantity || 1;
      const serviceFee = 0; // No additional service fee for now
      const paymentOption = data.paymentOption || 'full';
      
      // Get delivery fee based on selected method and selected province
      const deliveryMethod = document.querySelector('input[name="delivery-method"]:checked');
      // Province-based delivery rates (client-side mirror of server rates)
      const PROVINCE_RATES = {
        'metro manila': 120,
        'manila': 120,
        'quezon city': 120,
        'makati': 120,
        'cavite': 70,
        'laguna': 80,
        'batangas': 120,
        'bulacan': 90,
        'pampanga': 100,
        'rizal': 85,
        'quezon': 150,
        'nueva ecija': 120,
        'tarlac': 130,
        'zambales': 140,
        'bataan': 140,
        'other': 120
      };
      function clientRateForProvince(prov){
        if(!prov) return 120;
        const key = (prov||'').toString().toLowerCase();
        if(key.includes('cavite')) return PROVINCE_RATES['cavite'];
        if(key.includes('laguna')) return PROVINCE_RATES['laguna'];
        if(key.includes('batangas')) return PROVINCE_RATES['batangas'];
        if(key.includes('metro')||key.includes('manila')||key.includes('quezon city')||key.includes('makati')) return PROVINCE_RATES['metro manila'];
        return PROVINCE_RATES[key] || 120;
      }
      // For remaining-balance payment, do not add a new delivery fee; use the original fee for computation only
      const selectedProvince = document.getElementById('ship-province')?.value || '';
      const selectedDeliveryFee = deliveryMethod && deliveryMethod.value === 'pickup' ? 0 : clientRateForProvince(selectedProvince);
      const previousDeliveryFee = Number(data.previousDeliveryFee || 0);
      
      // Determine subtotal semantics:
      // - If unitPrice is provided, subtotal = unitPrice * qty
      // - Else if totalPrice provided, subtotal = totalPrice (already for whole order)
      // - Else if basePrice provided, treat it as a whole-order amount
      let subtotal;
      if (typeof data.unitPrice === 'number' && data.unitPrice > 0) {
        subtotal = (data.unitPrice * quantity) + serviceFee;
      } else if (typeof data.totalPrice === 'number' && data.totalPrice > 0) {
        subtotal = data.totalPrice + serviceFee;
      } else if (typeof data.basePrice === 'number' && data.basePrice > 0) {
        subtotal = data.basePrice + serviceFee;
      } else {
        subtotal = 0;
      }

      // Full amount before delivery should be the subtotal (for full) or 50% of it (for downpayment)
      let displayAmount;
      if (paymentOption === 'downpayment') {
        // Downpayment is 50% of (items + selected delivery fee)
        displayAmount = (subtotal + selectedDeliveryFee) * 0.5;
      } else if (paymentOption === 'balance') {
        const totalWithOriginalDelivery = subtotal + previousDeliveryFee;
        // If DB didn't store the paid amount (older orders), infer 50%
        let alreadyPaid = Number(data.alreadyPaidAmount || 0);
        if (!alreadyPaid || alreadyPaid <= 0) {
          alreadyPaid = totalWithOriginalDelivery * 0.5;
        }
        displayAmount = Math.max(totalWithOriginalDelivery - alreadyPaid, 0);
      } else {
        displayAmount = subtotal + selectedDeliveryFee;
      }

      // Update displays
      function round2(v){ return Math.round((v + Number.EPSILON) * 100) / 100; }
      // Display numbers with two decimals and currency formatting
      document.getElementById('base-price').textContent = subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      // For balance payments, surface 0 and note that fee was already included before
      const effectiveDelivery = paymentOption === 'balance' ? 0 : selectedDeliveryFee;
      document.getElementById('delivery-fee-amount').textContent = peso(effectiveDelivery);
      // Update the delivery price on the Standard Delivery card (show only number)
      const feeCard = document.getElementById('fee-standard-services');
      if (feeCard) feeCard.textContent = effectiveDelivery.toLocaleString();

      // VAT computation: applies to subtotal only (after discounts). For services, discounts rarely present.
      const totalVat = round2(subtotal * 0.12);
      let vatForDisplay = totalVat;
      if (paymentOption === 'downpayment') {
        vatForDisplay = round2(totalVat * 0.5);
      } else if (paymentOption === 'balance') {
        let alreadyPaid = Number(data.alreadyPaidAmount || 0);
        if (!alreadyPaid || alreadyPaid <= 0) {
          alreadyPaid = (subtotal + previousDeliveryFee) * 0.5;
        }
        const denom = (subtotal + previousDeliveryFee) || 1;
        const proportionPaid = Math.min(Math.max(alreadyPaid / denom, 0), 1);
        const vatPaid = round2(totalVat * proportionPaid);
        vatForDisplay = Math.max(round2(totalVat - vatPaid), 0);
      }

      // Final displayed total includes VAT (VAT not applied to delivery fee)
      const finalDisplayedTotal = round2(displayAmount + vatForDisplay);
      document.getElementById('vat-services').textContent = vatForDisplay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      // Display total with two decimals and include currency symbol in UI wrapper
      document.getElementById('total-amount').textContent = finalDisplayedTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      // Remove existing payment option badge if any
      const existingBadge = document.querySelector('.payment-option-badge');
      if (existingBadge) existingBadge.remove();
      
      // Show payment option badge (add after billing summary)
      const billingSection = document.getElementById('total-amount').closest('section');
      if (paymentOption === 'downpayment') {
        const badge = document.createElement('div');
        badge.className = 'payment-option-badge bg-yellow-50 border border-yellow-300 rounded-lg p-3 text-xs text-yellow-800 mt-3';
        badge.innerHTML = '<i class="fas fa-info-circle mr-1"></i><strong>50% Downpayment</strong> - Remaining balance due after production starts';
        billingSection.querySelector('.space-y-3').after(badge);
      } else if (paymentOption === 'full') {
        const badge = document.createElement('div');
        badge.className = 'payment-option-badge bg-green-50 border border-green-300 rounded-lg p-3 text-xs text-green-800 mt-3';
        badge.innerHTML = '<i class="fas fa-check-circle mr-1"></i><strong>100% Full Payment</strong> - Complete payment, no balance due';
        billingSection.querySelector('.space-y-3').after(badge);
      } else if (paymentOption === 'balance') {
        const badge = document.createElement('div');
        badge.className = 'payment-option-badge bg-purple-50 border border-purple-300 rounded-lg p-3 text-xs text-purple-800 mt-3';
        let alreadyPaid = Number(data.alreadyPaidAmount || 0);
        if (!alreadyPaid || alreadyPaid <= 0) {
          alreadyPaid = (subtotal + previousDeliveryFee) * 0.5;
        }
        badge.innerHTML = `<i class=\"fas fa-wallet mr-1\"></i><strong>Remaining Balance</strong> ‚Äî Previous payment: ‚Ç±${alreadyPaid.toLocaleString()}. Delivery fee already included previously.`;
        billingSection.querySelector('.space-y-3').after(badge);
      }
    }

    /**
     * Fetch user profile to pre-fill contact form and shipping address
     */
    async function fetchUserProfile() {
      const token = localStorage.getItem('token');
      
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });
        
        if (!res.ok) throw new Error('Failed to fetch profile');
        
        const json = await res.json();
        if (json.success && json.data) {
          const user = json.data;
          
          // Fill contact information
          document.getElementById('contact-name').value = user.name || '';
          document.getElementById('contact-email').value = user.email || '';
          document.getElementById('contact-phone').value = user.contactNumber || '';
          
          // Fill shipping address if available
            if (user.address) {
            document.getElementById('ship-block').value = user.address.block || '';
            document.getElementById('ship-lot').value = user.address.lot || '';
            document.getElementById('ship-street').value = user.address.street || '';
            document.getElementById('ship-building').value = user.address.building || '';
            // ship-province is now a select; try to match an existing option
            const provSel = document.getElementById('ship-province');
            if (provSel) {
              const prov = (user.address.province || '').toString();
              const match = Array.from(provSel.options).find(o => o.text.toLowerCase().includes(prov.toLowerCase()));
              if (match) provSel.value = match.text; else provSel.value = prov || '';
              // Recompute displayed fees when we populate the province
              try { updatePaymentAmounts(serviceData || {}); } catch (e) { /* ignore */ }
            }
            document.getElementById('ship-city').value = user.address.city || '';
            document.getElementById('ship-zip').value = user.address.zip || '';
            document.getElementById('ship-phone').value = user.address.phone || user.contactNumber || '';
          }
        }
      } catch (err) {
        console.error('Error fetching user profile:', err);
        // Non-blocking error - user can still fill form manually
      }
    }

    /**
     * Handle payment submission
     */
    async function handlePaymentSubmit(e) {
      e.preventDefault();
      
      const btn = document.getElementById('proceed-payment-btn');
      const originalBtnText = btn.innerHTML;
      
      // Validation
      if (!validateForm()) return;
      
      // Show loading state
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
      hideMessages();

      const token = localStorage.getItem('token');
      
      try {
        // Get selected payment method
        const paymentMethod = document.getElementById('pay-card')?.checked ? 'card' : 'gcash';
        
        // Get delivery method and fee
        const deliveryMethodElem = document.querySelector('input[name="delivery-method"]:checked');
        const paymentOption = serviceData.paymentOption || 'full';
        const deliveryMethod = paymentOption === 'balance'
          ? (serviceData.shippingMethod || 'Standard')
          : (deliveryMethodElem?.value === 'pickup' ? 'Pick-Up' : 'Standard');
        // Do not pass a new delivery fee for remaining-balance payments
        let deliveryFee = 0;
        if (paymentOption === 'balance') {
          deliveryFee = 0;
        } else if (deliveryMethod === 'Pick-Up') {
          deliveryFee = 0;
        } else {
          // compute from selected province (client-side estimate)
          const selProv = document.getElementById('ship-province')?.value || '';
          function clientRateForProvinceSimple(prov){
            const key = (prov||'').toString().toLowerCase();
            if(key.includes('cavite')) return 70;
            if(key.includes('laguna')) return 80;
            if(key.includes('batangas')) return 120;
            if(key.includes('metro')||key.includes('manila')||key.includes('quezon city')||key.includes('makati')) return 120;
            return 120;
          }
          deliveryFee = clientRateForProvinceSimple(selProv);
        }
        
        // Get shipping address (only if not pick-up)
        let shippingAddress = null;
        if (deliveryMethod === 'Standard') {
          const useDefault = document.getElementById('address-default')?.checked;
          shippingAddress = {
            block: document.getElementById('ship-block').value.trim(),
            lot: document.getElementById('ship-lot').value.trim(),
            street: document.getElementById('ship-street').value.trim(),
            building: document.getElementById('ship-building').value.trim(),
            province: document.getElementById('ship-province').value.trim(),
            city: document.getElementById('ship-city').value.trim(),
            zip: document.getElementById('ship-zip').value.trim(),
            phone: document.getElementById('ship-phone').value.trim()
          };
        }
        
        // Calculate charge amount
        const baseAmount = Number(serviceData.totalPrice || 0);
        const previousDeliveryFee = Number(serviceData.previousDeliveryFee || 0);
        const totalAmountWithDelivery = baseAmount + (paymentOption === 'balance' ? previousDeliveryFee : deliveryFee);
        let finalAmount;
        if (paymentOption === 'downpayment') {
          finalAmount = totalAmountWithDelivery * 0.5;
        } else if (paymentOption === 'balance') {
          let alreadyPaid = Number(serviceData.alreadyPaidAmount || 0);
          if (!alreadyPaid || alreadyPaid <= 0) {
            // Infer 50% already paid when DB does not have it
            alreadyPaid = (baseAmount + previousDeliveryFee) * 0.5;
          }
          finalAmount = Math.max((baseAmount + previousDeliveryFee) - alreadyPaid, 0);
        } else {
          finalAmount = totalAmountWithDelivery;
        }

        // VAT on subtotal only (not on delivery). Handle downpayment/balance proportionally.
        function round2(v){ return Math.round((v + Number.EPSILON) * 100) / 100; }
        const totalVat = round2(baseAmount * 0.12);
        let vatForCharge = totalVat;
        if (paymentOption === 'downpayment') vatForCharge = round2(totalVat * 0.5);
        else if (paymentOption === 'balance') {
          let alreadyPaid = Number(serviceData.alreadyPaidAmount || 0);
          if (!alreadyPaid || alreadyPaid <= 0) alreadyPaid = (baseAmount + previousDeliveryFee) * 0.5;
          const denom = (baseAmount + previousDeliveryFee) || 1;
          const proportionPaid = Math.min(Math.max(alreadyPaid / denom, 0), 1);
          const vatPaid = round2(totalVat * proportionPaid);
          vatForCharge = Math.max(round2(totalVat - vatPaid), 0);
        }

        const finalCharge = round2(finalAmount + vatForCharge);

        // Prepare payment payload
        const payload = {
          orderId: serviceData.orderId || null,
          orderReference: orderReference,
          serviceType: serviceData.serviceType || 'customize-jersey',
          // Amount for server/PayMongo: integer cents
          amount: Math.round(finalCharge * 100),
          // Human-readable amount
          amountDisplay: finalCharge,
          vatAmount: vatForCharge,
          vatCents: Math.round(vatForCharge * 100),
          baseAmount: baseAmount,
          deliveryFee: deliveryFee,
          deliveryFeeCents: Math.round(deliveryFee * 100),
          paymentMethod: paymentMethod,
          paymentOption: paymentOption, // 'downpayment' | 'full' | 'balance'
          shippingMethod: deliveryMethod,
          shippingAddress: shippingAddress,
          customerInfo: {
            name: document.getElementById('contact-name').value.trim(),
            email: document.getElementById('contact-email').value.trim(),
            phone: document.getElementById('contact-phone').value.trim(),
            notes: document.getElementById('contact-notes').value.trim()
          },
          serviceData: serviceData
          // successUrl and cancelUrl will be generated by backend with proper order reference
        };

        // Create PayMongo checkout session
        const res = await fetch(`${API_BASE}/api/payments/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (!res.ok) {
          throw new Error(json.msg || json.error || `Server returned ${res.status}`);
        }

        if (json.success && json.data && json.data.checkoutUrl) {
          // Clear pending checkout data
          localStorage.removeItem('pendingServiceCheckout');
          
          // Store order ID for success page
          if (json.data.orderId) {
            localStorage.setItem('lastOrderId', json.data.orderId);
          }
          
          // Redirect to PayMongo checkout
          showSuccess('Redirecting to secure payment page...');
          setTimeout(() => {
            window.location.href = json.data.checkoutUrl;
          }, 1000);
        } else {
          throw new Error('Invalid response from payment gateway');
        }

      } catch (err) {
        console.error('Payment submission error:', err);
        showError(err.message || 'Failed to process payment. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
      }
    }

    /**
     * Validate checkout form
     */
    function validateForm() {
      const name = document.getElementById('contact-name').value.trim();
      const email = document.getElementById('contact-email').value.trim();
      const phone = document.getElementById('contact-phone').value.trim();
      const agreeTerms = document.getElementById('agree-terms').checked;

      if (!name) {
        showError('Please enter your full name.');
        document.getElementById('contact-name').focus();
        return false;
      }

      if (!email || !isValidEmail(email)) {
        showError('Please enter a valid email address.');
        document.getElementById('contact-email').focus();
        return false;
      }

      if (!phone) {
        showError('Please enter your phone number.');
        document.getElementById('contact-phone').focus();
        return false;
      }
      
      // Validate shipping address if Standard Delivery is selected
      const deliveryMethodElem = document.querySelector('input[name="delivery-method"]:checked');
      const deliveryMethod = deliveryMethodElem?.value;
      const paymentOption = (serviceData && serviceData.paymentOption) || 'full';
      
      if (paymentOption !== 'balance' && deliveryMethod === 'standard') {
        const street = document.getElementById('ship-street').value.trim();
        const province = document.getElementById('ship-province').value.trim();
        const city = document.getElementById('ship-city').value.trim();
        const zip = document.getElementById('ship-zip').value.trim();
        const shipPhone = document.getElementById('ship-phone').value.trim();
        
        if (!street) {
          showError('Please enter your street address.');
          document.getElementById('ship-street').focus();
          return false;
        }
        
        if (!province) {
          showError('Please select your province.');
          document.getElementById('ship-province').focus();
          return false;
        }
        
        if (!city) {
          showError('Please enter your city.');
          document.getElementById('ship-city').focus();
          return false;
        }
        
        if (!zip) {
          showError('Please enter your ZIP code.');
          document.getElementById('ship-zip').focus();
          return false;
        }
        
        if (!shipPhone) {
          showError('Please enter your contact number for delivery.');
          document.getElementById('ship-phone').focus();
          return false;
        }
      }

      if (!agreeTerms) {
        showError('Please agree to the Terms of Service and Privacy Policy.');
        return false;
      }

      return true;
    }

    /**
     * Validate email format
     */
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    /**
     * Show error message
     */
    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
      
      // Scroll to message
      errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    /**
     * Show success message
     */
    function showSuccess(message) {
      const successEl = document.getElementById('success-message');
      successEl.textContent = message;
      successEl.classList.remove('hidden');
    }

    /**
     * Hide all messages
     */
    function hideMessages() {
      document.getElementById('error-message').classList.add('hidden');
      document.getElementById('success-message').classList.add('hidden');
    }
  </script>

  <!-- Socket.io Client -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <!-- Chat Widget -->
  <script src="js/chat.js"></script>
</body>
</html>
