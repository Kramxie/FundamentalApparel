<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Successful - Fundamental Apparel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes checkmark {
      0% { stroke-dashoffset: 100; }
      100% { stroke-dashoffset: 0; }
    }
    .checkmark-circle { animation: checkmark 0.6s ease-in-out; }
  </style>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-gray-800"><a href="index.html">Fundamental</a></div>
    </nav>
  </header>

  <main class="container mx-auto px-4 py-16">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-2xl shadow-lg p-8 md:p-12 text-center">
        <!-- Success Icon -->
        <div class="mb-6 flex justify-center">
          <svg class="w-24 h-24 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle class="checkmark-circle" cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="100" stroke-dashoffset="0" fill="none"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
          </svg>
        </div>

        <!-- Title -->
        <h1 class="text-3xl font-bold text-gray-900 mb-3">
          <i class="fas fa-check-circle text-green-500"></i>
          Payment Successful!
        </h1>
        
        <p class="text-gray-600 mb-6">
          Thank you for your payment. Your order has been confirmed.
        </p>

        <!-- Order Details -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6 text-left">
          <h2 class="font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-receipt mr-2 text-indigo-600"></i>
            Order Details
          </h2>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Order Reference:</span>
              <span class="font-medium" id="order-reference">Loading...</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Payment Status:</span>
              <span class="font-medium text-green-600">Paid</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Order Status:</span>
              <span class="font-medium" id="order-status">
                <i class="fas fa-sync fa-spin mr-1"></i>
                Verifying payment...
              </span>
            </div>
          </div>
        </div>

        <!-- Status Message (dynamically updated) -->
        <div id="status-message" class="mb-6"></div>

        <!-- Next Steps -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6 mb-6 text-left">
          <h3 class="font-semibold text-indigo-900 mb-3 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            What's Next?
          </h3>
          <ol class="list-decimal list-inside space-y-2 text-sm text-indigo-800">
            <li>Our team will review your custom design requirements</li>
            <li>We'll send you updates via email and notifications</li>
            <li>Production will begin once the design is approved</li>
            <li>You'll receive tracking information when your order ships</li>
          </ol>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a id="view-orders-btn" href="my-quotes.html" class="inline-flex items-center justify-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-user mr-2"></i>
            View My Orders
          </a>
            <button id="request-return-btn" class="inline-flex items-center justify-center px-6 py-3 bg-white text-red-600 font-semibold rounded-lg border-2 border-red-600 hover:bg-red-50 transition">
              <i class="fas fa-undo mr-2"></i>
              Request Return / Refund
            </button>
            <a href="services.html" class="inline-flex items-center justify-center px-6 py-3 bg-white text-indigo-600 font-semibold rounded-lg border-2 border-indigo-600 hover:bg-indigo-50 transition">
              <i class="fas fa-plus mr-2"></i>
              New Order
            </a>
          <a href="index.html" class="inline-flex items-center justify-center px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition">
            <i class="fas fa-home mr-2"></i>
            Home
          </a>
        </div>

        <!-- Support -->
        <div class="mt-8 pt-6 border-t text-sm text-gray-600">
          <p>Need help? <a href="#" class="text-indigo-600 hover:underline font-medium">Contact Support</a></p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = 'https://unmumbled-balloonlike-gayle.ngrok-free.dev';
    // Parse URL params once (must be globally accessible)
    const URL_PARAMS = new URLSearchParams(window.location.search);
    const ORDER_REF = URL_PARAMS.get('ref');
    const TYPE_PARAM = URL_PARAMS.get('type'); // 'order' for product orders, else service payment type
    const ORDER_ID_PARAM = URL_PARAMS.get('oid');
        document.getElementById('view-orders-btn').href = 'profile.html?tab=orders';
        // enable return button and bind order id
        try {
          const rb = document.getElementById('request-return-btn');
          if (rb) {
            rb.dataset.orderId = order._id;
            rb.classList.remove('hidden');
            rb.addEventListener('click', openReturnModal);
          }
        } catch (e) { console.error('Return button bind error', e); }
    const SESSION_ID_PARAM = URL_PARAMS.get('sid');

    document.addEventListener('DOMContentLoaded', () => {
      if (ORDER_REF) {
        document.getElementById('order-reference').textContent = ORDER_REF;
        const viewBtn = document.getElementById('view-orders-btn');
        if (viewBtn) viewBtn.href = `my-quotes.html?payment=success&ref=${encodeURIComponent(ORDER_REF)}`;
        syncAndFetchOrder(ORDER_REF, TYPE_PARAM);
      } else {
        document.getElementById('order-reference').textContent = 'N/A';
        document.getElementById('order-status').textContent = 'Processing';
      }
      localStorage.removeItem('pendingServiceCheckout');
      localStorage.removeItem('lastOrderId');
    });

    async function syncAndFetchOrder(orderRef, typeParam) {
      const token = localStorage.getItem('token');
      if (!token) {
        showError('Please log in to view order details');
        return;
      }

      try {
        const orderType = typeParam; // reuse parsed param
        let order;
        let orderId = ORDER_ID_PARAM; // may be null if older success URL
        
        // Check if this is a regular order (product) or custom order (service)
        if (orderType === 'order') {
          // Prefer direct fetch by orderId if provided
          if (orderId) {
            const singleRes = await fetch(`${API_BASE}/api/orders/${orderId}`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'ngrok-skip-browser-warning': 'true'
              }
            });
            if (singleRes.ok) {
              const singleData = await singleRes.json();
              if (singleData.success) {
                order = singleData.data;
              }
            }
          }

          // Fallback: list and match by reference
          // Fetch regular product orders
          const listRes = await fetch(`${API_BASE}/api/orders/myorders`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'ngrok-skip-browser-warning': 'true'
            }
          });

          if (!listRes.ok) {
            throw new Error('Failed to fetch orders');
          }

          const listData = await listRes.json();
          if (!listData.success || !listData.data) {
            throw new Error('No orders found');
          }

          if (!order) {
            // Find order by reference (last 8 chars of _id)
            order = listData.data.find(o => {
              const oidStr = (o._id || '').toString();
              const last8 = oidStr.slice(-8).toUpperCase();
              return last8 === orderRef.toUpperCase();
            });
          }

          // Secondary fallback: paymentIntentId/session match
          if (!order && SESSION_ID_PARAM) {
            order = listData.data.find(o => o.paymentIntentId === SESSION_ID_PARAM);
          }

          if (!order) {
            console.error('[Payment Success] Product order not found for ref:', orderRef);
            document.getElementById('order-status').innerHTML = '<span class="text-red-600">Order not found</span>';
            showError('Order not found. Please check your orders page.');
            return;
          }
          
          console.log('[Payment Success] Found product order:', order._id, 'Status:', order.status, 'Payment:', order.paymentStatus);

          // Update UI immediately with initial status
          document.getElementById('order-reference').textContent = orderRef;
          const statusEl = document.getElementById('order-status');
          statusEl.innerHTML = `<span class="text-yellow-600"><i class="fas fa-sync fa-spin mr-1"></i>Confirming...</span>`;
          
          const messageEl = document.getElementById('status-message');
          messageEl.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
              <h3 class="font-semibold text-blue-900 mb-2 flex items-center">
                <i class="fas fa-hourglass-half mr-2"></i>
                Processing Payment...
              </h3>
              <p class="text-sm text-blue-800">
                We're confirming your payment with the payment processor. This usually takes a few seconds.
              </p>
            </div>
          `;

          // Trigger payment sync (manual) if payment status still Pending
          setTimeout(async () => {
            try {
              const syncRes = await fetch(`${API_BASE}/api/payments/sync/${order._id}`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'ngrok-skip-browser-warning': 'true'
                }
              });
              
              if (syncRes.ok) {
                const syncData = await syncRes.json();
                console.log('[Payment Success] Sync result:', syncData);
                
                // Refresh order data
                const refreshRes = await fetch(`${API_BASE}/api/orders/myorders`, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                  }
                });
                
                if (refreshRes.ok) {
                  const refreshData = await refreshRes.json();
                  const refreshedOrder = refreshData.data.find(o => o._id === order._id);
                  if (refreshedOrder) {
                    order = refreshedOrder;
                  }
                }
                
                // Update UI with final status
                statusEl.innerHTML = `<span class="text-green-600">${order.status}</span>`;
                
                messageEl.innerHTML = `
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                    <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                      <i class="fas fa-check-circle mr-2"></i>
                      Order Confirmed!
                    </h3>
                    <p class="text-sm text-green-800">
                      Your payment has been received and confirmed. Your order is now being processed.
                      You'll receive tracking information when your order ships.
                    </p>
                  </div>
                `;
              } else {
                // Sync failed but show order anyway
                statusEl.innerHTML = `<span class="text-green-600">${order.status}</span>`;
                messageEl.innerHTML = `
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                    <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                      <i class="fas fa-check-circle mr-2"></i>
                      Payment Received!
                    </h3>
                    <p class="text-sm text-green-800">
                      Your payment has been received. Your order will be processed shortly.
                    </p>
                  </div>
                `;
              }
            } catch (syncError) {
              console.error('[Payment Success] Sync error:', syncError);
              // Show order status anyway
              statusEl.innerHTML = `<span class="text-green-600">${order.status}</span>`;
              messageEl.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                  <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Payment Received!
                  </h3>
                  <p class="text-sm text-green-800">
                    Your payment has been received. Your order will be processed shortly.
                  </p>
                </div>
              `;
            }
          }, 2000); // Wait 2 seconds for webhook to process

          // Change button to view regular orders
          document.getElementById('view-orders-btn').href = 'profile.html?tab=orders';
          
          return;
        }
        
        // Otherwise, fetch custom orders (services)
        const listRes = await fetch(`${API_BASE}/api/custom-orders/my-custom-orders`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });

        if (!listRes.ok) {
          throw new Error('Failed to fetch orders');
        }

        const listData = await listRes.json();
        if (!listData.success || !listData.data) {
          throw new Error('No orders found');
        }

        // Find order by reference (last 8 chars of _id)
        order = listData.data.find(o => {
          const orderId = (o._id || '').toString();
          const last8 = orderId.slice(-8).toUpperCase();
          return last8 === orderRef.toUpperCase();
        });

        if (!order) {
          console.error('[Payment Success] Order not found for ref:', orderRef);
          console.log('[Payment Success] Available orders:', listData.data.map(o => ({
            id: o._id,
            ref: (o._id || '').toString().slice(-8).toUpperCase()
          })));
          showError('Order not found');
          return;
        }
        
        console.log('[Payment Success] Found order:', order._id, 'Status:', order.status);

        // Step 2: Trigger payment sync
        const syncRes = await fetch(`${API_BASE}/api/payments/sync/${order._id}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'ngrok-skip-browser-warning': 'true'
          }
        });

        const syncData = await syncRes.json();

        // Step 3: Update UI based on sync result
        if (syncData.success) {
          const status = syncData.data.status;
          const paymentTypeActual = syncData.data.paymentType;
          
          // Update order status display
          const statusEl = document.getElementById('order-status');
          statusEl.innerHTML = `<span class="text-green-600">${status}</span>`;
          
          // Show appropriate message based on payment type and status
          const messageEl = document.getElementById('status-message');
          
          if (status === 'Pending Downpayment') {
            // Downpayment received, waiting for admin to verify
            if (paymentTypeActual === 'full') {
              messageEl.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                  <h3 class="font-semibold text-blue-900 mb-2 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Full Payment Received!
                  </h3>
                  <p class="text-sm text-blue-800">
                    Your 100% payment has been received. Our admin team is verifying it now. 
                    Once verified, your order will move to production.
                  </p>
                  <p class="text-xs text-blue-700 mt-2">Redirecting to your orders page...</p>
                </div>
              `;
            } else {
              messageEl.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                  <h3 class="font-semibold text-blue-900 mb-2 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Downpayment Received!
                  </h3>
                  <p class="text-sm text-blue-800">
                    Your 50% downpayment has been received. Our admin team is verifying it now. 
                    Once verified, your order will move to production.
                  </p>
                  <p class="text-xs text-blue-700 mt-2">Redirecting to your orders page...</p>
                </div>
              `;
            }
            // Auto-redirect after 3 seconds
            setTimeout(() => window.location.href = 'my-quotes.html', 3000);
          }
          else if (status === 'In Production') {
            if (paymentTypeActual === 'full') {
              messageEl.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                  <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Full Payment Verified!
                  </h3>
                  <p class="text-sm text-green-800">
                    Your 100% payment has been confirmed. Your order is now in production. 
                    You'll receive updates as it progresses.
                  </p>
                  <p class="text-xs text-green-700 mt-2">Redirecting to your orders page...</p>
                </div>
              `;
              // Auto-redirect after 3 seconds
              setTimeout(() => window.location.href = 'my-quotes.html', 3000);
            } else {
              messageEl.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                  <h3 class="font-semibold text-green-900 mb-2 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Downpayment Verified!
                  </h3>
                  <p class="text-sm text-green-800">
                    Your 50% downpayment has been confirmed. Your order is now in production. 
                    You'll be notified when the final balance is due.
                  </p>
                  <p class="text-xs text-green-700 mt-2">Redirecting to your orders page...</p>
                </div>
              `;
              // Auto-redirect after 3 seconds
              setTimeout(() => window.location.href = 'my-quotes.html', 3000);
            }
          } else if (status === 'Pending Final Verification') {
            messageEl.innerHTML = `
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-left">
                <h3 class="font-semibold text-purple-900 mb-2 flex items-center">
                  <i class="fas fa-check-circle mr-2"></i>
                  Final Payment Received!
                </h3>
                <p class="text-sm text-purple-800">
                  Your final payment has been received successfully. Our admin team is verifying it now. 
                  You'll be notified once verified and your order will be ready for fulfillment.
                </p>
                <p class="text-xs text-purple-700 mt-2">Redirecting to your orders page...</p>
              </div>
            `;
            // Auto-redirect after 3 seconds
            setTimeout(() => window.location.href = 'my-quotes.html', 3000);
          } else {
            messageEl.innerHTML = `
              <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 text-left">
                <h3 class="font-semibold text-indigo-900 mb-2 flex items-center">
                  <i class="fas fa-info-circle mr-2"></i>
                  Payment Confirmed
                </h3>
                <p class="text-sm text-indigo-800">
                  Your payment has been received and is being processed. Check your orders page for updates.
                </p>
              </div>
            `;
          }
        } else {
          // Sync failed or payment still pending
          showWarning('Payment is being processed. Please check your orders page in a moment.');
        }

      } catch (err) {
        console.error('Error syncing payment:', err);
        showError('Unable to verify payment status. Please check your orders page.');
      }
    }

    function showError(message) {
      const statusEl = document.getElementById('order-status');
      statusEl.innerHTML = `<span class="text-yellow-600">Verifying...</span>`;
      
      const messageEl = document.getElementById('status-message');
      messageEl.innerHTML = `
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-left">
          <p class="text-sm text-yellow-800">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            ${message}
          </p>
        </div>
      `;
    }

    function showWarning(message) {
      const statusEl = document.getElementById('order-status');
      statusEl.innerHTML = `<span class="text-blue-600">Processing...</span>`;
      
      const messageEl = document.getElementById('status-message');
      messageEl.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
          <p class="text-sm text-blue-800">
            <i class="fas fa-clock mr-2"></i>
            ${message}
          </p>
        </div>
      `;
    }

      /* Return Request Modal */
      // inject modal into DOM
      (function createReturnModal() {
        const html = `
        <div id="return-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
          <div class="bg-white rounded-lg shadow max-w-2xl w-full overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b">
              <h3 class="font-semibold text-gray-800">Request Return / Refund</h3>
              <button id="return-modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Reason</label>
                <input id="return-reason" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="e.g. Wrong size received" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Details (optional)</label>
                <textarea id="return-details" class="mt-1 block w-full border rounded px-3 py-2" rows="3"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Upload video (optional, mp4/mov/webm)</label>
                <input id="return-videos" type="file" accept="video/*" multiple class="mt-1" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Upload images (optional)</label>
                <input id="return-images" type="file" accept="image/*" multiple class="mt-1" />
              </div>
              <div id="return-error" class="text-sm text-red-600 hidden"></div>
            </div>
            <div class="px-5 py-3 border-t flex items-center justify-end gap-3">
              <button id="return-submit" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded">Submit Request</button>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        document.getElementById('return-modal-close').addEventListener('click', closeReturnModal);
        document.getElementById('return-submit').addEventListener('click', submitReturnRequest);
      })();

      function openReturnModal(e) {
        const btn = e.currentTarget || e;
        const orderId = btn.dataset ? btn.dataset.orderId : null;
        const modal = document.getElementById('return-modal');
        if (!orderId) {
          document.getElementById('return-error').textContent = 'Order ID missing. Cannot request return.';
          document.getElementById('return-error').classList.remove('hidden');
          return;
        }
        modal.dataset.orderId = orderId;
        modal.classList.remove('hidden');
        document.getElementById('return-error').classList.add('hidden');
      }

      function closeReturnModal() {
        const modal = document.getElementById('return-modal');
        if (modal) modal.classList.add('hidden');
      }

      async function submitReturnRequest() {
        const modal = document.getElementById('return-modal');
        const orderId = modal.dataset.orderId;
        const reason = document.getElementById('return-reason').value.trim();
        const details = document.getElementById('return-details').value.trim();
        const videos = document.getElementById('return-videos').files;
        const images = document.getElementById('return-images').files;
        const errEl = document.getElementById('return-error');
        errEl.classList.add('hidden'); errEl.textContent = '';

        if (!reason) { errEl.textContent = 'Please provide a reason.'; errEl.classList.remove('hidden'); return; }
        const token = localStorage.getItem('token');
        if (!token) { errEl.textContent = 'Please log in to submit a return.'; errEl.classList.remove('hidden'); return; }

        const fd = new FormData();
        fd.append('reason', reason);
        fd.append('details', details);
        for (let i=0;i<videos.length;i++) fd.append('videos', videos[i]);
        for (let i=0;i<images.length;i++) fd.append('images', images[i]);

        try {
          const res = await fetch(`${API_BASE}/api/orders/${orderId}/returns`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: fd
          });
          const data = await res.json();
          if (!res.ok) {
            errEl.textContent = data.msg || JSON.stringify(data);
            errEl.classList.remove('hidden');
            return;
          }
          closeReturnModal();
          alert('Return request submitted. Admin will review it shortly.');
        } catch (e) {
          errEl.textContent = 'Failed to submit request. Try again later.';
          errEl.classList.remove('hidden');
          console.error('Submit return error', e);
        }
      }
  </script>
</body>
</html>
