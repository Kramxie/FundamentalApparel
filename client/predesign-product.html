<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pre-Design Product - Fundamental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
        
        /* Smooth transitions */
        .transition-all-300 { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-[#F3F4F6] min-h-screen flex flex-col">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold text-indigo-600 tracking-tight">Fundamental</a>
            <a href="services.html" class="text-sm font-medium text-gray-500 hover:text-indigo-600 flex items-center gap-2 transition">
                <i class="fas fa-arrow-left"></i> Back to Services
            </a>
        </div>
    </header>

    <div class="bg-[#F9FAFB] border-b border-gray-200 px-6 py-3 sticky top-[61px] z-40 shadow-sm bg-opacity-95 backdrop-blur-sm">
        <div class="max-w-[1800px] mx-auto flex flex-wrap items-center justify-between gap-4">
            
            <div class="flex items-center gap-3">
                <button id="team-mode-toggle" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-50 transition shadow-sm">
                    Team Mode: Off
                </button>
                <button id="team-names-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-50 transition shadow-sm">
                    Team Names
                </button>
                <button class="text-gray-400 hover:text-indigo-600 transition ml-2" title="Information">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-xs font-medium text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-md border border-indigo-100">
                    Quote: <span id="predesign-quote-status">Pending admin review</span>
                </div>
                <button id="predesign-submit-quote" class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 shadow-md transition flex items-center gap-2 transform active:scale-95">
                    <i class="fas fa-paper-plane"></i> Submit Quote
                </button>
            </div>
        </div>
    </div>

    <main class="flex-grow px-6 py-8 overflow-y-auto">
        <div class="max-w-[1800px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 h-full items-start">
            
            <div class="lg:col-span-3 flex flex-col gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Pre-Design Product</h3>
                    
                    <div class="bg-indigo-50 rounded-xl p-5 mb-5 border border-indigo-100 text-center group cursor-pointer" onclick="openProductCatalog()">
                        <p class="text-xs text-indigo-500 mb-1 font-semibold uppercase">Currently Selected</p>
                        <p id="predesign-selected-product" class="text-xl font-bold text-gray-900">Choose A Product</p>
                    </div>

                    <button id="change-product-btn" class="w-full py-3 bg-white text-indigo-600 border-2 border-indigo-100 rounded-xl font-bold hover:bg-indigo-50 hover:border-indigo-200 transition shadow-sm">
                        Change Product
                    </button>
    
                    <div id="predesign-size-stock" class="mt-4 bg-white border border-gray-100 rounded-xl p-3 text-sm text-gray-700 hidden">
                        <div class="text-xs font-semibold text-gray-500 uppercase mb-2">Stock by Size</div>
                        <div id="predesign-size-stock-list" class="space-y-1"></div>
                            <div id="predesign-size-debug" class="text-xs text-gray-400 mt-2"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 h-full min-h-[500px] flex flex-col relative">
                    <h3 class="text-sm font-bold text-gray-800 mb-4 flex justify-between items-center">
                        Pre-Design Preview
                        <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">Live Preview</span>
                    </h3>
                    
                    <div class="flex-grow bg-[#F8FAFC] rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden group transition-all hover:border-indigo-200">
                        <div id="predesign-selected-product-container" class="text-center p-6">
                            <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                                <i class="fas fa-tshirt text-4xl"></i>
                            </div>
                            <p class="text-gray-500 font-medium">No Product Selected</p>
                            <p class="text-gray-400 text-sm mt-1">Click "Change Product" to start</p>
                        </div>
                        
                        <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-medium text-gray-500 border shadow-sm pointer-events-none">
                            Preview Mode
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 h-fit">
                    <form id="predesign-form" class="space-y-5">
                        
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Printing Type</h3>
                            <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-lg hover:bg-white hover:shadow-sm cursor-pointer transition border border-transparent hover:border-gray-200">
                                    <input type="radio" name="printingType" value="Dye Sublimation" checked class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Dye Sublimation</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-white hover:shadow-sm cursor-pointer transition border border-transparent hover:border-gray-200">
                                    <input type="radio" name="printingType" value="Heat Transfer" class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Heat Transfer</span>
                                </label>
                                <label class="flex items-center p-2 rounded-lg hover:bg-white hover:shadow-sm cursor-pointer transition border border-transparent hover:border-gray-200">
                                    <input type="radio" name="printingType" value="Vinyl Print" class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Vinyl Print</span>
                                </label>
                            </div>
                        </div>

                        <hr class="border-gray-100">

                        <div class="flex gap-4">
                            <div class="w-1/3">
                                <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">QTY</label>
                                <input id="predesign-qty" name="quantity" type="number" min="1" value="1" 
                                    class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-center font-bold">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">Size</label>
                                <div class="relative">
                                    <select id="predesign-size" name="size" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 appearance-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition cursor-pointer">
                                        <option value="">Choose Size</option>
                                        <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                        <i class="fas fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">Placement Location</label>
                            <div class="flex gap-2" id="predesign-placement-group">
                                <button type="button" data-placement="Front" class="placement-btn flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-medium text-sm shadow-sm transition hover:bg-indigo-700">Front</button>
                                <button type="button" data-placement="Back" class="placement-btn flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-50 transition">Back</button>
                            </div>
                            <input type="hidden" id="predesign-placement" name="placement" value="Front" />
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">Team Name</label>
                            <input id="predesign-teamname" name="teamName" type="text" placeholder="Enter team name (Optional)" 
                                class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition placeholder-gray-400">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">First Name</label>
                                <input id="predesign-firstname" type="text" placeholder="Optional - e.g. Juan" 
                                    class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition placeholder-gray-400">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">Surname</label>
                                <input id="predesign-surname" type="text" placeholder="Optional - e.g. Dela Cruz" 
                                    class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition placeholder-gray-400">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">Jersey Number</label>
                            <input id="predesign-number" name="jerseyNumber" type="text" placeholder="Optional - e.g. 7" 
                                class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition placeholder-gray-400">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1.5 uppercase">Notes</label>
                            <textarea id="predesign-notes" name="notes" rows="3" placeholder="Special instructions for admin..." 
                                class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition placeholder-gray-400 resize-none"></textarea>
                        </div>

                        <button type="button" id="predesign-cancel" class="w-full py-2 text-gray-400 text-xs font-medium hover:text-red-600 transition">
                            Cancel and Return
                        </button>

                    </form>
                </div>
            </div>

        </div>
    </main>

    <script>
        const API = 'https://fundamental-apparel-backend.onrender.com'; 

        // --- Product Catalog Logic ---
        async function loadProductsForCatalog() {
            // Try to load predesign products from the API. Fall back to local list if API fails.
            try {
                const res = await fetch((API || '') + '/api/products?type=predesign');
                if (!res.ok) throw new Error('no api');
                const json = await res.json();
                const products = (json && json.data) ? json.data.map(p => ({
                    id: p._id || p.id,
                    name: p.name,
                    description: p.description,
                    category: p.category,
                    images: p.images || (p.imageUrl ? { front: p.imageUrl, back: p.imageUrl } : {}),
                    image: p.imageUrl || (p.images && p.images.front) || '',
                    sizesInventory: p.sizesInventory || {}
                })) : [];
                window.__predesign_all_products = products;
                return products;
            } catch (e) {
                // Fallback local list
                const fallback = [
                    { id: 'basic-jersey', name: 'Basic Jersey', description: 'Classic jersey', image: 'https://via.placeholder.com/300?text=Basic+Jersey', category: 'Jersey' },
                    { id: 'drifit-prod-1', name: 'Dri-Fit_1', description: 'High performance athletic wear', images: { front: '../images/predesign/drifit/product1/front.png', back: '../images/predesign/drifit/product1/back.png' }, image: '../images/predesign/drifit/product1/front.png', category: 'Dri-fit T-Shirts' },
                    { id: 'training-shorts', name: 'Training Shorts', description: 'Comfort shorts', image: 'https://via.placeholder.com/300?text=Shorts', category: 'Shorts' }
                ];
                window.__predesign_all_products = fallback;
                return fallback;
            }
        }

        function getOrCreateCatalogModal() {
            let modal = document.getElementById('product-catalog-modal');
            if (modal) return modal;
            modal = document.createElement('div');
            modal.id = 'product-catalog-modal';
            modal.className = 'hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 overflow-y-auto flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-5xl w-full my-8 flex flex-col shadow-2xl max-h-[90vh]">
                    <div class="flex justify-between items-center p-6 border-b border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800">Select Product</h3>
                        <button onclick="closeProductCatalog()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition"><i class="fas fa-times text-lg"></i></button>
                    </div>
                    <div class="flex-1 overflow-hidden flex">
                        <div class="w-64 bg-gray-50 border-r border-gray-100 p-4 overflow-y-auto hidden md:block">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">Categories</div>
                            <ul class="space-y-1" id="predesign-catalog-cats">
                                <li><button data-cat="All" onclick="selectCatalogCategory('All')" class="pred-catalog-cat w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 transition">All Products</button></li>
                                <li><button data-cat="Jersey" onclick="selectCatalogCategory('Jersey')" class="pred-catalog-cat w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition">Jersey</button></li>
                                <li><button data-cat="Shorts" onclick="selectCatalogCategory('Shorts')" class="pred-catalog-cat w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition">Shorts</button></li>
                                <li><button data-cat="Dri-fit T-Shirts" onclick="selectCatalogCategory('Dri-fit T-Shirts')" class="pred-catalog-cat w-full text-left px-4 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition">Dri-fit T-Shirts</button></li>
                            </ul>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto bg-white">
                            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        async function openProductCatalog() {
            const modal = getOrCreateCatalogModal();
            modal.classList.remove('hidden');
            const products = await loadProductsForCatalog();
            window.__predesign_all_products = products || [];
            selectCatalogCategory('All');
        }

        function closeProductCatalog() {
            const modal = document.getElementById('product-catalog-modal');
            if (modal) modal.classList.add('hidden');
        }

        function renderProductCatalog(products) {
            const grid = document.getElementById('products-grid');
            if (!grid) return;
            if (!products || products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400 flex flex-col items-center"><i class="fas fa-box-open text-4xl mb-3"></i><p>No products found</p></div>';
                return;
            }
            grid.innerHTML = products.map(p => `
                <div class="group bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg hover:border-indigo-200 transition cursor-pointer" onclick="selectProductFromCatalog('${p._id || p.id}')">
                    <div class="h-48 bg-gray-100 relative overflow-hidden">
                        ${p.image || p.imageUrl ? `<img src="${p.image || p.imageUrl}" alt="${p.name}" class="object-cover w-full h-full group-hover:scale-105 transition duration-500"/>` : '<div class="flex items-center justify-center h-full text-gray-300"><i class="fas fa-image text-3xl"></i></div>'}
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition"></div>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-gray-800 mb-1 truncate">${p.name}</h4>
                        <p class="text-xs text-gray-500 line-clamp-2">${p.description || 'No description'}</p>
                        <div class="mt-3 flex justify-end">
                            <span class="text-xs font-semibold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full group-hover:bg-indigo-600 group-hover:text-white transition">Select</span>
                        </div>
                    </div>
                </div>
            `).join('');
            window.__predesign_catalog = products.reduce((m,it)=>{m[it._id || it.id]=it;return m;},{});
        }

        function selectCatalogCategory(cat) {
            const buttons = document.querySelectorAll('.pred-catalog-cat');
            buttons.forEach(b => {
                const isMatch = b.dataset.cat === cat;
                b.classList.toggle('bg-indigo-50', isMatch);
                b.classList.toggle('text-indigo-600', isMatch);
                b.classList.toggle('text-gray-600', !isMatch);
                b.classList.toggle('hover:bg-gray-100', !isMatch);
            });

            const all = window.__predesign_all_products || [];
            if(cat === 'All') return renderProductCatalog(all);
            const filtered = all.filter(p => (p.category || '').toLowerCase() === cat.toLowerCase());
            renderProductCatalog(filtered);
        }

        async function selectProductFromCatalog(id) {
            const p = (window.__predesign_catalog && window.__predesign_catalog[id]);
            if (!p) return;

            const sel = document.getElementById('predesign-selected-product');
            sel.textContent = p.name;

            const container = document.getElementById('predesign-selected-product-container');
            // Prefer explicit front/back images if available; else fallback to single image
            const images = p.images || (p.image ? { front: p.image, back: p.image } : null);
            const placement = (document.getElementById('predesign-placement')?.value || 'Front').toLowerCase();
            const chosen = (images && (images[placement] || images.front)) || p.image || p.imageUrl || '';

            if (chosen) {
                container.innerHTML = `<img id="predesign-preview-img" src="${chosen}" alt="product" class="max-h-[350px] w-auto object-contain drop-shadow-lg" />`;
            } else {
                container.innerHTML = `<div class="text-center p-10"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h2 class="text-xl font-bold text-gray-800">${p.name}</h2></div>`;
            }

            const form = document.getElementById('predesign-form');
            form.dataset.productName = p.name;
            // store images for later (placement button switching)
            form.dataset.productImages = images ? JSON.stringify(images) : '';
            if (chosen) form.dataset.productImage = chosen;

            // Render per-size stock for customer visibility (fetch authoritative inventory if possible)
            try {
                const stockContainer = document.getElementById('predesign-size-stock');
                const stockList = document.getElementById('predesign-size-stock-list');
                const form = document.getElementById('predesign-form');

                // Helper: try to fetch inventory availability from backend (preferred)
                async function fetchInventoryAvailability() {
                    try {
                        // Prefer Inventory API by productId if available, else by name
                        const token = localStorage.getItem('token');
                        const headers = { 'Content-Type': 'application/json' };
                        if (token) headers['Authorization'] = 'Bearer ' + token;

                        // try by productId first
                        if (p._id) {
                            const url = (API || '') + '/api/admin/inventory/availability?id=' + encodeURIComponent(p._id);
                            const resp = await fetch(url, { headers });
                            if (resp.ok) return await resp.json();
                        }

                        // fallback by name (case-insensitive)
                        if (p.name) {
                            const url = (API || '') + '/api/admin/inventory/availability?name=' + encodeURIComponent(p.name);
                            const resp = await fetch(url, { headers });
                            if (resp.ok) return await resp.json();
                        }
                    } catch (err) {
                        // ignore fetch errors and fall back to product payload
                        console.warn('Inventory availability fetch failed:', err && err.message);
                    }
                    return null;
                }

                let inv = p.sizesInventory || {};
                // Attempt to fetch authoritative inventory (only if API reachable and user token present or endpoint allows public)
                let usedSource = 'productPayload';
                let fetchError = null;
                try {
                    const remote = await fetchInventoryAvailability();
                    if (remote && remote.success && remote.data) {
                        inv = remote.data.sizesInventory || {};
                        usedSource = 'inventoryAvailability';
                        // if backend returned inventory id/name, persist for debugging
                        if (form) {
                            form.dataset.inventoryId = remote.data.id || '';
                            form.dataset.inventoryName = remote.data.name || '';
                        }
                    } else if (remote && !remote.success && remote.error) {
                        fetchError = remote.error;
                    }
                } catch (e) { /* ignore */ }

                // If inventory availability wasn't available, try fetching the latest product document
                if (usedSource === 'productPayload' && p._id) {
                    try {
                        console.debug('[Predesign] Falling back to GET /api/products/:id for latest product data', p._id);
                        const resp = await fetch((API || '') + '/api/products/' + encodeURIComponent(p._id));
                        if (resp && resp.ok) {
                            const pj = await resp.json();
                            if (pj && pj.success && pj.data) {
                                const prodDoc = pj.data;
                                if (prodDoc.sizesInventory && Object.keys(prodDoc.sizesInventory || {}).length > 0) {
                                    inv = prodDoc.sizesInventory || {};
                                    usedSource = 'productEndpoint';
                                }
                            }
                        }
                    } catch (pfErr) {
                        console.debug('[Predesign] Product fetch fallback failed:', pfErr && pfErr.message);
                    }
                }

                console.debug('[Predesign] Using inventory source:', usedSource, 'sizes:', inv, 'fetchError:', fetchError);

                // Update debug UI element so it's visible without opening console
                try {
                    const debugEl = document.getElementById('predesign-size-debug');
                    if (debugEl) {
                        let msg = `Source: ${usedSource}`;
                        if (form && form.dataset.inventoryId) msg += ` • invId: ${form.dataset.inventoryId}`;
                        if (fetchError) msg += ` • err: ${escapeHtml(String(fetchError))}`;
                        debugEl.textContent = msg;
                    }
                } catch (uiErr) { /* ignore */ }

                // Persist sizesInventory on the form for client-side validation
                if (form) form.dataset.sizesInventory = JSON.stringify(inv || {});

                if (stockContainer && stockList) {
                    const allSizes = Object.keys(inv || {});
                    const positive = allSizes.filter(k => Number(inv[k] || 0) > 0);
                    const zeroOrMissing = allSizes.filter(k => Number(inv[k] || 0) <= 0);

                    if (positive.length > 0) {
                        stockList.innerHTML = positive.map(k => `
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${escapeHtml(k)}</span>
                                <span class="text-gray-600">${Number(inv[k] || 0)}</span>
                            </div>
                        `).join('');

                        if (zeroOrMissing.length > 0) {
                            stockList.innerHTML += `<div class="mt-2 text-xs font-semibold text-gray-400 uppercase">Out of stock</div>`;
                            stockList.innerHTML += zeroOrMissing.map(k => `
                                <div class="flex justify-between items-center text-gray-400">
                                    <span>${escapeHtml(k)}</span>
                                    <span>0</span>
                                </div>
                            `).join('');
                        }

                        stockContainer.classList.remove('hidden');
                    } else if (allSizes.length > 0) {
                        stockList.innerHTML = '<div class="text-gray-500">Currently out of stock for all sizes</div>';
                        stockContainer.classList.remove('hidden');
                    } else {
                        stockList.innerHTML = '<div class="text-gray-400">No stock information available</div>';
                        stockContainer.classList.remove('hidden');
                    }
                }

                // Populate size dropdown with only available sizes (qty > 0).
                try {
                    const sizeSelect = document.getElementById('predesign-size');
                    if (sizeSelect) {
                        // preserve default option
                        const defaultOpt = sizeSelect.querySelector('option[value=""]') ? sizeSelect.querySelector('option[value=""]').outerHTML : '<option value="">Choose Size</option>';
                        const opts = [defaultOpt];
                        const availableSizes = Object.keys(inv || {}).filter(s => Number(inv[s] || 0) > 0);
                        if (availableSizes.length > 0) {
                            availableSizes.forEach(sz => { opts.push(`<option value="${escapeHtml(sz)}">${escapeHtml(sz)}</option>`); });
                        } else {
                            // Fallback: show sizes but disabled if no inventory info
                            const fallback = ['XS','S','M','L','XL','XXL'];
                            fallback.forEach(sz => opts.push(`<option value="${sz}">${sz}</option>`));
                        }
                        sizeSelect.innerHTML = opts.join('');
                        // If there are available sizes, default to the first one and set qty limit
                        if (availableSizes && availableSizes.length) {
                            sizeSelect.value = availableSizes[0];
                            const qtyEl = document.getElementById('predesign-qty');
                            if (qtyEl) {
                                qtyEl.max = String(Math.max(1, Number(inv[sizeSelect.value] || 0)));
                                if (Number(qtyEl.value) > Number(qtyEl.max)) qtyEl.value = qtyEl.max;
                            }
                            try { sizeSelect.dispatchEvent(new Event('change')); } catch(e){}
                        }
                    }
                } catch (e) { /* ignore dropdown errors */ }

            } catch (e) { /* ignore UI errors */ }

            closeProductCatalog();
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Buttons
            document.getElementById('change-product-btn')?.addEventListener('click', openProductCatalog);
            document.getElementById('predesign-submit-quote')?.addEventListener('click', () => document.getElementById('predesign-form').requestSubmit());
            document.getElementById('predesign-cancel')?.addEventListener('click', () => window.location.href='services.html');
            
            // Team Names -> only open if Team Mode is ON; otherwise prompt the user
            document.getElementById('team-names-btn')?.addEventListener('click', (e) => {
                const form = document.getElementById('predesign-form');
                const mode = form?.dataset.teamMode === 'on' ? 'on' : 'off';
                if (mode === 'on') {
                    openTeamNamesModal();
                } else {
                    // show simple alert guiding the user to enable Team Mode first
                    alert('Enable Team Mode first');
                }
            });
            
            // Team Mode Toggle
            const teamBtn = document.getElementById('team-mode-toggle');
                if (teamBtn) {
                teamBtn.addEventListener('click', () => {
                    const isOff = teamBtn.textContent.includes('Off');
                    teamBtn.textContent = isOff ? 'Team Mode: On' : 'Team Mode: Off';
                    teamBtn.classList.toggle('bg-indigo-50', isOff);
                    teamBtn.classList.toggle('text-indigo-700', isOff);
                    teamBtn.classList.toggle('border-indigo-200', isOff);
                    const form = document.getElementById('predesign-form');
                    if (form) form.dataset.teamMode = isOff ? 'on' : 'off';
                });
            }
                // set initial teamMode flag on form
                const _form = document.getElementById('predesign-form');
                if (_form && typeof _form.dataset.teamMode === 'undefined') {
                    _form.dataset.teamMode = (teamBtn && teamBtn.textContent && teamBtn.textContent.includes('On')) ? 'on' : 'off';
                }

            // Placement Buttons Logic
            const placementBtns = document.querySelectorAll('.placement-btn');
            placementBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    placementBtns.forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white');
                        b.classList.add('bg-white', 'border', 'text-gray-700');
                    });
                    btn.classList.remove('bg-white', 'border', 'text-gray-700');
                    btn.classList.add('bg-indigo-600', 'text-white');
                    
                    const val = btn.getAttribute('data-placement') || 'Front';
                    const hidden = document.getElementById('predesign-placement');
                    if (hidden) hidden.value = val;

                    // If the selected product has front/back images, update preview accordingly
                    try {
                        const form = document.getElementById('predesign-form');
                        const images = form && form.dataset.productImages ? JSON.parse(form.dataset.productImages) : null;
                        const imgEl = document.getElementById('predesign-preview-img');
                        const key = (val || 'Front').toLowerCase();
                        const newSrc = (images && (images[key] || images.front)) || form?.dataset.productImage || '';
                        if (imgEl && newSrc) imgEl.src = newSrc;
                    } catch (e) {
                        // ignore JSON parse or missing image errors
                    }
                });
            });

            // Form Submit
            document.getElementById('predesign-form')?.addEventListener('submit', handlePreDesignFormSubmit);

            // Add validation listeners for size and quantity inputs
            const sizeEl = document.getElementById('predesign-size');
            const qtyEl = document.getElementById('predesign-qty');
            const formEl = document.getElementById('predesign-form');
            const errorEl = document.createElement('div');
            errorEl.id = 'predesign-form-error';
            errorEl.className = 'text-sm text-red-600 mt-2 hidden';
            qtyEl && qtyEl.parentNode && qtyEl.parentNode.appendChild(errorEl);

            function getSizesInventory() {
                try { return formEl && formEl.dataset.sizesInventory ? JSON.parse(formEl.dataset.sizesInventory) : {}; } catch(e){ return {}; }
            }

            function updateQtyLimitForSelectedSize() {
                const sizesInv = getSizesInventory();
                const selected = sizeEl ? (sizeEl.value || '') : '';
                if (selected && sizesInv && typeof sizesInv[selected] !== 'undefined') {
                    const available = Number(sizesInv[selected] || 0);
                    if (qtyEl) {
                        qtyEl.max = String(Math.max(1, available));
                        if (Number(qtyEl.value) > available) qtyEl.value = available || 1;
                    }
                    showFormErrorIfNeeded();
                } else {
                    if (qtyEl) qtyEl.removeAttribute('max');
                }
            }

            function showFormErrorIfNeeded(msg) {
                const e = document.getElementById('predesign-form-error');
                if (!e) return;
                if (typeof msg === 'string' && msg) {
                    e.textContent = msg;
                    e.classList.remove('hidden');
                } else {
                    // validate current values
                    const sizesInv = getSizesInventory();
                    const selected = sizeEl ? (sizeEl.value || '') : '';
                    if (formEl && formEl.dataset.teamMode === 'on') {
                        // team mode: ensure team entries counts per-size do not exceed available
                        let entries = [];
                        try { entries = JSON.parse(formEl.dataset.teamEntries || '[]'); } catch(e){ entries = []; }
                        const counts = {};
                        entries.forEach(en => { const s = en.size || ''; if (s) counts[s] = (counts[s]||0) + 1; });
                        const invalid = Object.keys(counts).filter(s => (Number(sizesInv[s]||0) < counts[s]));
                        if (invalid.length) {
                            e.textContent = `Team entries exceed stock for size(s): ${invalid.join(', ')}`;
                            e.classList.remove('hidden');
                            return true;
                        }
                        e.classList.add('hidden');
                        return false;
                    } else {
                        if (!selected) { e.classList.add('hidden'); return false; }
                        const available = Number(sizesInv[selected] || 0);
                        const qty = Number(qtyEl?.value || 0);
                        if (qty > available) {
                            e.textContent = `Quantity exceeds available stock (${available}) for size ${selected}`;
                            e.classList.remove('hidden');
                            return true;
                        }
                        e.classList.add('hidden');
                        return false;
                    }
                }
            }

            sizeEl && sizeEl.addEventListener('change', () => {
                updateQtyLimitForSelectedSize();
                // when team modal open, we should also update team entries options if present
            });

            qtyEl && qtyEl.addEventListener('input', () => {
                try {
                    const max = Number(qtyEl.max || Infinity);
                    let val = Number(qtyEl.value || 0) || 0;
                    if (val < 1) val = 1;
                    if (Number.isFinite(max) && val > max) val = max;
                    if (String(val) !== String(qtyEl.value)) qtyEl.value = String(val);
                } catch(e) { /* ignore clamping errors */ }
                showFormErrorIfNeeded();
            });

            // When team mode toggled, disable/enable qty input and validate
            const teamBtnEl = document.getElementById('team-mode-toggle');
            if (teamBtnEl) {
                teamBtnEl.addEventListener('click', () => {
                    setTimeout(() => {
                        const mode = formEl.dataset.teamMode === 'on' ? 'on' : 'off';
                        if (mode === 'on') {
                            if (qtyEl) { qtyEl.disabled = true; qtyEl.classList.add('opacity-60'); }
                        } else {
                            if (qtyEl) { qtyEl.disabled = false; qtyEl.classList.remove('opacity-60'); }
                        }
                        showFormErrorIfNeeded();
                    }, 10);
                });
                // set initial state
                if (formEl && formEl.dataset.teamMode === 'on') { if (qtyEl) { qtyEl.disabled = true; qtyEl.classList.add('opacity-60'); } }
            }
        });

        async function handlePreDesignFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const productName = form.dataset.productName || document.getElementById('predesign-selected-product')?.textContent;
            
            if (!productName || productName === 'Choose A Product') {
                alert('Please select a product first.');
                return;
            }

            const quantity = parseInt(document.getElementById('predesign-qty')?.value) || 1;
            const size = document.getElementById('predesign-size')?.value || '';
            const teamName = document.getElementById('predesign-teamname')?.value || form.dataset.teamNames || '';
            const firstName = document.getElementById('predesign-firstname')?.value || '';
            const surname = document.getElementById('predesign-surname')?.value || '';
            const jerseyNumber = document.getElementById('predesign-number')?.value || '';
            // If single buyer provided first/surname, combine into memberName
            const memberName = (firstName || surname) ? `${firstName}${firstName && surname ? ' ' : ''}${surname}`.trim() : '';
            const notes = document.getElementById('predesign-notes')?.value || '';
            const placement = document.getElementById('predesign-placement')?.value || 'Front';
            const printingType = document.querySelector('input[name="printingType"]:checked')?.value || 'Dye Sublimation';
            const productImage = form.dataset.productImage || '';

            const payload = { 
                serviceType: 'predesign-product', 
                productName, 
                productImage, 
                quantity, 
                size, 
                placement, 
                teamName, 
                notes,
                printingType,
                // include single-buyer fields (optional). Server will accept memberName and jerseyNumber when present.
                ...(memberName ? { memberName } : {}),
                ...(jerseyNumber ? { jerseyNumber } : {})
            };

            // include team entries if present (Team Mode)
            try {
                if (form.dataset.teamEntries) {
                    payload.teamEntries = JSON.parse(form.dataset.teamEntries);
                }
            } catch (e) { /* ignore parse errors */ }

            const submitBtn = document.getElementById('predesign-submit-quote');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            submitBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const res = await fetch((API || '') + '/api/custom-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true',
                        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                    },
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                if (!res.ok) throw new Error(json.msg || 'Failed to submit');
                
                alert('Quote submitted successfully!');
                window.location.href = 'my-quotes.html';
            } catch (err) {
                console.error(err);
                alert('Error submitting request: ' + err.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // --- Team Names / Team Entries Modal Logic ---
        function openTeamNamesModal() {
            const form = document.getElementById('predesign-form');
            const mode = form?.dataset.teamMode === 'on' ? 'on' : 'off';
            const modal = getOrCreateTeamModal();
            modal.classList.remove('hidden');
            if (mode === 'on') renderTeamEntriesModal(); else renderSimpleTeamModal();
        }

        function getOrCreateTeamModal() {
            let modal = document.getElementById('predesign-team-modal');
            if (modal) return modal;
            modal = document.createElement('div');
            modal.id = 'predesign-team-modal';
            modal.className = 'hidden fixed inset-0 bg-black/60 z-50 flex items-start justify-center pt-20 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                    <div id="predesign-team-modal-body"></div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeTeamModal() { const m = document.getElementById('predesign-team-modal'); if (m) m.classList.add('hidden'); }

        function renderSimpleTeamModal() {
            const body = document.getElementById('predesign-team-modal-body'); if (!body) return;
            const form = document.getElementById('predesign-form');
            const current = form?.dataset.teamNames || document.getElementById('predesign-teamname')?.value || '';
            body.innerHTML = `
                <h3 class="text-lg font-bold mb-4">Team Name</h3>
                <input id="modal-simple-teamname" class="w-full px-3 py-2 border rounded mb-4" value="${escapeHtml(current)}" placeholder="Enter team name (optional)">
                <div class="flex justify-end gap-2">
                    <button id="modal-team-apply" class="px-4 py-2 bg-green-500 text-white rounded">Apply</button>
                    <button id="modal-team-close" class="px-4 py-2 border rounded">Close</button>
                </div>
            `;
            document.getElementById('modal-team-close').addEventListener('click', closeTeamModal);
            document.getElementById('modal-team-apply').addEventListener('click', () => {
                const val = document.getElementById('modal-simple-teamname').value.trim();
                const form = document.getElementById('predesign-form');
                if (form) { form.dataset.teamNames = val; document.getElementById('predesign-teamname').value = val; }
                closeTeamModal();
            });
        }

        function renderTeamEntriesModal() {
            const body = document.getElementById('predesign-team-modal-body'); if (!body) return;
            const form = document.getElementById('predesign-form');
            let entries = [];
            try { entries = JSON.parse(form.dataset.teamEntries || '[]'); } catch(e){ entries = []; }
            // Build size options dynamically from current product sizesInventory
            function getAvailableSizes() {
                try { const inv = form && form.dataset.sizesInventory ? JSON.parse(form.dataset.sizesInventory) : {}; return Object.keys(inv || {}).filter(s => Number(inv[s] || 0) > 0); } catch(e) { return ['XS','S','M','L','XL','XXL']; }
            }
            const availableSizes = getAvailableSizes();
            const defaultEntries = entries.length ? entries : [{name:'', number:'', size:(availableSizes[0]||'M')}];
            const rows = defaultEntries.map((e, i) => {
                const sizeOptions = (availableSizes.length ? availableSizes : ['XS','S','M','L','XL','XXL']).map(sz => `<option value="${escapeHtml(sz)}" ${ (e.size||'')===sz ? 'selected' : '' }>${escapeHtml(sz)}</option>`).join('');
                return `
                <div class="team-entry mb-3 flex gap-2 items-center" data-idx="${i}">
                    <input class="team-entry-name flex-1 px-3 py-2 border rounded" placeholder="Name (optional)" value="${escapeHtml(e.name||'')}">
                    <input class="team-entry-number w-20 px-2 py-2 border rounded" placeholder="# (optional)" value="${escapeHtml(e.number||'')}">
                    <select class="team-entry-size px-3 py-2 border rounded">${sizeOptions}</select>
                    <button class="team-entry-remove px-3 py-2 bg-red-500 text-white rounded">X</button>
                </div>
                `;
            }).join('');

            body.innerHTML = `
                <h3 class="text-lg font-bold mb-4">Team Entries</h3>
                <div id="team-entries-list">${rows}</div>
                <div class="mt-3 mb-4"><button id="team-add-entry" class="w-full px-4 py-2 bg-indigo-600 text-white rounded">+ Add Entry</button></div>
                <div class="flex justify-end gap-2">
                    <button id="team-entries-apply" class="px-4 py-2 bg-green-500 text-white rounded">Apply</button>
                    <button id="team-entries-close" class="px-4 py-2 border rounded">Close</button>
                </div>
            `;

            document.getElementById('team-entries-close').addEventListener('click', closeTeamModal);
            document.getElementById('team-add-entry').addEventListener('click', addTeamEntryRow);
            document.getElementById('team-entries-apply').addEventListener('click', applyTeamEntries);
            document.querySelectorAll('.team-entry-remove').forEach(btn => btn.addEventListener('click', (ev) => { const row = ev.target.closest('.team-entry'); if (row) row.remove(); }));
            // When size selects change, re-validate (validation runs on apply)
            document.querySelectorAll('.team-entry-size').forEach(sel => sel.addEventListener('change', () => { /* noop, validation on apply */ }));
        }

        function addTeamEntryRow() {
            const list = document.getElementById('team-entries-list'); if (!list) return;
            const form = document.getElementById('predesign-form');
            let available = [];
            try { available = form && form.dataset.sizesInventory ? Object.keys(JSON.parse(form.dataset.sizesInventory)).filter(s => Number(JSON.parse(form.dataset.sizesInventory)[s]||0) > 0) : []; } catch(e){ available = []; }
            if (!available.length) available = ['XS','S','M','L','XL','XXL'];
            const div = document.createElement('div');
            div.className = 'team-entry mb-3 flex gap-2 items-center';
            const sizeOptions = available.map(sz => `<option value="${escapeHtml(sz)}">${escapeHtml(sz)}</option>`).join('');
            div.innerHTML = `
                <input class="team-entry-name flex-1 px-3 py-2 border rounded" placeholder="Name">
                <input class="team-entry-number w-20 px-2 py-2 border rounded" placeholder="# (optional)">
                <select class="team-entry-size px-3 py-2 border rounded">${sizeOptions}</select>
                <button class="team-entry-remove px-3 py-2 bg-red-500 text-white rounded">X</button>
            `;
            list.appendChild(div);
            div.querySelector('.team-entry-remove').addEventListener('click', ()=>div.remove());
        }

        function applyTeamEntries() {
            const list = document.getElementById('team-entries-list'); if (!list) return;
            const entries = [];
            list.querySelectorAll('.team-entry').forEach(row=>{
                const name = row.querySelector('.team-entry-name')?.value.trim() || '';
                const number = row.querySelector('.team-entry-number')?.value.trim() || '';
                const size = row.querySelector('.team-entry-size')?.value || '';
                // include the row if any field is filled; name and number are optional
                if (name || number || size) entries.push({ name, number, size });
            });
            const form = document.getElementById('predesign-form');
            // Validate entries against sizesInventory
            try {
                const sizesInv = form && form.dataset.sizesInventory ? JSON.parse(form.dataset.sizesInventory) : {};
                const counts = {};
                entries.forEach(en => { const s = en.size || ''; if (s) counts[s] = (counts[s]||0) + 1; });
                const invalid = Object.keys(counts).filter(s => Number(sizesInv[s] || 0) < counts[s]);
                if (invalid.length) {
                    alert('Team entries exceed available stock for sizes: ' + invalid.join(', '));
                    return; // do not apply
                }
            } catch(e) { /* if validation fails, allow apply but warn */ }

            if (form) {
                form.dataset.teamEntries = JSON.stringify(entries);
                document.getElementById('predesign-teamname').value = entries[0]?.name || '';
                // If team mode is on, set qty input to number of entries
                if (form.dataset.teamMode === 'on') {
                    const qtyEl = document.getElementById('predesign-qty');
                    if (qtyEl) { qtyEl.value = String(entries.length || 1); }
                }
            }
            closeTeamModal();
        }

        function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    </script>

    <div id="site-footer"></div>
    <script src="js/footer.js"></script>
</body>
</html>