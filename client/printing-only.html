<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Upload - Fundamental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style> body{font-family: 'Inter', sans-serif;} </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="font-extrabold text-xl text-gray-900">Fundamental</a>
      <nav class="flex items-center gap-6 text-sm">
        <a href="services.html" class="inline-flex items-center gap-2 px-4 py-2 border rounded-lg text-sm text-gray-700 hover:bg-gray-50">
          <i class="fas fa-arrow-left"></i>
          Back To Services
        </a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Custom Upload</h1>
      <p class="text-gray-600 mt-2">Upload your finished design and provide the specifics. We'll make it professionally.</p>
    </div>

    <form id="po-form" class="bg-white rounded-2xl shadow p-6 space-y-8">
      <div id="formMessage" class="rounded p-3 text-sm hidden"></div>
      <!-- Printing Type -->
      <section>
        <label class="block text-sm font-bold text-gray-800 mb-3">Printing Type</label>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="dye-sublimation" class="peer hidden" checked />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-fire text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Dye-Sublimation</p>
              <p class="text-xs text-gray-500 mt-1">Best for full-color designs</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="heat-transfer" class="peer hidden" />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-temperature-high text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Heat Transfer</p>
              <p class="text-xs text-gray-500 mt-1">Good for photos & gradients</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="vinyl-print" class="peer hidden" />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-layer-group text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Vinyl Print</p>
              <p class="text-xs text-gray-500 mt-1">Durable for simple designs</p>
            </div>
          </label>
        </div>
      </section>

      <!-- SEPARATE Fabric & Garment Selection -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Fabric Type -->
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">
            <i class="fas fa-scroll text-blue-600 mr-1"></i>Fabric Type
          </label>
          <select id="fabricType" class="w-full border rounded-lg px-3 py-2" required>
            <option value="">Select fabric type</option>
            <option value="Fullmax">Fullmax</option>
            <option value="Polydex">Polydex</option>
            <option value="Synthetic">Synthetic</option>
            <option value="Cotton">Cotton</option>
            <option value="Dry-Fit">Dry-Fit</option>
            <option value="Polyester">Polyester</option>
          </select>
        </div>
        
        <!-- Garment Type -->
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">
            <i class="fas fa-tshirt text-green-600 mr-1"></i>Garment Type
          </label>
          <select id="garmentType" class="w-full border rounded-lg px-3 py-2" required>
            <option value="">Select garment type</option>
            <option value="Jersey">Jersey</option>
            <option value="T-Shirt">T-Shirt</option>
            <option value="Hoodie">Hoodie</option>
            <option value="Polo Shirt">Polo Shirt</option>
            <option value="Long Sleeve">Long Sleeve</option>
            <option value="Tank Top">Tank Top</option>
            <option value="Shorts">Shorts</option>
          </select>
        </div>
      </section>

      <!-- Quantity & Size Guide -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Quantity</label>
          <input id="quantity" type="number" min="1" class="w-full border rounded-lg px-3 py-2" value="1" required />
        </div>
        <div class="md:col-span-2 flex items-end gap-3">
          <button id="checkSizesBtn" type="button" class="px-4 py-2 border rounded-lg text-sm bg-white hover:bg-gray-50 flex items-center gap-2">
            <i class="fas fa-search text-green-600"></i>Check Available Sizes
          </button>
          <button id="sizeGuideBtn" type="button" class="px-4 py-2 border border-blue-300 bg-blue-50 rounded-lg text-sm text-blue-700 hover:bg-blue-100 flex items-center gap-2">
            <i class="fas fa-ruler"></i>Size Guide
          </button>
          <span id="fabricStatusBadge" class="ml-3 inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 hidden"></span>
        </div>
      </section>

      <!-- Hidden field for combined fabric & garment (for backend compatibility) -->
      <input type="hidden" id="fabricGarment" name="fabricGarment" />

      <!-- Availability Info Panel -->
      <div id="sizesAvailability" class="hidden bg-gray-50 border rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-semibold text-gray-700"><i class="fas fa-boxes text-green-600 mr-2"></i>Available Stock</h4>
          <button type="button" onclick="document.getElementById('sizesAvailability').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="stockInfo" class="text-sm text-gray-600"></div>
      </div>

      <!-- Design Uploads -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Upload Design</label>
          <input id="designFile" type="file" accept="image/*,.pdf,.ai,.psd,.zip" class="w-full border rounded-lg px-3 py-2" required />
          <p class="text-xs text-gray-500 mt-1">High-res preferred (300 DPI+)</p>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Team Names (optional)</label>
          <input id="teamNamesFile" type="file" accept=".txt,.csv" class="w-full border rounded-lg px-3 py-2" />
          <p class="text-xs text-gray-500 mt-1">Upload .txt or .csv list to prefill team members.</p>
        </div>
      </section>

      <!-- Team Mode -->
      <section class="space-y-3">
        <div class="flex items-center gap-3 flex-wrap">
          <button id="teamToggle" type="button" class="px-4 py-2 border rounded-lg text-sm flex items-center gap-2 hover:bg-gray-50">
            <i class="fas fa-users"></i><span>Team Mode: Off</span>
          </button>
          <p class="text-xs text-gray-500">Enable for multiple jerseys with different names/numbers</p>
        </div>
        <div id="teamBox" class="hidden bg-gradient-to-b from-gray-50 to-white border rounded-lg p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800"><i class="fas fa-users text-green-600 mr-2"></i>Team Members</h3>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500">Surname & Number are optional</span>
              <button id="addTeamMemberBtn" type="button" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                <i class="fas fa-plus mr-1"></i>Add Member
              </button>
            </div>
          </div>
          <!-- Team Header -->
          <div class="grid grid-cols-12 gap-2 text-xs font-semibold text-gray-500 mb-2 px-2">
            <div class="col-span-1">#</div>
            <div class="col-span-4">Surname / Name</div>
            <div class="col-span-2">Jersey Number</div>
            <div class="col-span-4">Size</div>
            <div class="col-span-1"></div>
          </div>
          <div id="teamContainer" class="space-y-2 max-h-80 overflow-y-auto"></div>
        </div>
      </section>

      <!-- Size (single) when not team mode -->
      <section id="singleSizeRow" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Size</label>
          <select id="garmentSize" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select size</option>
            <option>XS</option><option>S</option><option>M</option><option>L</option>
            <option>XL</option><option>XXL</option><option>3XL</option>
          </select>
        </div>
      </section>

      <!-- Customer Notes -->
      <section>
        <label class="block text-sm font-bold text-gray-800 mb-2">Additional Notes (Optional)</label>
        <textarea id="customerNotes" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Any special instructions, requirements, or details you want us to know..."></textarea>
      </section>

      <div class="pt-2">
        <button id="submitBtn" type="submit" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-teal-700">
          <i class="fas fa-paper-plane mr-2"></i>Submit Quote Order
        </button>
      </div>
    </form>
  </main>

  <!-- Size Guide Modal -->
  <div id="sizeGuideModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl max-w-2xl w-full mx-4 shadow-2xl overflow-hidden">
      <div class="px-6 py-4 border-b bg-gradient-to-r from-blue-600 to-blue-700 text-white flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-ruler-combined"></i>
          <span class="font-semibold">Size Guide</span>
        </div>
        <button id="sizeGuideClose" class="text-white hover:text-blue-200 text-xl">&times;</button>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-600 mb-4">All measurements are in centimeters (cm). Measurements may vary slightly.</p>
        <div class="overflow-x-auto">
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-3 py-2 text-left font-semibold">Size</th>
                <th class="border px-3 py-2 text-center font-semibold">Chest</th>
                <th class="border px-3 py-2 text-center font-semibold">Length</th>
                <th class="border px-3 py-2 text-center font-semibold">Shoulder</th>
                <th class="border px-3 py-2 text-center font-semibold">Sleeve</th>
              </tr>
            </thead>
            <tbody>
              <tr class="hover:bg-gray-50">
                <td class="border px-3 py-2 font-medium">XS</td>
                <td class="border px-3 py-2 text-center">86-91</td>
                <td class="border px-3 py-2 text-center">66</td>
                <td class="border px-3 py-2 text-center">40</td>
                <td class="border px-3 py-2 text-center">19</td>
              </tr>
              <tr class="hover:bg-gray-50 bg-gray-50">
                <td class="border px-3 py-2 font-medium">S</td>
                <td class="border px-3 py-2 text-center">91-96</td>
                <td class="border px-3 py-2 text-center">69</td>
                <td class="border px-3 py-2 text-center">42</td>
                <td class="border px-3 py-2 text-center">20</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="border px-3 py-2 font-medium">M</td>
                <td class="border px-3 py-2 text-center">96-101</td>
                <td class="border px-3 py-2 text-center">72</td>
                <td class="border px-3 py-2 text-center">44</td>
                <td class="border px-3 py-2 text-center">21</td>
              </tr>
              <tr class="hover:bg-gray-50 bg-gray-50">
                <td class="border px-3 py-2 font-medium">L</td>
                <td class="border px-3 py-2 text-center">101-106</td>
                <td class="border px-3 py-2 text-center">74</td>
                <td class="border px-3 py-2 text-center">46</td>
                <td class="border px-3 py-2 text-center">22</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="border px-3 py-2 font-medium">XL</td>
                <td class="border px-3 py-2 text-center">106-111</td>
                <td class="border px-3 py-2 text-center">76</td>
                <td class="border px-3 py-2 text-center">48</td>
                <td class="border px-3 py-2 text-center">23</td>
              </tr>
              <tr class="hover:bg-gray-50 bg-gray-50">
                <td class="border px-3 py-2 font-medium">XXL</td>
                <td class="border px-3 py-2 text-center">111-116</td>
                <td class="border px-3 py-2 text-center">78</td>
                <td class="border px-3 py-2 text-center">50</td>
                <td class="border px-3 py-2 text-center">24</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="border px-3 py-2 font-medium">3XL</td>
                <td class="border px-3 py-2 text-center">116-121</td>
                <td class="border px-3 py-2 text-center">80</td>
                <td class="border px-3 py-2 text-center">52</td>
                <td class="border px-3 py-2 text-center">25</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-xs text-blue-800">
            <i class="fas fa-info-circle mr-1"></i>
            <strong>How to measure:</strong> Chest - measure around the fullest part. Length - from shoulder to hem. 
            Shoulder - seam to seam. Sleeve - from shoulder seam to cuff.
          </p>
        </div>
      </div>
      <div class="px-6 py-4 border-t bg-gray-50 text-right">
        <button id="sizeGuideCloseBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
          Got it!
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const API = 'https://fundamental-apparel-backend.onrender.com';

    const els = {
      form: document.getElementById('po-form'),
      teamToggle: document.getElementById('teamToggle'),
      teamBox: document.getElementById('teamBox'),
      teamContainer: document.getElementById('teamContainer'),
      quantity: document.getElementById('quantity'),
      fabricType: document.getElementById('fabricType'),
      garmentType: document.getElementById('garmentType'),
      fabricGarment: document.getElementById('fabricGarment'), // hidden combined field
      checkSizesBtn: document.getElementById('checkSizesBtn'),
      sizesAvailability: document.getElementById('sizesAvailability'),
      stockInfo: document.getElementById('stockInfo'),
      garmentSize: document.getElementById('garmentSize'),
      singleSizeRow: document.getElementById('singleSizeRow'),
      teamNamesFileInput: document.getElementById('teamNamesFile'),
      addTeamMemberBtn: document.getElementById('addTeamMemberBtn'),
      sizeGuideBtn: document.getElementById('sizeGuideBtn'),
      sizeGuideModal: document.getElementById('sizeGuideModal'),
      sizeGuideClose: document.getElementById('sizeGuideClose'),
      sizeGuideCloseBtn: document.getElementById('sizeGuideCloseBtn')
    };

    let teamMode = false;
    let availableVariants = [];
    let currentInventory = null;
    const DEFAULT_SIZE_ORDER = ['XS','S','M','L','XL','XXL','3XL'];
    let teamMemberCounter = 0;

    // Size Guide Modal handlers
    els.sizeGuideBtn?.addEventListener('click', () => {
      els.sizeGuideModal?.classList.remove('hidden');
    });
    els.sizeGuideClose?.addEventListener('click', () => {
      els.sizeGuideModal?.classList.add('hidden');
    });
    els.sizeGuideCloseBtn?.addEventListener('click', () => {
      els.sizeGuideModal?.classList.add('hidden');
    });
    els.sizeGuideModal?.addEventListener('click', (e) => {
      if (e.target === els.sizeGuideModal) els.sizeGuideModal.classList.add('hidden');
    });

    // Update combined fabricGarment field when either dropdown changes
    function updateCombinedField() {
      const fabric = els.fabricType?.value || '';
      const garment = els.garmentType?.value || '';
      if (fabric && garment) {
        els.fabricGarment.value = `${fabric} - ${garment}`;
      } else {
        els.fabricGarment.value = '';
      }
      // Try to load availability for this combination
      if (els.fabricGarment.value) {
        showVariantAvailability(els.fabricGarment.value);
      } else {
        currentInventory = null;
        updateSizeDropdowns();
        els.sizesAvailability?.classList.add('hidden');
      }
    }

    els.fabricType?.addEventListener('change', updateCombinedField);
    els.garmentType?.addEventListener('change', updateCombinedField);

    // Generate team member row
    function createTeamRow(index, name = '', number = '', size = '') {
      const row = document.createElement('div');
      row.className = 'grid grid-cols-12 gap-2 items-center p-2 bg-white border rounded';
      row.dataset.index = index;
      row.innerHTML = `
        <div class="col-span-1 text-center text-sm text-gray-500 font-medium">${index + 1}</div>
        <div class="col-span-4">
          <input type="text" class="team-name w-full border rounded px-2 py-1.5 text-sm" placeholder="Surname / Name" value="${escapeHtml(name)}" />
        </div>
        <div class="col-span-2">
          <input type="text" class="team-number w-full border rounded px-2 py-1.5 text-sm text-center" placeholder="#" value="${escapeHtml(number)}" />
        </div>
        <div class="col-span-4">
          <select class="team-size w-full border rounded px-2 py-1.5 text-sm">
            <option value="">Select size</option>
          </select>
        </div>
        <div class="col-span-1 text-center">
          <button type="button" class="remove-team-row text-red-500 hover:text-red-700 p-1">
            <i class="fas fa-trash text-xs"></i>
          </button>
        </div>
      `;
      // Populate size options
      const sizeSelect = row.querySelector('.team-size');
      const sizes = getAvailableSizes();
      sizes.forEach(sz => {
        const opt = document.createElement('option');
        opt.value = sz;
        opt.textContent = sz;
        sizeSelect.appendChild(opt);
      });
      if (size && sizes.includes(size)) {
        sizeSelect.value = size;
      }
      // Remove button handler
      row.querySelector('.remove-team-row').addEventListener('click', () => {
        row.remove();
        renumberTeamRows();
        updateQuantityFromTeam();
      });
      return row;
    }

    function escapeHtml(s) {
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function renumberTeamRows() {
      const rows = els.teamContainer.querySelectorAll('[data-index]');
      rows.forEach((row, idx) => {
        row.dataset.index = idx;
        row.querySelector('.col-span-1').textContent = idx + 1;
      });
    }

    function updateQuantityFromTeam() {
      const count = els.teamContainer.querySelectorAll('[data-index]').length;
      els.quantity.value = count || 1;
    }

    function genTeamRows() {
      const qty = Math.max(1, parseInt(els.quantity.value || '1', 10));
      const existingRows = els.teamContainer.querySelectorAll('[data-index]');
      const currentCount = existingRows.length;
      
      if (qty > currentCount) {
        // Add more rows
        for (let i = currentCount; i < qty; i++) {
          els.teamContainer.appendChild(createTeamRow(i));
        }
      } else if (qty < currentCount) {
        // Remove excess rows from the end
        for (let i = currentCount - 1; i >= qty; i--) {
          existingRows[i]?.remove();
        }
      }
      renumberTeamRows();
    }

    // Add team member button
    els.addTeamMemberBtn?.addEventListener('click', () => {
      const currentCount = els.teamContainer.querySelectorAll('[data-index]').length;
      els.teamContainer.appendChild(createTeamRow(currentCount));
      els.quantity.value = currentCount + 1;
    });

    function setTeamMode(on) {
      teamMode = !!on;
      if (teamMode) {
        els.teamBox.classList.remove('hidden');
        els.singleSizeRow.classList.add('hidden');
        els.teamToggle.querySelector('span').textContent = 'Team Mode: On';
        els.teamToggle.classList.add('bg-green-50', 'border-green-300');
        genTeamRows();
        if (currentInventory) updateSizeDropdowns();
      } else {
        els.teamBox.classList.add('hidden');
        els.singleSizeRow.classList.remove('hidden');
        els.teamToggle.querySelector('span').textContent = 'Team Mode: Off';
        els.teamToggle.classList.remove('bg-green-50', 'border-green-300');
      }
    }

    els.teamToggle.addEventListener('click', () => setTeamMode(!teamMode));
    
    els.quantity.addEventListener('change', async () => {
      if (teamMode) {
        genTeamRows();
        updateSizeDropdowns();
        const combined = els.fabricGarment?.value;
        if (!currentInventory && combined) {
          await showVariantAvailability(combined);
          updateSizeDropdowns();
        }
      }
    });

    // Parse uploaded .txt/.csv into rows
    els.teamNamesFileInput?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        els.quantity.value = lines.length;
        setTeamMode(true);
        els.teamContainer.innerHTML = '';
        lines.forEach((ln, idx) => {
          const parts = ln.split(/[,|\t]/);
          const name = (parts[0] || '').trim();
          const number = (parts[1] || '').trim();
          const size = (parts[2] || '').trim().toUpperCase();
          els.teamContainer.appendChild(createTeamRow(idx, name, number, size));
        });
        updateSizeDropdowns();
        const combined = els.fabricGarment?.value;
        if (!currentInventory && combined) {
          await showVariantAvailability(combined);
          updateSizeDropdowns();
        }
        showMessage('Team members loaded from file!', 'success');
      } catch (err) {
        console.error(err);
        showMessage('Failed to parse file', 'error');
      }
    });

    function collectTeamMembers(){
      const arr = [];
      if(!teamMode) return arr;
      els.teamContainer.querySelectorAll('[data-index]').forEach(row=>{
        arr.push({
          name: row.querySelector('.team-name')?.value || '',
          jerseyNumber: row.querySelector('.team-number')?.value || '',
          size: row.querySelector('.team-size')?.value || ''
        });
      });
      return arr;
    }

    // --- Inventory-size helpers ---
    function getAvailableSizes(){
      const inv = currentInventory;
      if(!inv) return [];
      const sizesObj = inv.sizesInventory || {};
      const reserved = inv.reservedSizes || {};
      const sizeOrder = ['XS','S','M','L','XL','XXL','3XL'];
      const keys = Object.keys(sizesObj || {});
      keys.sort((a,b)=>{
        const ia = sizeOrder.indexOf(a);
        const ib = sizeOrder.indexOf(b);
        if(ia === -1 && ib === -1) return a.localeCompare(b);
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      });
      return keys.filter(sz => {
        const total = Number(sizesObj[sz] || 0);
        const resv = Number(reserved[sz] || 0);
        return (total - resv) > 0;
      });
    }

    function buildSizeOptionsHTML(sizes){
      // If inventory sizes are not available, fall back to a sensible default list
      const useSizes = (sizes && sizes.length) ? sizes : DEFAULT_SIZE_ORDER;
      let html = '<option value="">Select size</option>';
      (useSizes || []).forEach(sz => { html += `<option value="${sz}">${sz}</option>`; });
      return html;
    }

    function updateSizeDropdowns(){
      const sizes = getAvailableSizes();
      const sel = document.getElementById('garmentSize');
      if(sel){
        // preserve previous selection if possible
        const prev = sel.value;
        sel.innerHTML = buildSizeOptionsHTML(sizes);
        if (prev && Array.from(sel.options).some(o => o.value === prev)) sel.value = prev;
        sel.disabled = sizes.length === 0;
      }
      // Update team member size selects
      if(teamMode){
        const rows = els.teamContainer.querySelectorAll('[data-index]');
        rows.forEach(r=>{
          const s = r.querySelector('.team-size');
          if(!s) return;
          const prevVal = s.value;
          s.innerHTML = buildSizeOptionsHTML(sizes);
          if (prevVal && Array.from(s.options).some(o => o.value === prevVal)) s.value = prevVal;
          s.disabled = sizes.length === 0;
        });
      }
    }

    // Inline message helpers (replace alert())
    function showMessage(msg, type){
      const el = document.getElementById('formMessage');
      if(!el) return;
      el.className = 'rounded p-3 text-sm';
      if(type === 'error') el.classList.add('bg-red-50','text-red-700','border','border-red-100');
      else if(type === 'success') el.classList.add('bg-green-50','text-green-700','border','border-green-100');
      else el.classList.add('bg-yellow-50','text-yellow-700','border','border-yellow-100');
      el.textContent = msg;
      el.classList.remove('hidden');
      // auto-clear success messages after a short delay
      if(type === 'success') setTimeout(()=>{ clearMessage(); }, 2500);
    }
    function clearMessage(){ const el = document.getElementById('formMessage'); if(el){ el.classList.add('hidden'); el.textContent=''; el.className='rounded p-3 text-sm hidden'; } }

    // Sizes modal helpers
    function openSizesModal(){ const m = document.getElementById('sizesModal'); if(!m) return; m.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
    function closeSizesModal(){ const m = document.getElementById('sizesModal'); if(!m) return; m.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }

    // Display sizes availability in the stock info panel
    function displaySizesAvailability(item, opts){
      if(!item) {
        els.sizesAvailability?.classList.add('hidden');
        return;
      }
      currentInventory = item;
      updateSizeDropdowns();
      
      // Build stock info HTML
      const sizesInventory = item.sizesInventory || {};
      const sizesPrice = item.sizesPrice || {};
      const reservedSizes = item.reservedSizes || {};
      
      let html = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">';
      const sizeOrder = ['XS','S','M','L','XL','XXL','3XL'];
      const keys = Object.keys(sizesInventory).sort((a,b) => {
        const ia = sizeOrder.indexOf(a);
        const ib = sizeOrder.indexOf(b);
        if(ia === -1 && ib === -1) return a.localeCompare(b);
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      });
      
      keys.forEach(sz => {
        const total = Number(sizesInventory[sz]||0);
        const reserved = Number(reservedSizes[sz]||0);
        const available = Math.max(0, total - reserved);
        const price = sizesPrice[sz] ? `₱${sizesPrice[sz]}` : '';
        const statusClass = available > 0 ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
        html += `
          <div class="p-2 rounded border ${statusClass} text-center">
            <div class="font-semibold">${sz}</div>
            <div class="text-xs">${available} avail</div>
            ${price ? `<div class="text-xs">${price}</div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      
      // Show min price if available
      let minPrice = item.price;
      if (!minPrice || minPrice <= 0) {
        const priceVals = Object.values(sizesPrice).filter(v => v > 0);
        if (priceVals.length) minPrice = Math.min(...priceVals);
      }
      if (minPrice && minPrice > 0) {
        html += `<div class="mt-2 text-xs text-gray-500">Starting from ₱${Number(minPrice).toFixed(2)}</div>`;
      }
      
      els.stockInfo.innerHTML = html;
      els.sizesAvailability?.classList.remove('hidden');
      
      // Also update the sizes modal if it's open
      const modal = document.getElementById('sizesModal');
      const list = modal?.querySelector('.sizes-list');
      if (list) {
        list.innerHTML = '';
        keys.forEach(sz => {
          const total = Number(sizesInventory[sz]||0);
          const reserved = Number(reservedSizes[sz]||0);
          const available = Math.max(0, total - reserved);
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between py-2 border-b';
          row.innerHTML = `
            <div class="text-sm"><strong>${sz}</strong>${sizesPrice[sz] ? ` • ₱${sizesPrice[sz]}` : ''}</div>
            <div class="flex items-center gap-2">
              <div class="text-xs text-gray-500">${available} available</div>
              <button class="choose-size px-3 py-1 rounded text-sm ${available>0 ? 'bg-green-600' : 'bg-gray-400'} text-white" data-size="${sz}" data-available="${available}">${available>0? 'Choose' : 'Out'}</button>
            </div>
          `;
          list.appendChild(row);
        });
      }
      
      if(opts && opts.openModal) openSizesModal();
    }

    // Click handler for choose-size buttons inside modal
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest && ev.target.closest('.choose-size');
      if(!btn) return;
      const sz = btn.dataset.size;
      const avail = Number(btn.dataset.available||0);
      if(!teamMode){
        const sel = document.getElementById('garmentSize');
        if(sel && avail>0){ sel.value = sz; showMessage(`Selected size ${sz}`, 'success'); }
        else if(avail<=0){ showMessage(`Size ${sz} is out of stock`, 'error'); }
        closeSizesModal();
        return;
      }
      // team mode: apply selected size to all members that don't yet have a size
      if(teamMode){
        const rows = els.teamContainer.querySelectorAll('[data-index]');
        rows.forEach(r=>{ const s = r.querySelector('.team-size'); if(s && !s.value) s.value = sz; });
        showMessage(`Applied size ${sz} to team members (empty entries)`, 'success');
        closeSizesModal();
      }
    });

    // wire modal close buttons and overlay click
    const closeBtn = document.getElementById('sizesModalClose');
    const cancelBtn = document.getElementById('sizesModalCancel');
    const modal = document.getElementById('sizesModal');
    if(closeBtn) closeBtn.addEventListener('click', closeSizesModal);
    if(cancelBtn) cancelBtn.addEventListener('click', closeSizesModal);
    if(modal) modal.addEventListener('click', (ev)=>{ if(ev.target === modal) closeSizesModal(); });

    els.form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const token = localStorage.getItem('token');
      if(!token){
        showMessage('Please login to submit a quote order. Redirecting...', 'error');
        setTimeout(()=> window.location.href = 'login.html', 1000);
        return;
      }

      // Validate fabric and garment selection
      const fabricVal = els.fabricType?.value || '';
      const garmentVal = els.garmentType?.value || '';
      if (!fabricVal) {
        showMessage('Please select a Fabric Type', 'error');
        return;
      }
      if (!garmentVal) {
        showMessage('Please select a Garment Type', 'error');
        return;
      }

      const fd = new FormData();
      fd.append('serviceType', 'printing-only');
      fd.append('customType', 'PrintingOnly');
      fd.append('printingMethod', (document.querySelector('input[name="printingMethod"]:checked')?.value)||'dye-sublimation');
      
      // Use separate Fabric and Garment values from the new dropdowns
      const fg = `${fabricVal} - ${garmentVal}`;
      
      // Send the combined selection as inventoryName so backend can match admin-created inventory entries
      fd.append('inventoryName', fg);
      fd.append('fabricType', fabricVal);
      fd.append('garmentType', garmentVal);
      fd.append('quantity', document.getElementById('quantity').value);

      // Add customer notes if provided
      const customerNotes = document.getElementById('customerNotes');
      if (customerNotes && customerNotes.value.trim()) {
        fd.append('notes', customerNotes.value.trim());
      }

      const designFile = document.getElementById('designFile').files[0];
      if(designFile) fd.append('designFile', designFile);
      const teamNames = document.getElementById('teamNamesFile').files[0];
      if(teamNames) fd.append('teamNamesFile', teamNames);

      // NOTE: do not append size/team to FormData here — we append after
      // availability checks and any auto-selection so the posted value
      // reflects the final selected/auto-selected size(s).

      // Validate inventory availability before sending the quote
      // Ensure currentInventory is populated (try preloaded or fetch), then check requested sizes
      if (fg) {
        await showVariantAvailability(fg);
        // If single-mode and user didn't pick a size, auto-select the first available size
        if (!teamMode) {
          const sel = document.getElementById('garmentSize');
          try{
            if (sel && (!sel.value || sel.value === '')) {
              const sizes = getAvailableSizes();
              if (sizes && sizes.length) {
                sel.value = sizes[0];
                showMessage(`Auto-selected available size ${sizes[0]}`, 'success');
              } else {
                showMessage('No available sizes for the selected variant.', 'error');
                return;
              }
            }
          }catch(e){ console.debug('Auto-select size failed', e && e.message); }
        }
      }
      const inv = typeof currentInventory !== 'undefined' ? currentInventory : null;
      const qtyRequested = Number(document.getElementById('quantity').value) || 0;
      if (inv) {
        const sizes = inv.sizesInventory || {};
        const reserved = inv.reservedSizes || {};
        if (teamMode) {
          // Ensure every team member has a size selected. If some are missing,
          // try to auto-assign the most-available size when it's unambiguous.
          const team = collectTeamMembers();
          const missingIndexes = team.map((m,i)=>({i, size: (m.size||'').trim()})).filter(x=>!x.size).map(x=>x.i);
          if (missingIndexes.length) {
            const availSizes = getAvailableSizes();
            if (availSizes.length === 1) {
              // auto apply the only available size to missing entries
              const only = availSizes[0];
              const rows = els.teamContainer.querySelectorAll('.grid');
              rows.forEach(r=>{ const s = r.querySelector('.size'); if(s && !s.value) s.value = only; });
              showMessage(`Auto-applied size ${only} to ${missingIndexes.length} team member(s)`, 'success');
            } else {
              showMessage('Please select sizes for all team members before submitting (some are empty). Use "Check Available Sizes" to help.', 'error');
              return;
            }
          }

          // Now compute counts per size and validate availability
          const counts = {};
          team.forEach(m => { const key = (m.size||'').trim(); counts[key] = (counts[key]||0) + 1; });
          for (const sz in counts) {
            const needed = counts[sz] || 0;
            const total = Number(sizes[sz] || 0);
            const resv = Number(reserved[sz] || 0);
            const avail = Math.max(0, total - resv);
            if (avail < needed) {
              const label = sz || 'unspecified size';
              showMessage(`Not enough stock for ${label}. Available: ${avail}, required: ${needed}`, 'error');
              return;
            }
          }
        } else {
          const size = (document.getElementById('garmentSize').value || '').trim();
          if (!size) { showMessage('Please select a size before submitting.', 'error'); return; }
          const total = Number(sizes[size] || 0);
          const resv = Number(reserved[size] || 0);
          const avail = Math.max(0, total - resv);
          if (avail < qtyRequested) {
            showMessage(`Not enough stock for size ${size}. Available: ${avail}, requested: ${qtyRequested}`, 'error');
            return;
          }
        }
      } else {
        // No inventory info available — proceed but warn in console
        console.debug('No inventory data available to validate before submit for', fg);
      }

      // Append size/team info after availability checks (ensures auto-select applied)
      if (teamMode) {
        fd.append('includeTeamMembers', 'true');
        const teamMembers = collectTeamMembers();
        // Temporary debug: log the teamMembers and the FormData contents before sending
        try{ console.log('DEBUG: teamMembers payload', teamMembers); }catch(e){}
        fd.append('teamMembers', JSON.stringify(teamMembers));
      } else {
        const selSizeVal = (document.getElementById('garmentSize') && document.getElementById('garmentSize').value) || '';
        if (selSizeVal) fd.append('garmentSize', selSizeVal);
      }

      // Temporary debug: log FormData entries (for troubleshooting what is sent)
      try{
        for (const pair of fd.entries()) { console.log('DEBUG FormData:', pair[0], pair[1]); }
      }catch(e){ console.debug('Failed to enumerate FormData for debug', e && e.message); }

      const btn = document.getElementById('submitBtn');
      const original = btn ? btn.innerHTML : 'Submit';
      if(btn){ btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...'; }
      try{
        const res = await fetch(`${API}/api/custom-orders`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd });
        let data = null;
        try{
          data = await res.json();
        }catch(parseErr){
          const text = await res.text().catch(()=>null);
          throw new Error(`Server responded with ${res.status}: ${text || res.statusText}`);
        }
        if(!data.success) {
          console.error('Server responded with error payload:', data);
          const errMsg = (data.msg || 'Failed to submit order') + (data.error ? ` — ${data.error}` : '');
          throw new Error(errMsg);
        }
        showMessage('Printing order submitted! We will contact you with a quote.', 'success');
        setTimeout(()=> window.location.href = 'profile.html', 900);
      }catch(err){
        console.error('Submit quote error:', err);
        showMessage(err.message || 'Failed to submit quote. See console for details.', 'error');
      }finally{
        if(btn){ btn.disabled = false; btn.innerHTML = original; }
      }
      });

      // Check Available Sizes handler
    async function checkAvailableSizesFG(){
      const token = localStorage.getItem('token');
      const fabricVal = els.fabricType?.value || '';
      const garmentVal = els.garmentType?.value || '';
      
      if(!fabricVal || !garmentVal){ 
        showMessage('Please select both Fabric Type and Garment Type first.', 'error'); 
        return; 
      }
      
      // Use the combined name as inventory 'name' for lookup
      const nameQuery = `${fabricVal} - ${garmentVal}`;
      
      try{
        els.checkSizesBtn.disabled = true;
        els.checkSizesBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
        const res = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(nameQuery)}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if(!res.ok){
          const txt = await res.text().catch(()=>res.statusText);
          throw new Error(`Availability API error ${res.status}: ${txt}`);
        }
        const data = await res.json().catch(()=>null);
        if(!data || !data.success) throw new Error((data && data.message) || 'Failed to fetch availability');
        // set current inventory and show availability
        currentInventory = data.data;
        displaySizesAvailability(data.data, { openModal: false });
        showMessage('Stock information loaded!', 'success');
      }catch(err){
        showMessage(err.message || 'Error checking sizes', 'error');
        els.sizesAvailability?.classList.add('hidden');
      }finally{
        els.checkSizesBtn.disabled = false;
        els.checkSizesBtn.innerHTML = '<i class="fas fa-search text-green-600"></i> Check Available Sizes';
      }
    }

    els.checkSizesBtn.addEventListener('click', checkAvailableSizesFG);
    // Populate Fabric & Garment dropdown from public inventory variants
    async function loadAvailableVariants(){
      try{
        const res = await fetch(`${API}/api/admin/inventory/public/variants`);
        if(!res.ok){ console.debug('Variants API returned', res.status); return; }
        const json = await res.json().catch(()=>null);
        if(!json || !json.success){ console.debug('Variants API response invalid'); return; }
        availableVariants = json.data || [];
        
        // Extract unique fabric types and garment types from available variants
        const fabricTypes = new Set();
        const garmentTypes = new Set();
        
        availableVariants.forEach(v => {
          const name = v.name || '';
          if (name.includes(' - ')) {
            const parts = name.split(' - ');
            if (parts[0]) fabricTypes.add(parts[0].trim());
            if (parts[1]) garmentTypes.add(parts[1].trim());
          }
        });
        
        // Update fabric dropdown with available options
        if (els.fabricType && fabricTypes.size > 0) {
          // Keep existing options and add new ones from inventory
          const existingValues = new Set(Array.from(els.fabricType.options).map(o => o.value));
          fabricTypes.forEach(ft => {
            if (!existingValues.has(ft)) {
              const opt = document.createElement('option');
              opt.value = ft;
              opt.textContent = ft;
              els.fabricType.appendChild(opt);
            }
          });
        }
        
        // Update garment dropdown with available options
        if (els.garmentType && garmentTypes.size > 0) {
          const existingValues = new Set(Array.from(els.garmentType.options).map(o => o.value));
          garmentTypes.forEach(gt => {
            if (!existingValues.has(gt)) {
              const opt = document.createElement('option');
              opt.value = gt;
              opt.textContent = gt;
              els.garmentType.appendChild(opt);
            }
          });
        }
        
      }catch(err){ console.debug('Failed to load variants:', err && err.message); }
    }

    // Show availability for selected variant using preloaded data or fallback to API
    async function showVariantAvailability(name){
      if(!name){ 
        currentInventory = null; 
        updateSizeDropdowns(); 
        els.sizesAvailability?.classList.add('hidden');
        return; 
      }
      // try preloaded list
      const found = availableVariants.find(v => (v.name||'').toLowerCase() === name.toLowerCase());
      if(found){
        currentInventory = found;
        updateSizeDropdowns();
        displaySizesAvailability(found);
        return;
      }
      // fallback to API call
      try{
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(name)}`, { 
          headers: token ? { 'Authorization': `Bearer ${token}` } : {} 
        });
        if(!res.ok){
          console.debug('Availability API returned', res.status);
          currentInventory = null;
          updateSizeDropdowns();
          return;
        }
        const data = await res.json().catch(()=>null);
        if(data && data.success && data.data){
          currentInventory = data.data;
          displaySizesAvailability(data.data);
        } else {
          currentInventory = null;
        }
        updateSizeDropdowns();
      }catch(err){ 
        console.debug('availability fetch failed', err && err.message); 
        currentInventory = null; 
        updateSizeDropdowns(); 
      }
    }

    // Update fabric status badge
    function updateFabricBadge(available){
      const badge = document.getElementById('fabricStatusBadge');
      if(!badge) return;
      if(available === null || available === undefined){ 
        badge.classList.add('hidden'); 
        return; 
      }
      if(available === 0){ 
        badge.textContent = 'Out of stock'; 
        badge.classList.remove('hidden', 'bg-green-50', 'text-green-700'); 
        badge.classList.add('bg-red-50','text-red-700'); 
      } else { 
        badge.textContent = `${available} in stock`; 
        badge.classList.remove('hidden', 'bg-red-50','text-red-700'); 
        badge.classList.add('bg-green-50','text-green-700'); 
      }
    }

    // load variants on page load
    loadAvailableVariants();
    });
    
  </script>
  <!-- Sizes Modal -->
  <div id="sizesModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg max-w-md w-full mx-4 shadow-lg overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <div class="text-sm font-semibold">Available Sizes</div>
        <button id="sizesModalClose" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="p-4">
        <div class="sizes-list space-y-2 text-sm text-gray-800"></div>
      </div>
      <div class="px-4 py-3 border-t text-right">
        <button id="sizesModalCancel" class="px-3 py-2 rounded border text-sm">Close</button>
      </div>
    </div>
  </div>
</body>
</html>
