<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Printing Only - Fundamental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style> body{font-family: 'Inter', sans-serif;} </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="font-extrabold text-xl text-gray-900">Fundamental</a>
      <nav class="flex items-center gap-6 text-sm">
        <a href="services.html" class="inline-flex items-center gap-2 px-4 py-2 border rounded-lg text-sm text-gray-700 hover:bg-gray-50">
          <i class="fas fa-arrow-left"></i>
          Back To Services
        </a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Printing Only</h1>
      <p class="text-gray-600 mt-2">Upload your finished design and provide the specifics. We'll print it professionally.</p>
    </div>

    <form id="po-form" class="bg-white rounded-2xl shadow p-6 space-y-8">
      <!-- Printing Type -->
      <section>
        <label class="block text-sm font-bold text-gray-800 mb-3">Printing Type</label>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="dye-sublimation" class="peer hidden" checked />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-fire text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Dye-Sublimation</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="heat-transfer" class="peer hidden" />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-temperature-high text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Heat Transfer</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="vinyl-print" class="peer hidden" />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-layer-group text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Vinyl Print</p>
            </div>
          </label>
        </div>
      </section>

      <!-- Fabric & Garment combined -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-bold text-gray-800 mb-2">Fabric & Garment</label>
          <select id="fabricGarment" class="w-full border rounded-lg px-3 py-2" required>
            <option value="">Select fabric & garment</option>
            <option value="Cotton - Jersey">Cotton - Jersey</option>
            <option value="Cotton - T-Shirt">Cotton - T-Shirt</option>
            <option value="Cotton - Hoodie">Cotton - Hoodie</option>
            <option value="Dry-Fit - Jersey">Dry-Fit - Jersey</option>
            <option value="Dry-Fit - T-Shirt">Dry-Fit - T-Shirt</option>
            <option value="Polyester - Jersey">Polyester - Jersey</option>
            <option value="Polyester - Hoodie">Polyester - Hoodie</option>
          </select>

          <div class="mt-3 flex items-center gap-3">
            <button id="checkSizesBtn" type="button" class="px-3 py-2 border rounded-lg text-sm bg-white hover:bg-gray-50">
              <i class="fas fa-search mr-2"></i>Check Available Sizes
            </button>
            <div id="sizesAvailability" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Quantity</label>
          <input id="quantity" type="number" min="1" class="w-full border rounded-lg px-3 py-2" value="1" required />
        </div>
      </section>

      <!-- Design Uploads -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Upload Design</label>
          <input id="designFile" type="file" accept="image/*,.pdf,.ai,.psd,.zip" class="w-full border rounded-lg px-3 py-2" required />
          <p class="text-xs text-gray-500 mt-1">High-res preferred (300 DPI+)</p>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Team Names (optional)</label>
          <input id="teamNamesFile" type="file" accept=".txt,.csv" class="w-full border rounded-lg px-3 py-2" />
          <p class="text-xs text-gray-500 mt-1">Upload .txt or .csv list to prefill team members.</p>
        </div>
      </section>

      <!-- Team Mode -->
      <section class="space-y-3">
        <div class="flex items-center gap-3">
          <button id="teamToggle" type="button" class="px-3 py-2 border rounded-lg text-sm flex items-center gap-2">
            <i class="fas fa-users"></i><span>Team Mode: Off</span>
          </button>
          <button id="uploadNamesBtn" type="button" class="px-3 py-2 border rounded-lg text-sm hidden">
            <i class="fas fa-file-upload"></i> Team Names
          </button>
        </div>
        <div id="teamBox" class="hidden bg-gray-50 border rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800"><i class="fas fa-users text-green-600 mr-2"></i>Team Members</h3>
            <span class="text-xs text-gray-500">Auto based on quantity • Surname & Number are optional</span>
          </div>
          <div id="teamContainer" class="space-y-3"></div>
        </div>
      </section>

      <!-- Size (single) when not team mode -->
      <section id="singleSizeRow" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Size</label>
          <select id="garmentSize" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select size</option>
            <option>XS</option><option>S</option><option>M</option><option>L</option>
            <option>XL</option><option>XXL</option><option>3XL</option>
          </select>
        </div>
      </section>

      <div class="pt-2">
        <button id="submitBtn" type="submit" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-teal-700">
          <i class="fas fa-paper-plane mr-2"></i>Submit Printing Order
        </button>
      </div>
    </form>
  </main>

  <script>
    const API = 'https://fundamental-apparel-backend.onrender.com';

    const els = {
      form: document.getElementById('po-form'),
      teamToggle: document.getElementById('teamToggle'),
      uploadNamesBtn: document.getElementById('uploadNamesBtn'),
      teamBox: document.getElementById('teamBox'),
      teamContainer: document.getElementById('teamContainer'),
      quantity: document.getElementById('quantity'),
      fabricGarment: document.getElementById('fabricGarment'),
      checkSizesBtn: document.getElementById('checkSizesBtn'),
      sizesAvailability: document.getElementById('sizesAvailability'),
      garmentSize: document.getElementById('garmentSize'),
      singleSizeRow: document.getElementById('singleSizeRow'),
      teamNamesFileInput: document.getElementById('teamNamesFile')
    };

    let teamMode = false;
    let availableVariants = [];
    let currentInventory = null; // latest availability object for selected variant

    function genTeamRows() {
      const qty = Math.max(1, parseInt(els.quantity.value || '1', 10));
      els.teamContainer.innerHTML = '';
      for (let i=0;i<qty;i++){
        const row = document.createElement('div');
        row.className = 'grid grid-cols-3 gap-2 bg-white border rounded p-3';
        row.innerHTML = `
          <input class="name border rounded px-2 py-1" placeholder="Surname / Name (optional)" />
          <input class="number border rounded px-2 py-1" placeholder="Number (optional)" />
          <select class="size border rounded px-2 py-1">
            <option value="">Size</option>
            <option>XS</option><option>S</option><option>M</option><option>L</option>
            <option>XL</option><option>XXL</option><option>3XL</option>
          </select>
        `;
        els.teamContainer.appendChild(row);
      }
    }

    function setTeamMode(on){
      teamMode = !!on;
      if(teamMode){
        els.teamBox.classList.remove('hidden');
        els.uploadNamesBtn.classList.remove('hidden');
        els.singleSizeRow.classList.add('hidden');
        els.teamToggle.querySelector('span').textContent = 'Team Mode: On';
        genTeamRows();
      }else{
        els.teamBox.classList.add('hidden');
        els.uploadNamesBtn.classList.add('hidden');
        els.singleSizeRow.classList.remove('hidden');
        els.teamToggle.querySelector('span').textContent = 'Team Mode: Off';
      }
    }

    els.teamToggle.addEventListener('click', ()=> setTeamMode(!teamMode));
    els.quantity.addEventListener('change', ()=>{ if(teamMode) genTeamRows(); });

    // Optional: parse uploaded .txt/.csv into rows
    els.teamNamesFileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        els.quantity.value = lines.length;
        setTeamMode(true);
        genTeamRows();
        const rows = els.teamContainer.querySelectorAll('.grid');
        lines.forEach((ln, idx)=>{
          const parts = ln.split(/[,|\t]/);
          const row = rows[idx]; if(!row) return;
          row.querySelector('.name').value = (parts[0]||'').trim();
          row.querySelector('.number').value = (parts[1]||'').trim();
          if(parts[2]) row.querySelector('.size').value = parts[2].trim();
        });
      }catch(err){ console.error(err); }
    });

    function collectTeamMembers(){
      const arr = [];
      if(!teamMode) return arr;
      els.teamContainer.querySelectorAll('.grid').forEach(row=>{
        arr.push({
          name: row.querySelector('.name').value,
          jerseyNumber: row.querySelector('.number').value,
          size: row.querySelector('.size').value
        });
      });
      return arr;
    }

    els.form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const token = localStorage.getItem('token');
      if(!token){
        alert('Please login to submit a printing order.');
        window.location.href = 'login.html';
        return;
      }

      const fd = new FormData();
      fd.append('serviceType', 'printing-only');
      fd.append('printingMethod', (document.querySelector('input[name="printingMethod"]:checked')?.value)||'dye-sublimation');
      // split combined "Fabric - Garment" into separate fields for backend compatibility
      const fg = (els.fabricGarment && els.fabricGarment.value) ? els.fabricGarment.value : '';
      let fabricVal = '';
      let garmentVal = '';
      if(fg.includes(' - ')){
        const parts = fg.split(' - ');
        fabricVal = parts[0].trim();
        garmentVal = parts[1].trim();
      } else {
        fabricVal = fg;
      }
      // Send the original combined selection as inventoryName so backend can match admin-created inventory entries
      if (fg) fd.append('inventoryName', fg);
      fd.append('fabricType', fabricVal);
      fd.append('garmentType', garmentVal);
      fd.append('quantity', document.getElementById('quantity').value);

      const designFile = document.getElementById('designFile').files[0];
      if(designFile) fd.append('designFile', designFile);
      const teamNames = document.getElementById('teamNamesFile').files[0];
      if(teamNames) fd.append('teamNamesFile', teamNames);

      if(teamMode){
        fd.append('includeTeamMembers', 'true');
        fd.append('teamMembers', JSON.stringify(collectTeamMembers()));
      }else{
        fd.append('garmentSize', document.getElementById('garmentSize').value);
      }

      // Validate inventory availability before sending the quote
      // Ensure currentInventory is populated (try preloaded or fetch), then check requested sizes
      if (fg) {
        await showVariantAvailability(fg);
      }
      const inv = typeof currentInventory !== 'undefined' ? currentInventory : null;
      const qtyRequested = Number(document.getElementById('quantity').value) || 0;
      if (inv) {
        const sizes = inv.sizesInventory || {};
        const reserved = inv.reservedSizes || {};
        if (teamMode) {
          const team = collectTeamMembers();
          const counts = {};
          team.forEach(m => { counts[m.size] = (counts[m.size]||0) + 1; });
          for (const sz in counts) {
            const needed = counts[sz] || 0;
            const total = Number(sizes[sz] || 0);
            const resv = Number(reserved[sz] || 0);
            const avail = Math.max(0, total - resv);
            if (avail < needed) {
              alert(`Not enough stock for size ${sz}. Available: ${avail}, required: ${needed}`);
              return;
            }
          }
        } else {
          const size = document.getElementById('garmentSize').value;
          const total = Number(sizes[size] || 0);
          const resv = Number(reserved[size] || 0);
          const avail = Math.max(0, total - resv);
          if (avail < qtyRequested) {
            alert(`Not enough stock for size ${size}. Available: ${avail}, requested: ${qtyRequested}`);
            return;
          }
        }
      } else {
        // No inventory info available — proceed but warn in console
        console.debug('No inventory data available to validate before submit for', fg);
      }

      const btn = document.getElementById('submitBtn');
      const original = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
      try{
        const res = await fetch(`${API}/api/custom-orders`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd });
        const data = await res.json();
        if(!data.success) throw new Error(data.msg || 'Failed to submit order');
        alert('Printing order submitted! We will contact you with a quote.');
        window.location.href = 'profile.html';
      }catch(err){
        alert(err.message);
      }finally{
        btn.disabled = false; btn.innerHTML = original;
      }
       // Check Available Sizes handler
    async function checkAvailableSizesFG(){
      const token = localStorage.getItem('token');
      const fg = (els.fabricGarment && els.fabricGarment.value) ? els.fabricGarment.value : '';
      if(!fg){ alert('Please select a fabric & garment option first.'); return; }
      // Use the combined name as inventory 'name' for lookup
      const nameQuery = fg;
      try{
        els.checkSizesBtn.disabled = true;
        els.checkSizesBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
        const res = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(nameQuery)}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const data = await res.json();
        if(!data.success) throw new Error(data.message || 'Failed to fetch availability');
        displaySizesAvailability(data.data);
      }catch(err){
        alert(err.message || 'Error checking sizes');
      }finally{
        els.checkSizesBtn.disabled = false;
        els.checkSizesBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Check Available Sizes';
      }
    }

    function displaySizesAvailability(item){
      els.sizesAvailability.innerHTML = '';
      if(!item) return;
      const sizesInventory = item.sizesInventory || {};
      const sizesPrice = item.sizesPrice || {};
      const reservedSizes = item.reservedSizes || {};
      Object.keys(sizesInventory).forEach(sz=>{
        const total = Number(sizesInventory[sz]||0);
        const reserved = Number(reservedSizes[sz]||0);
        const available = Math.max(0, total - reserved);
        const badge = document.createElement('div');
        badge.className = 'px-3 py-1 rounded-full bg-gray-100 text-sm border';
        badge.innerHTML = `<strong>${sz}</strong>: ${available} available${sizesPrice[sz] ? ` • ₱${sizesPrice[sz]}` : ''}`;
        els.sizesAvailability.appendChild(badge);
      });
    }

    els.checkSizesBtn.addEventListener('click', checkAvailableSizesFG);
    // Populate Fabric & Garment dropdown from public inventory variants
    async function loadAvailableVariants(){
      try{
        const res = await fetch(`${API}/api/admin/inventory/public/variants`);
        if(!res.ok) return;
        const json = await res.json();
        if(!json.success) return;
        availableVariants = json.data || [];
        const sel = document.getElementById('fabricGarment');
        // clear existing options but keep placeholder
        const placeholder = sel.querySelector('option[value=""]');
        sel.innerHTML = '';
        if(placeholder) sel.appendChild(placeholder);
        // add options
        availableVariants.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = v.name;
          sel.appendChild(opt);
        });
      }catch(err){ console.debug('Failed to load variants:', err && err.message); }
    }

    // Show availability for selected variant using preloaded data or fallback to API
    function renderStockPanel(inv){
      els.sizesAvailability.innerHTML = '';
      currentInventory = inv || null;
      if(!inv){
        els.sizesAvailability.innerHTML = '<div class="text-sm text-gray-500">No availability info</div>';
        return;
      }
      const container = document.createElement('div');
      container.className = 'bg-white border rounded p-3';
      const title = document.createElement('div');
      title.className = 'text-xs font-semibold text-gray-700 mb-2';
      title.textContent = 'Stock by Size';
      container.appendChild(title);
      const list = document.createElement('div');
      list.className = 'text-sm text-gray-800 space-y-1';
      const sizes = inv.sizesInventory || {};
      const reserved = inv.reservedSizes || {};
      // show in-stock sizes first
      Object.keys(sizes).sort().forEach(sz=>{
        const total = Number(sizes[sz]||0);
        const resv = Number(reserved[sz]||0);
        const avail = Math.max(0, total - resv);
        const row = document.createElement('div');
        row.innerHTML = `<strong>${sz}</strong>: ${avail}`;
        list.appendChild(row);
      });
      container.appendChild(list);
      // footer with source and total
      const footer = document.createElement('div');
      footer.className = 'text-xs text-gray-500 mt-2';
      footer.textContent = `Source: inventory/availability • invId: ${inv.id || inv._id || ''}`;
      container.appendChild(footer);
      els.sizesAvailability.appendChild(container);
    }

    async function showVariantAvailability(name){
      if(!name){ renderStockPanel(null); return; }
      // try preloaded list
      const found = availableVariants.find(v => (v.name||'').toLowerCase() === name.toLowerCase());
      if(found){
        renderStockPanel(found);
        return;
      }
      // fallback to API call
      try{
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(name)}`, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
        const data = await res.json();
        if(data && data.success && data.data){
          renderStockPanel(data.data);
        } else {
          renderStockPanel(null);
        }
      }catch(err){ console.debug('availability fetch failed', err && err.message); renderStockPanel(null); }
    }

    // wire dropdown change to show availability
    document.getElementById('fabricGarment').addEventListener('change', (e)=>{
      const val = e.target.value;
      showVariantAvailability(val);
    });

    // load variants on page load
    loadAvailableVariants();
    });
  </script>
</body>
</html>
