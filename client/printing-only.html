<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Upload - Fundamental</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style> body{font-family: 'Inter', sans-serif;} </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="font-extrabold text-xl text-gray-900">Fundamental</a>
      <nav class="flex items-center gap-6 text-sm">
        <a href="services.html" class="inline-flex items-center gap-2 px-4 py-2 border rounded-lg text-sm text-gray-700 hover:bg-gray-50">
          <i class="fas fa-arrow-left"></i>
          Back To Services
        </a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Custom Upload</h1>
      <p class="text-gray-600 mt-2">Upload your finished design and provide the specifics. We'll make it professionally.</p>
    </div>

    <form id="po-form" class="bg-white rounded-2xl shadow p-6 space-y-8">
      <div id="formMessage" class="rounded p-3 text-sm hidden"></div>
      <!-- Printing Type -->
      <section>
        <label class="block text-sm font-bold text-gray-800 mb-3">Printing Type</label>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="dye-sublimation" class="peer hidden" checked />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-fire text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Dye-Sublimation</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="heat-transfer" class="peer hidden" />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-temperature-high text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Heat Transfer</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="printingMethod" value="vinyl-print" class="peer hidden" />
            <div class="border-2 border-gray-200 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 text-center">
              <i class="fas fa-layer-group text-2xl text-green-600 mb-2"></i>
              <p class="font-semibold text-sm">Vinyl Print</p>
            </div>
          </label>
        </div>
      </section>

      <!-- Fabric & Garment combined -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-bold text-gray-800 mb-2">Fabric & Garment</label>
          <select id="fabricGarment" class="w-full border rounded-lg px-3 py-2" required>
            <option value="">Select fabric & garment</option>
            <option value="Cotton - Jersey">Cotton - Jersey</option>
            <option value="Cotton - T-Shirt">Cotton - T-Shirt</option>
            <option value="Cotton - Hoodie">Cotton - Hoodie</option>
            <option value="Dry-Fit - Jersey">Dry-Fit - Jersey</option>
            <option value="Dry-Fit - T-Shirt">Dry-Fit - T-Shirt</option>
            <option value="Polyester - Jersey">Polyester - Jersey</option>
            <option value="Polyester - Hoodie">Polyester - Hoodie</option>
          </select>

          <div class="mt-3 flex items-center gap-3">
            <button id="checkSizesBtn" type="button" class="px-3 py-2 border rounded-lg text-sm bg-white hover:bg-gray-50">
              <i class="fas fa-search mr-2"></i>Check Available Sizes
            </button>
            <div id="sizesAvailability" class="flex flex-wrap gap-2"></div>
            <span id="fabricStatusBadge" class="ml-3 inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 hidden"></span>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Quantity</label>
          <input id="quantity" type="number" min="1" class="w-full border rounded-lg px-3 py-2" value="1" required />
        </div>
      </section>

      <!-- Design Uploads -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Upload Design</label>
          <input id="designFile" type="file" accept="image/*,.pdf,.ai,.psd,.zip" class="w-full border rounded-lg px-3 py-2" required />
          <p class="text-xs text-gray-500 mt-1">High-res preferred (300 DPI+)</p>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Team Names (optional)</label>
          <input id="teamNamesFile" type="file" accept=".txt,.csv" class="w-full border rounded-lg px-3 py-2" />
          <p class="text-xs text-gray-500 mt-1">Upload .txt or .csv list to prefill team members.</p>
        </div>
      </section>

      <!-- Team Mode -->
      <section class="space-y-3">
        <div class="flex items-center gap-3">
          <button id="teamToggle" type="button" class="px-3 py-2 border rounded-lg text-sm flex items-center gap-2">
            <i class="fas fa-users"></i><span>Team Mode: Off</span>
          </button>
          <button id="uploadNamesBtn" type="button" class="px-3 py-2 border rounded-lg text-sm hidden">
            <i class="fas fa-file-upload"></i> Team Names
          </button>
        </div>
        <div id="teamBox" class="hidden bg-gray-50 border rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800"><i class="fas fa-users text-green-600 mr-2"></i>Team Members</h3>
            <span class="text-xs text-gray-500">Auto based on quantity • Surname & Number are optional</span>
          </div>
          <div id="teamContainer" class="space-y-3"></div>
        </div>
      </section>

      <!-- Size (single) when not team mode -->
      <section id="singleSizeRow" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-800 mb-2">Size</label>
          <select id="garmentSize" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select size</option>
            <option>XS</option><option>S</option><option>M</option><option>L</option>
            <option>XL</option><option>XXL</option><option>3XL</option>
          </select>
        </div>
      </section>

      <div class="pt-2">
        <button id="submitBtn" type="submit" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-teal-700">
          <i class="fas fa-paper-plane mr-2"></i>Submit Quote Order
        </button>
      </div>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const API = 'https://fundamental-apparel-backend.onrender.com';

    const els = {
      form: document.getElementById('po-form'),
      teamToggle: document.getElementById('teamToggle'),
      uploadNamesBtn: document.getElementById('uploadNamesBtn'),
      teamBox: document.getElementById('teamBox'),
      teamContainer: document.getElementById('teamContainer'),
      quantity: document.getElementById('quantity'),
      fabricGarment: document.getElementById('fabricGarment'),
      checkSizesBtn: document.getElementById('checkSizesBtn'),
      sizesAvailability: document.getElementById('sizesAvailability'),
      garmentSize: document.getElementById('garmentSize'),
      singleSizeRow: document.getElementById('singleSizeRow'),
      teamNamesFileInput: document.getElementById('teamNamesFile')
    };

    let teamMode = false;
    let availableVariants = [];
    let currentInventory = null; // latest availability object for selected variant

    function genTeamRows() {
      const qty = Math.max(1, parseInt(els.quantity.value || '1', 10));
      els.teamContainer.innerHTML = '';
      for (let i=0;i<qty;i++){
        const row = document.createElement('div');
        row.className = 'grid grid-cols-3 gap-2 bg-white border rounded p-3';
        row.innerHTML = `
          <input class="name border rounded px-2 py-1" placeholder="Surname / Name (optional)" />
          <input class="number border rounded px-2 py-1" placeholder="Number (optional)" />
          <select class="size border rounded px-2 py-1">
          </select>
        `;
        els.teamContainer.appendChild(row);
      }
    }

    function setTeamMode(on){
      teamMode = !!on;
      if(teamMode){
        els.teamBox.classList.remove('hidden');
        els.uploadNamesBtn.classList.remove('hidden');
        els.singleSizeRow.classList.add('hidden');
        els.teamToggle.querySelector('span').textContent = 'Team Mode: On';
        genTeamRows();
        // populate team size selects from current inventory if available
        if(currentInventory) updateSizeDropdowns();
      }else{
        els.teamBox.classList.add('hidden');
        els.uploadNamesBtn.classList.add('hidden');
        els.singleSizeRow.classList.remove('hidden');
        els.teamToggle.querySelector('span').textContent = 'Team Mode: Off';
      }
    }

    els.teamToggle.addEventListener('click', ()=> setTeamMode(!teamMode));
    els.quantity.addEventListener('change', ()=>{ if(teamMode) genTeamRows(); });

    // Optional: parse uploaded .txt/.csv into rows
    els.teamNamesFileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        els.quantity.value = lines.length;
        setTeamMode(true);
        genTeamRows();
        const rows = els.teamContainer.querySelectorAll('.grid');
        lines.forEach((ln, idx)=>{
          const parts = ln.split(/[,|\t]/);
          const row = rows[idx]; if(!row) return;
          row.querySelector('.name').value = (parts[0]||'').trim();
          row.querySelector('.number').value = (parts[1]||'').trim();
          if(parts[2]) row.querySelector('.size').value = parts[2].trim();
        });
      }catch(err){ console.error(err); }
    });

    function collectTeamMembers(){
      const arr = [];
      if(!teamMode) return arr;
      els.teamContainer.querySelectorAll('.grid').forEach(row=>{
        arr.push({
          name: row.querySelector('.name').value,
          jerseyNumber: row.querySelector('.number').value,
          size: row.querySelector('.size').value
        });
      });
      return arr;
    }

    // --- Inventory-size helpers ---
    function getAvailableSizes(){
      const inv = currentInventory;
      if(!inv) return [];
      const sizesObj = inv.sizesInventory || {};
      const reserved = inv.reservedSizes || {};
      const sizeOrder = ['XS','S','M','L','XL','XXL','3XL'];
      const keys = Object.keys(sizesObj || {});
      keys.sort((a,b)=>{
        const ia = sizeOrder.indexOf(a);
        const ib = sizeOrder.indexOf(b);
        if(ia === -1 && ib === -1) return a.localeCompare(b);
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      });
      return keys.filter(sz => {
        const total = Number(sizesObj[sz] || 0);
        const resv = Number(reserved[sz] || 0);
        return (total - resv) > 0;
      });
    }

    function buildSizeOptionsHTML(sizes){
      let html = '<option value="">Select size</option>';
      (sizes || []).forEach(sz => { html += `<option value="${sz}">${sz}</option>`; });
      return html;
    }

    function updateSizeDropdowns(){
      const sizes = getAvailableSizes();
      const sel = document.getElementById('garmentSize');
      if(sel){
        sel.innerHTML = buildSizeOptionsHTML(sizes);
        sel.disabled = sizes.length === 0;
      }
      // regenerate team rows so their size selects reflect availability
      if(teamMode){
        genTeamRows();
        // populate each team row size select
        const rows = els.teamContainer.querySelectorAll('.grid');
        rows.forEach(r=>{
          const s = r.querySelector('.size');
          if(s){ s.innerHTML = buildSizeOptionsHTML(sizes); s.disabled = sizes.length === 0; }
        });
      }
    }

    // Inline message helpers (replace alert())
    function showMessage(msg, type){
      const el = document.getElementById('formMessage');
      if(!el) return;
      el.className = 'rounded p-3 text-sm';
      if(type === 'error') el.classList.add('bg-red-50','text-red-700','border','border-red-100');
      else if(type === 'success') el.classList.add('bg-green-50','text-green-700','border','border-green-100');
      else el.classList.add('bg-yellow-50','text-yellow-700','border','border-yellow-100');
      el.textContent = msg;
      el.classList.remove('hidden');
      // auto-clear success messages after a short delay
      if(type === 'success') setTimeout(()=>{ clearMessage(); }, 2500);
    }
    function clearMessage(){ const el = document.getElementById('formMessage'); if(el){ el.classList.add('hidden'); el.textContent=''; el.className='rounded p-3 text-sm hidden'; } }

    // Sizes modal helpers
    function openSizesModal(){ const m = document.getElementById('sizesModal'); if(!m) return; m.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
    function closeSizesModal(){ const m = document.getElementById('sizesModal'); if(!m) return; m.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }

    // Display sizes into modal with CTA buttons
    function displaySizesAvailability(item, opts){
      els.sizesAvailability.innerHTML = '';
      if(!item) return;
      currentInventory = item;
      updateSizeDropdowns();
      const modal = document.getElementById('sizesModal');
      const list = modal.querySelector('.sizes-list');
      list.innerHTML = '';
      const sizesInventory = item.sizesInventory || {};
      const sizesPrice = item.sizesPrice || {};
      const reservedSizes = item.reservedSizes || {};
      Object.keys(sizesInventory).forEach(sz=>{
        const total = Number(sizesInventory[sz]||0);
        const reserved = Number(reservedSizes[sz]||0);
        const available = Math.max(0, total - reserved);
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between py-2 border-b';
        row.innerHTML = `
          <div class="text-sm"><strong>${sz}</strong>${sizesPrice[sz] ? ` • ₱${sizesPrice[sz]}` : ''}</div>
          <div class="flex items-center gap-2">
            <div class="text-xs text-gray-500">${available} available</div>
            <button class="choose-size px-3 py-1 rounded text-sm bg-green-600 text-white" data-size="${sz}" data-available="${available}">${available>0? 'Choose' : 'Notify'}</button>
          </div>
        `;
        list.appendChild(row);
      });
      if(opts && opts.openModal) openSizesModal();
    }

    // Click handler for choose-size buttons inside modal
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest && ev.target.closest('.choose-size');
      if(!btn) return;
      const sz = btn.dataset.size;
      const avail = Number(btn.dataset.available||0);
      if(!teamMode){
        const sel = document.getElementById('garmentSize');
        if(sel && avail>0){ sel.value = sz; showMessage(`Selected size ${sz}`, 'success'); }
        else if(avail<=0){ showMessage(`Size ${sz} is out of stock`, 'error'); }
        closeSizesModal();
        return;
      }
      // team mode: apply selected size to all members that don't yet have a size
      if(teamMode){
        const rows = els.teamContainer.querySelectorAll('.grid');
        rows.forEach(r=>{ const s = r.querySelector('.size'); if(s && !s.value) s.value = sz; });
        showMessage(`Applied size ${sz} to team members (empty entries)`, 'success');
        closeSizesModal();
      }
    });

    // wire modal close buttons and overlay click
    const closeBtn = document.getElementById('sizesModalClose');
    const cancelBtn = document.getElementById('sizesModalCancel');
    const modal = document.getElementById('sizesModal');
    if(closeBtn) closeBtn.addEventListener('click', closeSizesModal);
    if(cancelBtn) cancelBtn.addEventListener('click', closeSizesModal);
    if(modal) modal.addEventListener('click', (ev)=>{ if(ev.target === modal) closeSizesModal(); });

    els.form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const token = localStorage.getItem('token');
      if(!token){
        showMessage('Please login to submit a quote order. Redirecting...', 'error');
        setTimeout(()=> window.location.href = 'login.html', 1000);
        return;
      }

      const fd = new FormData();
      fd.append('serviceType', 'Upload Design ');
      fd.append('printingMethod', (document.querySelector('input[name="printingMethod"]:checked')?.value)||'dye-sublimation');
      // split combined "Fabric - Garment" into separate fields for backend compatibility
      const fg = (els.fabricGarment && els.fabricGarment.value) ? els.fabricGarment.value : '';
      let fabricVal = '';
      let garmentVal = '';
      if(fg.includes(' - ')){
        const parts = fg.split(' - ');
        fabricVal = parts[0].trim();
        garmentVal = parts[1].trim();
      } else {
        fabricVal = fg;
      }
      // Send the original combined selection as inventoryName so backend can match admin-created inventory entries
      if (fg) fd.append('inventoryName', fg);
      fd.append('fabricType', fabricVal);
      fd.append('garmentType', garmentVal);
      fd.append('quantity', document.getElementById('quantity').value);

      const designFile = document.getElementById('designFile').files[0];
      if(designFile) fd.append('designFile', designFile);
      const teamNames = document.getElementById('teamNamesFile').files[0];
      if(teamNames) fd.append('teamNamesFile', teamNames);

      if(teamMode){
        fd.append('includeTeamMembers', 'true');
        fd.append('teamMembers', JSON.stringify(collectTeamMembers()));
      }else{
        fd.append('garmentSize', document.getElementById('garmentSize').value);
      }

      // Validate inventory availability before sending the quote
      // Ensure currentInventory is populated (try preloaded or fetch), then check requested sizes
      if (fg) {
        await showVariantAvailability(fg);
        // If single-mode and user didn't pick a size, auto-select the first available size
        if (!teamMode) {
          const sel = document.getElementById('garmentSize');
          try{
            if (sel && (!sel.value || sel.value === '')) {
              const sizes = getAvailableSizes();
              if (sizes && sizes.length) {
                sel.value = sizes[0];
                showMessage(`Auto-selected available size ${sizes[0]}`, 'success');
              } else {
                showMessage('No available sizes for the selected variant.', 'error');
                return;
              }
            }
          }catch(e){ console.debug('Auto-select size failed', e && e.message); }
        }
      }
      const inv = typeof currentInventory !== 'undefined' ? currentInventory : null;
      const qtyRequested = Number(document.getElementById('quantity').value) || 0;
      if (inv) {
        const sizes = inv.sizesInventory || {};
        const reserved = inv.reservedSizes || {};
        if (teamMode) {
          const team = collectTeamMembers();
          const counts = {};
          team.forEach(m => { counts[m.size] = (counts[m.size]||0) + 1; });
          for (const sz in counts) {
            const needed = counts[sz] || 0;
            const total = Number(sizes[sz] || 0);
            const resv = Number(reserved[sz] || 0);
            const avail = Math.max(0, total - resv);
            if (avail < needed) {
              showMessage(`Not enough stock for size ${sz}. Available: ${avail}, required: ${needed}`, 'error');
              return;
            }
          }
        } else {
          const size = document.getElementById('garmentSize').value;
          const total = Number(sizes[size] || 0);
          const resv = Number(reserved[size] || 0);
          const avail = Math.max(0, total - resv);
          if (avail < qtyRequested) {
            showMessage(`Not enough stock for size ${size}. Available: ${avail}, requested: ${qtyRequested}`, 'error');
            return;
          }
        }
      } else {
        // No inventory info available — proceed but warn in console
        console.debug('No inventory data available to validate before submit for', fg);
      }

      const btn = document.getElementById('submitBtn');
      const original = btn ? btn.innerHTML : 'Submit';
      if(btn){ btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...'; }
      try{
        const res = await fetch(`${API}/api/custom-orders`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd });
        let data = null;
        try{
          data = await res.json();
        }catch(parseErr){
          const text = await res.text().catch(()=>null);
          throw new Error(`Server responded with ${res.status}: ${text || res.statusText}`);
        }
        if(!data.success) {
          console.error('Server responded with error payload:', data);
          const errMsg = (data.msg || 'Failed to submit order') + (data.error ? ` — ${data.error}` : '');
          throw new Error(errMsg);
        }
        showMessage('Printing order submitted! We will contact you with a quote.', 'success');
        setTimeout(()=> window.location.href = 'profile.html', 900);
      }catch(err){
        console.error('Submit quote error:', err);
        showMessage(err.message || 'Failed to submit quote. See console for details.', 'error');
      }finally{
        if(btn){ btn.disabled = false; btn.innerHTML = original; }
      }
      });

      // Check Available Sizes handler
    async function checkAvailableSizesFG(){
      const token = localStorage.getItem('token');
      const fg = (els.fabricGarment && els.fabricGarment.value) ? els.fabricGarment.value : '';
      if(!fg){ showMessage('Please select a fabric & garment option first.', 'error'); return; }
      // Use the combined name as inventory 'name' for lookup
      const nameQuery = fg;
      try{
        els.checkSizesBtn.disabled = true;
        els.checkSizesBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
        const res = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(nameQuery)}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if(!res.ok){
          const txt = await res.text().catch(()=>res.statusText);
          throw new Error(`Availability API error ${res.status}: ${txt}`);
        }
        const data = await res.json().catch(()=>null);
        if(!data || !data.success) throw new Error((data && data.message) || 'Failed to fetch availability');
        // set current inventory and show availability modal
        currentInventory = data.data;
        displaySizesAvailability(data.data, { openModal: true });
      }catch(err){
        showMessage(err.message || 'Error checking sizes', 'error');
      }finally{
        els.checkSizesBtn.disabled = false;
        els.checkSizesBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Check Available Sizes';
      }
    }

    els.checkSizesBtn.addEventListener('click', checkAvailableSizesFG);
    // Populate Fabric & Garment dropdown from public inventory variants
    async function loadAvailableVariants(){
      try{
        const res = await fetch(`${API}/api/admin/inventory/public/variants`);
        if(!res.ok){ console.debug('Variants API returned', res.status); return; }
        const json = await res.json().catch(()=>null);
        if(!json || !json.success){ console.debug('Variants API response invalid'); return; }
        availableVariants = json.data || [];
        const sel = document.getElementById('fabricGarment');
        if(!sel) return;
        // clear existing options but keep placeholder
        const placeholder = sel.querySelector('option[value=""]');
        sel.innerHTML = '';
        if(placeholder) sel.appendChild(placeholder);
        // add options
        availableVariants.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.name || '';
          // compute available total across sizes
          const sizesObj = v.sizesInventory || {};
          const reserved = v.reservedSizes || {};
          let totalAvail = 0;
          Object.keys(sizesObj).forEach(k=>{ const t = Number(sizesObj[k]||0); const r = Number(reserved[k]||0); totalAvail += Math.max(0, t - r); });
          opt.dataset.available = totalAvail;
          if(totalAvail === 0){ opt.textContent = `${v.name || ''} — Out of stock`; opt.dataset.oos = '1'; }
          else { opt.textContent = `${v.name || ''} (${totalAvail})`; }
          sel.appendChild(opt);
        });
        // update badge for current selection (placeholder or first option)
        setTimeout(()=>{ const opt = sel.selectedOptions && sel.selectedOptions[0]; if(opt) updateFabricBadge(opt); }, 50);
      }catch(err){ console.debug('Failed to load variants:', err && err.message); }
    }

    // Show availability for selected variant using preloaded data or fallback to API
    function renderStockPanel(inv){
      els.sizesAvailability.innerHTML = '';
      currentInventory = inv || null;
      updateSizeDropdowns();
      if(!inv){
        els.sizesAvailability.innerHTML = '<div class="text-sm text-gray-500">No availability info</div>';
        return;
      }
      const container = document.createElement('div');
      container.className = 'bg-white border rounded p-3';
      const title = document.createElement('div');
      title.className = 'text-xs font-semibold text-gray-700 mb-2';
      title.textContent = 'Stock by Size';
      // show minimum price if provided
      if (inv.price !== undefined && inv.price !== null) {
        const priceEl = document.createElement('div');
        priceEl.className = 'text-xs text-gray-500 mb-2';
        priceEl.textContent = `Minimum price: ₱${Number(inv.price).toFixed(2)}`;
        container.appendChild(priceEl);
      }
      container.appendChild(title);
      const list = document.createElement('div');
      list.className = 'text-sm text-gray-800 space-y-1';
      const sizes = inv.sizesInventory || {};
      const reserved = inv.reservedSizes || {};
      // show in-stock sizes first
      const sizesPrice = inv.sizesPrice || {};
      Object.keys(sizes).sort().forEach(sz=>{
        const total = Number(sizes[sz]||0);
        const resv = Number(reserved[sz]||0);
        const avail = Math.max(0, total - resv);
        const row = document.createElement('div');
        row.innerHTML = `<strong>${sz}</strong>: ${avail}${sizesPrice[sz] ? ` • ₱${sizesPrice[sz]}` : ''}`;
        list.appendChild(row);
      });
      container.appendChild(list);
      // footer with source and total
      const footer = document.createElement('div');
      footer.className = 'text-xs text-gray-500 mt-2';
      footer.textContent = `Source: inventory/availability • invId: ${inv.id || inv._id || ''}`;
      container.appendChild(footer);
      els.sizesAvailability.appendChild(container);
    }

    async function showVariantAvailability(name){
      if(!name){ renderStockPanel(null); return; }
      // try preloaded list
      const found = availableVariants.find(v => (v.name||'').toLowerCase() === name.toLowerCase());
      if(found){
        renderStockPanel(found);
        return;
      }
      // fallback to API call
      try{
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}/api/admin/inventory/availability?name=${encodeURIComponent(name)}`, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
        const data = await res.json();
        if(data && data.success && data.data){
          renderStockPanel(data.data);
        } else {
          renderStockPanel(null);
        }
      }catch(err){ console.debug('availability fetch failed', err && err.message); renderStockPanel(null); }
    }

    // wire dropdown change to show availability
    function updateFabricBadge(option){
      const badge = document.getElementById('fabricStatusBadge');
      if(!badge) return;
      if(!option){ badge.classList.add('hidden'); return; }
      const avail = Number(option.dataset.available||0);
      if(option.dataset.oos === '1' || avail === 0){ badge.textContent = 'Out of stock'; badge.classList.remove('hidden'); badge.classList.remove('bg-green-100'); badge.classList.add('bg-red-50','text-red-700'); }
      else { badge.textContent = `${avail} in stock`; badge.classList.remove('hidden'); badge.classList.remove('bg-red-50','text-red-700'); badge.classList.add('bg-green-50','text-green-700'); }
    }
    const fabricEl = document.getElementById('fabricGarment');
    if(fabricEl){
      fabricEl.addEventListener('change', (e)=>{ const val = e.target.value; const opt = e.target.selectedOptions && e.target.selectedOptions[0]; updateFabricBadge(opt); showVariantAvailability(val); });
    }

    // load variants on page load
    loadAvailableVariants();
    });
    
  </script>
  <!-- Sizes Modal -->
  <div id="sizesModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg max-w-md w-full mx-4 shadow-lg overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <div class="text-sm font-semibold">Available Sizes</div>
        <button id="sizesModalClose" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="p-4">
        <div class="sizes-list space-y-2 text-sm text-gray-800"></div>
      </div>
      <div class="px-4 py-3 border-t text-right">
        <button id="sizesModalCancel" class="px-3 py-2 rounded border text-sm">Close</button>
      </div>
    </div>
  </div>
</body>
</html>
